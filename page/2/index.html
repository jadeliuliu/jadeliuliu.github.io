<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Jadeliu&#39;s blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Jadeliu&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Jade liu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Jadeliu's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jadeliu's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/22/myblog/spring/springboot%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/22/myblog/spring/springboot%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">springbootå­¦ä¹ </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-22 18:37:23" itemprop="dateCreated datePublished" datetime="2022-12-22T18:37:23+08:00">2022-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-20 15:40:41" itemprop="dateModified" datetime="2023-08-20T15:40:41+08:00">2023-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="springbootåˆ›å»ºå·¥ç¨‹"><a href="#springbootåˆ›å»ºå·¥ç¨‹" class="headerlink" title="springbootåˆ›å»ºå·¥ç¨‹"></a>springbootåˆ›å»ºå·¥ç¨‹</h2><p>å¾®æœåŠ¡ä½“ç³»ä¸‹ä¸å¯æˆ–ç¼ºã€‚<br>ssm(spring+springMvc+mybatis) -&gt; springboot -&gt; springcloud</p>
<p>springbootï¼šçº¦å®šä¼˜äºé…ç½®ï¼Œä¸ç”¨ä¸“æ³¨äºé…ç½®ã€‚2014å¹´å‘å¸ƒã€‚</p>
<p>springbootçš„ä½ç½®ï¼šæ˜¯springçš„é¡¶çº§é¡¹ç›®ï¼Œå’ŒspringFramework(iocã€aop)æ˜¯åŒç­‰çº§çš„ã€‚</p>
<p>springbootä½¿ç”¨æœ€å°é…ç½®å¿«é€Ÿæ„å»ºspringé¡¹ç›®ã€‚springbootä¸æ˜¯springåŠŸèƒ½ä¸Šçš„å¢å¼ºï¼Œè€Œæ˜¯æä¾›ä¸€ç§å¿«é€Ÿå¼€å‘springé¡¹ç›®çš„æ–¹å¼ã€‚</p>
<p>springç¼ºç‚¹ï¼š<br>&lt;1&gt; å†™é…ç½®æ–‡ä»¶ï¼Œç¹ç<br>&lt;2&gt; ä¾èµ–ç¹çï¼Œmavenåæ ‡ç‰ˆæœ¬é—®é¢˜</p>
<p>springbootæä¾›çš„ä¼˜ç‚¹ï¼š<br>&lt;1&gt; è‡ªåŠ¨é…ç½®ï¼Œåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶çš„è¿‡ç¨‹<br>&lt;2&gt; èµ·æ­¥ä¾èµ–ï¼Œåæ ‡pomæ‰“åŒ…åˆ°ä¸€èµ·ï¼Œå¯¹å…¶ä»–åº“çš„ä¾èµ–ä¼ é€’<br>&lt;3&gt; å…¶ä»–ï¼šåµŒå…¥å¼æœåŠ¡å™¨ï¼Œå®‰å…¨ï¼Œå¥åº·æ£€æµ‹</p>
<hr>
<p>âœ… ç”¨springbootæ­å»ºä¸€ä¸ªwebé¡¹ç›®ï¼š<br>&lt;1&gt; åˆ›å»ºmavené¡¹ç›®<br>&lt;2&gt; å¼•å…¥èµ·æ­¥ä¾èµ–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--springbootå·¥ç¨‹éœ€è¦ç»§æ‰¿çš„çˆ¶å·¥ç¨‹   --&gt;</span><br><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.6.1&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!--  webå¼€å‘çš„èµ·æ­¥ä¾èµ–  --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>&lt;3&gt; å†™ä¸€ä¸ªcontroller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.liuxuan.controller;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-12-22 23:28</span><br><span class="line"> **/</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/h&quot;)</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @RequestMapping(&quot;/hello&quot;)</span><br><span class="line">    public String hello() &#123;</span><br><span class="line">        return &quot;hello!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&lt;4&gt; å†™å¼•å¯¼ç±»ï¼Œspringbooté¡¹ç›®å…¥å£ï¼Œç„¶åè¿è¡Œmainæ–¹æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.liuxuan;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-12-22 23:38</span><br><span class="line"> **/</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class StartApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(StartApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>âœ… å¿«é€Ÿæ„å»º</p>
<p>ç”¨ideaï¼Œé€‰Spring Initializrï¼Œé€‰maven projectï¼Œé€‰jaræ‰“åŒ…æ–¹å¼ï¼Œå‹¾é€‰ä¾èµ–ã€‚</p>
<h2 id="springbootèµ·æ­¥ä¾èµ–"><a href="#springbootèµ·æ­¥ä¾èµ–" class="headerlink" title="springbootèµ·æ­¥ä¾èµ–"></a>springbootèµ·æ­¥ä¾èµ–</h2><p>spring-boot-starter-parentï¼Œå¾€é‡Œçœ‹æºç ï¼Œæœ€ç»ˆæ˜¯spring-boot-dependencyåŒ…ï¼Œå…¶ä¸­pomæ–‡ä»¶ä¸­<code>&lt;dependencyManagement&gt;</code> æ˜¯ç‰ˆæœ¬é”å®šï¼Œçˆ¶å·¥ç¨‹ä¸­å®šä¹‰çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œè‡ªå·±å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸å†™ç‰ˆæœ¬å·ã€‚</p>
<p>spring-boot-starter-webï¼Œå¾€é‡Œçœ‹ï¼Œå‘ç°å¼•å…¥äº†spring-webã€spring-webmvcã€‚</p>
<p>æ€»ç»“ï¼š<br>1.åœ¨spring-boot-starter-parentä¸­å®šä¹‰äº†å„ç§æŠ€æœ¯çš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œç»„åˆäº†ä¸€å¥—æœ€ä¼˜æ­é…çš„æŠ€æœ¯ç‰ˆæœ¬ã€‚<br>2.åœ¨å„ç§starterä¸­ï¼Œå®šä¹‰äº†å®Œæˆè¯¥åŠŸèƒ½çš„åæ ‡åˆé›†ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ç‰ˆæœ¬ä¿¡æ¯æ¥è‡ªäºçˆ¶å·¥ç¨‹ã€‚<br>3.æˆ‘ä»¬å·¥ç¨‹ç»§æ‰¿è‡ªparentï¼Œå¼•å…¥starterï¼Œé€šè¿‡ä¾èµ–ä¼ é€’ï¼Œå°±å¯ä»¥ç®€å•æ–¹ä¾¿è·å–éœ€è¦çš„jaråŒ…ï¼Œå¹¶ä¸”ä¸ä¼šå­˜åœ¨ç‰ˆæœ¬å†²çªé—®é¢˜ã€‚</p>
<h2 id="springbooté…ç½®"><a href="#springbooté…ç½®" class="headerlink" title="springbooté…ç½®"></a>springbooté…ç½®</h2><p>é…ç½®æ–‡ä»¶åˆ†ç±»ï¼špropertiesæ–‡ä»¶ã€yaml/ymlæ–‡ä»¶ã€‚<br>profileæ–‡ä»¶ï¼Œä¸‰ç§ç¯å¢ƒåŠ¨æ€åˆ‡æ¢ã€‚</p>
<p>springbootåŸºäºçº¦å®šï¼Œé…ç½®æœ‰é»˜è®¤å€¼ï¼Œæ›¿æ¢çš„è¯ï¼Œç”¨application.properties/application.ymlæ–‡ä»¶æ¥é…ç½®ã€‚resourceæ ¹ç›®å½•ä¸‹ï¼Œapplication.properties/yml/yaml æ–‡ä»¶é‡Œé¢æ”¾ç¨‹åºè‡ªåŠ¨è¯†åˆ«çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥å†™è‡ªå·±å®šä¹‰çš„å†…å®¹ã€‚</p>
<p>åŒä¸€çº§ç›®å½•ä¸‹ï¼Œé…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåºï¼šproperties &gt; yml &gt; yaml</p>
<p>yamlï¼šä¸æ˜¯ä¸€ä¸ªæ ‡è®°è¯­è¨€ï¼Œæ˜¯ç›´è§‚çš„èƒ½è¢«ç”µè„‘è¯†åˆ«çš„æ•°æ®åºåˆ—åŒ–æ ¼å¼ï¼Œä»¥æ•°æ®ä¸ºæ ¸å¿ƒï¼Œæ¯”xmlæ›´åŠ ç®€æ´ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xml:</span><br><span class="line">&lt;server&gt;</span><br><span class="line">    &lt;port&gt;8080&lt;/port&gt;</span><br><span class="line">&lt;/server&gt;</span><br><span class="line"></span><br><span class="line">yml:</span><br><span class="line">server:</span><br><span class="line">    port: 8080</span><br><span class="line"></span><br><span class="line">properties:</span><br><span class="line">server.port=8080</span><br></pre></td></tr></table></figure>

<p>yamlè¯­æ³•ï¼šå¤§å°å†™æ•æ„Ÿã€æ•°æ®å€¼å‰å¿…é¡»æœ‰ç©ºæ ¼ï¼ˆè‡³å°‘ä¸€ä¸ªï¼‰ã€ç¼©è¿›è¡¨ç¤ºå±‚çº§å…³ç³»ï¼Œç¼©è¿›ç©ºæ ¼ä¸ªæ•°ä¸é‡è¦ï¼Œä½†è¦å·¦å¯¹é½ã€#æ³¨é‡Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8082</span><br><span class="line"></span><br><span class="line">person:</span><br><span class="line">  name: liu</span><br><span class="line">  address: [beijing, shanghai]</span><br><span class="line"></span><br><span class="line">msg1: &quot;hello \n world&quot;  #åŒå¼•å·è¯†åˆ«è½¬ä¹‰å­—ç¬¦</span><br><span class="line">msg2: &#x27;hello \n world&#x27;  #å•å¼•å·åŸæ ·è¾“å‡º</span><br><span class="line"></span><br><span class="line">å‚æ•°å¼•ç”¨ï¼š$&#123;name&#125;</span><br></pre></td></tr></table></figure>


<p>è¯»å–é…ç½®æ–‡ä»¶å†…å®¹ï¼š</p>
<p>1.@Valueæ–¹æ³•ï¼Œå•ä¸ªå±æ€§æ³¨å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Value(&quot;$&#123;person.name&#125;&quot;)</span><br><span class="line">private String name;</span><br><span class="line"></span><br><span class="line">@Value(&quot;$&#123;person.address[0]&#125;&quot;)</span><br><span class="line">private String address;</span><br></pre></td></tr></table></figure>

<p>2.Environment</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private Environment env;    </span><br><span class="line"></span><br><span class="line">env.getProperty(&quot;person.name&quot;)</span><br></pre></td></tr></table></figure>

<p>3.@ConfigurationPropertiesï¼Œå¯¹è±¡å’Œé…ç½®çš„ç»‘å®š</p>
<p>åœ¨å®ä½“ç±»Personä¸ŠåŠ æ³¨è§£ <code>@ConfigurationProperties(prefix=&quot;person&quot;)</code></p>
<hr>
<p>profileï¼šä¸€å¥—ç¨‹åºé€šå¸¸éœ€è¦éƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹ï¼Œå¼€å‘æµ‹è¯•ç”Ÿäº§ï¼Œå¦‚æœæ¯æ¬¡æ‰“åŒ…éƒ½è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œéº»çƒ¦ï¼Œprofileæä¾›è¿›è¡ŒåŠ¨æ€é…ç½®åˆ‡æ¢çš„æ–¹å¼ã€‚</p>
<p>é…ç½®æ–¹å¼ï¼š<br>1.å¤šprofileæ–‡ä»¶æ–¹å¼ï¼šæä¾›å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œæ¯ä¸ªä»£è¡¨ä¸€ä¸ªç¯å¢ƒ<br>application-dev.properties/yml<br>application-test.properties/yml<br>application-pro.properties/yml</p>
<p>2.ymlå•æ–‡ä»¶æ–¹å¼<br>ç”¨â€”åˆ†å‰²ä¸åŒç¯å¢ƒé…ç½®</p>
<p>æ¿€æ´»æ–¹å¼ï¼š<br>1.é…ç½®æ–¹å¼ï¼š<br><code>spring.profiles.active=dev</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    profiles:</span><br><span class="line">        active: dev</span><br></pre></td></tr></table></figure>

<p>2.è™šæ‹Ÿæœºå‚æ•°<br>åœ¨VM optionä¸­è¾“å…¥ï¼š<code>-Dspring.profiles.active=test</code></p>
<p>3.å‘½ä»¤è¡Œå‚æ•°<br>å…ˆpackageæ‰“åŒ…<br><code>java -jar ...jar --spring.profiles.active=test</code></p>
<hr>
<p>æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°ï¼šjarä¸­æ²¡æœ‰ä¸»æ¸…å•å±æ€§</p>
<p>åŸå› ï¼šæ‰“åŒ…åçš„jaræ–‡ä»¶ä¸­çš„MANIFEST.MFç¼ºå°‘é¡¹ç›®å¯åŠ¨é¡¹ï¼Œå³æ²¡æœ‰Main-Class</p>
<p>è§£å†³æ–¹æ¡ˆï¼š<br>1ã€æŒ‡å®šMANIFEST.MFè·¯å¾„<br>é¡¹ç›®æ‰“åŒ…å‰ï¼š<br>ç¬¬ä¸€æ­¥ fileâ€“&gt;project structure å¼¹æ¡†åé€‰ä¸­Atifactsâ€”&gt; + â€”-&gt;jarâ€”-&gt;from module with dependenceis<br>ç¬¬äºŒæ­¥ é€‰æ‹©ä¸€ä¸ªMain Classï¼Œé€‰çš„StartApplicationæ–‡ä»¶</p>
<p>2ã€é¡¹ç›®pom.xmlæ–‡ä»¶ä¸­æ·»åŠ æ’ä»¶spring-boot-maven-plugin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<hr>
<p>å†…éƒ¨é…ç½®åŠ è½½é¡ºåºï¼š</p>
<p>1.é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„configæ–‡ä»¶å¤¹ä¸‹<br>2.é¡¹ç›®æ ¹ç›®å½•ï¼ˆideaç‚¹project filesçš„æ ¹ç›®å½•ï¼‰ä¸‹<br>3.classPathï¼ˆresourceç›®å½•ä¸‹ï¼‰çš„configæ–‡ä»¶å¤¹ä¸‹<br>4.classPathï¼ˆresourceç›®å½•ä¸‹ï¼‰ä¸‹</p>
<p>å‰ä¸¤ä¸ªä¸ä¼šæ‰“è¿›jaråŒ…é‡Œ</p>
<hr>
<p>å¤–éƒ¨é…ç½®åŠ è½½é¡ºåºï¼š</p>
<p>1.å‘½ä»¤è¡ŒæŒ‡å®šç«¯å£å·ï¼š<code>java -jar spring-boot-study-api-1.0-SNAPSHOT.jar --server.port=8086</code><br>æŒ‡å®šé»˜è®¤å‰ç¼€è·¯å¾„ï¼š<code>--server.servlet.context-path=/default</code><br>2.æŒ‡å®šå¤–éƒ¨é…ç½®æ–‡ä»¶è·¯å¾„ï¼š<code>--spring.config.location=è·¯å¾„</code><br>3.åœ¨jaråŒ…åŒç›®å½•ä¸‹ï¼ˆtargetæ–‡ä»¶å¤¹ä¸‹ï¼‰ï¼ŒåŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶<code>application.properties</code>ï¼ŒåŒæ ·ç”Ÿæ•ˆï¼Œå¤–éƒ¨é…ç½®ä¼˜å…ˆç”Ÿæ•ˆ</p>
<h2 id="springbootæ•´åˆå…¶ä»–æ¡†æ¶"><a href="#springbootæ•´åˆå…¶ä»–æ¡†æ¶" class="headerlink" title="springbootæ•´åˆå…¶ä»–æ¡†æ¶"></a>springbootæ•´åˆå…¶ä»–æ¡†æ¶</h2><h3 id="springbootæ•´åˆJunit"><a href="#springbootæ•´åˆJunit" class="headerlink" title="springbootæ•´åˆJunit"></a>springbootæ•´åˆJunit</h3><p>1.å¼•å…¥spring-boot-starter-test èµ·æ­¥ä¾èµ–<br>2.åœ¨æµ‹è¯•ç±»ä¸ŠåŠ ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class) //springboot2ä¸ç”¨åŠ </span><br><span class="line">@SpringBootTest(classes = StartApplication.class) //å¦‚æœä¸StartApplicationåœ¨ä¸€ä¸ªåŒ…ä¸‹ï¼Œå¯ä»¥ä¸åŠ æ‹¬å·é‡Œçš„</span><br></pre></td></tr></table></figure>


<h3 id="springbootæ•´åˆredis"><a href="#springbootæ•´åˆredis" class="headerlink" title="springbootæ•´åˆredis"></a>springbootæ•´åˆredis</h3><p>1.å¼•å…¥spring-boot-starter-data-redisä¾èµ–<br>2.è¿æ¥æœ¬åœ°çš„redisï¼Œä¸éœ€è¦ä»»ä½•é…ç½®<br>3.ç›´æ¥ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">redisTemplate.boundValueOps(&quot;name&quot;).set(&quot;liu&quot;);</span><br><span class="line">Object o = redisTemplate.boundValueOps(&quot;name&quot;).get();</span><br></pre></td></tr></table></figure>
<p>4.å…¶ä»–ipçš„ï¼Œéœ€è¦é…ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: 127.0.0.1</span><br><span class="line">    port: 6379</span><br></pre></td></tr></table></figure>


<h3 id="springæ•´åˆmybatis"><a href="#springæ•´åˆmybatis" class="headerlink" title="springæ•´åˆmybatis"></a>springæ•´åˆmybatis</h3><p>1.å¼•å…¥mybatisèµ·æ­¥ä¾èµ– <code>mybatis-spring-boot-starter</code> ï¼ˆä¸åŒäºå…¶ä»–ï¼Œè¿™ä¸ªæ˜¯mybatisæä¾›çš„ï¼Œç”¨3.0.1çš„æœ‰ç‚¹é—®é¢˜ï¼Œæ”¹ç”¨2.1.0ï¼‰ï¼Œæ·»åŠ mysqlé©±åŠ¨ <code>mysql-connector-java</code><br>2.é…ç½®datasourceå’Œmybatis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql:///test?serverTimezone=UTC</span><br><span class="line">    #db.url=jdbc:mysql://localhost:3306/test?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span><br><span class="line">    username: liuxuan</span><br><span class="line">    password: jade</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>
<p>3.åˆ›å»ºè¡¨ï¼Œå¹¶ç¼–å†™å®ä½“ç±»<br>4.çº¯æ³¨è§£å¼€å‘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line">@Repository</span><br><span class="line">public interface StudentMapper &#123;</span><br><span class="line"></span><br><span class="line">    @Select(&quot;select * from student&quot;)</span><br><span class="line">    public List&lt;Student&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5 .xmlæ˜ å°„æ–‡ä»¶å½¢å¼å¼€å‘<br>Mapperæ¥å£</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line">@Repository</span><br><span class="line">public interface StudentXmlMapper &#123;</span><br><span class="line"></span><br><span class="line">    public List&lt;Student&gt; findAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xmlé…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.liuxuan.repository.mapper.StudentXmlMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.liuxuan.repository.domain.Student&quot;</span>&gt;</span></span><br><span class="line">        select * from student</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¢åŠ mybatisé…ç½®(ä¸åœ¨springä¸‹)ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">  # Mapperæ˜ å°„æ–‡ä»¶è·¯å¾„</span><br><span class="line">  mapper-locations: classpath:mapper/*Mapper.xml</span><br><span class="line">  # åŒ…æ‰«æ</span><br><span class="line">  type-aliases-package: com.liuxuan.repository.domain</span><br></pre></td></tr></table></figure>


<h2 id="springbootåŸç†åˆ†æ"><a href="#springbootåŸç†åˆ†æ" class="headerlink" title="springbootåŸç†åˆ†æ"></a>springbootåŸç†åˆ†æ</h2><h3 id="springbootè‡ªåŠ¨é…ç½®"><a href="#springbootè‡ªåŠ¨é…ç½®" class="headerlink" title="springbootè‡ªåŠ¨é…ç½®"></a>springbootè‡ªåŠ¨é…ç½®</h3><p>Conditionæ˜¯spring4.0å¢åŠ çš„æ¡ä»¶åˆ¤æ–­åŠŸèƒ½ï¼Œå¯ä»¥å®ç°é€‰æ‹©æ€§åœ°åˆ›å»ºBeanæ“ä½œã€‚</p>
<h4 id="âœ…éœ€æ±‚1-åˆ›å»ºbeanå¢åŠ æ¡ä»¶"><a href="#âœ…éœ€æ±‚1-åˆ›å»ºbeanå¢åŠ æ¡ä»¶" class="headerlink" title="âœ…éœ€æ±‚1:åˆ›å»ºbeanå¢åŠ æ¡ä»¶"></a>âœ…éœ€æ±‚1:åˆ›å»ºbeanå¢åŠ æ¡ä»¶</h4><p>1.è‡ªå®šä¹‰æ¡ä»¶ç±»ï¼Œç»§æ‰¿Conditionæ¥å£ï¼Œå®ç°matchesæ–¹æ³•ï¼Œæ–¹æ³•ä¸­è¿›è¡Œé€»è¾‘åˆ¤æ–­ï¼Œå‚æ•°contextå¯ä»¥è·å–ä¸Šä¸‹æ–‡å®¹å™¨ç­‰ï¼Œmetadataå¯ä»¥è·å–æ³¨è§£å±æ€§ã€‚<br>2.åˆ¤æ–­æ¡ä»¶ï¼Œåˆå§‹åŒ–beanæ—¶ä½¿ç”¨@Conditional(æ¡ä»¶ç±».class)æ³¨è§£</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">éœ€è¦åŠ æ³¨è§£@Conditionalï¼š</span><br><span class="line">@Configuration</span><br><span class="line">public class UserConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    @Conditional(ClassCondition.class)</span><br><span class="line">    public User user() &#123;</span><br><span class="line">        return new User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è‡ªå·±å®šä¹‰ä¸€ä¸ªå®ç°äº†Conditionæ¥å£çš„ç±»ï¼Œé‡Œé¢å®ç°æ¡ä»¶åˆ¤æ–­matchesæ–¹æ³•ï¼š</span><br><span class="line">public class ClassCondition implements Condition &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">        // å†™åˆ›å»ºbeançš„æ¡ä»¶ï¼šå¯¼å…¥jedisåæ ‡ååˆ›å»ºbean</span><br><span class="line">        try &#123;</span><br><span class="line">            Class cls = Class.forName(&quot;redis.clients.jedis.Jedis&quot;);</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è·å–beanï¼š</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class StartApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // å¯åŠ¨springbootåº”ç”¨ï¼Œè·å–springçš„iocå®¹å™¨</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(StartApplication.class, args);</span><br><span class="line"></span><br><span class="line">        // è·å–bean</span><br><span class="line">        Object user = context.getBean(&quot;user&quot;);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="âœ…éœ€æ±‚2-ç”¨è‡ªå®šä¹‰æ³¨è§£å®ç°åŠ¨æ€Condition"><a href="#âœ…éœ€æ±‚2-ç”¨è‡ªå®šä¹‰æ³¨è§£å®ç°åŠ¨æ€Condition" class="headerlink" title="âœ…éœ€æ±‚2:ç”¨è‡ªå®šä¹‰æ³¨è§£å®ç°åŠ¨æ€Condition"></a>âœ…éœ€æ±‚2:ç”¨è‡ªå®šä¹‰æ³¨è§£å®ç°åŠ¨æ€Condition</h4><p>å®šä¹‰è‡ªå®šä¹‰æ³¨è§£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Conditional(ClassCondition.class)</span><br><span class="line">public @interface ConditionOnClass &#123;</span><br><span class="line">    String[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Configä¸­åŠ æ³¨è§£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class UserConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">//    @Conditional(ClassCondition.class)</span><br><span class="line">    @ConditionOnClass(&quot;redis.clients.jedis.Jedis&quot;)</span><br><span class="line">    public User user() &#123;</span><br><span class="line">        return new User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§æ‰¿Conditionæ¥å£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class ClassCondition implements Condition &#123;</span><br><span class="line">    /**</span><br><span class="line">     * @param context  ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ç”¨äºè·å–ç¯å¢ƒã€Iocå®¹å™¨ã€classLoaderå¯¹è±¡</span><br><span class="line">     * @param metadata æ³¨è§£å…ƒå¯¹è±¡ï¼Œå¯ä»¥ç”¨äºè·å–æ³¨è§£å®šä¹‰çš„å±æ€§å€¼</span><br><span class="line">     * @return boolean</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) &#123;</span><br><span class="line">        // éœ€æ±‚1ï¼šå†™åˆ›å»ºbeançš„æ¡ä»¶ï¼šå¯¼å…¥jedisåæ ‡ååˆ›å»ºbean</span><br><span class="line">//        try &#123;</span><br><span class="line">//            Class cls = Class.forName(&quot;redis.clients.jedis.Jedis&quot;);</span><br><span class="line">//        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//            return false;</span><br><span class="line">//        &#125;</span><br><span class="line">//        return true;</span><br><span class="line"></span><br><span class="line">        // éœ€æ±‚2ï¼šé€šè¿‡æ³¨è§£å±æ€§å€¼valueæŒ‡å®šåæ ‡ååˆ›å»ºbean</span><br><span class="line">        Map&lt;String, Object&gt; map = metadata.getAnnotationAttributes(ConditionOnClass.class.getName());</span><br><span class="line">        String[] value = (String[])map.get(&quot;value&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            for (String className : value) &#123;</span><br><span class="line">                Class&lt;?&gt; cls = Class.forName(className);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹åŒ…spring-boot-anto-configurationä¸­ï¼Œspringbootå·²ç»å®šä¹‰å¥½äº†å¾ˆå¤šconditionæ³¨è§£ï¼Œä¾‹å¦‚ï¼š@ConditionalOnClassã€‚</p>
<hr>
<h4 id="âœ…åˆ‡æ¢å†…ç½®æœåŠ¡å™¨"><a href="#âœ…åˆ‡æ¢å†…ç½®æœåŠ¡å™¨" class="headerlink" title="âœ…åˆ‡æ¢å†…ç½®æœåŠ¡å™¨"></a>âœ…åˆ‡æ¢å†…ç½®æœåŠ¡å™¨</h4><p>spring-boot-starter-web</p>
<p>spring-boot-autoconfiguration åŒ…çš„webçš„embeddedä¸­å†…ç½®äº†å››ç§æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬jettyã€nettyã€tomcatã€undertomã€‚</p>
<p>é‡Œé¢è¿˜æœ‰ä¸ªç±»è´Ÿè´£é€‰æ‹©webæœåŠ¡å™¨ï¼ŒåŸç†ä¹Ÿæ˜¯ç”¨äº†@ConditionalOnClassæ³¨è§£ï¼Œçœ‹å¯¼å…¥äº†ä»€ä¹ˆåæ ‡æ¥é€‰æ‹©æœåŠ¡å™¨ã€‚</p>
<p>ç”¨<exclusions> æŠŠspring-boot-starter-web ä¸­çš„ spring-boot-starter-tomcat æ’é™¤æ‰ã€‚å†å¼•å…¥jettyçš„ä¾èµ–ï¼Œå°±ä¼šåˆ‡æ¢ä¸ºjettyæœåŠ¡å™¨ã€‚</exclusions></p>
<hr>
<h4 id="âœ…-Enable-æ³¨è§£"><a href="#âœ…-Enable-æ³¨è§£" class="headerlink" title="âœ… @Enable*æ³¨è§£"></a>âœ… @Enable*æ³¨è§£</h4><p>SpringBootæä¾›äº†å¾ˆå¤š@Enableå¼€å¤´çš„æ³¨è§£ï¼Œç”¨äºåŠ¨æ€å¯åŠ¨æŸäº›åŠŸèƒ½(è·å–ä¸€äº›bean)ï¼Œå…¶åº•å±‚åŸç†æ˜¯ä½¿ç”¨@Importæ³¨è§£å¯¼å…¥ä¸€äº›é…ç½®ç±»ï¼Œå®ç°Beançš„åŠ¨æ€åŠ è½½ã€‚</p>
<p>çœ‹æ³¨è§£ @SpringBootApplication</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@SpringBootConfiguration --å†…éƒ¨@Configurationå¯é…ç½®bean</span><br><span class="line">@EnableAutoConfiguration --é‡ç‚¹</span><br><span class="line">@ComponentScan(   --åŒ…æ‰«æ</span><br><span class="line">    excludeFilters = &#123;@Filter(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;TypeExcludeFilter.class&#125;</span><br><span class="line">), @Filter(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span><br><span class="line">)&#125;</span><br><span class="line">)</span><br><span class="line">public @interface SpringBootApplication</span><br><span class="line"></span><br><span class="line">å…¶ä¸­Enableæ³¨è§£ä¸‹ï¼š</span><br><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@AutoConfigurationPackage</span><br><span class="line">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br><span class="line">public @interface EnableAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">é‡è¦çš„æ˜¯Importæ³¨è§£</span><br></pre></td></tr></table></figure>

<p>âš ï¸å¯åŠ¨å­æ¨¡å—çš„å¯åŠ¨ç±»ï¼Œæ— æ³•å¯åŠ¨çˆ¶å·¥ç¨‹çš„controllerã€‚</p>
<p>springbootå·¥ç¨‹ä¸å¯ä»¥ç›´æ¥è·å–å…¶ä»–jaråŒ…ä¸­å®šä¹‰çš„beanï¼Œæ¯”å¦‚redisTemplateã€‚</p>
<p>åŸå› ï¼š@ComponentScan åŒ…æ‰«æçš„èŒƒå›´æ˜¯ï¼šå½“å‰å¼•å¯¼ç±»æ‰€åœ¨åŒ…åŠå…¶å­åŒ…ï¼Œå…¶ä»–é¡¹ç›®é…ç½®Beançš„åŒ…ä¸åœ¨è¯¥èŒƒå›´å†…ã€‚</p>
<p>å°è¯•ï¼šå¦å¤–åˆ›å»ºä¸€ä¸ªå­æ¨¡å—ï¼Œå­æ¨¡å—å¼•å…¥å¦ä¸€ä¸ªå­æ¨¡å—çš„pomï¼Œç„¶åå°è¯•è·å–å¦ä¸€ä¸ªå­æ¨¡å—çš„beanã€‚<br>æŠ¥é”™ï¼šNoSuchBeanDefinitionExceptionã€‚</p>
<p>å¦‚ä½•è·å–Beanï¼š<br>1.åœ¨å¯åŠ¨ç±»ä¸ŠåŠ @ComponentScanæ³¨è§£ï¼Œæ‰«æè¦å¼•å…¥Beançš„åŒ…ã€‚<br>ç¼ºç‚¹ï¼šè¦å†™åŒ…å¤ªç´¯èµ˜<br>2.ä½¿ç”¨@Importæ³¨è§£åŠ è½½è¦å¯¼å…¥beançš„é…ç½®ç±»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">public @interface Import &#123;</span><br><span class="line">    Class&lt;?&gt;[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>valueä¸­çš„è¿™äº›ç±»ä¼šè¢«springåˆ›å»ºå¹¶æ”¾å…¥IOCå®¹å™¨ä¸­ã€‚<br>ç¼ºç‚¹ï¼šè¦è®°ç±»çš„åå­—<br>3.å¯¹Importæ³¨è§£è¿›è¡Œå°è£…<br>è‡ªå®šä¹‰ä¸€ä¸ªEnableæ³¨è§£ï¼ŒæŠŠImportæ³¨è§£å°è£…è¿›å»ï¼Œè¦æƒ³ç”¨è¿™ä¸ªbeançš„æ—¶å€™ï¼Œç›´æ¥ç”¨Enableæ³¨è§£å°±å¯ä»¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(UserConfig.class)</span><br><span class="line">public @interface EnableUser &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨ç±»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class) //æ’é™¤æ­¤ç±»çš„AutoConfig</span><br><span class="line">//@ComponentScan(&quot;com.liuxuan.condition&quot;)</span><br><span class="line">//@Import(UserConfig.class)</span><br><span class="line">@EnableUser</span><br><span class="line">public class StartApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // å¯åŠ¨springbootåº”ç”¨ï¼Œè·å–springçš„iocå®¹å™¨</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(StartApplication.class, args);</span><br><span class="line"></span><br><span class="line">        // è·å–bean</span><br><span class="line">        Object user = context.getBean(&quot;user&quot;);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ğŸ˜Š<code>@SpringBootApplication(exclude=&#123;DataSourceAutoConfiguration.class&#125;)</code></p>
<p>excludeï¼Œæ’é™¤æ­¤ç±»çš„AutoConfigï¼Œå³ç¦æ­¢ SpringBoot è‡ªåŠ¨æ³¨å…¥æ•°æ®æºé…ç½®ã€‚</p>
<p>DataSourceAutoConfiguration.class ä¼šè‡ªåŠ¨æŸ¥æ‰¾ application.yml æˆ–è€… properties æ–‡ä»¶é‡Œçš„ spring.datasource.* ç›¸å…³å±æ€§å¹¶è‡ªåŠ¨é…ç½®å•æ•°æ®æºã€Œæ³¨æ„è¿™é‡Œæåˆ°çš„å•æ•°æ®æºã€ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ’é™¤äº†è‡ªåŠ¨é…ç½®ï¼ŒSpringè¿˜æ€ä¹ˆè¯†åˆ«åˆ°æ•°æ®åº“é…ç½®å‘¢ï¼Ÿ</p>
<p>ç­”ï¼šæ˜¾ç„¶æ¥ä¸‹æ¥å°±éœ€è¦æ‰‹åŠ¨é…ç½®ï¼Œå¦‚æœä½ å‘ç°é¡¹ç›®ä¸­å­˜åœ¨è¿™ä¸ªæ’é™¤çš„æ“ä½œï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­æœä¸€ä¸‹Javaå…³é”®å­—@ConfigurationProperties(â€œspring.datasource)ï¼Œä½ å¯èƒ½ä¼šå‘ç°æ‰‹åŠ¨é…ç½®æ•°æ®æºçš„ç±»ã€‚</p>
<p>å†æ¥å›ç­”ä¸ºä½•è¦æ‰‹åŠ¨é…ç½®æ•°æ®æºï¼Œå› ä¸ºè¦é…ç½®å¤šæ•°æ®æºï¼Œä¸Šè¾¹æœ‰æåˆ°DataSourceAutoConfiguration.classé»˜è®¤ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨é…ç½®å•æ•°æ®æºï¼Œæ‰€ä»¥ï¼Œå¦‚æœæƒ³åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¤šæ•°æ®æºå°±éœ€è¦æ’é™¤å®ƒï¼Œæ‰‹åŠ¨æŒ‡å®šå¤šæ•°æ®æºã€‚</p>
<p>@SpringBootApplicationæ³¨è§£ä¸­excludeå‚æ•°ä½¿ç”¨åŠåŸç†:<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/csdn_20150804/article/details/116104742">https://blog.csdn.net/csdn_20150804/article/details/116104742</a></p>
<h4 id="âœ…-Importæ³¨è§£"><a href="#âœ…-Importæ³¨è§£" class="headerlink" title="âœ… @Importæ³¨è§£"></a>âœ… @Importæ³¨è§£</h4><p>@Enable*åº•å±‚ä¾èµ–@Importæ³¨è§£å¯¼å…¥ä¸€äº›ç±»ï¼Œä½¿ç”¨@Importå¯¼å…¥çš„ç±»ä¼šè¢«SpringåŠ è½½åˆ°IOCå®¹å™¨ä¸­ï¼Œ@Importæä¾›å››ç§ç”¨æ³•ï¼š</p>
<p>1.å¯¼å…¥Bean</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">StartApplicationä¸Šï¼š</span><br><span class="line">@Import(User.class)</span><br><span class="line"></span><br><span class="line">StartApplicationä¸­ï¼š</span><br><span class="line">// æ ¹æ®ç±»å‹è·å–bean</span><br><span class="line">Object user = context.getBean(User.class);</span><br><span class="line">System.out.println(user);</span><br><span class="line">// è·å–beanåç§°</span><br><span class="line">Map&lt;String, User&gt; map = context.getBeansOfType(User.class);</span><br><span class="line">System.out.println(map);</span><br></pre></td></tr></table></figure>

<p>2.å¯¼å…¥é…ç½®ç±»<br>è¿™ç§æ–¹å¼ï¼Œé…ç½®ç±»ä¸Šçš„@Configurationæ³¨è§£å¯ä»¥ä¸åŠ </p>
<p>3.å¯¼å…¥ImportSelectå®ç°ç±»ã€‚ä¸€èˆ¬ç”¨äºåŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„ç±»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Import(MyImportSelector.class)</span><br><span class="line"></span><br><span class="line">å®ç°ç±»ï¼š</span><br><span class="line">public class MyImportSelector implements ImportSelector &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        return new String[]&#123;&quot;com.liuxuan.condition.User&quot;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.å¯¼å…¥ImportBeanDefinitionRegistrarå®ç°ç±»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Import(MyImportBeanDefinitionRegistrar.class)</span><br><span class="line"></span><br><span class="line">å®ç°ç±»ï¼š</span><br><span class="line">public class MyImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123;</span><br><span class="line">        AbstractBeanDefinition beanDefinition = BeanDefinitionBuilder.rootBeanDefinition(User.class).getBeanDefinition();</span><br><span class="line">        registry.registerBeanDefinition(&quot;beanName&quot;, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="âœ…-EnableAutoConfigurationæ³¨è§£"><a href="#âœ…-EnableAutoConfigurationæ³¨è§£" class="headerlink" title="âœ…@EnableAutoConfigurationæ³¨è§£"></a>âœ…@EnableAutoConfigurationæ³¨è§£</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@EnableAutoConfiguration</span><br><span class="line"></span><br><span class="line">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br><span class="line"></span><br><span class="line">AutoConfigurationImportSelectorä¸­ï¼š</span><br><span class="line">public String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">    if (!this.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">        return NO_IMPORTS;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        AutoConfigurationImportSelector.AutoConfigurationEntry autoConfigurationEntry = this.getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">        return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ ¸å¿ƒä»£ç ï¼šgetAutoConfigurationEntry</span><br><span class="line">List&lt;String&gt; configurations = this.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line"></span><br><span class="line">protected List&lt;String&gt; getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes) &#123;</span><br><span class="line">    List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(this.getSpringFactoriesLoaderFactoryClass(), this.getBeanClassLoader());</span><br><span class="line">    Assert.notEmpty(configurations, &quot;No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct.&quot;);</span><br><span class="line">    return configurations;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">æ„æ€æ˜¯ï¼šä»spring-boot-autoconfigurationçš„jaråŒ…ä¸‹é¢çš„META-INF/spring.factoriesæ–‡ä»¶ä¸­åŠ è½½ã€‚</span><br><span class="line">çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼š</span><br><span class="line"> # Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span><br><span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span><br><span class="line">æœ‰å¾ˆå¤šé…ç½®æ–‡ä»¶ç±»</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š<br>@EnableAutoConfiguration å¦‚ä½•å®ç°è‡ªåŠ¨é…ç½®<br>1.@EnableAutoConfigurationæ³¨è§£å†…éƒ¨ä½¿ç”¨@Import({AutoConfigurationImportSelector.class}) æ¥åŠ è½½é…ç½®ç±»<br>2.é…ç½®æ–‡ä»¶ä½ç½®ï¼šMETA-INF/spring.factoriesï¼Œè¯¥é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†å¤§é‡çš„é…ç½®ç±»ï¼Œå½“springbootåº”ç”¨å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½è¿™äº›é…ç½®ç±»ï¼Œåˆå§‹åŒ–bean<br>3.å¹¶ä¸æ˜¯æ‰€æœ‰çš„beanéƒ½ä¼šè¢«åˆå§‹åŒ–ï¼Œåœ¨é…ç½®ç±»ä¸­ä½¿ç”¨Conditionæ¥åŠ è½½æ»¡è¶³æ¡ä»¶çš„bean</p>
<h4 id="âœ…è‡ªå®šä¹‰starterå®ç°"><a href="#âœ…è‡ªå®šä¹‰starterå®ç°" class="headerlink" title="âœ…è‡ªå®šä¹‰starterå®ç°"></a>âœ…è‡ªå®šä¹‰starterå®ç°</h4><p>çœ‹mybatis-spring-boot-starterå¦‚ä½•å®ç°ï¼š<br>1.çœ‹åˆ°mybatis-spring-boot-starteråŒ…ä¸‹æ²¡ä»€ä¹ˆï¼Œåªæœ‰ä¸€ä¸ªpomæ–‡ä»¶ï¼Œé‡Œé¢å¼•å…¥mybatis-spring-boot-autoconfigureåŒ…<br>2.mybatis-spring-boot-autoconfigureåŒ…çš„META-INF/spring.factoriesæ–‡ä»¶ä¸­å®šä¹‰äº†MybatisAutoConfiguration<br>3.@EnableAutoConfigurationä¼šè‡ªåŠ¨è¯†åˆ«åˆ°META-INF/spring.factoriesæ–‡ä»¶ï¼Œä»è€Œè¯†åˆ«åˆ°MybatisAutoConfigurationï¼Œæ¨¡å—ä¸­åˆå§‹åŒ–çš„beanå°±åˆ›å»ºå‡ºæ¥</p>
<p>éœ€æ±‚ï¼šè‡ªå®šä¹‰redis-starterï¼Œå½“å¯¼å…¥redis-starteråæ ‡æ—¶ï¼Œspringbootè‡ªåŠ¨åˆ›å»ºjedisçš„beanã€‚</p>
<p>1.åˆ›å»ºä¸€ä¸ªredis-autoconfigurationæ¨¡å—ï¼Œåœ¨é‡Œé¢æä¾›jedisçš„beanï¼Œå¹¶å®ç°è‡ªåŠ¨é…ç½®ã€‚</p>
<p>âš ï¸äº²æµ‹ï¼Œä¸€ä¸ªæ¨¡å—çš„é…ç½®äº†8082ç«¯å£ï¼Œå¦ä¸€ä¸ªæ¨¡å—æ²¡é…ç½®ç«¯å£ï¼Œä½†æ˜¯è¿è¡Œè¯¥æ¨¡å—çš„StartApplicationï¼Œè¦ç”¨çš„æ˜¯8082ç«¯å£ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">RedisAutoConfiguration.class:</span><br><span class="line">@Configuration</span><br><span class="line">@EnableConfigurationProperties(RedisProperties.class) //RedisPropertiesè¢«springè¯†åˆ«ï¼Œåˆ›å»ºbean</span><br><span class="line">@ConditionalOnClass(Jedis.class)  //ç–‘é—®ï¼šæ²¡æœ‰Jedisåæ ‡åˆ™ä¸é…ç½®ï¼Œåˆ›å»ºä¹‹å‰ä¸æ˜¯æ²¡è¿™ä¸ªBeanå—ï¼Ÿå¯¼å…¥åæ ‡å’Œæœ‰beançš„å…³ç³»ï¼Ÿ</span><br><span class="line">public class RedisAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @ConditionalOnMissingBean(name = &quot;jedis&quot;)  //å·²ç»å®šä¹‰äº†å°±ä¸å®šä¹‰</span><br><span class="line">    public Jedis getJedisBean(RedisProperties redisProperties) &#123;</span><br><span class="line">        System.out.println(&quot;RedisAutoConfiguration...&quot;);</span><br><span class="line">        return new Jedis(redisProperties.getIp(), redisProperties.getPort());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RedisProperties.class:</span><br><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">@ConfigurationProperties(prefix = &quot;redis&quot;) //ä¸é…ç½®æ–‡ä»¶ä¸­å¯¹åº”</span><br><span class="line">public class RedisProperties &#123;</span><br><span class="line">    private String ip = &quot;localhost&quot;; //æ²¡æä¾›æ—¶ç»™é»˜è®¤å€¼</span><br><span class="line">    private Integer port = 6379;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.åˆ›å»ºMETA-INF/spring.factoriesæ–‡ä»¶ï¼Œå…¶ä¸­é…ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">    com.liuxuan.redis.configuration.RedisAutoConfiguration</span><br></pre></td></tr></table></figure>

<p>3.åˆ›å»ºredis-starteræ¨¡å—ï¼Œpomæ–‡ä»¶ä¸­å¼•å…¥redis-configurationä¾èµ–ã€‚</p>
<p>4.åœ¨å¦ä¸€ä¸ªæ¨¡å—ä¸­ï¼Œpomæ–‡ä»¶ä¸­å¼•å…¥redis-starterä¾èµ–ã€‚åœ¨StartApplicationä¸­å°è¯•è·å–beanã€‚è¿™ä¸ªæ¨¡å—ä¸­å¯¼å…¥äº†Jedisä¾èµ–ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰Jedisçš„beançš„é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ConfigurableApplicationContext context = SpringApplication.run(StartApplication.class, args);</span><br><span class="line">Jedis jedis = context.getBean(Jedis.class);</span><br><span class="line">System.out.println(jedis);</span><br><span class="line"></span><br><span class="line">jedis.set(&quot;hello&quot;, &quot;hi&quot;);</span><br><span class="line">System.out.println(jedis.get(&quot;hello&quot;));</span><br></pre></td></tr></table></figure>

<p>5.å¯ä»¥åœ¨ä½¿ç”¨çš„æ¨¡å—ä¸­è¿›è¡Œé…ç½®redisçš„ipå’Œhost</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis.port=6379</span><br><span class="line">redis.ip=localhost</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼šStartApplicationä¸Šçš„@SpringBootApplicationæ³¨è§£ä¸­çš„@EnableAutoConfigurationä¸­çš„@Import({AutoConfigurationImportSelector.class})ä¸­ä¼šè‡ªåŠ¨å»æ‰¾jaråŒ…ä¸­çš„META-INF/spring.factoriesæ–‡ä»¶ï¼Œè¯†åˆ«åˆ°éœ€è¦åŠ è½½çš„é…ç½®ç±»ï¼Œå†è·å–é…ç½®ç±»åˆ›å»ºçš„beanï¼Œä»è€Œå®ç°è‡ªåŠ¨é…ç½®beanã€‚</p>
<p>çœ‹spring-boot-autoconfigurationåŒ…ä¸‹çš„dataä¸‹çš„redisä¸‹çš„æ–‡ä»¶ä¸­ï¼Œå°±å®šä¹‰äº†RedisAutoConfigurationï¼Œå’Œä¸Šé¢å®ç°ç±»ä¼¼ã€‚</p>
<h3 id="springbootç›‘å¬æœºåˆ¶"><a href="#springbootç›‘å¬æœºåˆ¶" class="headerlink" title="springbootç›‘å¬æœºåˆ¶"></a>springbootç›‘å¬æœºåˆ¶</h3><p>springbootçš„ç›‘å¬æœºåˆ¶ï¼Œå…¶å®æ˜¯å¯¹javaæä¾›çš„äº‹ä»¶ç›‘å¬æœºåˆ¶çš„å°è£…ã€‚</p>
<p>javaä¸­çš„äº‹ä»¶ç›‘å¬æœºåˆ¶å®šä¹‰äº†ä»¥ä¸‹å‡ ä¸ªè§’è‰²ï¼š<br>1.äº‹ä»¶ï¼šEventï¼Œç»§æ‰¿java.util.EventObjectç±»çš„å¯¹è±¡<br>2.äº‹ä»¶æºï¼šSourceï¼Œä»»æ„å¯¹è±¡Object<br>3.ç›‘å¬å™¨ï¼šListenerï¼Œå®ç°java.util.EventListeneræ¥å£çš„å¯¹è±¡</p>
<p>springbootä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦ï¼Œspringbootåœ¨é¡¹ç›®å¯åŠ¨æ—¶ï¼Œä¼šå¯¹å‡ ä¸ªç›‘å¬å™¨è¿›è¡Œå›è°ƒï¼Œæˆ‘ä»¬å¯ä»¥å®ç°è¿™äº›ç›‘å¬å™¨æ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆä¸€äº›æ“ä½œã€‚</p>
<p>ApplicationContextInitializerã€SpringApplicationRunListenerã€CommandLineRunnerã€ApplicationRunner</p>
<p>1 .ç»§æ‰¿è¿™äº›æ¥å£ï¼Œé‡å†™æ–¹æ³•ï¼Œå¹¶æ‰“å°å¯¹åº”æ“ä½œï¼Œ@Componentæ³¨å†Œbeanã€‚</p>
<p>2 .å¯åŠ¨å‘ç°åªæœ‰åä¸¤ä¸ªæœ‰æ‰“å°ã€‚<br>CommandLineRunnerã€ApplicationRunneråœ¨é¡¹ç›®å¯åŠ¨åæ‰§è¡Œrunæ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚ï¼šç¼“å­˜é¢„çƒ­(æå‰æŠŠæ•°æ®åº“çš„æ•°æ®åŠ åˆ°ç¼“å­˜)<br>æ‰“å°è¿™ä¸¤ä¸ªæ–¹æ³•çš„argsï¼Œå‘ç°æ˜¯ç©ºæ•°ç»„ï¼Œåœ¨é…ç½®ä¸­çš„environmentä¸­çš„program argumentsä¸­æ·»åŠ hello worldï¼Œå°±ä¼šè¿”å›[hello, world]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyCommandLineRunner implements CommandLineRunner &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run(String... args) throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;MyCommandLineRunner run...&quot;);</span><br><span class="line">        System.out.println(&quot;MyCommandLineRunner args:&quot; + Arrays.asList(args));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyApplicationRunner implements ApplicationRunner &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments args) throws Exception &#123;</span><br><span class="line">        System.out.println(&quot;MyApplicationRunner run...&quot;);</span><br><span class="line">        System.out.println(&quot;MyApplicationRunner args:&quot; + Arrays.asList(args.getSourceArgs()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3 .å…¶ä»–ä¸¤ä¸ªç›‘å¬å™¨æ€ä¹ˆç”¨ï¼šåœ¨META-INF/spring.factoriesï¼ˆå›ºå®šçš„å†™æ³•ï¼Œå·¥ç¨‹å¯åŠ¨æ—¶ä¼šè¢«è‡ªåŠ¨æ‰«æåˆ°ï¼‰ä¸­é…ç½®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.ApplicationContextInitializer=\</span><br><span class="line">  com.liuxuan.listener.MyApplicationContextInitializer</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener=\</span><br><span class="line">  com.liuxuan.listener.MySpringApplicationRunListener</span><br></pre></td></tr></table></figure>

<p>MyApplicationContextInitializerçš„initializeæ–¹æ³•ï¼šé¡¹ç›®è¿˜æ²¡æœ‰å‡†å¤‡iocå®¹å™¨ä¹‹å‰ï¼Œå¯ä»¥æ£€æµ‹ä¸€äº›èµ„æºæ˜¯å¦å­˜åœ¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class MyApplicationContextInitializer implements ApplicationContextInitializer &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void initialize(ConfigurableApplicationContext applicationContext) &#123;</span><br><span class="line">        System.out.println(&quot;MyApplicationContextInitializer project start..&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>MySpringApplicationRunListener æŠ¥é”™ï¼š<code>java.lang.NoSuchMethodException: com.liuxuan.listener.MySpringApplicationRunListener.&lt;init&gt;(org.springframework.boot.SpringApplication, [Ljava.lang.String;)</code><br>è¡¨ç¤ºéœ€è¦ä¸€ä¸ªæ„é€ æ–¹æ³•ã€‚<br>çœ‹ä¸€ä¸‹ä»£ç ä¸­æä¾›çš„ä¸€ä¸ªå®ç°ç±»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//å…¥å‚SpringApplicationè¡¨ç¤ºé¡¹ç›®å¯åŠ¨æ—¶çš„äº‹ä»¶æº</span><br><span class="line">public class EventPublishingRunListener implements SpringApplicationRunListener, Ordered &#123;</span><br><span class="line">    private final SpringApplication application;</span><br><span class="line">    private final String[] args;</span><br><span class="line">    private final SimpleApplicationEventMulticaster initialMulticaster;</span><br><span class="line"></span><br><span class="line">    public EventPublishingRunListener(SpringApplication application, String[] args) &#123;</span><br><span class="line">        this.application = application;</span><br><span class="line">        this.args = args;</span><br><span class="line">        this.initialMulticaster = new SimpleApplicationEventMulticaster();</span><br><span class="line">        Iterator var3 = application.getListeners().iterator();</span><br><span class="line"></span><br><span class="line">        while(var3.hasNext()) &#123;</span><br><span class="line">            ApplicationListener&lt;?&gt; listener = (ApplicationListener)var3.next();</span><br><span class="line">            this.initialMulticaster.addApplicationListener(listener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼ŒåŠ ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠ@Componentå»æ‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class MySpringApplicationRunListener implements SpringApplicationRunListener &#123;</span><br><span class="line"></span><br><span class="line">    public MySpringApplicationRunListener(SpringApplication application, String[] args) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void starting(ConfigurableBootstrapContext bootstrapContext) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener é¡¹ç›®å¯åŠ¨ä¸­...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void environmentPrepared(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener ç¯å¢ƒå¯¹è±¡å¼€å§‹å‡†å¤‡ä¸­(è¿˜ä¸èƒ½è·å–é…ç½®ä¿¡æ¯)...&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void contextPrepared(ConfigurableApplicationContext context) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener ä¸Šä¸‹æ–‡å¯¹è±¡å¼€å§‹å‡†å¤‡(è¿˜æ²¡åŠ è½½iocå®¹å™¨)...&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void contextLoaded(ConfigurableApplicationContext context) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener ä¸Šä¸‹æ–‡å¯¹è±¡å¼€å§‹åŠ è½½(åˆ›å»ºspringbootå¯åŠ¨çš„bean)...&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void started(ConfigurableApplicationContext context, Duration timeTaken) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener åŠ è½½å®Œæˆ...&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void started(ConfigurableApplicationContext context) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void ready(ConfigurableApplicationContext context, Duration timeTaken) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void running(ConfigurableApplicationContext context) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener é¡¹ç›®å¯åŠ¨å®Œæˆå¼€å§‹è¿è¡Œ...&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void failed(ConfigurableApplicationContext context, Throwable exception) &#123;</span><br><span class="line">        System.out.println(&quot;MySpringApplicationRunListener é¡¹ç›®å¯åŠ¨å¤±è´¥...&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹spring-bootåŒ…ä¸‹çš„contextä¸‹çš„eventåŒ…ä¸‹çš„ä¸€äº›å®šä¹‰å¥½çš„äº‹ä»¶Eventï¼Œå¾€é‡Œçœ‹éƒ½æ˜¯ç»§æ‰¿è‡ªjavaçš„utilåŒ…ä¸‹çš„EventObjectçš„ã€‚æ‰€ä»¥è¯´springbootçš„äº‹ä»¶ç›‘å¬æ˜¯å¯¹javaäº‹ä»¶ç›‘å¬çš„å°è£…ã€‚</p>
<h3 id="springbootå¯åŠ¨æµç¨‹"><a href="#springbootå¯åŠ¨æµç¨‹" class="headerlink" title="springbootå¯åŠ¨æµç¨‹"></a>springbootå¯åŠ¨æµç¨‹</h3><p>è§‚å¯Ÿè€…æ¨¡å¼ï¼šè§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ï¼Œè¢«è§‚å¯Ÿè€…ï¼šäº‹ä»¶å’Œäº‹ä»¶æºï¼Œè§‚å¯Ÿè€…ï¼šç›‘å¬å™¨ã€‚</p>
<h4 id="âœ…åˆå§‹åŒ–"><a href="#âœ…åˆå§‹åŒ–" class="headerlink" title="âœ…åˆå§‹åŒ–"></a>âœ…åˆå§‹åŒ–</h4><p>debugä¸€ä¸‹å¯åŠ¨ç±»StartApplicationä¸­çš„<code>SpringApplication.run</code>æ–¹æ³•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static ConfigurableApplicationContext run(Class&lt;?&gt;[] primarySources, String[] args) &#123;</span><br><span class="line">    return (new SpringApplication(primarySources)).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºäº†ä¸€ä¸ªSpringApplicationå¯¹è±¡ï¼ˆäº‹ä»¶æºå¯¹è±¡ï¼‰ã€‚</p>
<p>SpringApplicationæ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) &#123;</span><br><span class="line">    this.sources = new LinkedHashSet();</span><br><span class="line">    this.bannerMode = Mode.CONSOLE;</span><br><span class="line">    this.logStartupInfo = true;</span><br><span class="line">    this.addCommandLineProperties = true;</span><br><span class="line">    this.addConversionService = true;</span><br><span class="line">    this.headless = true;</span><br><span class="line">    this.registerShutdownHook = true;</span><br><span class="line">    this.additionalProfiles = Collections.emptySet();</span><br><span class="line">    this.isCustomEnvironment = false;</span><br><span class="line">    this.lazyInitialization = false;</span><br><span class="line">    this.applicationContextFactory = ApplicationContextFactory.DEFAULT;</span><br><span class="line">    this.applicationStartup = ApplicationStartup.DEFAULT;</span><br><span class="line">    this.resourceLoader = resourceLoader;</span><br><span class="line">    Assert.notNull(primarySources, &quot;PrimarySources must not be null&quot;);</span><br><span class="line">    this.primarySources = new LinkedHashSet(Arrays.asList(primarySources));  //æœ‰æ²¡æœ‰ä¸»ç±»</span><br><span class="line">    this.webApplicationType = WebApplicationType.deduceFromClasspath();   //æ˜¯å¦æ˜¯webç¯å¢ƒ</span><br><span class="line">    this.bootstrapRegistryInitializers = new ArrayList(this.getSpringFactoriesInstances(BootstrapRegistryInitializer.class));</span><br><span class="line">    this.setInitializers(this.getSpringFactoriesInstances(ApplicationContextInitializer.class));  //ä»springfactoryæ–‡ä»¶ä¸­åŠ è½½initializers</span><br><span class="line">    this.setListeners(this.getSpringFactoriesInstances(ApplicationListener.class));  //ä»springfactoryé…ç½®æ–‡ä»¶ä¸­åŠ è½½listenerï¼ˆæ”¾åˆ°seté›†åˆä¸­ï¼‰</span><br><span class="line">    this.mainApplicationClass = this.deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/springboot%E5%90%AF%E5%8A%A8.png"></p>
<h4 id="âœ…runæ–¹æ³•"><a href="#âœ…runæ–¹æ³•" class="headerlink" title="âœ…runæ–¹æ³•"></a>âœ…runæ–¹æ³•</h4><p>StartApplicationçš„runæ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">    long startTime = System.nanoTime();  //ç›‘æ§è€—æ—¶ï¼Œä¹Ÿå¯ä»¥ç”¨StopWatch</span><br><span class="line">    DefaultBootstrapContext bootstrapContext = this.createBootstrapContext();</span><br><span class="line">    ConfigurableApplicationContext context = null;  //å®šä¸€ä¸ªå®¹å™¨</span><br><span class="line">    this.configureHeadlessProperty();  //åŠ è½½ä¸œè¥¿</span><br><span class="line">    SpringApplicationRunListeners listeners = this.getRunListeners(args);  //è·å–RunListener</span><br><span class="line">    listeners.starting(bootstrapContext, this.mainApplicationClass);  //è°ƒç”¨runListenerçš„startingæ–¹æ³•</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);</span><br><span class="line">        ConfigurableEnvironment environment = this.prepareEnvironment(listeners, bootstrapContext, applicationArguments);  //å‡†å¤‡ç¯å¢ƒï¼Œå›è°ƒrunListenerçš„prepareEnvironmentæ–¹æ³•ï¼Œç¯å¢ƒå¯¹è±¡Environmentå°±æœ‰ä¿¡æ¯äº†</span><br><span class="line">        this.configureIgnoreBeanInfo(environment);</span><br><span class="line">        Banner printedBanner = this.printBanner(environment);  //æ‰“å°springå›¾æ ‡ï¼Œå¯ä»¥æ›¿æ¢banner.txt</span><br><span class="line">        context = this.createApplicationContext();  //åˆ›å»ºiocå®¹å™¨</span><br><span class="line">        context.setApplicationStartup(this.applicationStartup);</span><br><span class="line">        this.prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);  //åŠ è½½iocå®¹å™¨</span><br><span class="line">        // å¯ä»¥çœ‹contexté‡Œçš„beanFactoryé‡Œçš„beanDefinitionMapï¼Œé‡Œé¢æ˜¯çœŸæ­£çš„beanï¼Œè¿™æ—¶è¿˜æ²¡åŠ è½½bean</span><br><span class="line">        this.refreshContext(context);  //è¿™é‡Œä»é…ç½®æ–‡ä»¶é‡Œæ‰¾ï¼Œåˆ›å»ºbeanï¼ˆè€—æ—¶æ“ä½œï¼‰</span><br><span class="line">        this.afterRefresh(context, applicationArguments);</span><br><span class="line">        Duration timeTakenToStartup = Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">        if (this.logStartupInfo) &#123;</span><br><span class="line">            (new StartupInfoLogger(this.mainApplicationClass)).logStarted(this.getApplicationLog(), timeTakenToStartup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listeners.started(context, timeTakenToStartup);  //é¡¹ç›®å¯åŠ¨æˆåŠŸï¼ŒåŠ è½½æˆåŠŸ</span><br><span class="line">        this.callRunners(context, applicationArguments);  //commandLineRunnerå’ŒapplicationRunner å›è°ƒæ‰§è¡Œ</span><br><span class="line">    &#125; catch (Throwable var12) &#123;</span><br><span class="line">        this.handleRunFailure(context, var12, listeners);</span><br><span class="line">        throw new IllegalStateException(var12);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        Duration timeTakenToReady = Duration.ofNanos(System.nanoTime() - startTime);</span><br><span class="line">        listeners.ready(context, timeTakenToReady);</span><br><span class="line">        return context;</span><br><span class="line">    &#125; catch (Throwable var11) &#123;</span><br><span class="line">        this.handleRunFailure(context, var11, (SpringApplicationRunListeners)null);</span><br><span class="line">        throw new IllegalStateException(var11);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šï¼Œé€šè¿‡debugæºç çš„æ–¹å¼ï¼Œæ¢ç´¢äº†springbootå¯åŠ¨æµç¨‹ï¼Œçœ‹äº†ç›‘å¬å™¨æ–¹æ³•åœ¨å“ªé‡Œæ‰§è¡Œå›è°ƒã€‚</p>
<h2 id="springbootç›‘æ§"><a href="#springbootç›‘æ§" class="headerlink" title="springbootç›‘æ§"></a>springbootç›‘æ§</h2><h3 id="urlæ–¹å¼"><a href="#urlæ–¹å¼" class="headerlink" title="urlæ–¹å¼"></a>urlæ–¹å¼</h3><p>SpringBootè‡ªå¸¦ç›‘æ§åŠŸèƒ½Actuatorï¼Œå¯ä»¥å¸®åŠ©å®ç°å¯¹ç¨‹åºå†…éƒ¨è¿è¡Œæƒ…å†µç›‘æ§ï¼Œæ¯”å¦‚ç›‘æ§çŠ¶å†µã€BeanåŠ è½½æƒ…å†µã€é…ç½®å±æ€§ ã€æ—¥å¿—ä¿¡æ¯ç­‰ã€‚</p>
<p>ä½¿ç”¨æ­¥éª¤</p>
<p>â‘  å¯¼å…¥ä¾èµ–åæ ‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>â‘¡ è®¿é—®<a target="_blank" rel="noopener" href="http://localhost:8080/actuator">http://localhost:8080/actuator</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_links&quot;:&#123;</span><br><span class="line">        &quot;self&quot;:&#123;</span><br><span class="line">            &quot;href&quot;:&quot;http://localhost:8082/actuator&quot;,</span><br><span class="line">            &quot;templated&quot;:false</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;health-path&quot;:&#123;</span><br><span class="line">            &quot;href&quot;:&quot;http://localhost:8082/actuator/health/&#123;*path&#125;&quot;,</span><br><span class="line">            &quot;templated&quot;:true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;health&quot;:&#123;</span><br><span class="line">            &quot;href&quot;:&quot;http://localhost:8082/actuator/health&quot;,</span><br><span class="line">            &quot;templated&quot;:false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è·¯å¾„	æè¿°</span><br><span class="line">/beans	æè¿°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡é‡Œå…¨éƒ¨çš„Beanï¼Œä»¥åŠå®ƒä»¬çš„å…³ç³»</span><br><span class="line">/env	è·å–å…¨éƒ¨ç¯å¢ƒå±æ€§</span><br><span class="line">/env/&#123;name&#125;	æ ¹æ®åç§°è·å–ç‰¹å®šçš„ç¯å¢ƒå±æ€§å€¼</span><br><span class="line">/health	æŠ¥å‘Šåº”ç”¨ç¨‹åºçš„å¥åº·æŒ‡æ ‡ï¼Œè¿™äº›å€¼ç”±HealthIndicatorçš„å®ç°ç±»æä¾›</span><br><span class="line">/info	è·å–åº”ç”¨ç¨‹åºçš„å®šåˆ¶ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ç”±infoæ‰“å¤´çš„å±æ€§æä¾›</span><br><span class="line">/mappings	æè¿°å…¨éƒ¨çš„URIè·¯å¾„ï¼Œä»¥åŠå®ƒä»¬å’Œæ§åˆ¶å™¨(åŒ…å«Actuatorç«¯ç‚¹)çš„æ˜ å°„å…³ç³»</span><br><span class="line">/metrics	æŠ¥å‘Šå„ç§åº”ç”¨ç¨‹åºåº¦é‡ä¿¡æ¯ï¼Œæ¯”å¦‚å†…å­˜ç”¨é‡å’ŒHTTPè¯·æ±‚è®¡æ•°</span><br><span class="line">/metrics/&#123;name&#125;	æŠ¥å‘ŠæŒ‡å®šåç§°çš„åº”ç”¨ç¨‹åºåº¦é‡å€¼</span><br><span class="line">/trace	æä¾›åŸºæœ¬çš„HTTPè¯·æ±‚è·Ÿè¸ªä¿¡æ¯(æ—¶é—´æˆ³ã€HTTPå¤´ç­‰)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">info:</span><br><span class="line">  name: hello</span><br><span class="line">  age: 23</span><br><span class="line"></span><br><span class="line">management:</span><br><span class="line">  #å¼€å¯å¥åº·æ£€æŸ¥çš„å®Œæ•´ä¿¡æ¯</span><br><span class="line">  endpoint:</span><br><span class="line">    health:</span><br><span class="line">      show-details: always</span><br><span class="line">  #å°†æ‰€æœ‰çš„ç›‘æ§endPointsæš´æ¼å‡ºæ¥</span><br><span class="line">  endpoints:</span><br><span class="line">    web:</span><br><span class="line">      exposure:</span><br><span class="line">        include: *</span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot-Admin"><a href="#Spring-Boot-Admin" class="headerlink" title="Spring Boot Admin"></a>Spring Boot Admin</h3><p>ç›‘æ§çš„å¯è§†åŒ–ç•Œé¢ï¼Œåªä¸è¿‡éœ€è¦è‡ªå·±å†èµ·ä¸ªç›‘æ§æœåŠ¡ã€‚</p>
<p>Spring Boot Adminæ˜¯ä¸€ä¸ªå¼€æºç¤¾åŒºé¡¹ç›®ï¼Œç”¨äºç®¡ç†å’Œç›‘æ§SpringBootåº”ç”¨ç¨‹åºã€‚</p>
<p>Spring Boot Admin æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œå®¢æˆ·ç«¯(Client)å’ŒæœåŠ¡ç«¯(Server)ã€‚</p>
<p>åº”ç”¨ç¨‹åºä½œä¸ºSpring Boot Admin Clientå‘ä¸ºSpring Boot Admin Serveræ³¨å†Œ</p>
<p>Spring Boot Admin Server çš„UIç•Œé¢å°†Spring Boot Admin Clientçš„Actuator Endpointä¸Šçš„ä¸€äº›ç›‘æ§ä¿¡æ¯.</p>
<p>ä½¿ç”¨æ­¥éª¤ï¼š</p>
<p>admin-serverï¼ˆç›‘æ§æœåŠ¡ï¼‰</p>
<p>â‘  åˆ›å»º admin-server æ¨¡å—</p>
<p>â‘¡ å¯¼å…¥ä¾èµ–åæ ‡ admin-starter-server</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;de.codecentric&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-admin-starter-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>â‘¢ åœ¨å¼•å¯¼ç±»ä¸Šå¯ç”¨ç›‘æ§åŠŸèƒ½@EnableAdminServer</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableAdminServer</span><br><span class="line">public class SpringbootAdminServerApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(SpringbootAdminServerApplication.class, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<p>admin-clientï¼ˆè¢«ç›‘æ§æœåŠ¡ï¼‰</p>
<p>â‘  åˆ›å»º admin-client æ¨¡å—</p>
<p>â‘¡ å¯¼å…¥ä¾èµ–åæ ‡ admin-starter-client</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;de.codecentric&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-admin-starter-client&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>â‘¢ é…ç½®ç›¸å…³ä¿¡æ¯ï¼šserveråœ°å€ç­‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æŒ‡å®šadmin.serveråœ°å€ï¼Œserveråœ¨9000ç«¯å£å·ï¼Œç›¸å½“äºå‘serveræ³¨å†Œ</span><br><span class="line">spring.boot.admin.client.url=http://localhost:9000</span><br><span class="line">å±•ç¤ºå¥åº·æ£€æŸ¥è¯¦ç»†è¯¦ç»†å±•ç¤ºå‡ºæ¥</span><br><span class="line">management.endpoint.health.show-details=always</span><br><span class="line">å¼€å¯æ‰€æœ‰é…ç½®</span><br><span class="line">management.endpoints.web.exposure.include=*</span><br></pre></td></tr></table></figure>

<p>â‘£ å¯åŠ¨serverå’ŒclientæœåŠ¡ï¼Œè®¿é—®server<br><a target="_blank" rel="noopener" href="http://localhost:9000/applications">http://localhost:9000/applications</a></p>
<hr>
<p>å‡ºç°é—®é¢˜ï¼š<br>Failed to configure a DataSource: â€˜urlâ€™ attribute is not specified and no embedded datasource could be configured.</p>
<p>åŸå› ï¼šå½“å‰é¡¹ç›®æ²¡æœ‰é…ç½®DataSourceç›¸å…³é…ç½®ã€‚springbootè‡ªåŠ¨é…ç½®æ—¶ï¼Œæ£€æµ‹åˆ°æ·»åŠ äº†mysqlçš„ä¾èµ–åŒ…ï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶ä¸­å´æ²¡æ·»åŠ æ•°æ®åº“çš„ç›¸å…³é…ç½®ã€‚<br>è¯¥æ¡ˆä¾‹ä¸­ï¼šmysqlä¾èµ–åœ¨çˆ¶pomä¸­å¼•å…¥ï¼Œè¯¥å­å·¥ç¨‹ä¸ç”¨mysqlã€‚</p>
<p>è§£å†³åŠæ³•ï¼š@SpringBootApplication(exclude = DataSourceAutoConfiguration.class) æ’é™¤è‡ªåŠ¨æ³¨å…¥æ•°æ®åº“é…ç½®</p>
<hr>
<p>ä¸çŸ¥é“æ˜¯ä¸æ˜¯åŒ…çš„ç‰ˆæœ¬ä¸å¯¹ï¼Œæœ‰çš„ç‰ˆæœ¬æŠ¥é”™ï¼Œæœ‰çš„ç‰ˆæœ¬è¿è¡Œäº†å´æ²¡æ˜¾ç¤ºã€‚<br>ideaä¸­ç‚¹EndPoinså°±å¯ä»¥å›¾å½¢åŒ–ç•Œé¢çš„æ–¹å¼æ¥ç›‘æ§ï¼Œä¸ç”¨é‚£ä¹ˆéº»çƒ¦ï¼Œ</p>
<h2 id="springbooté¡¹ç›®éƒ¨ç½²"><a href="#springbooté¡¹ç›®éƒ¨ç½²" class="headerlink" title="springbooté¡¹ç›®éƒ¨ç½²"></a>springbooté¡¹ç›®éƒ¨ç½²</h2><p>SpringBoot é¡¹ç›®å¼€å‘å®Œæ¯•åï¼Œæ”¯æŒä¸¤ç§æ–¹å¼éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼š</p>
<p>â‘  jaråŒ…(å®˜æ–¹æ¨è) ç”¨å†…ç½®çš„tomcatå¯åŠ¨</p>
<p>â‘¡ waråŒ…</p>
<h3 id="jaræ‰“åŒ…æ–¹å¼"><a href="#jaræ‰“åŒ…æ–¹å¼" class="headerlink" title="jaræ‰“åŒ…æ–¹å¼"></a>jaræ‰“åŒ…æ–¹å¼</h3><p>å°†å½“å‰æ¨¡å—æ‰“åŒ…ï¼šideaå³è¾¹mavenä¸­é€‰æ‹©è¦æ‰“åŒ…çš„æ¨¡å—ï¼Œç‚¹lifecycleï¼Œç‚¹packageã€‚</p>
<p>æ‰“å¥½çš„jaråŒ…åœ¨é¡¹ç›®çš„targetç›®å½•ä¸‹ã€‚ç›´æ¥<code>java -jar .\jaråŒ…åç§°</code>ï¼Œå¯åŠ¨æˆåŠŸã€‚</p>
<h3 id="waræ‰“åŒ…æ–¹å¼"><a href="#waræ‰“åŒ…æ–¹å¼" class="headerlink" title="waræ‰“åŒ…æ–¹å¼"></a>waræ‰“åŒ…æ–¹å¼</h3><p>pom.xmlé‡Œæ›´æ”¹æ‰“åŒ…æ–¹å¼ï¼š<code>&lt;packaging&gt;war&lt;/packaging&gt;</code><br>å¦‚æœæƒ³æ”¹waråŒ…çš„åå­—ï¼š<code>&lt;finalName&gt;</code>æ ‡ç­¾</p>
<p>åœ¨å¼•å¯¼ç±»ç»§æ‰¿SpringBootServletInitializerç±»ï¼Œå¹¶é‡å†™configureæ–¹æ³•:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class SpringBootDeployApplication extends SpringBootServletInitializer &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(SpringBootDeployApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) &#123;</span><br><span class="line">        return builder.sources(SpringBootDeployApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œï¼Œæ‰“å¥½çš„waråŒ…å¯ä»¥è¢«å¤–éƒ¨tomcatè¯†åˆ«ï¼Œå°†å…¶æ”¾åœ¨tomcatç›®å½•ä¸‹çš„webappsç›®å½•ä¸‹ï¼Œå¯åŠ¨tomcatå³å¯ï¼ˆstartup.batï¼‰ï¼Œæµè§ˆå™¨è®¿é—®éœ€è¦åŠ é¡¹ç›®çš„åŒ…åç§°ï¼Œå› ä¸ºWEB-INFæ–‡ä»¶åœ¨å…¶ä¹‹ä¸‹ã€‚å¹¶ä¸”ï¼Œå†…ç½®é¡¹ç›®çš„ç«¯å£å·é…ç½®å°±ä¸ç”Ÿæ•ˆäº†ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/22/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/sqlite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/22/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/sqlite/" class="post-title-link" itemprop="url">sqlite</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-22 11:49:15" itemprop="dateCreated datePublished" datetime="2022-12-22T11:49:15+08:00">2022-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-05 12:19:43" itemprop="dateModified" datetime="2023-02-05T12:19:43+08:00">2023-02-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä»€ä¹ˆæ˜¯sqlite"><a href="#ä»€ä¹ˆæ˜¯sqlite" class="headerlink" title="ä»€ä¹ˆæ˜¯sqlite"></a>ä»€ä¹ˆæ˜¯sqlite</h2><p>SQLite æ˜¯ä¸€ä¸ªè½¯ä»¶åº“ï¼Œå®ç°äº†è‡ªç»™è‡ªè¶³çš„ã€æ— æœåŠ¡å™¨çš„ã€é›¶é…ç½®çš„ã€äº‹åŠ¡æ€§çš„ SQL æ•°æ®åº“å¼•æ“ã€‚SQLite æ˜¯åœ¨ä¸–ç•Œä¸Šæœ€å¹¿æ³›éƒ¨ç½²çš„ SQL æ•°æ®åº“å¼•æ“ã€‚</p>
<p>å®ƒæ˜¯ä¸€ä¸ªé›¶é…ç½®çš„æ•°æ®åº“ï¼Œè¿™æ„å‘³ç€ä¸å…¶ä»–æ•°æ®åº“ä¸ä¸€æ ·ï¼Œæ‚¨ä¸éœ€è¦åœ¨ç³»ç»Ÿä¸­é…ç½®ã€‚</p>
<hr>
<p>sqliteçš„ä¼˜ç‚¹ï¼š</p>
<p>&lt;1&gt; ä¸éœ€è¦ä¸€ä¸ªå•ç‹¬çš„æœåŠ¡å™¨è¿›ç¨‹æˆ–æ“ä½œçš„ç³»ç»Ÿï¼ˆæ— æœåŠ¡å™¨çš„ï¼‰<br>&lt;2&gt; SQLite ä¸éœ€è¦é…ç½®ï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦å®‰è£…æˆ–ç®¡ç†ã€‚<br>&lt;3&gt; ä¸€ä¸ªå®Œæ•´çš„ SQLite æ•°æ®åº“æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªå•ä¸€çš„è·¨å¹³å°çš„ç£ç›˜æ–‡ä»¶ã€‚<br>&lt;4&gt; SQLite æ˜¯éå¸¸å°çš„ï¼Œæ˜¯è½»é‡çº§çš„ï¼Œå®Œå…¨é…ç½®æ—¶å°äº 400KB<br>&lt;5&gt; SQLite æ˜¯è‡ªç»™è‡ªè¶³çš„ï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦ä»»ä½•å¤–éƒ¨çš„ä¾èµ–ã€‚<br>&lt;6&gt; SQLite äº‹åŠ¡æ˜¯å®Œå…¨å…¼å®¹ ACID çš„ï¼Œå…è®¸ä»å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å®‰å…¨è®¿é—®ã€‚</p>
<h2 id="å®‰è£…sqlite"><a href="#å®‰è£…sqlite" class="headerlink" title="å®‰è£…sqlite"></a>å®‰è£…sqlite</h2><p>linuxå’ŒmacOSï¼ŒåŸºæœ¬éƒ½ç³»ç»Ÿé¢„è£…äº†ã€‚<br>è¾“å…¥<code>sqlite3</code>æ£€æŸ¥æ˜¯å¦å®‰è£…ã€‚</p>
<p>å¦‚æœæœªå®‰è£…ï¼Œä¸‹è½½ç½‘å€ï¼š<a target="_blank" rel="noopener" href="https://www.sqlite.org/download.html">https://www.sqlite.org/download.html</a><br>ä¸‹è½½<code>sqlite-autoconf-*.tar.gzã€‚</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvzf sqlite-autoconf-3071502.tar.gz</span><br><span class="line">$ cd sqlite-autoconf-3071502</span><br><span class="line">$ ./configure --prefix=/usr/local</span><br><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>

<h2 id="sqliteå‘½ä»¤"><a href="#sqliteå‘½ä»¤" class="headerlink" title="sqliteå‘½ä»¤"></a>sqliteå‘½ä»¤</h2><p><code>.show </code>å‘½åï¼ŒæŸ¥çœ‹ SQLite å‘½ä»¤æç¤ºç¬¦çš„é»˜è®¤è®¾ç½®ã€‚</p>
<p>æ›´æ”¹é…ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlite&gt;.header on    </span><br><span class="line">sqlite&gt;.mode column</span><br><span class="line">sqlite&gt;.timer on</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ•°æ®åº“ï¼š<br><code>$ sqlite3 DatabaseName.db </code> æˆ– <code>sqlite&gt;.open test.db </code></p>
<p>åˆ›å»ºçš„æ•°æ®åº“æ–‡ä»¶ä½äº sqlite3 å‘½ä»¤åŒä¸€ç›®å½•ä¸‹ã€‚<br>æ‰“å¼€å·²å­˜åœ¨æ•°æ®åº“ä¹Ÿæ˜¯ç”¨ .open å‘½ä»¤ï¼Œä»¥ä¸Šå‘½ä»¤å¦‚æœ test.db å­˜åœ¨åˆ™ç›´æ¥ä¼šæ‰“å¼€ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºå®ƒã€‚</p>
<p><code>.databases</code> å±•ç¤ºæ•°æ®åº“åˆ—è¡¨<br><code>.quit</code> é€€å‡º<br><code>testDB.db .dump &gt; testDB.sql</code> å¯¼å‡ºå®Œæ•´çš„æ•°æ®åº“åˆ°æ–‡æœ¬æ–‡ä»¶ä¸­<br><code>testDB.db &lt; testDB.sql</code> æ¢å¤dbæ–‡ä»¶</p>
<p><code>attach database file_name AS database_name;</code> å°†åŒä¸€æ–‡ä»¶å¤¹ä¸‹çš„dbæ–‡ä»¶é™„åŠ è¿›æ¥ï¼Œå¹¶ç»™ä¸ªåˆ«åã€‚<br>æ•°æ®åº“åç§° main å’Œ temp è¢«ä¿ç•™ç”¨äºä¸»æ•°æ®åº“å’Œå­˜å‚¨ä¸´æ—¶è¡¨åŠå…¶ä»–ä¸´æ—¶æ•°æ®å¯¹è±¡çš„æ•°æ®åº“ã€‚è¿™ä¸¤ä¸ªæ•°æ®åº“åç§°å¯ç”¨äºæ¯ä¸ªæ•°æ®åº“è¿æ¥ï¼Œä¸”ä¸åº”è¯¥è¢«ç”¨äºé™„åŠ ã€‚</p>
<p><code>detach database &#39;database_name&#39;;</code> æ–­å¼€ç»™å®šåç§°çš„è¿æ¥ï¼Œè€Œå…¶ä½™çš„ä»ç„¶æœ‰æ•ˆ</p>
<p>åˆ›å»ºè¡¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE database_name.table_name(</span><br><span class="line">   ID INT PRIMARY KEY     NOT NULL,</span><br><span class="line">   NAME           TEXT    NOT NULL,</span><br><span class="line">   AGE            INT     NOT NULL,</span><br><span class="line">   ADDRESS        CHAR(50),</span><br><span class="line">   SALARY         REAL</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>.tables</code> æŸ¥çœ‹åˆ›å»ºçš„è¡¨</p>
<p><code>.schema tableName</code> å¾—åˆ°è¡¨çš„å®Œæ•´ä¿¡æ¯ï¼ˆå»ºè¡¨è¯­å¥ï¼‰</p>
<h2 id="javaä½¿ç”¨sqlite"><a href="#javaä½¿ç”¨sqlite" class="headerlink" title="javaä½¿ç”¨sqlite"></a>javaä½¿ç”¨sqlite</h2><p>SQLiteç›¸æ¯”å¤§å¤šæ•°æ•°æ®åº“è€Œè¨€ï¼Œå…·æœ‰å…å®‰è£…ç­‰ä¼˜åŠ¿ï¼Œå¹¿æ³›åº”ç”¨äºæµ‹è¯•ã€Androidç­‰é¢†åŸŸã€‚é€šè¿‡ä¸€ä¸ª.dbæ–‡ä»¶å°±èƒ½å®ç°æ•°æ®åº“è¿æ¥ã€DDLæ“ä½œè¯­å¥ã€DMLå‘½ä»¤ã€‚</p>
<p>å¯¼å…¥<code>sqlite-jdbc</code>ä¾èµ–:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.xerial&lt;/groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;sqlite-jdbc&lt;/artifactId&gt;</span><br><span class="line">   &lt;version&gt;3.40.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>è½¯ä»¶ï¼šDB Browser for SQLite</p>
<p>sqliteæ²¡æœ‰åƒmysqlä½¿ç”¨commentå¢åŠ å­—æ®µ/è¡¨åæ³¨é‡Šï¼Œä½¿ç”¨â€“æ³¨é‡Šå†…å®¹ã€‚</p>
<p>âœ…å»ºè¡¨ã€æ’å…¥ã€æŸ¥è¯¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">package com.liuxuan.service;</span><br><span class="line"></span><br><span class="line">import lombok.Getter;</span><br><span class="line">import lombok.Setter;</span><br><span class="line">import lombok.ToString;</span><br><span class="line">import org.apache.commons.dbutils.QueryRunner;</span><br><span class="line">import org.apache.commons.dbutils.handlers.BeanListHandler;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.sql.*;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2023-01-20 09:41</span><br><span class="line"> **/</span><br><span class="line">@Service</span><br><span class="line">public class SqliteService &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String filePath = &quot;/Users/liuxuan/Downloads/test.db&quot;;</span><br><span class="line">        Connection conn = createConnection(filePath);</span><br><span class="line">        // åˆ›å»ºè¡¨</span><br><span class="line">        String query = &quot;create table if not exists table_test (\n&quot; +</span><br><span class="line">                &quot;id integer PRIMARY KEY AUTOINCREMENT,\n&quot; +</span><br><span class="line">                &quot;num INTEGER(11),\n&quot; +</span><br><span class="line">                &quot;`desc` varchar(10) not null);&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            Statement stmt = conn.createStatement();</span><br><span class="line">            stmt.executeUpdate(query);</span><br><span class="line">            stmt.close();</span><br><span class="line">//            conn.commit();</span><br><span class="line">//            conn.close();</span><br><span class="line">        &#125; catch (SQLException e)&#123;</span><br><span class="line">            System.out.println(&quot;å»ºç«‹è¡¨å­˜åœ¨å¼‚å¸¸ï¼&quot; + e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // æ’å…¥æ•°æ®</span><br><span class="line">        String sql = &quot;insert into table_test (num, desc) &quot; +</span><br><span class="line">                &quot;values(1, &#x27;one&#x27;);&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            Statement stmt = conn.createStatement();</span><br><span class="line">            stmt.executeUpdate(sql);</span><br><span class="line">            stmt.close();</span><br><span class="line">        &#125; catch (SQLException e)&#123;</span><br><span class="line">            System.out.println(&quot;æ’å…¥æ•°æ®å­˜åœ¨å¼‚å¸¸ï¼&quot; + e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // æŸ¥è¯¢æ•°æ®</span><br><span class="line">        try &#123;</span><br><span class="line">            Statement stmt = conn.createStatement();</span><br><span class="line">            ResultSet rs = stmt.executeQuery( &quot;SELECT * FROM table_test;&quot; );</span><br><span class="line">            while (rs.next() ) &#123;</span><br><span class="line">                int id = rs.getInt(&quot;id&quot;);</span><br><span class="line">                int num = rs.getInt(&quot;num&quot;);</span><br><span class="line">                String desc = rs.getString(&quot;desc&quot;);</span><br><span class="line">                System.out.println(id + &quot;,&quot; + num + &quot;,&quot; + desc);</span><br><span class="line">            &#125;</span><br><span class="line">            rs.close();</span><br><span class="line">        &#125; catch (SQLException e)&#123;</span><br><span class="line">            System.out.println(&quot;æŸ¥è¯¢æ•°æ®å­˜åœ¨å¼‚å¸¸ï¼&quot; + e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // åˆ†é¡µæŸ¥è¯¢ ç”¨commons-dbutilsåŒ…ä¸‹çš„QueryRunner</span><br><span class="line">        String selectSql = &quot;select * from table_test&quot;;</span><br><span class="line">        try &#123;</span><br><span class="line">            List&lt;SqliteDO&gt; list = selectList(selectSql, conn, SqliteDO.class, 1, 10);</span><br><span class="line">            System.out.println(list);</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            System.out.println(&quot;æŸ¥è¯¢æ•°æ®listå­˜åœ¨å¼‚å¸¸ï¼&quot; + e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * è·å–æ•°æ®åº“è¿æ¥</span><br><span class="line">     **/</span><br><span class="line">    public static Connection createConnection(String filePath) &#123;</span><br><span class="line">        Connection conn = null;</span><br><span class="line">        try&#123;</span><br><span class="line">            Class.forName(&quot;org.sqlite.JDBC&quot;);</span><br><span class="line">            conn = DriverManager.getConnection(String.format(&quot;jdbc:sqlite:%s&quot;, filePath));</span><br><span class="line">        &#125;catch(ClassNotFoundException e)&#123;</span><br><span class="line">            System.out.println(&quot;ä¸å­˜åœ¨sqliteé©±åŠ¨åŒ…ï¼&quot;);</span><br><span class="line">        &#125;catch (SQLException e)&#123;</span><br><span class="line">            System.out.println(&quot;ä¸sqliteæ•°æ®åº“è¿æ¥å¤±è´¥ï¼&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static &lt;T&gt; List&lt;T&gt; selectList(String sql, Connection connection, Class&lt;T&gt;objType, int currentPage, int pageSize) throws SQLException &#123;</span><br><span class="line">        sql = sql + &quot; limit ?,?&quot;;</span><br><span class="line">        QueryRunner queryRunner = new QueryRunner();</span><br><span class="line">        List&lt;T&gt; dataList = queryRunner.query(connection, sql, new BeanListHandler&lt;&gt;(objType), pageSize * (currentPage - 1), pageSize);</span><br><span class="line">        return dataList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @ToString</span><br><span class="line">    @Getter</span><br><span class="line">    @Setter</span><br><span class="line">    public static class SqliteDO &#123;</span><br><span class="line">        private Integer id;</span><br><span class="line">        private Integer num;</span><br><span class="line">        private String desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>âœ…çº¿ç¨‹å®‰å…¨</p>
<p>sqliteæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥å¤šçº¿ç¨‹æ’å…¥ã€‚</p>
<p>âœ…sqliteåœ¨javaä¸­æ‰¹é‡æ’å…¥æ•°æ®å·¨æ…¢</p>
<p>å¼€å§‹æ˜¯æ’å…¥ä¸€æ¡å°±æ„é€ ä¸€æ¡insertè¯­å¥ï¼Œä¸€æ¡ä¸€æ¡æ’å…¥ï¼Œæ…¢ã€‚<br>åæ¥æ”¹æˆå¤šçº¿ç¨‹æ’å…¥ï¼Œè¿˜æ˜¯æ…¢ã€‚<br>å†åæ¥ï¼Œä¸€æ¡insertè¯­å¥æ’å…¥1000æ¡ï¼Œå¿«äº†å¾ˆå¤šã€‚</p>
<p>ä¸€ä¸ªè¯´äº‹åŠ¡æ§åˆ¶æ‰¹é‡æ’å…¥çš„ï¼š<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiao-tangyuan/p/9556114.html">https://www.cnblogs.com/xiao-tangyuan/p/9556114.html</a></p>
<hr>
<p>SQLiteâ€”â€”Javaä½¿ç”¨ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38322527/article/details/125717093">https://blog.csdn.net/qq_38322527/article/details/125717093</a></p>
<p>SQLiteæ•°æ®åº“åŸºæœ¬ä½¿ç”¨ï¼ˆJavaï¼‰ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44102521/article/details/119884521">https://blog.csdn.net/weixin_44102521/article/details/119884521</a></p>
<p>æŸ¥è¯¢è·å–listï¼š<br><a target="_blank" rel="noopener" href="https://m.runoob.com/sqlite/sqlite-java.html?ivk_sa=1024320u">https://m.runoob.com/sqlite/sqlite-java.html?ivk_sa=1024320u</a></p>
<p>sqliteæ²¡æœ‰commentï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qinxu0611/article/details/128609756">https://blog.csdn.net/qinxu0611/article/details/128609756</a></p>
<p>SQLite çº¿ç¨‹å®‰å…¨å’Œå¹¶å‘ï¼š<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/feng9exe/p/10682567.html">https://www.cnblogs.com/feng9exe/p/10682567.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/10/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/10/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/elasticsearch/" class="post-title-link" itemprop="url">elasticsearch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-10 15:22:27" itemprop="dateCreated datePublished" datetime="2022-12-10T15:22:27+08:00">2022-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-22 11:49:00" itemprop="dateModified" datetime="2022-12-22T11:49:00+08:00">2022-12-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ä»€ä¹ˆæ˜¯elasticsearch"><a href="#ä»€ä¹ˆæ˜¯elasticsearch" class="headerlink" title="ä»€ä¹ˆæ˜¯elasticsearch"></a>ä»€ä¹ˆæ˜¯elasticsearch</h2><p>ES=elaticsearchç®€å†™ï¼Œ Elasticsearchæ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ‰©å±•çš„åˆ†å¸ƒå¼å…¨æ–‡æ£€ç´¢å¼•æ“ï¼Œå®ƒå¯ä»¥è¿‘ä¹å®æ—¶çš„å­˜å‚¨ã€æ£€ç´¢æ•°æ®ï¼›æœ¬èº«æ‰©å±•æ€§å¾ˆå¥½ï¼Œå¯ä»¥æ‰©å±•åˆ°ä¸Šç™¾å°æœåŠ¡å™¨ï¼Œå¤„ç†PBçº§åˆ«çš„æ•°æ®ã€‚<br>Elasticsearchä¹Ÿä½¿ç”¨Javaå¼€å‘å¹¶ä½¿ç”¨Luceneä½œä¸ºå…¶æ ¸å¿ƒæ¥å®ç°æ‰€æœ‰ç´¢å¼•å’Œæœç´¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ç®€å•çš„RESTful APIæ¥éšè—Luceneçš„å¤æ‚æ€§ï¼Œé€šè¿‡é¢å‘æ–‡æ¡£ä»è€Œè®©å…¨æ–‡æœç´¢å˜å¾—ç®€å•ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45081813/article/details/113061113">https://blog.csdn.net/weixin_45081813/article/details/113061113</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/27/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/27/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">è®¾è®¡æ¨¡å¼</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-27 19:31:18 / Modified: 22:10:25" itemprop="dateCreated datePublished" datetime="2022-11-27T19:31:18+08:00">2022-11-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å·¥å‚æ¨¡å¼"><a href="#å·¥å‚æ¨¡å¼" class="headerlink" title="å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h2><p>å·¥å‚æ¨¡å¼æ˜¯ç”¨å·¥å‚æ–¹æ³•ä»£æ›¿newæ“ä½œçš„ä¸€ç§æ¨¡å¼ã€‚ä¾‹å¦‚ï¼ŒExecutorsåˆ›å»ºçº¿ç¨‹æ± ExecutorServiceçš„æ–¹æ³•ï¼Œå°±æ˜¯å·¥å‚æ¨¡å¼ã€‚</p>
<p>å·¥å‚æ¨¡å¼åœ¨Javaç¨‹åºç³»ç»Ÿå¯ä»¥è¯´æ˜¯éšå¤„å¯è§ã€‚å› ä¸ºå·¥å‚æ¨¡å¼å°±ç›¸å½“äºåˆ›å»ºå®ä¾‹å¯¹è±¡çš„newï¼Œæˆ‘ä»¬ç»å¸¸è¦æ ¹æ®ç±»Classç”Ÿæˆå®ä¾‹å¯¹è±¡ï¼Œå¦‚A a=new A()ï¼Œå·¥å‚æ¨¡å¼ä¹Ÿæ˜¯ç”¨æ¥åˆ›å»ºå®ä¾‹å¯¹è±¡ã€‚ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºå®ä¾‹å¯¹è±¡ï¼Œä¼šç»™ä½ ç³»ç»Ÿå¸¦æ¥æ›´å¤§çš„å¯æ‰©å±•æ€§å’Œå°½é‡å°‘çš„ä¿®æ”¹é‡ï¼ˆé™ä½è€¦åˆï¼‰ã€‚</p>
<h3 id="ä¸€ã€ç®€å•å·¥å‚æ¨¡å¼"><a href="#ä¸€ã€ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ä¸€ã€ç®€å•å·¥å‚æ¨¡å¼"></a>ä¸€ã€ç®€å•å·¥å‚æ¨¡å¼</h3><p>ç®€å•å·¥å‚æ¨¡å¼ä¸å±äºGOFçš„23ç§ç»å…¸è®¾è®¡æ¨¡å¼ï¼Œç›¸å½“äºä¸€ç§ç¼–ç¨‹ä¹ æƒ¯ã€‚</p>
<p>ç®€å•å·¥å‚æ¨¡å¼åŒ…å«å¦‚ä¸‹ä¸‰ç§è§’è‰²ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æŠ½è±¡äº§å“ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚ï¼ˆå¯ä»¥æ˜¯æ¥å£ï¼‰</span><br><span class="line">å…·ä½“äº§å“ï¼šå®ç°æˆ–è€…ç»§æ‰¿æŠ½è±¡äº§å“çš„å­ç±»ã€‚</span><br><span class="line">å…·ä½“å·¥å‚ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œä½¿ç”¨è€…é€šè¿‡è¯¥æ–¹æ³•æ¥è·å–äº§å“ã€‚</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* åœ¨å·¥å‚æ–¹æ³•ä¸­æ ¹æ®ç±»å‹åˆ›å»ºä¸åŒçš„å…·ä½“å¯¹è±¡</span><br><span class="line">**/</span><br><span class="line">public class SimpleCoffeeFactory &#123;</span><br><span class="line">	// æ ¹æ®typeåˆ¤æ–­ç±»å‹ï¼Œå®ä¾‹åŒ–å¹¶è¿”å›å¯¹åº”å¯¹è±¡</span><br><span class="line">    public Coffee createCoffee(String type) &#123;</span><br><span class="line">        Coffee coffee = null;</span><br><span class="line">        if(&quot;americano&quot;.equals(type)) &#123;</span><br><span class="line">            coffee = new AmericanoCoffee();</span><br><span class="line">        &#125; else if(&quot;latte&quot;.equals(type)) &#123;</span><br><span class="line">            coffee = new LatteCoffee();</span><br><span class="line">        &#125;</span><br><span class="line">        return coffee;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å·¥å‚å¤„ç†åˆ›å»ºå¯¹è±¡çš„ç»†èŠ‚ï¼Œä¸€æ—¦æœ‰äº†å·¥å‚ï¼ŒåæœŸå¦‚æœéœ€è¦å¯¹è±¡ç›´æ¥ä»å·¥å‚ä¸­è·å–å³å¯ã€‚è¿™æ ·ä¹Ÿå°±è§£é™¤äº†å’Œå®ç°ç±»çš„è€¦åˆï¼Œä¸éœ€è¦å…³æ³¨åˆ›å»ºå¯¹è±¡çš„ç»†èŠ‚ï¼Œä½†åŒæ—¶åˆäº§ç”Ÿäº†æ–°çš„è€¦åˆã€‚åæœŸå¦‚æœå†æ·»åŠ æ–°çš„ç±»ï¼Œå°±å¿…é¡»ä¿®æ”¹å·¥å‚ç±»çš„ä»£ç ï¼Œè¿åäº†å¼€é—­åŸåˆ™ã€‚</p>
<hr>
<p>é™æ€å·¥å‚æ¨¡å¼ï¼šåœ¨å¼€å‘ä¸­ä¹Ÿæœ‰ä¸€éƒ¨åˆ†äººå°†å·¥å‚ç±»ä¸­çš„åˆ›å»ºå¯¹è±¡çš„åŠŸèƒ½å®šä¹‰ä¸ºé™æ€çš„ï¼Œè¿™ä¸ªå°±æ˜¯é™æ€å·¥å‚æ¨¡å¼ï¼Œå®ƒä¹Ÿä¸æ˜¯23ç§è®¾è®¡æ¨¡å¼ä¸­çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class SimpleCoffeeFactory &#123;</span><br><span class="line">    public static Coffee createCoffee(String type) &#123;</span><br><span class="line">        Coffee coffee = null;</span><br><span class="line">        if(&quot;americano&quot;.equals(type)) &#123;</span><br><span class="line">            coffee = new AmericanoCoffee();</span><br><span class="line">        &#125; else if(&quot;latte&quot;.equals(type)) &#123;</span><br><span class="line">            coffee = new LatteCoffee();</span><br><span class="line">        &#125;</span><br><span class="line">        return coffe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äºŒã€å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#äºŒã€å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="äºŒã€å·¥å‚æ–¹æ³•æ¨¡å¼"></a>äºŒã€å·¥å‚æ–¹æ³•æ¨¡å¼</h3><p>é’ˆå¯¹ç®€å•å·¥å‚æ¨¡å¼çš„ç¼ºç‚¹ï¼Œä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼å°±å¯ä»¥å®Œç¾çš„è§£å†³ï¼Œå®Œå…¨éµå¾ªå¼€é—­åŸåˆ™ã€‚</p>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFACTORY METHODï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„ç±»åˆ›å»ºå‹è®¾è®¡æ¨¡å¼,æ­¤æ¨¡å¼çš„æ ¸å¿ƒç²¾ç¥æ˜¯å°è£…ç±»ä¸­å˜åŒ–çš„éƒ¨åˆ†ï¼Œæå–å…¶ä¸­ä¸ªæ€§åŒ–å–„å˜çš„éƒ¨åˆ†ä¸ºç‹¬ç«‹ç±»ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥ä»¥è¾¾åˆ°è§£è€¦ã€å¤ç”¨å’Œæ–¹ä¾¿åæœŸç»´æŠ¤æ‹“å±•çš„ç›®çš„ã€‚å®ƒçš„æ ¸å¿ƒç»“æ„æœ‰å››ä¸ªè§’è‰²ï¼Œåˆ†åˆ«æ˜¯æŠ½è±¡å·¥å‚ã€å…·ä½“å·¥å‚ã€æŠ½è±¡äº§å“ã€å…·ä½“äº§å“ã€‚</p>
<p>å››ä¸ªè§’è‰²ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æŠ½è±¡å·¥å‚ï¼ˆAbstract Factoryï¼‰ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œè°ƒç”¨è€…é€šè¿‡å®ƒè®¿é—®å…·ä½“å·¥å‚çš„å·¥å‚æ–¹æ³•æ¥åˆ›å»ºäº§å“ã€‚</span><br><span class="line">å…·ä½“å·¥å‚ï¼ˆConcreteFactoryï¼‰ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚</span><br><span class="line">æŠ½è±¡äº§å“ï¼ˆProductï¼‰ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚</span><br><span class="line">å…·ä½“äº§å“ï¼ˆConcreteProductï¼‰ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²æ‰€å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒåŒå…·ä½“å·¥å‚ä¹‹é—´ä¸€ä¸€å¯¹åº”ã€‚</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* æŠ½è±¡å·¥å‚</span><br><span class="line">**/</span><br><span class="line">public interface CoffeeFactory &#123;</span><br><span class="line">    Coffee createCoffee();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* å…·ä½“å·¥å‚</span><br><span class="line">* </span><br><span class="line">* æŠ½è±¡äº§å“ä¸ºcoffeeï¼Œå…·ä½“äº§å“ä¸ºLatteCoffeeå’ŒAmericanCoffee</span><br><span class="line">* è¿™ç§å·¥å‚æ¨¡å¼å¯ä»¥é€šè¿‡ä¸åŒçš„å…·ä½“å·¥å‚åˆ›å»ºå‡ºä¸åŒçš„å…·ä½“äº§å“</span><br><span class="line">**/</span><br><span class="line">public class LatteCoffeeFactory implements CoffeeFactory &#123;</span><br><span class="line">    public Coffee createCoffee() &#123;</span><br><span class="line">        return new LatteCoffee();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class AmericanCoffeeFactory implements CoffeeFactory &#123;</span><br><span class="line">    public Coffee createCoffee() &#123;</span><br><span class="line">        return new AmericanCoffee();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦å¢åŠ äº§å“ç±»æ—¶ä¸éœ€è¦ä¿®æ”¹å·¥å‚ç±»çš„ä»£ç äº†ï¼Œè¿™æ ·å°±è§£å†³äº†ç®€å•å·¥å‚æ¨¡å¼çš„ç¼ºç‚¹ï¼Œä½†è¦ç›¸åº”åœ°å¢åŠ å·¥å‚ç±»ã€‚</p>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„è¿›ä¸€æ­¥æŠ½è±¡ã€‚ç”±äºä½¿ç”¨äº†å¤šæ€æ€§ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼ä¿æŒäº†ç®€å•å·¥å‚æ¨¡å¼çš„ä¼˜ç‚¹ï¼Œè€Œä¸”å…‹æœäº†å®ƒçš„ç¼ºç‚¹ã€‚</p>
<p>ä¼˜ç‚¹ï¼š<br>åœ¨è·å–å¯¹è±¡æ—¶åªéœ€è¦çŸ¥é“å…·ä½“å·¥å‚çš„åç§°å°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„å¯¹è±¡ï¼Œæ— é¡»çŸ¥é“å…·ä½“åˆ›å»ºè¿‡ç¨‹ï¼›åœ¨ç³»ç»Ÿå¢åŠ æ–°çš„ç±»æ—¶åªéœ€è¦æ·»åŠ å¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œæ— é¡»å¯¹åŸå·¥å‚è¿›è¡Œä»»ä½•ä¿®æ”¹ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ï¼›</p>
<p>ç¼ºç‚¹ï¼š<br>æ¯å¢åŠ ä¸€ä¸ªç±»å°±è¦å¢åŠ ä¸€ä¸ªå¯¹åº”çš„å…·ä½“å·¥å‚ç±»ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</p>
<h3 id="ä¸‰ã€æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#ä¸‰ã€æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="ä¸‰ã€æŠ½è±¡å·¥å‚æ¨¡å¼"></a>ä¸‰ã€æŠ½è±¡å·¥å‚æ¨¡å¼</h3><p>æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factory Patternï¼‰éš¶å±äºè®¾è®¡æ¨¡å¼ä¸­çš„åˆ›å»ºå‹æ¨¡å¼ï¼Œç”¨äºäº§å“æ—çš„æ„å»ºã€‚æŠ½è±¡å·¥å‚æ˜¯æ‰€æœ‰å½¢æ€çš„å·¥å‚æ¨¡å¼ä¸­æœ€ä¸ºæŠ½è±¡å’Œæœ€å…·ä¸€èˆ¬æ€§çš„ä¸€ç§å½¢æ€ã€‚æŠ½è±¡å·¥å‚æ˜¯æŒ‡å½“æœ‰å¤šä¸ªæŠ½è±¡è§’è‰²æ—¶ä½¿ç”¨çš„ä¸€ç§å·¥å‚æ¨¡å¼ã€‚æŠ½è±¡å·¥å‚æ¨¡å¼å¯ä»¥å‘å®¢æˆ·ç«¯æä¾›ä¸€ä¸ªæ¥å£ï¼Œä½¿å®¢æˆ·ç«¯åœ¨ä¸å¿…æŒ‡å®šäº§å“çš„å…·ä½“æƒ…å†µä¸‹ï¼Œåˆ›å»º<strong>å¤šä¸ªäº§å“æ—</strong>ä¸­çš„äº§å“å¯¹è±¡ã€‚</p>
<p>å·¥å‚æ¨¡å¼ä¸­çš„æ¯ä¸€ä¸ªå½¢æ€éƒ½æ˜¯é’ˆå¯¹ä¸€å®šé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå·¥å‚æ–¹æ³•é’ˆå¯¹çš„æ˜¯å¤šä¸ªäº§å“ç³»åˆ—ç»“æ„ï¼›è€ŒæŠ½è±¡å·¥å‚æ¨¡å¼é’ˆå¯¹çš„æ˜¯å¤šä¸ªäº§å“æ—ç»“æ„ï¼Œä¸€ä¸ªäº§å“æ—å†…æœ‰å¤šä¸ªäº§å“ç³»åˆ—ã€‚</p>
<p>æŠ½è±¡å·¥å‚æ¨¡å¼çš„ä¸»è¦è§’è‰²å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æŠ½è±¡å·¥å‚ï¼ˆAbstract Factoryï¼‰ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œå®ƒåŒ…å«å¤šä¸ªåˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒç­‰çº§çš„äº§å“ã€‚</span><br><span class="line">å…·ä½“å·¥å‚ï¼ˆConcrete Factoryï¼‰ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„å¤šä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚</span><br><span class="line">æŠ½è±¡äº§å“ï¼ˆProductï¼‰ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼æœ‰å¤šä¸ªæŠ½è±¡äº§å“ã€‚</span><br><span class="line">å…·ä½“äº§å“ï¼ˆConcreteProductï¼‰ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²æ‰€å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒ åŒå…·ä½“å·¥å‚ä¹‹é—´æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ã€‚</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* æŠ½è±¡å·¥å‚</span><br><span class="line">**/</span><br><span class="line">public interface DessertFactory &#123;</span><br><span class="line">    Coffee createCoffee();</span><br><span class="line">    Dessert createDessert();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* å…·ä½“å·¥å‚</span><br><span class="line">**/</span><br><span class="line">public class AmericanDessertFactory implements DessertFactory &#123;</span><br><span class="line">    public Coffee createCoffee() &#123;</span><br><span class="line">        return new AmericanCoffee();</span><br><span class="line">    &#125;</span><br><span class="line">    public Dessert createDessert() &#123;</span><br><span class="line">        return new MatchaMousse();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class ItalyDessertFactory implements DessertFactory &#123;</span><br><span class="line">    public Coffee createCoffee() &#123;</span><br><span class="line">        return new LatteCoffee();</span><br><span class="line">    &#125;</span><br><span class="line">    public Dessert createDessert() &#123;</span><br><span class="line">        return new Tiramisu();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦åŠ åŒä¸€ä¸ªäº§å“æ—çš„è¯ï¼Œåªéœ€è¦å†åŠ ä¸€ä¸ªå¯¹åº”çš„å·¥å‚ç±»å³å¯ï¼Œä¸éœ€è¦ä¿®æ”¹å…¶ä»–çš„ç±»ã€‚</p>
<p>ä¼˜ç‚¹ï¼š<br>å½“ä¸€ä¸ªäº§å“æ—ä¸­çš„å¤šä¸ªå¯¹è±¡è¢«è®¾è®¡æˆä¸€èµ·å·¥ä½œæ—¶ï¼Œå®ƒèƒ½ä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“æ—ä¸­çš„å¯¹è±¡ã€‚</p>
<p>ç¼ºç‚¹ï¼š<br>å½“äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—¶ï¼Œæ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚</p>
<h3 id="å››ã€æ¨¡å¼æ‰©å±•ï¼ˆç®€å•å·¥å‚-é…ç½®æ–‡ä»¶è§£é™¤è€¦åˆï¼‰"><a href="#å››ã€æ¨¡å¼æ‰©å±•ï¼ˆç®€å•å·¥å‚-é…ç½®æ–‡ä»¶è§£é™¤è€¦åˆï¼‰" class="headerlink" title="å››ã€æ¨¡å¼æ‰©å±•ï¼ˆç®€å•å·¥å‚+é…ç½®æ–‡ä»¶è§£é™¤è€¦åˆï¼‰"></a>å››ã€æ¨¡å¼æ‰©å±•ï¼ˆç®€å•å·¥å‚+é…ç½®æ–‡ä»¶è§£é™¤è€¦åˆï¼‰</h3><p>å¯ä»¥é€šè¿‡å·¥å‚æ¨¡å¼+é…ç½®æ–‡ä»¶çš„æ–¹å¼è§£é™¤å·¥å‚å¯¹è±¡å’Œäº§å“å¯¹è±¡çš„è€¦åˆã€‚åœ¨å·¥å‚ç±»ä¸­åŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„å…¨ç±»åï¼Œå¹¶åˆ›å»ºå¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œå®¢æˆ·ç«¯å¦‚æœéœ€è¦å¯¹è±¡ï¼Œç›´æ¥è·å–å³å¯ã€‚</p>
<p>åˆ›å»ºé…ç½®æ–‡ä»¶:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">american=cn.com.supercoder.pattern.AmericanCoffee</span><br><span class="line">latte=cn.com.supercoder.pattern.LatteCoffee</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class CoffeeFactory &#123;</span><br><span class="line">    private static Map&lt;String,Coffee&gt; map = new HashMap();</span><br><span class="line">    // åŠ è½½é…ç½®æ–‡ä»¶</span><br><span class="line">    static &#123;</span><br><span class="line">        Properties p = new Properties();</span><br><span class="line">        InputStream is = CoffeeFactory.class.getClassLoader().getResourceAsStream(&quot;bean.properties&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            p.load(is);</span><br><span class="line">            // éå†Propertiesé›†åˆå¯¹è±¡</span><br><span class="line">            Set&lt;Object&gt; keys = p.keySet();</span><br><span class="line">            for (Object key : keys) &#123;</span><br><span class="line">                // æ ¹æ®é”®è·å–å€¼ï¼ˆå…¨ç±»åï¼‰</span><br><span class="line">                String className = p.getProperty((String) key);</span><br><span class="line">                // è·å–Classå¯¹è±¡</span><br><span class="line">                Class clazz = Class.forName(className);</span><br><span class="line">                // å®ä¾‹åŒ–å¯¹è±¡</span><br><span class="line">                Coffee obj = (Coffee) clazz.newInstance();</span><br><span class="line">                // å°†å¯¹è±¡ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å…¥map</span><br><span class="line">                map.put((String)key,obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	* è·å–å¯¹è±¡æ—¶ç›´æ¥æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„keyè·å–å¯¹åº”çš„å¯¹è±¡</span><br><span class="line">	**/</span><br><span class="line">    public static Coffee createCoffee(String name) &#123;</span><br><span class="line">        return map.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45867375/article/details/124597130">https://blog.csdn.net/qq_45867375/article/details/124597130</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/05/myblog/JAVA/Page%E5%88%86%E9%A1%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/05/myblog/JAVA/Page%E5%88%86%E9%A1%B5/" class="post-title-link" itemprop="url">Pageåˆ†é¡µ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-05 12:55:45" itemprop="dateCreated datePublished" datetime="2022-11-05T12:55:45+08:00">2022-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-23 23:09:22" itemprop="dateModified" datetime="2023-02-23T23:09:22+08:00">2023-02-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="springæ•´åˆmybatis"><a href="#springæ•´åˆmybatis" class="headerlink" title="springæ•´åˆmybatis"></a>springæ•´åˆmybatis</h2><p>æ–°å»ºä¸€ä¸ªå­å·¥ç¨‹web-repositoryã€‚</p>
<p>mybatisä¾èµ–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.1.35&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®ç»“æ„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">--web-repository</span><br><span class="line"> --src</span><br><span class="line">  --main</span><br><span class="line">   --java</span><br><span class="line">     --config</span><br><span class="line">       --SpringConfig.java</span><br><span class="line">     --domain</span><br><span class="line">       --StudentDO.java</span><br><span class="line">     --StudentDao.java</span><br><span class="line">   --resource</span><br><span class="line">     --mapper</span><br><span class="line">  --test</span><br></pre></td></tr></table></figure>

<p>âœ…springé…ç½®ç±»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ComponentScan(basePackages = &#123;&quot;org.example&quot;&#125;)</span><br><span class="line">public class SpringConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦å¼•å…¥springä¾èµ–ã€‚</p>
<p>springé…ç½®ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fengyupinglan/p/14517267.html">https://www.cnblogs.com/fengyupinglan/p/14517267.html</a></p>
<p>âœ…springæ•´åˆmybatis</p>
<p>é¦–å…ˆï¼Œspringé…ç½®æ–‡ä»¶å¯ä»¥æ˜¯xmlæ–‡ä»¶åœ¨resourceæ–‡ä»¶å¤¹ä¸‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æ³¨è§£æ–¹å¼çš„javaæ–‡ä»¶ã€‚å…ˆå†™ä¸€ä¸ªspringé…ç½®æ–‡ä»¶ï¼Œè‡ªåŠ¨è£…é…æä¸Šå»ã€‚è¿˜æœ‰mybatisçš„ä¸€äº›beanè¦é…ç½®ä¸Šå»ã€‚</p>
<h3 id="xmlæ–¹å¼"><a href="#xmlæ–¹å¼" class="headerlink" title="xmlæ–¹å¼"></a>xmlæ–¹å¼</h3><p>xmlæ–‡ä»¶æ–¹å¼ï¼Œspring-mybatis.xml<br>å¼€å¯è‡ªåŠ¨æ‰«æå’Œé…ç½®bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span> <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">						http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--å¼€å¯ç»„ä»¶æ‰«æ,æ‰«æå¤šä¸ªåŒ…ç”¨,éš”å¼€--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;org.example&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- å¼€å¯Aspectç”Ÿæˆä»£ç†å¯¹è±¡ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    &lt;aop:aspectj-autoproxy&gt;&lt;/aop:aspectj-autoproxy&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--åŠ è½½propertiesæ–‡ä»¶--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">ignore-unresolvable</span>=<span class="string">&#x27;true&#x27;</span> <span class="attr">location</span>=<span class="string">&#x27;classpath:dbconfig.properties&#x27;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 1.é…ç½®é˜¿é‡Œdruidè¿æ¥æ±  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- é…ç½®æ•°æ®åº“åŸºæœ¬ä¿¡æ¯ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;db.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;db.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;db.password&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;db.driverClassName&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxActive&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;db.maxActive&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;initialSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;db.initialSize&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 2.é…ç½®springçš„æ•°æ®æºï¼Œå£°æ˜äº‹åŠ¡ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 3.é…ç½® mybatisï¼Œæ‰«æmapper.xmlæ–‡ä»¶ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 3.1 é…ç½® mybatis config --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 3.2 é…ç½®æ‰«æmybatisæ˜ å°„æ–‡ä»¶è·¯å¾„ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mapper/*.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 4.ç±»ä¼¼äº jdbcTemplate å¸®åŠ©ç±» --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- è‡ªåŠ¨æ‰«æäº†æ‰€æœ‰çš„*Mapper.xmlå¯¹åº”çš„mapperæ¥å£æ–‡ä»¶ï¼Œè¿™æ ·å°±ä¸ç”¨ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨é…ç½®Mapperçš„æ˜ å°„äº†ï¼Œåªè¦Mapperæ¥å£ç±»å’ŒMapperæ˜ å°„æ–‡ä»¶å¯¹åº”èµ·æ¥å°±å¯ä»¥äº†ã€‚ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.example.mysql&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>druidéœ€è¦ä¾èµ–åŒ…ï¼šdruid<br>SqlSessionFactoryBean éœ€è¦ä¾èµ–åŒ…ï¼šspring-jdbc<br>è¿˜éœ€è¦ ibatis-common</p>
<p>dbconfig.properties:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.url=jdbc:mysql://localhost:3306/test?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span><br><span class="line">db.driverClassName=com.mysql.cj.jdbc.Driver</span><br><span class="line">db.password=jade</span><br><span class="line">db.username=liuxuan</span><br><span class="line">db.maxActive=5</span><br><span class="line">db.initialSize=1</span><br></pre></td></tr></table></figure>

<p>mybatisé…ç½®æ–‡ä»¶ï¼Œmybatis-config.xml<br>ä¸€äº›configuration setting</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//ybatis.org//DTD SQL Map Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;cacheEnabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">setting</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;useGeneratedKeys&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">setting</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;defaultExecutorType&quot;</span> <span class="attr">value</span>=<span class="string">&quot;REUSE&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">setting</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">setting</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>xmlæ–¹å¼springæ•´åˆmybatisï¼Œmybatisé…ç½®é¡¹çš„æ„ä¹‰ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45797116/article/details/117105095">https://blog.csdn.net/qq_45797116/article/details/117105095</a></p>
<p>xmlæ–‡ä»¶ä¸­å¦‚æœæƒ³å¼•å…¥å…¶ä»–xmlæ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;import resource=&quot;.../...xml&quot;/&gt;</span><br></pre></td></tr></table></figure>

<h3 id="æ³¨è§£æ–¹å¼"><a href="#æ³¨è§£æ–¹å¼" class="headerlink" title="æ³¨è§£æ–¹å¼"></a>æ³¨è§£æ–¹å¼</h3><p>æ³¨è§£æ–¹å¼ï¼ŒSpringConfig.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package org.example.mysql.config;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.annotation.ComponentScan;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@ComponentScan(basePackages = &#123;&quot;org.example&quot;&#125;)</span><br><span class="line">@ImportResource(&quot;classpath:spring-mybatis.xml&quot;) //å¯¼å…¥xmlé…ç½®é¡¹</span><br><span class="line">public class SpringConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œå¯ä»¥ç”¨@Importå¯¼å…¥å…¶ä»–æ³¨è§£æ–¹å¼çš„é…ç½®æ–‡ä»¶ï¼Œä»¥åŠç”¨@ImportResourceå¯¼å…¥xmlæ–¹å¼çš„é…ç½®æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Import(CDPlayerConfig.class)  </span><br><span class="line">@ImportResource(&quot;classpath:cons-injec.xml&quot;) //å¯¼å…¥xmlé…ç½®é¡¹</span><br></pre></td></tr></table></figure>

<p>æ³¨è§£æ–¹å¼å€’å…¥é…ç½®æ–‡ä»¶ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42107384/article/details/116475637">https://blog.csdn.net/weixin_42107384/article/details/116475637</a></p>
<p>çº¯æ³¨è§£æ–¹å¼çš„æ•´åˆspringå’Œmybatisé…ç½®ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44226181/article/details/127343597">https://blog.csdn.net/weixin_44226181/article/details/127343597</a></p>
<p>è¿˜æœ‰ä¸€ä¸ªä¸€è¡Œä»£ç çš„åŸºäºæ³¨è§£æ•´åˆçš„ï¼š<br><a target="_blank" rel="noopener" href="https://www.pudn.com/news/62f1dcb95425817ffc22c172.html">https://www.pudn.com/news/62f1dcb95425817ffc22c172.html</a></p>
<h3 id="æµ‹è¯•éªŒè¯"><a href="#æµ‹è¯•éªŒè¯" class="headerlink" title="æµ‹è¯•éªŒè¯"></a>æµ‹è¯•éªŒè¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">public class StudentDaoTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testSelectById() &#123;</span><br><span class="line"></span><br><span class="line">        // xmlï¼š</span><br><span class="line">        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);</span><br><span class="line">        UserMapper mapper = (UserMapper) context.getBean(&quot;userMapper&quot;);</span><br><span class="line"></span><br><span class="line">        // æ³¨è§£ï¼š</span><br><span class="line">        ApplicationContext context =new AnnotationConfigApplicationContext(SpringConfig.class);</span><br><span class="line">        StudentDao studentDao = (StudentDao) context.getBean(&quot;studentDao&quot;);</span><br><span class="line"></span><br><span class="line">        StudentDO studentDO = studentDao.selectById(1L);</span><br><span class="line">        System.out.println(studentDO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•éªŒè¯åŠxmlä¸­é…ç½®SqlSessionFactoryçš„beanå’Œæ‰«æçš„beanï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_28082757/article/details/103488364">https://blog.csdn.net/qq_28082757/article/details/103488364</a></p>
<p>é…ç½®æ•°æ®åº“è¿æ¥æ± æœ‰å‡ ç§æ–¹æ³•ï¼Œä¸Šé¢ç”¨çš„æ˜¯aliçš„druidè¿æ¥æ± ï¼Œå…³äºDruidè¿æ¥æ± ï¼š<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chy18883701161/p/12594889.html">https://www.cnblogs.com/chy18883701161/p/12594889.html</a></p>
<p>æ³¨è§£æ–¹å¼é…ç½®JdbcConfigä¸­ PlatformTransactionManager æ˜¯äº‹åŠ¡ç®¡ç†ï¼Œåœ¨spring-jdbcåŒ…ä¸‹ã€‚<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/903c01cb2a77">https://www.jianshu.com/p/903c01cb2a77</a></p>
<p>@Mapperæ³¨è§£ï¼Œéš¾é“æ˜¯spring-bootæ‰èƒ½ç”¨çš„ï¼Ÿ<br>mybatisæ”¯æŒçš„æ˜ å°„æ–¹å¼æœ‰åŸºäºxmlçš„mapper.xmlæ–‡ä»¶ã€åŸºäºjavaçš„ä½¿ç”¨Mapperæ¥å£classã€‚<br>ä»mybatis3.4.0å¼€å§‹åŠ å…¥äº†@Mapperæ³¨è§£ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†ä¸å†å†™mapperæ˜ å°„æ–‡ä»¶ã€‚<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46369022/article/details/122755858">https://blog.csdn.net/weixin_46369022/article/details/122755858</a><br>éœ€è¦ä¾èµ–åŒ…ï¼šmybatis-spring-boot-starter</p>
<h3 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h3><p>âœ… @Valueé‡Œçš„å­—æ®µæŠ¥çº¢</p>
<p>åŸå› ï¼šè‡ªåŠ¨å¯¼å…¥äº†lomboké‡Œçš„@Valueï¼Œè¦ç”¨çš„æ˜¯SpringFrameworkä¸‹çš„@Valueã€‚</p>
<p>âœ… xmlé…ç½®æ–‡ä»¶åŠ è½½ä¸åˆ°propertieså±æ€§é—®é¢˜</p>
<p>åŸå› ï¼šspringä¸­æ²¡æœ‰æˆåŠŸåŠ è½½ç›¸åº”çš„é…ç½®æ–‡ä»¶</p>
<p>è§£å†³ï¼šè¿›å…¥File-Project Strucctureï¼Œè¿›å…¥Facetsä¸­è¿›è¡Œé…ç½®ï¼Œ.åœ¨å³è¾¹çš„springç›®å½•ä¸‹ï¼Œæ‰¾åˆ°å¯¹åº”çš„çˆ†çº¢é—®é¢˜æ‰€åœ¨é…ç½®æ–‡ä»¶ï¼Œé€‰æ‹©xmlæ–‡ä»¶ï¼Œç‚¹å‡»ä¿®æ”¹ç¬¦åˆï¼ˆä¸‹å›¾ä¸­çš„å°é“…ç¬”ï¼‰ï¼Œåœ¨è·³å‡ºæ¥çš„å¼¹æ¡†ä¸­ï¼Œé€‰æ‹©æ·»åŠ ï¼ˆåŠ å·ï¼‰ï¼Œç„¶åé€‰æ‹©Additioonal properties filesã€‚ç„¶åæ‰¾åˆ°éœ€è¦åŠ è½½è¿›springä¸­çš„é…ç½®æ–‡ä»¶ï¼Œç‚¹å‡»OKï¼Œæ·»åŠ æˆåŠŸã€‚</p>
<p>æ¥è‡ªï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaogot/article/details/103224088">https://blog.csdn.net/zhaogot/article/details/103224088</a></p>
<p>âœ… xmlé…ç½®æ–‡ä»¶ä¸­çš„é—®é¢˜ï¼šæ ¹å…ƒç´  â€œbeansâ€ å¿…é¡»åŒ¹é… DOCTYPE æ ¹ â€œnullâ€</p>
<p>åœ¨<code>&lt;beans&gt;</code>æ ‡ç­¾é‚£é‡ŒæŠ¥å‡ºæ¥ã€‚</p>
<p>åŸå› ï¼šmybatisåœ¨æ‰«æMapper.xmlæ–‡ä»¶æ—¶ï¼Œæ‰«æåˆ°émapperæ–‡ä»¶ã€‚æ¯”å¦‚æœ¬æ¬¡æŠ¥é”™æ‰«æåˆ°äº†è‡ªå·±ã€‚spring.xmlçš„æ ¹å…ƒç´ æ˜¯<code>&lt;beans&gt;&lt;/beans&gt;</code>å½“ç„¶ä¸ä¼šæœ‰DOCTYPEäº†ã€‚<br>æ‰€ä»¥å½“Mybatisæ‰«æåˆ°äº†Spring.xmlè¿™ä¸ªéMapper.xmlæ–‡ä»¶æ—¶ï¼Œè‡ªç„¶æ‰¾ä¸åˆ°DOCTYPEï¼Œæ‰€ä»¥ä¼šæœ‰â€œDOCTYPE æ ¹ â€œnullâ€â€è¿™ä¸ªé”™è¯¯ã€‚</p>
<p>ç²—å¿ƒï¼šåº”è¯¥æ‰«çš„æ˜¯mybatis-config.xmlæ–‡ä»¶ï¼Œç»“æ„å†™æˆäº†è‡ªå·±ã€‚</p>
<p>æ¥è‡ªï¼š<a target="_blank" rel="noopener" href="https://www.codeleading.com/article/7746743165/">https://www.codeleading.com/article/7746743165/</a></p>
<p>âœ… org.apache.ibatis.binding.BindingException: Invalid bound statement (not found)</p>
<p>åŸå› ï¼šmapperæ¥å£å’Œxmlæ–‡ä»¶æ²¡åŒ¹é…ä¸Šï¼Œæœ‰å¯èƒ½æ˜¯æ–‡ä»¶åæ–¹æ³•åæ²¡åŒ¹é…ä¸Šï¼Œè¿™é‡Œæ˜¯åœ¨é…ç½®æ–‡ä»¶é‡Œæ²¡åŠ æ‰«ææ¥å£ï¼ŒåŠ äº†å°±å¥½äº†ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43570367/article/details/103147854">https://blog.csdn.net/weixin_43570367/article/details/103147854</a></p>
<p>âœ… propertiesæ–‡ä»¶ java.lang.NumberFormatException</p>
<p>æ˜æ˜æ˜¯æ•°å­—ç±»å‹ï¼Œä½†æ˜¯è¯´æˆ‘ä»Stringè½¬ä¸ºintå‘ç”Ÿå¼‚å¸¸ã€‚</p>
<p>éœ€è¦åœ¨xmlé…ç½®æ–‡ä»¶ä¸­åŠ è½½propertiesé…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--åŠ è½½propertiesæ–‡ä»¶--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">ignore-unresolvable</span>=<span class="string">&#x27;true&#x27;</span> <span class="attr">location</span>=<span class="string">&#x27;classpath:dbconfig.properties&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>springåŠ è½½propertiesæ–‡ä»¶çš„å‡ ç§æ–¹å¼ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/chuige2013/article/details/121759088">https://blog.csdn.net/chuige2013/article/details/121759088</a></p>
<p>âœ… java.sql.SQLException: com.mysql.cj.jdbc.Driver</p>
<p>mysqlè¿æ¥é©±åŠ¨ä¾èµ–çš„ç‰ˆæœ¬ä¸åŒ¹é…é—®é¢˜ï¼Œä¸€èˆ¬å‡ºç°åœ¨ä½¿ç”¨ä½ç‰ˆæœ¬è¿æ¥é©±åŠ¨è¿æ¥é«˜ç‰ˆæœ¬mysqlæƒ…å†µä¸‹ï¼Œè§£å†³æ–¹æ³•æ˜¯åœ¨mavenä¸­å¤®ä»“åº“ä¸­ä¸‹è½½é«˜ç‰ˆæœ¬çš„mysqlè¿æ¥é©±åŠ¨.</p>
<p>mysql-connector-java æ¢8.0.21çš„åŒ…ï¼Œè‡ªåŠ¨å¼•å…¥æ²¡æˆåŠŸï¼Œæ‰‹åŠ¨ä¸‹è½½è£…åˆ°.m2çš„ã€‚</p>
<p>âœ… init datasource error, url: jdbc:mysql://localhost:3306/mybatis?useUnicode=true&amp;characterEncoding=UTF-8</p>
<p>db.urlæ¢æˆï¼š<code>jdbc:mysql://localhost:3306/mysql?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</code></p>
<p>âœ… Table â€˜mysql.studentâ€™ doesnâ€™t exist</p>
<p>ä¸Šé¢mysqlæ¢æˆåº“åã€‚</p>
<p>ğŸ˜„ç»ˆäºæˆåŠŸäº†ï¼Œä¸å®¹æ˜“ã€‚</p>
<h2 id="com-github-pagehelper"><a href="#com-github-pagehelper" class="headerlink" title="com.github.pagehelper"></a>com.github.pagehelper</h2><p>èƒŒæ™¯ï¼šä½¿ç”¨Pigeæ—¶ï¼Œä»æ•°æ®åº“ä¸­è·å–åˆ°listä¹‹åï¼ŒremoveIfç­›é€‰ï¼Œä½†æ˜¯åˆ†é¡µå¾—åˆ°çš„æ•ˆæœä¸å¯¹ï¼Œæ¡ç›®æ€»æ•°totalæ˜¯ä»æ•°æ®åº“å¾—åˆ°çš„list sizeã€‚</p>
<p>åŸå› ï¼šPageä¸Mybatiså¼ºè€¦åˆï¼Œä¸æ˜¯å…ˆä»æ•°æ®åº“è·å–å†åˆ†é¡µï¼Œè€Œæ˜¯å…ˆè·å–æŸé¡µè¦è·å–çš„æ¡ç›®ï¼Œè€¦åˆåˆ°sqlä¸­æŸ¥è¯¢ã€‚</p>
<p>éš¾é“åªèƒ½æ˜¯spring-bootç”¨çš„ï¼Ÿ pagehelper-spring-boot-starter ä¾èµ–åŒ…ä¸­ã€‚</p>
<p>PageHelperåˆ†é¡µï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43958747/article/details/103822761">https://blog.csdn.net/weixin_43958747/article/details/103822761</a></p>
<p>å…¶ä¸­æœ‰ä¸ªå‚æ•°ä¸ºCallBackæ¥å£ã€‚</p>
<p>âš ï¸ä½¿ç”¨ä¸­çš„ä¸€ä¸ªcaseï¼š<br>Pageedä¸­çš„listçš„å…ƒç´ å¾—å’Œæ•°æ®åº“daoè¿”å›çš„æ•°æ®ç»“æ„ä¸€æ ·ï¼Œå¾—æ˜¯DOã€‚è·å–äº†Pagedä¹‹åå†è½¬ä¸ºvoï¼Œå› ä¸ºåˆ†é¡µPageå’Œmybatisæ˜¯å¼ºè€¦åˆçš„ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/22/myblog/leecode%E5%88%B7%E9%A2%98%E4%B9%8Bjava/leeco%E9%A2%98%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/22/myblog/leecode%E5%88%B7%E9%A2%98%E4%B9%8Bjava/leeco%E9%A2%98%E7%9B%AE/" class="post-title-link" itemprop="url">javaã®leecode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-22 09:27:14" itemprop="dateCreated datePublished" datetime="2022-10-22T09:27:14+08:00">2022-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-29 20:58:34" itemprop="dateModified" datetime="2023-12-29T20:58:34+08:00">2023-12-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/leecode%E5%88%B7%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">leecodeåˆ·é¢˜</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="intæ•°ç»„çš„æ’åº"><a href="#intæ•°ç»„çš„æ’åº" class="headerlink" title="intæ•°ç»„çš„æ’åº"></a>intæ•°ç»„çš„æ’åº</h2><p>int[]æ•°ç»„çš„æ’åº<br>å•çº¯ä»å°åˆ°å¤§æ’åºï¼Œç›´æ¥ <code>Arrays.sort(nums);</code><br>ä½†æ˜¯æƒ³è¦å€’å™æ’åˆ—æˆ–è€…è‡ªå®šä¹‰æ’åºï¼Œå°±éœ€è¦å…ˆè½¬æ¢ä¸ºInteger[]æ•°ç»„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// é¦–å…ˆå°†int[]è½¬æ¢ä¸ºInteger[]ï¼Œå› ä¸ºComparatorä¸é€‚ç”¨äºåŸå§‹æ•°æ®ç±»å‹æ•°ç»„</span><br><span class="line">Integer[] numbersObj = Arrays.stream(numbers).boxed().toArray(Integer[]::new);</span><br><span class="line">å˜ä¸ºInteger[]ä¹‹åï¼Œå°±å¯ä»¥</span><br><span class="line">Arrays.sort(numbers, Collections.reverseOrder());</span><br><span class="line">æˆ–è€…ï¼š</span><br><span class="line">Arrays.sort(strings, new Comparator&lt;String&gt;() &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public int compare(String s1, String s2) &#123;</span><br><span class="line">		return s2.compareTo(s1); // é€†åº</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;);</span><br><span class="line">// ä½¿ç”¨è‡ªå®šä¹‰ComparatoræŒ‰ç»å¯¹å€¼ä»å¤§åˆ°å°æ’åº</span><br><span class="line">Arrays.sort(numbersObj, (a, b) -&gt; &#123;</span><br><span class="line">	// æ¯”è¾ƒç»å¯¹å€¼ï¼Œå®ç°é€†åºæ’åº</span><br><span class="line">	return Integer.compare(Math.abs(b), Math.abs(a));</span><br><span class="line">&#125;);</span><br><span class="line">æˆ–è€…è½¬å˜ä¸ºList&lt;Integer&gt;ï¼Œä½¿ç”¨ Collections.sort(list);   Collections.reverse(list);</span><br><span class="line">ä»¥åŠè‡ªå®šä¹‰æ’åºï¼š</span><br><span class="line">Collections.sort(list, new Comparator&lt;A&gt;()&#123;</span><br><span class="line">  @Oerride</span><br><span class="line">  public int compare(A a1, A a2)&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="int-å’ŒListè½¬æ¢"><a href="#int-å’ŒListè½¬æ¢" class="headerlink" title="int[]å’ŒListè½¬æ¢"></a>int[]å’ŒListè½¬æ¢</h2><p>Listè½¬å˜ä¸ºint[]ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">åœ¨Javaä¸­ï¼Œå°†List&lt;Integer&gt;è½¬æ¢ä¸ºåŸºæœ¬ç±»å‹æ•°ç»„int[]éœ€è¿›è¡Œæ‹†ç®±æ“ä½œï¼Œ</span><br><span class="line">å› ä¸ºListå¯ä»¥å­˜å‚¨å¯¹è±¡ï¼ˆä¾‹å¦‚Integerç±»å‹ï¼‰ï¼Œè€ŒåŸºæœ¬ç±»å‹æ•°ç»„ï¼ˆå¦‚int[]ï¼‰å­˜å‚¨çš„æ˜¯åŸºæœ¬ç±»å‹çš„å€¼ã€‚</span><br><span class="line">é™¤äº†éå†addï¼Œä¹Ÿå¯ä»¥ç”¨streamã€‚</span><br><span class="line"></span><br><span class="line">// å°†List&lt;Integer&gt;è½¬æ¢ä¸ºint[]</span><br><span class="line">int[] array = list.stream()  // å°†Listè½¬æ¢ä¸ºStream</span><br><span class="line">		 .mapToInt(Integer::intValue)  // å°†æ¯ä¸ªIntegeræ‹†ç®±æˆint</span><br><span class="line">		 .toArray();  // ä»Streamåˆ›å»ºæ•°ç»„</span><br></pre></td></tr></table></figure>

<p>int[]è½¬å˜ä¸ºListï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">åœ¨Javaä¸­ï¼Œå°†ä¸€ä¸ªåŸºæœ¬ç±»å‹çš„æ•°ç»„ int[] è½¬æ¢ä¸º List&lt;Integer&gt; ç›¸å¯¹æ¥è¯´æ›´ä¸ºç›´æ¥ï¼Œ</span><br><span class="line">å› ä¸ºéœ€è¦è¿›è¡Œè£…ç®±æ“ä½œã€‚é™¤äº†éå†addï¼Œä¹Ÿå¯ä»¥ç”¨streamã€‚</span><br><span class="line"></span><br><span class="line">// ä½¿ç”¨Stream APIå°†int[]è½¬æ¢ä¸ºList&lt;Integer&gt;</span><br><span class="line">List&lt;Integer&gt; list = IntStream.of(array) // åˆ›å»ºä¸€ä¸ªIntStream</span><br><span class="line">			.boxed()   // å°†æ¯ä¸ªintè£…ç®±æˆInteger</span><br><span class="line">			.collect(Collectors.toList()); // æ”¶é›†ä¸ºList</span><br></pre></td></tr></table></figure>

<p>ä¸æ˜¯æ™®é€šæ•°æ®ç±»å‹çš„è½¬æ¢ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int[][] nums = list.toArray(new int[list.size()][]);  // toArrayéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œå³æ•°ç»„çš„ç±»å‹å’ŒæœŸæœ›çš„å¤§å°</span><br><span class="line"> List&lt;int[]&gt; list = Arrays.stream(nums).collect(Collectors.toList());</span><br><span class="line">æ‰“å°ï¼šlist.forEach(m -&gt; System.out.println(Arrays.toString(m)));</span><br></pre></td></tr></table></figure>

<p>javaä¸­Stringå’Œchar[]çš„ç›¸äº’è½¬æ¢ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¦å°†ä¸€ä¸ª String å¯¹è±¡è½¬æ¢ä¸º char[] æ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨ String ç±»æä¾›çš„ toCharArray() æ–¹æ³•ï¼š</span><br><span class="line">String str = &quot;Hello World&quot;;</span><br><span class="line">char[] charArray = str.toCharArray();</span><br><span class="line"></span><br><span class="line">è¦å°†ä¸€ä¸ª char[] æ•°ç»„è½¬æ¢ä¸º String å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ String ç±»çš„æ„é€ å‡½æ•°ä¹‹ä¸€ï¼š</span><br><span class="line">char[] charArray = &#123;&#x27;H&#x27;, &#x27;e&#x27;, &#x27;l&#x27;, &#x27;l&#x27;, &#x27;o&#x27;, &#x27; &#x27;, &#x27;W&#x27;, &#x27;o&#x27;, &#x27;r&#x27;, &#x27;l&#x27;, &#x27;d&#x27;&#125;;</span><br><span class="line">String str = new String(charArray);</span><br></pre></td></tr></table></figure>

<h2 id="æ ˆå’Œé˜Ÿåˆ—"><a href="#æ ˆå’Œé˜Ÿåˆ—" class="headerlink" title="æ ˆå’Œé˜Ÿåˆ—"></a>æ ˆå’Œé˜Ÿåˆ—</h2><p>åˆ›å»ºæ ˆï¼š</p>
<p>åœ¨Javaä¸­ï¼Œåˆ›å»ºæ ˆå¯ä»¥é€šè¿‡ä½¿ç”¨ java.util.Stack ç±»ï¼Œå®ƒæ˜¯ Java é›†åˆæ¡†æ¶çš„ä¸€éƒ¨åˆ†ã€‚ä½†è‡ªä» Java 1.6 å¼€å§‹ï¼Œé€šå¸¸å»ºè®®ä½¿ç”¨ Deque æ¥å£æ¥å®ç°æ ˆçš„åŠŸèƒ½ï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´ä¸ºä¸€è‡´å’Œå®Œæ•´çš„æ ˆæ“ä½œã€‚ArrayDeque æ˜¯ Deque æ¥å£çš„ä¸€ä¸ªå¸¸ç”¨å®ç°ï¼Œå®ƒæ¯” Stack ç±»æ›´å¿«ï¼Œå› æ­¤é€šå¸¸æ˜¯å®ç°æ ˆçš„é¦–é€‰ã€‚ Stack ç±»æ˜¯åŸºäº Vector å®ç°çš„ï¼Œè€Œ Vector æ˜¯ä¸€ä¸ªåŒæ­¥çš„é›†åˆç±»ï¼Œå®ƒçš„æ“ä½œæ¯” ArrayDeque æ›´æ…¢ä¸”é€šå¸¸ä¸æ˜¯å¿…éœ€çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Stack&lt;Integer&gt; stack = new Stack&lt;&gt;();</span><br><span class="line">Deque&lt;Integer&gt; stack = new ArrayDeque&lt;&gt;();</span><br><span class="line">Deque&lt;Integer&gt; stack = new LinkedList&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>âœ…ArrayDeque å’Œ LinkedListï¼š</p>
<p>ArrayDeque å’Œ LinkedList éƒ½æ˜¯ Deque æ¥å£çš„å®ç°ï¼Œéƒ½å¯ä»¥ç”¨æ¥åˆ›å»ºä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆdequeï¼‰ã€‚å°½ç®¡å®ƒä»¬éƒ½æä¾›äº†ç›¸ä¼¼çš„æ“ä½œï¼Œä½†æ˜¯åœ¨å†…éƒ¨æ•°æ®ç»“æ„å’Œæ€§èƒ½ä¸Šæœ‰æ‰€ä¸åŒã€‚</p>
<p>ArrayDeque<br>â€¢å†…éƒ¨æ•°æ®ç»“æ„ï¼šArrayDequeÂ æ˜¯åŸºäºä¸€ä¸ªå¾ªç¯æ•°ç»„å®ç°çš„ï¼Œè¿™æ„å‘³ç€å®ƒçš„æ“ä½œå¯ä»¥éå¸¸å¿«é€Ÿï¼Œå¹¶ä¸”å…·æœ‰è¾ƒå¥½çš„å†…å­˜å±€éƒ¨æ€§ã€‚æ‰©å®¹æ—¶ï¼Œæ¶‰åŠåˆ°æ•°ç»„å¤åˆ¶ï¼Œå¯èƒ½æ¯”Â LinkedListÂ æ…¢ã€‚</p>
<p>LinkedList<br>â€¢å†…éƒ¨æ•°æ®ç»“æ„ï¼šLinkedListÂ æ˜¯åŸºäºåŒå‘é“¾è¡¨å®ç°çš„ï¼Œä¸ºæ¯ä¸ªå…ƒç´ éƒ½åˆ†é…äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…å«æ•°æ®å’Œå‰åæŒ‡é’ˆï¼‰ã€‚åœ¨åˆ—è¡¨ä¸­æœç´¢ç‰¹å®šå…ƒç´ çš„æ“ä½œï¼Œå®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯çº¿æ€§çš„ï¼ˆO(n)ï¼‰ã€‚æ·»åŠ æ–°å…ƒç´ ä¸éœ€è¦å¤åˆ¶æ•´ä¸ªæ•°æ®ç»“æ„ï¼Œä¹Ÿä¸éœ€è¦é¢„å…ˆåˆ†é…å†…å­˜ã€‚LinkedListÂ å¯¹äºæ¯ä¸ªå…ƒç´ éƒ½æœ‰é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦é¢å¤–å­˜å‚¨ä¸¤ä¸ªæŒ‡é’ˆï¼ˆå‰ä¸€ä¸ªå’Œåä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ï¼‰ã€‚</p>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒArrayDeque æ˜¯å®ç°æ ˆæˆ–é˜Ÿåˆ—çš„æ›´å¥½é€‰æ‹©ï¼Œå› ä¸ºå®ƒæä¾›äº†æ›´é«˜çš„æ€§èƒ½å’Œæ›´ä½çš„å†…å­˜å¼€é”€ã€‚ç„¶è€Œï¼Œå¦‚æœä½ éœ€è¦ä¸€ä¸ªå¯ä»¥åŒ…å« null å…ƒç´ çš„åŒç«¯é˜Ÿåˆ—ï¼Œæˆ–è€…ä½ ç¡®åˆ‡çŸ¥é“ä½ çš„åº”ç”¨åœºæ™¯ä¸­ LinkedList çš„æŸäº›ç‰¹æ€§æ›´æœ‰ä¼˜åŠ¿ï¼Œé‚£ä¹ˆé€‰æ‹© LinkedList ä¹Ÿæ˜¯åˆç†çš„ã€‚</p>
<p>âœ…Stackã€Dequeã€Queueã€ArrayDequeã€LinkedListçš„å…³ç³»ï¼š</p>
<p>1ã€Stack:<br>StackÂ æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒè¡¨ç¤ºåè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ ˆæ•°æ®ç»“æ„ã€‚<br>å®ƒç»§æ‰¿è‡ªÂ VectorÂ ç±»ï¼Œå¹¶æä¾›äº†æ ‡å‡†çš„æ ˆæ“ä½œï¼Œæ¯”å¦‚Â pushã€popã€å’ŒÂ peekã€‚<br>StackÂ ç±»æ˜¯ä¼ ç»Ÿçš„æ ˆå®ç°ï¼Œä½†è‡ªJava 1.6èµ·ä¸æ¨èä½¿ç”¨ï¼Œå› ä¸ºå®ƒæ˜¯åŒæ­¥çš„ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰ï¼Œè¿™åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹å¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</p>
<p>2ã€Deque:<br>DequeÂ æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»£è¡¨åŒç«¯é˜Ÿåˆ—ï¼Œå®ƒæ”¯æŒåœ¨ä¸¤ç«¯æ’å…¥å’Œç§»é™¤å…ƒç´ ã€‚<br>DequeÂ æ¥å£æ‰©å±•äº†Â QueueÂ æ¥å£ï¼Œå› æ­¤å®ƒæœ‰Â QueueÂ çš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŠ ä¸Šé¢å¤–çš„åœ¨é˜Ÿåˆ—å¤´éƒ¨å’Œå°¾éƒ¨è¿›è¡Œæ“ä½œçš„èƒ½åŠ›ã€‚<br>DequeÂ æ¥å£å¯ä»¥ä½œä¸ºæ ˆæˆ–é˜Ÿåˆ—ä½¿ç”¨ã€‚</p>
<p>3ã€Queue:<br>QueueÂ æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒè¡¨ç¤ºå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é˜Ÿåˆ—æ•°æ®ç»“æ„ã€‚<br>å®ƒå®šä¹‰äº†åŸºæœ¬çš„é˜Ÿåˆ—æ“ä½œï¼Œå¦‚Â offerã€pollã€å’ŒÂ peekã€‚</p>
<p>4ã€ArrayDeque:<br>ArrayDequeÂ æ˜¯Â DequeÂ æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå®ƒä½¿ç”¨å¾ªç¯æ•°ç»„æ¥æ”¯æŒåŒç«¯é˜Ÿåˆ—çš„æ“ä½œã€‚<br>ArrayDequeÂ å¯ä»¥ç”¨ä½œæ ˆæˆ–é˜Ÿåˆ—ï¼Œé€šå¸¸æ¯”Â StackÂ æ›´é«˜æ•ˆï¼Œå¹¶ä¸”ä¸å…è®¸æ’å…¥Â nullÂ å…ƒç´ ã€‚<br>ä½œä¸ºä¸€ä¸ªÂ DequeÂ å®ç°ï¼Œå®ƒæä¾›äº†æ‰€æœ‰Â DequeÂ æ¥å£çš„æ–¹æ³•ï¼Œä¹ŸåŒ…æ‹¬Â QueueÂ æ¥å£çš„æ–¹æ³•ã€‚</p>
<p>5ã€LinkedList:<br>LinkedListÂ æ˜¯Â ListÂ å’ŒÂ DequeÂ æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œå®ƒä½¿ç”¨é“¾è¡¨æ•°æ®ç»“æ„ã€‚<br>LinkedListÂ å¯ä»¥ç”¨ä½œåˆ—è¡¨ã€æ ˆæˆ–é˜Ÿåˆ—ï¼Œå¹¶å…è®¸æ’å…¥Â nullÂ å…ƒç´ ã€‚<br>ä½œä¸ºÂ DequeÂ çš„å®ç°ï¼Œå®ƒæä¾›äº†åœ¨åŒç«¯é˜Ÿåˆ—çš„ä¸¤ç«¯è¿›è¡Œæ“ä½œçš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒÂ QueueÂ æ¥å£çš„æ‰€æœ‰æ“ä½œã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼ŒStackã€ArrayDequeã€å’Œ LinkedList éƒ½å¯ä»¥ç”¨æ¥å®ç°æ ˆçš„åŠŸèƒ½ï¼Œè€Œ ArrayDeque å’Œ LinkedList ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°é˜Ÿåˆ—ã€‚Deque æ˜¯ä¸€ä¸ªæ›´é€šç”¨çš„æ¥å£ï¼Œæ¶µç›–äº†æ ˆå’Œé˜Ÿåˆ—çš„æ“ä½œï¼Œè€Œ Queue æ˜¯ä¸“æ³¨äºé˜Ÿåˆ—æ“ä½œçš„æ¥å£ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼ŒArrayDeque æ˜¯æ¨èç”¨æ¥å®ç°æ ˆå’Œé˜Ÿåˆ—çš„ç±»ï¼Œå› ä¸ºå®ƒé€šå¸¸æ¯” Stack å’Œ LinkedList æä¾›æ›´å¥½çš„æ€§èƒ½ã€‚</p>
<p>âœ…Queueã€Dequeã€å’ŒStackåœ¨Javaä¸­çš„å¸¸è§æ–¹æ³•çš„ç®€å•ä»‹ç»ï¼š</p>
<p>1ã€Queue<br>Queueæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é›†åˆã€‚å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†ä»¥ä¸‹åŸºæœ¬æ“ä½œï¼š<br>offer(E e): å°†æŒ‡å®šå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œå¦‚æœç”±äºå®¹é‡é™åˆ¶æ— æ³•æ·»åŠ åˆ™è¿”å›falseã€‚<br>poll(): ç§»é™¤å¹¶è¿”å›é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›nullã€‚<br>peek(): è¿”å›é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ï¼Œä½†ä¸ç§»é™¤ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›nullã€‚<br>add(E e): å°†æŒ‡å®šå…ƒç´ æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œå¦‚æœæ— æ³•æ·»åŠ åˆ™æŠ›å‡ºIllegalStateExceptionã€‚<br>remove(): ç§»é™¤å¹¶è¿”å›é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºNoSuchElementExceptionã€‚<br>element(): è¿”å›é˜Ÿåˆ—çš„å¤´éƒ¨å…ƒç´ ï¼Œä½†ä¸ç§»é™¤ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºNoSuchElementExceptionã€‚</p>
<p>2ã€Deque<br>Dequeæ˜¯åŒç«¯é˜Ÿåˆ—æ¥å£ï¼Œç»§æ‰¿è‡ªQueueæ¥å£ï¼ŒåŒ…æ‹¬Queueçš„æ‰€æœ‰æ–¹æ³•ï¼Œä»¥åŠæ”¯æŒä»ä¸¤ç«¯æ’å…¥å’Œåˆ é™¤å…ƒç´ çš„æ–¹æ³•ï¼š<br>addFirst(E e)å’ŒofferFirst(E e): åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨æ’å…¥ä¸€ä¸ªå…ƒç´ ã€‚<br>addLast(E e)å’ŒofferLast(E e): åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥ä¸€ä¸ªå…ƒç´ ã€‚<br>removeFirst()å’ŒpollFirst(): ç§»é™¤å¹¶è¿”å›é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚<br>removeLast()å’ŒpollLast(): ç§»é™¤å¹¶è¿”å›é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚<br>getFirst()å’ŒpeekFirst(): è¿”å›é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä½†ä¸ç§»é™¤ã€‚<br>getLast()å’ŒpeekLast(): è¿”å›é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œä½†ä¸ç§»é™¤ã€‚<br>push(E e): å°†å…ƒç´ æ¨å…¥æ ˆé¡¶ï¼ˆç­‰åŒäºaddFirstï¼‰ã€‚<br>pop(): ç§»é™¤å¹¶è¿”å›æ ˆé¡¶å…ƒç´ ï¼ˆç­‰åŒäºremoveFirstï¼‰ã€‚</p>
<p>3ã€Stack<br>Stackæ˜¯ä¸€ä¸ªç±»ï¼Œå®ç°äº†ä¼ ç»Ÿçš„åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„æ ˆæ•°æ®ç»“æ„ã€‚å®ƒç»§æ‰¿è‡ªVectorç±»ï¼Œå¹¶æä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼š<br>push(E item): å°†é¡¹ç›®å‹å…¥æ ˆé¡¶ã€‚<br>pop(): ç§»é™¤å¹¶è¿”å›æ ˆé¡¶å…ƒç´ ï¼Œå¦‚æœæ ˆä¸ºç©ºï¼Œåˆ™æŠ›å‡ºEmptyStackExceptionã€‚<br>peek(): è¿”å›æ ˆé¡¶å…ƒç´ ä½†ä¸ç§»é™¤ï¼Œå¦‚æœæ ˆä¸ºç©ºï¼Œåˆ™æŠ›å‡ºEmptyStackExceptionã€‚<br>empty(): æµ‹è¯•å †æ ˆæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚<br>search(Object o): è¿”å›å¯¹è±¡åœ¨å †æ ˆä¸­çš„ä½ç½®ï¼Œä»¥1ä¸ºæ ˆåº•çš„åç§»é‡å¼€å§‹è®¡æ•°ã€‚å¦‚æœå¯¹è±¡ä¸åœ¨å †æ ˆä¸­ï¼Œè¿”å›-1ã€‚</p>
<h2 id="ä¸¤æ•°ä¹‹å’Œ"><a href="#ä¸¤æ•°ä¹‹å’Œ" class="headerlink" title="ä¸¤æ•°ä¹‹å’Œ"></a>ä¸¤æ•°ä¹‹å’Œ</h2><p>é¢˜ç›®ï¼šç»™ä¸ªæ•°ç»„å’Œç›®æ ‡å€¼ï¼Œç»™å‡ºæ•°ç»„ä¸­ä¸¤ä¸ªæ•°ä¹‹å’Œç­‰äºç›®æ ‡å€¼çš„æ•°çš„ç´¢å¼•ã€‚<br>æ€æƒ³ï¼šå“ˆå¸Œæ˜ å°„ï¼Œåˆ©ç”¨mapçš„å¿«é€ŸæŸ¥æ‰¾keyç‰¹æ€§ï¼ˆ<code>map.containsKey(key)</code>ï¼‰æ¥å®ç°éå†ä¸€æ¬¡å°±å¤Ÿäº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package leeco.nums;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ä¸¤æ•°ä¹‹å’Œ</span><br><span class="line"> *</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-10-20 23:39</span><br><span class="line"> **/</span><br><span class="line">public class TwoNumSum &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int[] nums = new int[]&#123;2,7,11,15&#125;;</span><br><span class="line">        Solution solution = new Solution();</span><br><span class="line">        int[] res = solution.twoSum(nums, 9);</span><br><span class="line">        System.out.println(Arrays.toString(res));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        public int[] twoSum(int[] nums, int target) &#123;</span><br><span class="line">            HashMap&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">            for (int i = 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">                if (map.containsKey(target - nums[i])) &#123;</span><br><span class="line">                    return new int[]&#123;i, map.get(target - nums[i])&#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                map.put(nums[i], i);</span><br><span class="line">            &#125;</span><br><span class="line">            throw new IllegalArgumentException(&quot;no result&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def twoSum(self, nums: List[int], target: int) -&gt; List[int]:</span><br><span class="line">        d = dict()  #å­—å…¸ï¼Œç›¸å½“äºmap</span><br><span class="line">        for i, num in enumerate(nums):  #éå†è·å–ç´¢å¼•å’Œå†…å®¹</span><br><span class="line">            if target - num in d:</span><br><span class="line">                return [i, d[target - num]]</span><br><span class="line">            else:</span><br><span class="line">                d[num] = i</span><br><span class="line">        return []</span><br></pre></td></tr></table></figure>

<h2 id="ä¸¤é“¾è¡¨è¡¨ç¤ºçš„æ•°ç›¸åŠ "><a href="#ä¸¤é“¾è¡¨è¡¨ç¤ºçš„æ•°ç›¸åŠ " class="headerlink" title="ä¸¤é“¾è¡¨è¡¨ç¤ºçš„æ•°ç›¸åŠ "></a>ä¸¤é“¾è¡¨è¡¨ç¤ºçš„æ•°ç›¸åŠ </h2><p>é¢˜ç›®ï¼šä¸¤ä¸ªé“¾è¡¨è¡¨ç¤ºçš„æ•°ï¼Œ1-&gt;2-&gt;3 è¡¨ç¤º 123ï¼Œç›¸åŠ å¾—åˆ°å’Œçš„é“¾è¡¨ã€‚<br>æ€æƒ³ï¼šç›¸åŠ éå†è¿›ä½å³å¯ï¼Œcarryè¡¨ç¤ºè¿›ä½ï¼Œè¦åœ¨whileå¾ªç¯å¤–å®šä¹‰ï¼Œè¦å…ˆç®—å’Œå†ç®—è¿›ä½ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">package leeco.nums;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è®¡ç®—ä¸¤ä¸ªçè¡¨è¡¨ç¤ºçš„æ•°çš„å’Œ</span><br><span class="line"> *</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-10-22 10:18</span><br><span class="line"> **/</span><br><span class="line">public class TwoLinkNumSum &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // æ„é€ é“¾è¡¨</span><br><span class="line">        ListNode listNode1 = ListNode.inputList(1, 2, 3);</span><br><span class="line">        ListNode.printList(listNode1);</span><br><span class="line">        ListNode.printList(ListNode.reverseList(listNode1));</span><br><span class="line">        ListNode l1 = ListNode.inputList(2, 4, 3);</span><br><span class="line">        ListNode l2 = ListNode.inputList(5, 6, 4);</span><br><span class="line">        Solution s = new Solution();</span><br><span class="line">        ListNode sum = s.addTwoNumbers(l1, l2);</span><br><span class="line">        ListNode.printList(sum);</span><br><span class="line">    &#125;</span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        public ListNode addTwoNumbers(ListNode l1, ListNode l2) &#123;</span><br><span class="line">            // å®šä¹‰preèŠ‚ç‚¹ï¼Œä¿è¯å¤´èŠ‚ç‚¹ä¹Ÿå‚ä¸å¾ªç¯</span><br><span class="line">            ListNode pre = new ListNode(0);</span><br><span class="line">            ListNode cur = pre;</span><br><span class="line">            int carry = 0;</span><br><span class="line">            while (l1 != null || l2 != null) &#123;</span><br><span class="line">                int x = l1 == null ? 0 : l1.val;</span><br><span class="line">                int y = l2 == null ? 0 : l2.val;</span><br><span class="line">                int sum = (x y carry) % 10;</span><br><span class="line">                carry = (x y carry) / 10;</span><br><span class="line">                cur.next = new ListNode(sum);</span><br><span class="line">                cur = cur.next;</span><br><span class="line">                if (l1 != null) &#123;</span><br><span class="line">                    l1 = l1.next;</span><br><span class="line">                &#125;</span><br><span class="line">                if (l2 != null) &#123;</span><br><span class="line">                    l2 = l2.next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (carry != 0) &#123;</span><br><span class="line">                cur.next = new ListNode(carry);</span><br><span class="line">            &#125;</span><br><span class="line">            return pre.next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class ListNode &#123;</span><br><span class="line">        int val;</span><br><span class="line">        ListNode next;</span><br><span class="line">        ListNode() &#123;&#125;;</span><br><span class="line">        ListNode(int val) &#123;this.val = val;&#125;</span><br><span class="line">        ListNode(int val, ListNode next) &#123; this.val = val; this.next = next; &#125;</span><br><span class="line"></span><br><span class="line">        /** å‘é˜Ÿå°¾æ·»åŠ èŠ‚ç‚¹ */</span><br><span class="line">        private void addNode(ListNode newNode) &#123;</span><br><span class="line">            if (this.next == null) &#123;</span><br><span class="line">                this.next = newNode;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.next.addNode(newNode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        /** ä½¿ç”¨æ–¹æ³•å¯å˜å‚æ•°æŠŠä¸€ä¸²æ•°å­—å˜æˆé“¾è¡¨ */</span><br><span class="line">        public static ListNode inputList(int ...data) &#123;</span><br><span class="line">            ListNode listHead = null;</span><br><span class="line">            for (int temp : data) &#123;</span><br><span class="line">                ListNode newNode = new ListNode(temp);</span><br><span class="line">                if (listHead == null) &#123;</span><br><span class="line">                    listHead = newNode;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    listHead.addNode(newNode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return listHead;</span><br><span class="line">        &#125;</span><br><span class="line">        /** æ‰“å°é“¾è¡¨ */</span><br><span class="line">        public static void printList(ListNode head) &#123;</span><br><span class="line">            while (head != null) &#123;</span><br><span class="line">                System.out.print(head.val &quot;-&gt;&quot;);</span><br><span class="line">                head = head.next;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        /** ç¿»è½¬é“¾è¡¨ */</span><br><span class="line">        public static ListNode reverseList(ListNode head) &#123;</span><br><span class="line">            ListNode pre = null;</span><br><span class="line">            ListNode cur = head;</span><br><span class="line">            while (cur != null) &#123;</span><br><span class="line">                ListNode next = cur.next;</span><br><span class="line">                cur.next = pre;</span><br><span class="line">                pre = cur;</span><br><span class="line">                cur = next;</span><br><span class="line">            &#125;</span><br><span class="line">            return pre;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å­—ç¬¦ä¸²çš„æœ€é•¿æ— é‡å¤å­—ç¬¦å­ä¸²"><a href="#å­—ç¬¦ä¸²çš„æœ€é•¿æ— é‡å¤å­—ç¬¦å­ä¸²" class="headerlink" title="å­—ç¬¦ä¸²çš„æœ€é•¿æ— é‡å¤å­—ç¬¦å­ä¸²"></a>å­—ç¬¦ä¸²çš„æœ€é•¿æ— é‡å¤å­—ç¬¦å­ä¸²</h2><p>é¢˜ç›®ï¼šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç»™å‡ºå­—ç¬¦ä¸²çš„è¿ç»­å­ä¸²ä¸­å…¶ä¸­æ— é‡å¤å­—ç¬¦çš„å­ä¸²çš„æœ€å¤§é•¿åº¦ã€‚<br>æ€æƒ³ï¼šæ»‘åŠ¨çª—å£ï¼Œæˆ–è€…å«åšåŒæŒ‡é’ˆï¼Œä¸¤ä¸ªæŒ‡é’ˆçš„å·®+1è¡¨ç¤ºçª—å£çš„é•¿åº¦ï¼Œç”¨ä¸€ä¸ªmapè®°å½•æŸå­—ç¬¦æœ€æ™šå‡ºç°çš„ä½ç½®çš„ä¸‹ä¸€ä¸ªä½ç½®ã€‚å¦‚æœåœ¨startæŒ‡é’ˆåé¢å‡ºç°è¿‡å°±éœ€è¦ç§»åŠ¨startåˆ°mapè¯¥å­—ç¬¦çš„valueçš„ä½ç½®äº†ã€‚å¦‚æœè¦å­ä¸²æœ¬èº«ï¼Œè¿˜å¾—è®°å½•å¼€å§‹ä½ç½®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package leeco.nums;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²</span><br><span class="line"> *</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-10-22 12:29</span><br><span class="line"> **/</span><br><span class="line">public class MaxNoRepeatString &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String s = &quot;abcabc&quot;;</span><br><span class="line">        Solution solution = new Solution();</span><br><span class="line">        System.out.println(solution.lengthOfLongestSubstring(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        public int lengthOfLongestSubstring(String s) &#123;</span><br><span class="line">            // ç”¨mapè¡¨ç¤ºå­—ç¬¦å¯¹åº”çš„ä¸‹ä¸€ä¸ªä½ç½®</span><br><span class="line">            Map&lt;Character, Integer&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">            int res = 0;</span><br><span class="line">            String sub = null;</span><br><span class="line">            for (int start = 0, end = 0; end &lt; s.length(); end ++) &#123;</span><br><span class="line">                char c = s.charAt(end);</span><br><span class="line">                if (map.containsKey(c)) &#123;</span><br><span class="line">                    start = Math.max(start, map.get(c));</span><br><span class="line">                &#125;</span><br><span class="line">                // å¦‚æœå­˜åœ¨keyï¼Œä¼šæ›´æ–°</span><br><span class="line">                map.put(c, end 1);</span><br><span class="line">                //res = Math.max(res, end - start 1);</span><br><span class="line">                if (end - start 1 &gt; res) &#123;</span><br><span class="line">                    res = end - start 1;</span><br><span class="line">                    sub = s.substring(start, end 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;subå­—ç¬¦ä¸²ï¼š&quot; sub);</span><br><span class="line">            return res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int lengthOfLongestSubstring(String s) &#123;</span><br><span class="line">        Map&lt;Character, Integer&gt; map = new HashMap();</span><br><span class="line">        int maxSize = 0;</span><br><span class="line">        int l = 0;</span><br><span class="line">        String res = null;</span><br><span class="line">        for (int r = 0; r &lt; s.length(); r ++) &#123;  //Stringæ˜¯.length() æ•°ç»„æ˜¯.length</span><br><span class="line">            char c = s.charAt(r);  //ä¸æ˜¯.getï¼Œæ˜¯.charAt</span><br><span class="line">            if (map.containsKey(c)) &#123;</span><br><span class="line">                l = Math.max(map.get(c) 1, l);  //éœ€è¦å–å¤§çš„ï¼Œä¸ç„¶ä¼šå›é€€</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(c, r);</span><br><span class="line">            if (r - l 1 &gt; maxSize) &#123;</span><br><span class="line">                maxSize = r - l 1;</span><br><span class="line">                res = s.substring(l, r 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;res:&quot; res);</span><br><span class="line">        return maxSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Solution:</span><br><span class="line">    def lengthOfLongestSubstring(self, s: str) -&gt; int:</span><br><span class="line">        dic, res, i = &#123;&#125;, 0, 0</span><br><span class="line">        for j in range(len(s)):</span><br><span class="line">            if s[j] in dic:</span><br><span class="line">                i = max(i, dic[s[j]] + 1)</span><br><span class="line">            dic[s[j]] = j</span><br><span class="line">            res = max(res, j - i + 1)</span><br><span class="line">        return res</span><br></pre></td></tr></table></figure>

<h2 id="å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°"><a href="#å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°" class="headerlink" title="å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°"></a>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°</h2><p>é¢˜ç›®ï¼šç»™ä¸¤ä¸ªæ­£åºæ’åˆ—çš„æ•°ç»„ï¼Œè¿”å›è¿™ä¸¤ä¸ªæ•°ç»„åˆèµ·æ¥çš„æ•°ç»„çš„ä¸­ä½æ•°ã€‚<br>æ€è·¯1ï¼šéå†ï¼Œåœ¨ä¸¤ä¸ªæ•°ç»„é—´æ¨ªè·³ï¼Œéå†(m+n)/2+1æ¬¡å°±å¥½äº†ã€‚æ—¶é—´å¤æ‚åº¦æ˜¯O(m+n)<br>æ€è·¯2ï¼šéå†æ˜¯æŒ¨ä¸ªæ’é™¤ä¸å¯èƒ½çš„å€¼ï¼Œé‚£ä¹ˆå¦‚æœç”¨äºŒåˆ†æ³•å°±å¯ä»¥ä¸€åŠä¸€åŠåœ°æ’é™¤ä¸å¯èƒ½çš„å€¼ã€‚å…¶å®æ˜¯æ‰¾ç¬¬Kå°çš„æ•°ï¼Œè¦æ¯”ä¸¤ä¸ªæ•°ç»„çš„K/2ä½ç½®çš„æ•°ï¼Œå°çš„é‚£ä¸ªæ•°ç»„K/2åŠå‰é¢çš„æ•°å°±å¯ä»¥æ’é™¤æ‰ï¼Œè¿™æ ·é€’å½’æŸ¥æ‰¾ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package leeco.nums;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°</span><br><span class="line"> *</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-10-23 10:10</span><br><span class="line"> **/</span><br><span class="line">public class MedianOfTwoArray &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int[] array1 = new int[]&#123;1, 2&#125;;</span><br><span class="line">        int[] array2 = new int[]&#123;3, 4&#125;;</span><br><span class="line">        Solution s = new Solution();</span><br><span class="line">        System.out.println(s.findMedianSortedArrays(array1, array2));</span><br><span class="line">        System.out.println(s.findMedianSortedArrays2(array1, array2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        // æ–¹æ³•ä¸€ï¼šåœ¨ä¸¤ä¸ªæ•°ç»„é—´éå†ï¼Œç§»åŠ¨(m+n)/2+1æ­¥</span><br><span class="line">        public double findMedianSortedArrays(int[] nums1, int[] nums2) &#123;</span><br><span class="line">            int index1 = 0, index2 = 0, left = 0, right = 0;</span><br><span class="line">            int size = nums1.length nums2.length;</span><br><span class="line">            for (int i = 0; i &lt;= size / 2; i++) &#123;</span><br><span class="line">                // leftæ…¢ä¸€æ­¥</span><br><span class="line">                left = right;</span><br><span class="line">                if (index1 &lt; nums1.length &amp;&amp; (index2 == nums2.length || nums1[index1] &lt;= nums2[index2])) &#123;</span><br><span class="line">                    right = nums1[index1++];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    right = nums2[index2++];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (size % 2 == 0) &#123;</span><br><span class="line">                return (left right) / 2.0;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return left;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // æ–¹æ³•äºŒï¼šäºŒåˆ†æ³•</span><br><span class="line">        public double findMedianSortedArrays2(int[] nums1, int[] nums2) &#123;</span><br><span class="line">            int n = nums1.length;</span><br><span class="line">            int m = nums2.length;</span><br><span class="line">            int left = (n m 1) / 2;</span><br><span class="line">            int right = (n m 2) / 2;</span><br><span class="line">            return (getKth(nums1, 0, n - 1, nums2, 0, m - 1, left) getKth(nums1, 0, n - 1, nums2, 0, m - 1, right)) * 0.5;</span><br><span class="line">        &#125;</span><br><span class="line">        // è·å–ä¸¤æ­£åºæ•°ç»„çš„ç¬¬kå¤§çš„å€¼</span><br><span class="line">        private int getKth(int[] nums1, int start1, int end1, int[] nums2, int start2, int end2, int k) &#123;</span><br><span class="line">            // è¦è¿›è¡Œæ¯”è¾ƒçš„æ•°ç»„çš„é•¿åº¦</span><br><span class="line">            int len1 = end1 - start1 1;</span><br><span class="line">            int len2 = end2 - start2 1;</span><br><span class="line">            if (len1 len2 &lt; k) &#123;throw new IllegalArgumentException(&quot;no result&quot;);&#125;</span><br><span class="line">            // å‡ºé€’å½’æ¡ä»¶</span><br><span class="line">            if (len1 == 0) return nums2[start2 k - 1];</span><br><span class="line">            if (len2 == 0) return nums1[start1 k - 1];</span><br><span class="line">            if (k == 1) return Math.min(nums1[start1], nums2[start2]);</span><br><span class="line">            // è¦æ¯”è¾ƒçš„ä¸¤ä¸ªæ•°ç»„çš„ç´¢å¼•</span><br><span class="line">            int i = start1 Math.min(len1, k / 2) - 1;</span><br><span class="line">            int j = start2 Math.min(len2, k / 2) - 1;</span><br><span class="line">            if (nums1[i] &gt; nums2[j]) &#123;</span><br><span class="line">                return getKth(nums1, start1, end1, nums2, j + 1, end2, k - (j - start2 1));</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">                return getKth(nums1, i + 1, end1, nums2, start2, end2, k - (i - start1 1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public double findMedianSortedArrays(int[] nums1, int[] nums2) &#123;</span><br><span class="line">        int size = nums1.length nums2.length;</span><br><span class="line">        int i = 0, j = 0;</span><br><span class="line">        int left = 0, right = 0;</span><br><span class="line">        for (int m = 0; m &lt;= size/2; m ++) &#123;</span><br><span class="line">            left = right;</span><br><span class="line">            if (i &lt; nums1.length &amp;&amp; (j == nums2.length || nums1[i] &lt;= nums2[j])) &#123;  //æ³¨æ„è¶Šç•Œ</span><br><span class="line">                right = nums1[i ++];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                right = nums2[j ++];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (size % 2 == 0) &#123;</span><br><span class="line">            return (left right) / 2.0; //æ³¨æ„é™¤ä»¥2.0</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // äºŒåˆ†æ³•çš„æ€æƒ³ï¼šåœ¨æœ‰åºæ•°ç»„ä¸­æŸ¥æ‰¾ï¼Œæ¯æ¬¡ç¼©å°ä¸€åŠçš„æŸ¥æ‰¾èŒƒå›´</span><br><span class="line">    // å°±è¦çœ‹æ€ä¹ˆæ·˜æ±°ï¼šæ‰©å±•ä¸€ä¸‹ï¼Œæ‰¾ç¬¬kå¤§æ•°ï¼Œä¸¤ä¸ªæ•°ç»„k/2ä½ç½®ï¼Œå°çš„é‚£ä¸ªæ•°ç»„ä¹‹å‰çš„å°±èƒ½æ·˜æ±°</span><br><span class="line">    public double findMedianSortedArrays(int[] nums1, int[] nums2) &#123;</span><br><span class="line">        int len = nums1.length nums2.length;</span><br><span class="line">        if (len % 2 == 0) &#123;</span><br><span class="line">            return (getK(nums1, 0, nums1.length - 1, nums2, 0, nums2.length - 1, len/2) getK(nums1, 0, nums1.length - 1, nums2, 0, nums2.length - 1, len/2 1)) / 2.0;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return getK(nums1, 0, nums1.length - 1, nums2, 0, nums2.length - 1, len/2 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Integer getK(int[] nums1, int s1, int e1, int[] nums2, int s2, int e2, int k) &#123;</span><br><span class="line">        System.out.println(s1+&quot;.&quot;+e1+&quot;.&quot;+s2+&quot;.&quot;+e2+&quot;.&quot;+k);</span><br><span class="line">        // é€’å½’ç¬¬ä¸€æ­¥ï¼šå‡ºé€’å½’æ¡ä»¶</span><br><span class="line">        if (s1 &gt; e1) return nums2[s2 k - 1]; // æ³¨æ„è¿™é‡Œå¾—åŠ s2</span><br><span class="line">        if (s2 &gt; e2) return nums1[s1 k - 1]; // æ³¨æ„kæ˜¯ç¬¬kä¸ªï¼Œç´¢å¼•åˆæ˜¯ä»0å¼€å§‹çš„</span><br><span class="line">        if (k == 1) return nums1[s1] &lt; nums2[s2] ? nums1[s1]:nums2[s2];</span><br><span class="line">        // é€’å½’ç¬¬äºŒæ­¥ï¼šç¼©å°èŒƒå›´</span><br><span class="line">        // éœ€è¦æ³¨æ„æ•°ç»„å¯èƒ½æ²¡k/2é‚£ä¹ˆå¤§äº†ï¼Œæ²¡é‚£ä¹ˆå¤§åªèƒ½é€‰è¾¹ç•Œ</span><br><span class="line">        int i = Math.min(s1 k/2 - 1, e1); // æ³¨æ„-1</span><br><span class="line">        int j = Math.min(s2 k/2 - 1, e2);</span><br><span class="line">        if (nums1[i] &lt; nums2[j]) &#123;</span><br><span class="line">            // åº”è¯¥æ‰¾ç¬¬å‡ ä¸ªäº†</span><br><span class="line">            int find = k - (i - s1 1);</span><br><span class="line">            return getK(nums1, i + 1, e1, nums2, s2, e2, find);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            int find = k - (j - s2 1);</span><br><span class="line">            return getK(nums1, s1, e1, nums2, j + 1, e2, find);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€é•¿å›æ–‡å­ä¸²"><a href="#æœ€é•¿å›æ–‡å­ä¸²" class="headerlink" title="æœ€é•¿å›æ–‡å­ä¸²"></a>æœ€é•¿å›æ–‡å­ä¸²</h2><p>é¢˜ç›®ï¼šç»™ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›è¯¥å­—ç¬¦ä¸²çš„æœ€é•¿å›æ–‡å­ä¸²ï¼Œä¾‹å¦‚ï¼šabaï¼Œabbaã€‚<br>æ€æƒ³1ï¼šå¯ä»¥æŒ¨ä¸ªéå†æ¯ä¸ªå­—ç¬¦ï¼Œä»å­—ç¬¦å¼€å§‹å‘å·¦å³æ•£å‘ï¼Œå¦‚æœä¸ç›¸ç­‰äº†å°±åœæ­¢ï¼Œå¹¶ä¸”åˆ†ä¸¤ç§æ•£å‘ï¼šä¸€ä¸ªä¸­å¿ƒå­—ç¬¦ï¼Œä¸¤ä¸ªä¸€æ ·çš„ä½œä¸ºä¸­å¿ƒå­—ç¬¦ã€‚è®°å½•å¼€å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚<br>æ€æƒ³2ï¼šå›æ–‡å­ä¸²ä¹Ÿæ˜¯è¯¥å­—ç¬¦ä¸²ä¸å®ƒå€’è¿‡æ¥çš„å­—ç¬¦ä¸²çš„æœ€é•¿å…¬å…±å­ä¸²ï¼Œå¯ä»¥ç”¨åŠ¨æ€è§„åˆ’ç»´æŠ¤ä¸€ä¸ªäºŒç»´æ•°ç»„æ¥åšã€‚åŠ¨æ€è§„åˆ’å°±æ˜¯ä¸ºäº†å‡å°‘é‡å¤è®¡ç®—çš„é—®é¢˜ã€‚åŠ¨æ€è§„åˆ’å¬èµ·æ¥å¾ˆé«˜å¤§ä¸Šã€‚å…¶å®è¯´ç™½äº†å°±æ˜¯ç©ºé—´æ¢æ—¶é—´ï¼Œå°†è®¡ç®—ç»“æœæš‚å­˜èµ·æ¥ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚ä½œç”¨å’Œå·¥ç¨‹ä¸­ç”¨ redis åšç¼“å­˜æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚<br>æ±‚å‡ºæœ€é•¿å…¬å…±å­ä¸²åï¼Œå¹¶ä¸ä¸€å®šæ˜¯å›æ–‡ä¸²ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ¤æ–­è¯¥å­—ç¬¦ä¸²å€’ç½®å‰çš„ä¸‹æ ‡å’Œå½“å‰çš„å­—ç¬¦ä¸²ä¸‹æ ‡æ˜¯ä¸æ˜¯åŒ¹é…</p>
<blockquote>
<p>æ•´ä½“æ€æƒ³å°±æ˜¯ï¼Œç”³è¯·ä¸€ä¸ªäºŒç»´çš„æ•°ç»„åˆå§‹åŒ–ä¸º 0ï¼Œç„¶ååˆ¤æ–­å¯¹åº”çš„å­—ç¬¦æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰çš„è¯<br>arr [ i ][ j ] = arr [ i - 1 ][ j - 1] + 1 ã€‚<br>å½“ i = 0 æˆ–è€… j = 0 çš„æ—¶å€™å•ç‹¬åˆ†æï¼Œå­—ç¬¦ç›¸ç­‰çš„è¯ arr [ i ][ j ] å°±èµ‹ä¸º 1 ã€‚<br>arr [ i ][ j ] ä¿å­˜çš„å°±æ˜¯å…¬å…±å­ä¸²çš„é•¿åº¦ï¼Œè¡¨ç¤ºä»¥iä¸ºç»“å°¾å’Œä»¥jä¸ºç»“å°¾çš„å‰arr[i][j]ä¸ªå­—ç¬¦æ˜¯å…¬å…±å­ä¸²ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">package leeco.nums;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æœ€é•¿å›æ–‡å­ä¸²</span><br><span class="line"> *</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-10-29 20:43</span><br><span class="line"> **/</span><br><span class="line">public class HuiWenString &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String s = &quot;aacabdkacaa&quot;;</span><br><span class="line">        Solution solution = new Solution();</span><br><span class="line">        System.out.println(solution.longestPalindrome(s));</span><br><span class="line">        System.out.println(solution.longestPalindrome1(s));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        public String longestPalindrome(String s) &#123;</span><br><span class="line">            if (null == s || s.length() &lt; 2) &#123;</span><br><span class="line">                return s;</span><br><span class="line">            &#125;</span><br><span class="line">            int max = 0;</span><br><span class="line">            String res = null;</span><br><span class="line">            for (int i = 0; i &lt; s.length() - 1; i ++) &#123;</span><br><span class="line">                int l = i, r = i;</span><br><span class="line">                while (l &gt;= 0 &amp;&amp; r &lt; s.length() &amp;&amp; s.charAt(l) == s.charAt(r)) &#123;</span><br><span class="line">                    l --;</span><br><span class="line">                    r ++;</span><br><span class="line">                &#125;</span><br><span class="line">                if (r - l 1 &gt; max) &#123;</span><br><span class="line">                    max = r - l 1;</span><br><span class="line">                    res = s.substring(l 1, r);</span><br><span class="line">                &#125;</span><br><span class="line">                l = i;</span><br><span class="line">                r = i + 1;</span><br><span class="line">                while (l &gt;= 0 &amp;&amp; r &lt; s.length() &amp;&amp; s.charAt(l) == s.charAt(r)) &#123;</span><br><span class="line">                    l --;</span><br><span class="line">                    r ++;</span><br><span class="line">                &#125;</span><br><span class="line">                if (r - l 1 &gt; max) &#123;</span><br><span class="line">                    max = r - l 1;</span><br><span class="line">                    res = s.substring(l 1, r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return res;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String longestPalindrome1(String s) &#123;</span><br><span class="line">            if (null == s || s.length() &lt; 2) &#123;</span><br><span class="line">                return s;</span><br><span class="line">            &#125;</span><br><span class="line">            String res = null;</span><br><span class="line">            int max = 0;</span><br><span class="line">            int length = s.length();</span><br><span class="line">            int[][] arr = new int[length][length];</span><br><span class="line">            String rev = new StringBuffer(s).reverse().toString(); //å­—ç¬¦ä¸²ç¿»è½¬</span><br><span class="line">            for (int i = 0; i &lt; length; i ++) &#123;</span><br><span class="line">                for (int j = 0; j &lt; length; j ++) &#123;</span><br><span class="line">                    //å¦‚æœä¸æƒ³ç­‰å¯ä»¥ä¸èµ‹å€¼ä¸º0ï¼Œè¡¨ç¤ºä»¥è¿™ä¸ªå­—ç¬¦ä¸ºå…¬å…±æœ€åå­—ç¬¦æ²¡æœ‰å…¬å…±å­—ç¬¦ï¼ŒåŠ¨æ€è§„åˆ’ä¹Ÿç”¨ä¸ä¸Š</span><br><span class="line">                    if (s.charAt(i) == rev.charAt(j)) &#123;</span><br><span class="line">                        //ä¸º0çš„è¾¹ç•Œ</span><br><span class="line">                        if (i == 0 || j == 0) &#123;</span><br><span class="line">                            arr[i][j] = 1;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            arr[i][j] = arr[i - 1][j - 1] + 1;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (arr[i][j] &gt; max) &#123;</span><br><span class="line">                        int beforeRev = length - 1 - j; //å€’ç½®å‰çš„åæ ‡</span><br><span class="line">                        if (beforeRev arr[i][j] - 1 == i) &#123; //åˆ¤æ–­ä¸‹æ ‡æ˜¯å¦å¯¹åº”</span><br><span class="line">                            max = arr[i][j];</span><br><span class="line">                            res = s.substring(i - arr[i][j] + 1, i + 1);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public String longestPalindrome(String s) &#123;</span><br><span class="line">        //éå†æ¯ä¸ªå…ƒç´ ï¼Œç”¨åŒæŒ‡é’ˆå‰åæ‹“å±•ï¼Œç›´åˆ°ä¸ä¸€æ ·å°±åœæ­¢</span><br><span class="line">        int maxSize = 0;</span><br><span class="line">        String res = &quot;&quot;;</span><br><span class="line">        for (int i = 0; i &lt; s.length(); i++) &#123;</span><br><span class="line">            // 1.ä¸€ä¸ªç‚¹ä¸ºä¸­å¿ƒ</span><br><span class="line">            int jump = 0;</span><br><span class="line">            while (i - jump &gt;= 0 &amp;&amp; i jump &lt; s.length() &amp;&amp; s.charAt(i - jump) == s.charAt(i jump)) &#123;</span><br><span class="line">                if (jump*2+1 &gt; maxSize) &#123;</span><br><span class="line">                    maxSize = jump*2+1;</span><br><span class="line">                    res = s.substring(i - jump, i jump +1);</span><br><span class="line">                &#125;</span><br><span class="line">                jump ++;</span><br><span class="line">            &#125;</span><br><span class="line">            // 2.ä»¥ä¸¤ä¸ªç‚¹ä¸ºä¸­å¿ƒ</span><br><span class="line">            jump= 0; // æ³¨æ„ä»0å¼€å§‹</span><br><span class="line">            while (i - jump &gt;= 0 &amp;&amp; i + 1 jump &lt; s.length() &amp;&amp; s.charAt(i - jump) == s.charAt(i + 1 jump)) &#123;</span><br><span class="line">                if (jump*2+2 &gt; maxSize) &#123;</span><br><span class="line">                    maxSize = jump*2+2;</span><br><span class="line">                    res = s.substring(i - jump, i jump +2);  //æ³¨æ„æ˜¯substring</span><br><span class="line">                &#125;</span><br><span class="line">                jump ++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public String longestPalindrome(String s) &#123;</span><br><span class="line">        //åŠ¨æ€è§„åˆ’çš„æ€æƒ³ï¼šä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œä¿å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—</span><br><span class="line">        //éœ€è¦æ˜ç¡®[i][j]è¡¨ç¤ºçš„å«ä¹‰ï¼Œä»¥åŠæ€ä¹ˆä¼ é€’ä¸‹å»ï¼Œä»¥åŠæœ€å¼€å§‹æ€ä¹ˆç®—</span><br><span class="line">        // 1.åˆå§‹åŒ–åŠ¨æ€è§„åˆ’çŸ©é˜µ</span><br><span class="line">        int length = s.length();</span><br><span class="line">        int[][] nums = new int[length][length]; //çŸ©é˜µåˆå§‹åŒ–æ–¹æ³•</span><br><span class="line">        String res = &quot;&quot;;</span><br><span class="line">        int max = 0;</span><br><span class="line">        // 2.éå†æ–¹å‘è¦ä¾æ®ä¼ é€’æ¡ä»¶</span><br><span class="line">        for (int i = length - 1; i &gt;= 0; i --) &#123;</span><br><span class="line">            int maxj = i;</span><br><span class="line">            for (int j = i; j &lt; length; j++) &#123;</span><br><span class="line">                if (i == j) &#123;</span><br><span class="line">                    // 3.ä»£è¡¨çš„å«ä¹‰åº”è¯¥æ˜¯ï¼šæ˜¯å¦å›æ–‡</span><br><span class="line">                    nums[i][j] = 1;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                if (s.charAt(i) == s.charAt(j)) &#123;</span><br><span class="line">                    if (j == i + 1) &#123;</span><br><span class="line">                        nums[i][j] = 1;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // 4.ä¸Šé¢æ˜¯åˆå§‹æ¡ä»¶ï¼Œä¸‹é¢æ˜¯ä¼ é€’æ¡ä»¶</span><br><span class="line">                        nums[i][j] = nums[i + 1][j - 1];</span><br><span class="line">                    &#125;</span><br><span class="line">                    maxj = nums[i][j] == 1 &amp;&amp; j &gt; maxj ? j: maxj;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    nums[i][j] = 0;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (maxj - i + 1 &gt; max) &#123;</span><br><span class="line">                max = maxj - i + 1;</span><br><span class="line">                res = s.substring(i, maxj + 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Zå­—å½¢å˜æ¢"><a href="#Zå­—å½¢å˜æ¢" class="headerlink" title="Zå­—å½¢å˜æ¢"></a>Zå­—å½¢å˜æ¢</h2><p>é¢˜ç›®ï¼šå°†ä¸€ä¸ªç»™å®šå­—ç¬¦ä¸² s æ ¹æ®ç»™å®šçš„è¡Œæ•° numRows ï¼Œä»¥ä»ä¸Šå¾€ä¸‹ã€ä»å·¦åˆ°å³è¿›è¡Œ Z å­—å½¢æ’åˆ—ã€‚</p>
<p>æ€è·¯ï¼šæ ¹æ®è¡Œæ•°å¯ä»¥å¾—å‡ºå¤šå°‘ä¸ªå¾ªç¯ä¸€æ¬¡åŠZï¼Œç„¶åç¬¬ä¸€è¡Œå°±æ˜¯é™¤ä»¥å‡ ä½™å‡ çš„ï¼Œçœ‹æœ‰å’©ç”¨æ–¹æ³•å¯ä»¥è·å–ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ä½ç½®æ˜¯/nä½™içš„å­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²ã€‚Stringçš„splitæ–¹æ³•å°½ç®¡å¯ä»¥æŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼æ¥åˆ†å‰²ï¼Œä½†æ˜¯è²Œä¼¼æ— æ³•å®ç°éš”ä½åˆ†å‰²ã€‚<br>æ‰€ä»¥åªèƒ½æ˜¯æ–°å»ºä¸€ä¸ª<code>List&lt;StringBuilder&gt;</code>ï¼Œç„¶åéå†å­—ç¬¦ä¸²æ¥appendè¿›å»ã€‚æ¯”å–ä½™æ›´å¥½çš„åšæ³•æ˜¯ç”¨ä¸€ä¸ªindexæ ‡æ³¨ï¼Œå¾€ä¸‹æ˜¯+1ï¼Œé‡åˆ°æ‹è§’å°±-1.</p>
<p>éå†å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦ï¼š<code>char c : s.toCharArray()</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package leeco.string;</span><br><span class="line"></span><br><span class="line">import com.google.common.collect.Lists;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-12 12:08</span><br><span class="line"> **/</span><br><span class="line">public class ZTransform &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String s = &quot;PAYPALISHIRING&quot;;</span><br><span class="line">        Solution so = new Solution();</span><br><span class="line">        String res = so.convert(s, 3);</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        public String convert(String s, int numRows) &#123;</span><br><span class="line">            if (numRows &lt; 2) return s;</span><br><span class="line">            List&lt;StringBuilder&gt; rows = Lists.newArrayList();</span><br><span class="line">            //List&lt;StringBuilder&gt; rows = new ArrayList&lt;StringBuilder&gt;();</span><br><span class="line">            //éœ€è¦å†™å…¥numRowsä¸ªStringBuilderåˆ°List</span><br><span class="line">            for (int i = 0; i &lt; numRows; i++) &#123;</span><br><span class="line">                StringBuilder sb = new StringBuilder();</span><br><span class="line">                rows.add(sb);</span><br><span class="line">            &#125;</span><br><span class="line">            int index = 0;</span><br><span class="line">            int step = -1;</span><br><span class="line">            for (char c : s.toCharArray()) &#123;</span><br><span class="line">                rows.get(index).append(c);</span><br><span class="line">                //é‡åˆ°æ‹ç‚¹ï¼Œæ–¹å‘å°±å</span><br><span class="line">                if (index == 0 || index == numRows - 1) &#123;</span><br><span class="line">                    step = -step;</span><br><span class="line">                &#125;</span><br><span class="line">                index += step;</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder res = new StringBuilder();</span><br><span class="line">            for (int i = 0; i &lt; numRows; i++) &#123;</span><br><span class="line">                res.append(rows.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">            return res.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public String convert(String s, int numRows) &#123;</span><br><span class="line">        //å¾ˆç®€å•ï¼Œè§„å¾‹æ€§çš„ä¸œè¥¿ï¼Œä¸¤ä¸ªæ–¹å‘ï¼šå¾€ä¸Šèµ°å’Œå¾€ä¸‹èµ°</span><br><span class="line">        if (numRows == 1) &#123;</span><br><span class="line">            return s;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;StringBuilder&gt; sbList = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 0; i&lt; numRows; i++) &#123;</span><br><span class="line">            StringBuilder sb = new StringBuilder();</span><br><span class="line">            sbList.add(sb);</span><br><span class="line">        &#125;</span><br><span class="line">        int index = 0;</span><br><span class="line">        for (int i = 0; i &lt; s.length(); i ++) &#123;</span><br><span class="line">            sbList.get(index).append(s.charAt(i));</span><br><span class="line">            if (i % (2 * numRows - 2) &lt; numRows - 1) &#123;</span><br><span class="line">                index ++;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                index --;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i&lt;numRows; i++) &#123;</span><br><span class="line">            sbList.get(0).append(sbList.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">        return sbList.get(0).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ•´æ•°åè½¬"><a href="#æ•´æ•°åè½¬" class="headerlink" title="æ•´æ•°åè½¬"></a>æ•´æ•°åè½¬</h2><p>é¢˜ç›®ï¼šç»™ä½ ä¸€ä¸ª 32 ä½çš„æœ‰ç¬¦å·æ•´æ•° x ï¼Œè¿”å›å°† x ä¸­çš„æ•°å­—éƒ¨åˆ†åè½¬åçš„ç»“æœã€‚-123 å˜ -321<br>Integeræ•´æ•°åŒºé—´ï¼š[âˆ’2^31,  2^31 âˆ’ 1]<br>æ€è·¯1ï¼šå˜æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶ååè½¬ï¼Œç„¶ååŠ ç¬¦å·ã€‚<br>æ€è·¯2ï¼šå¯¹intä¸€æ­¥ä¸€æ­¥/10ï¼Œç„¶åæ‹¿åˆ°ç»“æœä¸€æ­¥ä¸€æ­¥*10<br>æ€è·¯3ï¼šç”¨æ ˆstackï¼Œä¹Ÿå¾—å…ˆå˜å­—ç¬¦ä¸²ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯å­—ç¬¦ä¸²åè½¬ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">package leeco.nums;</span><br><span class="line"></span><br><span class="line">import java.util.Stack;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-12 22:38</span><br><span class="line"> **/</span><br><span class="line">public class IntegerReverse &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(Integer.MAX_VALUE);</span><br><span class="line">        System.out.println(Math.pow(2, 31) - 1);</span><br><span class="line">        int i = -33;</span><br><span class="line">        System.out.println(~(i-1));  //å’Œ-iä¸€æ ·</span><br><span class="line">        Solution s = new Solution();</span><br><span class="line">        System.out.println(s.reverse(-123));</span><br><span class="line">        System.out.println(s.reverse2(-123));</span><br><span class="line">        System.out.println(s.reverse2(-123));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Solution &#123;</span><br><span class="line">        public int reverse(int x) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                boolean flag = false;</span><br><span class="line">                if (x &lt; 0) &#123;</span><br><span class="line">                    flag = true;</span><br><span class="line">                    x = -x;</span><br><span class="line">                &#125;</span><br><span class="line">                String old = String.valueOf(x);</span><br><span class="line">                String newS = new StringBuilder(old).reverse().toString();</span><br><span class="line">                int res = Integer.parseInt(newS);</span><br><span class="line">                if (flag) res = -res;</span><br><span class="line">                return res;</span><br><span class="line">            &#125; catch (NumberFormatException e) &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int reverse2(int x) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                boolean flag = false;</span><br><span class="line">                if (x &lt; 0) &#123;</span><br><span class="line">                    flag = true;</span><br><span class="line">                    x = -x;</span><br><span class="line">                &#125;</span><br><span class="line">                int res = 0;</span><br><span class="line">                while (x &gt; 0) &#123;</span><br><span class="line">                    res = res * 10 x % 10;</span><br><span class="line">                    x = x / 10;</span><br><span class="line">                &#125;</span><br><span class="line">                if (flag) res = - res;</span><br><span class="line">                return res;</span><br><span class="line">            &#125; catch (NumberFormatException e) &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int reverse3(int x) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                boolean flag = false;</span><br><span class="line">                if (x &lt; 0) &#123;</span><br><span class="line">                    flag = true;</span><br><span class="line">                    x = -x;</span><br><span class="line">                &#125;</span><br><span class="line">                String old = String.valueOf(x);</span><br><span class="line">                Stack&lt;Character&gt; stack = new Stack&lt;&gt;();</span><br><span class="line">                for (char c : old.toCharArray()) stack.push(c);</span><br><span class="line">                StringBuilder sb = new StringBuilder();</span><br><span class="line">                while (!stack.empty()) sb.append(stack.pop());</span><br><span class="line">                int res = Integer.parseInt(sb.toString());</span><br><span class="line">                if (flag) res = -res;</span><br><span class="line">                return res;</span><br><span class="line">            &#125; catch (NumberFormatException e) &#123;</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int reverse(int x) &#123;</span><br><span class="line">        // ç”¨Stringè¿›è¡Œåè½¬ï¼Œjavaçš„å¹‚è¿ç®—ç”¨Math.pow(2,2)</span><br><span class="line">        boolean isFu = false;</span><br><span class="line">        if(x &lt; 0) &#123;</span><br><span class="line">            isFu = true;</span><br><span class="line">            // å¦‚æœæ˜¯-2^31ï¼Œè´Ÿçš„æ¥ä¸ä½ã€‚</span><br><span class="line">            if (x == Integer.MIN_VALUE) return 0;</span><br><span class="line">            x = -x;</span><br><span class="line">        &#125;</span><br><span class="line">        String s = new StringBuilder(String.valueOf(x)).reverse().toString();</span><br><span class="line">        long l = Long.valueOf(s);</span><br><span class="line">        // åŸæ¥æ­£çš„ï¼Œåè¿‡æ¥æ­£çš„ï¼Œä¸èƒ½å¤§äº2^ 31-1</span><br><span class="line">        if ((isFu &amp;&amp; l &gt; Math.pow(2, 31)) || !isFu &amp;&amp; l &gt; Math.pow(2, 31)-1)</span><br><span class="line">            return 0;</span><br><span class="line">        return isFu? -Integer.valueOf(String.valueOf(l)) : Integer.valueOf(String.valueOf(l));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="äºŒåˆ†"><a href="#äºŒåˆ†" class="headerlink" title="äºŒåˆ†"></a>äºŒåˆ†</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class ErFen &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(&quot;è¾“å…¥æœ‰åºæ•°ç»„ï¼Œé€—å·åˆ†éš”ï¼š&quot;);</span><br><span class="line">        Scanner sc = new Scanner(System.in);</span><br><span class="line">        String str = sc.nextLine();</span><br><span class="line">        str = str.replace(&quot; &quot;, &quot;&quot;);</span><br><span class="line">        String[] strArray = str.split(&quot;,&quot;);</span><br><span class="line">        int[] array = new int[strArray.length];</span><br><span class="line">        for(int i = 0; i &lt; array.length; i++) &#123;</span><br><span class="line">            array[i] = Integer.parseInt(strArray[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;è¾“å…¥ç›®æ ‡å€¼ï¼š&quot;);</span><br><span class="line">        int target = sc.nextInt();</span><br><span class="line">        System.out.println(&quot;array:&quot; Arrays.toString(array));</span><br><span class="line">        int min = 0;</span><br><span class="line">        int max = array.length - 1;</span><br><span class="line">        int middle = min (max - min) / 2; //é˜²æ­¢è¶Šç•Œ</span><br><span class="line">        while(min &lt;= max) &#123;</span><br><span class="line">            if (array[middle] == target) &#123;</span><br><span class="line">                System.out.println(middle);</span><br><span class="line">                return;</span><br><span class="line">            &#125; else if (array[middle] &lt; target) &#123;</span><br><span class="line">                min = middle 1;</span><br><span class="line">                middle = min (max - min) / 2;</span><br><span class="line">            &#125; else if (array[middle] &gt; target) &#123;</span><br><span class="line">                max = middle - 1;</span><br><span class="line">                middle = min (max - min) / 2;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°"><a href="#å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°" class="headerlink" title="å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°"></a>å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°</h2><p>â€œ   -42â€ å˜ä¸º-42.<br>â€œ4193 with wordsâ€ å˜ä¸º4193ã€‚<br>é‡åˆ°éæ•°å­—çš„å­—ç¬¦ä¸²å°±åœæ­¢ï¼Œå¦‚æœè¶…è¿‡intè¡¨ç¤ºèŒƒå›´äº†å°±è¿”å›æ­£è´Ÿçš„æœ€å¤§å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int myAtoi(String s) &#123;</span><br><span class="line">        // å»æ‰å¤´å°¾ç©ºç™½ç¬¦ï¼Œä¸­é—´çš„ä¸å»</span><br><span class="line">        char[] c = s.trim().toCharArray();</span><br><span class="line">        if (c.length == 0) return 0;</span><br><span class="line">        int res = 0, bndry = Integer.MAX_VALUE / 10; //æœ€å¤§æ˜¯2147483647</span><br><span class="line">        int i = 1, sign = 1;</span><br><span class="line">        if (c[0] == &#x27;-&#x27;) sign = -1;</span><br><span class="line">        else if (c[0] != &#x27;+&#x27;) i = 0; //ä»0å¼€å§‹</span><br><span class="line">        for (int j = i; j &lt; c.length; j++) &#123;</span><br><span class="line">            if (c[j] &lt; &#x27;0&#x27; || c[j] &gt; &#x27;9&#x27;) break;</span><br><span class="line">            if (res &gt; bndry || res == bndry &amp;&amp; c[j] &gt; &#x27;7&#x27;) &#123;</span><br><span class="line">                return sign == 1 ? Integer.MAX_VALUE : Integer.MIN_VALUE;</span><br><span class="line">            &#125;</span><br><span class="line">            res = res * 10 (c[j] - &#x27;0&#x27;); //å­—ç¬¦å˜æ•°å­—</span><br><span class="line">        &#125;</span><br><span class="line">        return sign * res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="åˆ°æœ€è¿‘çš„äººçš„æœ€å¤§è·ç¦»"><a href="#åˆ°æœ€è¿‘çš„äººçš„æœ€å¤§è·ç¦»" class="headerlink" title="åˆ°æœ€è¿‘çš„äººçš„æœ€å¤§è·ç¦»"></a>åˆ°æœ€è¿‘çš„äººçš„æœ€å¤§è·ç¦»</h2><p>ç»™ä½ ä¸€ä¸ªæ•°ç»„ seats è¡¨ç¤ºä¸€æ’åº§ä½ï¼Œå…¶ä¸­ seats[i] = 1 ä»£è¡¨æœ‰äººååœ¨ç¬¬ i ä¸ªåº§ä½ä¸Šï¼Œseats[i] = 0 ä»£è¡¨åº§ä½ i ä¸Šæ˜¯ç©ºçš„ï¼ˆä¸‹æ ‡ä» 0 å¼€å§‹ï¼‰ã€‚</p>
<p>æ‰¾ä¸€ä¸ªè·ç¦»ä¸¤è¾¹äººæœ€è¿‘çš„ä¸€ä¸ªä½ç½®ï¼Œæ‰¾å‘ä½ã€‚è¿”å›ä»–åˆ°ç¦»ä»–æœ€è¿‘çš„äººçš„æœ€å¤§è·ç¦»ã€‚</p>
<p>åŒæŒ‡é’ˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int maxDistToClosest(int[] seats) &#123;</span><br><span class="line">        //åŒæŒ‡é’ˆï¼šå·¦å³æŒ‡é’ˆä¸ºç›¸é‚»çš„æœ‰äººåº§ä½ï¼Œåˆ™æœ€å¤§è·ç¦»æ˜¯r-l/2</span><br><span class="line">        //ä½†æ˜¯è¦è€ƒè™‘ä¸¤è¾¹æ²¡åº§ä½çš„æƒ…å†µ</span><br><span class="line">        int res = 0;</span><br><span class="line">        int l = 0;</span><br><span class="line">        while(seats[l] == 0) &#123;</span><br><span class="line">            l ++;</span><br><span class="line">        &#125;</span><br><span class="line">        res = Math.max(res, l);</span><br><span class="line">        while(l &lt; seats.length - 1) &#123;</span><br><span class="line">            int r = l 1;</span><br><span class="line">            while(r &lt; seats.length &amp;&amp; seats[r] == 0) &#123;</span><br><span class="line">                r ++;</span><br><span class="line">            &#125;</span><br><span class="line">            if (r == seats.length) &#123;</span><br><span class="line">                res = Math.max(res, r - l - 1);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                res = Math.max(res, (r - l)/2);</span><br><span class="line">            &#125;</span><br><span class="line">            l = r;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="å›æ–‡æ•°"><a href="#å›æ–‡æ•°" class="headerlink" title="å›æ–‡æ•°"></a>å›æ–‡æ•°</h2><p>1.å˜æˆStringä¹‹ååè½¬æ¯”è¾ƒæ˜¯å¦è·Ÿä¹‹å‰çš„æ•°ç›¸ç­‰ï¼Œä½†æ˜¯è¦æ³¨æ„Integeræº¢å‡ºã€‚<br>2.å˜æˆStringä¹‹åï¼ŒåŒæŒ‡é’ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public boolean isPalindrome(int x) &#123;</span><br><span class="line">        if (x &lt; 0) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        long y = Long.valueOf(new StringBuilder(new Long(x).toString()).reverse().toString());</span><br><span class="line">        return x == y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç››æœ€å¤šæ°´çš„å®¹å™¨"><a href="#ç››æœ€å¤šæ°´çš„å®¹å™¨" class="headerlink" title="ç››æœ€å¤šæ°´çš„å®¹å™¨"></a>ç››æœ€å¤šæ°´çš„å®¹å™¨</h2><p>ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•´æ•°æ•°ç»„ height ã€‚æœ‰ n æ¡å‚çº¿ï¼Œç¬¬ i æ¡çº¿çš„ä¸¤ä¸ªç«¯ç‚¹æ˜¯ (i, 0) å’Œ (i, height[i]) ã€‚</p>
<p>æ‰¾å‡ºå…¶ä¸­çš„ä¸¤æ¡çº¿ï¼Œä½¿å¾—å®ƒä»¬ä¸ x è½´å…±åŒæ„æˆçš„å®¹å™¨å¯ä»¥å®¹çº³æœ€å¤šçš„æ°´ã€‚</p>
<p>è¿”å›å®¹å™¨å¯ä»¥å‚¨å­˜çš„æœ€å¤§æ°´é‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int maxArea(int[] height) &#123;</span><br><span class="line">        // åŒæŒ‡é’ˆï¼šä¸€ä¸ªæœ€å‰ä¸€ä¸ªæœ€åï¼Œè°å°å°±ç§»åŠ¨è°</span><br><span class="line">        int l = 0, r = height.length-1;</span><br><span class="line">        int max = 0;</span><br><span class="line">        while(l &lt; r) &#123;</span><br><span class="line">            // é€‰æ‹©å°çš„ç§»åŠ¨</span><br><span class="line">            if (height[l] &lt; height[r]) &#123;</span><br><span class="line">                max = Math.max(max, (r - l) * height[l]);</span><br><span class="line">                l ++;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                max = Math.max(max, (r - l) * height[r]);</span><br><span class="line">                r --;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ•´æ•°è½¬ç½—é©¬æ•°å­—"><a href="#æ•´æ•°è½¬ç½—é©¬æ•°å­—" class="headerlink" title="æ•´æ•°è½¬ç½—é©¬æ•°å­—"></a>æ•´æ•°è½¬ç½—é©¬æ•°å­—</h2><p>1.5.10.50â€¦æœ‰ç‰¹å®šçš„ç¬¦å·ï¼Œä½†æ˜¯4.9.40.90â€¦ä¹Ÿæ¯”è¾ƒç‰¹æ®Šï¼Œæ‰€ä»¥æŠŠå®ƒä»¬ä¹Ÿä½œä¸ºç‰¹å®šçš„ç¬¦å·ã€‚ä»å¤§åˆ°å°éå†ã€‚ä¸ä¼šå‡ºç°80å˜ä¸ºä¸¤ä¸ª40çš„æƒ…å†µï¼Œå› ä¸ºä¹‹å‰ä¸€å®šä¼šå…ˆæ‹†å‡ºä¸€ä¸ª50.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    int[] values = &#123;1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1&#125;;</span><br><span class="line">    String[] symbols = &#123;&quot;M&quot;, &quot;CM&quot;, &quot;D&quot;, &quot;CD&quot;, &quot;C&quot;, &quot;XC&quot;, &quot;L&quot;, &quot;XL&quot;, &quot;X&quot;, &quot;IX&quot;, &quot;V&quot;, &quot;IV&quot;, &quot;I&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    public String intToRoman(int num) &#123;</span><br><span class="line">        StringBuffer roman = new StringBuffer();</span><br><span class="line">        for (int i = 0; i &lt; values.length; ++i) &#123;</span><br><span class="line">            int value = values[i];</span><br><span class="line">            String symbol = symbols[i];</span><br><span class="line">            while (num &gt;= value) &#123;</span><br><span class="line">                num -= value;</span><br><span class="line">                roman.append(symbol);</span><br><span class="line">            &#125;</span><br><span class="line">            if (num == 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return roman.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„"><a href="#åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„" class="headerlink" title="åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„"></a>åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„</h2><p>ç»™ä¸¤ä¸ªé€’å¢çš„æ•°ç»„ï¼Œå…¶ä¸­nums1åé¢çš„nums2çš„é•¿åº¦æ˜¯æœ‰çš„ï¼Œå¡«å……çš„0.å°†nums2å¡«å……åˆ°nums1ä¸­ï¼Œå¹¶ä¸”æ˜¯æ’å¥½åºçš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public void merge(int[] nums1, int m, int[] nums2, int n) &#123;</span><br><span class="line">        //ç”¨åŒæŒ‡é’ˆè¿›è¡Œæ›¿æ¢ï¼Œå¦‚æœæ˜¯ç¬¬äºŒä¸ªé˜Ÿåˆ—çš„å…ƒç´ å¤§ï¼Œå°±æ›¿æ¢</span><br><span class="line">        //æ›¿æ¢å‡ºæ¥çš„ç¬¬ä¸€ä¸ªé˜Ÿåˆ—çš„å…ƒç´ æ”¾åœ¨å“ªï¼Œæ”¾å“ªéƒ½ä¸è¡Œï¼Œæ‰€ä»¥ä»åå¾€å‰ç§»åŠ¨</span><br><span class="line">        // æ–¹æ³•ä¸€ï¼šå…ˆåˆå¹¶ï¼Œç›´æ¥Arrays.sort(nums1)</span><br><span class="line">        // æ–¹æ³•äºŒï¼šå¼€ä¸€ä¸ªæ–°æ•°ç»„ï¼Œä»å‰å¾€ååŒæŒ‡é’ˆ</span><br><span class="line">        // æ–¹æ³•ä¸‰ï¼šä¸ç”¨é‡å¼€ï¼Œç›´æ¥ä»åå¾€å‰åŒæŒ‡é’ˆ</span><br><span class="line">        int tail = m n - 1;</span><br><span class="line">        int p1 = m - 1;</span><br><span class="line">        int p2 = n - 1;</span><br><span class="line">        while(p1 &gt;= 0 || p2 &gt;= 0) &#123;</span><br><span class="line">            if (p1 &lt; 0) &#123;</span><br><span class="line">                nums1[tail] = nums2[p2--];</span><br><span class="line">            &#125; else if (p2 &lt; 0) &#123;</span><br><span class="line">                nums1[tail] = nums1[p1--];</span><br><span class="line">            &#125; else if (nums1[p1] &gt; nums2[p2]) &#123;</span><br><span class="line">                nums1[tail] = nums1[p1--];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                nums1[tail] = nums2[p2--];</span><br><span class="line">            &#125;</span><br><span class="line">            tail--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç§»é™¤å…ƒç´ "><a href="#ç§»é™¤å…ƒç´ " class="headerlink" title="ç§»é™¤å…ƒç´ "></a>ç§»é™¤å…ƒç´ </h2><p>ç»™ä½ ä¸€ä¸ªæ•°ç»„ nums å’Œä¸€ä¸ªå€¼ valï¼Œä½ éœ€è¦ åŸåœ° ç§»é™¤æ‰€æœ‰æ•°å€¼ç­‰äº val çš„å…ƒç´ ï¼Œå¹¶è¿”å›ç§»é™¤åæ•°ç»„çš„æ–°é•¿åº¦ã€‚ä¸èƒ½ä½¿ç”¨é¢å¤–çš„ç©ºé—´ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int removeElement(int[] nums, int val) &#123;</span><br><span class="line">        //åŒæŒ‡é’ˆï¼Œä¸€å‰ä¸€åï¼Œå‰é¢çš„ä¸æ˜¯valï¼Œå°±å¾€åèµ°ï¼Œå¦‚æœæ˜¯å°±æ›¿æ¢ï¼Œå¹¶å‰åéƒ½ç§»åŠ¨ï¼Œå…¶å®ä¸ç”¨æ›¿æ¢</span><br><span class="line">        int l = 0;</span><br><span class="line">        int r = nums.length - 1;</span><br><span class="line">        while(l &lt;= r) &#123;</span><br><span class="line">            if (l == r) &#123;</span><br><span class="line">                if (nums[l] != val) l ++;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (nums[l] == val &amp;&amp; nums[r] != val) &#123;</span><br><span class="line">                nums[l] = nums[r];</span><br><span class="line">                l ++;</span><br><span class="line">                r --;</span><br><span class="line">            &#125; else if (nums[l] == val &amp;&amp; nums[r] == val) &#123;</span><br><span class="line">                r --;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                l ++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return l;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹"><a href="#åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹" class="headerlink" title="åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹"></a>åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹</h2><p>ç»™ä½ ä¸€ä¸ª å‡åºæ’åˆ— çš„æ•°ç»„ nums ï¼Œè¯·ä½  åŸåœ° åˆ é™¤é‡å¤å‡ºç°çš„å…ƒç´ ï¼Œä½¿æ¯ä¸ªå…ƒç´  åªå‡ºç°ä¸€æ¬¡ ï¼Œè¿”å›åˆ é™¤åæ•°ç»„çš„æ–°é•¿åº¦ã€‚å…ƒç´ çš„ ç›¸å¯¹é¡ºåº åº”è¯¥ä¿æŒ ä¸€è‡´ ã€‚ç„¶åè¿”å› nums ä¸­å”¯ä¸€å…ƒç´ çš„ä¸ªæ•°ã€‚nums çš„å…¶ä½™å…ƒç´ ä¸ nums çš„å¤§å°ä¸é‡è¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int removeDuplicates(int[] nums) &#123;</span><br><span class="line">        //åŒæŒ‡é’ˆï¼Œç§»é™¤é‡å¤çš„å…ƒç´ å…¶å®å°±æ˜¯æŠŠä¸é‡å¤çš„å…ƒç´ ç§»åˆ°æœ€å‰é¢</span><br><span class="line">        int i = 0;</span><br><span class="line">        int j = 1;</span><br><span class="line">        while(j &lt; nums.length) &#123;</span><br><span class="line">            if (nums[i] == nums[j]) &#123;</span><br><span class="line">                j ++;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                i ++;</span><br><span class="line">                nums[i] = nums[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return i+1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹-II"><a href="#åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹-II" class="headerlink" title="åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹ II"></a>åˆ é™¤æœ‰åºæ•°ç»„ä¸­çš„é‡å¤é¡¹ II</h2><p>ç»™ä½ ä¸€ä¸ªæœ‰åºæ•°ç»„ nums ï¼Œè¯·ä½  åŸåœ° åˆ é™¤é‡å¤å‡ºç°çš„å…ƒç´ ï¼Œä½¿å¾—å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸¤æ¬¡çš„å…ƒç´ åªå‡ºç°ä¸¤æ¬¡ ï¼Œè¿”å›åˆ é™¤åæ•°ç»„çš„æ–°é•¿åº¦ã€‚</p>
<p>å’Œä¸Šé¢çš„ç›¸æ¯”ï¼Œå¤šäº†ä¿ç•™ä¸¤ä¸ªé‡å¤çš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int removeDuplicates(int[] nums) &#123;</span><br><span class="line">        // åŒæ ·æ˜¯ç›¸å½“äºå°†å…ƒç´ å‘å‰ç§»åŠ¨ï¼Œæ— éæ˜¯åŠ ä¸ªæ ‡è¯†ä½è¡¨ç¤ºç¬¬ä¸€ä¸ª</span><br><span class="line">        int i = 0, j = 1;</span><br><span class="line">        boolean isFirst = true;</span><br><span class="line">        while (j &lt; nums.length) &#123;</span><br><span class="line">            if (nums[i] == nums[j]) &#123;</span><br><span class="line">                if (isFirst) &#123;</span><br><span class="line">                    i ++;</span><br><span class="line">                    nums[i] = nums[j];</span><br><span class="line">                    isFirst = false;</span><br><span class="line">                    j ++;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    j ++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                i ++;</span><br><span class="line">                nums[i] = nums[j];</span><br><span class="line">                j ++;</span><br><span class="line">                isFirst = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return i+1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¤šæ•°å…ƒç´ "><a href="#å¤šæ•°å…ƒç´ " class="headerlink" title="å¤šæ•°å…ƒç´ "></a>å¤šæ•°å…ƒç´ </h2><p>æ‘©å°”æŠ•ç¥¨æ³•ï¼š<br>å€™é€‰äºº(cand_num)åˆå§‹åŒ–ä¸º nums[0]ï¼Œç¥¨æ•° count åˆå§‹åŒ–ä¸º 1ã€‚<br>å½“é‡åˆ°ä¸ cand_num ç›¸åŒçš„æ•°ï¼Œåˆ™ç¥¨æ•° count = count 1ï¼Œå¦åˆ™ç¥¨æ•° count = count - 1ã€‚å½“ç¥¨æ•° count ä¸º 0 æ—¶ï¼Œæ›´æ¢å€™é€‰äººï¼Œå¹¶å°†ç¥¨æ•° count é‡ç½®ä¸º 1ã€‚éå†å®Œæ•°ç»„åï¼Œcand_num å³ä¸ºæœ€ç»ˆç­”æ¡ˆã€‚</p>
<p>æŠ•ç¥¨æ³•æ˜¯é‡åˆ°ç›¸åŒçš„åˆ™ ç¥¨æ•° 1ï¼Œé‡åˆ°ä¸åŒçš„åˆ™ ç¥¨æ•° - 1ã€‚<br>ä¸”â€œå¤šæ•°å…ƒç´ â€çš„ä¸ªæ•° &gt; âŒŠ n/2 âŒ‹ï¼Œå…¶ä½™å…ƒç´ çš„ä¸ªæ•°æ€»å’Œ &lt;= âŒŠ n/2 âŒ‹ã€‚<br>å› æ­¤â€œå¤šæ•°å…ƒç´ â€çš„ä¸ªæ•° - å…¶ä½™å…ƒç´ çš„ä¸ªæ•°æ€»å’Œ çš„ç»“æœ è‚¯å®š &gt;= 1ã€‚<br>è¿™å°±ç›¸å½“äºæ¯ä¸ª â€œå¤šæ•°å…ƒç´ â€ å’Œå…¶ä»–å…ƒç´  ä¸¤ä¸¤ç›¸äº’æŠµæ¶ˆï¼ŒæŠµæ¶ˆåˆ°æœ€åè‚¯å®šè¿˜å‰©ä½™ è‡³å°‘1ä¸ª â€œå¤šæ•°å…ƒç´ â€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int majorityElement(int[] nums) &#123;</span><br><span class="line">        // æ’åºä¹‹åçš„nums.length/2å…ƒç´ ä¸€å®šæ˜¯å¤šæ•°å…ƒç´ </span><br><span class="line">        // æ‘©å°”æŠ•ç¥¨æ³•ï¼šå…ˆé€‰ä¸€ä¸ªï¼Œå¾€åéå†ï¼Œå¦‚æœä¸ä¸€æ ·å°±å‡ä¸€ï¼Œç›´åˆ°0å°±æ¢</span><br><span class="line">        int res = nums[0];</span><br><span class="line">        int score = 1;</span><br><span class="line">        for (int num : nums) &#123;</span><br><span class="line">            if (num == res) score ++;</span><br><span class="line">            else if (--score == 0) &#123;</span><br><span class="line">                res = num;</span><br><span class="line">                score = 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è½®è½¬æ•°ç»„"><a href="#è½®è½¬æ•°ç»„" class="headerlink" title="è½®è½¬æ•°ç»„"></a>è½®è½¬æ•°ç»„</h2><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ numsï¼Œå°†æ•°ç»„ä¸­çš„å…ƒç´ å‘å³è½®è½¬ k ä¸ªä½ç½®ï¼Œå…¶ä¸­ k æ˜¯éè´Ÿæ•°ã€‚<br>ä½¿ç”¨ç©ºé—´å¤æ‚åº¦ä¸º O(1) çš„ åŸåœ° ç®—æ³•è§£å†³è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public void rotate(int[] nums, int k) &#123;</span><br><span class="line">        // ä½¿ç”¨é¢å¤–çš„æ•°ç»„å¾ˆç®€å•ï¼Œé—®é¢˜æ˜¯æ€ä¹ˆç”¨O1çš„ç©ºé—´</span><br><span class="line">        // è¢«æ›¿æ¢çš„å…ƒç´ ä¿å­˜åœ¨å˜é‡tempä¸­ï¼Œä»è€Œé¿å…äº†é¢å¤–æ•°ç»„çš„å¼€é”€</span><br><span class="line">        // æ€ä¹ˆéå†ï¼Ÿè·³è·ƒå¼æ›¿æ¢ï¼Œå›åˆ°åŸç‚¹æ—¶åº”è¯¥ä»ä¸‹ä¸€ä¸ªå…ƒç´ å¼€å§‹è·³è·ƒ</span><br><span class="line">        // ä»€ä¹ˆæ—¶å€™ç»“æŸï¼Ÿç”¨ä¸€ä¸ªå…ƒç´ è®°å½•éå†äº†å¤šå°‘æ¬¡</span><br><span class="line">        if (k == 0 || nums.length &lt; 2) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        int count = 0;</span><br><span class="line">        int index = 0;</span><br><span class="line">        int temp = nums[index];</span><br><span class="line">        int pre;</span><br><span class="line">        int start = 0;</span><br><span class="line">        while (count &lt; nums.length) &#123;</span><br><span class="line">            index = (index k) % nums.length;</span><br><span class="line">            pre = nums[index];</span><br><span class="line">            nums[index] = temp;</span><br><span class="line">            temp = pre;</span><br><span class="line">            count ++;</span><br><span class="line">            if (count &lt; nums.length &amp;&amp; index == start) &#123;</span><br><span class="line">                index = start 1;</span><br><span class="line">                start = index;</span><br><span class="line">                temp = nums[index];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº"><a href="#ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº" class="headerlink" title="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº"></a>ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº</h2><p>ç»™å®šä¸€ä¸ªæ•°ç»„ prices ï¼Œå®ƒçš„ç¬¬ i ä¸ªå…ƒç´  prices[i] è¡¨ç¤ºä¸€æ”¯ç»™å®šè‚¡ç¥¨ç¬¬ i å¤©çš„ä»·æ ¼ã€‚</p>
<p>ä½ åªèƒ½é€‰æ‹© æŸä¸€å¤© ä¹°å…¥è¿™åªè‚¡ç¥¨ï¼Œå¹¶é€‰æ‹©åœ¨ æœªæ¥çš„æŸä¸€ä¸ªä¸åŒçš„æ—¥å­ å–å‡ºè¯¥è‚¡ç¥¨ã€‚è®¾è®¡ä¸€ä¸ªç®—æ³•æ¥è®¡ç®—ä½ æ‰€èƒ½è·å–çš„æœ€å¤§åˆ©æ¶¦ã€‚</p>
<p>è¿”å›ä½ å¯ä»¥ä»è¿™ç¬”äº¤æ˜“ä¸­è·å–çš„æœ€å¤§åˆ©æ¶¦ã€‚å¦‚æœä½ ä¸èƒ½è·å–ä»»ä½•åˆ©æ¶¦ï¼Œè¿”å› 0 ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        // ä¸€æ¬¡éå†ä¾¿å¯å¾—åˆ°ï¼Œæ¯æ¬¡éå†å¾—åˆ°ä¹‹å‰æœ€å°çš„æ•°ï¼Œä»¥åŠç›®å‰ä¸ºæ­¢æœ€å¤§åˆ©æ¶¦</span><br><span class="line">        int cost = Integer.MAX_VALUE, profile = 0;</span><br><span class="line">        for (int price : prices) &#123;</span><br><span class="line">            profile = Math.max(price - cost, profile);</span><br><span class="line">            cost = Math.min(cost, price);</span><br><span class="line">        &#125;</span><br><span class="line">        return profile;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’ï¼š</p>
<p>çŠ¶æ€å®šä¹‰ï¼šdp[i][j]ï¼šä¸‹æ ‡ä¸º i è¿™ä¸€å¤©ç»“æŸçš„æ—¶å€™ï¼Œæ‰‹ä¸ŠæŒè‚¡çŠ¶æ€ä¸º j æ—¶ï¼Œæˆ‘ä»¬æŒæœ‰çš„ç°é‡‘æ•°ã€‚æ¢ç§è¯´æ³•ï¼šdp[i][j] è¡¨ç¤ºå¤©æ•° [0, i] åŒºé—´é‡Œï¼Œä¸‹æ ‡ i è¿™ä¸€å¤©çŠ¶æ€ä¸º j çš„æ—¶å€™èƒ½å¤Ÿè·å¾—çš„æœ€å¤§åˆ©æ¶¦ã€‚</p>
<p>æ¨å¯¼çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š<br>dp[i][0]ï¼šè§„å®šäº†ä»Šå¤©ä¸æŒè‚¡ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š<br>æ˜¨å¤©ä¸æŒè‚¡ï¼Œä»Šå¤©ä»€ä¹ˆéƒ½ä¸åšï¼›<br>æ˜¨å¤©æŒè‚¡ï¼Œä»Šå¤©å–å‡ºè‚¡ç¥¨ï¼ˆç°é‡‘æ•°å¢åŠ ï¼‰</p>
<p>dp[i][1]ï¼šè§„å®šäº†ä»Šå¤©æŒè‚¡ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š<br>æ˜¨å¤©æŒè‚¡ï¼Œä»Šå¤©ä»€ä¹ˆéƒ½ä¸åšï¼ˆç°é‡‘æ•°ä¸æ˜¨å¤©ä¸€æ ·ï¼‰ï¼›<br>æ˜¨å¤©ä¸æŒè‚¡ï¼Œä»Šå¤©ä¹°å…¥è‚¡ç¥¨ï¼ˆæ³¨æ„ï¼šåªå…è®¸äº¤æ˜“ä¸€æ¬¡ï¼Œå› æ­¤æ‰‹ä¸Šçš„ç°é‡‘æ•°å°±æ˜¯å½“å¤©çš„è‚¡ä»·çš„ç›¸åæ•°ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        // ç‰¹æ®Šåˆ¤æ–­</span><br><span class="line">        if (len &lt; 2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        int[][] dp = new int[len][2];</span><br><span class="line"></span><br><span class="line">        // dp[i][0] ä¸‹æ ‡ä¸º i è¿™å¤©ç»“æŸçš„æ—¶å€™ï¼Œä¸æŒè‚¡ï¼Œæ‰‹ä¸Šæ‹¥æœ‰çš„ç°é‡‘æ•°</span><br><span class="line">        // dp[i][1] ä¸‹æ ‡ä¸º i è¿™å¤©ç»“æŸçš„æ—¶å€™ï¼ŒæŒè‚¡ï¼Œæ‰‹ä¸Šæ‹¥æœ‰çš„ç°é‡‘æ•°</span><br><span class="line"></span><br><span class="line">        // åˆå§‹åŒ–ï¼šä¸æŒè‚¡æ˜¾ç„¶ä¸º 0ï¼ŒæŒè‚¡å°±éœ€è¦å‡å»ç¬¬ 1 å¤©ï¼ˆä¸‹æ ‡ä¸º 0ï¼‰çš„è‚¡ä»·</span><br><span class="line">        dp[0][0] = 0;</span><br><span class="line">        dp[0][1] = -prices[0];</span><br><span class="line"></span><br><span class="line">        // ä»ç¬¬ 2 å¤©å¼€å§‹éå†</span><br><span class="line">        for (int i = 1; i &lt; len; i++) &#123;</span><br><span class="line">            dp[i][0] = Math.max(dp[i - 1][0], dp[i - 1][1] prices[i]);</span><br><span class="line">            dp[i][1] = Math.max(dp[i - 1][1], -prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len - 1][0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº2"><a href="#ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº2" class="headerlink" title="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº2"></a>ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº2</h2><p>ä¸ç¬¬ä¸€é¢˜åªèƒ½è¿›è¡Œä¸€æ¬¡äº¤æ˜“ä¸åŒï¼Œè¿™é‡Œå¯ä»¥è¿›è¡Œå¤šæ¬¡äº¤æ˜“ã€‚</p>
<p>æ–¹æ³•ä¸€ï¼šåœ¨æ¯ä¸€å¤©éƒ½æœ‰æ“ä½œ/ä¸æ“ä½œï¼ˆä¹°å…¥è¿˜æ˜¯å–å‡ºï¼‰çš„é€‰æ‹©ã€‚æ‰€ä»¥ç”¨æ ‘å½¢ç»“æ„è¿›è¡Œå›æº¯æœç´¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">    private int res;</span><br><span class="line"></span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        if (len &lt; 2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        this.res = 0;</span><br><span class="line">        dfs(prices, 0, len, 0, res);</span><br><span class="line">        return this.res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @param prices è‚¡ä»·æ•°ç»„</span><br><span class="line">     * @param index  å½“å‰æ˜¯ç¬¬å‡ å¤©ï¼Œä» 0 å¼€å§‹</span><br><span class="line">     * @param status 0 è¡¨ç¤ºä¸æŒæœ‰è‚¡ç¥¨ï¼Œ1è¡¨ç¤ºæŒæœ‰è‚¡ç¥¨ï¼Œ</span><br><span class="line">     * @param profit å½“å‰æ”¶ç›Š</span><br><span class="line">     */</span><br><span class="line">    private void dfs(int[] prices, int index, int len, int status, int profit) &#123;</span><br><span class="line"></span><br><span class="line">        if (index == len) &#123;</span><br><span class="line">            this.res = Math.max(this.res, profit);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dfs(prices, index 1, len, status, profit);</span><br><span class="line"></span><br><span class="line">        if (status == 0) &#123;</span><br><span class="line">            // å¯ä»¥å°è¯•è½¬å‘ 1</span><br><span class="line">            dfs(prices, index 1, len, 1, profit - prices[index]);</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // æ­¤æ—¶ status == 1ï¼Œå¯ä»¥å°è¯•è½¬å‘ 0</span><br><span class="line">            dfs(prices, index 1, len, 0, profit prices[index]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•äºŒï¼šåŠ¨æ€è§„åˆ’ï¼Œä¸ä¸Šä¸€é¢˜åœ¨çŠ¶æ€è½¬ç§»çš„æ—¶å€™ä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        // ç‰¹æ®Šåˆ¤æ–­</span><br><span class="line">        if (len &lt; 2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        int[][] dp = new int[len][2];</span><br><span class="line"></span><br><span class="line">        // dp[i][0] ä¸‹æ ‡ä¸º i è¿™å¤©ç»“æŸçš„æ—¶å€™ï¼Œä¸æŒè‚¡ï¼Œæ‰‹ä¸Šæ‹¥æœ‰çš„ç°é‡‘æ•°</span><br><span class="line">        // dp[i][1] ä¸‹æ ‡ä¸º i è¿™å¤©ç»“æŸçš„æ—¶å€™ï¼ŒæŒè‚¡ï¼Œæ‰‹ä¸Šæ‹¥æœ‰çš„ç°é‡‘æ•°</span><br><span class="line"></span><br><span class="line">        // åˆå§‹åŒ–ï¼šä¸æŒè‚¡æ˜¾ç„¶ä¸º 0ï¼ŒæŒè‚¡å°±éœ€è¦å‡å»ç¬¬ 1 å¤©ï¼ˆä¸‹æ ‡ä¸º 0ï¼‰çš„è‚¡ä»·</span><br><span class="line">        dp[0][0] = 0;</span><br><span class="line">        dp[0][1] = -prices[0];</span><br><span class="line"></span><br><span class="line">        // ä»ç¬¬ 2 å¤©å¼€å§‹éå†</span><br><span class="line">        for (int i = 1; i &lt; len; i++) &#123;</span><br><span class="line">            dp[i][0] = Math.max(dp[i - 1][0], dp[i - 1][1] prices[i]);</span><br><span class="line">            // è¿™é‡ŒæŒè‚¡ï¼Œå¹¶ä¸æ˜¯è¿™å¤©æŒè‚¡çš„æ”¶ç›Šï¼Œä¸åªä¹°å–ä¸€æ¬¡å°±è¿™é‡Œçš„å·®åˆ«</span><br><span class="line">            dp[i][1] = Math.max(dp[i - 1][1], dp[i - 1][0] - prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len - 1][0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºå½“å‰è¡Œåªå‚è€ƒä¸Šä¸€è¡Œï¼Œæ¯ä¸€è¡Œå°± 2 ä¸ªå€¼ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘ä½¿ç”¨ã€Œæ»šåŠ¨å˜é‡ã€</p>
<p>æ–¹æ³•ä¸‰ï¼šè´ªå¿ƒç®—æ³•</p>
<p>æ±‚è§£æœ€ä¼˜åŒ–é—®é¢˜çš„ç®—æ³•é€šå¸¸éœ€è¦ç»è¿‡ä¸€ç³»åˆ—çš„æ­¥éª¤ï¼Œåœ¨æ¯ä¸ªæ­¥éª¤éƒ½é¢ä¸´ç”Ÿç§é€‰æ‹©ã€‚å¯¹äºè®¸å¤šæœ€ä¼˜åŒ–é—®é¢˜ï¼Œä½¿ç”¨åŠ¨æ€è§„åˆ’ç®—æ³•æ¥æ±‚æœ€ä¼˜è§£æœ‰äº›æ€é¸¡ç”¨ç‰›åŠ›äº†ï¼Œå¯ä»¥ä½¿ç”¨æ›´ç®€å•ã€æ›´é«˜æ•ˆçš„ç®—æ³•ã€‚è´ªå¿ƒç®—æ³•(greedy algorithm)å°±æ˜¯è¿™æ ·çš„ç®—æ³•ï¼Œå®ƒåœ¨æ¯ä¸€æ­¥éƒ½åšå‡ºå½“æ—¶çœ‹èµ·æ¥æœ€ä½³çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ€»æ˜¯åšå‡ºå±€éƒ¨æœ€ä¼˜çš„é€‰æ‹©ï¼Œå¯„å¸Œæœ›è¿™æ ·çš„é€‰æ‹©èƒ½å¯¼è‡´å…¨å±€æœ€ä¼˜è§£ã€‚</p>
<p>è´ªå¿ƒç®—æ³•å’ŒåŠ¨æ€è§„åˆ’ç›¸æ¯”ï¼Œå®ƒæ—¢ä¸çœ‹å‰é¢ï¼ˆä¹Ÿå°±æ˜¯è¯´å®ƒä¸éœ€è¦ä»å‰é¢çš„çŠ¶æ€è½¬ç§»è¿‡æ¥ï¼‰ï¼Œä¹Ÿä¸çœ‹åé¢ï¼ˆæ— åæ•ˆæ€§ï¼Œåé¢çš„é€‰æ‹©ä¸ä¼šå¯¹å‰é¢çš„é€‰æ‹©æœ‰å½±å“ï¼‰ï¼Œå› æ­¤è´ªå¿ƒç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸€èˆ¬æ˜¯çº¿æ€§çš„ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯å¸¸æ•°çº§åˆ«çš„ã€‚</p>
<p>è¿™é“é¢˜ ã€Œè´ªå¿ƒã€ çš„åœ°æ–¹åœ¨äºï¼Œå¯¹äº ã€Œä»Šå¤©çš„è‚¡ä»· - æ˜¨å¤©çš„è‚¡ä»·ã€ï¼Œå¾—åˆ°çš„ç»“æœæœ‰ 3 ç§å¯èƒ½ï¼šâ‘  æ­£æ•°ï¼Œâ‘¡ 0ï¼Œâ‘¢è´Ÿæ•°ã€‚è´ªå¿ƒç®—æ³•çš„å†³ç­–æ˜¯ï¼š åªåŠ æ­£æ•° ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        if (len &lt; 2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 1; i &lt; len; i++) &#123;</span><br><span class="line">            res += Math.max(prices[i] - prices[i - 1], 0);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº3"><a href="#ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº3" class="headerlink" title="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº3"></a>ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº3</h2><p>ä¸ä¸Šé¢ä¸åŒï¼Œè¿™é‡Œåªå…è®¸æœ€å¤šå®Œæˆä¸¤ç¬”äº¤æ˜“ï¼Œå¹¶ä¸”å¿…é¡»åœ¨å†æ¬¡è´­ä¹°å‰å‡ºå”®æ‰ä¹‹å‰çš„è‚¡ç¥¨ã€‚</p>
<p>ç»“åˆä¸Šé¢ä¸¤é“é¢˜ï¼Œç¬¬ä¸€é¢˜æ˜¯äº¤æ˜“ä¸€æ¬¡å°±ä¸äº¤æ˜“ï¼Œç¬¬äºŒé¢˜æ˜¯è¿˜å¯ä»¥äº¤æ˜“ã€‚è¿™é‡Œè®¾å®šä¸‰ç»´æ•°ç»„ï¼Œå¢åŠ ä¸€ç»´è¡¨ç¤ºäº¤æ˜“æ¬¡æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        if (len &lt; 2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // ç¬¬ 2 ç»´çš„ 0 æ²¡æœ‰æ„ä¹‰ï¼Œ1 è¡¨ç¤ºäº¤æ˜“è¿›è¡Œäº† 1 æ¬¡ï¼Œ2 è¡¨ç¤ºäº¤æ˜“è¿›è¡Œäº† 2 æ¬¡</span><br><span class="line">        // ä¸ºäº†ä½¿å¾—ç¬¬ 2 ç»´çš„æ•°å€¼ 1 å’Œ 2 æœ‰æ„ä¹‰ï¼Œè¿™é‡Œå°†ç¬¬ 2 ç»´çš„é•¿åº¦è®¾ç½®ä¸º 3</span><br><span class="line">        int[][][] dp = new int[len][3][2];</span><br><span class="line"></span><br><span class="line">        // ç†è§£å¦‚ä¸‹åˆå§‹åŒ–</span><br><span class="line">        // ç¬¬ 3 ç»´è§„å®šäº†å¿…é¡»æŒè‚¡ï¼Œå› æ­¤æ˜¯ -prices[0]</span><br><span class="line">        dp[0][1][1] = -prices[0];</span><br><span class="line">        // è¿˜æ²¡å‘ç”Ÿçš„äº¤æ˜“ï¼ŒæŒè‚¡çš„æ—¶å€™åº”è¯¥åˆå§‹åŒ–ä¸ºè´Ÿæ— ç©·</span><br><span class="line">        dp[0][2][1] = Integer.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">        for (int i = 1; i &lt; len; i++) &#123;</span><br><span class="line">            // è½¬ç§»é¡ºåºå…ˆæŒè‚¡ï¼Œå†å–å‡º</span><br><span class="line">            dp[i][1][1] = Math.max(dp[i - 1][1][1], -prices[i]) ;</span><br><span class="line">            dp[i][1][0] = Math.max(dp[i - 1][1][0], dp[i - 1][1][1] prices[i]);</span><br><span class="line">            dp[i][2][1] = Math.max(dp[i - 1][2][1], dp[i - 1][1][0] - prices[i]);</span><br><span class="line">            dp[i][2][0] = Math.max(dp[i - 1][2][0], dp[i - 1][2][1] prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return Math.max(dp[len - 1][1][0], dp[len - 1][2][0]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº4"><a href="#ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº4" class="headerlink" title="ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº4"></a>ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº4</h2><p>æœ€å¤šå¯ä»¥å®Œæˆ k ç¬”äº¤æ˜“ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int maxProfit(int k, int[] prices) &#123;</span><br><span class="line">         int len = prices.length;</span><br><span class="line">        if (k &gt;= len / 2) &#123;</span><br><span class="line">            int res = 0;</span><br><span class="line">            for (int i = 1; i &lt; len; i ++) &#123;</span><br><span class="line">                res += Math.max(0, prices[i] - prices[i - 1]);</span><br><span class="line">            &#125;</span><br><span class="line">            return res;</span><br><span class="line">        &#125;</span><br><span class="line">        int[] dpHold = new int[k 1];</span><br><span class="line">        int[] dpNoHold = new int[k 1];</span><br><span class="line">        for (int i = 0; i &lt;= k; i++) &#123;</span><br><span class="line">            dpHold[i] = Integer.MIN_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int price : prices) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= k; j++) &#123;</span><br><span class="line">                // æŒæœ‰ = max(å‰ä¸€å¤©æŒæœ‰ï¼Œå‰ä¸€å¤©ä¸æŒæœ‰ä»Šå¤©æŒæœ‰)</span><br><span class="line">                // æŒæœ‰è¡¨ç¤ºäº¤æ˜“æ¬¡æ•°+1ï¼Œéœ€è¦è€ƒè™‘äº¤æ˜“æ¬¡æ•°-1çš„æƒ…å†µ</span><br><span class="line">                dpHold[j] = Math.max(dpHold[j], dpNoHold[j - 1] - price);</span><br><span class="line">                // ä¸æŒæœ‰ = max(å‰ä¸€å¤©ä¸æŒæœ‰ï¼Œ ä»Šå¤©å–æ‰)</span><br><span class="line">                // ä¸æŒæœ‰ï¼Œå–æ‰ï¼Œäº¤æ˜“æ¬¡æ•°è¿˜æ˜¯åŸæ¥çš„</span><br><span class="line">                dpNoHold[j] = Math.max(dpNoHold[j], dpHold[j] price);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dpNoHold[k];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ä¹°å–è‚¡ç¥¨å«å†·å†»æœŸ"><a href="#ä¹°å–è‚¡ç¥¨å«å†·å†»æœŸ" class="headerlink" title="ä¹°å–è‚¡ç¥¨å«å†·å†»æœŸ"></a>ä¹°å–è‚¡ç¥¨å«å†·å†»æœŸ</h2><p>å–å‡ºè‚¡ç¥¨åï¼Œä½ æ— æ³•åœ¨ç¬¬äºŒå¤©ä¹°å…¥è‚¡ç¥¨ (å³å†·å†»æœŸä¸º 1 å¤©)ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int maxProfit(int[] prices) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        // ä¸€ç»´è¡¨ç¤ºå¤©ï¼ŒäºŒç»´è¡¨ç¤º ä¸æŒæœ‰ã€æŒæœ‰ã€å†·å†»</span><br><span class="line">        int[][] dp = new int[len 1][3];</span><br><span class="line">        for (int i = 0; i &lt;= len; i++) &#123;</span><br><span class="line">            dp[i][1] = Integer.MIN_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i &lt;= len; i++) &#123;</span><br><span class="line">            // ä¸æŒæœ‰ï¼šå‰ä¸€å¤©ä¸æŒæœ‰/å‰ä¸€å¤©æŒæœ‰ä»Šå¤©å–æ‰</span><br><span class="line">            dp[i][0] = Math.max(dp[i-1][0], dp[i-1][1] prices[i-1]);</span><br><span class="line">            // æŒæœ‰ï¼šå‰ä¸€å¤©æŒæœ‰/å‰ä¸€å¤©å†·å†»ä»Šå¤©æŒæœ‰</span><br><span class="line">            dp[i][1] = Math.max(dp[i-1][1], dp[i-1][2] - prices[i-1]);</span><br><span class="line">            // å†·å†»ï¼šå‰ä¸€å¤©ä¸æŒæœ‰/å‰ä¸€å¤©å†·å†»</span><br><span class="line">            dp[i][2] = Math.max(dp[i-1][2], dp[i-1][0]);</span><br><span class="line">            System.out.println(dp[i][0] &quot;==&quot; dp[i][1] &quot;==&quot; dp[i][2]);</span><br><span class="line">        &#125;</span><br><span class="line">        return Math.max(dp[len][0], dp[len][2]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¹°å–è‚¡ç¥¨å«æ‰‹ç»­è´¹"><a href="#ä¹°å–è‚¡ç¥¨å«æ‰‹ç»­è´¹" class="headerlink" title="ä¹°å–è‚¡ç¥¨å«æ‰‹ç»­è´¹"></a>ä¹°å–è‚¡ç¥¨å«æ‰‹ç»­è´¹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public int maxProfit(int[] prices, int fee) &#123;</span><br><span class="line">        int len = prices.length;</span><br><span class="line">        int[][] dp = new int[len+1][2];</span><br><span class="line">        for (int i = 0; i&lt;=len; i++) &#123;</span><br><span class="line">            dp[i][1] = Integer.MIN_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i &lt;= len; i++) &#123;</span><br><span class="line">            // ä¸æŒæœ‰</span><br><span class="line">            dp[i][0] = Math.max(dp[i-1][0], dp[i-1][1] prices[i-1]);</span><br><span class="line">            dp[i][1] = Math.max(dp[i-1][1], dp[i-1][0] - prices[i-1] - fee);</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len][0];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è·³è·ƒæ¸¸æˆ"><a href="#è·³è·ƒæ¸¸æˆ" class="headerlink" title="è·³è·ƒæ¸¸æˆ"></a>è·³è·ƒæ¸¸æˆ</h2><p>ç»™ä½ ä¸€ä¸ªéè´Ÿæ•´æ•°æ•°ç»„ nums ï¼Œä½ æœ€åˆä½äºæ•°ç»„çš„ ç¬¬ä¸€ä¸ªä¸‹æ ‡ ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä»£è¡¨ä½ åœ¨è¯¥ä½ç½®å¯ä»¥è·³è·ƒçš„æœ€å¤§é•¿åº¦ã€‚</p>
<p>åˆ¤æ–­ä½ æ˜¯å¦èƒ½å¤Ÿåˆ°è¾¾æœ€åä¸€ä¸ªä¸‹æ ‡ï¼Œå¦‚æœå¯ä»¥ï¼Œè¿”å› true ï¼›å¦åˆ™ï¼Œè¿”å› false ã€‚</p>
<p>è§£æ³•ï¼šä»å‰å¾€åéå†ï¼Œåœ¨å½“å‰ç‚¹æ—¶ï¼Œå¯ä»¥çŸ¥é“å½“å‰ç‚¹æœ€è¿œå¯ä»¥åˆ°è¾¾å“ªé‡Œï¼Œåœ¨éå†ä¸‹ä¸€ä¸ªçš„æ—¶å€™ï¼Œå¯¹æ¯”èƒ½ä¸èƒ½è¾¾åˆ°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public boolean canJump(int[] nums) &#123;</span><br><span class="line">        int reach = nums[0];</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i++) &#123;</span><br><span class="line">            if (i &gt; reach) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            reach = Math.max(reach, i nums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è·³è·ƒæ¸¸æˆ2"><a href="#è·³è·ƒæ¸¸æˆ2" class="headerlink" title="è·³è·ƒæ¸¸æˆ2"></a>è·³è·ƒæ¸¸æˆ2</h2><p>ç»™ä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºåœ¨è¯¥ä½ç½®ä¸Šçš„æœ€å¤§è·³è·ƒé•¿åº¦ã€‚ç°åœ¨è¦ç»™å‡ºæœ€å°‘è·³è·ƒæ­¥æ•°ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒã€åŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // æ–¹æ³•1ï¼šåŠ¨æ€è§„åˆ’ï¼Œæ­£å‘éå†åˆ°è¾¾æ¯ä¸€ä¸ªä½ç½®éœ€è¦çš„æœ€å°‘æ­¥æ•°ï¼Œæ—¶é—´å¤æ‚åº¦On2</span><br><span class="line">    public static int jump(int[] nums) &#123;</span><br><span class="line">        int[] res = new int[nums.length];</span><br><span class="line">        for (int i = 1; i&lt; res.length; i++) &#123;</span><br><span class="line">            res[i] = Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">            for (int j = i + 1; j &lt;= i nums[i] &amp;&amp; j &lt; nums.length; j++) &#123;</span><br><span class="line">                res[j] = Math.min(res[i] + 1, res[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res[res.length - 1];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // æ–¹æ³•2ï¼šè´ªå¿ƒï¼Œåå‘æŸ¥æ‰¾å‡ºå‘ä½ç½®ï¼Œå…·ä½“å“ªä¸ªä½ç½®è·³æœ€å¥½éœ€è¦ä»å‰å¾€åéå†</span><br><span class="line">    // psï¼šå› ä¸ºä¸æ˜¯å›ºå®šæ­¥æ•°è·³ï¼Œæ‰€ä»¥å¯è¡Œ</span><br><span class="line">    public static int jump(int[] nums) &#123;</span><br><span class="line">        int len = nums.length;</span><br><span class="line">        int pos = len - 1;</span><br><span class="line">        int step = 0;</span><br><span class="line">        while (pos &gt; 0) &#123;</span><br><span class="line">            for (int i = 0; i &lt; len; i++) &#123;</span><br><span class="line">                if (i nums[i] &gt;= pos) &#123;</span><br><span class="line">                    step += 1;</span><br><span class="line">                    pos = i;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return step;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // æ–¹æ³•3ï¼šè´ªå¿ƒåœ°æ­£å‘æŸ¥æ‰¾ï¼Œæ¯æ¬¡å¯åˆ°è¾¾çš„æœ€è¿œä½ç½®</span><br><span class="line">    public static int jump(int[] nums) &#123;</span><br><span class="line">        int len = nums.length;</span><br><span class="line">        int end = 0; //è¾¹ç•Œ</span><br><span class="line">        int maxPos = 0; //èƒ½åˆ°è¾¾çš„æœ€è¿œä½ç½®</span><br><span class="line">        int step = 0;</span><br><span class="line">        // æ³¨æ„ï¼šéå†åˆ°æœ€åå…ƒç´ çš„å‰ä¸€ä¸ªå°±å¥½</span><br><span class="line">        for (int i = 0; i &lt; len - 1; i++) &#123;</span><br><span class="line">            maxPos = Math.max(maxPos, nums[i] i);</span><br><span class="line">            // åˆ°è¾¾è¾¹ç•Œäº†å°±éœ€è¦èµ°ä¸€æ­¥äº†ï¼Œå¹¶ä¸”æ›´æ–°è¾¹ç•Œ</span><br><span class="line">            if (i == end) &#123;</span><br><span class="line">                end = maxPos;</span><br><span class="line">                step ++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return step;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="è·³è·ƒæ¸¸æˆ3"><a href="#è·³è·ƒæ¸¸æˆ3" class="headerlink" title="è·³è·ƒæ¸¸æˆ3"></a>è·³è·ƒæ¸¸æˆ3</h2><p>è¿™é‡Œæœ‰ä¸€ä¸ªéè´Ÿæ•´æ•°æ•°ç»„ arrï¼Œä½ æœ€å¼€å§‹ä½äºè¯¥æ•°ç»„çš„èµ·å§‹ä¸‹æ ‡ start å¤„ã€‚å½“ä½ ä½äºä¸‹æ ‡ i å¤„æ—¶ï¼Œä½ å¯ä»¥è·³åˆ° i arr[i] æˆ–è€… i - arr[i]ã€‚åˆ¤æ–­è‡ªå·±æ˜¯å¦èƒ½å¤Ÿè·³åˆ°å¯¹åº”å…ƒç´ å€¼ä¸º 0 çš„ ä»»ä¸€ ä¸‹æ ‡å¤„ã€‚</p>
<p>æ ‡ç­¾ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // è·³è·ƒæ¸¸æˆ3ï¼šå¯ä»¥å·¦å³è·³è·ƒï¼Œåªèƒ½è·³è·ƒå›ºå®šå€¼ï¼Œä»ç»™å®šå¼€å§‹ä½ç½®ï¼Œèƒ½ä¸èƒ½è·³åˆ°å…ƒç´ å€¼ä¸º0çš„åœ°æ–¹</span><br><span class="line">    // æ·±åº¦ä¼˜å…ˆæœç´¢ï¼šDFSï¼Œå¯ä»¥ç”¨é€’å½’å®ç°ï¼Œä¹Ÿå¯ä»¥ç”¨æ ˆå®ç°</span><br><span class="line">    // æ¯”å¦‚äºŒå‰æ ‘ï¼Œå‘ä¸‹éå†ç›´åˆ°å¶å­èŠ‚ç‚¹ï¼Œç„¶åå‘ä¸Šå›æº¯ï¼Œå†å‘ä¸‹éå†ã€‚ç”¨æ ˆå°±æ˜¯å‡ºæ ˆå’Œå…¥æ ˆã€‚</span><br><span class="line">    public static boolean canReach(int[] nums, int start) &#123;</span><br><span class="line">        // ç”¨ä¸€ä¸ªæ•°ç»„è¡¨ç¤ºæ˜¯å¦è®¿é—®è¿‡</span><br><span class="line">        boolean[] visit = new boolean[nums.length];</span><br><span class="line">        return dfs(nums, start, visit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean dfs(int[] nums, int start, boolean[] visit) &#123;</span><br><span class="line">        if (start &lt; 0 || start &gt;= nums.length) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // å¦‚æœä¹‹å‰è®¿é—®è¿‡ï¼Œä¸€å®šåˆ°ä¸äº†</span><br><span class="line">        if (visit[start]) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // å‡ºé€’å½’æ¡ä»¶</span><br><span class="line">        if (nums[start] == 0) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        visit[start] = true;</span><br><span class="line">        return dfs(nums, start - nums[start], visit) || dfs(nums, start nums[start], visit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nçš‡å"><a href="#Nçš‡å" class="headerlink" title="Nçš‡å"></a>Nçš‡å</h2><p>æŒ‰ç…§å›½é™…è±¡æ£‹çš„è§„åˆ™ï¼Œçš‡åå¯ä»¥æ”»å‡»ä¸ä¹‹å¤„åœ¨åŒä¸€è¡Œæˆ–åŒä¸€åˆ—æˆ–åŒä¸€æ–œçº¿ä¸Šçš„æ£‹å­ã€‚<br>n çš‡åé—®é¢˜ ç ”ç©¶çš„æ˜¯å¦‚ä½•å°† n ä¸ªçš‡åæ”¾ç½®åœ¨ nÃ—n çš„æ£‹ç›˜ä¸Šï¼Œå¹¶ä¸”ä½¿çš‡åå½¼æ­¤ä¹‹é—´ä¸èƒ½ç›¸äº’æ”»å‡»ã€‚<br>ç»™ä½ ä¸€ä¸ªæ•´æ•° n ï¼Œè¿”å›æ‰€æœ‰ä¸åŒçš„ n çš‡åé—®é¢˜ çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>è¿™ä¸ªé¢˜ç›®è¦æ±‚æ‰“å°å‡ºæ¥ã€‚</p>
<p>æ ‡ç­¾ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    public List&lt;List&lt;String&gt;&gt; solveNQueens(int n) &#123;</span><br><span class="line">        List&lt;List&lt;String&gt;&gt; res = new ArrayList();</span><br><span class="line">        int[] place = new int[n];</span><br><span class="line">        List&lt;int[]&gt; resList = new ArrayList();</span><br><span class="line">        int resNum = queueDfs(0, place, n, res);</span><br><span class="line">        for (int[] resPlace : resList) &#123;</span><br><span class="line">            System.out.println(Arrays.toString(resPlace));</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private List&lt;String&gt; print(int[] place) &#123;</span><br><span class="line">        List&lt;String&gt; ss = new ArrayList();</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        for (int j = 0; j &lt; place.length; j++) &#123;</span><br><span class="line">            sb.append(&#x27;.&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        for (int column : place) &#123;</span><br><span class="line">            // è¿™é‡Œä¹Ÿå¾—æ–°å»ºä¸€ä¸ª</span><br><span class="line">            StringBuilder pre = new StringBuilder(sb);</span><br><span class="line">            pre.setCharAt(column, &#x27;Q&#x27;);</span><br><span class="line">            ss.add(pre.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        return ss;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // rowä»£è¡¨ç¬¬rowè¡Œçš‡åçš„æ”¾ç½®</span><br><span class="line">    private int queueDfs(int row, int[] place, int n, List&lt;List&lt;String&gt;&gt; resList) &#123;</span><br><span class="line">        int res = 0;</span><br><span class="line">        if (row == n) &#123;</span><br><span class="line">            // æ³¨æ„è¿™é‡ŒåŠ å…¥çš„æ˜¯æ•°ç»„çš„å¼•ç”¨ï¼Œä¹‹åä¼šå˜</span><br><span class="line">            resList.add(print(place));</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // ç¬¬rowè¡Œå¯ä»¥æ”¾åˆ°ç¬¬0åˆ°n-1åˆ—</span><br><span class="line">        for (int i = 0; i &lt; n; i ++) &#123;</span><br><span class="line">            if (isValid(row, place, i)) &#123;</span><br><span class="line">                place[row] = i;</span><br><span class="line">                res += queueDfs(row 1, place, n, resList);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥ç¬¬rowè¡Œçš‡åæ”¾åœ¨columnåˆ—æœ‰æ²¡æœ‰é—®é¢˜</span><br><span class="line">    private static boolean isValid(int row, int[] place, int column) &#123;</span><br><span class="line">        for (int i = 0; i &lt; row; i++) &#123;</span><br><span class="line">            if (place[i] == column || row - i == Math.abs(column - place[i])) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(row &quot;:&quot; column &quot;:&quot; Arrays.toString(place));</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¿˜æœ‰ä¸€ç§æ„å»ºâ€â€¦Qâ€å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œæ›´ä¼˜é›…ï¼Œç”¨charæ•°ç»„åˆ›å»ºStringï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">char[] row = new char[n];</span><br><span class="line">Arrays.fill(row, &#x27;.&#x27;);</span><br><span class="line">row[queens[i]] = &#x27;Q&#x27;;</span><br><span class="line">board.add(new String(row));</span><br></pre></td></tr></table></figure>

<h2 id="Nçš‡å2"><a href="#Nçš‡å2" class="headerlink" title="Nçš‡å2"></a>Nçš‡å2</h2><p>è¿™ä¸ªNçš‡åä¹‹éœ€è¦ç»™å‡ºæœ‰å‡ ç§è§£ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public static int totalNQueens(int n) &#123;</span><br><span class="line">        // çš‡åé—®é¢˜ï¼Œåœ¨äºDFSï¼Œè¡¨ç°å½¢å¼ï¼šint[] è¡¨ç¤ºæ¯åˆ—ä¸Šçš‡åçš„ä½ç½®</span><br><span class="line">        int[] place = new int[n];</span><br><span class="line">        return queueDfs(0, place, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // columnä»£è¡¨ç¬¬rowåˆ—çš„æ”¾ç½®</span><br><span class="line">    private static int queueDfs(int column, int[] place, int n) &#123;</span><br><span class="line">        int res = 0;</span><br><span class="line">        if (column == n) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // ç¬¬rowåˆ—å¯ä»¥æ”¾åˆ°ç¬¬0åˆ°n-1è¡Œ</span><br><span class="line">        for (int i = 0; i &lt; n; i ++) &#123;</span><br><span class="line">            if (isValid(column, place, i)) &#123;</span><br><span class="line">                place[column] = i;</span><br><span class="line">                res += queueDfs(column 1, place, n);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ£€æŸ¥ç¬¬columnåˆ—çš‡åæ”¾åœ¨rowè¡Œæœ‰æ²¡æœ‰é—®é¢˜</span><br><span class="line">    private static boolean isValid(int column, int[] place, int row) &#123;</span><br><span class="line">        for (int i = 0; i &lt; column; i++) &#123;</span><br><span class="line">            if (place[i] == row || column - i == Math.abs(row - place[i])) &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ‹¬å·ç”Ÿæˆ"><a href="#æ‹¬å·ç”Ÿæˆ" class="headerlink" title="æ‹¬å·ç”Ÿæˆ"></a>æ‹¬å·ç”Ÿæˆ</h2><p>æ•°å­— n ä»£è¡¨ç”Ÿæˆæ‹¬å·çš„å¯¹æ•°ï¼Œè¯·ä½ è®¾è®¡ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºèƒ½å¤Ÿç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„å¹¶ä¸” æœ‰æ•ˆçš„ æ‹¬å·ç»„åˆã€‚<br>è¾“å…¥ï¼šn = 3<br>è¾“å‡ºï¼š[â€œ((()))â€,â€(()())â€,â€(())()â€,â€()(())â€,â€()()()â€]</p>
<p>æ ‡ç­¾ï¼šDFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public class BracketAlgo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        System.out.println(generateBracket(3));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ç»™å‡ºä¸€ä¸ªnï¼Œè¿”å›å¯èƒ½çš„æ‹¬å·ç»„åˆ</span><br><span class="line">    public static List&lt;String&gt; generateBracket(int n) &#123;</span><br><span class="line">        List&lt;String&gt; res = new ArrayList();</span><br><span class="line">        String s = &quot;&quot;;</span><br><span class="line">        dfs(n, n, s, res);</span><br><span class="line">        return  res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å…¥å‚ï¼šå‰©ä½™å·¦æ‹¬å·æ•°ã€å‰©ä½™å³æ‹¬å·æ•°ã€å½“å‰Stringã€ç»“æœ</span><br><span class="line">    private static void dfs(int left, int right, String curStr, List&lt;String&gt; res) &#123;</span><br><span class="line">        // å‡ºé€’å½’æ¡ä»¶</span><br><span class="line">        if (left == 0 &amp;&amp; right == 0) &#123;</span><br><span class="line">            res.add(curStr);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // å·¦æ‹¬å·è¿˜æœ‰å°±å¯ä»¥ç»§ç»­æ”¾å·¦æ‹¬å·ï¼Œå‰©ä½™å³æ‹¬å·å¤§äºå‰©ä½™å·¦æ‹¬å·ï¼Œå°±å¯ä»¥æ”¾å³æ‹¬å·</span><br><span class="line">        // è¿™é‡Œæ²¡æœ‰æ„Ÿè§‰æœ‰å›æº¯å‘¢ï¼Œå°±æ„Ÿè§‰ä¸éœ€è¦å›æº¯</span><br><span class="line">        if (left &gt; 0) &#123;</span><br><span class="line">            dfs(left - 1, right, curStr &quot;(&quot;, res);</span><br><span class="line">        &#125;</span><br><span class="line">        if (right &gt; left) &#123;</span><br><span class="line">            dfs(left, right - 1, curStr &quot;)&quot;, res);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="å²›å±¿é—®é¢˜"><a href="#å²›å±¿é—®é¢˜" class="headerlink" title="å²›å±¿é—®é¢˜"></a>å²›å±¿é—®é¢˜</h2><p>ç»™ä½ ä¸€ä¸ªç”± â€˜1â€™ï¼ˆé™†åœ°ï¼‰å’Œ â€˜0â€™ï¼ˆæ°´ï¼‰ç»„æˆçš„çš„äºŒç»´ç½‘æ ¼ï¼Œè¯·ä½ è®¡ç®—ç½‘æ ¼ä¸­å²›å±¿çš„æ•°é‡ã€‚<br>å²›å±¿æ€»æ˜¯è¢«æ°´åŒ…å›´ï¼Œå¹¶ä¸”æ¯åº§å²›å±¿åªèƒ½ç”±æ°´å¹³æ–¹å‘å’Œ/æˆ–ç«–ç›´æ–¹å‘ä¸Šç›¸é‚»çš„é™†åœ°è¿æ¥å½¢æˆã€‚<br>æ­¤å¤–ï¼Œä½ å¯ä»¥å‡è®¾è¯¥ç½‘æ ¼çš„å››æ¡è¾¹å‡è¢«æ°´åŒ…å›´ã€‚</p>
<p>æ ‡ç­¾ï¼šDFSã€å¹¶æŸ¥é›†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package com.liuxuan.lee;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line"></span><br><span class="line">public class IslandAlgo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        char[][] lands = new char[][]&#123;&#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;1&#x27;&#125;&#125;;</span><br><span class="line">        System.out.println(islandNum(lands));</span><br><span class="line">        lands = new char[][]&#123;&#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;1&#x27;&#125;&#125;;</span><br><span class="line">        System.out.println(islandNum2(lands));</span><br><span class="line">        lands = new char[][]&#123;&#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;1&#x27;&#125;&#125;;</span><br><span class="line">        System.out.println(islandNum3(lands));</span><br><span class="line">        lands = new char[][]&#123;&#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;1&#x27;,&#x27;1&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;&#125;, &#123;&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;0&#x27;,&#x27;1&#x27;&#125;&#125;;</span><br><span class="line">        System.out.println(maxIsland(lands));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 1è¡¨ç¤ºé™†åœ°ï¼Œ0è¡¨ç¤ºæ°´ï¼Œå››å‘¨ä¹Ÿæ˜¯æ°´ï¼Œæ–œçº¿ç›¸æ¥çš„ä¸æ˜¯ä¸€åº§å²›å±¿ï¼Œè¿”å›æ€»å…±æœ‰å‡ ä¸ªå²›å±¿</span><br><span class="line">    // æ–¹æ³•ä¸€ï¼šDFSè§£æ³•ï¼š</span><br><span class="line">    //éå†æ•´ä¸ªäºŒç»´ç½‘æ ¼ï¼Œå½“é‡åˆ°ä¸€ä¸ªå²›å±¿ï¼ˆå€¼ä¸º1ï¼‰æ—¶ï¼Œè®¡æ•°å™¨åŠ 1ï¼Œç„¶åè°ƒç”¨DFSå‡½æ•°ï¼Œå°†ç›¸é‚»çš„å²›å±¿éƒ½æ ‡è®°ä¸ºå·²éå†ï¼ˆå¯ä»¥å°†å…¶å€¼ç½®ä¸º0ï¼‰ã€‚</span><br><span class="line">    //åœ¨DFSå‡½æ•°ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦è¶Šç•Œæˆ–è€…å·²ç»éå†è¿‡ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›ã€‚</span><br><span class="line">    //å¦‚æœå½“å‰ä½ç½®æ˜¯å²›å±¿ï¼Œåˆ™å°†å…¶å€¼ç½®ä¸º0ï¼Œå¹¶é€’å½’è°ƒç”¨DFSå‡½æ•°ï¼Œåˆ†åˆ«å‘ä¸Šã€å‘ä¸‹ã€å‘å·¦ã€å‘å³å››ä¸ªæ–¹å‘è¿›è¡Œæœç´¢ã€‚</span><br><span class="line">    //æœ€åï¼Œè¿”å›è®¡æ•°å™¨çš„å€¼å³ä¸ºå²›å±¿çš„æ•°é‡ã€‚</span><br><span class="line">    public static int islandNum(char[][] lands) &#123;</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 0; i &lt; lands.length; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; lands[0].length; j++) &#123;</span><br><span class="line">                // æœ‰ä¸€å—é™†åœ°å°±è¡¨ç¤ºä¸€å®šæ˜¯ä¸€ä¸ªå²›å±¿ï¼Œåªéœ€è¦æŠŠå‘¨å›´çš„éƒ½å˜æˆæ°´</span><br><span class="line">                // é€’å½’çš„ç›®çš„æ˜¯å°†å‘¨å›´çš„é™†åœ°å˜ä¸ºæ°´ï¼Œå¹¶ä¸”æ˜¯åœ¨éå†ä¸‹ä¸€å—å„¿åœ°ä¹‹å‰</span><br><span class="line">                if (lands[i][j] == &#x27;1&#x27;) &#123;</span><br><span class="line">                    res ++;</span><br><span class="line">                    dfs(i, j, lands);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void dfs(int i, int j, char[][] lands) &#123;</span><br><span class="line">        // è¶Šç•Œåˆ™å‡ºé€’å½’</span><br><span class="line">        if (i &lt; 0 || i &gt;= lands.length || j &lt; 0 || j &gt;= lands[0].length) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // æ˜¯æ°´åˆ™å‡ºé€’å½’</span><br><span class="line">        if (lands[i][j] == &#x27;0&#x27;) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // è¿™é‡Œå°†é™†åœ°å˜ä¸ºæ°´ï¼Œæ‰€ä»¥ä¸‹é¢å³ä½¿é€’å½’å›åˆ°è¯¥ä½ç½®ä¹Ÿç›´æ¥returnäº†</span><br><span class="line">        lands[i][j] = &#x27;0&#x27;;</span><br><span class="line">        dfs(i - 1, j, lands);</span><br><span class="line">        dfs(i + 1, j, lands);</span><br><span class="line">        dfs(i, j - 1, lands);</span><br><span class="line">        dfs(i, j + 1, lands);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶æŸ¥é›†ï¼Œæœ‰ç‚¹é—®é¢˜ï¼šä¸ä¸€å®šéƒ½æ˜¯å¾€å·¦ä¸Šè§’é æ‹¢çš„ï¼Œæ¯”å¦‚å·¥å­—å‹ï¼Œæ‰€ä»¥ä½¿ç”¨å®Œæ•´çš„å¹¶æŸ¥é›†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public static int numIslands(char[][] lands) &#123;</span><br><span class="line">        // 1.é¦–å…ˆåˆå§‹åŒ–ï¼Œç”¨ä¸€ä¸ªæ•°ç»„è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ ¹ç»“ç‚¹</span><br><span class="line">        int n = lands.length;</span><br><span class="line">        int m = lands[0].length;</span><br><span class="line">        int[] roots = new int[n * m];</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 0; i &lt; n; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; m; j++) &#123;</span><br><span class="line">                if (lands[i][j] == &#x27;1&#x27;) &#123;</span><br><span class="line">                    roots[i * m j] = i * m j;</span><br><span class="line">                    res++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 2.åˆå¹¶ï¼Œå¾€å››ä¸ªæ–¹å‘èµ°ï¼Œå¦‚æœä¹Ÿæ˜¯1çš„è¯å°±åˆå¹¶èŠ‚ç‚¹ï¼ˆå°†å½“å‰èŠ‚ç‚¹çš„æ ¹ç»“ç‚¹å˜ä¸ºç›¸é‚»èŠ‚ç‚¹çš„æ ¹ç»“ç‚¹ï¼‰ï¼Œåœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­å°±å®Œæˆè®¡æ•°</span><br><span class="line">        int[][] directs = new int[][]&#123;&#123;-1, 0&#125;, &#123;1, 0&#125;, &#123;0, -1&#125;, &#123;0, 1&#125;&#125;;</span><br><span class="line">        for (int i = 0; i &lt; n; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; m; j ++) &#123;</span><br><span class="line">                if (lands[i][j] == &#x27;1&#x27;) &#123;</span><br><span class="line">                    for (int[] direct : directs) &#123;</span><br><span class="line">                        // å¦‚æœç›¸é‚»ä¹Ÿæ˜¯1ï¼Œä¸”æ ¹ç»“ç‚¹ä¸ç›¸åŒåˆ™è¿›è¡Œåˆå¹¶ï¼šå°†ç›¸é‚»èŠ‚ç‚¹çš„æ ¹èŠ‚ç‚¹å˜ä¸ºå½“å‰èŠ‚ç‚¹çš„æ ¹ç»“ç‚¹ï¼Œè¿™æ ·å‘ä¸‹å‘å³éå†çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå†å˜åŸæ¥çš„æ ¹ç»“ç‚¹äº†</span><br><span class="line">                        // æ­£å¸¸åˆå¹¶éœ€è¦è€ƒè™‘èŠ‚ç‚¹æ·±åº¦ï¼Œå¦‚æœä¸¤ä¸ªé›†åˆçš„æ·±åº¦ä¸åŒï¼Œä¸ºäº†ä¿æŒå¹¶æŸ¥é›†çš„å¹³è¡¡æ€§ï¼Œåº”è¯¥å°†æ·±åº¦è¾ƒå°çš„é›†åˆåˆå¹¶åˆ°æ·±åº¦è¾ƒå¤§çš„é›†åˆä¸Š</span><br><span class="line">                        // ä½†æ˜¯è¿™é‡Œç”±äºéå†çš„æœ‰åºæ€§ï¼Œæ‰€ä»¥å…ˆéå†çš„æ·±åº¦å¤§</span><br><span class="line">                        int newRow = i direct[0];</span><br><span class="line">                        int newColumn = j direct[1];</span><br><span class="line">                        if (newRow &lt; 0 || newRow &gt;= n || newColumn &lt; 0 || newColumn &gt;= m) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        // è¿™é‡Œè¿˜æ˜¯ç”±äºéå†çš„æœ‰åºæ€§ï¼Œæ‰¾rootï¼Œæ ¹ç»“ç‚¹ä¸€å®šæ˜¯å·¦ä¸Šè§’çš„1</span><br><span class="line">                        if (lands[newRow][newColumn] == &#x27;1&#x27; &amp;&amp; roots[i * m j] != roots[newRow * m newColumn]) &#123;</span><br><span class="line">                            roots[newRow * m newColumn] = roots[i * m j];</span><br><span class="line">                            res --;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ²¡é—®é¢˜ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å¹¶æŸ¥é›†-è§„èŒƒå®Œæ•´ç‰ˆ</span><br><span class="line">    public static int numIslands(char[][] lands) &#123;</span><br><span class="line">        // 1.é¦–å…ˆåˆå§‹åŒ–ï¼Œç”¨ä¸€ä¸ªæ•°ç»„è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ ¹ç»“ç‚¹</span><br><span class="line">        int n = lands.length;</span><br><span class="line">        int m = lands[0].length;</span><br><span class="line">        // è®°å½•èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span><br><span class="line">        int[] parents = new int[n * m];</span><br><span class="line">        // è®°å½•èŠ‚ç‚¹æ·±åº¦</span><br><span class="line">        int[] ranks = new int[n * m];</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 0; i &lt; n; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; m; j++) &#123;</span><br><span class="line">                if (lands[i][j] == &#x27;1&#x27;) &#123;</span><br><span class="line">                    parents[i * m j] = i * m j;</span><br><span class="line">                    ranks[i * m j] = 0;</span><br><span class="line">                    res++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // 2.åˆå¹¶ï¼Œå¾€å››ä¸ªæ–¹å‘èµ°ï¼Œå¦‚æœä¹Ÿæ˜¯1çš„è¯å°±åˆå¹¶èŠ‚ç‚¹ï¼ˆå°†å½“å‰èŠ‚ç‚¹çš„æ ¹ç»“ç‚¹å˜ä¸ºç›¸é‚»èŠ‚ç‚¹çš„æ ¹ç»“ç‚¹ï¼‰ï¼Œåœ¨åˆå¹¶çš„è¿‡ç¨‹ä¸­å°±å®Œæˆè®¡æ•°</span><br><span class="line">        int[][] directs = new int[][]&#123;&#123;-1, 0&#125;, &#123;1, 0&#125;, &#123;0, -1&#125;, &#123;0, 1&#125;&#125;;</span><br><span class="line">        for (int i = 0; i &lt; n; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; m; j ++) &#123;</span><br><span class="line">                if (lands[i][j] == &#x27;1&#x27;) &#123;</span><br><span class="line">                    int curRoot = find(parents, i * m j);</span><br><span class="line">                    for (int[] direct : directs) &#123;</span><br><span class="line">                        int newRow = i direct[0];</span><br><span class="line">                        int newColumn = j direct[1];</span><br><span class="line">                        if (newRow &lt; 0 || newRow &gt;= n || newColumn &lt; 0 || newColumn &gt;= m || lands[newRow][newColumn] == &#x27;0&#x27;) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        int newRoot = find(parents, newRow * m newColumn);</span><br><span class="line">                        if (curRoot != newRoot) &#123;</span><br><span class="line">                            System.out.println(&quot;cur:&quot; i &quot;-&quot; j &quot;:&quot; curRoot &quot;===&quot; &quot;new:&quot; newRow &quot;-&quot; newColumn &quot;:&quot; newRoot);</span><br><span class="line">//                            System.out.println(&quot;curRanks:&quot; ranks[i * m j] &quot;===&quot; &quot;newRanks:&quot; ranks[newRow * m newColumn]);</span><br><span class="line">                            // æ·±åº¦å°çš„å¾€æ·±åº¦å¤§çš„åˆå¹¶ï¼Œæé«˜æŸ¥æ‰¾æ ¹ç»“ç‚¹çš„æ•ˆç‡</span><br><span class="line">                            // å°†rankè¾ƒå°çš„æ ¹èŠ‚ç‚¹æŒ‡å‘rankè¾ƒå¤§çš„æ ¹èŠ‚ç‚¹ï¼Œä»¥ä¿æŒæ ‘çš„å¹³è¡¡ã€‚å¦‚æœä¸¤ä¸ªæ ¹èŠ‚ç‚¹çš„rankç›¸åŒï¼Œåˆ™å¯ä»¥å°†å…¶ä¸­ä¸€ä¸ªæ ¹èŠ‚ç‚¹ä½œä¸ºå¦ä¸€ä¸ªæ ¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œå¹¶å°†rankå¢åŠ 1ã€‚</span><br><span class="line">                            if (ranks[i * m j] &lt; ranks[newRow * m newColumn]) &#123;</span><br><span class="line">                                // å½“å‰èŠ‚ç‚¹æ·±åº¦å°ï¼šå°†æ·±åº¦è¾ƒå°çš„æ ¹èŠ‚ç‚¹åˆå¹¶åˆ°æ·±åº¦è¾ƒå¤§çš„æ ¹èŠ‚ç‚¹ä¸Š</span><br><span class="line">                                parents[curRoot] = newRoot;</span><br><span class="line">                            &#125; else if (ranks[i * m j] &gt; ranks[newRow * m newColumn])&#123;</span><br><span class="line">                                parents[newRoot] = curRoot;</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                parents[newRoot] = curRoot;</span><br><span class="line">                                ranks[i * m j] ++;</span><br><span class="line">                            &#125;</span><br><span class="line">                            res --;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int find(int[] parents, int k) &#123;</span><br><span class="line">        // æ ¹ç»“ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯è‡ªå·±</span><br><span class="line">        if (parents[k] == k) &#123;</span><br><span class="line">            return k;</span><br><span class="line">        &#125;</span><br><span class="line">        return find(parents, parents[k]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å²›å±¿çš„æœ€å¤§é¢ç§¯"><a href="#å²›å±¿çš„æœ€å¤§é¢ç§¯" class="headerlink" title="å²›å±¿çš„æœ€å¤§é¢ç§¯"></a>å²›å±¿çš„æœ€å¤§é¢ç§¯</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // å²›å±¿çš„æœ€å¤§é¢ç§¯</span><br><span class="line">    // psï¼šå°†areaä½œä¸ºå‚æ•°ä¼ é€’æ—¶ï¼Œintä¸è¡Œã€Integerä¹Ÿä¸è¡Œã€è¿”å›å‡ºå»éœ€è¦åœ¨è¿ç»­å››ä¸ªdfsä¸ŠåŠ ä¸Šè¿”å›å†ä¼ å…¥ä¸‹ä¸€ä¸ª</span><br><span class="line">    // ç”¨ä¸€ä¸ªå…¨å±€å˜é‡è¡¨ç¤ºareaæ¯”è¾ƒå¥½</span><br><span class="line">    public static int maxAreaOfIsland(int[][] lands) &#123;</span><br><span class="line">        // å’Œè·å–æ•°é‡ä¸€æ ·ï¼Œé€’å½’ï¼Œä½†æ˜¯åŒæ—¶è®°å½•å²›å±¿æœ€å¤§é¢ç§¯</span><br><span class="line">        int maxArea = 0;</span><br><span class="line">        for (int i = 0; i &lt; lands.length; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; lands[0].length; j++) &#123;</span><br><span class="line">                if (lands[i][j] == 1) &#123;</span><br><span class="line">                    int area = dfs(lands, i , j, 0);</span><br><span class="line">                    maxArea = Math.max(area, maxArea);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return maxArea;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int dfs(int[][] lands, int i, int j, int area) &#123;</span><br><span class="line">        if (i &lt; 0 || j &lt; 0 || i &gt;= lands.length || j &gt;= lands[0].length) &#123;</span><br><span class="line">            return area;</span><br><span class="line">        &#125;</span><br><span class="line">        if (lands[i][j] == 0) &#123;</span><br><span class="line">            return area;</span><br><span class="line">        &#125;</span><br><span class="line">        lands[i][j] = 0;</span><br><span class="line">        area += 1;</span><br><span class="line">        area = dfs(lands, i - 1, j, area);</span><br><span class="line">        area = dfs(lands, i + 1, j, area);</span><br><span class="line">        area = dfs(lands, i, j - 1, area);</span><br><span class="line">        area = dfs(lands, i, j + 1, area);</span><br><span class="line">        return area;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æˆ³æ°”çƒ"><a href="#æˆ³æ°”çƒ" class="headerlink" title="æˆ³æ°”çƒ"></a>æˆ³æ°”çƒ</h2><p>æœ‰ n ä¸ªæ°”çƒï¼Œç¼–å·ä¸º0 åˆ° n - 1ï¼Œæ¯ä¸ªæ°”çƒä¸Šéƒ½æ ‡æœ‰ä¸€ä¸ªæ•°å­—ï¼Œè¿™äº›æ•°å­—å­˜åœ¨æ•°ç»„ nums ä¸­ã€‚</p>
<p>ç°åœ¨è¦æ±‚ä½ æˆ³ç ´æ‰€æœ‰çš„æ°”çƒã€‚æˆ³ç ´ç¬¬ i ä¸ªæ°”çƒï¼Œä½ å¯ä»¥è·å¾— nums[i - 1] * nums[i] * nums[i + 1] æšç¡¬å¸ã€‚ è¿™é‡Œçš„ i - 1 å’Œ i + 1 ä»£è¡¨å’Œ i ç›¸é‚»çš„ä¸¤ä¸ªæ°”çƒçš„åºå·ã€‚å¦‚æœ i - 1æˆ– i + 1 è¶…å‡ºäº†æ•°ç»„çš„è¾¹ç•Œï¼Œé‚£ä¹ˆå°±å½“å®ƒæ˜¯ä¸€ä¸ªæ•°å­—ä¸º 1 çš„æ°”çƒã€‚</p>
<p>æ±‚æ‰€èƒ½è·å¾—ç¡¬å¸çš„æœ€å¤§æ•°é‡ã€‚</p>
<p>è¾“å…¥ï¼šnums = [1,5]<br>è¾“å‡ºï¼š10</p>
<p>æ ‡ç­¾ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢ã€åŠ¨æ€è§„åˆ’</p>
<p>è¶…å‡ºæ—¶é—´é™åˆ¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // æˆ³æ°”çƒï¼šä¸€ç»„æ•°ä»£è¡¨æ°”çƒçš„å€¼ï¼Œæˆ³ä¸€ä¸ªæ°”çƒæ”¶ç›Šæ˜¯å·¦æ°”çƒ*è‡ªå·±*å³æ°”çƒï¼Œæˆ³ç ´åå·¦å³ä¸¤ä¸ªå˜ä¸ºç›¸é‚»çš„ï¼Œæ±‚æœ€å¤§æ”¶ç›Š</span><br><span class="line">    // æ–¹æ³•ä¸€ï¼šæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œåˆ°æœ€åä¸€ä¸ªæ°”çƒæ—¶è®°å½•æ”¶ç›Šè®°å½•ä¸‹æ¥ï¼Œæœ€åå¯¹æ¯”æœ€å¤§å€¼</span><br><span class="line">    public static int maxCoins(int[] nums) &#123;</span><br><span class="line">        // æ³¨æ„ï¼šListæ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„é›†åˆï¼Œéœ€è¦ç”¨Integer</span><br><span class="line">        List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int num : nums) &#123;</span><br><span class="line">            list.add(num);</span><br><span class="line">        &#125;</span><br><span class="line">        return dfs(list);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int dfs(List&lt;Integer&gt; list) &#123;</span><br><span class="line">        if (list.size() == 0) return 0;</span><br><span class="line">        // åœ¨å“ªé‡Œå–æœ€å¤§å€¼ï¼šåœ¨è¿™é‡Œå–ï¼Œå› ä¸ºè¿™é‡Œå°±æ˜¯æœ€ç»ˆçš„æœ€å¤§å€¼</span><br><span class="line">        int max = 0;</span><br><span class="line">        int left, cur, right;</span><br><span class="line">        for (int i = 0; i &lt; list.size(); i++) &#123;</span><br><span class="line">            left = i == 0 ? 1 : list.get(i - 1);</span><br><span class="line">            right = i == list.size() - 1 ? 1 : list.get(i + 1);</span><br><span class="line">            cur = list.get(i);</span><br><span class="line">            // è¿™é‡Œä¼šæŠ¥warningï¼šå†å¾ªç¯ä¸­ä¿®æ”¹Listï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶Listï¼Œæ¯æ¬¡ä¼ å…¥ä¸´æ—¶List</span><br><span class="line">            list.remove(i);</span><br><span class="line">            max = Math.max(left * cur * right dfs(list), max);</span><br><span class="line">            list.add(i, cur);</span><br><span class="line">        &#125;</span><br><span class="line">        return max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªä¸å¯¹çš„DFSï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// æ–¹æ³•äºŒï¼šå¦ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œä¸Šä¸€ä¸ªæ˜¯å…ˆæˆ³ç ´å†é€’å½’è®¡ç®—å‰©ä¸‹çš„ï¼Œè¿™é‡Œå¯ä»¥å…ˆæ‹†å¼€è®¡ç®—å·¦å³çš„å†åŠ èµ·æ¥</span><br><span class="line">    // è¿™æ ·çš„å¥½å¤„æ˜¯ï¼šListæ²¡æœ‰è¢«ç ´åï¼Œåªéœ€ç»™ä¸ªè¾¹ç•Œ</span><br><span class="line">    // !!! è¿™ä¸ªæ–¹æ³•ä¸å¯¹ï¼Œå¿½ç•¥äº†æ°”çƒæˆ³ç ´åä¸¤è¾¹æ°”çƒå°±å˜æˆç›¸é‚»æ°”çƒçš„äº‹å®</span><br><span class="line">    private static int maxProfit2(int[] nums) &#123;</span><br><span class="line">        List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int num : nums) &#123;</span><br><span class="line">            list.add(num);</span><br><span class="line">        &#125;</span><br><span class="line">        return dfs2(list, 0, nums.length - 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int dfs2(List&lt;Integer&gt; list, int left, int right) &#123;</span><br><span class="line">        if (left == right) return 0;</span><br><span class="line">        int max = 0;</span><br><span class="line">        int l, r, cur;</span><br><span class="line">        for (int i = left; i &lt;= right; i++) &#123;</span><br><span class="line">            l = i == 0 ? 1 : list.get(i - 1);</span><br><span class="line">            r = i == list.size() - 1 ? 1 : list.get(i + 1);</span><br><span class="line">            cur = list.get(i);</span><br><span class="line">            int profit = l * cur * r dfs2(list, left, i - 1) dfs2(list, i + 1, right);</span><br><span class="line">            max = Math.max(max, profit);</span><br><span class="line">        &#125;</span><br><span class="line">        return max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ­£ç¡®çš„åŠ¨æ€è§„åˆ’ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // æ–¹æ³•ä¸‰ï¼šåŠ¨æ€è§„åˆ’</span><br><span class="line">    // 1.å®šä¹‰æ•°æ® 2.åˆå§‹åŒ– 3.çŠ¶æ€è½¬ç§»</span><br><span class="line">    // ä¸¤è¾¹å„åŠ ä¸€ä¸ªè¾…åŠ©æ°”çƒï¼Œæ˜¯1ï¼Œç”¨kè¡¨ç¤ºæœ€åæˆ³ç ´çš„æ°”çƒ</span><br><span class="line">    // dp[i][j]è¡¨ç¤ºæˆ³ç ´i-jåŒºé—´å†…æ°”çƒè·å¾—çš„æ”¶ç›Šï¼Œä¸¤è¾¹æ˜¯åŒ…å«è¾…åŠ©æ°”çƒçš„ï¼Œè¾…åŠ©æ°”çƒä¸æˆ³ç ´</span><br><span class="line">    // å› æ­¤ï¼šçŠ¶æ€è½¬ç§»ï¼šdp[i][j] = Math.max(dp[i][j], dp[i][k] dp[k][j] list[k] * list[i] * [j])</span><br><span class="line">    // æ³¨æ„ï¼škæ˜¯æœ€åæˆ³ç ´çš„ï¼Œæ‰€ä»¥ä¹˜ä»¥æœ€ä¸¤è¾¹çš„è¾…åŠ©æ°”çƒ</span><br><span class="line">    // è¾…åŠ©æ°”çƒä¸æˆ³ç ´ï¼Œæ‰€ä»¥è¿™æ ·æ‹†åˆ†ä¹‹åkæ˜¯è¾…åŠ©æ°”çƒï¼Œä¸ºä¸¤è¾¹ç®—æ”¶ç›Šç”¨ï¼Œä½†æœ¬èº«ä¸è¢«æˆ³ç ´</span><br><span class="line">    // Maxçš„è¿‡ç¨‹æ˜¯åœ¨é€‰æœ€åæˆ³ç ´å“ªä¸ªæ°”çƒçš„è¿‡ç¨‹ä¸­é€‰æ‹©çš„</span><br><span class="line">    // å› ä¸ºè¯¥çŠ¶æ€æ–¹ç¨‹ï¼Œæ‰€ä»¥é•¿åº¦çŸ­çš„åº”è¯¥å…ˆç®—å¥½ï¼Œæ‰€ä»¥æœ€å¤–å±‚å¾ªç¯ä¸ºé•¿åº¦</span><br><span class="line">    public static int maxCoins(int[] nums) &#123;</span><br><span class="line">        // å®šä¹‰æ•°æ®</span><br><span class="line">        int len =nums.length 2;</span><br><span class="line">        int[][] dp = new int[len][len];</span><br><span class="line">        int[] arr = new int[len];</span><br><span class="line">        arr[0] = 1;</span><br><span class="line">        arr[len - 1] = 1;</span><br><span class="line">        System.arraycopy(nums, 0, arr, 1, len - 2);</span><br><span class="line">        // åˆå§‹åŒ–ï¼Œå› ä¸ºåœ¨çŠ¶æ€è½¬ç§»è¿‡ç¨‹ä¸­ä¼šå–å€¼ï¼Œæ‰€ä»¥ä¸º0å°±å¥½</span><br><span class="line">        // ä¸€å±‚å¾ªç¯ä¸ºé•¿åº¦ï¼Œæœ€å°é•¿åº¦ä¸º3ï¼Œä¸¤è¾¹æ˜¯è¾…åŠ©æ°”çƒ</span><br><span class="line">        for (int l = 3; l &lt;= len; l ++) &#123;</span><br><span class="line">            // äºŒå±‚å¾ªç¯ä¸ºå¼€å§‹ä½ç½®</span><br><span class="line">            for (int i = 0; i &lt;= len - l; i ++) &#123;</span><br><span class="line">                // ç»“æŸä½ç½®</span><br><span class="line">                int j = i l - 1;</span><br><span class="line">                // æœ€åæˆ³ç ´æ°”çƒçš„ä½ç½®k</span><br><span class="line">                for (int k = i + 1; k &lt; j; k ++) &#123;</span><br><span class="line">                    dp[i][j] = Math.max(dp[i][j], arr[i] * arr[k] * arr[j] dp[i][k] dp[k][j]);</span><br><span class="line">                    // ä¸ºä»€ä¹ˆä¸èƒ½æ­£å‘å…ˆæˆ³ç ´kï¼Ÿ</span><br><span class="line">                    // å› ä¸ºæˆ³ç ´ä¹‹åkå°±ä¸å­˜åœ¨äº†ï¼Œæ‰€ä»¥ä¸èƒ½åœ¨ç®—ä¸¤è¾¹æ—¶åŠ kè€Œæ˜¯åŠ kå·¦å³ä¸¤è¾¹çš„ï¼Œæ˜¯ä¸€ä¸ªkæ–­å¼€çš„çŠ¶æ€</span><br><span class="line">                    // æœ€åæˆ³ç ´kå°±å¯ä»¥ç”¨kç®—ä¸¤è¾¹ï¼Œå› ä¸ºç®—å®Œä¸¤è¾¹æœ€åæ‰æˆ³ç ´k</span><br><span class="line">//                    dp[i][j] = Math.max(dp[i][j], arr[k] * arr[k - 1] * arr[k 1] dp[i][k] dp[k][j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[0][len - 1];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="çœä»½æ•°é‡"><a href="#çœä»½æ•°é‡" class="headerlink" title="çœä»½æ•°é‡"></a>çœä»½æ•°é‡</h2><p>æœ‰ n ä¸ªåŸå¸‚ï¼Œå…¶ä¸­ä¸€äº›å½¼æ­¤ç›¸è¿ï¼Œå¦ä¸€äº›æ²¡æœ‰ç›¸è¿ã€‚å¦‚æœåŸå¸‚ a ä¸åŸå¸‚ b ç›´æ¥ç›¸è¿ï¼Œä¸”åŸå¸‚ b ä¸åŸå¸‚ c ç›´æ¥ç›¸è¿ï¼Œé‚£ä¹ˆåŸå¸‚ a ä¸åŸå¸‚ c é—´æ¥ç›¸è¿ã€‚</p>
<p>çœä»½ æ˜¯ä¸€ç»„ç›´æ¥æˆ–é—´æ¥ç›¸è¿çš„åŸå¸‚ï¼Œç»„å†…ä¸å«å…¶ä»–æ²¡æœ‰ç›¸è¿çš„åŸå¸‚ã€‚</p>
<p>ç»™ä½ ä¸€ä¸ª n x n çš„çŸ©é˜µ isConnected ï¼Œå…¶ä¸­ isConnected[i][j] = 1 è¡¨ç¤ºç¬¬ i ä¸ªåŸå¸‚å’Œç¬¬ j ä¸ªåŸå¸‚ç›´æ¥ç›¸è¿ï¼Œè€Œ isConnected[i][j] = 0 è¡¨ç¤ºäºŒè€…ä¸ç›´æ¥ç›¸è¿ã€‚</p>
<p>è¿”å›çŸ©é˜µä¸­ çœä»½ çš„æ•°é‡ã€‚</p>
<p>æ ‡ç­¾ï¼šå¹¶æŸ¥é›†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    private static int num;</span><br><span class="line">    </span><br><span class="line">    // çœä»½æ•°é‡</span><br><span class="line">    // è¾“å…¥n*nï¼Œnums[i][j]è¡¨ç¤ºiå’Œjç›¸è¿</span><br><span class="line">    // è¿”å›æœ‰å¤šå°‘ä¸ç›¸è¿çš„åŸå¸‚ç¾¤</span><br><span class="line">    public static int findCircleNum(int[][] nums) &#123;</span><br><span class="line">        // 1.åˆå§‹åŒ–</span><br><span class="line">        int len = nums.length;</span><br><span class="line">        int[] parents = new int[len];</span><br><span class="line">        int[] ranks = new int[len];</span><br><span class="line">        num = len;</span><br><span class="line">        for (int i = 0; i &lt; len; i++) &#123;</span><br><span class="line">            parents[i] = i;</span><br><span class="line">            ranks[i] = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        // 2.åˆå¹¶</span><br><span class="line">        for (int i = 0; i &lt; len; i++) &#123;</span><br><span class="line">            for (int j = i + 1; j &lt; len; j++) &#123;</span><br><span class="line">                if (nums[i][j] == 0) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                union(parents, ranks, i, j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void union(int[] parents, int[] ranks, int i, int j) &#123;</span><br><span class="line">        int iRoot = find(parents, i);</span><br><span class="line">        int jRoot = find(parents, j);</span><br><span class="line">        if (iRoot == jRoot) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (ranks[i] &gt; ranks[j]) &#123;</span><br><span class="line">            parents[jRoot] = iRoot;</span><br><span class="line">        &#125; else if (ranks[i] &lt; ranks[j]) &#123;</span><br><span class="line">            parents[iRoot] = jRoot;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            parents[iRoot] = jRoot;</span><br><span class="line">            ranks[j] ++;</span><br><span class="line">        &#125;</span><br><span class="line">        num --;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int find(int[] parents, int k) &#123;</span><br><span class="line">        if (parents[k] == k) &#123;</span><br><span class="line">            return k;</span><br><span class="line">        &#125;</span><br><span class="line">        return find(parents, parents[k]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»Ÿè®¡æ— å‘å›¾ä¸­æ— æ³•äº’ç›¸åˆ°è¾¾ç‚¹æ•°é‡"><a href="#ç»Ÿè®¡æ— å‘å›¾ä¸­æ— æ³•äº’ç›¸åˆ°è¾¾ç‚¹æ•°é‡" class="headerlink" title="ç»Ÿè®¡æ— å‘å›¾ä¸­æ— æ³•äº’ç›¸åˆ°è¾¾ç‚¹æ•°é‡"></a>ç»Ÿè®¡æ— å‘å›¾ä¸­æ— æ³•äº’ç›¸åˆ°è¾¾ç‚¹æ•°é‡</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•° n ï¼Œè¡¨ç¤ºä¸€å¼  æ— å‘å›¾ ä¸­æœ‰ n ä¸ªèŠ‚ç‚¹ï¼Œç¼–å·ä¸º 0 åˆ° n - 1 ã€‚åŒæ—¶ç»™ä½ ä¸€ä¸ªäºŒç»´æ•´æ•°æ•°ç»„ edges ï¼Œå…¶ä¸­ edges[i] = [ai, bi] è¡¨ç¤ºèŠ‚ç‚¹ ai å’Œ bi ä¹‹é—´æœ‰ä¸€æ¡ æ— å‘ è¾¹ã€‚</p>
<p>è¯·ä½ è¿”å› æ— æ³•äº’ç›¸åˆ°è¾¾ çš„ä¸åŒ ç‚¹å¯¹æ•°ç›® ã€‚</p>
<p>æ ‡ç­¾ï¼šå¹¶æŸ¥é›†ã€DFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // ç»Ÿè®¡æ— å‘å›¾ä¸­æ— æ³•äº’ç›¸åˆ°è¾¾çš„ç‚¹å¯¹æ•°</span><br><span class="line">    // è¾“å…¥ï¼šæ€»å…±å¤šå°‘ä¸ªç‚¹ã€ç‚¹ä¸ç‚¹é—´æ— å‘è¾¹</span><br><span class="line">    // è¾“å‡ºï¼šæ€»å…±å¤šå°‘ä¸è¿æ¥çš„ç‚¹ç»„åˆ</span><br><span class="line">    // è¶…å‡ºæ—¶é—´é™åˆ¶ï¼šå› ä¸ºè·å–ç»“æœåŒå±‚å¾ªç¯ï¼Œå¯ä»¥ç®€åŒ–</span><br><span class="line">    public static long countPairs(int n, int[][] edges) &#123;</span><br><span class="line">        // 1.åˆå§‹åŒ–</span><br><span class="line">        int[] parents = new int[n];</span><br><span class="line">        // è¿™é‡Œä¸ç”¨ranksè¡¨ç¤ºæ·±åº¦ï¼Œè€Œæ˜¯ç”¨sizesè¡¨ç¤ºä»¥xä¸ºæ ¹ç»“ç‚¹æ‰€åœ¨æ ‘çš„é¡¶ç‚¹æ•°</span><br><span class="line">        int[] sizes = new int[n];</span><br><span class="line">        for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">            parents[i] = i;</span><br><span class="line">            sizes[i] = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // 2.åˆå¹¶</span><br><span class="line">        for (int[] edge : edges) &#123;</span><br><span class="line">            union(parents, sizes, edge[0], edge[1]);</span><br><span class="line">        &#125;</span><br><span class="line">        // 3.è·å–ç»“æœ</span><br><span class="line">        long res = 0;</span><br><span class="line">        for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">            res += n - sizes[find(parents, i)];</span><br><span class="line">        &#125;</span><br><span class="line">        // æ³¨æ„ï¼šä¸Šé¢æ˜¯æ¯ä¸ªèŠ‚ç‚¹ä¸å‡ ä¸ªèŠ‚ç‚¹ä¸ç›¸è¿ï¼Œç®—ä¸¤éäº†</span><br><span class="line">        return res / 2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void union(int[] parents, int[] sizes, int i, int j) &#123;</span><br><span class="line">        int iRoot = find(parents, i);</span><br><span class="line">        int jRoot = find(parents, j);</span><br><span class="line">        if (iRoot == jRoot) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (sizes[i] &gt; sizes[j]) &#123;</span><br><span class="line">            // jåº”è¯¥å¾€iåˆå¹¶ï¼Œjçš„èŠ‚ç‚¹æ•°ç»™åˆ°i</span><br><span class="line">            parents[jRoot] = iRoot;</span><br><span class="line">            sizes[iRoot] += sizes[jRoot];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // iåº”è¯¥å¾€jåˆå¹¶ï¼Œiçš„èŠ‚ç‚¹æ•°ç»™åˆ°j</span><br><span class="line">            parents[iRoot] = jRoot;</span><br><span class="line">            sizes[jRoot] += sizes[iRoot];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int find(int[] parents, int k) &#123;</span><br><span class="line">        if (parents[k] == k) &#123;</span><br><span class="line">            return k;</span><br><span class="line">        &#125;</span><br><span class="line">        return find(parents, parents[k]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DFS:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public static int countPairs(int n, int[][] edges) &#123;</span><br><span class="line">        List&lt;List&lt;Integer&gt;&gt; graph = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">            graph.add(new ArrayList&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        // æ„å»ºå›¾çš„é‚»æ¥è¡¨ï¼Œå­˜å‚¨ç›´æ¥è¿æ¥çš„èŠ‚ç‚¹</span><br><span class="line">        for (int[] edge : edges) &#123;</span><br><span class="line">            graph.get(edge[0]).add(edge[1]);</span><br><span class="line">            graph.get(edge[1]).add(edge[0]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        boolean[] visited = new boolean[n];</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">            if (!visited[i]) &#123;</span><br><span class="line">                int count = dfs(graph, i, visited);</span><br><span class="line">                // ç»“æœè¦ä¸è¿é€šçš„èŠ‚ç‚¹å¯¹æ•°ï¼Œå¯¹äºè¯¥ç°‡ï¼Œcountä¸ªç‚¹ç›¸äº’è”é€šï¼Œè¿™æ ·ç®—ä¼šç®—ä¸¤æ¬¡</span><br><span class="line">                res += count * (n - count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res / 2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // é€šè¿‡DFSå¾—åˆ°è¯¥èŠ‚ç‚¹è”é€šçš„èŠ‚ç‚¹æ•°ï¼ˆä¸€ä¸ªç°‡çš„èŠ‚ç‚¹æ•°ï¼‰</span><br><span class="line">    private static int dfs(List&lt;List&lt;Integer&gt;&gt; graph, int node, boolean[] visited) &#123;</span><br><span class="line">        visited[node] = true;</span><br><span class="line">        int count = 1;</span><br><span class="line">        for (int neighbor : graph.get(node)) &#123;</span><br><span class="line">            if (!visited[neighbor]) &#123;</span><br><span class="line">                count += dfs(graph, neighbor, visited);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return count;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å²›å±¿çš„å‘¨é•¿"><a href="#å²›å±¿çš„å‘¨é•¿" class="headerlink" title="å²›å±¿çš„å‘¨é•¿"></a>å²›å±¿çš„å‘¨é•¿</h2><p>æ ‡ç­¾ï¼šDFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // å²›å±¿çš„å‘¨é•¿ï¼šåªæœ‰ä¸€ä¸ªå²›å±¿ï¼Œå¹¶ä¸”å²›å±¿å†…éƒ¨æ²¡æœ‰æ¹–</span><br><span class="line">    // ä½¿ç”¨DFSçš„æ–¹æ³•ï¼Œforå¾ªç¯éå†åˆ°ç¬¬ä¸€ä¸ªé™†åœ°ï¼Œç„¶åå¼€å§‹DFSï¼Œå°†landså…ƒç´ ç½®ä¸º2è¡¨ç¤ºéå†è¿‡äº†</span><br><span class="line">    public static int islandPerimeter(int[][] lands) &#123;</span><br><span class="line">        for (int i = 0; i &lt; lands.length; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; lands[0].length; j ++) &#123;</span><br><span class="line">                if (lands[i][j] == 1) &#123;</span><br><span class="line">                    return lengthDfs(lands, i, j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static int lengthDfs(int[][] lands, int i, int j) &#123;</span><br><span class="line">        // è¾¹ç•Œæˆ–é‡åˆ°æ°´å‘¨é•¿+1</span><br><span class="line">        if (i &lt; 0 || i &gt;= lands.length || j &lt; 0 || j &gt;= lands[0].length || lands[i][j] == 0) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;</span><br><span class="line">        if (lands[i][j] == 2) &#123;</span><br><span class="line">           return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        lands[i][j] = 2;</span><br><span class="line">        return lengthDfs(lands, i-1, j) lengthDfs(lands, i+1, j) lengthDfs(lands, i, j-1) lengthDfs(lands, i, j+1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è¡£æ©±æ•´ç†-æœºå™¨äººçš„è¿åŠ¨èŒƒå›´"><a href="#è¡£æ©±æ•´ç†-æœºå™¨äººçš„è¿åŠ¨èŒƒå›´" class="headerlink" title="è¡£æ©±æ•´ç†/æœºå™¨äººçš„è¿åŠ¨èŒƒå›´"></a>è¡£æ©±æ•´ç†/æœºå™¨äººçš„è¿åŠ¨èŒƒå›´</h2><p>å®¶å±…æ•´ç†å¸ˆå°†å¾…æ•´ç†è¡£æ©±åˆ’åˆ†ä¸º m x n çš„äºŒç»´çŸ©é˜µ gridï¼Œå…¶ä¸­ grid[i][j] ä»£è¡¨ä¸€ä¸ªéœ€è¦æ•´ç†çš„æ ¼å­ã€‚æ•´ç†å¸ˆè‡ª grid[0][0] å¼€å§‹ é€è¡Œé€åˆ— åœ°æ•´ç†æ¯ä¸ªæ ¼å­ã€‚</p>
<p>æ•´ç†è§„åˆ™ä¸ºï¼šåœ¨æ•´ç†è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€‰æ‹© å‘å³ç§»åŠ¨ä¸€æ ¼ æˆ– å‘ä¸‹ç§»åŠ¨ä¸€æ ¼ï¼Œä½†ä¸èƒ½ç§»åŠ¨åˆ°è¡£æŸœä¹‹å¤–ã€‚åŒæ—¶ï¼Œä¸éœ€è¦æ•´ç† digit(i) digit(j) &gt; cnt çš„æ ¼å­ï¼Œå…¶ä¸­ digit(x) è¡¨ç¤ºæ•°å­— x çš„å„æ•°ä½ä¹‹å’Œã€‚</p>
<p>è¯·è¿”å›æ•´ç†å¸ˆ æ€»å…±éœ€è¦æ•´ç†å¤šå°‘ä¸ªæ ¼å­ã€‚</p>
<p>è¾“å…¥ï¼šm = 4, n = 7, cnt = 5<br>è¾“å‡ºï¼š18</p>
<p>æ ‡ç­¾ï¼šDFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // æœºå™¨äººçš„è¿åŠ¨èŒƒå›´</span><br><span class="line">    // è¾“å…¥ï¼šmè¡Œã€nåˆ—çš„æ ¼å­ï¼Œæœºå™¨äººä»[0][0]å¼€å§‹ç§»åŠ¨ï¼Œæ¯æ¬¡åªèƒ½ç§»åŠ¨ä¸€æ ¼ï¼Œä½†æ˜¯ä¸èƒ½åˆ°æ ¼å­æ•°ä½ä¹‹å’Œä¸ºkçš„æ ¼å­ã€‚</span><br><span class="line">    // è¿”å›ï¼šèƒ½åˆ°å‡ ä¸ªæ ¼å­</span><br><span class="line">    public static int wardrobeFinishing(int m, int n, int k) &#123;</span><br><span class="line">        int[][] lands = new int[m][n];</span><br><span class="line">        dfs(lands, 0 , 0, k);</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 0; i &lt; m; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; n; j++) &#123;</span><br><span class="line">                if (lands[i][j] == 1) res ++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ä¸èƒ½ç›´æ¥è¿”å›ï¼Ÿå› ä¸ºåˆæ¬¡åˆ°è¾¾çš„åº”è¯¥è¿”å›1ï¼Œä½†æ˜¯è¿˜å¾—å¾€ä¸‹éå†ä¸èƒ½return</span><br><span class="line">    private static void dfs(int[][] lands, int i, int j, int k) &#123;</span><br><span class="line">        if (i &lt; 0 || i &gt;= lands.length || j &lt; 0 || j &gt;= lands[0].length || lands[i][j] == 1) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!checkValid(i, j, k)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // å¯ä»¥åˆ°è¾¾ç½®ä¸º1</span><br><span class="line">        lands[i][j] = 1;</span><br><span class="line">        dfs(lands, i+1, j, k);</span><br><span class="line">        dfs(lands, i-1, j, k);</span><br><span class="line">        dfs(lands, i, j-1, k);</span><br><span class="line">        dfs(lands, i, j+1, k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean checkValid(int i, int j, int k) &#123;</span><br><span class="line">        int sum = 0;</span><br><span class="line">        while (i &gt; 0) &#123;</span><br><span class="line">            sum += i % 10;</span><br><span class="line">            i = i / 10;</span><br><span class="line">        &#125;</span><br><span class="line">        while (j &gt; 0) &#123;</span><br><span class="line">            sum += j % 10;</span><br><span class="line">            j = j / 10;</span><br><span class="line">        &#125;</span><br><span class="line">        return sum &lt;= k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å•è¯æœç´¢"><a href="#å•è¯æœç´¢" class="headerlink" title="å•è¯æœç´¢"></a>å•è¯æœç´¢</h2><p>ç»™å®šä¸€ä¸ª m x n äºŒç»´å­—ç¬¦ç½‘æ ¼ board å’Œä¸€ä¸ªå­—ç¬¦ä¸²å•è¯ word ã€‚å¦‚æœ word å­˜åœ¨äºç½‘æ ¼ä¸­ï¼Œè¿”å› true ï¼›å¦åˆ™ï¼Œè¿”å› false ã€‚</p>
<p>å•è¯å¿…é¡»æŒ‰ç…§å­—æ¯é¡ºåºï¼Œé€šè¿‡ç›¸é‚»çš„å•å…ƒæ ¼å†…çš„å­—æ¯æ„æˆï¼Œå…¶ä¸­â€œç›¸é‚»â€å•å…ƒæ ¼æ˜¯é‚£äº›æ°´å¹³ç›¸é‚»æˆ–å‚ç›´ç›¸é‚»çš„å•å…ƒæ ¼ã€‚åŒä¸€ä¸ªå•å…ƒæ ¼å†…çš„å­—æ¯ä¸å…è®¸è¢«é‡å¤ä½¿ç”¨ã€‚</p>
<p>æ ‡ç­¾ï¼šDFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // å•è¯æœç´¢</span><br><span class="line">    // è¾“å…¥ï¼šä¸€ä¸ªå­—ç¬¦çŸ©é˜µï¼Œä¸€ä¸ªå•è¯</span><br><span class="line">    // è¾“å‡ºï¼šæ°´å¹³ä¸¤è¿å’Œå‚ç›´ç›¸è¿ï¼Œå¯ä»¥æ‹å¼¯ï¼Œèƒ½å¦æ‰¾åˆ°è¿™ä¸ªå•è¯</span><br><span class="line">    // è§£æ³•ï¼šDFSï¼Œdfsèµ·ç‚¹ï¼šæ¯ä¸ªç‚¹ï¼›dfséœ€è¦æºå¸¦çš„ï¼šåŒ¹é…ä¸Šçš„å­—ç¬¦é•¿åº¦ï¼›dfså‡ºå£ï¼šå­—ç¬¦ä¸ä¸€æ ·/å­—ç¬¦é•¿åº¦è¾¾åˆ°</span><br><span class="line">    // å·²ç»ç”¨è¿‡çš„å­—æ¯ä¸èƒ½å†ç”¨ï¼šå‘ä¸‹ä¸€ä¸ªé€’å½’ä¹‹å‰å˜ä¸ºå…¶ä»–å­—ç¬¦ï¼Œé€’å½’å®Œä¹‹åå†å˜å›æ¥</span><br><span class="line">    public static boolean exist(char[][] words, String s) &#123;</span><br><span class="line">        for (int i = 0; i &lt; words.length; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; words[0].length; j ++) &#123;</span><br><span class="line">                if (dfs(words, i, j, 0, s)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean dfs(char[][] words, int i, int j, int k, String s) &#123;</span><br><span class="line">        if (s.length() == k) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        if (i &lt; 0 || i &gt;= words.length || j &lt; 0 || j &gt;= words[0].length || words[i][j] != s.charAt(k)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        k ++;</span><br><span class="line">        char pre = words[i][j];</span><br><span class="line">        words[i][j] = &#x27; &#x27;;</span><br><span class="line">        boolean one = dfs(words, i + 1, j, k, s);</span><br><span class="line">        boolean two = dfs(words, i - 1, j, k, s);</span><br><span class="line">        boolean three = dfs(words, i, j + 1, k, s);</span><br><span class="line">        boolean four = dfs(words, i, j - 1, k, s);</span><br><span class="line">        words[i][j] = pre;</span><br><span class="line">        return one || two || three || four;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è…çƒ‚çš„æ©˜å­"><a href="#è…çƒ‚çš„æ©˜å­" class="headerlink" title="è…çƒ‚çš„æ©˜å­"></a>è…çƒ‚çš„æ©˜å­</h2><p>åœ¨ç»™å®šçš„ m x n ç½‘æ ¼ grid ä¸­ï¼Œæ¯ä¸ªå•å…ƒæ ¼å¯ä»¥æœ‰ä»¥ä¸‹ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼š</p>
<p>å€¼ 0 ä»£è¡¨ç©ºå•å…ƒæ ¼ï¼›<br>å€¼ 1 ä»£è¡¨æ–°é²œæ©˜å­ï¼›<br>å€¼ 2 ä»£è¡¨è…çƒ‚çš„æ©˜å­ã€‚<br>æ¯åˆ†é’Ÿï¼Œè…çƒ‚çš„æ©˜å­ å‘¨å›´ 4 ä¸ªæ–¹å‘ä¸Šç›¸é‚» çš„æ–°é²œæ©˜å­éƒ½ä¼šè…çƒ‚ã€‚</p>
<p>è¿”å› ç›´åˆ°å•å…ƒæ ¼ä¸­æ²¡æœ‰æ–°é²œæ©˜å­ä¸ºæ­¢æ‰€å¿…é¡»ç»è¿‡çš„æœ€å°åˆ†é’Ÿæ•°ã€‚å¦‚æœä¸å¯èƒ½ï¼Œè¿”å› -1 ã€‚</p>
<p>æ ‡ç­¾ï¼šBFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // è…çƒ‚çš„æ©˜å­</span><br><span class="line">    // è¾“å…¥ï¼š0ç©º 1æ–°é²œ 2è…çƒ‚ï¼Œæ¯ä¸€åˆ†é’Ÿè…çƒ‚æ©˜å­å‘å››å‘¨æ‰©æ•£</span><br><span class="line">    // è¾“å‡ºï¼šå‡ åˆ†é’Ÿå¯ä»¥å…¨éƒ¨è…çƒ‚</span><br><span class="line">    // å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼šä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—Queueæˆ–è€…åŒå‘é˜Ÿåˆ—Dequeï¼Œå…ˆå°†ç¬¬ä¸€å±‚èŠ‚ç‚¹æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œç„¶åwhileå¾ªç¯ä¸­pollå‡ºæ¥ï¼Œæ¯pollä¸€ä¸ªå°±æŠŠå®ƒçš„ä¸‹ä¸€å±‚èŠ‚ç‚¹offerè¿›å»</span><br><span class="line">    public static int orangesRotting(int[][] oranges) &#123;</span><br><span class="line">        // 1.å°†ç¬¬ä¸€å±‚çƒ‚æ©˜å­åŠ å…¥é˜Ÿåˆ—ï¼Œç»Ÿè®¡å¥½æ©˜å­ä¸ªæ•°</span><br><span class="line">        Queue&lt;int[]&gt; queue = new LinkedList&lt;&gt;();</span><br><span class="line">        int freshNum = 0;</span><br><span class="line">        for (int i = 0; i &lt; oranges.length; i++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; oranges[0].length; j++) &#123;</span><br><span class="line">                if (oranges[i][j] == 2) &#123;</span><br><span class="line">                    queue.offer(new int[]&#123;i, j&#125;);</span><br><span class="line">                &#125; else if (oranges[i][j] == 1) &#123;</span><br><span class="line">                    freshNum ++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        int[][] directs = new int[][]&#123;&#123;-1, 0&#125;, &#123;1, 0&#125;, &#123;0, 1&#125;, &#123;0, -1&#125;&#125;;</span><br><span class="line">        int res = 0;</span><br><span class="line">        // 2.ä¸€å±‚ä¸€å±‚BFS</span><br><span class="line">        // éœ€è¦å¢åŠ freshNum &gt; 0ï¼Œä¸ç„¶æœ€åä¸€å±‚ä¹‹åè¿˜ä¼šéå†ä¸€ä¸‹</span><br><span class="line">        while (!queue.isEmpty() &amp;&amp; freshNum &gt; 0) &#123;</span><br><span class="line">            res ++;</span><br><span class="line">            int size = queue.size();</span><br><span class="line">            for (int i = 0; i &lt; size; i ++) &#123;</span><br><span class="line">                int[] cur = queue.poll();</span><br><span class="line">                int row = cur[0];</span><br><span class="line">                int column = cur[1];</span><br><span class="line">                for (int[] direct : directs) &#123;</span><br><span class="line">                    int newRow = row direct[0];</span><br><span class="line">                    int newColumn = column direct[1];</span><br><span class="line">                    if (newRow &gt;= 0 &amp;&amp; newRow &lt; oranges.length &amp;&amp; newColumn &gt;= 0 &amp;&amp; newColumn &lt; oranges[0].length &amp;&amp; oranges[newRow][newColumn] == 1) &#123;</span><br><span class="line">                        queue.offer(new int[]&#123;newRow, newColumn&#125;);</span><br><span class="line">                        freshNum --;</span><br><span class="line">                        oranges[newRow][newColumn] = 2;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return freshNum == 0 ? res : -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€å°åŸºå› å˜åŒ–"><a href="#æœ€å°åŸºå› å˜åŒ–" class="headerlink" title="æœ€å°åŸºå› å˜åŒ–"></a>æœ€å°åŸºå› å˜åŒ–</h2><p>åŸºå› åºåˆ—å¯ä»¥è¡¨ç¤ºä¸ºä¸€æ¡ç”± 8 ä¸ªå­—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­æ¯ä¸ªå­—ç¬¦éƒ½æ˜¯ â€˜Aâ€™ã€â€™Câ€™ã€â€™Gâ€™ å’Œ â€˜Tâ€™ ä¹‹ä¸€ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒæŸ¥ä»åŸºå› åºåˆ— start å˜ä¸º end æ‰€å‘ç”Ÿçš„åŸºå› å˜åŒ–ã€‚ä¸€æ¬¡åŸºå› å˜åŒ–å°±æ„å‘³ç€è¿™ä¸ªåŸºå› åºåˆ—ä¸­çš„ä¸€ä¸ªå­—ç¬¦å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p>å¦æœ‰ä¸€ä¸ªåŸºå› åº“ bank è®°å½•äº†æ‰€æœ‰æœ‰æ•ˆçš„åŸºå› å˜åŒ–ï¼Œåªæœ‰åŸºå› åº“ä¸­çš„åŸºå› æ‰æ˜¯æœ‰æ•ˆçš„åŸºå› åºåˆ—ã€‚ï¼ˆå˜åŒ–åçš„åŸºå› å¿…é¡»ä½äºåŸºå› åº“ bank ä¸­ï¼‰</p>
<p>ç»™ä½ ä¸¤ä¸ªåŸºå› åºåˆ— start å’Œ end ï¼Œä»¥åŠä¸€ä¸ªåŸºå› åº“ bank ï¼Œè¯·ä½ æ‰¾å‡ºå¹¶è¿”å›èƒ½å¤Ÿä½¿ start å˜åŒ–ä¸º end æ‰€éœ€çš„æœ€å°‘å˜åŒ–æ¬¡æ•°ã€‚å¦‚æœæ— æ³•å®Œæˆæ­¤åŸºå› å˜åŒ–ï¼Œè¿”å› -1 ã€‚</p>
<p>æ³¨æ„ï¼šèµ·å§‹åŸºå› åºåˆ— start é»˜è®¤æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯å®ƒå¹¶ä¸ä¸€å®šä¼šå‡ºç°åœ¨åŸºå› åº“ä¸­ã€‚</p>
<p>æ ‡ç­¾ï¼šBFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // æœ€å°åŸºå› å˜åŒ–</span><br><span class="line">    // å…«ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å­—ç¬¦åªèƒ½æ˜¯ACGTï¼Œæ¯æ¬¡åŸºå› å˜åŒ–åªèƒ½æ”¹å˜ä¸€ä¸ªå­—ç¬¦ï¼Œå¹¶ä¸”å¿…é¡»å¾—æ˜¯åŸºå› åº“é‡Œçš„</span><br><span class="line">    // é—®æœ€å°‘éœ€è¦å‡ æ¬¡åŸºå› å˜åŒ–ï¼Œæœ‰çš„å­—ç¬¦ä¸èƒ½ç›´æ¥å˜è¿‡å»ï¼Œéœ€è¦banké‡Œçš„ä¸­è½¬ä¸€ä¸‹ 123-145ï¼Œ123-163-165-145</span><br><span class="line">    // æœ€å°‘éœ€è¦å‡ æ¬¡è¿™ç§é—®é¢˜ï¼Œå°±æ˜¯å‡ å±‚ï¼Œè‡ªç„¶æ˜¯å¹¿åº¦ä¼˜å…ˆéå†</span><br><span class="line">    // æ·±åº¦ä¼˜å…ˆéå†è¡Œä¸è¡Œï¼Ÿæˆ‘è®¤ä¸ºä¹Ÿè¡Œï¼Œç±»ä¼¼ä¸å•è¯æœç´¢ï¼Œä½†æ˜¯éœ€è¦éå†å®Œæ‰€æœ‰ç¬¦åˆè¦æ±‚çš„endï¼Œç„¶åæ±‚æœ€å°‘æ¬¡æ•°ï¼Œæ—¶é—´å¤æ‚åº¦é«˜äº†</span><br><span class="line">    public int minMutation(String startGene, String endGene, String[] bank) &#123;</span><br><span class="line">        // 1.å°†ç¬¬ä¸€ä¸ªæ”¾å…¥é˜Ÿåˆ—</span><br><span class="line">        char[] chars = new char[]&#123;&#x27;A&#x27;, &#x27;C&#x27;, &#x27;G&#x27;, &#x27;T&#x27;&#125;;</span><br><span class="line">        Queue&lt;String&gt; queue = new LinkedList&lt;&gt;();</span><br><span class="line">        queue.offer(startGene);</span><br><span class="line">        int res = 0;</span><br><span class="line">        // å¦‚æœå°†charæ•°ç»„ï¼ˆchar[]ï¼‰ä½œä¸ºHashSetæˆ–HashMapçš„é”®ï¼ˆkeyï¼‰ï¼Œé‚£ä¹ˆåªæœ‰å½“ä¸¤ä¸ªcharæ•°ç»„æ˜¯ç›¸åŒçš„å¯¹è±¡å¼•ç”¨æ—¶ï¼Œæ‰ä¼šè¢«è§†ä¸ºç›¸åŒçš„é”®ã€‚ä¸¤ä¸ªå…·æœ‰ç›¸åŒå…ƒç´ çš„charæ•°ç»„ï¼Œå³ä½¿å®ƒä»¬çš„å…ƒç´ å†…å®¹ç›¸åŒï¼Œä½†æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œä»ç„¶è¢«è§†ä¸ºä¸åŒçš„é”®ã€‚</span><br><span class="line">        // è¿™é‡Œæ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨String</span><br><span class="line">        Set&lt;String&gt; bankSet = new HashSet&lt;&gt;(Arrays.asList(bank));</span><br><span class="line">        // ä»¥åŠéå†è¿‡çš„ä¸èƒ½å†éå†ï¼ŒSetè®°å½•</span><br><span class="line">        Set&lt;String&gt; visitedSet = new HashSet&lt;&gt;();</span><br><span class="line">        visitedSet.add(startGene);</span><br><span class="line">        // 2.å¼€å§‹whileå¹¿åº¦éå†</span><br><span class="line">        while(!queue.isEmpty()) &#123;</span><br><span class="line">            int size = queue.size();</span><br><span class="line">            for (int i = 0; i &lt; size; i ++) &#123;</span><br><span class="line">                String gene = queue.poll();</span><br><span class="line">                if (gene.equals(endGene)) &#123;</span><br><span class="line">                    return res;</span><br><span class="line">                &#125;</span><br><span class="line">                // éå†ä¸‹å±‚èŠ‚ç‚¹</span><br><span class="line">                char[] geneChars = gene.toCharArray();</span><br><span class="line">                for (int index = 0; index &lt; geneChars.length; index ++) &#123;</span><br><span class="line">                    char originChar = geneChars[index];</span><br><span class="line">                    for (char c : chars) &#123;</span><br><span class="line">                        if (c == originChar) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        geneChars[index] = c;</span><br><span class="line">                        String pre = new String(geneChars);</span><br><span class="line">                        //æ‹·è´char[] : System.arraycopy(gene, 0, pre, 0, gene.length);</span><br><span class="line">                        if (bankSet.contains(pre) &amp;&amp; !visitedSet.contains(pre)) &#123;</span><br><span class="line">                            queue.offer(pre);</span><br><span class="line">                            visitedSet.add(pre);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    geneChars[index] = originChar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // éå†ä¸€å±‚</span><br><span class="line">            res ++;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å•è¯æ¥é¾™"><a href="#å•è¯æ¥é¾™" class="headerlink" title="å•è¯æ¥é¾™"></a>å•è¯æ¥é¾™</h2><p>å­—å…¸ wordList ä¸­ä»å•è¯ beginWord å’Œ endWord çš„ è½¬æ¢åºåˆ— æ˜¯ä¸€ä¸ªæŒ‰ä¸‹è¿°è§„æ ¼å½¢æˆçš„åºåˆ— beginWord -&gt; s1 -&gt; s2 -&gt; â€¦ -&gt; skï¼š</p>
<p>æ¯ä¸€å¯¹ç›¸é‚»çš„å•è¯åªå·®ä¸€ä¸ªå­—æ¯ã€‚<br> å¯¹äº 1 &lt;= i &lt;= k æ—¶ï¼Œæ¯ä¸ª si éƒ½åœ¨ wordList ä¸­ã€‚æ³¨æ„ï¼Œ beginWord ä¸éœ€è¦åœ¨ wordList ä¸­ã€‚<br>sk == endWord<br>ç»™ä½ ä¸¤ä¸ªå•è¯ beginWord å’Œ endWord å’Œä¸€ä¸ªå­—å…¸ wordList ï¼Œè¿”å› ä» beginWord åˆ° endWord çš„ æœ€çŸ­è½¬æ¢åºåˆ— ä¸­çš„ å•è¯æ•°ç›® ã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„è½¬æ¢åºåˆ—ï¼Œè¿”å› 0 ã€‚</p>
<p>æ ‡ç­¾ï¼šBFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // å•è¯æ¥é¾™</span><br><span class="line">    // wordListæ˜¯ä»startWordåˆ°endWordçš„è½¬æ¢åºåˆ—ï¼Œæ¯æ¬¡åªèƒ½å˜ä¸€ä¸ªå­—æ¯ï¼ŒendWordéœ€è¦åœ¨è½¬æ¢åºåˆ—é‡Œ</span><br><span class="line">    // è¿”å›ï¼šæœ€çŸ­è½¬æ¢åºåˆ—ä¸­çš„å•è¯æ•°ç›®</span><br><span class="line">    // æ€ä¹ˆä»wordListä¸­è·å–å¯ä»¥å˜çš„wordï¼Ÿ</span><br><span class="line">    public int ladderLength(String beginWord, String endWord, List&lt;String&gt; wordList) &#123;</span><br><span class="line">        if (!wordList.contains(endWord)) return 0;</span><br><span class="line">        // 1.å®šä¹‰é˜Ÿåˆ—ï¼Œæ”¾å…¥ç¬¬ä¸€ä¸ª</span><br><span class="line">        Queue&lt;String&gt; queue = new LinkedList&lt;&gt;();</span><br><span class="line">        queue.offer(beginWord);</span><br><span class="line">        Set&lt;String&gt; visited = new HashSet&lt;&gt;();</span><br><span class="line">        visited.add(beginWord);</span><br><span class="line">        int res = 1;</span><br><span class="line">        // 2.éå†é˜Ÿåˆ—</span><br><span class="line">        while (!queue.isEmpty()) &#123;</span><br><span class="line">            int size = queue.size();</span><br><span class="line">            for (int i = 0; i &lt; size; i ++) &#123;</span><br><span class="line">                String word = queue.poll();</span><br><span class="line">                if (word.equals(endWord)) return res;</span><br><span class="line">                for (String other : wordList) &#123;</span><br><span class="line">                    if (!visited.contains(other) &amp;&amp; checkWord(word, other)) &#123;</span><br><span class="line">                        queue.offer(other);</span><br><span class="line">                        visited.add(other);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res ++;</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean checkWord(String s1, String s2) &#123;</span><br><span class="line">        if (s1.length() != s2. length()) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        int diffNum = 0;</span><br><span class="line">        for (int i = 0; i &lt; s1.length(); i ++) &#123;</span><br><span class="line">            if (s1.charAt(i) != s2.charAt(i)) diffNum ++;</span><br><span class="line">            if (diffNum &gt; 1) return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è·³è·ƒæ¸¸æˆ4"><a href="#è·³è·ƒæ¸¸æˆ4" class="headerlink" title="è·³è·ƒæ¸¸æˆ4"></a>è·³è·ƒæ¸¸æˆ4</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ arr ï¼Œä½ ä¸€å¼€å§‹åœ¨æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¤„ï¼ˆä¸‹æ ‡ä¸º 0ï¼‰ã€‚</p>
<p>æ¯ä¸€æ­¥ï¼Œä½ å¯ä»¥ä»ä¸‹æ ‡ i è·³åˆ°ä¸‹æ ‡ i + 1 ã€i - 1 æˆ–è€… j ï¼š</p>
<p>i + 1 éœ€æ»¡è¶³ï¼ši + 1 &lt; arr.length<br>i - 1 éœ€æ»¡è¶³ï¼ši - 1 &gt;= 0<br>j éœ€æ»¡è¶³ï¼šarr[i] == arr[j] ä¸” i != j<br>è¯·ä½ è¿”å›åˆ°è¾¾æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡å¤„æ‰€éœ€çš„ æœ€å°‘æ“ä½œæ¬¡æ•° ã€‚</p>
<p>æ³¨æ„ï¼šä»»ä½•æ—¶å€™ä½ éƒ½ä¸èƒ½è·³åˆ°æ•°ç»„å¤–é¢ã€‚</p>
<p>æ ‡ç­¾ï¼šBFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // è·³è·ƒæ¸¸æˆ4</span><br><span class="line">    // ä»index=0å¼€å§‹ï¼Œæ¯æ¬¡èƒ½å‰åè·³ä¸€æ­¥ï¼Œæˆ–è€…è·³åˆ°arr[i] == arr[j]çš„ä½ç½®</span><br><span class="line">    // è¿”å›åˆ°è¾¾æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡å¤„æ‰€éœ€çš„æœ€å°‘æ“ä½œæ¬¡æ•°</span><br><span class="line">    public int minJumps(int[] arr) &#123;</span><br><span class="line">        // 1.åˆå§‹åŒ–ï¼Œç¬¬ä¸€ä¸ªç‚¹åŠ å…¥é˜Ÿåˆ—</span><br><span class="line">        Queue&lt;Integer&gt; queue = new LinkedList&lt;&gt;();</span><br><span class="line">        queue.offer(0);</span><br><span class="line">        Set&lt;Integer&gt; visited = new HashSet&lt;&gt;();</span><br><span class="line">        visited.add(0);</span><br><span class="line">        int res = 0;</span><br><span class="line">        // 2.whileå¾ªç¯</span><br><span class="line">        while (!queue.isEmpty()) &#123;</span><br><span class="line">            int size = queue.size();</span><br><span class="line">            for (int i = 0; i &lt; size; i ++) &#123;</span><br><span class="line">                Integer index = queue.poll();</span><br><span class="line">                if (index == arr.length - 1) return res;</span><br><span class="line">                for (int j = 0; j &lt; arr.length; j ++) &#123;</span><br><span class="line">                    if (visited.contains(j)) continue;</span><br><span class="line">                    if (arr[j] == arr[index] || j == index - 1 || j == index 1) &#123;</span><br><span class="line">                        queue.offer(j);</span><br><span class="line">                        visited.add(j);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            res ++;</span><br><span class="line">        &#125;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»„åˆæ€»å’Œ1ï¼ˆå…ƒç´ æ— é‡å¤å¯é‡é€‰ï¼‰"><a href="#ç»„åˆæ€»å’Œ1ï¼ˆå…ƒç´ æ— é‡å¤å¯é‡é€‰ï¼‰" class="headerlink" title="ç»„åˆæ€»å’Œ1ï¼ˆå…ƒç´ æ— é‡å¤å¯é‡é€‰ï¼‰"></a>ç»„åˆæ€»å’Œ1ï¼ˆå…ƒç´ æ— é‡å¤å¯é‡é€‰ï¼‰</h2><p>ç»™ä½ ä¸€ä¸ª æ— é‡å¤å…ƒç´  çš„æ•´æ•°æ•°ç»„ candidates å’Œä¸€ä¸ªç›®æ ‡æ•´æ•° target ï¼Œæ‰¾å‡º candidates ä¸­å¯ä»¥ä½¿æ•°å­—å’Œä¸ºç›®æ ‡æ•° target çš„ æ‰€æœ‰ ä¸åŒç»„åˆ ï¼Œå¹¶ä»¥åˆ—è¡¨å½¢å¼è¿”å›ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›è¿™äº›ç»„åˆã€‚</p>
<p>candidates ä¸­çš„ åŒä¸€ä¸ª æ•°å­—å¯ä»¥ æ— é™åˆ¶é‡å¤è¢«é€‰å– ã€‚å¦‚æœè‡³å°‘ä¸€ä¸ªæ•°å­—çš„è¢«é€‰æ•°é‡ä¸åŒï¼Œåˆ™ä¸¤ç§ç»„åˆæ˜¯ä¸åŒçš„ã€‚ </p>
<p>æ ‡ç­¾ï¼šDFSå›æº¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; res;</span><br><span class="line">    </span><br><span class="line">    // ç»„åˆæ€»å’Œ</span><br><span class="line">    // è¾“å…¥ï¼šæ— é‡å¤å…ƒç´ çš„æ•´æ•°æ•°ç»„ã€ç›®æ ‡æ•´æ•°</span><br><span class="line">    // è¾“å‡ºï¼šæ‰€æœ‰ç»„åˆï¼Œæ•°ç»„ä¸­çš„æ•°å¯é‡å¤ä½¿ç”¨</span><br><span class="line">    // å¸¸è§„DFSå›æº¯</span><br><span class="line">    // æ³¨æ„ï¼š1.æ¯æ¬¡add numsæ—¶ï¼Œéœ€è¦addå‰¯æœ¬ï¼›2.éœ€è¦ä¼ startç´¢å¼•ï¼Œå› ä¸ºæ‰¾åˆ°åé¢çš„å°±ä¸éœ€è¦å†å¾€å‰æ‰¾äº†ã€‚</span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; combinationSum(int[] candidates, int target) &#123;</span><br><span class="line">        // 1.åˆå§‹åŒ–ï¼Œæ’ä¸ªåºï¼ˆå®é™…ä¸Šè¿™ä¸ªä¾‹å­ä¸­ä¸éœ€è¦æ’åºï¼‰</span><br><span class="line">        // Arrays.sort(candidates);</span><br><span class="line">        res = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs(candidates, target, 0, new ArrayList&lt;&gt;(), 0);</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void dfs(int[] candidates, int target, int sum, List&lt;Integer&gt; nums, int start) &#123;</span><br><span class="line">        if (sum &gt; target) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (sum == target) &#123;</span><br><span class="line">            res.add(new ArrayList&lt;&gt;(nums)); // éœ€è¦æ·»åŠ numsçš„å‰¯æœ¬</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = start; i &lt; candidates.length; i++) &#123;</span><br><span class="line">            nums.add(candidates[i]);</span><br><span class="line">            dfs(candidates, target, sum candidates[i], nums, i); // ä¼ é€’å½“å‰ç´¢å¼•iä½œä¸ºä¸‹ä¸€æ¬¡é€’å½’çš„start</span><br><span class="line">            nums.remove(nums.size() - 1); // å›æº¯ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»„åˆæ€»å’Œ2ï¼ˆå…ƒç´ é‡å¤ä¸å¯é‡é€‰ï¼‰"><a href="#ç»„åˆæ€»å’Œ2ï¼ˆå…ƒç´ é‡å¤ä¸å¯é‡é€‰ï¼‰" class="headerlink" title="ç»„åˆæ€»å’Œ2ï¼ˆå…ƒç´ é‡å¤ä¸å¯é‡é€‰ï¼‰"></a>ç»„åˆæ€»å’Œ2ï¼ˆå…ƒç´ é‡å¤ä¸å¯é‡é€‰ï¼‰</h2><p>ç»™å®šä¸€ä¸ªå€™é€‰äººç¼–å·çš„é›†åˆ candidates å’Œä¸€ä¸ªç›®æ ‡æ•° target ï¼Œæ‰¾å‡º candidates ä¸­æ‰€æœ‰å¯ä»¥ä½¿æ•°å­—å’Œä¸º target çš„ç»„åˆã€‚</p>
<p>candidates ä¸­çš„æ¯ä¸ªæ•°å­—åœ¨æ¯ä¸ªç»„åˆä¸­åªèƒ½ä½¿ç”¨ ä¸€æ¬¡ ã€‚</p>
<p>æ³¨æ„ï¼šè§£é›†ä¸èƒ½åŒ…å«é‡å¤çš„ç»„åˆã€‚ </p>
<p>æ ‡ç­¾ï¼šDFSå›æº¯ å‰ªæ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; res2;</span><br><span class="line">    // ç»„åˆæ€»å’Œ2</span><br><span class="line">    // è¾“å…¥ï¼šå¯é‡å¤å…ƒç´ çš„æ•´æ•°æ•°ç»„ã€ç›®æ ‡æ•´æ•°</span><br><span class="line">    // è¾“å‡ºï¼šæ‰€æœ‰ç»„åˆï¼Œæ•°ç»„ä¸­çš„æ•°ä¸å¯é‡å¤ä½¿ç”¨</span><br><span class="line">    // å¸¸è§„DFSå›æº¯</span><br><span class="line">    // æ³¨æ„ï¼š1.æ¯æ¬¡add numsæ—¶ï¼Œéœ€è¦addå‰¯æœ¬ï¼›2.éœ€è¦ä¼ startç´¢å¼•ï¼Œå› ä¸ºæ‰¾åˆ°åé¢çš„å°±ä¸éœ€è¦å†å¾€å‰æ‰¾äº†ã€‚</span><br><span class="line">    // è¿”å›çš„ç»“æœé‡Œä¸èƒ½åŒ…å«é‡å¤çš„ç»„åˆï¼Œå…ƒç´ å€¼é‡å¤ï¼Œä½†æ˜¯å…ƒç´ ä¸èƒ½é‡å¤ä½¿ç”¨ï¼Œä¸€æ ·å€¼çš„ä¸åŒå…ƒç´ å¯ä»¥ç”¨</span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; combinationSum2(int[] candidates, int target) &#123;</span><br><span class="line">        // 1.åˆå§‹åŒ–ï¼Œæ’åºä¹Ÿè¡Œï¼Œä¸æ’åºä¹Ÿè¡Œã€‚æ’åºå¯ä»¥åœ¨æ¨ªå‘å¾ªç¯éå†æ—¶å‘ç°å¤§äº†å°±breakï¼Œè€Œä¸å¾€ä¸‹DFSï¼Œä¸Šé¢é‚£ä¸ªä¾‹å­ä¹Ÿæ˜¯</span><br><span class="line">        Arrays.sort(candidates);</span><br><span class="line">        System.out.println(Arrays.toString(candidates));</span><br><span class="line">        res2 = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs2(candidates, target, 0, 0, new ArrayList&lt;&gt;());</span><br><span class="line">        return res2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs2(int[] candidates, int target, int sum, int start, List&lt;Integer&gt; nums) &#123;</span><br><span class="line">        if (sum == target) &#123;</span><br><span class="line">            res2.add(new ArrayList&lt;&gt;(nums));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = start; i &lt; candidates.length; i++) &#123;</span><br><span class="line">            if (sum candidates[i] &gt; target) break; //å‰ªæ</span><br><span class="line">            // å…³é”®ï¼šåé¢å…ƒç´ ä¸€æ ·çš„è¯ï¼Œå°±continueï¼Œè¿™æ˜¯æ¨ªå‘çš„ï¼Œå› ä¸ºæ¯”å¦‚111ï¼Œtargetä¸º2ï¼Œç”¨å‰é¢ä¸¤ä¸ª11å°±è¡Œï¼Œåé¢å°±ä¸ç”¨éå†äº†</span><br><span class="line">            if (i &gt; start &amp;&amp; candidates[i] == candidates[i- 1]) &#123;</span><br><span class="line">                System.out.println(candidates[i]);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            nums.add(candidates[i]);</span><br><span class="line">            dfs2(candidates, target, sum candidates[i], i + 1, nums);</span><br><span class="line">            nums.remove(nums.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç»„åˆæ€»å’Œ3ï¼ˆkä¸ªæ•°å’Œä¸ºnï¼‰"><a href="#ç»„åˆæ€»å’Œ3ï¼ˆkä¸ªæ•°å’Œä¸ºnï¼‰" class="headerlink" title="ç»„åˆæ€»å’Œ3ï¼ˆkä¸ªæ•°å’Œä¸ºnï¼‰"></a>ç»„åˆæ€»å’Œ3ï¼ˆkä¸ªæ•°å’Œä¸ºnï¼‰</h2><p>ç»™ä½ ä¸€ä¸ªç”± ä¸åŒ æ•´æ•°ç»„æˆçš„æ•°ç»„ nums ï¼Œå’Œä¸€ä¸ªç›®æ ‡æ•´æ•° target ã€‚è¯·ä½ ä» nums ä¸­æ‰¾å‡ºå¹¶è¿”å›æ€»å’Œä¸º target çš„å…ƒç´ ç»„åˆçš„ä¸ªæ•°ã€‚</p>
<p>æ ‡ç­¾ï¼šDFSå›æº¯ åªä¼ leftNum</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // ç»„åˆæ€»å’Œ3</span><br><span class="line">    // æ‰¾å‡ºæ‰€æœ‰ç›¸åŠ ä¹‹å’Œä¸ºnçš„kä¸ªæ•°çš„ç»„åˆï¼Œæ•°å­—1-9ï¼Œæ¯ä¸ªæ•°å­—æœ€å¤šåªç”¨ä¸€æ¬¡</span><br><span class="line">    // æŠ€å·§ï¼šè¿­ä»£ä¸­åªä¼ å‰©ä¸‹çš„nã€å‰©ä¸‹çš„kå°±å¥½äº†ã€‚</span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; res3;</span><br><span class="line"></span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; combinationSum3(int k, int n) &#123;</span><br><span class="line">        res3 = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs3(n, k, 1, new ArrayList&lt;&gt;());</span><br><span class="line">        return res3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs3(int leftNum, int leftK, int start, List&lt;Integer&gt; nums) &#123;</span><br><span class="line">        if (leftNum &lt; 0 || leftK &lt; 0) return;</span><br><span class="line">        if (leftNum == 0 &amp;&amp; leftK == 0) &#123;</span><br><span class="line">            res3.add(new ArrayList&lt;&gt;(nums));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = start; i &lt;= 9; i ++) &#123;</span><br><span class="line">            nums.add(i);</span><br><span class="line">            dfs3(leftNum - i, leftK - 1, i + 1, nums);</span><br><span class="line">            nums.remove(nums.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ç”µè¯å·ç çš„å­—æ¯ç»„åˆ"><a href="#ç”µè¯å·ç çš„å­—æ¯ç»„åˆ" class="headerlink" title="ç”µè¯å·ç çš„å­—æ¯ç»„åˆ"></a>ç”µè¯å·ç çš„å­—æ¯ç»„åˆ</h2><p>ç»™å®šä¸€ä¸ªä»…åŒ…å«æ•°å­— 2-9 çš„å­—ç¬¦ä¸²ï¼Œè¿”å›æ‰€æœ‰å®ƒèƒ½è¡¨ç¤ºçš„å­—æ¯ç»„åˆã€‚ç­”æ¡ˆå¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›ã€‚</p>
<p>æ ‡ç­¾ï¼šDFS+å›æº¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ‰‹æœºå·ç çš„ç»„åˆ</span><br><span class="line">    // æ‰‹æœºä¹å®«æ ¼é”®ç›˜ 2-9åˆ†åˆ«å¯¹åº”å‡ ä¸ªå­—ç¬¦ï¼Œè¿”å›ä¸€ä¸²æ•°å­—çš„æ‰€æœ‰å­—æ¯ç»„åˆ</span><br><span class="line">    private List&lt;String&gt; res4;</span><br><span class="line">    private String[] letters = new String[]&#123;&quot;abc&quot;, &quot;def&quot;, &quot;ghi&quot;, &quot;jkl&quot;, &quot;mno&quot;, &quot;pqrs&quot;, &quot;tuv&quot;, &quot;wxyz&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    // æ‰‹æœºå·ç çš„ç»„åˆ</span><br><span class="line">    // æ‰‹æœºä¹å®«æ ¼é”®ç›˜ 2-9åˆ†åˆ«å¯¹åº”å‡ ä¸ªå­—ç¬¦ï¼Œè¿”å›ä¸€ä¸²æ•°å­—çš„æ‰€æœ‰å­—æ¯ç»„åˆ</span><br><span class="line">    public List&lt;String&gt; letterCombinations(String digits) &#123;</span><br><span class="line">        res4 = new ArrayList&lt;&gt;();</span><br><span class="line">        if (digits.equals(&quot;&quot;)) return res4;</span><br><span class="line">        dfs4(0, digits, new ArrayList&lt;&gt;());</span><br><span class="line">        return res4;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs4(int index, String digits, List&lt;Character&gt; chars) &#123;</span><br><span class="line">        if (index == digits.length()) &#123;</span><br><span class="line">            String s = chars.stream().map(String :: valueOf).collect(Collectors.joining());</span><br><span class="line">            res4.add(s);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        String letter = letters[digits.charAt(index) - &#x27;2&#x27;];</span><br><span class="line">        for (int i = 0; i &lt; letter.length(); i ++) &#123;</span><br><span class="line">            chars.add(letter.charAt(i));</span><br><span class="line">            dfs4(index 1, digits, chars);</span><br><span class="line">            chars.remove(chars.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ†å‰²å›æ–‡ä¸²"><a href="#åˆ†å‰²å›æ–‡ä¸²" class="headerlink" title="åˆ†å‰²å›æ–‡ä¸²"></a>åˆ†å‰²å›æ–‡ä¸²</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œè¯·ä½ å°† s åˆ†å‰²æˆä¸€äº›å­ä¸²ï¼Œä½¿æ¯ä¸ªå­ä¸²éƒ½æ˜¯ å›æ–‡ä¸² ã€‚è¿”å› s æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²æ–¹æ¡ˆã€‚</p>
<p>è¾“å…¥ï¼šs = â€œaabâ€<br>è¾“å‡ºï¼š[[â€œaâ€,â€aâ€,â€bâ€],[â€œaaâ€,â€bâ€]]</p>
<p>æ ‡ç­¾ï¼šåˆ†å‰²é—®é¢˜ DFS+å›æº¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    private List&lt;List&lt;String&gt;&gt; res;</span><br><span class="line"></span><br><span class="line">    // åˆ†å‰²å›æ–‡ä¸²</span><br><span class="line">    // ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œè¯·ä½ å°† s åˆ†å‰²æˆä¸€äº›å­ä¸²ï¼Œä½¿æ¯ä¸ªå­ä¸²éƒ½æ˜¯ å›æ–‡ä¸² ã€‚è¿”å› s æ‰€æœ‰å¯èƒ½çš„åˆ†å‰²æ–¹æ¡ˆ</span><br><span class="line">    // è§£æ³•ï¼šDFS+å›æº¯ï¼Œè¦ä¼ startè®°å½•åˆ‡å‰²ä½ç½®ï¼Œforæ¨ªå‘éå†ï¼Œdfsçºµå‘éå†</span><br><span class="line">    public List&lt;List&lt;String&gt;&gt; partition(String s) &#123;</span><br><span class="line">        res = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs(s, 0, new ArrayList&lt;&gt;());</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs(String s, int start, List&lt;String&gt; track) &#123;</span><br><span class="line">        if (start == s.length()) &#123;</span><br><span class="line">            res.add(new ArrayList&lt;&gt;(track));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = start; i &lt; s. length(); i ++) &#123;</span><br><span class="line">            if (isHuiWen(s, start, i)) &#123;</span><br><span class="line">                track.add(s.substring(start, i + 1));</span><br><span class="line">                dfs(s, i + 1, track);</span><br><span class="line">                track.remove(track.size() - 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isHuiWen(String s, int start, int end) &#123;</span><br><span class="line">        while(start &lt; end) &#123;</span><br><span class="line">            if (s.charAt(start) != s.charAt(end)) return false;</span><br><span class="line">            start ++;</span><br><span class="line">            end --;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¤åŸ-IP-åœ°å€"><a href="#å¤åŸ-IP-åœ°å€" class="headerlink" title="å¤åŸ IP åœ°å€"></a>å¤åŸ IP åœ°å€</h2><p>æœ‰æ•ˆ IP åœ°å€ æ­£å¥½ç”±å››ä¸ªæ•´æ•°ï¼ˆæ¯ä¸ªæ•´æ•°ä½äº 0 åˆ° 255 ä¹‹é—´ç»„æˆï¼Œä¸”ä¸èƒ½å«æœ‰å‰å¯¼ 0ï¼‰ï¼Œæ•´æ•°ä¹‹é—´ç”¨ â€˜.â€™ åˆ†éš”ã€‚</p>
<p>ä¾‹å¦‚ï¼šâ€0.1.2.201â€ å’Œ â€œ192.168.1.1â€ æ˜¯ æœ‰æ•ˆ IP åœ°å€ï¼Œä½†æ˜¯ â€œ0.011.255.245â€ã€â€192.168.1.312â€ å’Œ â€œ<a href="mailto:&#49;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x40;&#49;&#x2e;&#49;">&#49;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x40;&#49;&#x2e;&#49;</a>â€œ æ˜¯ æ— æ•ˆ IP åœ°å€ã€‚<br>ç»™å®šä¸€ä¸ªåªåŒ…å«æ•°å­—çš„å­—ç¬¦ä¸² s ï¼Œç”¨ä»¥è¡¨ç¤ºä¸€ä¸ª IP åœ°å€ï¼Œè¿”å›æ‰€æœ‰å¯èƒ½çš„æœ‰æ•ˆ IP åœ°å€ï¼Œè¿™äº›åœ°å€å¯ä»¥é€šè¿‡åœ¨ s ä¸­æ’å…¥ â€˜.â€™ æ¥å½¢æˆã€‚ä½  ä¸èƒ½ é‡æ–°æ’åºæˆ–åˆ é™¤ s ä¸­çš„ä»»ä½•æ•°å­—ã€‚ä½ å¯ä»¥æŒ‰ ä»»ä½• é¡ºåºè¿”å›ç­”æ¡ˆã€‚</p>
<p>æ ‡ç­¾ï¼šåˆ‡å‰²é—®é¢˜ DFS+å›æº¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å¤åŸIPåœ°å€</span><br><span class="line">    // è¾“å…¥ä¸€ä¸²æ•°å­—ï¼Œè¿”å›å¯èƒ½çš„IPåœ°å€ï¼Œå¦‚0.1.255.23</span><br><span class="line">    private List&lt;String&gt; ipList;</span><br><span class="line"></span><br><span class="line">    public List&lt;String&gt; restoreIpAddresses(String s) &#123;</span><br><span class="line">        ipList = new ArrayList&lt;&gt;();</span><br><span class="line">        if (s.length() &gt; 12) return ipList;</span><br><span class="line">        dfs2(s, 0, new ArrayList&lt;&gt;());</span><br><span class="line">        return ipList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs2(String s, int start, List&lt;String&gt; track) &#123;</span><br><span class="line">        if (track.size() == 4 &amp;&amp; start == s. length()) &#123;</span><br><span class="line">            String ip = String.join(&quot;.&quot;, track);</span><br><span class="line">            ipList.add(ip);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (track.size() == 4) return;</span><br><span class="line">        for (int i = start; i &lt; s. length(); i ++) &#123;</span><br><span class="line">            String ss = s.substring(start, i + 1);</span><br><span class="line">            if (isRightIp(ss)) &#123;</span><br><span class="line">                track.add(ss);</span><br><span class="line">                dfs2(s, i + 1, track);</span><br><span class="line">                track.remove(track.size() - 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isRightIp(String s) &#123;</span><br><span class="line">        if (s.length() == 1) return true;</span><br><span class="line">        if (s.charAt(0) == &#x27;0&#x27;) return false;</span><br><span class="line">        long num = Long.parseLong(s);</span><br><span class="line">        return num &lt; 256;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å­é›†"><a href="#å­é›†" class="headerlink" title="å­é›†"></a>å­é›†</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œæ•°ç»„ä¸­çš„å…ƒç´  äº’ä¸ç›¸åŒ ã€‚è¿”å›è¯¥æ•°ç»„æ‰€æœ‰å¯èƒ½çš„å­é›†ï¼ˆå¹‚é›†ï¼‰ã€‚</p>
<p>è§£é›† ä¸èƒ½ åŒ…å«é‡å¤çš„å­é›†ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›è§£é›†ã€‚</p>
<p>è¾“å…¥ï¼šnums = [1,2,3]<br>è¾“å‡ºï¼š<code>[[],[1],[2],[1,2],[3],[1,3],[2,3],[1,2,3]]</code></p>
<p>æ ‡ç­¾ï¼šDFS+å›æº¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å­é›†</span><br><span class="line">    // ç»™å®šä¸€ä¸ªint[]ï¼Œè¿”å›å®ƒçš„å­é›†ï¼ŒåŒ…æ‹¬[]ï¼Œä¸èƒ½é‡å¤.</span><br><span class="line">    // ç»™å®šçš„æ•°ç»„ä¸­ï¼Œå°±æ²¡é‡å¤çš„ï¼Œæ²¡é‡å¤çš„å°±ä¸ç”¨æ’åº</span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; res;</span><br><span class="line"></span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; subsets(int[] nums) &#123;</span><br><span class="line">        //Arrays.sort(nums);</span><br><span class="line">        res = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs(nums, 0, new ArrayList&lt;&gt;());</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs(int[] nums, int start, List&lt;Integer&gt; track) &#123;</span><br><span class="line">        res.add(new ArrayList&lt;&gt;(track));</span><br><span class="line">        for (int i = start; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            track.add(nums[i]);</span><br><span class="line">            dfs(nums, i + 1, track);</span><br><span class="line">            track.remove(track.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å­é›†2"><a href="#å­é›†2" class="headerlink" title="å­é›†2"></a>å­é›†2</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œå…¶ä¸­å¯èƒ½åŒ…å«é‡å¤å…ƒç´ ï¼Œè¯·ä½ è¿”å›è¯¥æ•°ç»„æ‰€æœ‰å¯èƒ½çš„å­é›†ï¼ˆå¹‚é›†ï¼‰ã€‚</p>
<p>è§£é›† ä¸èƒ½ åŒ…å«é‡å¤çš„å­é›†ã€‚è¿”å›çš„è§£é›†ä¸­ï¼Œå­é›†å¯ä»¥æŒ‰ ä»»æ„é¡ºåº æ’åˆ—ã€‚</p>
<p>è¾“å…¥ï¼šnums = [1,2,2]<br>è¾“å‡ºï¼š<code>[[],[1],[1,2],[1,2,2],[2],[2,2]]</code></p>
<p>æ ‡ç­¾ï¼šDFS+å›æº¯+å‰ªæ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å­é›†2ï¼šè¾“å…¥å¯èƒ½åŒ…å«é‡å¤å…ƒç´ äº†</span><br><span class="line">    // åªéœ€è¦å¢åŠ ä¸€ä¸ªæ¨ªå‘çš„å»é‡</span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; res2;</span><br><span class="line"></span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; subsetsWithDup(int[] nums) &#123;</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        res2 = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs2(nums, 0, new ArrayList&lt;&gt;());</span><br><span class="line">        return res2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs2(int[] nums, int start, List&lt;Integer&gt; track) &#123;</span><br><span class="line">        res2.add(new ArrayList&lt;&gt;(track));</span><br><span class="line">        for (int i = start; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            if (i &gt; start &amp;&amp; nums[i] == nums[i - 1]) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            track.add(nums[i]);</span><br><span class="line">            dfs2(nums, i + 1, track);</span><br><span class="line">            track.remove(track.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="é€’å¢å­åºåˆ—"><a href="#é€’å¢å­åºåˆ—" class="headerlink" title="é€’å¢å­åºåˆ—"></a>é€’å¢å­åºåˆ—</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œæ‰¾å‡ºå¹¶è¿”å›æ‰€æœ‰è¯¥æ•°ç»„ä¸­ä¸åŒçš„é€’å¢å­åºåˆ—ï¼Œé€’å¢å­åºåˆ—ä¸­ è‡³å°‘æœ‰ä¸¤ä¸ªå…ƒç´  ã€‚ä½ å¯ä»¥æŒ‰ ä»»æ„é¡ºåº è¿”å›ç­”æ¡ˆã€‚</p>
<p>æ•°ç»„ä¸­å¯èƒ½å«æœ‰é‡å¤å…ƒç´ ï¼Œå¦‚å‡ºç°ä¸¤ä¸ªæ•´æ•°ç›¸ç­‰ï¼Œä¹Ÿå¯ä»¥è§†ä½œé€’å¢åºåˆ—çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<p>è¾“å…¥ï¼šnums = [4,6,7,7]<br>è¾“å‡ºï¼š<code>[[4,6],[4,6,7],[4,6,7,7],[4,7],[4,7,7],[6,7],[6,7,7],[7,7]]</code></p>
<p>æ ‡ç­¾ï¼šDFS+å›æº¯+å‰ªæ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // é€’å¢å­åºåˆ—</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œè¿”å›æ‰€æœ‰çš„é€’å¢å­åºåˆ—ï¼Œç›¸åŒä¹Ÿç®—é€’å¢ï¼Œå­åºåˆ—ä¸éœ€è¦è¿ç»­å…ƒç´ ï¼Œå¯ä»¥é—´éš”å–ç”¨</span><br><span class="line">    // æ³¨æ„ï¼šåºåˆ—æœ¬èº«å¹¶ä¸ä¸€å®šæ˜¯é€’å¢çš„ï¼Œå­åºåˆ—ä¸èƒ½ä¸æ˜¯åŸåºåˆ—çš„é¡ºåºï¼Œæ‰€ä»¥ä¸èƒ½æ’åº</span><br><span class="line">    // æ³¨æ„ï¼šåºåˆ—ä¸æ˜¯é€’å¢çš„ï¼Œå‰ªæå°±ä¸èƒ½å‰åå¯¹æ¯”å‰ªæäº†</span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; sequenceList;</span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; findSubsequences(int[] nums) &#123;</span><br><span class="line">        sequenceList = new ArrayList&lt;&gt;();</span><br><span class="line">        dfs3(nums, 0, new ArrayList&lt;&gt;());</span><br><span class="line">        return sequenceList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs3(int[] nums, int start, List&lt;Integer&gt; track) &#123;</span><br><span class="line">        // åˆ¤æ–­æ˜¯å¦é€’å¢</span><br><span class="line">        if (track.size() &gt;= 2 &amp;&amp; track.get(track.size() - 1) &lt; track.get(track.size() - 2)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        // é•¿åº¦è‡³å°‘æ˜¯2</span><br><span class="line">        if (track.size() &gt;= 2) &#123;</span><br><span class="line">            // è¿™é‡Œä¸åº”è¯¥return</span><br><span class="line">            sequenceList.add(new ArrayList&lt;&gt;(track));</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;Integer&gt; jianzhiSet = new HashSet&lt;&gt;();</span><br><span class="line">        for (int i = start; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            // æ¨ªå‘å»é‡ï¼Œå‰ªæ</span><br><span class="line">//            if (i &gt; start &amp;&amp; nums[i] == nums[i - 1]) continue; //è¿™æ ·ä¸è¡Œ</span><br><span class="line">            if(jianzhiSet.contains(nums[i])) continue;</span><br><span class="line">            track.add(nums[i]);</span><br><span class="line">            jianzhiSet.add(nums[i]);</span><br><span class="line">            dfs3(nums, i + 1, track);</span><br><span class="line">            track.remove(track.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…¨æ’åˆ—ï¼ˆå…ƒç´ æ— é‡ï¼Œä¸å¯é‡é€‰ï¼‰"><a href="#å…¨æ’åˆ—ï¼ˆå…ƒç´ æ— é‡ï¼Œä¸å¯é‡é€‰ï¼‰" class="headerlink" title="å…¨æ’åˆ—ï¼ˆå…ƒç´ æ— é‡ï¼Œä¸å¯é‡é€‰ï¼‰"></a>å…¨æ’åˆ—ï¼ˆå…ƒç´ æ— é‡ï¼Œä¸å¯é‡é€‰ï¼‰</h2><p>ç»™å®šä¸€ä¸ªä¸å«é‡å¤æ•°å­—çš„æ•°ç»„ nums ï¼Œè¿”å›å…¶ æ‰€æœ‰å¯èƒ½çš„å…¨æ’åˆ— ã€‚ä½ å¯ä»¥ æŒ‰ä»»æ„é¡ºåº è¿”å›ç­”æ¡ˆã€‚</p>
<p>è¾“å…¥ï¼šnums = [1,2,3]<br>è¾“å‡ºï¼š<code>[[1,2,3],[1,3,2],[2,1,3],[2,3,1],[3,1,2],[3,2,1]]</code></p>
<p>æ ‡ç­¾ï¼šDFS+å›æº¯+è®°å½•æ•°ç»„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å…¨æ’åˆ—(å…ƒç´ æ— é‡ï¼Œä¸å¯é‡é€‰)</span><br><span class="line">    // [1,2] è¾“å‡º: [1,2][2,1]</span><br><span class="line">    // å…ƒç´ æ— é‡å¤ï¼Œä¸€ä¸ªä½ç½®çš„å…ƒç´ ä¸èƒ½é‡é€‰</span><br><span class="line">    // å®ç°ï¼šä¸éœ€è¦startæ¥è®°å½•éå†åˆ°å“ªï¼Œä½†æ˜¯éœ€è¦è®°å½•å“ªäº›ä½ç½®éå†è¿‡äº†ï¼ˆå‰ææ˜¯å…ƒç´ æ— é‡å¤ï¼Œè¦æ˜¯æœ‰é‡å¤çš„è¯ï¼Œä¸åŒä½ç½®ä½†æ˜¯å€¼ä¸€æ ·å°±ä¼šé‡é€‰ï¼‰</span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; res;</span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; permute(int[] nums) &#123;</span><br><span class="line">        res = new ArrayList&lt;&gt;();</span><br><span class="line">        if (nums.length == 0) return res;</span><br><span class="line">        dfs(nums, new ArrayList&lt;&gt;(), new HashSet&lt;&gt;());</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs(int[] nums, List&lt;Integer&gt; track, Set&lt;Integer&gt; usedIndex) &#123;</span><br><span class="line">        if (track.size() == nums.length) &#123;</span><br><span class="line">            res.add(new ArrayList&lt;&gt;(track));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">            if (usedIndex.contains(i)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            track.add(nums[i]);</span><br><span class="line">            usedIndex.add(i);</span><br><span class="line">            dfs(nums, track, usedIndex);</span><br><span class="line">            track.remove(track.size() - 1);</span><br><span class="line">            usedIndex.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…¨æ’åˆ—2ï¼ˆå…ƒç´ å¯é‡ï¼Œä¸å¯é‡é€‰ï¼‰"><a href="#å…¨æ’åˆ—2ï¼ˆå…ƒç´ å¯é‡ï¼Œä¸å¯é‡é€‰ï¼‰" class="headerlink" title="å…¨æ’åˆ—2ï¼ˆå…ƒç´ å¯é‡ï¼Œä¸å¯é‡é€‰ï¼‰"></a>å…¨æ’åˆ—2ï¼ˆå…ƒç´ å¯é‡ï¼Œä¸å¯é‡é€‰ï¼‰</h2><p>ç»™å®šä¸€ä¸ªå¯åŒ…å«é‡å¤æ•°å­—çš„åºåˆ— nums ï¼ŒæŒ‰ä»»æ„é¡ºåº è¿”å›æ‰€æœ‰ä¸é‡å¤çš„å…¨æ’åˆ—ã€‚</p>
<p>è¾“å…¥ï¼šnums = [1,1,2]<br>è¾“å‡ºï¼š<code>[[1,1,2], [1,2,1], [2,1,1]]</code></p>
<p>æ ‡ç­¾ï¼šDFS+å›æº¯+è®°å½•æ•°ç»„+å‰ªæ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å…¨æ’åˆ—(å…ƒç´ é‡å¤ï¼Œä¸å¯é‡é€‰)</span><br><span class="line">    // è¾“å…¥ï¼š[1,1,2] è¾“å‡ºï¼š[1,1,2][1,2,1][2,1,1]</span><br><span class="line">    // ä¸å…‰è¦è®°å½•æ·±åº¦æ–¹å‘å“ªäº›ç´¢å¼•å·²ç»ç”¨è¿‡ï¼Œè¿˜è¦æ¨ªå‘å‰ªæï¼Œä½†æ˜¯è¿™é‡Œå‰ªææ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦æ˜¯æ¨ªå‘ä¹‹å‰ç¡®å®šç”¨è¿‡çš„ï¼Œç”¨ä¸´æ—¶æ•°è®°å½•</span><br><span class="line">    private List&lt;List&lt;Integer&gt;&gt; res2;</span><br><span class="line"></span><br><span class="line">    public List&lt;List&lt;Integer&gt;&gt; permuteUnique(int[] nums) &#123;</span><br><span class="line">        res2 = new ArrayList&lt;&gt;();</span><br><span class="line">        if (nums.length == 0) return res2;</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        dfs2(nums, new ArrayList&lt;&gt;(), new HashSet&lt;&gt;());</span><br><span class="line">        return res2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void dfs2(int[] nums, List&lt;Integer&gt; track, Set&lt;Integer&gt; usedIndex) &#123;</span><br><span class="line">        System.out.println(track);</span><br><span class="line">        if (track.size() == nums.length) &#123;</span><br><span class="line">            res2.add(new ArrayList&lt;&gt;(track));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        int used = -11;</span><br><span class="line">        for (int i = 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">            if (usedIndex.contains(i)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (i &gt; 0 &amp;&amp; nums[i] == used) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            used = nums[i];</span><br><span class="line">            track.add(nums[i]);</span><br><span class="line">            usedIndex.add(i);</span><br><span class="line">            dfs2(nums, track, usedIndex);</span><br><span class="line">            track.remove(track.size() - 1);</span><br><span class="line">            usedIndex.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è§£æ•°ç‹¬"><a href="#è§£æ•°ç‹¬" class="headerlink" title="è§£æ•°ç‹¬"></a>è§£æ•°ç‹¬</h2><p>ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œé€šè¿‡å¡«å……ç©ºæ ¼æ¥è§£å†³æ•°ç‹¬é—®é¢˜ã€‚</p>
<p>æ•°ç‹¬çš„è§£æ³•éœ€ éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š</p>
<p>æ•°å­— 1-9 åœ¨æ¯ä¸€è¡Œåªèƒ½å‡ºç°ä¸€æ¬¡ã€‚<br>æ•°å­— 1-9 åœ¨æ¯ä¸€åˆ—åªèƒ½å‡ºç°ä¸€æ¬¡ã€‚<br>æ•°å­— 1-9 åœ¨æ¯ä¸€ä¸ªä»¥ç²—å®çº¿åˆ†éš”çš„ 3x3 å®«å†…åªèƒ½å‡ºç°ä¸€æ¬¡ã€‚ï¼ˆè¯·å‚è€ƒç¤ºä¾‹å›¾ï¼‰<br>æ•°ç‹¬éƒ¨åˆ†ç©ºæ ¼å†…å·²å¡«å…¥äº†æ•°å­—ï¼Œç©ºç™½æ ¼ç”¨ â€˜.â€™ è¡¨ç¤ºã€‚</p>
<p>æ ‡ç­¾ï¼šDFS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // è§£æ•°ç‹¬</span><br><span class="line">    // è¾“å…¥9*9çš„çŸ©é˜µï¼ŒæœªçŸ¥æ•°ç”¨.è¡¨ç¤ºï¼Œæ¯è¡Œæ¯åˆ—æ¯ä¸ªå·¦ä¸­å³3*3ï¼Œéƒ½æ˜¯1-9ä¸èƒ½é‡å¤</span><br><span class="line">    // è¾“å‡ºå¡«å¥½çš„æ•°ç‹¬</span><br><span class="line">    // è§£æ³•ï¼šå’Œnçš‡åé—®é¢˜ç±»ä¼¼ï¼Œnçš‡åæ˜¯åªå¡«ä¸€ä¸ªï¼Œæ•°ç‹¬è¦1-9ã€‚nçš‡åç”¨ä¸€ä¸ªint[]è¡¨ç¤ºçš‡åçš„ä½ç½®ã€‚</span><br><span class="line">    // éå†è¿˜æœ‰æ²¡æœ‰æ²¡å¡«çš„æ•°ï¼Œå¦‚æœæ²¡æœ‰äº†å°±returnäº†ã€‚å¾—è¿”å›booleanè®°å½•ä¸€ä¸‹ã€‚</span><br><span class="line">    // æ€æƒ³å…¶å®éƒ½æ˜¯å°è¯•ï¼Œnçš‡åå°è¯•åœ¨æ¯è¡Œçš„å“ªä¸ªä½ç½®æ”¾ç½®çš‡åï¼Œç„¶åæ ¡éªŒã€‚å¡«æ•°ç‹¬åœ¨æ²¡å¡«çš„ä½ç½®å°è¯•ï¼Œç„¶åæ ¡éªŒã€‚</span><br><span class="line">    // nçš‡åè¦è¿”å›å‡ ç§ç­”æ¡ˆï¼Œæ‰€ä»¥dfsè¿”å›å‡ ç§ã€‚</span><br><span class="line">    public void solveSudoku(char[][] board) &#123;</span><br><span class="line">        dfs(board);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean dfs(char[][] board) &#123;</span><br><span class="line">        for (int i = 0; i &lt; board.length; i ++) &#123;</span><br><span class="line">            for (int j = 0; j &lt; board[0].length; j ++) &#123;</span><br><span class="line">                if (board[i][j] != &#x27;.&#x27;) continue;</span><br><span class="line">                for (int tryNum = 1; tryNum &lt;= 9; tryNum ++) &#123;</span><br><span class="line">                    char tryChar = (char) (&#x27;0&#x27; tryNum);</span><br><span class="line">                    if (isValid(board, i, j, tryChar)) &#123;</span><br><span class="line">                        board[i][j] = tryChar;</span><br><span class="line">                        if (dfs(board)) return true;</span><br><span class="line">                        else board[i][j] = &#x27;.&#x27;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // æ³¨æ„ï¼šæ‰€æœ‰æ•°éƒ½ä¸è¡Œï¼Œè¯æ˜å‰é¢å¡«é”™äº†ï¼Œå› æ­¤éœ€è¦å›æº¯ã€‚ä¸ç„¶è¿˜ä¼šéå†ä¸‹ä¸€ä¸ªä½ç½®</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isValid(char[][] board, int row, int column, char num) &#123;</span><br><span class="line">        // åŒè¡Œæ˜¯å¦å·²æœ‰</span><br><span class="line">        for (int i = 0; i &lt; board[0].length; i++) &#123;</span><br><span class="line">            if (board[row][i] == num)  return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // åŒåˆ—æ˜¯å¦å·²æœ‰</span><br><span class="line">        for (int i = 0; i &lt; board.length; i++) &#123;</span><br><span class="line">            if (board[i][column] == num)  return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // åŒæ–¹å—å„¿æ˜¯å¦å·²æœ‰</span><br><span class="line">        int startRow = (row / 3) * 3;</span><br><span class="line">        int startColumn = (column / 3) * 3;</span><br><span class="line">        for (int i = startRow; i &lt; startRow 3; i ++) &#123;</span><br><span class="line">            for (int j = startColumn; j &lt; startColumn 3; j ++) &#123;</span><br><span class="line">                if (board[i][j] == num)  return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŒæ„å­—ç¬¦ä¸²"><a href="#åŒæ„å­—ç¬¦ä¸²" class="headerlink" title="åŒæ„å­—ç¬¦ä¸²"></a>åŒæ„å­—ç¬¦ä¸²</h2><p>ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸² s å’Œ t ï¼Œåˆ¤æ–­å®ƒä»¬æ˜¯å¦æ˜¯åŒæ„çš„ã€‚</p>
<p>å¦‚æœ s ä¸­çš„å­—ç¬¦å¯ä»¥æŒ‰æŸç§æ˜ å°„å…³ç³»æ›¿æ¢å¾—åˆ° t ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯åŒæ„çš„ã€‚</p>
<p>æ¯ä¸ªå‡ºç°çš„å­—ç¬¦éƒ½åº”å½“æ˜ å°„åˆ°å¦ä¸€ä¸ªå­—ç¬¦ï¼ŒåŒæ—¶ä¸æ”¹å˜å­—ç¬¦çš„é¡ºåºã€‚ä¸åŒå­—ç¬¦ä¸èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªå­—ç¬¦ä¸Šï¼Œç›¸åŒå­—ç¬¦åªèƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªå­—ç¬¦ä¸Šï¼Œå­—ç¬¦å¯ä»¥æ˜ å°„åˆ°è‡ªå·±æœ¬èº«ã€‚</p>
<p>è¾“å…¥ï¼šs = â€œeggâ€, t = â€œaddâ€<br>è¾“å‡ºï¼štrue</p>
<p>æ ‡ç­¾ï¼šMap indexOf charAt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // åŒæ„å­—ç¬¦ä¸²</span><br><span class="line">    // è¾“å…¥ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯åŒæ„å­—ç¬¦ä¸²ï¼Œå¦‚ï¼šaabcã€oodyï¼Œæ˜ å°„åªèƒ½æ˜¯ä¸€å¯¹ä¸€çš„</span><br><span class="line">    // æ€è·¯ï¼š</span><br><span class="line">    // 1.å¯ä»¥ç”¨Stringçš„indexOf()æ–¹æ³•ï¼šæ‰¾åˆ°å…ƒç´ çš„ç¬¬ä¸€ä¸ªç´¢å¼•ä¸‹æ ‡</span><br><span class="line">    // 2.å¯ä»¥ç”¨mapè®°å½•å­—ç¬¦æ˜ å°„</span><br><span class="line">    public boolean isIsomorphic(String s1, String s2) &#123;</span><br><span class="line">        if (s1.length() != s2.length()) return false;</span><br><span class="line">        for (int i = 0; i &lt; s1.length(); i++) &#123;</span><br><span class="line">            if (s1.indexOf(s1.charAt(i)) != s2.indexOf(s2.charAt(i))) return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isIsomorphic2(String s1, String s2) &#123;</span><br><span class="line">        if (s1.length() != s2.length()) return false;</span><br><span class="line">        Map&lt;Character, Character&gt; map = new HashMap();</span><br><span class="line">        for (int i = 0; i &lt; s1.length(); i++) &#123;</span><br><span class="line">            if (map.containsKey(s1.charAt(i)) &amp;&amp; s2.charAt(i) != map.get(s1.charAt(i))) return false;</span><br><span class="line">            map.put(s1.charAt(i), s2.charAt(i));</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="è´ªå¿ƒä¸“æ "><a href="#è´ªå¿ƒä¸“æ " class="headerlink" title="è´ªå¿ƒä¸“æ "></a>è´ªå¿ƒä¸“æ </h2><p>è´ªå¿ƒä¸“æ ï¼šè´ªå¿ƒç®—æ³•å°±æ˜¯æ‰¾å½“ä¸‹çš„æœ€ä¼˜è§£ï¼Œæ¯ä¸€ä¸ªçŠ¶æ€éƒ½æ‰¾åˆ°æœ€ä¼˜è§£ï¼Œä»è€Œå¸Œæœ›ç»“æœæ˜¯å…¨å±€æœ€ä¼˜çš„ã€‚<br>è§£é¢˜æ€è·¯ä¸€èˆ¬æ˜¯ï¼š<br>    â€¢    é—®é¢˜åˆ†è§£ä¸ºè‹¥å¹²å­é—®é¢˜<br>    â€¢    æ‰¾å‡ºé€‚åˆçš„è´ªå¿ƒç­–ç•¥<br>    â€¢    æ±‚è§£æ¯ä¸ªå­é—®é¢˜çš„æœ€ä¼˜è§£<br>    â€¢    å°†å±€éƒ¨æœ€ä¼˜è§£å †å æˆå…¨å±€æœ€ä¼˜</p>
<h2 id="åˆ†å‘é¥¼å¹²"><a href="#åˆ†å‘é¥¼å¹²" class="headerlink" title="åˆ†å‘é¥¼å¹²"></a>åˆ†å‘é¥¼å¹²</h2><p>å‡è®¾ä½ æ˜¯ä¸€ä½å¾ˆæ£’çš„å®¶é•¿ï¼Œæƒ³è¦ç»™ä½ çš„å­©å­ä»¬ä¸€äº›å°é¥¼å¹²ã€‚ä½†æ˜¯ï¼Œæ¯ä¸ªå­©å­æœ€å¤šåªèƒ½ç»™ä¸€å—é¥¼å¹²ã€‚</p>
<p>å¯¹æ¯ä¸ªå­©å­ iï¼Œéƒ½æœ‰ä¸€ä¸ªèƒƒå£å€¼ g[i]ï¼Œè¿™æ˜¯èƒ½è®©å­©å­ä»¬æ»¡è¶³èƒƒå£çš„é¥¼å¹²çš„æœ€å°å°ºå¯¸ï¼›å¹¶ä¸”æ¯å—é¥¼å¹² jï¼Œéƒ½æœ‰ä¸€ä¸ªå°ºå¯¸ s[j] ã€‚å¦‚æœ s[j] &gt;= g[i]ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªé¥¼å¹² j åˆ†é…ç»™å­©å­ i ï¼Œè¿™ä¸ªå­©å­ä¼šå¾—åˆ°æ»¡è¶³ã€‚ä½ çš„ç›®æ ‡æ˜¯å°½å¯èƒ½æ»¡è¶³è¶Šå¤šæ•°é‡çš„å­©å­ï¼Œå¹¶è¾“å‡ºè¿™ä¸ªæœ€å¤§æ•°å€¼ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒç®—æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // åˆ†å‘é¥¼å¹²</span><br><span class="line">    // è¾“å…¥ï¼šgæ•°ç»„è¡¨ç¤ºå­©å­çš„èƒƒå£å€¼ï¼Œæ•°ç»„å¤§å°è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªå­©å­ï¼Œsæ•°ç»„è¡¨ç¤ºé¥¼å¹²çš„å°ºå¯¸ï¼Œæ•°ç»„å¤§å°è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªé¥¼å¹²</span><br><span class="line">    // è¾“å‡ºï¼šæœ€å¤šèƒ½æ»¡è¶³å¤šå°‘ä¸ªå­©å­</span><br><span class="line">    // è´ªå¿ƒæ€æƒ³ï¼šä»å±€éƒ¨æœ€ä¼˜åˆ°å…¨å±€æœ€ä¼˜ï¼Œå¤§çš„é¥¼å¹²å°½å¯èƒ½æ»¡è¶³èƒƒå£å¤§çš„å­©å­</span><br><span class="line">    public int findContentChildren(int[] g, int[] s) &#123;</span><br><span class="line">        Arrays.sort(g);</span><br><span class="line">        Arrays.sort(s);</span><br><span class="line">        int i = g.length - 1, j = s.length - 1;</span><br><span class="line">        int res = 0;</span><br><span class="line">        while(i &gt;= 0 &amp;&amp; j &gt;= 0) &#123;</span><br><span class="line">            // èƒƒå£å¤§äº†</span><br><span class="line">            if (g[i] &gt; s[j]) &#123;</span><br><span class="line">                i --;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            res ++;</span><br><span class="line">            i --;</span><br><span class="line">            j --;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="K-æ¬¡å–ååæœ€å¤§åŒ–çš„æ•°ç»„å’Œ"><a href="#K-æ¬¡å–ååæœ€å¤§åŒ–çš„æ•°ç»„å’Œ" class="headerlink" title="K æ¬¡å–ååæœ€å¤§åŒ–çš„æ•°ç»„å’Œ"></a>K æ¬¡å–ååæœ€å¤§åŒ–çš„æ•°ç»„å’Œ</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•° k ï¼ŒæŒ‰ä»¥ä¸‹æ–¹æ³•ä¿®æ”¹è¯¥æ•°ç»„ï¼š</p>
<p>é€‰æ‹©æŸä¸ªä¸‹æ ‡ i å¹¶å°† nums[i] æ›¿æ¢ä¸º -nums[i] ã€‚<br>é‡å¤è¿™ä¸ªè¿‡ç¨‹æ°å¥½ k æ¬¡ã€‚å¯ä»¥å¤šæ¬¡é€‰æ‹©åŒä¸€ä¸ªä¸‹æ ‡ i ã€‚</p>
<p>ä»¥è¿™ç§æ–¹å¼ä¿®æ”¹æ•°ç»„åï¼Œè¿”å›æ•°ç»„ å¯èƒ½çš„æœ€å¤§å’Œ ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒç®—æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // kæ¬¡å–ååæœ€å¤§åŒ–çš„æ•°ç»„å’Œ</span><br><span class="line">    // è¾“å…¥ï¼šä¸€ä¸ªæ•´æ•°æ•°ç»„numsã€ä¸€ä¸ªæ•´æ•°kï¼Œæ¯æ¬¡é€‰æ‹©ä¸€ä¸ªå…ƒç´ å–åï¼Œé‡å¤kæ¬¡ï¼Œå¯ä»¥é‡å¤é€‰æ‹©åŒä¸€å…ƒç´ </span><br><span class="line">    // è¾“å‡ºï¼šæ“ä½œåæœ€å¤§çš„æ•°ç»„å’Œ</span><br><span class="line">    // è´ªå¿ƒæ€æƒ³ï¼šå±€éƒ¨æœ€ä¼˜æ˜¯æ¯æ¬¡å–åçš„æ•°å­—æ˜¯æœ€å°çš„</span><br><span class="line">    // æ–¹æ³•ä¸€ï¼šæ¯æ¬¡éƒ½é‡æ’åºï¼Œå–æœ€å°çš„åè½¬ã€‚æ—¶é—´å¤æ‚åº¦é«˜</span><br><span class="line">    public int largestSumAfterKNegations1(int[] nums, int k) &#123;</span><br><span class="line">        for (int i = 0; i &lt; k; i ++) &#123;</span><br><span class="line">            Arrays.sort(nums);</span><br><span class="line">            nums[0] = -nums[0];</span><br><span class="line">        &#125;</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int num : nums) &#123;</span><br><span class="line">            res += num;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ–¹æ³•äºŒï¼šä¼˜åŒ–ä¸€ä¸‹ï¼Œé¦–å…ˆå°†æ•°ç»„æŒ‰ç…§ç»å¯¹å€¼ä»å¤§åˆ°å°æ’åˆ—ï¼Œç„¶åä»å‰å¾€åéå†é‡åˆ°è´Ÿæ•°å°±åè½¬ï¼Œæœ€åå¦‚æœkæ²¡ç”¨å®Œå°±å°†æ”¾æœ€åçš„æ•°ç»„æ¥å›åè½¬ã€‚</span><br><span class="line">    // ä¼˜ç‚¹ï¼šåªéœ€è¦æ’åºä¸€æ¬¡ï¼Œéœ€è¦è‡ªå®šä¹‰æ’åº</span><br><span class="line">    public int largestSumAfterKNegations(int[] nums, int k) &#123;</span><br><span class="line">        // é¦–å…ˆå°†int[]è½¬æ¢ä¸ºInteger[]ï¼Œå› ä¸ºComparatorä¸é€‚ç”¨äºåŸå§‹æ•°æ®ç±»å‹æ•°ç»„</span><br><span class="line">        Integer[] numbersObj = Arrays.stream(nums).boxed().toArray(Integer[]::new);</span><br><span class="line">        Arrays.sort(numbersObj, new Comparator&lt;Integer&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public int compare(Integer o1, Integer o2) &#123;</span><br><span class="line">                // æ¯”è¾ƒç»å¯¹å€¼ï¼Œå®ç°é€†åºæ’åº</span><br><span class="line">                return Integer.compare(Math.abs(o2), Math.abs(o1));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        int i = 0;</span><br><span class="line">        while (k &gt; 0 &amp;&amp; i &lt; numbersObj.length) &#123;</span><br><span class="line">            if (numbersObj[i] &lt; 0) &#123;</span><br><span class="line">                numbersObj[i] *= -1;</span><br><span class="line">                k --;</span><br><span class="line">            &#125;</span><br><span class="line">            i ++;</span><br><span class="line">        &#125;</span><br><span class="line">        while (k -- &gt; 0) &#123;</span><br><span class="line">            numbersObj[numbersObj.length - 1] *= -1;</span><br><span class="line">        &#125;</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int num : numbersObj) &#123;</span><br><span class="line">            res += num;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æŸ æª¬æ°´æ‰¾é›¶"><a href="#æŸ æª¬æ°´æ‰¾é›¶" class="headerlink" title="æŸ æª¬æ°´æ‰¾é›¶"></a>æŸ æª¬æ°´æ‰¾é›¶</h2><p>åœ¨æŸ æª¬æ°´æ‘Šä¸Šï¼Œæ¯ä¸€æ¯æŸ æª¬æ°´çš„å”®ä»·ä¸º 5 ç¾å…ƒã€‚é¡¾å®¢æ’é˜Ÿè´­ä¹°ä½ çš„äº§å“ï¼Œï¼ˆæŒ‰è´¦å• bills æ”¯ä»˜çš„é¡ºåºï¼‰ä¸€æ¬¡è´­ä¹°ä¸€æ¯ã€‚</p>
<p>æ¯ä½é¡¾å®¢åªä¹°ä¸€æ¯æŸ æª¬æ°´ï¼Œç„¶åå‘ä½ ä»˜ 5 ç¾å…ƒã€10 ç¾å…ƒæˆ– 20 ç¾å…ƒã€‚ä½ å¿…é¡»ç»™æ¯ä¸ªé¡¾å®¢æ­£ç¡®æ‰¾é›¶ï¼Œä¹Ÿå°±æ˜¯è¯´å‡€äº¤æ˜“æ˜¯æ¯ä½é¡¾å®¢å‘ä½ æ”¯ä»˜ 5 ç¾å…ƒã€‚</p>
<p>æ³¨æ„ï¼Œä¸€å¼€å§‹ä½ æ‰‹å¤´æ²¡æœ‰ä»»ä½•é›¶é’±ã€‚</p>
<p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ bills ï¼Œå…¶ä¸­ bills[i] æ˜¯ç¬¬ i ä½é¡¾å®¢ä»˜çš„è´¦ã€‚å¦‚æœä½ èƒ½ç»™æ¯ä½é¡¾å®¢æ­£ç¡®æ‰¾é›¶ï¼Œè¿”å› true ï¼Œå¦åˆ™è¿”å› false ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒç®—æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æŸ æª¬æ°´æ‰¾é›¶</span><br><span class="line">    // ä¸€ä¸ªæŸ æª¬5å—ï¼Œè¾“å…¥ä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œè¡¨ç¤ºé¡¾å®¢ä»˜çš„é’±(5ã€10ã€20)ï¼Œéœ€è¦è€ƒè™‘é¡ºåº</span><br><span class="line">    // è¿”å›æ˜¯å¦æˆåŠŸæ‰¾é›¶</span><br><span class="line">    // è´ªå¿ƒæ€æƒ³ï¼šé¡ºåºéå†æœ‰å¤šå°‘5å—10å—ï¼Œæ‰¾20ä¼˜å…ˆä½¿ç”¨10+5</span><br><span class="line">    public boolean lemonadeChange(int[] bills) &#123;</span><br><span class="line">        int fiveNum = 0;</span><br><span class="line">        int tenNum = 0;</span><br><span class="line">        for (int bill : bills) &#123;</span><br><span class="line">            if (bill == 5) fiveNum ++;</span><br><span class="line">            else if (bill == 10) &#123;</span><br><span class="line">                fiveNum --;</span><br><span class="line">                tenNum ++;</span><br><span class="line">            &#125; else if (bill == 20) &#123;</span><br><span class="line">                if (tenNum &gt; 0) &#123;</span><br><span class="line">                    tenNum --;</span><br><span class="line">                    fiveNum --;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    fiveNum -= 3;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (fiveNum &lt; 0 || tenNum &lt; 0) return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ•´æ•°æ‹†åˆ†"><a href="#æ•´æ•°æ‹†åˆ†" class="headerlink" title="æ•´æ•°æ‹†åˆ†"></a>æ•´æ•°æ‹†åˆ†</h2><p>ç»™å®šä¸€ä¸ªæ­£æ•´æ•° n ï¼Œå°†å…¶æ‹†åˆ†ä¸º k ä¸ª æ­£æ•´æ•° çš„å’Œï¼ˆ k &gt;= 2 ï¼‰ï¼Œå¹¶ä½¿è¿™äº›æ•´æ•°çš„ä¹˜ç§¯æœ€å¤§åŒ–ã€‚</p>
<p>è¿”å› ä½ å¯ä»¥è·å¾—çš„æœ€å¤§ä¹˜ç§¯ ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒç®—æ³•ã€åŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ•´æ•°æ‹†åˆ†</span><br><span class="line">    // ç»™ä¸€ä¸ªæ­£æ•´æ•°nï¼Œæ±‚å°†å…¶æ‹†åˆ†åçš„æœ€å¤§ç§¯</span><br><span class="line">    // æ–¹æ³•1ï¼šè´ªå¿ƒï¼Œå‘ç°é™¤äº†æœ€åçš„4ï¼Œå°†å…¶æ‹†åˆ†ä¸ºå°½å¯èƒ½å¤šçš„3ï¼Œæœ€åç§¯æœ€å¤§</span><br><span class="line">    public int integerBreak2(int n) &#123;</span><br><span class="line">        if (n &lt;= 2) return 1;</span><br><span class="line">        if (n == 3) return 2;</span><br><span class="line">        int res = 1;</span><br><span class="line">        while (n &gt; 4) &#123;</span><br><span class="line">            res *= 3;</span><br><span class="line">            n -= 3;</span><br><span class="line">        &#125;</span><br><span class="line">        return res * n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ–¹æ³•2ï¼šåŠ¨æ€è§„åˆ’ï¼Œåä¸€ä¸ªçŠ¶æ€ä¸å‰ä¸€ä¸ªçŠ¶æ€æœ‰å…³ï¼Œå»ºç«‹çŠ¶æ€è½¬ç§»æ–¹ç¨‹</span><br><span class="line">    public int integerBreak(int n) &#123;</span><br><span class="line">        if (n &lt;= 2) return 1;</span><br><span class="line">        // 1.å®šä¹‰dp</span><br><span class="line">        int[] dp = new int[n + 1];</span><br><span class="line">        // 2.åˆå§‹åŒ–ï¼Œæœ¬æ¥æƒ³æ¯ä¸ªéƒ½åˆå§‹åŒ–è‡ªå·±nï¼Œä½†æ˜¯åªæœ‰1ï¼Œ2æ˜¯éœ€è¦èµ‹äºˆåˆå€¼çš„</span><br><span class="line">        dp[1] = 1;</span><br><span class="line">        dp[2] = 1;</span><br><span class="line">        // 3.çŠ¶æ€è½¬ç§»</span><br><span class="line">        for (int i = 3; i &lt;= n; i ++) &#123;</span><br><span class="line">            // éå†æ‹†åˆ°ä¸€åŠçš„æ•°</span><br><span class="line">            for (int j = 1; j &lt;= i/2; j ++) &#123;</span><br><span class="line">                dp[i] = Math.max(dp[i], j * Math.max(dp[i - j], i - j));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[n];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="é›¶é’±å…‘æ¢"><a href="#é›¶é’±å…‘æ¢" class="headerlink" title="é›¶é’±å…‘æ¢"></a>é›¶é’±å…‘æ¢</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ coins ï¼Œè¡¨ç¤ºä¸åŒé¢é¢çš„ç¡¬å¸ï¼›ä»¥åŠä¸€ä¸ªæ•´æ•° amount ï¼Œè¡¨ç¤ºæ€»é‡‘é¢ã€‚</p>
<p>è®¡ç®—å¹¶è¿”å›å¯ä»¥å‡‘æˆæ€»é‡‘é¢æ‰€éœ€çš„ æœ€å°‘çš„ç¡¬å¸ä¸ªæ•° ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ç§ç¡¬å¸ç»„åˆèƒ½ç»„æˆæ€»é‡‘é¢ï¼Œè¿”å› -1 ã€‚</p>
<p>ä½ å¯ä»¥è®¤ä¸ºæ¯ç§ç¡¬å¸çš„æ•°é‡æ˜¯æ— é™çš„ã€‚</p>
<p>è¾“å…¥ï¼šcoins = [1, 2, 5], amount = 11<br>è¾“å‡ºï¼š3<br>è§£é‡Šï¼š11 = 5 5 1</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * é›¶é’±å…‘æ¢</span><br><span class="line">     * è¾“å…¥ï¼šä¸€ä¸ªæ•°ç»„è¡¨ç¤ºæœ‰å“ªäº›ç§é›¶é’±ï¼Œæ¯ç§çš„æ•°é‡æ— é™ï¼Œç»™ä½ ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºæ€»é‡‘é¢ï¼Œè¿”å›æ‰€éœ€æœ€å°‘çš„é›¶é’±ä¸ªæ•°</span><br><span class="line">     * å¦‚æœç»„åˆä¸æˆï¼Œå°±è¿”å›-1</span><br><span class="line">     */</span><br><span class="line">    // æ€è·¯ï¼šç”¨åŠ¨æ€è§„åˆ’</span><br><span class="line">    public static int coinChange(int[] changes, int total) &#123;</span><br><span class="line">        if (total == 0) return 0;</span><br><span class="line">        Arrays.sort(changes);</span><br><span class="line">        int[] dp = new int[total 1];</span><br><span class="line">        for (int num : changes) &#123;</span><br><span class="line">            if (num &lt;= total)  dp[num] = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i &lt;= total; i ++) &#123;</span><br><span class="line">            for (int num : changes) &#123;</span><br><span class="line">                if (i - num &lt; 1) break;</span><br><span class="line">                if (dp[i - num] == 0) continue;</span><br><span class="line">                dp[i] = dp[i] == 0 ? dp[i - num] + 1 : Math.min(dp[i], dp[i - num] + 1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[total] == 0 ? -1 : dp[total];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ‘†åŠ¨åºåˆ—"><a href="#æ‘†åŠ¨åºåˆ—" class="headerlink" title="æ‘†åŠ¨åºåˆ—"></a>æ‘†åŠ¨åºåˆ—</h2><p>å¦‚æœè¿ç»­æ•°å­—ä¹‹é—´çš„å·®ä¸¥æ ¼åœ°åœ¨æ­£æ•°å’Œè´Ÿæ•°ä¹‹é—´äº¤æ›¿ï¼Œåˆ™æ•°å­—åºåˆ—ç§°ä¸º æ‘†åŠ¨åºåˆ— ã€‚ç¬¬ä¸€ä¸ªå·®ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰å¯èƒ½æ˜¯æ­£æ•°æˆ–è´Ÿæ•°ã€‚ä»…æœ‰ä¸€ä¸ªå…ƒç´ æˆ–è€…å«ä¸¤ä¸ªä¸ç­‰å…ƒç´ çš„åºåˆ—ä¹Ÿè§†ä½œæ‘†åŠ¨åºåˆ—ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ [1, 7, 4, 9, 2, 5] æ˜¯ä¸€ä¸ª æ‘†åŠ¨åºåˆ— ï¼Œå› ä¸ºå·®å€¼ (6, -3, 5, -7, 3) æ˜¯æ­£è´Ÿäº¤æ›¿å‡ºç°çš„ã€‚</p>
<p>ç›¸åï¼Œ[1, 4, 7, 2, 5] å’Œ [1, 7, 4, 5, 5] ä¸æ˜¯æ‘†åŠ¨åºåˆ—ï¼Œç¬¬ä¸€ä¸ªåºåˆ—æ˜¯å› ä¸ºå®ƒçš„å‰ä¸¤ä¸ªå·®å€¼éƒ½æ˜¯æ­£æ•°ï¼Œç¬¬äºŒä¸ªåºåˆ—æ˜¯å› ä¸ºå®ƒçš„æœ€åä¸€ä¸ªå·®å€¼ä¸ºé›¶ã€‚<br>å­åºåˆ— å¯ä»¥é€šè¿‡ä»åŸå§‹åºåˆ—ä¸­åˆ é™¤ä¸€äº›ï¼ˆä¹Ÿå¯ä»¥ä¸åˆ é™¤ï¼‰å…ƒç´ æ¥è·å¾—ï¼Œå‰©ä¸‹çš„å…ƒç´ ä¿æŒå…¶åŸå§‹é¡ºåºã€‚</p>
<p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œè¿”å› nums ä¸­ä½œä¸º æ‘†åŠ¨åºåˆ— çš„ æœ€é•¿å­åºåˆ—çš„é•¿åº¦ ã€‚</p>
<p>è¾“å…¥ï¼šnums = [1,7,4,9,2,5]<br>è¾“å‡ºï¼š6<br>è§£é‡Šï¼šæ•´ä¸ªåºåˆ—å‡ä¸ºæ‘†åŠ¨åºåˆ—ï¼Œå„å…ƒç´ ä¹‹é—´çš„å·®å€¼ä¸º (6, -3, 5, -7, 3) ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">     /**</span><br><span class="line">     * æ‘†åŠ¨åºåˆ—</span><br><span class="line">     * ä»€ä¹ˆæ˜¯æ‘†åŠ¨åºåˆ—ï¼šåºåˆ—ç›¸é‚»å…ƒç´ çš„å·®å€¼æ˜¯æ­£æ•°è´Ÿæ•°æ‘†åŠ¨çš„ï¼Œä»…å«æœ‰ä¸€ä¸ª/ä¸¤ä¸ªå…ƒç´ çš„åºåˆ—ä¹Ÿæ˜¯æ‘†åŠ¨åºåˆ—</span><br><span class="line">     * è¾“å…¥ä¸€ä¸ªåºåˆ—ï¼Œè¿”å›è¿™ä¸ªåºåˆ—çš„æœ€é•¿æ‘†åŠ¨å­åºåˆ—ï¼ˆåªèƒ½åˆ é™¤å…ƒç´ ï¼‰</span><br><span class="line">     * æ€è€ƒï¼šä¸ç®¡æ€ä¹ˆæ ·ï¼Œæœ€ä¼˜ç­”æ¡ˆä¸€å®šæ˜¯å¯ä»¥ä»æœ€å¼€å¤´å¼€å§‹éå†çš„ï¼Œå°±ç®—æ˜¯ï¼š1 2 3 2 3..ï¼Œä¹Ÿå¯ä»¥ 1 3 2 3</span><br><span class="line">     * æ‰€ä»¥ä»å¤´å¼€å§‹éå†ï¼Œè´ªå¿ƒåœ°å¾€åèµ°å°±å¥½</span><br><span class="line">     */</span><br><span class="line">    public static int wiggleMaxLength(int[] nums) &#123;</span><br><span class="line">        if (nums.length == 1) return 1;</span><br><span class="line">        if (nums.length == 2) return nums[0] == nums[1]? 1:2;</span><br><span class="line">        int res = nums[0] == nums[1] ? 1 : 2;</span><br><span class="line">        int preDiff = nums[1] - nums[0];</span><br><span class="line">        for (int i = 2; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            int curDiff = nums[i] - nums[i - 1];</span><br><span class="line">            if ((preDiff &gt;= 0  &amp;&amp; curDiff &lt; 0) || (preDiff &lt;= 0 &amp;&amp; curDiff &gt; 0)) &#123;</span><br><span class="line">                res ++;</span><br><span class="line">                preDiff = curDiff;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å³°ä¸è°·"><a href="#å³°ä¸è°·" class="headerlink" title="å³°ä¸è°·"></a>å³°ä¸è°·</h2><p>åœ¨ä¸€ä¸ªæ•´æ•°æ•°ç»„ä¸­ï¼Œâ€œå³°â€æ˜¯å¤§äºæˆ–ç­‰äºç›¸é‚»æ•´æ•°çš„å…ƒç´ ï¼Œç›¸åº”åœ°ï¼Œâ€œè°·â€æ˜¯å°äºæˆ–ç­‰äºç›¸é‚»æ•´æ•°çš„å…ƒç´ ã€‚ä¾‹å¦‚ï¼Œåœ¨æ•°ç»„{5, 8, 4, 2, 3, 4, 6}ä¸­ï¼Œ{8, 6}æ˜¯å³°ï¼Œ {5, 2}æ˜¯è°·ã€‚ç°åœ¨ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œå°†è¯¥æ•°ç»„æŒ‰å³°ä¸è°·çš„äº¤æ›¿é¡ºåºæ’åºã€‚</p>
<p>è¾“å…¥: [5, 3, 1, 2, 3]<br>è¾“å‡º: [5, 1, 3, 2, 3]</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒï¼Œæ³¨æ„è´ªå¿ƒç®—æ³•ï¼Œä»å±€éƒ¨æœ€ä¼˜åˆ°å…¨å±€æœ€ä¼˜çš„å‰ææ˜¯ï¼šå±€éƒ¨æœ€ä¼˜ä¸å½±å“å…¨å±€æœ€ä¼˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">   </span><br><span class="line">    /**</span><br><span class="line">     * å³°ä¸è°·</span><br><span class="line">     * è¾“å…¥ï¼šä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œå³°æ˜¯å¤§äºç­‰äºä¸¤è¾¹æ•°çš„ï¼Œè°·æ˜¯å°äºç­‰äºä¸¤è¾¹æ•°çš„ã€‚åœ¨æœ€è¾¹åªæœ‰ä¸€ä¸ªç›¸é‚»å…ƒç´ ä¹Ÿç®—</span><br><span class="line">     * è¾“å‡ºï¼šå°†è¯¥æ•°ç»„æŒ‰ç…§å³°ä¸è°·çš„é¡ºåºäº¤æ›¿é¡ºåºæ’åº</span><br><span class="line">     * [5,3,1,2,3] è¾“å‡ºï¼š[5,1,3,2,3]  åº”è¯¥è¾“å‡ºä¸æ­¢æœ‰ä¸€ç§å¯èƒ½</span><br><span class="line">     * è´ªå¿ƒçš„æ€æƒ³ï¼šæŒ¨ä¸ªéå†ï¼ŒæŒ¨ä¸ªæ»¡è¶³è¦æ±‚ã€‚é‡ç‚¹æ˜¯å³°ä¸è°·äº¤æ›¿ï¼Œæ‰€ä»¥æ¯ä¸ªä½ç½®æ˜¯å³°è¿˜æ˜¯è°·æ˜¯ç¡®å®šçš„ï¼Œæ¯æ¬¡éå†ä¿è¯å’Œä¸Šä¸€ä¸ªä½ç½®çš„å…³ç³»ã€‚</span><br><span class="line">     * ä»ç¬¬äºŒä¸ªæ•°å¼€å§‹éå†ï¼Œä¿è¯å’Œå‰ä¸€ä¸ªæ•°çš„å…³ç³»ï¼Œä¸æ»¡è¶³å°±äº¤æ¢ã€‚å¯æ˜¯äº¤æ¢äº†å½±å“å‰é¢çš„æ€ä¹ˆåŠï¼Ÿä¸ä¼šï¼Œåé¢äº¤æ¢åªä¼šæ¢æ¥æ›´å°æˆ–æ›´å¤§çš„</span><br><span class="line">     * æ¯”å¦‚ï¼Œåœ¨åº”è¯¥å³°çš„ä½ç½®ï¼Œæ¯”å‰é¢å°ï¼Œæ¢æ¥å‰é¢çš„å¤§å€¼ï¼Œåœ¨ä¸‹ä¸€ä¸ªåº”è¯¥è°·çš„ä½ç½®ï¼Œå‘ç°æ¯”å‰ä¸€ä¸ªå¤§ï¼Œæ‰€ä»¥æ¢æ¥å‰é¢çš„å°å€¼ï¼Œé‚£ä¹ˆæœ€å¼€å§‹å³°çš„ä½ç½®å˜å¾—æ›´å¤§äº†ï¼Œä¸å½±å“</span><br><span class="line">     */</span><br><span class="line">    public static int[] wiggleSort(int[] nums) &#123;</span><br><span class="line">        if(nums.length == 1) &#123;</span><br><span class="line">            return nums;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            if (i % 2 == 0) &#123;</span><br><span class="line">                //å³°ï¼Œåº”è¯¥æ¯”ä¸Šä¸€ä¸ªå¤§</span><br><span class="line">                if (nums[i] &lt; nums[i - 1]) &#123;</span><br><span class="line">                    swap(nums, i, i - 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //è°·ï¼Œåº”è¯¥æ¯”ä¸Šä¸€ä¸ªå°</span><br><span class="line">                if (nums[i] &gt; nums[i - 1]) &#123;</span><br><span class="line">                    swap(nums, i, i - 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return nums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void swap(int[] nums, int index1, int index2) &#123;</span><br><span class="line">        int pre = nums[index2];</span><br><span class="line">        nums[index2] = nums[index1];</span><br><span class="line">        nums[index1] = pre;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å•è°ƒé€’å¢çš„æ•°å­—"><a href="#å•è°ƒé€’å¢çš„æ•°å­—" class="headerlink" title="å•è°ƒé€’å¢çš„æ•°å­—"></a>å•è°ƒé€’å¢çš„æ•°å­—</h2><p>å½“ä¸”ä»…å½“æ¯ä¸ªç›¸é‚»ä½æ•°ä¸Šçš„æ•°å­— x å’Œ y æ»¡è¶³ x &lt;= y æ—¶ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªæ•´æ•°æ˜¯å•è°ƒé€’å¢çš„ã€‚</p>
<p>ç»™å®šä¸€ä¸ªæ•´æ•° n ï¼Œè¿”å› å°äºæˆ–ç­‰äº n çš„æœ€å¤§æ•°å­—ï¼Œä¸”æ•°å­—å‘ˆ å•è°ƒé€’å¢ ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">  </span><br><span class="line">    /**</span><br><span class="line">     * å•è°ƒé€’å¢çš„æ•°å­—</span><br><span class="line">     * å•è°ƒæ•°å­—æ˜¯å„ä½æ•°å­—éƒ½æ˜¯å•è°ƒé€’å¢çš„ï¼Œæ¯”å¦‚ï¼š123ã€122ã€‚121å°±ä¸æ˜¯  213 199; 9213 8999ï¼›192 189</span><br><span class="line">     * è¾“å…¥nï¼Œè¿”å›å°äºç­‰äºnçš„æœ€å¤§å•è°ƒæ•°å­—</span><br><span class="line">     * æ€è·¯ï¼šä»å‰å¾€åéå†ï¼Œå¦‚æœå‰&gt;åï¼Œå‰-1ï¼Œåé¢å°±éƒ½å˜9</span><br><span class="line">     * é”™è¯¯ï¼š332ï¼Œåº”è¯¥æ˜¯299ã€‚è¿™ç§æƒ…å†µæ€ä¹ˆå¤„ç†ã€‚åœ¨å‘ç°å‰æ•°å¤§äºåæ•°æ—¶ï¼Œéœ€è¦å…ˆå‘å‰éå†ï¼Œ-1æ˜¯å¦ä¼šæ¯”å‰ä¸€ä½å°ï¼ˆè¿™æ ·éº»çƒ¦ï¼‰</span><br><span class="line">     * ä¿®æ­£ï¼šä»åï¼ˆä¸ªä½ï¼‰å¾€å‰éå†ï¼Œå¦‚æœå‰é¢æ¯”åé¢å¤§ï¼Œå‰é¢ä½-1ï¼Œå¹¶è®°å½•flagï¼Œå†³å®šä»å“ªä½å¼€å§‹åé¢éƒ½å˜ä¸º9</span><br><span class="line">     */</span><br><span class="line">    public static int monotoneIncreasingDigits(int n) &#123;</span><br><span class="line">        // å­˜æ•°çš„å„ä¸ªä½ï¼Œå‰é¢æ˜¯ä¸ªä½</span><br><span class="line">        List&lt;Integer&gt; nums = new ArrayList&lt;&gt;();</span><br><span class="line">        while(n &gt; 0) &#123;</span><br><span class="line">            nums.add(n % 10);</span><br><span class="line">            n /= 10;</span><br><span class="line">        &#125;</span><br><span class="line">        int flag = -1;</span><br><span class="line">        for (int i = 0; i &lt; nums.size() - 1; i++) &#123;</span><br><span class="line">            if (nums.get(i) &lt; nums.get(i + 1)) &#123;</span><br><span class="line">                nums.set(i + 1, nums.get(i + 1) - 1);</span><br><span class="line">                flag = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 0; i &lt;= flag; i ++) &#123;</span><br><span class="line">            nums.set(i, 9);</span><br><span class="line">        &#125;</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = nums.size() - 1; i &gt;= 0; i --) &#123;</span><br><span class="line">            res = res * 10 nums.get(i);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€å¤§å­æ•°ç»„å’Œ"><a href="#æœ€å¤§å­æ•°ç»„å’Œ" class="headerlink" title="æœ€å¤§å­æ•°ç»„å’Œ"></a>æœ€å¤§å­æ•°ç»„å’Œ</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œè¯·ä½ æ‰¾å‡ºä¸€ä¸ªå…·æœ‰æœ€å¤§å’Œçš„è¿ç»­å­æ•°ç»„ï¼ˆå­æ•°ç»„æœ€å°‘åŒ…å«ä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œè¿”å›å…¶æœ€å¤§å’Œã€‚</p>
<p>å­æ•°ç»„ æ˜¯æ•°ç»„ä¸­çš„ä¸€ä¸ªè¿ç»­éƒ¨åˆ†ã€‚</p>
<p>è¾“å…¥ï¼šnums = [-2,1,-3,4,-1,2,1,-5,4]<br>è¾“å‡ºï¼š6<br>è§£é‡Šï¼šè¿ç»­å­æ•°ç»„ [4,-1,2,1] çš„å’Œæœ€å¤§ï¼Œä¸º 6 ã€‚</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’ï¼ŒåŠ¨æ€è§„åˆ’å’Œè´ªå¿ƒçš„å…³ç³»ï¼šéƒ½æ˜¯å±€éƒ¨åˆ°å…¨å±€ï¼Œè´ªå¿ƒä¸éœ€è¦çŠ¶æ€è½¬ç§»ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦dpã€‚åŠ¨æ€è§„åˆ’éœ€è¦çŠ¶æ€è½¬ç§»dpã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">  </span><br><span class="line">    // æœ€å¤§å­æ•°ç»„å’Œ</span><br><span class="line">    // ç»™ä½ ä¸€ä¸ªæ•°ç»„ï¼Œè¿”å›ä¸€ä¸ªæœ€å¤§è¿ç»­å­æ•°ç»„å’Œ</span><br><span class="line">    //åŠ¨æ€è§„åˆ’ï¼Œdpè¡¨ç¤ºçš„åº”è¯¥æ˜¯è¿ç»­çš„åˆ°æŸä½ç½®çš„æœ€å¤§å€¼</span><br><span class="line">    public static int maxSubArray(int[] nums) &#123;</span><br><span class="line">        int[] dp = new int[nums.length];</span><br><span class="line">        dp[0] = nums[0];</span><br><span class="line">        int res = dp[0];</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            dp[i] = Math.max(dp[i - 1] nums[i], nums[i]);</span><br><span class="line">            res = Math.max(res, dp[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—"><a href="#æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—" class="headerlink" title="æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—"></a>æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—</h2><p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<p>ç»™å®šä¸€ä¸ªæœªç»æ’åºçš„æ•´æ•°æ•°ç»„ï¼Œæ‰¾åˆ°æœ€é•¿ä¸” è¿ç»­é€’å¢çš„å­åºåˆ—ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦ã€‚</p>
<p>è¿ç»­é€’å¢çš„å­åºåˆ— å¯ä»¥ç”±ä¸¤ä¸ªä¸‹æ ‡ l å’Œ rï¼ˆl &lt; rï¼‰ç¡®å®šï¼Œå¦‚æœå¯¹äºæ¯ä¸ª l &lt;= i &lt; rï¼Œéƒ½æœ‰ nums[i] &lt; nums[i + 1] ï¼Œé‚£ä¹ˆå­åºåˆ— [nums[l], nums[l 1], â€¦, nums[r - 1], nums[r]] å°±æ˜¯è¿ç»­é€’å¢å­åºåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªæœªç»æ’åºçš„æ•´æ•°æ•°ç»„ï¼Œè¿”å›æœ€é•¿è¿ç»­é€’å¢å­åºåˆ—çš„é•¿åº¦ï¼Œç­‰äºä¸ç®—é€’å¢</span><br><span class="line">    public static int findLengthOfLCIS(int[] nums) &#123;</span><br><span class="line">        int[] dp = new int[nums.length];</span><br><span class="line">        dp[0] = 1;</span><br><span class="line">        int res = 1;</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            if (nums[i] &gt; nums[i - 1]) dp[i] = dp[i - 1] + 1;</span><br><span class="line">            else dp[i] = 1;</span><br><span class="line">            res = Math.max(res, dp[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ†å‘ç³–æœ"><a href="#åˆ†å‘ç³–æœ" class="headerlink" title="åˆ†å‘ç³–æœ"></a>åˆ†å‘ç³–æœ</h2><p>n ä¸ªå­©å­ç«™æˆä¸€æ’ã€‚ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ ratings è¡¨ç¤ºæ¯ä¸ªå­©å­çš„è¯„åˆ†ã€‚</p>
<p>ä½ éœ€è¦æŒ‰ç…§ä»¥ä¸‹è¦æ±‚ï¼Œç»™è¿™äº›å­©å­åˆ†å‘ç³–æœï¼š</p>
<p>æ¯ä¸ªå­©å­è‡³å°‘åˆ†é…åˆ° 1 ä¸ªç³–æœã€‚<br>ç›¸é‚»ä¸¤ä¸ªå­©å­è¯„åˆ†æ›´é«˜çš„å­©å­ä¼šè·å¾—æ›´å¤šçš„ç³–æœã€‚<br>è¯·ä½ ç»™æ¯ä¸ªå­©å­åˆ†å‘ç³–æœï¼Œè®¡ç®—å¹¶è¿”å›éœ€è¦å‡†å¤‡çš„ æœ€å°‘ç³–æœæ•°ç›® ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // åˆ†å‘ç³–æœ</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªæ•°ç»„ï¼Œè¡¨ç¤ºnä¸ªå­©å­ç«™æˆä¸€æ’çš„è¯„åˆ†</span><br><span class="line">    // åˆ†å‘ç³–æœè§„åˆ™ï¼šæ¯ä¸ªå­©å­éƒ½éœ€è¦åˆ†åˆ°è‡³å°‘ä¸€ä¸ªï¼Œç›¸é‚»å­©å­è¯„åˆ†é«˜çš„éœ€è¦åˆ†åˆ°æ›´å¤šç³–æœï¼Œå¦‚æœç›¸ç­‰åˆ™æ— æ‰€è°“ï¼Œå¯ä»¥å°‘</span><br><span class="line">    // è¾“å‡ºï¼šéœ€è¦çš„æœ€å°‘ç³–æœæ•°</span><br><span class="line">    // è´ªå¿ƒï¼Œä»å¤´éå†åˆ†ç³–æœï¼Œç¬¬ä¸€ä¸ªç»™1ï¼Œå¾€åéå†å¦‚æœå‡ºç°äº†éœ€è¦åˆ†0çš„æƒ…å†µï¼Œå¾€å‰éå†ï¼Œè¿ç»­å˜å¤§çš„+1ï¼Œä¾‹å¦‚5-4-3-2-1</span><br><span class="line">    // å‡ºé”™ï¼Œæ³¨æ„ï¼šå¾€å‰éå†ä¸èƒ½æ— è„‘åŠ 1ï¼Œéœ€è¦æ˜¯åé¢å€¼çš„åŠ ä¸€ï¼Œè€Œä¸”éœ€è¦æ¯”è¾ƒä¸€ä¸‹å–å¤§çš„</span><br><span class="line">    public static int candy(int[] nums) &#123;</span><br><span class="line">        int[] candies = new int[nums.length];</span><br><span class="line">        candies[0] = 1;</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            if (nums[i] &gt; nums[i - 1]) &#123;</span><br><span class="line">                candies[i] = candies[i - 1] + 1;</span><br><span class="line">            &#125; else if (nums[i] == nums[i - 1]) &#123;</span><br><span class="line">                candies[i] = 1; //ç›¸ç­‰å°±ç»™æœ€å°‘çš„</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (candies[i - 1] == 1) &#123;</span><br><span class="line">                    candies[i] = 1;</span><br><span class="line">                    int j = i - 1;</span><br><span class="line">                    while(j &gt;= 0 &amp;&amp; nums[j] &gt; nums[j + 1]) &#123;</span><br><span class="line">                        candies[j] = Math.max(candies[j + 1] + 1, candies[j]);</span><br><span class="line">                        j --;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    candies[i] = 1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int num : candies) &#123;</span><br><span class="line">            res += num;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Arrays.toString(candies));</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æ ¹æ®èº«é«˜é‡å»ºé˜Ÿåˆ—"><a href="#æ ¹æ®èº«é«˜é‡å»ºé˜Ÿåˆ—" class="headerlink" title="æ ¹æ®èº«é«˜é‡å»ºé˜Ÿåˆ—"></a>æ ¹æ®èº«é«˜é‡å»ºé˜Ÿåˆ—</h2><p>å‡è®¾æœ‰æ‰“ä¹±é¡ºåºçš„ä¸€ç¾¤äººç«™æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ•°ç»„ people è¡¨ç¤ºé˜Ÿåˆ—ä¸­ä¸€äº›äººçš„å±æ€§ï¼ˆä¸ä¸€å®šæŒ‰é¡ºåºï¼‰ã€‚æ¯ä¸ª people[i] = [hi, ki] è¡¨ç¤ºç¬¬ i ä¸ªäººçš„èº«é«˜ä¸º hi ï¼Œå‰é¢ æ­£å¥½ æœ‰ ki ä¸ªèº«é«˜å¤§äºæˆ–ç­‰äº hi çš„äººã€‚</p>
<p>è¯·ä½ é‡æ–°æ„é€ å¹¶è¿”å›è¾“å…¥æ•°ç»„ people æ‰€è¡¨ç¤ºçš„é˜Ÿåˆ—ã€‚è¿”å›çš„é˜Ÿåˆ—åº”è¯¥æ ¼å¼åŒ–ä¸ºæ•°ç»„ queue ï¼Œå…¶ä¸­ queue[j] = [hj, kj] æ˜¯é˜Ÿåˆ—ä¸­ç¬¬ j ä¸ªäººçš„å±æ€§ï¼ˆqueue[0] æ˜¯æ’åœ¨é˜Ÿåˆ—å‰é¢çš„äººï¼‰ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒï¼Œéš¾ç‚¹åœ¨äºæ€ä¹ˆæ€»ç»“å‡ºè§„å¾‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ ¹æ®èº«é«˜é‡å»ºé˜Ÿåˆ—</span><br><span class="line">    // ç»™å®šä¸€ä¸ªæ•°ç»„çš„æ•°ç»„[[5,1],[6,2],[7,3]]è¡¨ç¤ºä¸€äº›äººï¼Œ[5,1]ä¸­5è¡¨ç¤ºèº«é«˜ï¼Œ1è¡¨ç¤ºå‰é¢æœ‰ä¸€ä¸ªå¤§äºç­‰äºèº«é«˜5çš„äºº</span><br><span class="line">    // è¾“å…¥çš„æ•°ç»„æ˜¯ä¹±åºçš„ï¼Œè¾“å‡ºæ’å¥½åºçš„æ•°ç»„</span><br><span class="line">    // æ€è·¯ï¼šå…³é”®åœ¨äºå…ˆæŒ‰ç…§èº«é«˜ä»é«˜åˆ°ä½æ’åºï¼Œå¦‚æœèº«é«˜ç›¸åŒï¼Œåˆ™æŒ‰ç…§å‰é¢çš„äººæ•°å€¼ä»å°åˆ°å¤§æ’åºã€‚ç„¶åï¼Œä½¿ç”¨ä¸€ä¸ªåˆ—è¡¨ï¼ˆæˆ–æ•°ç»„ï¼‰æ¥ä¾æ¬¡æ”¾ç½®æ¯ä¸ªäººã€‚å¯¹äºæ¯ä¸ªäººï¼Œæˆ‘ä»¬æ ¹æ®å‰é¢äººæ•°å€¼å°†å…¶æ’å…¥åˆ°ç»“æœåˆ—è¡¨ä¸­çš„æ­£ç¡®ä½ç½®ã€‚</span><br><span class="line">    // è¾“å…¥ï¼š&#123;&#123;7, 0&#125;, &#123;4, 4&#125;, &#123;7, 1&#125;, &#123;5, 0&#125;, &#123;6, 1&#125;, &#123;5, 2&#125;&#125;</span><br><span class="line">    // æ’åºåï¼š[[7, 0], [7, 1], [6, 1], [5, 0], [5, 2], [4, 4]]</span><br><span class="line">    // ä¸€ä¸ªä¸€ä¸ªæ’å…¥ï¼š[5, 0], [7, 0], [5, 2], [6, 1], [4, 4], [7, 1]</span><br><span class="line">    public int[][] reconstructQueue(int[][] people) &#123;</span><br><span class="line">        // æŒ‰ç…§èº«é«˜é™åºæ’åˆ—ï¼Œèº«é«˜ç›¸åŒçš„åˆ™æŒ‰ç…§å‰é¢äººæ•°å‡åºæ’åˆ—</span><br><span class="line">        // è¿™é‡Œæ’çš„æ˜¯int[]ï¼Œä¸æ˜¯intï¼Œæ‰€ä»¥å¯ä»¥ã€‚</span><br><span class="line">        // Comparatoræ’åºï¼Œa-bè¡¨ç¤ºæ­£åºï¼Œb-aè¡¨ç¤ºå€’å™</span><br><span class="line">        Arrays.sort(people, (a, b) -&gt; &#123;</span><br><span class="line">            if (a[0] == b[0]) &#123;</span><br><span class="line">                return a[1] - b[1];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return b[0] - a[0];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        List&lt;int[]&gt; peopleList = new ArrayList&lt;&gt;();</span><br><span class="line">        // éå†æ’åºåçš„æ•°ç»„ï¼Œæ ¹æ®å‰é¢äººæ•°æ’å…¥åˆ°é˜Ÿåˆ—ä¸­çš„é€‚å½“ä½ç½®</span><br><span class="line">        for (int[] person : people) &#123;</span><br><span class="line">            peopleList.add(person[1], person);</span><br><span class="line">        &#125;</span><br><span class="line">        return peopleList.toArray(new int[peopleList.size()][]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆå¹¶åŒºé—´"><a href="#åˆå¹¶åŒºé—´" class="headerlink" title="åˆå¹¶åŒºé—´"></a>åˆå¹¶åŒºé—´</h2><p>ä»¥æ•°ç»„ intervals è¡¨ç¤ºè‹¥å¹²ä¸ªåŒºé—´çš„é›†åˆï¼Œå…¶ä¸­å•ä¸ªåŒºé—´ä¸º intervals[i] = [starti, endi] ã€‚è¯·ä½ åˆå¹¶æ‰€æœ‰é‡å çš„åŒºé—´ï¼Œå¹¶è¿”å› ä¸€ä¸ªä¸é‡å çš„åŒºé—´æ•°ç»„ï¼Œè¯¥æ•°ç»„éœ€æ°å¥½è¦†ç›–è¾“å…¥ä¸­çš„æ‰€æœ‰åŒºé—´ ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // åˆå¹¶åŒºé—´</span><br><span class="line">    // è¾“å…¥ï¼šint[][]ï¼Œæ¯ä¸ªint[]è¡¨ç¤ºä¸€ä¸ªåŒºé—´ï¼Œè¿™äº›åŒºé—´æœ‰é‡å </span><br><span class="line">    // è¿”å›ï¼šé‡å åŒºé—´åˆå¹¶åçš„ä¸é‡å çš„åŒºé—´æ•°ç»„ï¼Œè¾¹ç•Œç›¸åŒä¹Ÿå¯åˆå¹¶</span><br><span class="line">    // ä¾‹å¦‚ï¼šè¾“å…¥ï¼š[1,3],[2,6],[8,10]  è¾“å‡ºï¼š[1,6],[8,10]</span><br><span class="line">    // æ³¨æ„ï¼šæ’åºä¹‹åï¼Œå‰ä¸€ä¸ªçš„å³è¾¹ç•Œå¯èƒ½æ¯”åä¸€ä¸ªå³è¾¹ç•Œå¤§</span><br><span class="line">    public int[][] merge(int[][] nums) &#123;</span><br><span class="line">        // é¦–å…ˆæ ¹æ®ç¬¬ä¸€ä¸ªæ•°æ­£åºæ’åºï¼Œå¦‚æœç›¸åŒæ ¹æ®ç¬¬äºŒä¸ªæ•°æ­£åºæ’åº</span><br><span class="line">        Arrays.sort(nums, (a, b) -&gt; &#123;</span><br><span class="line">            if (a[0] == b[0]) &#123;</span><br><span class="line">                return a[1] - b[1];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return a[0] - b[0];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        int[] lastSec = nums[0];</span><br><span class="line">        List&lt;int[]&gt; secList = new ArrayList&lt;&gt;();</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            // ä¸åˆå¹¶æ¡ä»¶</span><br><span class="line">            if (lastSec[1] &lt; nums[i][0]) &#123;</span><br><span class="line">                secList.add(lastSec);</span><br><span class="line">                lastSec = nums[i];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // åˆå¹¶</span><br><span class="line">                lastSec[1] = Math.max(lastSec[1], nums[i][1]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        secList.add(lastSec);</span><br><span class="line">        int[][] res = secList.toArray(new int[secList.size()][]);</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ"><a href="#ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ" class="headerlink" title="ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ"></a>ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ</h2><p>æœ‰ä¸€äº›çƒå½¢æ°”çƒè´´åœ¨ä¸€å µç”¨ XY å¹³é¢è¡¨ç¤ºçš„å¢™é¢ä¸Šã€‚å¢™é¢ä¸Šçš„æ°”çƒè®°å½•åœ¨æ•´æ•°æ•°ç»„ points ï¼Œå…¶ä¸­points[i] = [xstart, xend] è¡¨ç¤ºæ°´å¹³ç›´å¾„åœ¨ xstart å’Œ xendä¹‹é—´çš„æ°”çƒã€‚ä½ ä¸çŸ¥é“æ°”çƒçš„ç¡®åˆ‡ y åæ ‡ã€‚</p>
<p>ä¸€æ”¯å¼“ç®­å¯ä»¥æ²¿ç€ x è½´ä»ä¸åŒç‚¹ å®Œå…¨å‚ç›´ åœ°å°„å‡ºã€‚åœ¨åæ ‡ x å¤„å°„å‡ºä¸€æ”¯ç®­ï¼Œè‹¥æœ‰ä¸€ä¸ªæ°”çƒçš„ç›´å¾„çš„å¼€å§‹å’Œç»“æŸåæ ‡ä¸º xstartï¼Œxendï¼Œ ä¸”æ»¡è¶³  xstart â‰¤ x â‰¤ xendï¼Œåˆ™è¯¥æ°”çƒä¼šè¢« å¼•çˆ† ã€‚å¯ä»¥å°„å‡ºçš„å¼“ç®­çš„æ•°é‡ æ²¡æœ‰é™åˆ¶ ã€‚ å¼“ç®­ä¸€æ—¦è¢«å°„å‡ºä¹‹åï¼Œå¯ä»¥æ— é™åœ°å‰è¿›ã€‚</p>
<p>ç»™ä½ ä¸€ä¸ªæ•°ç»„ points ï¼Œè¿”å›å¼•çˆ†æ‰€æœ‰æ°”çƒæ‰€å¿…é¡»å°„å‡ºçš„ æœ€å° å¼“ç®­æ•° ã€‚</p>
<p>è¾“å…¥ï¼špoints = [[10,16],[2,8],[1,6],[7,12]]<br>è¾“å‡ºï¼š2</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ åŒºé—´é—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // ç”¨æœ€å°‘æ•°é‡çš„ç®­å¼•çˆ†æ°”çƒ</span><br><span class="line">    // æ°”çƒåœ¨å¹³é¢ä¸Šï¼Œä¸€ä¸ªæ°”çƒæœ‰xè½´çš„åæ ‡ï¼Œç®­ä»xè½´æŸä¸ªä½ç½®å°„å‡ºã€‚æ±‚æœ€å°‘éœ€è¦å°„å¤šå°‘ç®­</span><br><span class="line">    // è¾“å…¥ï¼šint[][]è¡¨ç¤ºæ°”çƒçš„åæ ‡</span><br><span class="line">    // æ€è·¯ï¼šå…¶å®å’Œåˆå¹¶åŒºé—´æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œæœ€ååˆå¹¶å®Œå˜æˆå‡ ä¸ªåŒºé—´ï¼Œå°±æ˜¯å‡ ä¸ªç®­ ? å¹¶ä¸æ˜¯ï¼Œåº”è¯¥æ˜¯æœ‰å‡ ä¸ªç›¸äº¤åŒºåŸŸï¼Œå°±æ˜¯å‡ ä¸ªç®­ã€‚</span><br><span class="line">    public static int findMinArrowShots(int[][] nums) &#123;</span><br><span class="line">        // 1.é¦–å…ˆæ’åº</span><br><span class="line">        Arrays.sort(nums, (a, b) -&gt; &#123;</span><br><span class="line">            // ä¸‹é¢è¿™æ ·ä¼šè¶Šç•Œ</span><br><span class="line">            // if (a[0] == b[0]) return a[1] - b[1];</span><br><span class="line">            // else return a[0] - b[0];</span><br><span class="line">            // åªæ ¹æ®endæ’åºå°±è¡Œ</span><br><span class="line">            if (a[1] &gt; b[1]) &#123;</span><br><span class="line">                    return 1;</span><br><span class="line">                &#125; else if (a[1] &lt; b[1]) &#123;</span><br><span class="line">                    return -1;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    return 0;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        // 2.éå†å¯»æ‰¾åˆå¹¶å¥‘æœº</span><br><span class="line">        // ä¸Šä¸€ä¸ªé‡åˆåŒºé—´ï¼Œå¯ä»¥åˆå¹¶çš„æ¡ä»¶å˜ä¸¥æ ¼ï¼Œåªæœ‰å’Œè¿™ä¸ªé‡åˆåŒºé—´é‡åˆï¼Œæ‰èƒ½åŒä¸€æ ¹ç®­å°„çˆ†</span><br><span class="line">        int[] lastSec = nums[0];</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            if (lastSec[1] &gt;= nums[i][0]) &#123;</span><br><span class="line">                // å¯ä»¥åˆå¹¶</span><br><span class="line">                lastSec[0] = Math.max(lastSec[0], nums[i][0]);</span><br><span class="line">                lastSec[1] = Math.min(lastSec[1], nums[i][1]);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // ä¸èƒ½åˆå¹¶</span><br><span class="line">                res ++;</span><br><span class="line">                lastSec = nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æ— é‡å åŒºé—´"><a href="#æ— é‡å åŒºé—´" class="headerlink" title="æ— é‡å åŒºé—´"></a>æ— é‡å åŒºé—´</h2><p>ç»™å®šä¸€ä¸ªåŒºé—´çš„é›†åˆ intervals ï¼Œå…¶ä¸­ intervals[i] = [starti, endi] ã€‚è¿”å› éœ€è¦ç§»é™¤åŒºé—´çš„æœ€å°æ•°é‡ï¼Œä½¿å‰©ä½™åŒºé—´äº’ä¸é‡å  ã€‚</p>
<p>è¾“å…¥: intervals = [[1,2],[2,3],[3,4],[1,3]]<br>è¾“å‡º: 1<br>è§£é‡Š: ç§»é™¤ [1,3] åï¼Œå‰©ä¸‹çš„åŒºé—´æ²¡æœ‰é‡å ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒã€åŒºé—´é—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ— é‡å åŒºé—´</span><br><span class="line">    // è¾“å…¥ä¸€ç»„åŒºé—´ï¼Œè¿”å›æœ€å°‘éœ€è¦ç§»é™¤å‡ ä¸ªåŒºé—´æ‰èƒ½ä½¿å‰©ä½™åŒºé—´äº’ä¸é‡å ï¼ŒåŒºé—´è¾¹ç•Œç›¸åŒä¹Ÿä¸ç®—é‡å </span><br><span class="line">    // æ€è·¯ï¼šå…¶å®æ²¡é‚£ä¹ˆå¤æ‚ï¼Œå°±æ˜¯å°„ç®­é—®é¢˜çš„åé¢ï¼Œæ€è€ƒå‡ ä¸ªcaseå°±èƒ½æ˜ç™½ï¼Œä½†ä½ éœ€è¦æ³¨æ„æ°”çƒæ˜¯è¾¹ç•Œç›¸åŒå¯ä»¥å°„ç ´ï¼Œè¿™é‡Œä¸è¡Œã€‚</span><br><span class="line">    public static int eraseOverlapIntervals(int[][] nums) &#123;</span><br><span class="line">        // 1.é¦–å…ˆæ’åº</span><br><span class="line">        Arrays.sort(nums, (a, b) -&gt; &#123;</span><br><span class="line">            if (a[0] == b[0]) return a[1] - b[1];</span><br><span class="line">            else return a[0] - b[0];</span><br><span class="line">        &#125;);</span><br><span class="line">        // 2.éå†å¯»æ‰¾åˆå¹¶å¥‘æœº</span><br><span class="line">        // ä¸Šä¸€ä¸ªé‡åˆåŒºé—´ï¼Œå¯ä»¥åˆå¹¶çš„æ¡ä»¶å˜ä¸¥æ ¼ï¼Œåªæœ‰å’Œè¿™ä¸ªé‡åˆåŒºé—´é‡åˆï¼Œæ‰èƒ½åŒä¸€æ ¹ç®­å°„çˆ†</span><br><span class="line">        int[] lastSec = nums[0];</span><br><span class="line">        int res = 0;</span><br><span class="line">        for (int i = 1; i &lt; nums.length; i ++) &#123;</span><br><span class="line">            if (lastSec[1] &gt; nums[i][0]) &#123;</span><br><span class="line">                // å¯ä»¥åˆå¹¶</span><br><span class="line">                lastSec[0] = Math.max(lastSec[0], nums[i][0]);</span><br><span class="line">                lastSec[1] = Math.min(lastSec[1], nums[i][1]);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // ä¸èƒ½åˆå¹¶</span><br><span class="line">                res ++;</span><br><span class="line">                lastSec = nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return nums.length - res - 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ’åˆ†å­—æ¯åŒºé—´"><a href="#åˆ’åˆ†å­—æ¯åŒºé—´" class="headerlink" title="åˆ’åˆ†å­—æ¯åŒºé—´"></a>åˆ’åˆ†å­—æ¯åŒºé—´</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² s ã€‚æˆ‘ä»¬è¦æŠŠè¿™ä¸ªå­—ç¬¦ä¸²åˆ’åˆ†ä¸ºå°½å¯èƒ½å¤šçš„ç‰‡æ®µï¼ŒåŒä¸€å­—æ¯æœ€å¤šå‡ºç°åœ¨ä¸€ä¸ªç‰‡æ®µä¸­ã€‚</p>
<p>æ³¨æ„ï¼Œåˆ’åˆ†ç»“æœéœ€è¦æ»¡è¶³ï¼šå°†æ‰€æœ‰åˆ’åˆ†ç»“æœæŒ‰é¡ºåºè¿æ¥ï¼Œå¾—åˆ°çš„å­—ç¬¦ä¸²ä»ç„¶æ˜¯ s ã€‚</p>
<p>è¿”å›ä¸€ä¸ªè¡¨ç¤ºæ¯ä¸ªå­—ç¬¦ä¸²ç‰‡æ®µçš„é•¿åº¦çš„åˆ—è¡¨ã€‚</p>
<p>è¾“å…¥ï¼šs = â€œababcbacadefegdehijhklijâ€<br>è¾“å‡ºï¼š[9,7,8]<br>è§£é‡Šï¼š<br>åˆ’åˆ†ç»“æœä¸º â€œababcbacaâ€ã€â€defegdeâ€ã€â€hijhklijâ€ ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒã€åŒºé—´é—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // åˆ’åˆ†å­—æ¯åŒºé—´</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºå•è¯ã€‚è¦å°†è¿™ä¸ªå•è¯åˆ’åˆ†ä¸ºå°½å¯èƒ½å¤šçš„ç‰‡æ®µï¼ŒåŒä¸€ä¸ªå­—æ¯æœ€å¤šå‡ºç°åœ¨ä¸€ä¸ªç‰‡æ®µä¸­ã€‚</span><br><span class="line">    // å¹¶ä¸”ï¼Œæ‰€æœ‰ç‰‡æ®µæŒ‰é¡ºåºè¿æ¥ä¹‹åï¼Œè¿˜æ˜¯è¿™ä¸ªå•è¯</span><br><span class="line">    // è¿”å›è¡¨ç¤ºæ¯ä¸ªå­—ç¬¦ä¸²ç‰‡æ®µé•¿åº¦çš„åˆ—è¡¨</span><br><span class="line">    // æ€è·¯ï¼šindexOfåªèƒ½è·å–å­—ç¬¦çš„ç¬¬ä¸€ä¸ªä½ç½®ç´¢å¼•ã€‚è¿˜æ˜¯éå†ç”¨mapè®°å½•ä¸€ä¸‹å­—ç¬¦çš„æœ€å¤§ç´¢å¼•ã€‚ç„¶åéå†ï¼Œå¹¶æ›´æ–°è¾¹ç•Œï¼Œå¦‚æœå’Œè¾¹ç•Œç›¸ç­‰åˆ™æˆä¸€ä¸ªç‰‡æ®µã€‚</span><br><span class="line">    public static List&lt;Integer&gt; partitionLabels(String s) &#123;</span><br><span class="line">        Map&lt;Character, Integer&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; s.length(); i++) &#123;</span><br><span class="line">            map.put(s.charAt(i), i);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Integer&gt; resList = new ArrayList&lt;&gt;();</span><br><span class="line">        int start = 0;</span><br><span class="line">        int end = 0;</span><br><span class="line">        for (int i = 0; i &lt; s.length(); i ++) &#123;</span><br><span class="line">            end = Math.max(map.get(s.charAt(i)), end);</span><br><span class="line">            // ç­‰äºè¾¹ç•Œï¼Œè¡¨ç¤ºå¯ä»¥åˆ†å‰²</span><br><span class="line">            if (i == end) &#123;</span><br><span class="line">                resList.add(end - start 1);</span><br><span class="line">                start = end 1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return resList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ¨¡æ‹Ÿè¡Œèµ°æœºå™¨äºº"><a href="#æ¨¡æ‹Ÿè¡Œèµ°æœºå™¨äºº" class="headerlink" title="æ¨¡æ‹Ÿè¡Œèµ°æœºå™¨äºº"></a>æ¨¡æ‹Ÿè¡Œèµ°æœºå™¨äºº</h2><p>æœºå™¨äººåœ¨ä¸€ä¸ªæ— é™å¤§å°çš„ XY ç½‘æ ¼å¹³é¢ä¸Šè¡Œèµ°ï¼Œä»ç‚¹ (0, 0) å¤„å¼€å§‹å‡ºå‘ï¼Œé¢å‘åŒ—æ–¹ã€‚è¯¥æœºå™¨äººå¯ä»¥æ¥æ”¶ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„å‘½ä»¤ commands ï¼š</p>
<p>-2 ï¼šå‘å·¦è½¬ 90 åº¦<br>-1 ï¼šå‘å³è½¬ 90 åº¦<br>1 &lt;= x &lt;= 9 ï¼šå‘å‰ç§»åŠ¨ x ä¸ªå•ä½é•¿åº¦<br>åœ¨ç½‘æ ¼ä¸Šæœ‰ä¸€äº›æ ¼å­è¢«è§†ä¸ºéšœç¢ç‰© obstacles ã€‚ç¬¬ i ä¸ªéšœç¢ç‰©ä½äºç½‘æ ¼ç‚¹  obstacles[i] = (xi, yi) ã€‚</p>
<p>æœºå™¨äººæ— æ³•èµ°åˆ°éšœç¢ç‰©ä¸Šï¼Œå®ƒå°†ä¼šåœç•™åœ¨éšœç¢ç‰©çš„å‰ä¸€ä¸ªç½‘æ ¼æ–¹å—ä¸Šï¼Œå¹¶ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå‘½ä»¤ã€‚</p>
<p>è¿”å›æœºå™¨äººè·ç¦»åŸç‚¹çš„ æœ€å¤§æ¬§å¼è·ç¦» çš„ å¹³æ–¹ ã€‚ï¼ˆå³ï¼Œå¦‚æœè·ç¦»ä¸º 5 ï¼Œåˆ™è¿”å› 25 ï¼‰</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒæ¨¡æ‹Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ¨¡æ‹Ÿè¡Œèµ°æœºå™¨äºº</span><br><span class="line">    // æœºå™¨äººåœ¨æ— é™å¤§å¹³é¢è¡Œèµ°ï¼Œåˆå§‹ä½ç½®åœ¨(0,0)ï¼Œåˆå§‹æœå‘æ˜¯å‘åŒ—ï¼Œæ¥æ”¶æŒ‡ä»¤ï¼š-2å‘å·¦è½¬90åº¦ -1å‘å³è½¬90åº¦ 1-9è¡¨ç¤ºèµ°å¤šå°‘æ­¥ã€‚</span><br><span class="line">    // æœ‰éšœç¢ç‰©ï¼Œæœºå™¨äººèµ°ä¸ä¸Šå»ï¼Œéœ€è¦åŸåœ°è¸æ­¥ç›´åˆ°è½¬å‘ï¼Œæ±‚è¾¾åˆ°ç‚¹ç‚¹æœ€å¤§æ¬§å¼è·ç¦»(xå¹³æ–¹+yå¹³æ–¹)</span><br><span class="line">    // obstaclesè¡¨ç¤ºéšœç¢ç‰©ä½ç½®</span><br><span class="line">    // æ€è·¯ï¼šå…¶å®ä¸éš¾ï¼Œå°±æ˜¯éå†æŒ‡ä»¤ï¼Œåªæ˜¯éœ€è¦æ§åˆ¶å¥½æ–¹å‘</span><br><span class="line">    public int robotSim(int[] commands, int[][] obstacles) &#123;</span><br><span class="line">        // å®šä¹‰è½¬å‘ ä¸œå—è¥¿åŒ—</span><br><span class="line">        int[][] directs = new int[][]&#123;&#123;1, 0&#125;,&#123;0, -1&#125;,&#123;-1, 0&#125;,&#123;0, 1&#125;&#125;;</span><br><span class="line">        int res = 0;</span><br><span class="line">        int curX = 0;</span><br><span class="line">        int curY = 0;</span><br><span class="line">        int dir = 3; //åˆå§‹æœå‘åŒ—</span><br><span class="line">        // å®šä¹‰éšœç¢ç‰©ä½ç½®set</span><br><span class="line">        Set&lt;String&gt; obstacleSet = new HashSet&lt;&gt;();</span><br><span class="line">        for (int[] obs : obstacles) &#123;</span><br><span class="line">            obstacleSet.add(obs[0] &quot;:&quot; obs[1]);</span><br><span class="line">        &#125;</span><br><span class="line">        for (int command : commands) &#123;</span><br><span class="line">            if (command == -2) &#123;</span><br><span class="line">                dir = dir - 1 == -1? 3 : dir - 1;</span><br><span class="line">            &#125; else if (command == -1) &#123;</span><br><span class="line">                dir = dir 1 == 4? 0 : dir 1;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                while (command -- &gt; 0) &#123;</span><br><span class="line">                    int nextX = curX directs[dir][0];</span><br><span class="line">                    int nextY = curY directs[dir][1];</span><br><span class="line">                    String nextPos = nextX &quot;:&quot; nextY;</span><br><span class="line">                    if (obstacleSet.contains(nextPos)) break;</span><br><span class="line">                    curX = nextX;</span><br><span class="line">                    curY = nextY;</span><br><span class="line">                    res = (int)Math.max(res, Math.pow(curX, 2) Math.pow(curY, 2));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŠ æ²¹ç«™"><a href="#åŠ æ²¹ç«™" class="headerlink" title="åŠ æ²¹ç«™"></a>åŠ æ²¹ç«™</h2><p>åœ¨ä¸€æ¡ç¯è·¯ä¸Šæœ‰ n ä¸ªåŠ æ²¹ç«™ï¼Œå…¶ä¸­ç¬¬ i ä¸ªåŠ æ²¹ç«™æœ‰æ±½æ²¹ gas[i] å‡ã€‚</p>
<p>ä½ æœ‰ä¸€è¾†æ²¹ç®±å®¹é‡æ— é™çš„çš„æ±½è½¦ï¼Œä»ç¬¬ i ä¸ªåŠ æ²¹ç«™å¼€å¾€ç¬¬ i+1 ä¸ªåŠ æ²¹ç«™éœ€è¦æ¶ˆè€—æ±½æ²¹ cost[i] å‡ã€‚ä½ ä»å…¶ä¸­çš„ä¸€ä¸ªåŠ æ²¹ç«™å‡ºå‘ï¼Œå¼€å§‹æ—¶æ²¹ç®±ä¸ºç©ºã€‚</p>
<p>ç»™å®šä¸¤ä¸ªæ•´æ•°æ•°ç»„ gas å’Œ cost ï¼Œå¦‚æœä½ å¯ä»¥æŒ‰é¡ºåºç»•ç¯è·¯è¡Œé©¶ä¸€å‘¨ï¼Œåˆ™è¿”å›å‡ºå‘æ—¶åŠ æ²¹ç«™çš„ç¼–å·ï¼Œå¦åˆ™è¿”å› -1 ã€‚å¦‚æœå­˜åœ¨è§£ï¼Œåˆ™ ä¿è¯ å®ƒæ˜¯ å”¯ä¸€ çš„ã€‚</p>
<p>è¾“å…¥: gas = [1,2,3,4,5], cost = [3,4,5,1,2]<br>è¾“å‡º: 3</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // åŠ æ²¹ç«™</span><br><span class="line">    // è¾“å…¥ï¼šcostæ•°ç»„è¡¨ç¤ºç¬¬iä¸ªåŠ æ²¹ç«™åˆ°i+1ä¸ªåŠ æ²¹ç«™éœ€è¦çš„æ±½æ²¹ï¼Œgasè¡¨ç¤ºç¬¬iä¸ªåŠ æ²¹ç«™çš„æ±½æ²¹</span><br><span class="line">    // åŠ æ²¹ç«™æ˜¯ä¸ªç¯ï¼Œæ²¹ç®±æ— é™ï¼Œå¼€å§‹æ—¶é‚®ç®±ä¸ºç©ºï¼Œè¿”å›ä»å“ªä¸ªåŠ æ²¹ç«™å‡ºå‘èƒ½ç»•ä¸€åœˆï¼Œç­”æ¡ˆå”¯ä¸€ï¼Œä¸èƒ½è¿”å›-1</span><br><span class="line">    // è¾“å…¥ï¼š1,2,3,4,5 å’Œ 3,4,5,1,2ï¼Œè¿”å›3</span><br><span class="line">    // æ€è·¯ï¼šremainæ•°ç»„è¡¨ç¤ºåªç”¨è¿™ä¸ªåŠ æ²¹ç«™çš„æ²¹åˆ°ä¸‹ä¸€ä¸ªå¯ä»¥å‰©ä¸‹å¤šå°‘ï¼Œæ‰¾åˆ°è´Ÿçš„ï¼Œå‘å‰éå†ï¼Œåˆ°å“ªå¯ä»¥æ»¡è¶³</span><br><span class="line">    // åº”è¯¥å…ˆæ‰¾åˆ°ä¸€ä¸ªåº”è¯¥å¼€å§‹éå†çš„è´Ÿç‚¹ï¼šè¿™ä¸ªç‚¹æ˜¯ä»0ç‚¹å¼€å§‹ç´¯è®¡æ²¹é‡æœ€å°‘çš„åœ°æ–¹ã€‚ç”»ä¸ªç´¯è®¡æ²¹é‡æ›²çº¿å°±å¥½äº†ï¼Œä»0å¼€å§‹å’Œä»å…¶ä»–åœ°æ–¹å¼€å§‹æ›²çº¿å½¢çŠ¶éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ— éæ˜¯ä¸Šä¸‹å¹³ç§»</span><br><span class="line">    // å› ä¸ºæœ‰è§£ä¹Ÿåªæœ‰ä¸€ä¸ªè§£ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯ç´¯è®¡é‚®ç®±æœ€å°‘çš„ç‚¹çš„ä¸‹ä¸€ä¸ªç‚¹å¼€å§‹æ‰è¡Œã€‚æ— è§£æƒ…å†µï¼šcostæ€»å…±æ¯”gasè¿˜å¤šï¼Œä»ç»“ä½™æ›²çº¿æ¥çœ‹å°±æ˜¯å›ºå®šå‡ºå‘ç‚¹çºµåæ ‡ä¸ºå‡ºå‘ç‚¹ç»“ä½™é‡æ˜¯ï¼Œæ›²çº¿è¿˜åœ¨xè½´ä¸‹</span><br><span class="line">    // [2,0,0,0] [0,1,0,0]  å¼€å§‹ç‚¹æ˜¯0åˆ™å“ªéƒ½å»ä¸äº†ï¼Œè¿èƒŒä¸Šé¢çš„è§„å¾‹ã€‚</span><br><span class="line">    // è¿˜æ˜¯å¾—ç”¨è¿™ç§ã€‚ç´¯è®¡æ²¹é‡æ–°ä½ä¸ä»£è¡¨è¡Œä¸é€šã€‚</span><br><span class="line">    public int canCompleteCircuit(int[] gas, int[] cost) &#123;</span><br><span class="line">        // ä¸ºäº†é€‚é…[0,2,0,0,0] [0,0,1,0,0]æƒ…å†µï¼Œå°†resè®¾å®šä¸ºgasæœ€å¤šçš„ç‚¹ã€‚ä¸è¡Œï¼Œå»æ‰</span><br><span class="line">        int res = 0;</span><br><span class="line">        int maxGas = Integer.MIN_VALUE;</span><br><span class="line">        // for (int i = 0; i &lt; gas.length; i ++) &#123;</span><br><span class="line">        //     if (gas[i] &gt; maxGas) &#123;</span><br><span class="line">        //         res = i;</span><br><span class="line">        //         maxGas= gas[i];</span><br><span class="line">        //     &#125;</span><br><span class="line">        // &#125;</span><br><span class="line">        int totalSum = 0;</span><br><span class="line">        int currentSum = 0;</span><br><span class="line">        for (int i = 0; i &lt; gas.length; i++) &#123;</span><br><span class="line">            int netGas = gas[i] - cost[i];</span><br><span class="line">            totalSum += netGas;</span><br><span class="line">            currentSum += netGas;</span><br><span class="line">            // å¦‚æœå½“å‰ç´¯è®¡çš„å‡€æ²¹é‡å°äº0ï¼Œé‚£ä¹ˆä¸èƒ½ä»ä¹‹å‰çš„èµ·ç‚¹å‡ºå‘ï¼Œéœ€è¦å°†èµ·ç‚¹è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªç«™ç‚¹</span><br><span class="line">            if (currentSum &lt; 0) &#123;</span><br><span class="line">                res = i + 1;</span><br><span class="line">                currentSum = 0; // é‡ç½®å½“å‰ç´¯è®¡æ²¹é‡</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // å¦‚æœæ€»æ²¹é‡å°äºæ€»æˆæœ¬ï¼Œæ— æ³•ç»•ç¯è¡Œé©¶</span><br><span class="line">        if (totalSum &lt; 0) &#123;</span><br><span class="line">            return -1;</span><br><span class="line">        &#125;</span><br><span class="line">        // ç”±äºåŠ æ²¹ç«™æ˜¯ç¯å½¢çš„ï¼Œå¦‚æœå¯ä»¥ç»•è¡Œæ•´ä¸ªç¯è·¯ï¼Œè¿”å›è®¡ç®—å‡ºçš„èµ·ç‚¹</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç›‘æ§äºŒå‰æ ‘"><a href="#ç›‘æ§äºŒå‰æ ‘" class="headerlink" title="ç›‘æ§äºŒå‰æ ‘"></a>ç›‘æ§äºŒå‰æ ‘</h2><p>ç»™å®šä¸€ä¸ªäºŒå‰æ ‘ï¼Œæˆ‘ä»¬åœ¨æ ‘çš„èŠ‚ç‚¹ä¸Šå®‰è£…æ‘„åƒå¤´ã€‚<br>èŠ‚ç‚¹ä¸Šçš„æ¯ä¸ªæ‘„å½±å¤´éƒ½å¯ä»¥ç›‘è§†å…¶çˆ¶å¯¹è±¡ã€è‡ªèº«åŠå…¶ç›´æ¥å­å¯¹è±¡ã€‚<br>è®¡ç®—ç›‘æ§æ ‘çš„æ‰€æœ‰èŠ‚ç‚¹æ‰€éœ€çš„æœ€å°æ‘„åƒå¤´æ•°é‡ã€‚</p>
<p>æ ‡ç­¾ï¼šè´ªå¿ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Definition for a binary tree node.</span><br><span class="line"> * public class TreeNode &#123;</span><br><span class="line"> *     int val;</span><br><span class="line"> *     TreeNode left;</span><br><span class="line"> *     TreeNode right;</span><br><span class="line"> *     TreeNode() &#123;&#125;</span><br><span class="line"> *     TreeNode(int val) &#123; this.val = val; &#125;</span><br><span class="line"> *     TreeNode(int val, TreeNode left, TreeNode right) &#123;</span><br><span class="line"> *         this.val = val;</span><br><span class="line"> *         this.left = left;</span><br><span class="line"> *         this.right = right;</span><br><span class="line"> *     &#125;</span><br><span class="line"> * &#125;</span><br><span class="line"> */</span><br><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // ç›‘æ§äºŒå‰æ ‘</span><br><span class="line">    // ç»™å®šä¸€ä¸ªäºŒå‰æ ‘ï¼Œè¦åœ¨äºŒå‰æ ‘ä¸Šè£…æ‘„åƒå¤´ï¼Œæ¯ä¸ªæ‘„åƒå¤´å¯ä»¥ç›‘æ§å½“å‰èŠ‚ç‚¹ã€çˆ¶èŠ‚ç‚¹ã€ç›´æ¥å­å¯¹è±¡ï¼Œè¿”å›æœ€å°‘éœ€è¦å‡ ä¸ªæ‘„åƒå¤´</span><br><span class="line">    // æ€è·¯ï¼šå±€éƒ¨æœ€ä¼˜åˆ°å…¨å±€æœ€ä¼˜ï¼Œå°±æ˜¯æ‘„åƒå¤´å°½é‡å¾€å¤´èŠ‚ç‚¹è€Œä¸æ˜¯å¶å­èŠ‚ç‚¹æ”¾ï¼Œæ‰€ä»¥æ˜¯ååºéå†</span><br><span class="line">    // ä¸ºä»€ä¹ˆä¸æ˜¯å±‚åºéå†ï¼šè¿™é‡Œæ¶‰åŠåˆ°çŠ¶æ€è½¬ç§»ï¼Œçˆ¶èŠ‚ç‚¹çš„çŠ¶æ€ä¾èµ–äºå¶å­ç»“ç‚¹çš„çŠ¶æ€ï¼Œå¹¶ä¸”å±‚åºæ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œä¸åˆé€‚ã€‚</span><br><span class="line">    // çŠ¶æ€è½¬ç§»ï¼šä¸‰ç§çŠ¶æ€ï¼šæœ‰æ‘„åƒå¤´ã€æ— æ‘„åƒå¤´æœ‰è¦†ç›–ã€æ— æ‘„åƒå¤´æ— è¦†ç›–ã€‚ç©ºèŠ‚ç‚¹åº”è¯¥æ˜¯æ— æ‘„åƒå¤´æœ‰è¦†ç›–</span><br><span class="line">    public int minCameraCover(TreeNode root) &#123;</span><br><span class="line">        // æ³¨æ„ï¼šå¦‚æœæ ¹èŠ‚ç‚¹æ˜¯3ï¼Œæ ¹èŠ‚ç‚¹éœ€è¦è£…ä¸€ä¸ª</span><br><span class="line">        if (dfs(root) == 3)  minCameraRes ++;</span><br><span class="line">        return minCameraRes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private int minCameraRes;</span><br><span class="line"></span><br><span class="line">    // è¿”å›ï¼š1.æœ‰æ‘„åƒå¤´ 2.æ— æ‘„åƒå¤´æœ‰è¦†ç›– 3.æ— æ‘„åƒå¤´æ— è¦†ç›–</span><br><span class="line">    private int dfs(TreeNode node) &#123;</span><br><span class="line">        if (null == node) return 2;</span><br><span class="line">        int left = dfs(node.left);</span><br><span class="line">        int right = dfs(node.right);</span><br><span class="line">        if (left == 3 || right == 3) &#123;minCameraRes ++; return 1;&#125;</span><br><span class="line">        if (left == 1 || right == 1) return 2;</span><br><span class="line">        return 3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æ¯æ—¥æ¸©åº¦"><a href="#æ¯æ—¥æ¸©åº¦" class="headerlink" title="æ¯æ—¥æ¸©åº¦"></a>æ¯æ—¥æ¸©åº¦</h2><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ temperatures ï¼Œè¡¨ç¤ºæ¯å¤©çš„æ¸©åº¦ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ answer ï¼Œå…¶ä¸­ answer[i] æ˜¯æŒ‡å¯¹äºç¬¬ i å¤©ï¼Œä¸‹ä¸€ä¸ªæ›´é«˜æ¸©åº¦å‡ºç°åœ¨å‡ å¤©åã€‚å¦‚æœæ°”æ¸©åœ¨è¿™ä¹‹åéƒ½ä¸ä¼šå‡é«˜ï¼Œè¯·åœ¨è¯¥ä½ç½®ç”¨ 0 æ¥ä»£æ›¿ã€‚</p>
<p>è¾“å…¥: temperatures = [73,74,75,71,69,72,76,73]<br>è¾“å‡º: [1,1,4,2,1,1,0,0]</p>
<p>æ ‡ç­¾ï¼šå•è°ƒæ ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ¯æ—¥æ¸©åº¦</span><br><span class="line">    // è¾“å…¥temperaturesæ•°ç»„è¡¨ç¤ºæ¯å¤©çš„æ¸©åº¦</span><br><span class="line">    // è¾“å‡ºæ•°ç»„è¡¨ç¤ºæ”¹å¤©ä¹‹åçš„ä¸‹ä¸€ä¸ªæ›´é«˜æ¸©å¤©å‡ºç°åœ¨å‡ å¤©åï¼Œå¦‚æœæ²¡æœ‰ç”¨0ä»£æ›¿</span><br><span class="line">    // æ€è·¯ï¼šå•è°ƒæ ˆï¼Œå› ä¸ºè¦æ‰¾æ›´é«˜æ¸©ï¼Œæ‰€ä»¥ç”¨å•è°ƒä¸é€’å¢çš„å•è°ƒæ ˆ</span><br><span class="line">    // å•è°ƒæ ˆï¼š</span><br><span class="line">    // å¦‚æœè¦åŠ å…¥çš„æ•°å¤§äºæ ˆé¡¶å…ƒç´ ï¼Œåˆ™åº”è¯¥å¼¹å‡ºæ ˆï¼Œç›´åˆ°æ ˆé¡¶å…ƒç´ &gt;=åŠ å…¥çš„æ•°ã€‚è¡¨ç¤ºå¼¹å‡ºçš„æ•°çš„å³è¾¹ç¬¬ä¸€é«˜å°±æ˜¯è¦åŠ å…¥çš„æ•°</span><br><span class="line">    // å¦‚æœè¦åŠ å…¥çš„æ•°å°äºç­‰äºæ ˆé¡¶å…ƒç´ ï¼Œåˆ™åŠ å…¥</span><br><span class="line">    // peekè¿”å›æ ˆé¡¶å…ƒç´ ä¸ç§»é™¤  popç§»é™¤æ ˆé¡¶å…ƒç´   pushå‘æ ˆåŠ å…¥ä¸€ä¸ªå…ƒç´ </span><br><span class="line">    // è¾“å…¥: temperatures = [73,74,75,71,69,72,76,73]</span><br><span class="line">    // è¾“å‡º: [1,1,4,2,1,1,0,0]</span><br><span class="line">    public int[] dailyTemperatures(int[] temperatures) &#123;</span><br><span class="line">        Deque&lt;Integer&gt; stack = new LinkedList&lt;&gt;();</span><br><span class="line">        int[] res = new int[temperatures.length];</span><br><span class="line">        // éå†å…¥æ ˆå‡ºæ ˆ</span><br><span class="line">        for (int i = 0; i &lt; temperatures.length; i ++) &#123;</span><br><span class="line">            // å¦‚æœæ ˆé¡¶å…ƒç´ å°ï¼Œå°±å¼¹å‡º</span><br><span class="line">            while (!stack.isEmpty() &amp;&amp; temperatures[stack.peek()] &lt; temperatures[i]) &#123;</span><br><span class="line">                int index = stack.pop();</span><br><span class="line">                res[index] = i - index;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.push(i);</span><br><span class="line">        &#125;</span><br><span class="line">        // è¿˜åœ¨æ ˆé‡Œçš„å…ƒç´ å³è¾¹å°±æ²¡æœ‰æ¯”å®ƒæ›´å¤§çš„äº†</span><br><span class="line">        while (!stack.isEmpty()) &#123;</span><br><span class="line">            res[stack.pop()] = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ç§»æ‰kä½æ•°å­—"><a href="#ç§»æ‰kä½æ•°å­—" class="headerlink" title="ç§»æ‰kä½æ•°å­—"></a>ç§»æ‰kä½æ•°å­—</h2><p>ç»™ä½ ä¸€ä¸ªä»¥å­—ç¬¦ä¸²è¡¨ç¤ºçš„éè´Ÿæ•´æ•° num å’Œä¸€ä¸ªæ•´æ•° k ï¼Œç§»é™¤è¿™ä¸ªæ•°ä¸­çš„ k ä½æ•°å­—ï¼Œä½¿å¾—å‰©ä¸‹çš„æ•°å­—æœ€å°ã€‚è¯·ä½ ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›è¿™ä¸ªæœ€å°çš„æ•°å­—ã€‚</p>
<p>è¾“å…¥ï¼šnum = â€œ1432219â€, k = 3<br>è¾“å‡ºï¼šâ€1219â€<br>è§£é‡Šï¼šç§»é™¤æ‰ä¸‰ä¸ªæ•°å­— 4, 3, å’Œ 2 å½¢æˆä¸€ä¸ªæ–°çš„æœ€å°çš„æ•°å­— 1219 ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // ç§»é™¤kä½æ•°å­—</span><br><span class="line">    // è¾“å…¥ï¼šä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºçš„éè´Ÿæ•´æ•°numï¼Œå’Œä¸€ä¸ªæ•´æ•°kï¼Œè¡¨ç¤ºéœ€è¦ä»numä¸­ç§»é™¤kä½</span><br><span class="line">    // è¾“å‡ºï¼šç§»é™¤kä½åçš„æœ€å°æ•°</span><br><span class="line">    // ä¾‹å¦‚ï¼š10200 å’Œ 1  è¾“å‡º200ã€‚1432219 å’Œ 3 è¾“å‡º1219</span><br><span class="line">    // æ€è·¯ï¼šä»å‰å¾€åéå†ï¼Œå¦‚æœå‰&gt;åï¼Œå°±ç§»é™¤ã€‚ä¸è¡Œï¼Œä¼šæ¼æ‰å‰é¢çš„å¤§æ•°ã€‚é™¤éæ¯æ¬¡åªåˆ é™¤ä¸€ä¸ªæ•°ã€‚</span><br><span class="line">    // å•è°ƒæ ˆï¼šæ¯æ—¥æ¸©åº¦æ˜¯è¦è·å–åé¢å¤§çš„æ•°çš„ä½ç½®ï¼Œå¼¹å‡ºå‰é¢å°çš„ä½ç½®ï¼Œç”¨å•è°ƒé€’å‡çš„ã€‚è¿™é‡Œè¦å¼¹å‡ºå‰é¢å¤§çš„ï¼Œæ‰€ä»¥ç”¨å•è°ƒé€’å¢</span><br><span class="line">    // æ€»ç»“ï¼šè¦å¼¹å‡ºå°çš„ï¼Œå•è°ƒé€’å‡ã€‚è¦å¼¹å‡ºå¤§çš„ï¼Œå•è°ƒé€’å¢ã€‚(ä»æ ˆåº•åˆ°æ ˆé¡¶)</span><br><span class="line">    public String removeKdigits(String num, int k) &#123;</span><br><span class="line">        Deque&lt;Integer&gt; stack = new LinkedList&lt;&gt;();</span><br><span class="line">        for (char ch : num.toCharArray()) &#123;</span><br><span class="line">            int n = ch - &#x27;0&#x27;;</span><br><span class="line">            // å¦‚æœæ ˆé¡¶å…ƒç´ æ›´å¤§ï¼Œå°±å¼¹å‡º</span><br><span class="line">            while (!stack.isEmpty() &amp;&amp; k &gt; 0 &amp;&amp; stack.peek() &gt; n) &#123;</span><br><span class="line">                stack.pop();</span><br><span class="line">                k --;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.push(n);</span><br><span class="line">        &#125;</span><br><span class="line">        // æ²¡åˆ å®Œï¼Œå°±åˆ åé¢å¤§çš„ï¼Œä¹Ÿå°±æ˜¯å‡ºæ ˆ</span><br><span class="line">        while (k -- &gt; 0) &#123;</span><br><span class="line">            stack.pop();</span><br><span class="line">        &#125;</span><br><span class="line">        // å¼€å§‹è®¡ç®—ï¼Œæ ˆé¡¶æ˜¯ä¸ªä½ã€‚ç”¨intè®°å½•ç»“æœä¼šå¯¼è‡´æ•°æ®æº¢å‡ºï¼Œæ‰€ä»¥ç”¨StringBuilder</span><br><span class="line">        StringBuilder builder = new StringBuilder();</span><br><span class="line">        while (!stack.isEmpty()) &#123;</span><br><span class="line">            // ä»æ ˆåº•åŠ æ•°æ®</span><br><span class="line">            builder.append(stack.removeLast());</span><br><span class="line">        &#125;</span><br><span class="line">        // ç§»é™¤å‰å¯¼é›¶</span><br><span class="line">        while (builder.length() &gt; 1 &amp;&amp; builder.charAt(0) == &#x27;0&#x27;) &#123;</span><br><span class="line">            builder.deleteCharAt(0);</span><br><span class="line">        &#125;</span><br><span class="line">        // å¦‚æœç§»é™¤æ‰€æœ‰æ•°å­—ï¼Œè¿”å› &quot;0&quot;</span><br><span class="line">        if (builder.length() == 0) &#123;</span><br><span class="line">            return &quot;0&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ "><a href="#ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ " class="headerlink" title="ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ "></a>ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ </h2><p>nums1 ä¸­æ•°å­— x çš„ ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  æ˜¯æŒ‡ x åœ¨ nums2 ä¸­å¯¹åº”ä½ç½® å³ä¾§ çš„ ç¬¬ä¸€ä¸ª æ¯” x å¤§çš„å…ƒç´ ã€‚</p>
<p>ç»™ä½ ä¸¤ä¸ª æ²¡æœ‰é‡å¤å…ƒç´  çš„æ•°ç»„ nums1 å’Œ nums2 ï¼Œä¸‹æ ‡ä» 0 å¼€å§‹è®¡æ•°ï¼Œå…¶ä¸­nums1 æ˜¯ nums2 çš„å­é›†ã€‚</p>
<p>å¯¹äºæ¯ä¸ª 0 &lt;= i &lt; nums1.length ï¼Œæ‰¾å‡ºæ»¡è¶³ nums1[i] == nums2[j] çš„ä¸‹æ ‡ j ï¼Œå¹¶ä¸”åœ¨ nums2 ç¡®å®š nums2[j] çš„ ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  ã€‚å¦‚æœä¸å­˜åœ¨ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ ï¼Œé‚£ä¹ˆæœ¬æ¬¡æŸ¥è¯¢çš„ç­”æ¡ˆæ˜¯ -1 ã€‚</p>
<p>è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º nums1.length çš„æ•°ç»„ ans ä½œä¸ºç­”æ¡ˆï¼Œæ»¡è¶³ ans[i] æ˜¯å¦‚ä¸Šæ‰€è¿°çš„ ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  ã€‚</p>
<p>è¾“å…¥ï¼šnums1 = [4,1,2], nums2 = [1,3,4,2].<br>è¾“å‡ºï¼š[-1,3,-1]</p>
<p>æ ‡ç­¾ï¼šå•è°ƒæ ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ 1</span><br><span class="line">    // è¾“å…¥ä¸¤ä¸ªæ•°ç»„ï¼Œä¸¤ä¸ªæ•°ç»„éƒ½æ²¡é‡å¤ï¼Œæ•°ç»„1æ˜¯æ•°ç»„2çš„å­é›†</span><br><span class="line">    // è¿”å›æ•°ç»„1çš„æ•°å­—åœ¨æ•°ç»„2ä¸­ä½ç½®å³è¾¹ç¬¬ä¸€ä¸ªæ¯”å®ƒå¤§çš„æ•°ï¼Œæ²¡æœ‰å°±è¿”å›-1</span><br><span class="line">    // ä¾‹å­ï¼š[4,1,2] [1,3,4,2] è¿”å›[-1,3,-1]</span><br><span class="line">    // æ€è·¯ï¼šå’Œæ¯æ—¥æ¸©åº¦ç±»ä¼¼ï¼Œåªä¸è¿‡æ¯æ—¥æ¸©åº¦å°±ä¸€ä¸ªå½“å‰æ•°ç»„ã€‚è¿™ä¸ªé—®é¢˜å°±éœ€è¦éå†è¿‡ç¨‹è®°å½•æ•°å­—å¯¹åº”çš„å³è¾¹ç¬¬ä¸€ä¸ªå¤§çš„æ•°</span><br><span class="line">    // ä½¿ç”¨å•è°ƒä¸é€’å¢çš„å•è°ƒæ ˆï¼Œå¼¹å‡ºå°çš„</span><br><span class="line">    public int[] nextGreaterElement(int[] nums1, int[] nums2) &#123;</span><br><span class="line">        Deque&lt;Integer&gt; stack = new ArrayDeque&lt;&gt;();</span><br><span class="line">        // mapè®°å½•nums1çš„ æ•°-index æ˜ å°„</span><br><span class="line">        HashMap&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        for (int i = 0; i &lt; nums1.length; i ++) &#123;</span><br><span class="line">            map.put(nums1[i], i);</span><br><span class="line">        &#125;</span><br><span class="line">        int[] res = new int[nums1.length];</span><br><span class="line">        Arrays.fill(res, -1);</span><br><span class="line">        for (int value : nums2) &#123;</span><br><span class="line">            // æ ˆé¡¶å°çš„è¯å°±å¼¹å‡º</span><br><span class="line">            while (!stack.isEmpty() &amp;&amp; stack.peek() &lt; value) &#123;</span><br><span class="line">                int num2 = stack.pop();</span><br><span class="line">                if (map.containsKey(num2)) &#123;</span><br><span class="line">                    res[map.get(num2)] = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.push(value);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ -II"><a href="#ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ -II" class="headerlink" title="ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  II"></a>ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  II</h2><p>ç»™å®šä¸€ä¸ªå¾ªç¯æ•°ç»„ nums ï¼ˆ nums[nums.length - 1] çš„ä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯ nums[0] ï¼‰ï¼Œè¿”å› nums ä¸­æ¯ä¸ªå…ƒç´ çš„ ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´  ã€‚</p>
<p>æ•°å­— x çš„ ä¸‹ä¸€ä¸ªæ›´å¤§çš„å…ƒç´  æ˜¯æŒ‰æ•°ç»„éå†é¡ºåºï¼Œè¿™ä¸ªæ•°å­—ä¹‹åçš„ç¬¬ä¸€ä¸ªæ¯”å®ƒæ›´å¤§çš„æ•°ï¼Œè¿™æ„å‘³ç€ä½ åº”è¯¥å¾ªç¯åœ°æœç´¢å®ƒçš„ä¸‹ä¸€ä¸ªæ›´å¤§çš„æ•°ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¾“å‡º -1 ã€‚</p>
<p>è¾“å…¥: nums = [1,2,1]<br>è¾“å‡º: [2,-1,2]</p>
<p>æ ‡ç­¾ï¼šå•è°ƒæ ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    // ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ 2</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªæ•°ç»„ï¼ŒæŠŠå®ƒå½“ä½œå¾ªç¯æ•°ç»„ã€‚è¿”å›æ•°ç»„å…ƒç´ ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¾“å‡º-1</span><br><span class="line">    // æ€è·¯ï¼šç›´æ¥æŠŠæ•°ç»„copyä¸€ä»½æ”¾åé¢å°±okã€‚ä½†æ˜¯å€’ä¹Ÿä¸ç”¨çœŸçš„å¤åˆ¶ä¸€ä»½ï¼Œéå†2sizeå°±è¡Œ</span><br><span class="line">    // ä½¿ç”¨å•è°ƒä¸é€’å¢å•è°ƒæ ˆï¼Œå¼¹å‡ºå°çš„</span><br><span class="line">    public int[] nextGreaterElements(int[] nums) &#123;</span><br><span class="line">        Deque&lt;Integer&gt; stack = new ArrayDeque&lt;&gt;();</span><br><span class="line">        int[] res = new int[nums.length];</span><br><span class="line">        Arrays.fill(res, -1);</span><br><span class="line">        for (int i = 0; i &lt; nums.length * 2; i ++) &#123;</span><br><span class="line">            int index = i % nums.length;</span><br><span class="line">            while (!stack.isEmpty() &amp;&amp; nums[stack.peek()] &lt; nums[index]) &#123;</span><br><span class="line">                int topIndex = stack.pop();</span><br><span class="line">                res[topIndex] = nums[index];</span><br><span class="line">            &#125;</span><br><span class="line">            stack.push(index);</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="èƒŒåŒ…é—®é¢˜"><a href="#èƒŒåŒ…é—®é¢˜" class="headerlink" title="èƒŒåŒ…é—®é¢˜"></a>èƒŒåŒ…é—®é¢˜</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">// 01èƒŒåŒ…é—®é¢˜</span><br><span class="line">// è¾“å…¥ï¼šé‡é‡æ•°ç»„ã€ä»·å€¼æ•°ç»„ã€èƒŒåŒ…æœ€å¤§å®¹é‡ã€‚æ¯ä¸ªç‰©å“ä»…èƒ½ç”¨ä¸€æ¬¡ã€‚</span><br><span class="line">// è¾“å‡ºï¼šèƒŒåŒ…èƒ½å®¹çº³çš„æœ€å¤§ä»·å€¼</span><br><span class="line">// åŠ¨æ€è§„åˆ’æ­¥éª¤ï¼š</span><br><span class="line">// 1.ç¡®å®šdpæ•°ç»„ä»¥åŠä¸‹æ ‡çš„å«ä¹‰</span><br><span class="line">// 2.ç¡®å®šé€’æ¨å…¬å¼</span><br><span class="line">// 3.dpæ•°ç»„å¦‚ä½•åˆå§‹åŒ–</span><br><span class="line">// 4.ç¡®å®šéå†é¡ºåº</span><br><span class="line">// 5.ä¸¾ä¾‹æ¨å¯¼dpæ•°ç»„</span><br><span class="line">public static int maxPackage(int[] weight, int[] value, int size) &#123;</span><br><span class="line">    // 1.ç¡®å®šdpæ•°ç»„ï¼šäºŒç»´dp[i][j]ï¼Œiè¡¨ç¤ºè´­ä¹°åˆ°ç¬¬iä¸ªç‰©å“ï¼Œjè¡¨ç¤ºç”¨äº†jèƒŒåŒ…å®¹é‡</span><br><span class="line">    int[][] dp = new int[weight.length][size + 1];</span><br><span class="line">    // 2.ç¡®å®šé€’æ¨å…¬å¼ï¼šè¦iå’Œä¸è¦i: dp[i][j] = Math.max(dp[i-1][j-weight[i]] + value[i], dp[i-1][j]);</span><br><span class="line">    // éå†é¡ºåºï¼šå…ˆç‰©å“å†size</span><br><span class="line">    // 3.åˆå§‹åŒ–:i=0æ—¶ï¼Œåªæœ‰jå¤§äºç­‰äºäº†weight[0]æ‰å¯ä»¥æœ‰value[0]çš„ä»·å€¼</span><br><span class="line">    for (int j = weight[0]; j &lt;= size; j ++) &#123;</span><br><span class="line">        dp[0][j] = value[0];</span><br><span class="line">    &#125;</span><br><span class="line">    // 4.å¼€å§‹éå† å¤–å±‚æ˜¯ç‰©å“ å†…å±‚æ˜¯å¤§å°size</span><br><span class="line">    for (int i = 1; i &lt; weight.length; i ++) &#123;</span><br><span class="line">        for (int j = 1; j &lt;= size; j ++) &#123;</span><br><span class="line">            // æ”¾ä¸ä¸‹å½“å‰ç‰©å“</span><br><span class="line">            if (j &lt; weight[i]) &#123;</span><br><span class="line">                dp[i][j] = dp[i - 1][j];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                dp[i][j] = Math.max(dp[i - 1][j - weight[i]] + value[i], dp[i-1][j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return dp[weight.length - 1][size];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 01èƒŒåŒ…é—®é¢˜ä½¿ç”¨ä¸€ç»´æ•°ç»„ï¼Œè¡¨ç¤ºå®¹é‡ä¸ºjæ—¶çš„æœ€å¤§ä»·å€¼</span><br><span class="line">// å…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨å¯¹i=0åˆå§‹åŒ–ï¼Œä¸€ç»´çš„ä¸ç”¨åŠ åˆ¤æ–­ï¼Œä½†æ˜¯äºŒç»´çš„å°±å¾—åŠ äº†</span><br><span class="line">public static int maxPackage1(int[] weight, int[] value, int size) &#123;</span><br><span class="line">    int[] dp = new int[size + 1];</span><br><span class="line">//        for (int i = weight[0]; i &lt;= size; i ++) &#123;</span><br><span class="line">//            dp[i] = value[0];</span><br><span class="line">//        &#125;</span><br><span class="line">    for (int i = 0; i &lt; weight.length; i ++) &#123;</span><br><span class="line">        // æ³¨æ„ï¼šéå†é¡ºåºåº”è¯¥ä»å³å¾€å·¦äº†ï¼Œç¡®ä¿å–æ•°ç›¸å½“äºè¿˜æ˜¯ä»ä¸Šä¸€å±‚å–</span><br><span class="line">        // å¦‚æœè¿˜æ˜¯ä»å·¦åˆ°å³ï¼Œåé¢çš„å…ƒç´ å°±å¯èƒ½å› ä¸ºå‰è¾¹å…ƒç´ çš„å˜åŒ–è€Œå˜åŒ–ï¼Œä¸æ˜¯ç”±ä¸Šä¸€å±‚çš„å…ƒç´ æ¨å‡ºæ¥çš„äº†</span><br><span class="line">        // ç°å®æ„ä¹‰è¡¨ç¤ºä¸€ä¸ªç‰©å“ç”¨äº†å¤šæ¬¡</span><br><span class="line">        for (int j = size; j &gt; 0; j --) &#123;</span><br><span class="line">            if (j &gt;= weight[i])  dp[j] = Math.max(dp[j], dp[j - weight[i]] + value[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return dp[size];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// å®Œå…¨èƒŒåŒ…é—®é¢˜</span><br><span class="line">// è¾“å…¥ï¼šé‡é‡æ•°ç»„ã€ä»·å€¼æ•°ç»„ã€èƒŒåŒ…æœ€å¤§å®¹é‡ã€‚æ¯ä¸ªç‰©å“èƒ½ç”¨æ— é™æ¬¡</span><br><span class="line">// è¾“å‡ºï¼šèƒŒåŒ…èƒ½å®¹çº³çš„æœ€å¤§ä»·å€¼</span><br><span class="line">// ä¸€ç»´æ•°ç»„éå†é¡ºåºä»å·¦åˆ°å³</span><br><span class="line">// weightå’Œvalueå†…å…ƒç´ çš„é¡ºåºä¸ä¼šæœ‰å½±å“ï¼šå› ä¸ºéå†åˆ°ç‰©ä»¶ï¼Œéƒ½ä¼šä»å®¹é‡1å¼€å§‹éå†</span><br><span class="line">public static int maxPackageTotal(int[] weight, int[] value, int size) &#123;</span><br><span class="line">    int[] dp = new int[size + 1];</span><br><span class="line">    for (int i = 0; i &lt; weight.length; i ++) &#123;</span><br><span class="line">        for (int j = 1; j &lt;= size; j ++) &#123;</span><br><span class="line">            if (j &gt;= weight[i])  dp[j] = Math.max(dp[j], dp[j - weight[i]] + value[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return dp[size];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å®Œå…¨å¹³æ–¹æ•°"><a href="#å®Œå…¨å¹³æ–¹æ•°" class="headerlink" title="å®Œå…¨å¹³æ–¹æ•°"></a>å®Œå…¨å¹³æ–¹æ•°</h2><p>ç»™ä½ ä¸€ä¸ªæ•´æ•° n ï¼Œè¿”å› å’Œä¸º n çš„å®Œå…¨å¹³æ–¹æ•°çš„æœ€å°‘æ•°é‡ ã€‚</p>
<p>å®Œå…¨å¹³æ–¹æ•° æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå…¶å€¼ç­‰äºå¦ä¸€ä¸ªæ•´æ•°çš„å¹³æ–¹ï¼›æ¢å¥è¯è¯´ï¼Œå…¶å€¼ç­‰äºä¸€ä¸ªæ•´æ•°è‡ªä¹˜çš„ç§¯ã€‚ä¾‹å¦‚ï¼Œ1ã€4ã€9 å’Œ 16 éƒ½æ˜¯å®Œå…¨å¹³æ–¹æ•°ï¼Œè€Œ 3 å’Œ 11 ä¸æ˜¯ã€‚</p>
<p>æ ‡ç­¾ï¼šèƒŒåŒ…é—®é¢˜ åŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å®Œå…¨å¹³æ–¹æ•°</span><br><span class="line">    // è¾“å…¥ï¼šä¸€ä¸ªæ•´æ•°nï¼Œè¿”å›è¿™ä¸ªæ•´æ•°næœ€å°‘å¯ä»¥æ˜¯å‡ ä¸ªå®Œå…¨å¹³æ–¹æ•°çš„å’Œï¼Œå¯é‡å¤ç”¨</span><br><span class="line">    // å®Œå…¨èƒŒåŒ…é—®é¢˜ï¼Œä¸€ç»´æ•°ç»„ä»å‰å¾€åéå†</span><br><span class="line">    public static int numSquares(int num) &#123;</span><br><span class="line">        // 1æ¯”è¾ƒç‹¬ç‰¹</span><br><span class="line">        if (num == 1) return 1;</span><br><span class="line">        int[] dp = new int[num + 1];</span><br><span class="line">        Arrays.fill(dp, Integer.MAX_VALUE - 1);</span><br><span class="line">        dp[0] = 0;</span><br><span class="line">        // ç‰©å“è¡¨ç¤º1-num/2</span><br><span class="line">        for (int i = 0; i &lt;= num / 2; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= num; j ++) &#123;</span><br><span class="line">                int square = (int) Math.pow(i, 2);</span><br><span class="line">                if (j &gt;= square) &#123;</span><br><span class="line">                    dp[j] = Math.min(dp[j - square] + 1, dp[j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[num];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="å•è¯æ‹†åˆ†"><a href="#å•è¯æ‹†åˆ†" class="headerlink" title="å•è¯æ‹†åˆ†"></a>å•è¯æ‹†åˆ†</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² s å’Œä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ wordDict ä½œä¸ºå­—å…¸ã€‚è¯·ä½ åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ©ç”¨å­—å…¸ä¸­å‡ºç°çš„å•è¯æ‹¼æ¥å‡º s ã€‚</p>
<p>æ³¨æ„ï¼šä¸è¦æ±‚å­—å…¸ä¸­å‡ºç°çš„å•è¯å…¨éƒ¨éƒ½ä½¿ç”¨ï¼Œå¹¶ä¸”å­—å…¸ä¸­çš„å•è¯å¯ä»¥é‡å¤ä½¿ç”¨ã€‚</p>
<p>è¾“å…¥: s = â€œapplepenappleâ€, wordDict = [â€œappleâ€, â€œpenâ€]<br>è¾“å‡º: true</p>
<p>æ ‡ç­¾ï¼šèƒŒåŒ…é—®é¢˜(æœ‰é¡ºåº) åŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å•è¯æ‹†åˆ†</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²wordï¼Œå’Œä¸€ä¸ªStringæ•°ç»„è¡¨ç¤ºå¯ä»¥ä½¿ç”¨çš„å•è¯ï¼Œå•è¯ä¸ä¸€å®šå…¨éƒ¨ä½¿ç”¨ï¼Œå•è¯å¯ä»¥é‡å¤ä½¿ç”¨</span><br><span class="line">    // å®Œå…¨èƒŒåŒ…é—®é¢˜ï¼Œä¸€ç»´æ•°ç»„ä»å‰å¾€åéå†</span><br><span class="line">    // è¿™ä¸ªä¸åŒäºä¸Šé¢çš„èƒŒåŒ…é—®é¢˜ï¼Œä¸Šé¢çš„å¯¹äºç‰©å“æ²¡æœ‰é¡ºåºè¦æ±‚ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦ï¼Œå¦‚æœæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ï¼Œå°±ä¼šå¯¼è‡´abaçš„æƒ…å†µæ— æ³•éå†åˆ°</span><br><span class="line">    // è§£å†³åŠæ³•ï¼šå…ˆéå†sizeï¼Œå†éå†ç‰©å“ã€‚éå†é¡ºåºè¦å…ˆéå†èƒŒåŒ…ï¼Œä¸èƒ½å…ˆéå†ç‰©å“ï¼Œå› ä¸ºç‰©å“å¾—æ˜¯æœ‰åºçš„</span><br><span class="line">    public static boolean wordBreak(String word, List&lt;String&gt; words) &#123;</span><br><span class="line">        // å¾—åˆå§‹åŒ– word.length() + 1ï¼Œå› ä¸ºéœ€è¦dp[0]</span><br><span class="line">        boolean[] dp = new boolean[word.length() + 1];</span><br><span class="line">        // åˆå§‹åŒ–ï¼šdp[0]å°±è¡Œ</span><br><span class="line">        dp[0] = true;</span><br><span class="line">        // å› ä¸ºéœ€è¦æœ‰åºï¼Œéå†å…ˆéå†èƒŒåŒ…å†éå†ç‰©å“</span><br><span class="line">        for (int j = 1; j &lt;= word.length(); j ++) &#123;</span><br><span class="line">            for (int i = 0; i &lt; words.size(); i ++) &#123;</span><br><span class="line">                if (j &lt; words.get(i).length())  continue;</span><br><span class="line">                // åˆ¤æ–­è¯¥å•è¯èƒ½å¦ä¸å­—ç¬¦å°¾éƒ¨åŒ¹é…</span><br><span class="line">                String sub = word.substring(j - words.get(i).length(), j);</span><br><span class="line">                if (sub.equals(words.get(i))) &#123;</span><br><span class="line">                    dp[j] = dp[j] || dp[j - words.get(i).length()];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Arrays.toString(dp));</span><br><span class="line">        return dp[word.length()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆä¸è¿ç»­ï¼‰"><a href="#æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆä¸è¿ç»­ï¼‰" class="headerlink" title="æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆä¸è¿ç»­ï¼‰"></a>æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆä¸è¿ç»­ï¼‰</h2><p>ç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸² text1 å’Œ text2ï¼Œè¿”å›è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æœ€é•¿ å…¬å…±å­åºåˆ— çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨ å…¬å…±å­åºåˆ— ï¼Œè¿”å› 0 ã€‚</p>
<p>ä¸€ä¸ªå­—ç¬¦ä¸²çš„ å­åºåˆ— æ˜¯æŒ‡è¿™æ ·ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼šå®ƒæ˜¯ç”±åŸå­—ç¬¦ä¸²åœ¨ä¸æ”¹å˜å­—ç¬¦çš„ç›¸å¯¹é¡ºåºçš„æƒ…å†µä¸‹åˆ é™¤æŸäº›å­—ç¬¦ï¼ˆä¹Ÿå¯ä»¥ä¸åˆ é™¤ä»»ä½•å­—ç¬¦ï¼‰åç»„æˆçš„æ–°å­—ç¬¦ä¸²ã€‚</p>
<p>ä¾‹å¦‚ï¼Œâ€aceâ€ æ˜¯ â€œabcdeâ€ çš„å­åºåˆ—ï¼Œä½† â€œaecâ€ ä¸æ˜¯ â€œabcdeâ€ çš„å­åºåˆ—ã€‚</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">   </span><br><span class="line">    // æœ€é•¿å…¬å…±å­åºåˆ—</span><br><span class="line">    // è¾“å…¥ï¼šä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œæ±‚æœ€é•¿å…¬å…±å­åºåˆ—ï¼Œå¯ä»¥ä¸è¿ç»­ï¼Œä½†æ˜¯é¡ºåºå¾—æ­£ç¡®</span><br><span class="line">    // æ€æƒ³ï¼šåŠ¨æ€è§„åˆ’</span><br><span class="line">    public static int longestCommonSubsequence(String s1, String s2) &#123;</span><br><span class="line">        int len1 = s1.length();</span><br><span class="line">        int len2 = s2.length();</span><br><span class="line">        // å®šä¹‰dp[i][j]è¡¨ç¤ºs1å‰iä¸ªå­—ç¬¦å’Œs2å‰jä¸ªå­—ç¬¦çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦</span><br><span class="line">        int[][] dp = new int[len1 + 1][len2 + 1];</span><br><span class="line">        // åˆå§‹åŒ–çœ‹çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¾èµ–äºå“ªäº›çŠ¶æ€ï¼Œè¿™é‡Œæ˜¯ä¸Šå’Œå·¦</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">                if (s1.charAt(i - 1) == s2.charAt(j - 1)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i - 1][j - 1] + 1;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len1][len2];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€é•¿å…¬å…±å­ä¸²ï¼ˆè¿ç»­ï¼‰"><a href="#æœ€é•¿å…¬å…±å­ä¸²ï¼ˆè¿ç»­ï¼‰" class="headerlink" title="æœ€é•¿å…¬å…±å­ä¸²ï¼ˆè¿ç»­ï¼‰"></a>æœ€é•¿å…¬å…±å­ä¸²ï¼ˆè¿ç»­ï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// æœ€é•¿å…¬å…±å­ä¸²</span><br><span class="line">// è¾“å…¥ï¼šä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œæ±‚æœ€é•¿å…¬å…±å­ä¸²ï¼Œè¦æ±‚è¿ç»­</span><br><span class="line">// æ€æƒ³ï¼šåŠ¨æ€è§„åˆ’</span><br><span class="line">public static String maxCommonString(String s1, String s2) &#123;</span><br><span class="line">    int len1  = s1.length();</span><br><span class="line">    int len2 = s2.length();</span><br><span class="line">    int maxSize = 0;</span><br><span class="line">    // ç”¨äºè®°å½•å­ä¸²String</span><br><span class="line">    int endIndex = 0;</span><br><span class="line">    // dp[i][j]è¡¨ç¤ºä»¥s1[i-1]ç»“å°¾çš„s1å’Œä»¥s2[j-1]ç»“å°¾çš„s2ï¼Œå¹¶ä¸”å…¬å…±å­ä¸²éœ€è¦åŒ…æ‹¬è¿™ä¸¤ä¸ªç»“å°¾å­—ç¬¦çš„æœ€é•¿å…¬å…±å­ä¸²é•¿åº¦</span><br><span class="line">    int[][] dp = new int[len1 + 1][len2 + 1];</span><br><span class="line">    // éœ€è¦çš„åˆå§‹åŒ–æ˜¯0ï¼Œæ‰€ä»¥å¿½ç•¥åˆå§‹åŒ–</span><br><span class="line">    for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">        for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">            if (s1.charAt(i - 1) == s2.charAt(j - 1)) &#123;</span><br><span class="line">                dp[i][j] = dp[i -1][j -1] + 1;</span><br><span class="line">                // è®°å½•ç»“æœ</span><br><span class="line">                if (dp[i][j] &gt; maxSize) &#123;</span><br><span class="line">                    maxSize = dp[i][j];</span><br><span class="line">                    endIndex = i - 1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return maxSize &gt; 0 ? s1.substring(endIndex - maxSize + 1, endIndex + 1) : &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æœ€é•¿å›æ–‡å­ä¸²-1"><a href="#æœ€é•¿å›æ–‡å­ä¸²-1" class="headerlink" title="æœ€é•¿å›æ–‡å­ä¸²"></a>æœ€é•¿å›æ–‡å­ä¸²</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² sï¼Œæ‰¾åˆ° s ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚</p>
<p>å¦‚æœå­—ç¬¦ä¸²çš„ååºä¸åŸå§‹å­—ç¬¦ä¸²ç›¸åŒï¼Œåˆ™è¯¥å­—ç¬¦ä¸²ç§°ä¸ºå›æ–‡å­—ç¬¦ä¸²ã€‚</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<p>æ–¹æ³•ä¸€ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">  </span><br><span class="line">    // æœ€é•¿å›æ–‡å­ä¸²</span><br><span class="line">    // ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›å®ƒçš„æœ€é•¿å›æ–‡å­ä¸²ï¼Œè¿™ä¸ªå­ä¸²éœ€è¦æ˜¯è¿ç»­çš„å­ä¸²</span><br><span class="line">    // æ€è·¯ï¼šå’Œæœ¬å­—ç¬¦ä¸²åè½¬çš„ç”¨æœ€é•¿å…¬å…±å­ä¸²ï¼Œå°±æ˜¯å›æ–‡å­ä¸²ã€‚éœ€è¦å¢åŠ ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼šç´¢å¼•ä½ç½®æ˜¯å¦é•œåƒã€‚</span><br><span class="line">    // å¦‚æœä¸åˆ¤æ–­ï¼Œabaxabå’Œbaxabaå°±ä¼šæŠŠabã€baå½“ä½œå›æ–‡ä¸²</span><br><span class="line">    public static String longestPalindrome(String s) &#123;</span><br><span class="line">        String s2 = new StringBuilder(s).reverse().toString();</span><br><span class="line">        int len = s.length();</span><br><span class="line">        int maxSize = 0;</span><br><span class="line">        // ç”¨äºè®°å½•å­ä¸²String</span><br><span class="line">        int endIndex = 0;</span><br><span class="line">        // dp[i][j]è¡¨ç¤ºä»¥s1[i-1]ç»“å°¾çš„s1å’Œä»¥s2[j-1]ç»“å°¾çš„s2ï¼Œå¹¶ä¸”å…¬å…±å­ä¸²éœ€è¦åŒ…æ‹¬è¿™ä¸¤ä¸ªç»“å°¾å­—ç¬¦çš„æœ€é•¿å…¬å…±å­ä¸²é•¿åº¦</span><br><span class="line">        int[][] dp = new int[len + 1][len + 1];</span><br><span class="line">        // éœ€è¦çš„åˆå§‹åŒ–æ˜¯0ï¼Œæ‰€ä»¥å¿½ç•¥åˆå§‹åŒ–</span><br><span class="line">        for (int i = 1; i &lt;= len; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= len; j ++) &#123;</span><br><span class="line">                if (s.charAt(i - 1) == s2.charAt(j - 1)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i -1][j -1] + 1;</span><br><span class="line">                    // è®°å½•ç»“æœï¼Œå¹¶æ£€æŸ¥å­ä¸²çš„ç´¢å¼•æ˜¯å¦é•œåƒï¼Œä»¥ç¡®ä¿å®ƒæ˜¯å›æ–‡. 1213 3121 i=3 dp=3 len=4 j=4</span><br><span class="line">                    if (dp[i][j] &gt; maxSize &amp;&amp; i - dp[i][j] == len - j) &#123;</span><br><span class="line">                        maxSize = dp[i][j];</span><br><span class="line">                        endIndex = i - 1;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return s.substring(endIndex - maxSize + 1, endIndex + 1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•äºŒï¼šå¦ä¸€ä¸ªdpå«ä¹‰çš„åŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">  </span><br><span class="line">    public static String longestPalindrome(String s) &#123;</span><br><span class="line">        int len = s.length();</span><br><span class="line">        // dp[i][j]è¡¨ç¤ºä¸‹æ ‡i-jçš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯å›æ–‡å­—ç¬¦ä¸²ï¼Œj&gt;=i</span><br><span class="line">        boolean[][] dp = new boolean[len][len];</span><br><span class="line">        int maxLen = 0;</span><br><span class="line">        String res = &quot;&quot;;</span><br><span class="line">        // éå†é¡ºåºï¼šå·¦ä¸‹åˆ°å³ä¸Šï¼Œå› ä¸ºç”¨åˆ°[i+1][j-1]</span><br><span class="line">        for (int i = len - 1; i &gt;= 0; i --) &#123;</span><br><span class="line">            for (int j = i; j &lt; len; j ++) &#123;</span><br><span class="line">                if (s.charAt(i) == s.charAt(j)) &#123;</span><br><span class="line">                    // ç›¸å·®&lt;=1è‚¯å®šå›æ–‡ï¼Œä¸æ˜¯å°±è¦çœ‹ä¸­é—´æ˜¯ä¸æ˜¯</span><br><span class="line">                    if (j -i &lt;= 1 || dp[i + 1][j - 1]) &#123;</span><br><span class="line">                        dp[i][j] = true;</span><br><span class="line">                        if (j - i + 1 &gt; maxLen) &#123;</span><br><span class="line">                            maxLen = j - i + 1;</span><br><span class="line">                            res = s.substring(i, j + 1);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å›æ–‡å­ä¸²"><a href="#å›æ–‡å­ä¸²" class="headerlink" title="å›æ–‡å­ä¸²"></a>å›æ–‡å­ä¸²</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œè¯·ä½ ç»Ÿè®¡å¹¶è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²ä¸­ å›æ–‡å­ä¸² çš„æ•°ç›®ã€‚</p>
<p>å›æ–‡å­—ç¬¦ä¸² æ˜¯æ­£ç€è¯»å’Œå€’è¿‡æ¥è¯»ä¸€æ ·çš„å­—ç¬¦ä¸²ã€‚</p>
<p>å­å­—ç¬¦ä¸² æ˜¯å­—ç¬¦ä¸²ä¸­çš„ç”±è¿ç»­å­—ç¬¦ç»„æˆçš„ä¸€ä¸ªåºåˆ—ã€‚</p>
<p>å…·æœ‰ä¸åŒå¼€å§‹ä½ç½®æˆ–ç»“æŸä½ç½®çš„å­ä¸²ï¼Œå³ä½¿æ˜¯ç”±ç›¸åŒçš„å­—ç¬¦ç»„æˆï¼Œä¹Ÿä¼šè¢«è§†ä½œä¸åŒçš„å­ä¸²ã€‚</p>
<p>è¾“å…¥ï¼šs = â€œaaaâ€<br>è¾“å‡ºï¼š6<br>è§£é‡Šï¼š6ä¸ªå›æ–‡å­ä¸²: â€œaâ€, â€œaâ€, â€œaâ€, â€œaaâ€, â€œaaâ€, â€œaaaâ€</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // å›æ–‡å­ä¸²</span><br><span class="line">    // è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›æœ‰å¤šå°‘ä¸ªå›æ–‡å­ä¸²ã€‚å­ä¸²ï¼šè¿ç»­çš„å­—ç¬¦ç»„æˆçš„ã€‚å­—ç¬¦ä¸²ç›¸ç­‰ï¼Œä½†æ˜¯ä½ç½®ä¸åŒä¹Ÿç®—ä¸åŒçš„å­ä¸²</span><br><span class="line">    // æ€è·¯ï¼šåŠ¨æ€è§„åˆ’ï¼Œä¸ç”¨åè½¬å­—ç¬¦ä¸²ï¼Œç›´æ¥åŠ¨æ€è§„åˆ’</span><br><span class="line">    //01 dp[i][j]çš„å®šä¹‰ æ˜¯åœ¨ i-jè¿™ä¸ªåŒºé—´å†…çš„ æ˜¯ä¸æ˜¯å›æ–‡</span><br><span class="line">    //02 æ›´æ–°æ–¹æ³•: è¿™é‡Œæ˜¯å¦‚æœ ijçš„charç›¸ç­‰ ä¸” gap &lt;= 1é‚£ä¸€å®šå°±æ˜¯å›æ–‡ï¼›è¦æ˜¯gap &gt; 1é‚£å°±è¦çœ‹ dp[i+1][j-1]æ˜¯ä¸æ˜¯å›æ–‡ï¼›</span><br><span class="line">    //03 æ›´æ–°é¡ºåºï¼Œ æ˜¯ä»å·¦ä¸‹åˆ°å³ä¸Šï¼Œå› ä¸ºéœ€è¦i+1 å’Œ j-1 æ‰€ä»¥æ˜¯ä»å·¦ä¸‹å¼€å§‹</span><br><span class="line">    // æ³¨ï¼šæœ€é•¿å›æ–‡å­ä¸²ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥æ–¹æ³•</span><br><span class="line">    public static int countSubstrings(String s) &#123;</span><br><span class="line">        int len = s.length();</span><br><span class="line">        // dp[i][j]è¡¨ç¤ºä¸‹æ ‡i-jçš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯å›æ–‡å­—ç¬¦ä¸²ï¼Œj&gt;=i</span><br><span class="line">        boolean[][] dp = new boolean[len][len];</span><br><span class="line">        int res = 0;</span><br><span class="line">        // éå†é¡ºåºï¼šå·¦ä¸‹åˆ°å³ä¸Šï¼Œå› ä¸ºç”¨åˆ°[i+1][j-1]</span><br><span class="line">        for (int i = len - 1; i &gt;= 0; i --) &#123;</span><br><span class="line">            for (int j = i; j &lt; len; j ++) &#123;</span><br><span class="line">                if (s.charAt(i) == s.charAt(j)) &#123;</span><br><span class="line">                    // ç›¸å·®&lt;=1è‚¯å®šå›æ–‡ï¼Œä¸æ˜¯å°±è¦çœ‹ä¸­é—´æ˜¯ä¸æ˜¯</span><br><span class="line">                    if (j -i &lt;= 1 || dp[i + 1][j - 1]) &#123;</span><br><span class="line">                        dp[i][j] = true;</span><br><span class="line">                        res ++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ€é•¿å›æ–‡å­åºåˆ—"><a href="#æœ€é•¿å›æ–‡å­åºåˆ—" class="headerlink" title="æœ€é•¿å›æ–‡å­åºåˆ—"></a>æœ€é•¿å›æ–‡å­åºåˆ—</h2><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œæ‰¾å‡ºå…¶ä¸­æœ€é•¿çš„å›æ–‡å­åºåˆ—ï¼Œå¹¶è¿”å›è¯¥åºåˆ—çš„é•¿åº¦ã€‚</p>
<p>å­åºåˆ—å®šä¹‰ä¸ºï¼šä¸æ”¹å˜å‰©ä½™å­—ç¬¦é¡ºåºçš„æƒ…å†µä¸‹ï¼Œåˆ é™¤æŸäº›å­—ç¬¦æˆ–è€…ä¸åˆ é™¤ä»»ä½•å­—ç¬¦å½¢æˆçš„ä¸€ä¸ªåºåˆ—ã€‚</p>
<p>è¾“å…¥ï¼šs = â€œbbbabâ€<br>è¾“å‡ºï¼š4<br>è§£é‡Šï¼šä¸€ä¸ªå¯èƒ½çš„æœ€é•¿å›æ–‡å­åºåˆ—ä¸º â€œbbbbâ€ ã€‚</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">    </span><br><span class="line">    // æœ€é•¿å›æ–‡å­åºåˆ—</span><br><span class="line">    //01 dp[i][j] è¡¨ç¤º i-jåŒºé—´å†…çš„æœ€é•¿å›æ–‡å­åºåˆ—çš„é•¿åº¦ï¼›</span><br><span class="line">    //02 æ›´æ–°æ–¹æ³•æ˜¯ å¦‚æœ s[i] = s[j] é‚£å°±åœ¨ s[i-1][j-1]çš„åŸºç¡€ä¸Š+2ï¼›è¦æ˜¯ä¸ç›¸ç­‰çš„è¯ï¼Œé‚£å°±å– [i+1,j] å’Œ [i, j-1]åŒºé—´å†…æ¯”è¾ƒå¤§çš„é‚£ä¸ªå›æ–‡å­ä¸²æ•°ç›®ï¼Œä¹Ÿå°±æ˜¯max(dp[i+1][j], dp[i][j-1])ï¼›</span><br><span class="line">    //03 éå†é¡ºåº è¿˜æ˜¯ä»å·¦ä¸‹åˆ°å³ä¸Šï¼›</span><br><span class="line">    //04 åˆå§‹åŒ–å¯¹è§’çº¿</span><br><span class="line">    public static int longestPalindromeSubseq(String s) &#123;</span><br><span class="line">        int len = s.length();</span><br><span class="line">        // dpè¡¨ç¤ºå­—ç¬¦ä¸²i-jçš„æœ€é•¿å›æ–‡å­åºåˆ—é•¿åº¦</span><br><span class="line">        int[][] dp = new int[len][len];</span><br><span class="line">        // åˆå§‹åŒ–å¯¹è§’çº¿</span><br><span class="line">        for (int i = 0; i &lt; len; i ++) &#123;</span><br><span class="line">            dp[i][i] = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        // ä»å·¦ä¸‹å¼€å§‹éå†</span><br><span class="line">        for (int i = len - 1; i &gt;= 0; i --) &#123;</span><br><span class="line">            for (int j = i + 1; j &lt; len; j ++) &#123;</span><br><span class="line">                if (s.charAt(i) == s.charAt(j)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i + 1][j -1] + 2;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    dp[i][j] = Math.max(dp[i + 1][j], dp[i][j - 1]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[0][len - 1];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ¤æ–­å­åºåˆ—"><a href="#åˆ¤æ–­å­åºåˆ—" class="headerlink" title="åˆ¤æ–­å­åºåˆ—"></a>åˆ¤æ–­å­åºåˆ—</h2><p>ç»™å®šå­—ç¬¦ä¸² s å’Œ t ï¼Œåˆ¤æ–­ s æ˜¯å¦ä¸º t çš„å­åºåˆ—ã€‚</p>
<p>å­—ç¬¦ä¸²çš„ä¸€ä¸ªå­åºåˆ—æ˜¯åŸå§‹å­—ç¬¦ä¸²åˆ é™¤ä¸€äº›ï¼ˆä¹Ÿå¯ä»¥ä¸åˆ é™¤ï¼‰å­—ç¬¦è€Œä¸æ”¹å˜å‰©ä½™å­—ç¬¦ç›¸å¯¹ä½ç½®å½¢æˆçš„æ–°å­—ç¬¦ä¸²ã€‚ï¼ˆä¾‹å¦‚ï¼Œâ€aceâ€æ˜¯â€abcdeâ€çš„ä¸€ä¸ªå­åºåˆ—ï¼Œè€Œâ€aecâ€ä¸æ˜¯ï¼‰ã€‚</p>
<p>è¾“å…¥ï¼šs = â€œabcâ€, t = â€œahbgdcâ€<br>è¾“å‡ºï¼štrue</p>
<p>æ ‡ç­¾ï¼šåŒæŒ‡é’ˆã€åŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­å­åºåˆ—</span><br><span class="line">    // è¾“å…¥å­—ç¬¦ä¸²så’Œå­—ç¬¦ä¸²tï¼Œåˆ¤æ–­sæ˜¯å¦æ˜¯tçš„å­åºåˆ—  abcæ˜¯ajisbshcçš„å­åºåˆ—ï¼Œå‡ºç°é¡ºåºå¾—ä¸€æ ·</span><br><span class="line">    // æ€è·¯ï¼š1.åŒæŒ‡é’ˆ</span><br><span class="line">    public static boolean isSubsequence(String s, String t) &#123;</span><br><span class="line">        int i = 0, j = 0;</span><br><span class="line">        while (i &lt; s.length() &amp;&amp; j &lt; t.length()) &#123;</span><br><span class="line">            if (s.charAt(i) == t.charAt(j)) &#123;</span><br><span class="line">                i ++;</span><br><span class="line">            &#125;</span><br><span class="line">            j ++;</span><br><span class="line">        &#125;</span><br><span class="line">        return i == s.length();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // æ€è·¯2ï¼šåŠ¨æ€è§„åˆ’</span><br><span class="line">    // 1.å¯ä»¥ç”¨æœ€é•¿å…¬å…±å­åºåˆ—ï¼Œå¾—åˆ°çš„ç»“æœä¸ºsçš„é•¿åº¦ï¼Œå°±æ˜¯å­åºåˆ—ã€‚dpè¡¨ç¤ºå…¬å…±å­åºåˆ—é•¿åº¦</span><br><span class="line">    // 2.dpä¹Ÿå¯ä»¥è¡¨ç¤ºæ˜¯å¦æ˜¯å­åºåˆ—booleanï¼Œä½†æ˜¯çŠ¶æ€è½¬ç§»è¦æ³¨æ„ï¼šdp[i][j] = dp[i][j-1]; ä¸èƒ½æœ‰dp[i-1][j]ï¼Œå› ä¸ºå¯èƒ½å»æ‰sçš„ä¸€ä¸ªå­—ç¬¦ï¼Œå¯èƒ½å°±æ˜¯å­åºåˆ—äº†ï¼Œä½†æ˜¯åŠ ä¸Šä¸è¡Œ</span><br><span class="line">    public static boolean isSubsequence(String s, String t) &#123;</span><br><span class="line">        int len1 = s.length();</span><br><span class="line">        int len2 = t.length();</span><br><span class="line">        // å®šä¹‰dp[i][j]è¡¨ç¤ºs1å‰iä¸ªå­—ç¬¦å’Œs2å‰jä¸ªå­—ç¬¦çš„æœ€é•¿å…¬å…±å­åºåˆ—é•¿åº¦</span><br><span class="line">        int[][] dp = new int[len1 + 1][len2 + 1];</span><br><span class="line">        // åˆå§‹åŒ–çœ‹çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¾èµ–äºå“ªäº›çŠ¶æ€ï¼Œè¿™é‡Œæ˜¯ä¸Šå’Œå·¦</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">                if (s.charAt(i - 1) == t.charAt(j - 1)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i - 1][j - 1] + 1;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len1][len2] == len1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸åŒçš„å­åºåˆ—"><a href="#ä¸åŒçš„å­åºåˆ—" class="headerlink" title="ä¸åŒçš„å­åºåˆ—"></a>ä¸åŒçš„å­åºåˆ—</h2><p>ç»™ä½ ä¸¤ä¸ªå­—ç¬¦ä¸² s å’Œ t ï¼Œç»Ÿè®¡å¹¶è¿”å›åœ¨ s çš„ å­åºåˆ— ä¸­ t å‡ºç°çš„ä¸ªæ•°ï¼Œç»“æœéœ€è¦å¯¹ 109 + 7 å–æ¨¡ã€‚</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // ä¸åŒçš„å­åºåˆ—</span><br><span class="line">    // è¾“å…¥s1ï¼Œs2ï¼Œæ±‚s1çš„å­åºåˆ—ä¸­s2å‡ºç°çš„æ¬¡æ•°</span><br><span class="line">    // ä¾‹å¦‚ï¼šrabbbitä¸­rabbitå‡ºç°äº†3æ¬¡</span><br><span class="line">    // ä¸¤ä¸ªå­—ç¬¦ä¸²è°å¯¹åº”iè°å¯¹åº”jï¼Œæ— æ‰€è°“ã€‚çŠ¶æ€è½¬ç§»å¯¹äº†å°±è¡Œ</span><br><span class="line">    // babgbag bag è¿”å›5</span><br><span class="line">    public static int numDistinct(String s1, String s2) &#123;</span><br><span class="line">        int len1 = s1.length();</span><br><span class="line">        int len2 = s2.length();</span><br><span class="line">        // dp[i][j]è¡¨ç¤ºå­—ç¬¦ä¸²s1çš„å‰iä¸ªå­—ç¬¦çš„å­åºåˆ—ä¸­s2çš„å‰jä¸ªå­—ç¬¦å‡ºç°çš„æ¬¡æ•°</span><br><span class="line">        int[][] dp = new int[len1 + 1][len2 + 1];</span><br><span class="line">        // åˆå§‹åŒ– å…¶å®dp[0][j] å’Œ dp[i][0] æ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œä½†æ˜¯çœ‹çŠ¶æ€è½¬ç§»éœ€è¦ç¡®å®šåˆå§‹åŒ–</span><br><span class="line">        // æ³¨æ„åˆå§‹åŒ–ï¼Œdp[i][0] éƒ½éœ€è¦åˆå§‹åŒ–ä¸º1</span><br><span class="line">        for (int i = 0; i &lt; len1; i ++) &#123;</span><br><span class="line">            dp[i][0] = 1;</span><br><span class="line">        &#125;</span><br><span class="line">        dp[0][0] = 1;</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">                if (s1.charAt(i - 1) == s2.charAt(j - 1)) &#123;</span><br><span class="line">                    // ç›¸ç­‰çš„æƒ…å†µ jæ˜¯è¦åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œä¸èƒ½åŠ¨</span><br><span class="line">                    dp[i][j] = dp[i - 1][j - 1] + dp[i - 1][j];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // ä¸ç›¸ç­‰çš„æƒ…å†µ</span><br><span class="line">                    // æ³¨æ„ï¼šä¸æ˜¯ dp[i][j] = dp[i - 1][j] + dp[i - 2][j] + ....; è¿™ç§æ˜¯é‡å¤è®¡ç®—çš„</span><br><span class="line">                    dp[i][j] = dp[i - 1][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len1][len2];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ä¸¤ä¸ªå­—ç¬¦ä¸²çš„åˆ é™¤æ“ä½œ"><a href="#ä¸¤ä¸ªå­—ç¬¦ä¸²çš„åˆ é™¤æ“ä½œ" class="headerlink" title="ä¸¤ä¸ªå­—ç¬¦ä¸²çš„åˆ é™¤æ“ä½œ"></a>ä¸¤ä¸ªå­—ç¬¦ä¸²çš„åˆ é™¤æ“ä½œ</h2><p>ç»™å®šä¸¤ä¸ªå•è¯ word1 å’Œ word2 ï¼Œè¿”å›ä½¿å¾— word1 å’Œ  word2 ç›¸åŒæ‰€éœ€çš„æœ€å°æ­¥æ•°ã€‚</p>
<p>æ¯æ­¥ å¯ä»¥åˆ é™¤ä»»æ„ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„ä¸€ä¸ªå­—ç¬¦ã€‚</p>
<p>è¾“å…¥: word1 = â€œseaâ€, word2 = â€œeatâ€<br>è¾“å‡º: 2</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line">   </span><br><span class="line">    // ä¸¤ä¸ªå­—ç¬¦ä¸²çš„äº’ç›¸åˆ é™¤æ“ä½œ</span><br><span class="line">    // è¾“å…¥ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›ä½¿å¾—ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰çš„æœ€å°æ­¥æ•°ï¼Œæ¯ä¸€æ­¥å¯ä»¥åˆ é™¤ä»»æ„ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</span><br><span class="line">    // ä¾‹å¦‚ï¼šseaã€eat ä¸¤æ­¥</span><br><span class="line">    // æ€è·¯ï¼šç›´æ¥åŠ¨æ€è§„åˆ’</span><br><span class="line">    public static int minDistance(String s1, String s2) &#123;</span><br><span class="line">        int len1 = s1.length();</span><br><span class="line">        int len2 = s2.length();</span><br><span class="line">        // dp[i][j]è¡¨ç¤ºs1çš„å‰iä¸ªå­—ç¬¦å’Œs2çš„å‰jä¸ªå­—ç¬¦çš„åˆ é™¤è·ç¦»ï¼Œ</span><br><span class="line">        int[][] dp = new int[len1 + 1][len2 + 1];</span><br><span class="line">        // æ ¹æ®ä¸‹é¢çš„çŠ¶æ€è½¬ç§»æ¨æ–­å¦‚ä½•åˆå§‹åŒ–ï¼š</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            dp[i][0] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">            dp[0][j] = j;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">                if (s1.charAt(i - 1) == s2.charAt(j - 1)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i - 1][j - 1];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // ä¸ç›¸ç­‰ï¼Œä¸ç”¨è€ƒè™‘dp[i-1][j-1]ï¼Œå› ä¸ºè¿™ä¿©å·²ç»è€ƒè™‘äº†</span><br><span class="line">                    dp[i][j] = Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len1][len2];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼–è¾‘è·ç¦»"><a href="#ç¼–è¾‘è·ç¦»" class="headerlink" title="ç¼–è¾‘è·ç¦»"></a>ç¼–è¾‘è·ç¦»</h2><p>ç»™ä½ ä¸¤ä¸ªå•è¯ word1 å’Œ word2ï¼Œ è¯·è¿”å›å°† word1 è½¬æ¢æˆ word2 æ‰€ä½¿ç”¨çš„æœ€å°‘æ“ä½œæ•°  ã€‚</p>
<p>ä½ å¯ä»¥å¯¹ä¸€ä¸ªå•è¯è¿›è¡Œå¦‚ä¸‹ä¸‰ç§æ“ä½œï¼š<br>æ’å…¥ä¸€ä¸ªå­—ç¬¦<br>åˆ é™¤ä¸€ä¸ªå­—ç¬¦<br>æ›¿æ¢ä¸€ä¸ªå­—ç¬¦</p>
<p>è¾“å…¥ï¼šword1 = â€œhorseâ€, word2 = â€œrosâ€<br>è¾“å‡ºï¼š3</p>
<p>æ ‡ç­¾ï¼šåŠ¨æ€è§„åˆ’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    // ç¼–è¾‘è·ç¦»</span><br><span class="line">    // è¾“å…¥ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œæ±‚ç¼–è¾‘è·ç¦»ï¼šå¯ä»¥åˆ é™¤ã€æ’å…¥ã€æ›¿æ¢ã€‚ä½¿å¾—ç›¸ç­‰çš„æœ€å°‘æ“ä½œæ•°ã€‚</span><br><span class="line">    // intentionã€execution 5</span><br><span class="line">    public static int minDistance(String s1, String s2) &#123;</span><br><span class="line">        int len1 = s1.length();</span><br><span class="line">        int len2 = s2.length();</span><br><span class="line">        // dp[i][j]è¡¨ç¤ºs1å‰iä¸ªå­—ç¬¦å’Œs2çš„å‰jä¸ªå­—ç¬¦çš„æœ€å°ç¼–è¾‘è·ç¦»</span><br><span class="line">        int[][] dp = new int[len1 + 1][len2 + 1];</span><br><span class="line">        // å’Œåˆ é™¤è·ç¦»ä¸€æ ·çš„åˆå§‹åŒ–</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            dp[i][0] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">            dp[0][j] = j;</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 1; i &lt;= len1; i ++) &#123;</span><br><span class="line">            for (int j = 1; j &lt;= len2; j ++) &#123;</span><br><span class="line">                if (s1.charAt(i - 1) == s2.charAt(j - 1)) &#123;</span><br><span class="line">                    dp[i][j] = dp[i - 1][j - 1];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // åˆ ä¸€ä¸ª/åŠ ä¸€ä¸ª/ä¿®æ”¹ä¸€ä¸ª</span><br><span class="line">                    dp[i][j] = Math.min(dp[i - 1][j - 1] + 1, Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dp[len1][len2];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åˆ é™¤å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ç›¸é‚»é‡å¤é¡¹"><a href="#åˆ é™¤å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ç›¸é‚»é‡å¤é¡¹" class="headerlink" title="åˆ é™¤å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ç›¸é‚»é‡å¤é¡¹"></a>åˆ é™¤å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ç›¸é‚»é‡å¤é¡¹</h2><p>ç»™å‡ºç”±å°å†™å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸² Sï¼Œé‡å¤é¡¹åˆ é™¤æ“ä½œä¼šé€‰æ‹©ä¸¤ä¸ªç›¸é‚»ä¸”ç›¸åŒçš„å­—æ¯ï¼Œå¹¶åˆ é™¤å®ƒä»¬ã€‚<br>åœ¨ S ä¸Šåå¤æ‰§è¡Œé‡å¤é¡¹åˆ é™¤æ“ä½œï¼Œç›´åˆ°æ— æ³•ç»§ç»­åˆ é™¤ã€‚<br>åœ¨å®Œæˆæ‰€æœ‰é‡å¤é¡¹åˆ é™¤æ“ä½œåè¿”å›æœ€ç»ˆçš„å­—ç¬¦ä¸²ã€‚ç­”æ¡ˆä¿è¯å”¯ä¸€ã€‚</p>
<p>è¾“å…¥ï¼šâ€abbacaâ€<br>è¾“å‡ºï¼šâ€caâ€</p>
<p>æ ‡ç­¾ï¼šæ ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">    public static String removeDuplicates(String s) &#123;</span><br><span class="line">        Deque&lt;Character&gt; stack = new ArrayDeque&lt;&gt;();</span><br><span class="line">        for (char c : s.toCharArray()) &#123;</span><br><span class="line">            if (stack.isEmpty()) &#123;</span><br><span class="line">                stack.push(c);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                char top = stack.peek();</span><br><span class="line">                if (c == top) &#123;</span><br><span class="line">                    stack.pop();</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    stack.push(c);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line">        while (!stack.isEmpty()) &#123;</span><br><span class="line">            sb.append(stack.removeLast());</span><br><span class="line">        &#125;</span><br><span class="line">        return sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/25/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/mysql%E6%8A%80%E5%B7%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/25/myblog/%E5%90%8E%E7%AB%AF%E4%B9%8B%E8%B7%AF/mysql%E6%8A%80%E5%B7%A7/" class="post-title-link" itemprop="url">MysqlæŠ€å·§</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-25 16:25:11" itemprop="dateCreated datePublished" datetime="2022-09-25T16:25:11+08:00">2022-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-04 15:12:40" itemprop="dateModified" datetime="2023-06-04T15:12:40+08:00">2023-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">åç«¯å¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mysqlæ—¥æœŸå‡½æ•°"><a href="#mysqlæ—¥æœŸå‡½æ•°" class="headerlink" title="mysqlæ—¥æœŸå‡½æ•°"></a>mysqlæ—¥æœŸå‡½æ•°</h2><p>âœ…datepart()</p>
<p>è·å–æ—¥æœŸä¸­çš„å¹´æœˆæ—¥<br>datepart(â€˜2022-11-11 12:12:12â€™, â€˜yyyyâ€™)<br>å¾—åˆ°ï¼š2022ï¼Œä¹Ÿå¯ä»¥æ˜¯mmã€dd</p>
<p>âœ…datetrunc()</p>
<p>è·å–æ—¥æœŸçš„æŒ‡å®šèµ·å§‹æ—¥æœŸï¼Œæ¯”å¦‚ä¸€å¤©çš„å¼€å§‹<br>datetrunc(â€˜2022-11-11 12:12:12â€™, â€˜yyyyâ€˜)<br>å¾—åˆ°ï¼š2022-01-01 00:00:00</p>
<p>âœ…quarter()</p>
<p>è·å–æ—¥æœŸçš„å­£åº¦<br>quarter(â€˜2022-11-11 00:00:00â€™)<br>å¾—åˆ°ï¼š4</p>
<p>âœ…subdateå‡½æ•°</p>
<p>MySQLä¸­çš„SUBDATE()å‡½æ•°ç”¨äºä»ç»™å®šæ—¥æœŸå‡å»æŸé—´éš”æ—¶é—´ã€‚</p>
<p>ç”¨æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SUBDATE(date, INTERVAL expr, unit)</span><br><span class="line"></span><br><span class="line">æ­¤å‡½æ•°æ¥å—ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼š</span><br><span class="line">æ—¥æœŸï¼šç¬¬ä¸€ä¸ªæŒ‡å®šçš„æ—¥æœŸã€‚</span><br><span class="line">exprï¼šè¦å‡å»çš„æ—¶é—´/æ—¥æœŸé—´éš”çš„å€¼ã€‚è´Ÿçš„è¡¨ç¤ºè¯¥æ—¶é—´ä¹‹å</span><br><span class="line">å•ä½ï¼šé—´éš”çš„ç±»å‹ã€‚MICROSECOND\SECOND\MINUTE\HOUR\DAY\WEEK\MONTH\QUARTER\YEAR</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ï¼š<br><code>select subdate(&quot;2020-11-25&quot;, INTERVAL 30 DAY)</code></p>
<p>ä»Šå¤©çš„æ—¥æœŸï¼š<br><code>select curdate();  2022-10-30</code><br>ç°åœ¨çš„æ—¶é—´ï¼š<br><code>select curtime();   13:13:54</code></p>
<p>âœ…mysqlè®¡ç®—æ—¶é—´å·®å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.timestampdiff(interval, datetime1,datetime2)</span><br><span class="line">è¿”å›ï¼ˆæ—¶é—´2-æ—¶é—´1ï¼‰çš„æ—¶é—´å·®ï¼Œç»“æœå•ä½ç”±intervalå‚æ•°ç»™å‡º</span><br><span class="line">select timestampdiff(MINUTE,&#x27;2012-10-01&#x27;,&#x27;2013-01-13&#x27;); # 149760</span><br><span class="line">ä¸æ˜¯å››èˆäº”å…¥æ—¶é—´å·®ï¼Œè€Œæ˜¯ç›´æ¥å–æ•´æ•°éƒ¨åˆ†ï¼Œ1.9å¤©ç®—1å¤©ã€‚</span><br><span class="line">å¦‚æœå‰é¢åŠ avgæƒ³æ±‚å¹³å‡å€¼ï¼Œæ³¨æ„å¦‚æœä¸¤ä¸ªæ—¶é—´å­—æ®µä¸­æœ‰ä¸€ä¸ªä¸ºnullï¼Œåˆ™timestampdiffå‡½æ•°ä¼šè¿”å›nullï¼Œè€Œavgå‡½æ•°ä¼šå¿½ç•¥nullå€¼å¹¶è®¡ç®—å‰©ä½™æ—¶é—´å·®çš„å¹³å‡å€¼ï¼ˆä¸ºnullçš„é‚£ä¸€è¡Œå¿½ç•¥ï¼‰ã€‚</span><br><span class="line">ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œcoalesce(timediff,0) æˆ–è€… ifnull(timediff, 0)</span><br><span class="line">ä½†æ˜¯è¦æ³¨æ„timestampdiff(second, &quot;2023-04-30 00:00:00&quot;, 0) è¿”å›çš„å°†æ˜¯å¾ˆå¤§çš„è´Ÿæ•°ã€‚</span><br><span class="line"></span><br><span class="line">2.å¤©æ•°å·®å‡½æ•° datediff</span><br><span class="line">è¯­æ³•ï¼šä¼ å…¥ä¸¤ä¸ªæ—¥æœŸå‚æ•°ï¼Œæ¯”è¾ƒDAYå¤©æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å‡å»ç¬¬äºŒä¸ªå‚æ•°çš„å¤©æ•°å€¼ã€‚</span><br><span class="line">select datediff(â€˜2013-01-13â€™,â€˜2012-10-01â€™); # 104</span><br><span class="line"></span><br><span class="line">3.æ—¶é—´å·®å‡½æ•°ï¼štimediff</span><br><span class="line">è¯­æ³•ï¼štimediff(time1,time2)</span><br><span class="line">ç»“æœï¼šè¿”å›ä¸¤ä¸ªæ—¶é—´ç›¸å‡å¾—åˆ°çš„å·®å€¼ï¼Œtime1-time2ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ˜¯nullï¼Œè¿”å›ä¹Ÿæ˜¯nullã€‚</span><br><span class="line">select timediff(â€˜2018-05-21 14:51:43â€™,â€˜2018-05-19 12:54:43â€™);</span><br><span class="line"></span><br><span class="line">4.å…¶ä»–æ±‚æ—¶é—´çš„å‡½æ•°</span><br><span class="line">select now(); //2022-11-26 16:18:45</span><br><span class="line">select curdate(); //2022-11-26</span><br><span class="line">select curtime();</span><br></pre></td></tr></table></figure>

<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_53370274/article/details/122122628">https://blog.csdn.net/weixin_53370274/article/details/122122628</a></p>
<p>âœ…æ—¥æœŸè½¬æ¢ä¸ºæ—¶é—´æˆ³</p>
<p>10ä½çš„æ—¶é—´æˆ³ç²¾ç¡®åˆ°s<br>13ä½çš„æ—¶é—´æˆ³ç²¾ç¡®åˆ°msæ¯«ç§’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UNIX_TIMESTAMPå‡½æ•°:æ—¥æœŸè½¬æ—¶é—´æˆ³(10ä½)</span><br><span class="line">select unix_timestamp(now()); //1669452093</span><br><span class="line"></span><br><span class="line">FROM_UNIXTIMEå‡½æ•°ï¼šæ—¶é—´æˆ³è½¬æ—¥æœŸï¼ˆç¬¬äºŒä¸ªå‚æ•°éå¿…å¡«ï¼Œé»˜è®¤ï¼š%Y-%m-%d %H:%i:%sï¼‰</span><br><span class="line">select from_unixtime(unix_timestamp(now()));</span><br><span class="line">select from_unixtime(unix_timestamp(now()), &#x27;%Y~%m~%d %H:%i:%S&#x27;);  //2022~11~26 16:48:38</span><br></pre></td></tr></table></figure>

<p>âœ…æ—¥æœŸå’Œå­—ç¬¦ä¸²ç›¸äº’è½¬åŒ–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ—¥æœŸè½¬åŒ–ä¸ºæŒ‡å®šæ ¼å¼å­—ç¬¦ä¸²ï¼š</span><br><span class="line">select date_format(now(),&#x27;%Y-%m-%d %H:%i:%S&#x27;); //2022-11-26 16:45:59</span><br><span class="line"></span><br><span class="line">æŒ‡å®šæ ¼å¼å­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ—¥æœŸï¼š</span><br><span class="line">select str_to_date(&#x27;2022-11-29&#x27;, &#x27;%Y-%m-%d %H:%i:%S&#x27;); //2022-11-29 00:00:00</span><br></pre></td></tr></table></figure>

<h2 id="mySQL-with-asç”¨æ³•"><a href="#mySQL-with-asç”¨æ³•" class="headerlink" title="mySQL - with asç”¨æ³•"></a>mySQL - with asç”¨æ³•</h2><p>å¦‚æœä¸€æ•´å¥æŸ¥è¯¢ä¸­å¤šä¸ªå­æŸ¥è¯¢éƒ½éœ€è¦ä½¿ç”¨åŒä¸€ä¸ªå­æŸ¥è¯¢çš„ç»“æœï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨with asï¼Œå°†å…±ç”¨çš„å­æŸ¥è¯¢æå–å‡ºæ¥ï¼ŒåŠ ä¸ªåˆ«åã€‚åé¢æŸ¥è¯¢è¯­å¥å¯ä»¥ç›´æ¥ç”¨ï¼Œå¯¹äºå¤§é‡å¤æ‚çš„SQLè¯­å¥èµ·åˆ°äº†å¾ˆå¥½çš„ä¼˜åŒ–ä½œç”¨ã€‚</p>
<p>æ„é€ æ•°æ®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- åˆ†ç±»è¡¨</span><br><span class="line">CREATE TABLE category ( cid VARCHAR ( 32 ) PRIMARY KEY, cname VARCHAR ( 50 ) );</span><br><span class="line"></span><br><span class="line">-- å•†å“è¡¨</span><br><span class="line">CREATE TABLE products (</span><br><span class="line">	pid VARCHAR ( 32 ) PRIMARY KEY,</span><br><span class="line">	pname VARCHAR ( 50 ),</span><br><span class="line">	price INT,</span><br><span class="line">	flag VARCHAR ( 2 ),-- æ˜¯å¦ä¸Šæ¶æ ‡è®°ä¸ºï¼š1è¡¨ç¤ºä¸Šæ¶ã€0è¡¨ç¤ºä¸‹æ¶</span><br><span class="line">	category_id VARCHAR ( 32 ),</span><br><span class="line">	FOREIGN KEY ( category_id ) REFERENCES category ( cid ) </span><br><span class="line">);</span><br><span class="line">-- åˆ†ç±»æ•°æ®</span><br><span class="line">INSERT INTO category(cid,cname) VALUES(&#x27;c001&#x27;,&#x27;å®¶ç”µ&#x27;);</span><br><span class="line">INSERT INTO category(cid,cname) VALUES(&#x27;c002&#x27;,&#x27;é‹æœ&#x27;);</span><br><span class="line">INSERT INTO category(cid,cname) VALUES(&#x27;c003&#x27;,&#x27;åŒ–å¦†å“&#x27;);</span><br><span class="line">INSERT INTO category(cid,cname) VALUES(&#x27;c004&#x27;,&#x27;æ±½è½¦&#x27;);</span><br><span class="line"></span><br><span class="line">-- å•†å“æ•°æ®</span><br><span class="line">INSERT INTO products(pid, pname,price,flag,category_id) VALUES(&#x27;p001&#x27;,&#x27;å°ç±³ç”µè§†æœº&#x27;,5000,&#x27;1&#x27;,&#x27;c001&#x27;);</span><br><span class="line">INSERT INTO products(pid, pname,price,flag,category_id) VALUES(&#x27;p002&#x27;,&#x27;æ ¼åŠ›ç©ºè°ƒ&#x27;,3000,&#x27;1&#x27;,&#x27;c001&#x27;);</span><br><span class="line">INSERT INTO products(pid, pname,price,flag,category_id) VALUES(&#x27;p003&#x27;,&#x27;ç¾çš„å†°ç®±&#x27;,4500,&#x27;1&#x27;,&#x27;c001&#x27;);</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢ä¸¤ä¸ªå•†å“çš„å¹³å‡ä»·æ ¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WITH xm_gl AS ( SELECT * FROM products WHERE pname IN ( &#x27;å°ç±³ç”µè§†æœº&#x27;, &#x27;æ ¼åŠ›ç©ºè°ƒ&#x27; ) ) </span><br><span class="line">SELECT avg( price ) FROM xm_gl;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨with asè¿˜å¯ä»¥åˆ›å»ºå¤šä¸ªä¸´æ—¶è¡¨ï¼Œä½†æ˜¯è¦æ³¨æ„åŒä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰å†™ä¸€ä¸ªwithå°±å¤Ÿäº†ï¼Œå¦å¤–å­æŸ¥è¯¢éœ€è¦é€—å·éš”å¼€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WITH a AS ( SELECT * FROM category WHERE cname = &#x27;å®¶ç”µ&#x27; ),</span><br><span class="line">b AS ( SELECT * FROM products WHERE pname IN ( &#x27;å°ç±³ç”µè§†æœº&#x27;, &#x27;æ ¼åŠ›ç©ºè°ƒ&#x27; ) ) </span><br><span class="line">SELECT * FROM	a	LEFT JOIN b ON a.cid = b.category_id;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š<br>1ã€with as ç›¸å½“äºä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œä½†æ˜¯ä¸åŒäºè§†å›¾ï¼ˆcreate table asï¼‰ï¼Œä¸ä¼šå­˜å‚¨èµ·æ¥ï¼Œè¦ä¸selecté…åˆä½¿ç”¨ã€‚<br>2ã€åŒä¸€ä¸ªselectå‰å¯ä»¥æœ‰å¤šä¸ªä¸´æ—¶è¡¨ï¼Œå†™ä¸€ä¸ªwithå°±å¯ä»¥ï¼Œç”¨é€—å·éš”å¼€ï¼Œæœ€åä¸€ä¸ªwithè¯­å¥ä¸è¦ç”¨é€—å·ã€‚</p>
<p>æ‘˜è‡ªï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/397195826">https://zhuanlan.zhihu.com/p/397195826</a></p>
<p>å®æˆ˜æ€»ç»“ï¼š<br><code>with as</code>ä¸èƒ½å•ç‹¬åŠ <code>;</code>ä¸€å¥å•ç‹¬ä½¿ç”¨ï¼Œéœ€è¦åé¢è·Ÿselectä¸€èµ·ä½¿ç”¨ã€‚ç¬¬ä¸€ä¸ª<code>with as</code>å¾—åˆ°çš„ä¸´æ—¶è¡¨å¯ä»¥åœ¨ç¬¬äºŒä¸ªä¸´æ—¶è¡¨é‡Œç”¨ã€‚å¥½å¤„æ˜¯å¯ä»¥åˆ†æ­¥éª¤ç”Ÿæˆè¡¨ï¼Œä¸ç”¨åµŒå¥—å¾ˆå¤šå±‚ã€‚</p>
<p>å¦‚æœ<code>create table as</code> ï¼Œæ˜¯è¦åŠ åœ¨<code>with as</code>ä¹‹å‰çš„ã€‚</p>
<h2 id="mysql-case-when-ç”¨æ³•"><a href="#mysql-case-when-ç”¨æ³•" class="headerlink" title="mysql case when ç”¨æ³•"></a>mysql case when ç”¨æ³•</h2><p>MySQL çš„ case when çš„è¯­æ³•æœ‰ä¸¤ç§ï¼š</p>
<p>ç®€å•å‡½æ•°<br><code>CASE [col_name] WHEN [value1] THEN [result1]â€¦ELSE [default] END</code></p>
<p>æœç´¢å‡½æ•°<br><code>CASE WHEN [expr] THEN [result1]â€¦ELSE [default] END</code></p>
<p>ç®€å•å‡½æ•°ç”¨æ³•ï¼šæ ¹æ®caseå­—æ®µwhenå·²çŸ¥å¯èƒ½å€¼ï¼Œthenåˆ—å‡ºå·²çŸ¥è£…å¤‡ï¼ˆä¹Ÿå¯ä»¥æ˜¯è¡¨çš„æŸä¸ªå­—æ®µï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    NAME &#x27;è‹±é›„&#x27;,</span><br><span class="line">    CASE NAME</span><br><span class="line">        WHEN &#x27;å¾·è±æ–‡&#x27; THEN</span><br><span class="line">            &#x27;æ–§å­&#x27;</span><br><span class="line">        WHEN &#x27;å¾·ç›è¥¿äºš-ç›–ä¼¦&#x27; THEN</span><br><span class="line">            &#x27;å¤§å®å‰‘&#x27;</span><br><span class="line">        WHEN &#x27;æš—å¤œçŒæ‰‹-VN&#x27; THEN</span><br><span class="line">            &#x27;å¼©&#x27;</span><br><span class="line">        ELSE</span><br><span class="line">            &#x27;æ— &#x27;</span><br><span class="line">    END &#x27;è£…å¤‡&#x27;</span><br><span class="line">FROM</span><br><span class="line">    user_info;</span><br></pre></td></tr></table></figure>

<p>æœç´¢å‡½æ•°ç”¨æ³•ï¼šcase when æŸä¸ªå­—æ®µçš„å‡½æ•° thenæŸå€¼ï¼ˆä¹Ÿå¯ä»¥æ˜¯è¡¨çš„å­—æ®µï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># when è¡¨è¾¾å¼ä¸­å¯ä»¥ä½¿ç”¨ and è¿æ¥æ¡ä»¶</span><br><span class="line">SELECT</span><br><span class="line">    NAME &#x27;è‹±é›„&#x27;,</span><br><span class="line">    age &#x27;å¹´é¾„&#x27;,</span><br><span class="line">    CASE</span><br><span class="line">        WHEN age &lt; 18 THEN</span><br><span class="line">            &#x27;å°‘å¹´&#x27;</span><br><span class="line">        WHEN age &lt; 30 THEN</span><br><span class="line">            &#x27;é’å¹´&#x27;</span><br><span class="line">        WHEN age &gt;= 30</span><br><span class="line">        AND age &lt; 50 THEN</span><br><span class="line">            &#x27;ä¸­å¹´&#x27;</span><br><span class="line">        ELSE</span><br><span class="line">            &#x27;è€å¹´&#x27;</span><br><span class="line">    END &#x27;çŠ¶æ€&#x27;</span><br><span class="line">FROM</span><br><span class="line">    user_info;</span><br></pre></td></tr></table></figure>

<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenduzizhong/p/9590741.html">https://www.cnblogs.com/chenduzizhong/p/9590741.html</a></p>
<h2 id="mysqlæ‰¹é‡åˆ é™¤å¤§é‡æ•°æ®"><a href="#mysqlæ‰¹é‡åˆ é™¤å¤§é‡æ•°æ®" class="headerlink" title="mysqlæ‰¹é‡åˆ é™¤å¤§é‡æ•°æ®"></a>mysqlæ‰¹é‡åˆ é™¤å¤§é‡æ•°æ®</h2><p>å‡è®¾æœ‰ä¸€ä¸ªè¡¨(syslogs)æœ‰1000ä¸‡æ¡è®°å½•ï¼Œéœ€è¦åœ¨ä¸šåŠ¡ä¸åœæ­¢çš„æƒ…å†µä¸‹åˆ é™¤å…¶ä¸­statusid=1çš„æ‰€æœ‰è®°å½•ï¼Œå·®ä¸å¤šæœ‰600ä¸‡æ¡ï¼Œ ç›´æ¥æ‰§è¡Œ DELETE FROM syslogs WHERE statusid=1 ä¼šå‘ç°åˆ é™¤å¤±è´¥ï¼Œå› ä¸ºlock wait timeout exceedçš„é”™è¯¯ã€‚</p>
<p>å› ä¸ºè¿™æ¡è¯­å¥æ‰€æ¶‰åŠçš„è®°å½•æ•°å¤ªå¤šï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡LIMITå‚æ•°åˆ†æ‰¹åˆ é™¤ï¼Œæ¯”å¦‚æ¯10000æ¡è¿›è¡Œä¸€æ¬¡åˆ é™¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ MySQLè¿™æ ·çš„è¯­å¥æ¥å®Œæˆ:<br><code>DELETE FROM syslogs WHERE status=1 ORDER BY statusid LIMIT 10000;</code></p>
<p>å¦‚æœè¦ç”¨order by å¿…é¡»è¦å’Œ limit è”ç”¨ï¼Œå¦åˆ™è¢«ä¼˜åŒ–æ‰ã€‚ç„¶ååˆ†å¤šæ¬¡æ‰§è¡Œå°±å¯ä»¥æŠŠè¿™äº›è®°å½•æˆåŠŸåˆ é™¤ã€‚</p>
<p>æ³¨æ„ï¼š<br>æ‰§è¡Œå¤§æ‰¹é‡åˆ é™¤çš„æ—¶å€™æ³¨æ„è¦ä½¿ç”¨ä¸Šlimitã€‚å› ä¸ºå¦‚æœä¸ç”¨limitï¼Œåˆ é™¤å¤§é‡æ•°æ®å¾ˆæœ‰å¯èƒ½é€ æˆæ­»é”ã€‚<br><strong>å¦‚æœdeleteçš„whereè¯­å¥ä¸åœ¨ç´¢å¼•ä¸Šï¼Œå¯ä»¥å…ˆæ‰¾ä¸»é”®ï¼Œç„¶åæ ¹æ®ä¸»é”®åˆ é™¤æ•°æ®åº“ã€‚</strong><br>å¹³æ—¶updateå’Œdeleteçš„æ—¶å€™æœ€å¥½ä¹ŸåŠ ä¸Šlimit 1 æ¥é˜²æ­¢è¯¯æ“ä½œã€‚</p>
<p>mybatisä¸­çš„deleteè¯­å¥å¯ä»¥æœ‰è¿”å›ï¼Œè¿”å›ç»“æœintæ˜¯åˆ é™¤çš„æ¡æ•°ï¼Œå¦‚æœæ²¡åˆ é™¤ï¼Œè¿”å›0.</p>
<h2 id="deleteå’Œtruncateï¼Œdropçš„åŒºåˆ«"><a href="#deleteå’Œtruncateï¼Œdropçš„åŒºåˆ«" class="headerlink" title="deleteå’Œtruncateï¼Œdropçš„åŒºåˆ«"></a>deleteå’Œtruncateï¼Œdropçš„åŒºåˆ«</h2><p>1ã€deleteåˆ é™¤æ•°æ®çš„åŸç†:(deleteå±äºDMLè¯­å¥)</p>
<p>è¡¨ä¸­çš„æ•°æ®è¢«åˆ é™¤äº†ï¼Œä½†æ˜¯è¿™ä¸ªæ•°æ®åœ¨ç¡¬ç›˜ä¸Šçš„çœŸå®å­˜å‚¨ç©ºé—´ä¸ä¼šè¢«é‡Šæ”¾ã€‚<br>è¿™ç§åˆ é™¤è¡¨çš„ä¼˜ç‚¹æ˜¯ï¼šæ”¯æŒå›æ»šï¼Œåæ‚”äº†å¯ä»¥æ¢å¤æ•°æ®ï¼Œå¯ä»¥å¸¦whereæ¡ä»¶åˆ é™¤éƒ¨åˆ†æ•°æ®ï¼Œçµæ´»æ€§å¼ºã€‚<br>ç¼ºç‚¹ï¼šåˆ é™¤æ•ˆç‡æ¯”è¾ƒä½</p>
<p><code>delete from user;  //åˆ é™¤userè¡¨ä¸­çš„æ•°æ®ï¼Œä½†æ˜¯è¿™ç§åˆ é™¤æ•°æ®çš„æ–¹å¼æœ‰ç‚¹æ…¢ã€‚</code></p>
<p>2ã€truncateåˆ é™¤æ•°æ®çš„åŸç†:(DDL)</p>
<p>å¯ä»¥ç†è§£ä¸ºï¼Œdrop tableç„¶åå†create tableã€‚<br>æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œè¡¨è¢«ä¸€æ¬¡æˆªæ–­ï¼Œç‰©ç†åˆ é™¤<br>ä¼˜ç‚¹ï¼šå¿«é€Ÿï¼Œä¸èµ°äº‹åŠ¡ï¼Œä¸ä¼šé”è¡¨ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—å†™å…¥æ—¥å¿—æ–‡ä»¶<br>ç¼ºç‚¹ï¼šä¸æ”¯æŒå›æ»šï¼Œåªèƒ½åˆ é™¤è¡¨ä¸­æ‰€æœ‰æ•°æ®ï¼Œä¸èƒ½åˆ å•æ¡æ•°æ®<br>å¦‚æœè¯´å…¬å¸é¡¹ç›®é‡Œé¢æœ‰ä¸€å¼ å¤§è¡¨ï¼Œæ•°æ®éå¸¸å¤šï¼Œå‡ äº¿æ¡è®°å½•ï¼š<br>åˆ é™¤çš„æ—¶å€™ï¼Œä½¿ç”¨deleteï¼Œä¹Ÿè®¸æ‰§è¡Œä¸€ä¸ªå°æ—¶æ‰èƒ½åˆ é™¤å®Œï¼Œæ•ˆç‡æå…¶ä½ï¼›<br>å¯ä»¥é€‰æ‹©ä½¿ç”¨truncateåˆ é™¤è¡¨ä¸­çš„æ•°æ®ã€‚åªéœ€è¦ä¸åˆ°1sçš„æ—¶é—´å°±èƒ½åˆ é™¤ç»“æŸï¼Œæ•ˆç‡è¾ƒé«˜ã€‚<br>ä½†æ˜¯ä½¿ç”¨truncateä¹‹å‰ï¼Œå¿…é¡»ä»”ç»†è¯¢é—®å®¢æˆ·æ˜¯å¦çœŸçš„éœ€è¦åˆ é™¤ï¼Œå¹¶è­¦å‘Šåˆ é™¤ä¹‹åä¸å¯æ¢å¤ã€‚</p>
<p><code>truncate table user; //åˆ é™¤userè¡¨ä¸­çš„æ•°æ®ï¼Œå¿«é€Ÿã€‚</code></p>
<p><strong>truncateå’Œdeleteçš„å·®å¼‚</strong></p>
<blockquote>
<p>1ã€truncateæ˜¯DDLè¯­å¥ï¼Œå®ƒä¸å­˜åœ¨æ‰€è°“çš„â€œäº‹åŠ¡å›æ»šâ€ï¼›<br>deleteæ˜¯DMLè¯­å¥ï¼Œå®ƒæ‰§è¡Œå®Œæ˜¯å¯ä»¥rollbackçš„ã€‚<br>2ã€truncate tableè¿”å›å€¼æ˜¯0ï¼›<br>delete from tableè¿”å›å€¼æ˜¯è¢«åˆ é™¤çš„è¡Œæ•°ã€‚<br>3ã€InnoDBæ”¯æŒä¸€ä¸ªè¡¨ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼š<br>truncateä¼šä¸€æ¬¡æ€§æŠŠè¡¨å¹²æ‰ï¼Œä¸”ä¸ä¼šæ¿€æ´»è§¦å‘å™¨ï¼Œé€Ÿåº¦éå¸¸å¿«ï¼›<br>delete from tableåˆ™ä¼šä¸€è¡Œä¸€è¡Œåˆ é™¤ï¼Œä¼šæ¿€æ´»è§¦å‘å™¨ï¼Œé€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚<br>deleteæ•°æ®ï¼Œæ˜¯è¦è®°å½•æ—¥å¿—çš„ï¼Œtruncateè¡¨ä¸éœ€è¦è®°å½•æ—¥å¿—ã€‚<br>4ã€å½“è¡¨ä¸­æœ‰åˆ—è¢«å…¶å®ƒè¡¨ä½œä¸ºå¤–é”®(foreign key)æ—¶ï¼š<br>truncateä¼šæ˜¯å¤±è´¥ï¼› deleteåˆ™ä¼šæˆåŠŸã€‚<br>5ã€å½“è¡¨ä¸­æœ‰è‡ªå¢åˆ—æ—¶ï¼š<br>truncateä¼šä½¿å¾—è‡ªå¢åˆ—è®¡æ•°å¤åŸï¼›<br>deleteæ‰€æœ‰æ•°æ®åï¼Œè‡ªå¢åˆ—è®¡æ•°å¹¶ä¸ä¼šå¤åŸï¼Œè€Œæ˜¯ä¿æŒåŸæ¥çš„é¡ºåºè‡ªå¢ã€‚</p>
</blockquote>
<p>3ã€dropåˆ é™¤è¡¨æ“ä½œ</p>
<p>truncateå’Œdeleteæ˜¯åˆ é™¤è¡¨ä¸­çš„æ•°æ®ï¼Œè¡¨è¿˜åœ¨ã€‚</p>
<p><code>drop table è¡¨åï¼›// åˆ é™¤è¡¨ï¼Œä¸æ˜¯åˆ é™¤è¡¨ä¸­çš„æ•°æ®</code></p>
<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/jike11231/article/details/126551510">https://blog.csdn.net/jike11231/article/details/126551510</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/jkzyx123/article/details/127223589">https://blog.csdn.net/jkzyx123/article/details/127223589</a></p>
<h2 id="mysqlçš„ç©ºé—´"><a href="#mysqlçš„ç©ºé—´" class="headerlink" title="mysqlçš„ç©ºé—´"></a>mysqlçš„ç©ºé—´</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ç±»å‹	    å ç”¨ç©ºé—´	  å–å€¼èŒƒå›´</span><br><span class="line">tinyint	      1ä¸ªå­—èŠ‚	    -128~127</span><br><span class="line">smallint	2ä¸ªå­—èŠ‚	    -32768~32767</span><br><span class="line">mediumint	3ä¸ªå­—èŠ‚	    -223~ 223 - 1</span><br><span class="line">int	        4ä¸ªå­—èŠ‚	    -231~ 231- 1</span><br><span class="line">bigint	    8ä¸ªå­—èŠ‚	    -263~ 263- 1</span><br></pre></td></tr></table></figure>

<p>mysqlæ•°æ®ç±»å‹åŠå ç”¨ç©ºé—´ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/why_still_confused/article/details/125945285">https://blog.csdn.net/why_still_confused/article/details/125945285</a></p>
<h2 id="åˆ†åº“åˆ†è¡¨çš„è¡¨æ€ä¹ˆæŸ¥è¯¢"><a href="#åˆ†åº“åˆ†è¡¨çš„è¡¨æ€ä¹ˆæŸ¥è¯¢" class="headerlink" title="åˆ†åº“åˆ†è¡¨çš„è¡¨æ€ä¹ˆæŸ¥è¯¢"></a>åˆ†åº“åˆ†è¡¨çš„è¡¨æ€ä¹ˆæŸ¥è¯¢</h2><p>é€»è¾‘åº“æŸ¥è¯¢æš‚ä¸æ”¯æŒjoinæŸ¥è¯¢ã€‚</p>
<h2 id="Lindormäº‘åŸç”Ÿå¤šæ¨¡æ•°æ®åº“"><a href="#Lindormäº‘åŸç”Ÿå¤šæ¨¡æ•°æ®åº“" class="headerlink" title="Lindormäº‘åŸç”Ÿå¤šæ¨¡æ•°æ®åº“"></a>Lindormäº‘åŸç”Ÿå¤šæ¨¡æ•°æ®åº“</h2><p>Lindormæ˜¯é¢å‘ç‰©è”ç½‘ã€äº’è”ç½‘ã€è½¦è”ç½‘ç­‰è®¾è®¡å’Œä¼˜åŒ–çš„äº‘åŸç”Ÿå¤šæ¨¡è¶…èåˆæ•°æ®åº“ï¼Œæ”¯æŒå®½è¡¨ã€æ—¶åºã€æ–‡æœ¬ã€å¯¹è±¡ã€æµã€ç©ºé—´ç­‰å¤šç§æ•°æ®çš„ç»Ÿä¸€è®¿é—®å’Œèåˆå¤„ç†ï¼Œå¹¶å…¼å®¹SQLã€HBase/Cassandra/S3ã€TSDBã€HDFSã€Solrã€Kafkaç­‰å¤šç§æ ‡å‡†æ¥å£å’Œæ— ç¼é›†æˆä¸‰æ–¹ç”Ÿæ€å·¥å…·ï¼Œé€‚ç”¨äºæ—¥å¿—ã€ç›‘æ§ã€è´¦å•ã€å¹¿å‘Šã€ç¤¾äº¤ã€å‡ºè¡Œã€é£æ§ç­‰åœºæ™¯ï¼ŒLindormä¹Ÿæ˜¯ä¸ºé˜¿é‡Œå·´å·´æ ¸å¿ƒä¸šåŠ¡æä¾›æ”¯æ’‘çš„æ•°æ®åº“ä¹‹ä¸€ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/174640.html">https://help.aliyun.com/document_detail/174640.html</a></p>
<h2 id="mysqlæŸ¥å‡ºæ¥çš„æ•°æ®è½¬æ¢ä¸ºjsonæ ¼å¼-ç”¨ResultSet"><a href="#mysqlæŸ¥å‡ºæ¥çš„æ•°æ®è½¬æ¢ä¸ºjsonæ ¼å¼-ç”¨ResultSet" class="headerlink" title="mysqlæŸ¥å‡ºæ¥çš„æ•°æ®è½¬æ¢ä¸ºjsonæ ¼å¼ ç”¨ResultSet"></a>mysqlæŸ¥å‡ºæ¥çš„æ•°æ®è½¬æ¢ä¸ºjsonæ ¼å¼ ç”¨ResultSet</h2><p>å•çº¯mysqlè¯­å¥æ²¡å¾—åŠæ³•ã€‚<br>åªèƒ½åœ¨javaé‡Œæ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">import java.sql.Connection;</span><br><span class="line">import java.sql.DriverManager;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.sql.ResultSetMetaData;</span><br><span class="line">import java.sql.SQLException;</span><br><span class="line">import java.sql.Statement;</span><br><span class="line"></span><br><span class="line">import org.json.JSONArray;</span><br><span class="line">import org.json.JSONObject;</span><br><span class="line"></span><br><span class="line">public class MysqlToJSON &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String driver = &quot;com.mysql.jdbc.Driver&quot;;</span><br><span class="line">        String url = &quot;jdbc:mysql://localhost:3306/ontology&quot;;</span><br><span class="line">        String user = &quot;root&quot;;</span><br><span class="line">        String pwd = &quot;123456&quot;;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Class.forName(driver);</span><br><span class="line">            Connection con =DriverManager.getConnection(url,user,pwd);</span><br><span class="line">            Statement stet = con.createStatement();</span><br><span class="line"></span><br><span class="line">            String sql = &quot;select * from class_tab&quot;;</span><br><span class="line">            ResultSet rs = stet.executeQuery(sql);</span><br><span class="line">            ResultSetMetaData metaData = rs.getMetaData();</span><br><span class="line">            int columnCount= metaData.getColumnCount();</span><br><span class="line">            JSONArray array = new JSONArray();</span><br><span class="line">            while(rs.next())&#123;</span><br><span class="line">                JSONObject jsonObj = new JSONObject();</span><br><span class="line">                for(int i = 1; i &lt;= columnCount;i++)&#123;</span><br><span class="line">                    String columnName = metaData.getColumnLabel(i);</span><br><span class="line">                    String value =rs.getString(columnName);</span><br><span class="line">                    jsonObj.put(columnName, value);</span><br><span class="line">                &#125;</span><br><span class="line">                array.put(jsonObj);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;è½¬æ¢JSONæ•°æ®ï¼š&quot;);</span><br><span class="line">            System.out.println(array.toString());</span><br><span class="line">            </span><br><span class="line">        &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">            // TODO Auto-generated catch block</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mysqlçš„jsonæ•°æ®æ ¼å¼"><a href="#mysqlçš„jsonæ•°æ®æ ¼å¼" class="headerlink" title="mysqlçš„jsonæ•°æ®æ ¼å¼"></a>mysqlçš„jsonæ•°æ®æ ¼å¼</h2><p>mysql5.7ä»¥ä¸Šæä¾›äº†ä¸€ç§æ–°çš„å­—æ®µæ ¼å¼jsonï¼Œå¤§æ¦‚æ˜¯mysqlæƒ³æŠŠéå…³ç³»å‹å’Œå…³ç³»å‹æ•°æ®åº“ä¸€å£é€šåƒï¼Œæ‰€ä»¥æ¨å‡ºäº†è¿™ç§éå¸¸å¥½ç”¨çš„æ ¼å¼ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬çš„å¾ˆå¤šåŸºäºmongoDBçš„ä¸šåŠ¡éƒ½å¯ä»¥ç”¨mysqlå»å®ç°äº†ã€‚å½“ç„¶äº†ï¼Œ5.7çš„ç‰ˆæœ¬åªæ˜¯æœ€åŸºç¡€çš„ç‰ˆæœ¬ï¼Œå¯¹äºæµ·é‡æ•°æ®çš„æ•ˆç‡æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œä¸è¿‡è¿™äº›éƒ½åœ¨mysql8.0è§£å†³äº†ã€‚</p>
<p>âœ…åˆ›å»ºè¡¨ï¼Œæ’å…¥æ•°æ®</p>
<p>å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„å«jsonæ ¼å¼çš„æ•°æ®åº“è¡¨ï¼Œå…¶ä¸­json_valueå°±ä¸ºjsonæ ¼å¼çš„å­—æ®µã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `dept` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  `dept` varchar(255) DEFAULT NULL,</span><br><span class="line">  `json_value` json DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">insert into dept VALUES(1,&#x27;éƒ¨é—¨1&#x27;,&#x27;&#123;&quot;deptName&quot;: &quot;éƒ¨é—¨1&quot;, &quot;deptId&quot;: &quot;1&quot;, &quot;deptLeaderId&quot;: &quot;3&quot;&#125;&#x27;);</span><br><span class="line">insert into dept VALUES(2,&#x27;éƒ¨é—¨2&#x27;,&#x27;&#123;&quot;deptName&quot;: &quot;éƒ¨é—¨2&quot;, &quot;deptId&quot;: &quot;2&quot;, &quot;deptLeaderId&quot;: &quot;4&quot;&#125;&#x27;);</span><br><span class="line">insert into dept VALUES(3,&#x27;éƒ¨é—¨3&#x27;,&#x27;&#123;&quot;deptName&quot;: &quot;éƒ¨é—¨3&quot;, &quot;deptId&quot;: &quot;3&quot;, &quot;deptLeaderId&quot;: &quot;5&quot;&#125;&#x27;);</span><br></pre></td></tr></table></figure>

<p>âœ…åŸºç¡€æŸ¥è¯¢æ“ä½œ</p>
<p>å¦‚æœjsonå­—ç¬¦ä¸²ä¸æ˜¯æ•°ç»„ï¼Œåˆ™ç›´æ¥ä½¿ç”¨<code>$.å­—æ®µå</code><br>å¦‚æœjsonå­—ç¬¦ä¸²æ˜¯æ•°ç»„<code>[Array]</code>ï¼Œåˆ™ç›´æ¥ä½¿ç”¨<code>$[å¯¹åº”å…ƒç´ çš„ç´¢å¼•id]</code></p>
<p>ä½¿ç”¨ <code>jsonå­—æ®µå-&gt;â€™$.jsonå±æ€§â€™</code> è¿›è¡ŒæŸ¥è¯¢æ¡ä»¶<br>ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœæƒ³æŸ¥è¯¢deptLeaderId=5 çš„æ•°æ®ï¼Œé‚£ä¹ˆsqlè¯­å¥å¦‚ä¸‹ï¼š<br><code>SELECT * from dept WHERE json_value-&gt;&#39;$.deptLeaderId&#39;=&#39;5&#39;;</code></p>
<p>å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œæƒ³æŸ¥deptä¸ºâ€œéƒ¨é—¨3â€å’ŒdeptLeaderId=5çš„æ•°æ®ï¼Œsqlå¦‚ä¸‹ï¼š<br><code>SELECT * from dept WHERE json_value-&gt;&#39;$.deptLeaderId&#39;=&#39;5&#39; and dept=&#39;éƒ¨é—¨3&#39;;</code></p>
<p>jsonä¸­çš„å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œæƒ³æŸ¥è¯¢jsonæ ¼å¼ä¸­deptLeaderId=5å’ŒdeptId=5çš„æ•°æ®:<br><code>SELECT * from dept WHERE json_value-&gt;&#39;$.deptLeaderId&#39;=&#39;5&#39; and json_value-&gt;&#39;$.deptId&#39;=&#39;5&#39;;</code></p>
<p>ä¸¤ä¸ªæœ‰jsonå­—æ®µçš„è¡¨å…³è”æŸ¥è¯¢ï¼Œä¸€æ ·çš„ï¼š<br><code>SELECT * from dept,dept_leader  WHERE dept.json_value-&gt;&#39;$.deptLeaderId&#39;=dept_leader.json_value-&gt;&#39;$.id&#39; ;</code></p>
<p>è½¬è‡ªï¼šmysqlä¹‹jsonæ“ä½œä»¥åŠä¸€äº›jsonå‡½æ•°ï¼š<br><a target="_blank" rel="noopener" href="http://events.jianshu.io/p/40b153000fb2">http://events.jianshu.io/p/40b153000fb2</a></p>
<h2 id="mysqlè¡¨æ•°æ®è¿ç§»"><a href="#mysqlè¡¨æ•°æ®è¿ç§»" class="headerlink" title="mysqlè¡¨æ•°æ®è¿ç§»"></a>mysqlè¡¨æ•°æ®è¿ç§»</h2><p>ä¸æ˜¯ä¸€ä¸ªåº“åªèƒ½å…ˆselectå‡ºæ¥ï¼Œç„¶åæ„é€ insert</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ä»ä¸€ä¸ªè¡¨å¤åˆ¶æ•°æ®ï¼Œç„¶åæŠŠæ•°æ®æ’å…¥åˆ°å¦ä¸€ä¸ªæ–°è¡¨ä¸­ï¼š</span><br><span class="line">create  table æ–°è¡¨  as select * from æ—§è¡¨</span><br><span class="line"></span><br><span class="line">INSERT INTO SELECT è¯­å¥ä»ä¸€ä¸ªè¡¨å¤åˆ¶æ•°æ®ï¼Œç„¶åæŠŠæ•°æ®æ’å…¥åˆ°ä¸€ä¸ªå·²å­˜åœ¨çš„è¡¨ä¸­ï¼š</span><br><span class="line">insert into æ–°è¡¨ (select * from æ—§è¡¨)</span><br><span class="line"></span><br><span class="line">åªå¤åˆ¶å¸Œæœ›çš„åˆ—æ’å…¥åˆ°å¦ä¸€ä¸ªå·²å­˜åœ¨çš„è¡¨ä¸­ï¼š</span><br><span class="line">insert into æ–°è¡¨(å­—æ®µ1, å­—æ®µ2, å­—æ®µn)  select  å­—æ®µ1, å­—æ®µ2, å­—æ®µn from æ—§è¡¨</span><br></pre></td></tr></table></figure>


<h2 id="mysqlä¸­geometryç±»å‹çš„æ’å…¥"><a href="#mysqlä¸­geometryç±»å‹çš„æ’å…¥" class="headerlink" title="mysqlä¸­geometryç±»å‹çš„æ’å…¥"></a>mysqlä¸­geometryç±»å‹çš„æ’å…¥</h2><p>å¾—åŠ ä¸ª<code>geoFromText(â€˜lineString(...)â€™)</code></p>
<p>geometryé‚£ç¯‡åšå®¢é‡Œä¹Ÿæœ‰ã€‚</p>
<p>MySQLä¸­åœ°ç†ä½ç½®æ•°æ®æ‰©å±•geometryçš„ä½¿ç”¨å¿ƒå¾—ï¼š<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2074765">https://cloud.tencent.com/developer/article/2074765</a></p>
<h2 id="mysqlçš„mediumtextå’Œtext"><a href="#mysqlçš„mediumtextå’Œtext" class="headerlink" title="mysqlçš„mediumtextå’Œtext"></a>mysqlçš„mediumtextå’Œtext</h2><p>MysQLä¸­çš„mediumtextæ˜¯ä¸€ç§æ–‡æœ¬æ•°æ®ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨æœ€é•¿16777215ä¸ªå­—ç¬¦çš„æ–‡æœ¬æ•°æ®ã€‚å®ƒæ˜¯longtextå’Œtextç±»å‹ä¹‹é—´çš„ä¸­é—´ç±»å‹ï¼Œæ¯”textç±»å‹æ›´å¤§ï¼Œä½†æ¯”longtextç±»å‹æ›´å°ã€‚mediumtext é€šå¸¸ç”¨äºå­˜å‚¨å¤§é‡æ–‡æœ¬æ•°æ®ï¼Œä¾‹å¦‚æ–‡ç« ã€åšå®¢ç«™å­å’Œè¯„è®ºç­‰ã€‚</p>
<p>åœ¨msQLä¸­ï¼Œtextæ˜¯ä¸€ç§æ–‡æœ¬ç±»å‹ï¼Œå¯ä»¥å­˜å¥æœ€é•¿ 65535ä¸ªå­—ç¬¦çš„æ–‡æœ¬æ•°æ®ã€‚ textç±»å‹é€šå¸¸ç”¨äºå­˜å‚¨çš„å¤§é‡æ–‡æœ¬çš„æ•°æ®ã€‚ä¾‹å¦‚çŸ­ä¿¡ã€é‚®ä»¶å†…å®¹ã€ç®€çŸ­çš„è¯„è®ºç­‰ã€‚å¦‚æœéœ€è¦å­˜å‚¨æ›´é•¿çš„æ–‡æœ¬æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ longtextç±»å‹æˆ– mediumtextç±»å‹ã€‚</p>
<h2 id="mysqlçš„tinyint-unsignedèƒ½å­˜å¤šå¤§"><a href="#mysqlçš„tinyint-unsignedèƒ½å­˜å¤šå¤§" class="headerlink" title="mysqlçš„tinyint unsignedèƒ½å­˜å¤šå¤§"></a>mysqlçš„tinyint unsignedèƒ½å­˜å¤šå¤§</h2><p>mysqlçš„ tinyint unsignedèƒ½å­˜å¤šå¤§ï¼š<br>MySQLçš„tinyint unsigned æ•°æ®ç±»å‹å¯ä»¥å­˜å‚¨0åˆ°255ä¹‹é—´çš„æ•´æ•°ã€‚å®ƒä½¿ç”¨8ä½(1å­—èŠ‚ï¼‰å­˜å‚¨æ•°æ®ã€‚ç”±äºå®ƒæ˜¯æ— ç¬¦å·çš„ï¼Œå› æ­¤å®ƒä¸èƒ½å­˜å‚¨è´Ÿæ•°ï¼Œä½†å¯ä»¥å­˜å‚¨æ¯”æœ‰ç¬¦å·çš„tinyintï¼ˆ-128 - 127ï¼‰æ›´å¤§çš„æ­£æ•°å€¼ã€‚</p>
<h2 id="NOT-NULL-DEFAULT-quot-quot"><a href="#NOT-NULL-DEFAULT-quot-quot" class="headerlink" title="NOT NULL DEFAULT &quot;&quot;"></a><code>NOT NULL DEFAULT &quot;&quot;</code></h2><p>åœ¨æ•°æ®åº“è¡¨ä¸­ï¼Œ<code>NOT NULL DEFAULT &quot;&quot;</code> è¡¨ç¤ºè¯¥å­—æ®µä¸èƒ½ä¸ºç©ºä¸”å¦‚æœæ²¡æœ‰æŒ‡å®šå€¼ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼â€â€(ç©ºå®‡ç¬¦ä¸²)ã€‚å½“ä½¿ç”¨MyBatis æ’å…¥æ•°æ®æ—¶ï¼Œå¦‚æœè¯¥å­—æ®µä¼ é€’äº†nullå€¼ï¼Œå®ƒå°†å°è¯•å°†å…¶æ’å…¥æ•°æ®åº“ã€‚ç”±äºè¯¥å­—æ®µè¢«æŒ‡å®šä¸º NOT NULLï¼Œå› æ­¤æ•°æ®åº“ä¼šæ‹’ç»æ’å…¥null å€¼ï¼Œå¹¶è¿”å›é”™è¯¯æ¶ˆæ¯ã€‚å› æ­¤ï¼Œå»ºè®®åœ¨æ’å…¥æ•°æ®ä¹‹å‰æ£€æŸ¥æ¯ä¸ªå­—æ®µæ˜¯å¦å…·æœ‰æœ‰æ•ˆå€¼ï¼Œç‰¹åˆ«æ³¨æ„ä¼ çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡èµ‹å€¼ä¸ºnullï¼Œå°†æŠ¥é”™ã€‚</p>
<p>æ€»ä¹‹ï¼š<code>NOT NULL DEFAULT &quot;&quot;</code>ï¼Œè¦ä¹ˆä¸ä¼ ï¼Œè¦ä¹ˆä¼ énullã€‚ä¼ nullä¼šæŠ¥é”™ï¼Œè€Œä¸æ˜¯ä¼ nullç»™é»˜è®¤å€¼ã€‚</p>
<h2 id="æ’å…¥ä¹‹åæƒ³è·å–id"><a href="#æ’å…¥ä¹‹åæƒ³è·å–id" class="headerlink" title="æ’å…¥ä¹‹åæƒ³è·å–id"></a>æ’å…¥ä¹‹åæƒ³è·å–id</h2><p>useGeneratedkeys è·å–idï¼Œä¸æ˜¯ä»insertè¿”å›ï¼Œè€Œæ˜¯æ’å…¥å®ä½“ç±»çš„idã€‚</p>
<p>Long insertNum = myDao.insert(myDO);<br>Long id = myDO.getId();</p>
<h2 id="å…³è”è¡¨åˆ†æ¡ä»¶å…³è”"><a href="#å…³è”è¡¨åˆ†æ¡ä»¶å…³è”" class="headerlink" title="å…³è”è¡¨åˆ†æ¡ä»¶å…³è”"></a>å…³è”è¡¨åˆ†æ¡ä»¶å…³è”</h2><p>ä¾‹å¦‚aå…³è”bè¡¨ï¼Œaè¡¨status=1æ—¶ç”¨task_idå…³è”ï¼Œå¦åˆ™ç”¨flow_id<br>å…³è”ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from a left join b on </span><br><span class="line">case</span><br><span class="line">    when a.status=1 then a.task_id = b.task_id</span><br><span class="line">    else a.flow_id = b.flow_id</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·è²Œä¼¼è¿è¡Œæ—¶é—´é•¿ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦ç”¨<code>from a, b where (æ¡ä»¶1) or (æ¡ä»¶2)</code></p>
<h2 id="åˆ†ç»„è®¡æ•°"><a href="#åˆ†ç»„è®¡æ•°" class="headerlink" title="åˆ†ç»„è®¡æ•°"></a>åˆ†ç»„è®¡æ•°</h2><p>æœ‰ä¸€å¼ è¡¨ï¼Œæœ‰cityã€statuså­—æ®µï¼Œç›¸ç»Ÿè®¡å„ä¸ªåŸå¸‚ä¸åŒstatusçš„æ•°é‡å’Œæ¯”ä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å·²çŸ¥å„statusçš„æƒ…å†µä¸‹ï¼Œåˆ†åˆ—æ˜¾ç¤ºï¼š</span><br><span class="line">select city, count(1) as total, sum(status=0) as status_0, sum(status=1) as status_1</span><br><span class="line">from table</span><br><span class="line">group by city;</span><br><span class="line"></span><br><span class="line">ä¸æ˜statusæ˜¯ä»€ä¹ˆï¼Œåˆ†è¡Œæ˜¾ç¤ºï¼š</span><br><span class="line">select city, status, count(1) as count</span><br><span class="line">group by city, status;</span><br><span class="line"></span><br><span class="line">æ±‚ä¸¤ä¸ªæ•°çš„å•†ï¼Œå¹¶ä¿ç•™ä¸¤ä½å°æ•°ï¼š</span><br><span class="line">rount(num1 / num2, 2)</span><br></pre></td></tr></table></figure>

<h2 id="æƒ³å°†å¦ä¸€å¼ è¡¨çš„æ•°æ®æŒ‰ç…§æ˜ å°„æ›´æ–°åˆ°å¦ä¸€å¼ è¡¨ï¼š"><a href="#æƒ³å°†å¦ä¸€å¼ è¡¨çš„æ•°æ®æŒ‰ç…§æ˜ å°„æ›´æ–°åˆ°å¦ä¸€å¼ è¡¨ï¼š" class="headerlink" title="æƒ³å°†å¦ä¸€å¼ è¡¨çš„æ•°æ®æŒ‰ç…§æ˜ å°„æ›´æ–°åˆ°å¦ä¸€å¼ è¡¨ï¼š"></a>æƒ³å°†å¦ä¸€å¼ è¡¨çš„æ•°æ®æŒ‰ç…§æ˜ å°„æ›´æ–°åˆ°å¦ä¸€å¼ è¡¨ï¼š</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">update table_a</span><br><span class="line">left join table_b</span><br><span class="line">on table_a.task_id = table_b.task_id</span><br><span class="line">set table_a.status = table_b.status</span><br><span class="line">where table_a.task_id in ()</span><br></pre></td></tr></table></figure>
<p>ä»…æ›´æ–°table_açš„æ•°æ®ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/11/myblog/JAVA/java%20web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/11/myblog/JAVA/java%20web/" class="post-title-link" itemprop="url">java webç›¸å…³</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-11 14:46:24" itemprop="dateCreated datePublished" datetime="2022-09-11T14:46:24+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-20 15:33:03" itemprop="dateModified" datetime="2023-08-20T15:33:03+08:00">2023-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç½‘é¡µ502"><a href="#ç½‘é¡µ502" class="headerlink" title="ç½‘é¡µ502"></a>ç½‘é¡µ502</h2><p>502 Bad Gatewayæ˜¯æŒ‡é”™è¯¯ç½‘å…³ï¼Œæ— æ•ˆç½‘å…³ï¼›åœ¨äº’è”ç½‘ä¸­è¡¨ç¤ºä¸€ç§ç½‘ç»œé”™è¯¯ã€‚è¡¨ç°åœ¨WEBæµè§ˆå™¨ä¸­ç»™å‡ºçš„é¡µé¢åé¦ˆã€‚</p>
<p>æœåŠ¡ç«¯ä»£ç ä¸‹æ‰ï¼Œé‡æ–°éƒ¨ç½²çš„é—´éš™ï¼Œè®¿é—®æ¥å£ä¼š502.</p>
<h2 id="504é”™è¯¯"><a href="#504é”™è¯¯" class="headerlink" title="504é”™è¯¯"></a>504é”™è¯¯</h2><p>504é”™è¯¯ä»£è¡¨ç½‘å…³è¶…æ—¶ ï¼ˆGateway timeoutï¼‰ï¼Œæ˜¯æŒ‡æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†ï¼Œä½†æ˜¯æ²¡æœ‰åŠæ—¶ä»ä¸Šæ¸¸æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ã€‚</p>
<p>æ¥å£504è¶…æ—¶ï¼Œæ˜¯æœåŠ¡ç«¯è¿™è¾¹è¶…æ—¶æ–­å¼€è¯·æ±‚äº†ï¼Œéœ€è¦çœ‹ä¸€ä¸‹nginxé…ç½®ã€‚å¦‚æœæ˜¯tomcatï¼Œçœ‹ä¸€ä¸‹confä¸­é…ç½®çš„è¯·æ±‚è¶…æ—¶æ—¶é—´ã€‚</p>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><h3 id="âœ…nginxæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#âœ…nginxæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="âœ…nginxæ˜¯ä»€ä¹ˆï¼Ÿ"></a>âœ…nginxæ˜¯ä»€ä¹ˆï¼Ÿ</h3><blockquote>
<p>Nginxæ˜¯ååˆ†è½»é‡çº§çš„HTTPæœåŠ¡å™¨ã€‚Nginxï¼Œå®ƒçš„å‘éŸ³ä¸ºâ€œengine Xâ€ï¼Œæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªIMAP/POP3/SMTP ä»£ç†æœåŠ¡å™¨ã€‚</p>
<p>Ngnix æ˜¯äº’è”ç½‘ä¼ä¸šä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ä»£ç†æœåŠ¡å™¨ã€‚å®ƒå¯ä»¥ä¸ºåç«¯åˆ†å¸ƒå¼æœåŠ¡æä¾›è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥å°†åç«¯å¤šä¸ªæœåŠ¡åœ°å€èšåˆä¸ºå•ä¸ªåœ°å€æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<p>Nginxæ˜¯lgor Sysoevä¸ºä¿„ç½—æ–¯è®¿é—®é‡ç¬¬äºŒçš„rambler.ruç«™ç‚¹è®¾è®¡å¼€å‘çš„ã€‚ä»2004å¹´å‘å¸ƒè‡³ä»Šï¼Œå‡­å€Ÿå¼€æºçš„åŠ›é‡ï¼Œå·²ç»æ¥è¿‘æˆç†Ÿä¸å®Œå–„ã€‚<br>NginxåŠŸèƒ½ä¸°å¯Œï¼Œå¯ä½œä¸ºHTTPæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œé‚®ä»¶æœåŠ¡å™¨ã€‚æ”¯æŒFastCGIã€SSLã€Virtual Hostã€URL Rewriteã€Gzipç­‰åŠŸèƒ½ã€‚å¹¶ä¸”æ”¯æŒå¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ¨¡å—æ‰©å±•ã€‚<br>Nginxçš„ç¨³å®šæ€§ã€åŠŸèƒ½é›†ã€ç¤ºä¾‹é…ç½®æ–‡ä»¶å’Œä½ç³»ç»Ÿèµ„æºçš„æ¶ˆè€—è®©ä»–åæ¥å±…ä¸Šï¼Œåœ¨å…¨çƒæ´»è·ƒçš„ç½‘ç«™ä¸­æœ‰12.18%çš„ä½¿ç”¨æ¯”ç‡ï¼Œå¤§çº¦ä¸º2220ä¸‡ä¸ªç½‘ç«™ã€‚</p>
</blockquote>
<p>nginxæ˜¯æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨ï¼Œè´Ÿè½½å‡è¡¡ï¼Œåå‘ä»£ç†ï¼ŒæœåŠ¡å™¨æ¶æ„ã€‚</p>
<p>Nginxå‡­å€Ÿå…¶ç¨³å®šæ€§ã€ä½èµ„æºæ¶ˆè€—ã€ç®€å•é…ç½®å’Œä¸°å¯Œçš„åŠŸèƒ½ï¼Œä»åå¤šå¹´å‰åä¸è§ç»ä¼ çš„WebæœåŠ¡å™¨è½¯ä»¶ï¼Œå‘å±•åˆ°å¦‚ä»Šèƒ½å¤Ÿè·ŸApacheåŒ¹æ•Œçš„åœ°ä½ã€‚</p>
<p>1ã€ä½œä¸ºWebæœåŠ¡å™¨ï¼ŒNginxå¤„ç†é™æ€æ–‡ä»¶ã€ç´¢å¼•æ–‡ä»¶ï¼Œè‡ªåŠ¨ç´¢å¼•çš„æ•ˆç‡éå¸¸é«˜</p>
<p>2ã€ä½œä¸ºä»£ç†æœåŠ¡å™¨ï¼ŒNginxå¯ä»¥å®ç°æ— ç¼“å­˜çš„åå‘ä»£ç†åŠ é€Ÿï¼Œæé«˜ç½‘ç«™è¿è¡Œé€Ÿåº¦</p>
<p>3ã€ä½œä¸ºè´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼ŒNginxæ—¢å¯ä»¥åœ¨å†…éƒ¨ç›´æ¥æ”¯æŒRailså’ŒPHPï¼Œä¹Ÿå¯ä»¥æ”¯æŒHTTPä»£ç†æœåŠ¡å™¨å¯¹å¤–è¿›è¡ŒæœåŠ¡ï¼ŒåŒæ—¶è¿˜æ”¯æŒç®€å•çš„å®¹é”™å’Œåˆ©ç”¨ç®—æ³•è¿›è¡Œè´Ÿè½½å‡è¡¡</p>
<p>4ã€åœ¨æ€§èƒ½æ–¹é¢ï¼ŒNginxæ˜¯ä¸“é—¨ä¸ºæ€§èƒ½ä¼˜åŒ–è€Œå¼€å‘çš„ï¼Œå®ç°ä¸Šéå¸¸æ³¨é‡æ•ˆç‡ã€‚å®ƒé‡‡ç”¨å†…æ ¸Pollæ¨¡å‹ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„å¹¶å‘è¿æ¥ï¼Œæœ€å¤§å¯ä»¥æ”¯æŒå¯¹5ä¸‡ä¸ªå¹¶å‘è¿æ¥æ•°çš„å“åº”ï¼Œè€Œä¸”åªå ç”¨å¾ˆä½çš„å†…å­˜èµ„æº</p>
<p>5ã€åœ¨ç¨³å®šæ€§æ–¹é¢ï¼ŒNginxé‡‡å–äº†åˆ†é˜¶æ®µèµ„æºåˆ†é…æŠ€æœ¯ï¼Œä½¿å¾—CPUä¸å†…å­˜çš„å ç”¨ç‡éå¸¸ä½ã€‚Nginxå®˜æ–¹è¡¨ç¤ºï¼ŒNginxä¿æŒ1ä¸‡ä¸ªæ²¡æœ‰æ´»åŠ¨çš„è¿æ¥ï¼Œè€Œè¿™äº›è¿æ¥åªå ç”¨2.5MBå†…å­˜ï¼Œå› æ­¤ï¼Œç±»ä¼¼DOSè¿™æ ·çš„æ”»å‡»å¯¹Nginxæ¥è¯´åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•ä½œç”¨çš„</p>
<p>6ã€åœ¨é«˜å¯ç”¨æ€§æ–¹é¢ï¼ŒNginxæ”¯æŒçƒ­éƒ¨ç½²ï¼Œå¯åŠ¨é€Ÿåº¦ç‰¹åˆ«è¿…é€Ÿï¼Œå› æ­¤å¯ä»¥åœ¨ä¸é—´æ–­æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œå¯¹è½¯ä»¶ç‰ˆæœ¬æˆ–è€…é…ç½®è¿›è¡Œå‡çº§ï¼Œå³ä½¿è¿è¡Œæ•°æœˆä¹Ÿæ— éœ€é‡æ–°å¯åŠ¨ï¼Œå‡ ä¹å¯ä»¥åšåˆ°7x24å°æ—¶ä¸é—´æ–­åœ°è¿è¡Œ<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>è§£è¯»nginxï¼š<br>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_60274825/article/details/122101640">https://blog.csdn.net/weixin_60274825/article/details/122101640</a></p>
<h3 id="âœ…ä»€ä¹ˆæ˜¯ä»£ç†æœåŠ¡å™¨ï¼Ÿ"><a href="#âœ…ä»€ä¹ˆæ˜¯ä»£ç†æœåŠ¡å™¨ï¼Ÿ" class="headerlink" title="âœ…ä»€ä¹ˆæ˜¯ä»£ç†æœåŠ¡å™¨ï¼Ÿ"></a>âœ…ä»€ä¹ˆæ˜¯ä»£ç†æœåŠ¡å™¨ï¼Ÿ</h3><p>ä»£ç†æœåŠ¡å™¨æ˜¯ä»‹äºå®¢æˆ·ç«¯å’ŒWebæœåŠ¡å™¨ä¹‹é—´çš„å¦ä¸€å°æœåŠ¡å™¨ï¼Œæœ‰äº†å®ƒä¹‹åï¼Œæµè§ˆå™¨ä¸æ˜¯ç›´æ¥åˆ°WebæœåŠ¡å™¨å»å–å›ç½‘é¡µï¼Œè€Œæ˜¯é€šè¿‡å‘ä»£ç†æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä¿¡å·ä¼šå…ˆé€åˆ°ä»£ç†æœåŠ¡å™¨ï¼Œç”±ä»£ç†æœåŠ¡å™¨æ¥å–å›æµè§ˆå™¨æ‰€éœ€è¦çš„ä¿¡æ¯å¹¶ä¼ é€ç»™ä½ çš„æµè§ˆå™¨ã€‚</p>
<p><img src="/images/%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8.png"></p>
<p>ä»£ç†ä½äºWebå®¢æˆ·ç«¯å’ŒWebæœåŠ¡å™¨ä¹‹é—´ï¼Œæ‰®æ¼”â€œä¸­é—´äººâ€çš„è§’è‰²ã€‚<br>HTTPçš„ä»£ç†æœåŠ¡å™¨æ—¢æ˜¯WebæœåŠ¡å™¨åˆæ˜¯Webå®¢æˆ·ç«¯ã€‚</p>
<h3 id="âœ…ä»€ä¹ˆæ˜¯æ­£åå‘ä»£ç†"><a href="#âœ…ä»€ä¹ˆæ˜¯æ­£åå‘ä»£ç†" class="headerlink" title="âœ…ä»€ä¹ˆæ˜¯æ­£åå‘ä»£ç†"></a>âœ…ä»€ä¹ˆæ˜¯æ­£åå‘ä»£ç†</h3><p>æ­£å‘ä»£ç†æ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’ŒåŸå§‹æœåŠ¡å™¨ä¹‹é—´çš„æœåŠ¡å™¨ï¼Œä¸ºäº†ä»åŸå§‹æœåŠ¡å™¨å–çš„å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡ï¼ˆåŸå§‹æœåŠ¡å™¨ï¼‰ï¼Œç„¶åä»£ç†å‘åŸå§‹æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¿…é¡»è¦è¿›è¡Œä¸€äº›ç‰¹åˆ«çš„è®¾ç½®æ‰èƒ½ä½¿ç”¨æ­£å‘ä»£ç†ã€‚</p>
<p>æ­£å‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ï¼Œæ­£å‘ä»£ç†ä¸­ï¼Œproxyå’ŒclientåŒå±ä¸€ä¸ªLANï¼Œå¯¹serveré€æ˜ ï¼ˆå®¢æˆ·ç«¯æœåŠ¡ç«¯å¤šå¯¹ä¸€ï¼Ÿï¼‰</p>
<p>åå‘ä»£ç†æœåŠ¡å™¨ï¼šåœ¨æœåŠ¡å™¨ç«¯æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œç„¶åæŠŠè¯·æ±‚åˆ†å‘ç»™å…·ä½“çš„æœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼Œç„¶åå†å°†æœåŠ¡å™¨çš„å“åº”ç»“æœåé¦ˆç»™å®¢æˆ·ç«¯ã€‚Nginxå°±æ˜¯å…¶ä¸­çš„ä¸€ç§åå‘ä»£ç†æœåŠ¡å™¨è½¯ä»¶ã€‚</p>
<p>åå‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯æœåŠ¡ç«¯ï¼Œåå‘ä»£ç†ä¸­ï¼Œproxyå’ŒserveråŒå±ä¸€ä¸ªLANï¼Œå¯¹clienté€æ˜  ï¼ˆå®¢æˆ·ç«¯æœåŠ¡ç«¯å¤šå¯¹å¤šï¼‰</p>
<p>æ­£å‘ä»£ç†å®¢æˆ·ç«¯å¿…é¡»è®¾ç½®æ­£å‘ä»£ç†æœåŠ¡å™¨ï¼Œå½“ç„¶å‰ææ˜¯è¦çŸ¥é“æ­£å‘ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€ï¼Œè¿˜æœ‰ä»£ç†ç¨‹åºçš„ç«¯å£ã€‚<br>åå‘ä»£ç†æ­£å¥½ä¸æ­£å‘ä»£ç†ç›¸åï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ä»£ç†æœåŠ¡å™¨å°±åƒæ˜¯åŸå§‹æœåŠ¡å™¨ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è¿›è¡Œä»»ä½•ç‰¹åˆ«çš„è®¾ç½®ã€‚å®¢æˆ·ç«¯å‘åå‘ä»£ç†çš„å‘½åç©ºé—´ä¸­çš„å†…å®¹å‘é€æ™®é€šè¯·æ±‚ï¼Œæ¥ç€åå‘ä»£ç†å°†åˆ¤æ–­å‘å“ªä¸ªåŸå§‹æœåŠ¡å™¨è½¬äº¤è¯·æ±‚ï¼Œå¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>è§£è¯»nginxï¼š<br>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_60274825/article/details/122101640">https://blog.csdn.net/weixin_60274825/article/details/122101640</a></p>
<h3 id="âœ…nginxä¸tomcatä»€ä¹ˆå…³ç³»"><a href="#âœ…nginxä¸tomcatä»€ä¹ˆå…³ç³»" class="headerlink" title="âœ…nginxä¸tomcatä»€ä¹ˆå…³ç³»"></a>âœ…nginxä¸tomcatä»€ä¹ˆå…³ç³»</h3><p>nginxæ˜¯ä¸Šé¢åšwebä»£ç†æœåŠ¡å™¨çš„ï¼Œè€Œtomcatæ˜¯ä¸Šé¢åšçœŸæ­£webæœåŠ¡å™¨çš„ã€‚</p>
<p>nginxå¸¸ç”¨åšé™æ€å†…å®¹æœåŠ¡å’Œä»£ç†æœåŠ¡å™¨ï¼Œç›´é¢å¤–æ¥è¯·æ±‚è½¬å‘ç»™åé¢çš„åº”ç”¨æœåŠ¡ï¼ˆtomcatï¼Œdjangoä»€ä¹ˆçš„ï¼‰ï¼Œtomcatæ›´å¤šç”¨æ¥åšåšä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè®©java web appè·‘åœ¨é‡Œé¢çš„ä¸œè¥¿ï¼Œå¯¹åº”åŒçº§åˆ«çš„æœ‰jboss,jettyç­‰ä¸œè¥¿ã€‚</p>
<p>ä½†æ˜¯äº‹æ— ç»å¯¹ï¼Œnginxä¹Ÿå¯ä»¥é€šè¿‡æ¨¡å—å¼€å‘æ¥æä¾›åº”ç”¨åŠŸèƒ½ï¼Œtomcatä¹Ÿå¯ä»¥ç›´æ¥æä¾›httpæœåŠ¡ï¼Œé€šå¸¸ç”¨åœ¨å†…ç½‘å’Œä¸éœ€è¦æµæ§ç­‰å°å‹æœåŠ¡çš„åœºæ™¯ã€‚</p>
<p>ä¸¥æ ¼çš„æ¥è¯´ï¼ŒApache/Nginx åº”è¯¥å«åšã€ŒHTTP Serverã€ï¼›è€Œ Tomcat åˆ™æ˜¯ä¸€ä¸ªã€ŒApplication Serverã€ï¼Œæˆ–è€…æ›´å‡†ç¡®çš„æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªã€ŒServlet/JSPã€åº”ç”¨çš„å®¹å™¨ï¼ˆRuby/Python ç­‰å…¶ä»–è¯­è¨€å¼€å‘çš„åº”ç”¨ä¹Ÿæ— æ³•ç›´æ¥è¿è¡Œåœ¨ Tomcat ä¸Šï¼‰ã€‚</p>
<p>ä¸€ä¸ª HTTP Server å…³å¿ƒçš„æ˜¯ HTTP åè®®å±‚é¢çš„ä¼ è¾“å’Œè®¿é—®æ§åˆ¶ï¼Œæ‰€ä»¥åœ¨ Apache/Nginx ä¸Šä½ å¯ä»¥çœ‹åˆ°ä»£ç†ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚å®¢æˆ·ç«¯é€šè¿‡ HTTP Server è®¿é—®æœåŠ¡å™¨ä¸Šå­˜å‚¨çš„èµ„æºï¼ˆHTML æ–‡ä»¶ã€å›¾ç‰‡æ–‡ä»¶ç­‰ç­‰ï¼‰ã€‚é€šè¿‡ CGI æŠ€æœ¯ï¼Œä¹Ÿå¯ä»¥å°†å¤„ç†è¿‡çš„å†…å®¹é€šè¿‡ HTTP Server åˆ†å‘ï¼Œä½†æ˜¯ä¸€ä¸ª HTTP Server å§‹ç»ˆåªæ˜¯æŠŠæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å¦‚å®çš„é€šè¿‡ HTTP åè®®ä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>è€Œåº”ç”¨æœåŠ¡å™¨ï¼Œåˆ™æ˜¯ä¸€ä¸ªåº”ç”¨æ‰§è¡Œçš„å®¹å™¨ã€‚å®ƒé¦–å…ˆéœ€è¦æ”¯æŒå¼€å‘è¯­è¨€çš„ Runtimeï¼ˆå¯¹äº Tomcat æ¥è¯´ï¼Œå°±æ˜¯ Javaï¼‰ï¼Œä¿è¯åº”ç”¨èƒ½å¤Ÿåœ¨åº”ç”¨æœåŠ¡å™¨ä¸Šæ­£å¸¸è¿è¡Œã€‚å…¶æ¬¡ï¼Œéœ€è¦æ”¯æŒåº”ç”¨ç›¸å…³çš„è§„èŒƒï¼Œä¾‹å¦‚ç±»åº“ã€å®‰å…¨æ–¹é¢çš„ç‰¹æ€§ã€‚å¯¹äº Tomcat æ¥è¯´ï¼Œå°±æ˜¯éœ€è¦æä¾› JSP/Sevlet è¿è¡Œéœ€è¦çš„æ ‡å‡†ç±»åº“ã€Interface ç­‰ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œåº”ç”¨æœåŠ¡å™¨å¾€å¾€ä¹Ÿä¼šé›†æˆ HTTP Server çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸å¦‚ä¸“ä¸šçš„ HTTP Server é‚£ä¹ˆå¼ºå¤§ï¼Œæ‰€ä»¥åº”ç”¨æœåŠ¡å™¨å¾€å¾€æ˜¯è¿è¡Œåœ¨ HTTP Server çš„èƒŒåï¼Œæ‰§è¡Œåº”ç”¨ï¼Œå°†åŠ¨æ€çš„å†…å®¹è½¬åŒ–ä¸ºé™æ€çš„å†…å®¹ä¹‹åï¼Œé€šè¿‡ HTTP Server åˆ†å‘åˆ°å®¢æˆ·ç«¯ã€‚<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44517990/article/details/100712182">https://blog.csdn.net/weixin_44517990/article/details/100712182</a></p>
<h3 id="âœ…-springbootå†…ç½®tomcat-å’Œ-tomcat"><a href="#âœ…-springbootå†…ç½®tomcat-å’Œ-tomcat" class="headerlink" title="âœ… springbootå†…ç½®tomcat å’Œ tomcat"></a>âœ… springbootå†…ç½®tomcat å’Œ tomcat</h3><p>1.å†…ç½®çš„tomcatæ²¡æœ‰tomcatçš„ä¸»é¡µé¡µé¢<a target="_blank" rel="noopener" href="http://localhost:9999/%EF%BC%8C%E8%80%8C%E6%88%91%E4%BB%AC%E5%B9%B3%E6%97%B6%E7%94%A8%E7%9A%84%E5%A4%96%E7%BD%AE%E7%9A%84tomcat%E6%98%AF%E6%9C%89%E7%9A%84">http://localhost:9999/ï¼Œè€Œæˆ‘ä»¬å¹³æ—¶ç”¨çš„å¤–ç½®çš„tomcatæ˜¯æœ‰çš„</a></p>
<p>2.å†…ç½®çš„tomcatå¯ä»¥ç”¨mainè·‘é¡¹ç›®ï¼Œè€Œå¦‚æœè¦ç”¨å¤–ç½®çš„tomcatå°±éœ€è¦æŠŠé¡¹ç›®æ‰“æˆwaråŒ…ï¼Œç„¶åæ‹·è´åˆ°webappä¸‹è¿›è¡Œè¿è¡Œ</p>
<p>Tomcatï¼š<br>Tomcatæ˜¯ä¸€ä¸ªWebåº”ç”¨æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯Servletå®¹å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯ï¼Œè§£æå®¢æˆ·ç«¯clientå‘èµ·çš„requestï¼Œå¹¶ç»„è£…å‡ºHttpRequestã€åˆ›å»ºHttpResponseï¼Œå°†äºŒè€…äº¤äºå†…éƒ¨çš„HttpServletå¤„ç†å’Œå¡«å……</p>
<p>Tomcatæ˜ å°„å¤„ç†è¯·æ±‚çš„Servletæ˜¯é€šè¿‡web.xmlåšçš„ã€‚</p>
<p>SpringMVCä½¿ç”¨ä¸€ä¸ªDispatcherServletæ¥æ¥æ”¶æ‰€æœ‰çš„è¯·æ±‚ï¼Œå¹¶æŠŠå®ƒä»¬åˆ†å‘åˆ°ä¸åŒçš„controllerä¸­æ¥åšè¿›ä¸€æ­¥å¤„ç†ã€‚</p>
<p>SpringMVC = Spring + Webæ¡†æ¶ï¼ŒSpringè¿™éƒ¨åˆ†ä¸»è¦æ˜¯AOP/IOCå®¹å™¨ã€‚</p>
<p>SpringBootæ˜¯Springçš„æ‰©å±•ï¼Œç®€åŒ–äº†Springçš„é…ç½®ï¼Œé€šè¿‡starterçš„æ–¹å¼ç®€åŒ–äº†å¸¸ç”¨ç»„ä»¶ä¾èµ–çš„å¼•å…¥ï¼Œä½¿å…¶æ›´åŠ æ˜“ç”¨ã€‚</p>
<p>SpringBootå†…ç½®äº†tomcatã€‚</p>
<h3 id="âœ…tomcatå’Œspring-mvc"><a href="#âœ…tomcatå’Œspring-mvc" class="headerlink" title="âœ…tomcatå’Œspring mvc"></a>âœ…tomcatå’Œspring mvc</h3><p>tomcatæ—¢æ˜¯HttpæœåŠ¡å™¨ï¼ˆä¸ç”¨ä»£ç†çš„è¯ï¼Œå…¶å®æ˜¯åº”ç”¨æœåŠ¡å™¨ï¼‰ï¼ŒHttpæœåŠ¡å™¨ä¸Servletå®¹å™¨çš„åŠŸèƒ½ç•Œé™æ˜¯ï¼šå¯ä»¥æŠŠHTTPæœåŠ¡å™¨æƒ³è±¡æˆå‰å°çš„æ¥å¾…ï¼Œè´Ÿè´£ç½‘ç»œé€šä¿¡å’Œè§£æè¯·æ±‚ï¼ŒServletå®¹å™¨æ˜¯ä¸šåŠ¡éƒ¨é—¨ï¼Œè´Ÿè´£å¤„ç†ä¸šåŠ¡è¯·æ±‚ã€‚</p>
<p>Tomcatå’ŒServletä½œä¸ºWebæœåŠ¡å™¨å’ŒServletå®¹å™¨çš„ç»“åˆï¼Œå¯ä»¥æ¥å—ç½‘ç»œhttpè¯·æ±‚è§£æä¸ºServletè§„èŒƒçš„è¯·æ±‚å¯¹è±¡å’Œå“åº”å¯¹è±¡ã€‚æ¯”å¦‚ï¼ŒHttpServletRequestå¯¹è±¡æ˜¯Tomcatæä¾›çš„ï¼ŒServletæ˜¯è§„èŒƒï¼ŒTomcatæ˜¯å®ç°è§„èŒƒçš„Servletå®¹å™¨ã€‚tomcatç›‘å¬äº†ç«¯å£ï¼Œè¯·æ±‚è¿‡æ¥åï¼Œæ ¹æ®urlç­‰ä¿¡æ¯ï¼Œç¡®å®šè¦å°†è¯·æ±‚äº¤ç»™å“ªä¸ªservletå»å¤„ç†;ç„¶åè°ƒç”¨é‚£ä¸ªservletçš„serviceæ–¹æ³•ï¼Œserviceæ–¹æ³•è¿”å›ä¸€ä¸ªresponseå¯¹è±¡;<br>tomcatå†æŠŠè¿™ä¸ªresponseè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>SpringMVCæ˜¯å¤„ç†Servletè¯·æ±‚çš„åº”ç”¨ï¼Œå…¶ä¸­DispatcherServletå®ç°äº†Servletæ¥å£ï¼ŒTomcatè´Ÿè´£åŠ è½½å’Œè°ƒç”¨DispatcherServletã€‚åŒæ—¶ï¼ŒDispatcherServletæœ‰è‡ªå·±çš„å®¹å™¨ï¼ˆSpringMVCï¼‰å®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨è´Ÿè´£ç®¡ç†SpringMVCç›¸å…³çš„beanï¼Œæ¯”å¦‚Controlerå’ŒViewResolverç­‰ã€‚åŒæ—¶ï¼ŒSpringä¸­è¿˜æœ‰å…¶ä»–çš„Beanæ¯”å¦‚Serviceå’ŒDAOç­‰ï¼Œè¿™äº›ç”±å…¨å±€çš„Spring IOCå®¹å™¨ç®¡ç†ï¼Œå› æ­¤ï¼ŒSpringæœ‰ä¸¤ä¸ªIOCå®¹å™¨ã€‚</p>
<p>å¦‚æœåªæ˜¯ä½¿ç”¨spring(ä¸åŒ…å«springmvc)ï¼Œé‚£ä¹ˆæ˜¯tomcatå®¹å™¨è§£æxmlæ–‡ä»¶ï¼Œé€šè¿‡åå°„å®ä¾‹åŒ–å¯¹åº”çš„ç±»ï¼Œæ ¹æ®è¿™äº›servletè§„èŒƒå®ç°ç±»ï¼Œè§¦å‘å¯¹åº”çš„ä»£ç å¤„ç†é€»è¾‘ï¼Œè¿™ä¸ªæ—¶å€™tomcatè´Ÿè´£httpæŠ¥æ–‡çš„è§£æå’Œservletè°ƒåº¦çš„å·¥ä½œã€‚</p>
<p>å¦‚æœä½¿ç”¨spring mvcï¼Œé‚£ä¹ˆtomcatåªæ˜¯è§£æhttpæŠ¥æ–‡ï¼Œç„¶åå°†å…¶è½¬å‘ç»™dispatchsetvletï¼Œç„¶åç”±springmvcæ ¹æ®å…¶é…ç½®ï¼Œå®ä¾‹å¯¹åº”çš„ç±»ï¼Œæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ï¼Œç„¶åè¿”å›ç»“æœç»™dispatchservletï¼Œæœ€åç”±å®ƒè½¬å‘ç»™tomcat,ç”±tomcatè´Ÿè´£æ„å»ºhttpæŠ¥æ–‡æ•°æ®ã€‚</p>
<p>DispatcherServletï¼šæ˜¯Spring MVCä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ç°äº†Servletæ¥å£ã€‚æ‰€ä»¥éƒ¨ç½²åœ¨Tomcatä¸­çš„Springé¡¹ç›®ï¼Œå¯¹Tomcatæ¥è¯´ï¼Œéƒ½æ˜¯ä¸€ä¸ªservletã€‚</p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>spring mvcè¿˜éœ€è¦tomcatå—ï¼Ÿ<br>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œé»„æ³¥å·æ°´çŒ´å­ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40277163/article/details/124730530">https://blog.csdn.net/qq_40277163/article/details/124730530</a></p>
<h3 id="âœ…nginxä¸åŸŸåè§£æDNSä»€ä¹ˆå…³ç³»"><a href="#âœ…nginxä¸åŸŸåè§£æDNSä»€ä¹ˆå…³ç³»" class="headerlink" title="âœ…nginxä¸åŸŸåè§£æDNSä»€ä¹ˆå…³ç³»"></a>âœ…nginxä¸åŸŸåè§£æDNSä»€ä¹ˆå…³ç³»</h3><p>é¦–å…ˆï¼Œnginxæ˜¯webæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚ dnsæ˜¯åŸŸåè§£ææœåŠ¡å™¨ã€‚nginxä¸å¸¦dnsã€‚</p>
<p>ä½œä¸ºå°†åŸŸåå’ŒIPåœ°å€ç›¸äº’æ˜ å°„çš„ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œèƒ½å¤Ÿä½¿äººæ›´æ–¹ä¾¿åœ°è®¿é—®äº’è”ç½‘ã€‚è®¿é—®åŸŸåï¼Œdnså¸®å¿™è§£æåˆ°ipï¼Œç„¶åè®¿é—®è¿™ä¸ªåœ°å€çš„èµ„æºå‘ˆç°ç»™ä½ ã€‚hostså’Œnginxåœ¨åé¢ç”¨åˆ°ã€‚</p>
<p>hostsæ–‡ä»¶ï¼š<br>hostsæ–‡ä»¶æ˜¯ä¸ªæœ¬åœ°åŸŸåè§£ææ–‡ä»¶ï¼Œä¸ç®¡ä½ æ˜¯windwosè¿˜æ˜¯linuxï¼Œé‚£éƒ½æ˜¯æœ‰çš„ï¼Œä»–é‡Œé¢çš„æœ‰æ•ˆå†…å®¹ï¼Œå°±æ˜¯ä¸€ä¸ªä¸ªçš„ipå’ŒåŸŸåæ˜ å°„å…³ç³»ã€‚<br>windowsä¸€èˆ¬åœ¨ï¼šC:/Windows/System32/drivers/etc/hosts<br>Linuxçš„hostsæ–‡ä»¶è·¯å¾„ä¸€èˆ¬ï¼š/etc/hosts<br>æ¯”å¦‚ï¼š127.0.0.1 localhost<br>è¿™ä¸ªæ–‡ä»¶å…¶å®ä¹Ÿæ˜¯é…ç½®äº†ipå’ŒåŸŸåä¹‹é—´çš„æ˜ å°„å…³ç³»çš„æ•°æ®åº“ï¼Œæœ¬åœ°è¦æ˜¯æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå°±ä¼˜å…ˆç”¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„é…ç½®å»è§£æï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±é€šè¿‡dnsè§£æã€‚<br>æ³¨æ„ï¼šhostsæ–‡ä»¶åªèƒ½é…ç½®ipå’ŒåŸŸåçš„æ˜ å°„å…³ç³»ï¼Œä½†æ˜¯ä¸èƒ½é…ç½®ç«¯å£å·ï¼Œé»˜è®¤è®¿é—®80ç«¯å£</p>
<p>å› ä¸ºè¦è§£å†³ç«¯å£é—®é¢˜ï¼Œè¿™é‡Œå°±å¾—ä½¿ç”¨åå‘ä»£ç†è½¯ä»¶nginxï¼Œnginxä¸­çš„æ¯ä¸ªserverå°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†é…ç½®ï¼Œå¯ä»¥æœ‰å¤šä¸ªserverã€‚</p>
<p>ç†è§£ï¼š<em><strong>å®¢æˆ·ç«¯è¯·æ±‚ - dnsè§£æåŸŸå - è§£æåˆ°nginxæœåŠ¡å™¨çš„ip - nginxä»£ç†åˆ°tomcatæœåŠ¡å™¨+ç«¯å£ - tomcatå°†è¯·æ±‚ç»™servlet - servletçš„serviceå¤„ç†è¯·æ±‚ã€‚</strong></em></p>
<h3 id="âœ…nginxä¸CDNå†…å®¹åˆ†å‘ç½‘ç»œä»€ä¹ˆå…³ç³»"><a href="#âœ…nginxä¸CDNå†…å®¹åˆ†å‘ç½‘ç»œä»€ä¹ˆå…³ç³»" class="headerlink" title="âœ…nginxä¸CDNå†…å®¹åˆ†å‘ç½‘ç»œä»€ä¹ˆå…³ç³»"></a>âœ…nginxä¸CDNå†…å®¹åˆ†å‘ç½‘ç»œä»€ä¹ˆå…³ç³»</h3><p>cdnæ˜¯ç½‘ç»œï¼Œnginxæ˜¯æœåŠ¡å™¨ä¹Ÿæ˜¯è´Ÿè½½å‡è¡¡ã€‚</p>
<p>cdnï¼š<br>1ã€CDNçš„å…¨ç§°æ˜¯Content Delivery Networkï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œã€‚<br>2ã€å…¶åŸºæœ¬æ€è·¯æ˜¯å°½å¯èƒ½é¿å¼€äº’è”ç½‘ä¸Šæœ‰å¯èƒ½å½±å“æ•°æ®ä¼ è¾“é€Ÿåº¦å’Œç¨³å®šæ€§çš„ç“¶é¢ˆå’Œç¯èŠ‚ï¼Œä½¿å†…å®¹ä¼ è¾“çš„æ›´å¿«ã€æ›´ç¨³å®šã€‚<br>3ã€é€šè¿‡åœ¨ç½‘ç»œå„å¤„æ”¾ç½®èŠ‚ç‚¹æœåŠ¡å™¨æ‰€æ„æˆçš„åœ¨ç°æœ‰çš„äº’è”ç½‘åŸºç¡€ä¹‹ä¸Šçš„ä¸€å±‚æ™ºèƒ½è™šæ‹Ÿç½‘ç»œï¼ŒCDNç³»ç»Ÿèƒ½å¤Ÿå®æ—¶åœ°æ ¹æ®ç½‘ç»œæµé‡å’Œå„èŠ‚ç‚¹çš„è¿æ¥ã€è´Ÿè½½çŠ¶å†µä»¥åŠåˆ°ç”¨æˆ·çš„è·ç¦»å’Œå“åº”æ—¶é—´ç­‰ç»¼åˆä¿¡æ¯å°†ç”¨æˆ·çš„è¯·æ±‚é‡æ–°å¯¼å‘ç¦»ç”¨æˆ·æœ€è¿‘çš„æœåŠ¡èŠ‚ç‚¹ä¸Šã€‚<br>4ã€å…¶ç›®çš„æ˜¯ä½¿ç”¨æˆ·å¯å°±è¿‘å–å¾—æ‰€éœ€å†…å®¹ï¼Œè§£å†³ Internetç½‘ç»œæ‹¥æŒ¤çš„çŠ¶å†µï¼Œæé«˜ç”¨æˆ·è®¿é—®ç½‘ç«™çš„å“åº”é€Ÿåº¦**ã€‚<br>5ã€å†…å®¹åˆ†å‘ç½‘ç»œæ˜¯å»ºç«‹å¹¶è¦†ç›–åœ¨æ‰¿è½½ç½‘ä¹‹ä¸Šï¼Œç”±åˆ†å¸ƒåœ¨ä¸åŒåŒºåŸŸçš„è¾¹ç¼˜èŠ‚ç‚¹æœåŠ¡å™¨ç¾¤ç»„æˆçš„åˆ†å¸ƒå¼ç½‘ç»œã€‚</p>
<p>cdnçš„å·¥ä½œåŸç†ï¼š<br>CDNè¿™ä¸ªæŠ€æœ¯å…¶å®è¯´èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œæœ€åˆçš„æ ¸å¿ƒç†å¿µï¼Œå°±æ˜¯å°†å†…å®¹ç¼“å­˜åœ¨ç»ˆç«¯ç”¨æˆ·é™„è¿‘ã€‚</p>
<p>å†…å®¹æºä¸æ˜¯è¿œä¹ˆï¼Ÿé‚£ä¹ˆï¼Œæˆ‘ä»¬å°±åœ¨é è¿‘ç”¨æˆ·çš„åœ°æ–¹ï¼Œå»ºä¸€ä¸ªç¼“å­˜æœåŠ¡å™¨ï¼ŒæŠŠè¿œç«¯çš„å†…å®¹ï¼Œå¤åˆ¶ä¸€ä»½ï¼Œæ”¾åœ¨è¿™é‡Œï¼Œä¸å°±OKäº†ï¼Ÿ</p>
<p>å…·ä½“æ¥è¯´ï¼ŒCDNå°±æ˜¯é‡‡ç”¨æ›´å¤šçš„ç¼“å­˜æœåŠ¡å™¨ï¼ˆCDNè¾¹ç¼˜èŠ‚ç‚¹ï¼‰ï¼Œå¸ƒæ”¾åœ¨ç”¨æˆ·è®¿é—®ç›¸å¯¹é›†ä¸­çš„åœ°åŒºæˆ–ç½‘ç»œä¸­ã€‚å½“ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼Œåˆ©ç”¨å…¨å±€è´Ÿè½½æŠ€æœ¯ï¼Œå°†ç”¨æˆ·çš„è®¿é—®æŒ‡å‘è·ç¦»æœ€è¿‘çš„ç¼“å­˜æœåŠ¡å™¨ä¸Šï¼Œç”±ç¼“å­˜æœåŠ¡å™¨å“åº”ç”¨æˆ·è¯·æ±‚ã€‚ï¼ˆæœ‰ç‚¹åƒç”µå•†çš„æœ¬åœ°ä»“å§ï¼Ÿï¼‰</p>
<p>å¤§å®¶å¯èƒ½è§‰å¾—ï¼Œè¿™ä¸ªä¸å°±æ˜¯â€œé•œåƒæœåŠ¡å™¨â€å˜›ï¼Ÿå…¶å®ä¸ä¸€æ ·ã€‚é•œåƒæœåŠ¡å™¨æ˜¯æºå†…å®¹æœåŠ¡å™¨çš„å®Œæ•´å¤åˆ¶ã€‚è€ŒCDNï¼Œæ˜¯éƒ¨åˆ†å†…å®¹çš„ç¼“å­˜ï¼Œæ™ºèƒ½ç¨‹åº¦æ›´é«˜ã€‚</p>
<p><img src="/images/CDN.png"></p>
<p>å€Ÿç”¨é˜¿é‡Œäº‘å®˜ç½‘çš„ä¾‹å­ï¼Œæ¥ç®€å•ä»‹ç»CDNçš„å·¥ä½œåŸç†ã€‚</p>
<p>å‡è®¾é€šè¿‡CDNåŠ é€Ÿçš„åŸŸåä¸º <a href="http://www.a.comï¼Œæ¥å…¥CDNç½‘ç»œï¼Œå¼€å§‹ä½¿ç”¨åŠ é€ŸæœåŠ¡åï¼Œå½“ç»ˆç«¯ç”¨æˆ·ï¼ˆåŒ—äº¬ï¼‰å‘èµ·HTTPè¯·æ±‚æ—¶ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š">www.a.comï¼Œæ¥å…¥CDNç½‘ç»œï¼Œå¼€å§‹ä½¿ç”¨åŠ é€ŸæœåŠ¡åï¼Œå½“ç»ˆç«¯ç”¨æˆ·ï¼ˆåŒ—äº¬ï¼‰å‘èµ·HTTPè¯·æ±‚æ—¶ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</a></p>
<p>1ã€å½“ç»ˆç«¯ç”¨æˆ·ï¼ˆåŒ—äº¬ï¼‰å‘<a target="_blank" rel="noopener" href="http://www.a.comä¸‹çš„æŒ‡å®šèµ„æºå‘èµ·è¯·æ±‚æ—¶,é¦–å…ˆå‘ldns(æœ¬åœ°dns)å‘èµ·åŸŸåè§£æè¯·æ±‚./">www.a.comä¸‹çš„æŒ‡å®šèµ„æºå‘èµ·è¯·æ±‚æ—¶ï¼Œé¦–å…ˆå‘LDNSï¼ˆæœ¬åœ°DNSï¼‰å‘èµ·åŸŸåè§£æè¯·æ±‚ã€‚</a></p>
<p>2ã€LDNSæ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰<a target="_blank" rel="noopener" href="http://www.a.comçš„ipåœ°å€è®°å½•.å¦‚æœæœ‰,åˆ™ç›´æ¥è¿”å›ç»™ç»ˆç«¯ç”¨æˆ·;å¦‚æœæ²¡æœ‰,åˆ™å‘æˆæƒdnsæŸ¥è¯¢./">www.a.comçš„IPåœ°å€è®°å½•ã€‚å¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¿”å›ç»™ç»ˆç«¯ç”¨æˆ·ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™å‘æˆæƒDNSæŸ¥è¯¢ã€‚</a></p>
<p>3ã€å½“æˆæƒDNSè§£æ<a target="_blank" rel="noopener" href="http://www.a.comæ—¶,è¿”å›åŸŸåcname/">www.a.comæ—¶ï¼Œè¿”å›åŸŸåCNAME</a> <a target="_blank" rel="noopener" href="http://www.a.tbcdn.comå¯¹åº”ipåœ°å€./">www.a.tbcdn.comå¯¹åº”IPåœ°å€ã€‚</a></p>
<p>4ã€åŸŸåè§£æè¯·æ±‚å‘é€è‡³é˜¿é‡Œäº‘DNSè°ƒåº¦ç³»ç»Ÿï¼Œå¹¶ä¸ºè¯·æ±‚åˆ†é…æœ€ä½³èŠ‚ç‚¹IPåœ°å€ã€‚</p>
<p>5ã€LDNSè·å–DNSè¿”å›çš„è§£æIPåœ°å€ã€‚</p>
<p>6ã€ç”¨æˆ·è·å–è§£æIPåœ°å€ã€‚</p>
<p>7ã€ç”¨æˆ·å‘è·å–çš„IPåœ°å€å‘èµ·å¯¹è¯¥èµ„æºçš„è®¿é—®è¯·æ±‚ã€‚</p>
<p>8ã€å¦‚æœè¯¥IPåœ°å€å¯¹åº”çš„èŠ‚ç‚¹å·²ç¼“å­˜è¯¥èµ„æºï¼Œåˆ™ä¼šå°†æ•°æ®ç›´æ¥è¿”å›ç»™ç”¨æˆ·ï¼Œä¾‹å¦‚ï¼Œå›¾ä¸­æ­¥éª¤7å’Œ8ï¼Œè¯·æ±‚ç»“æŸã€‚</p>
<p>9ã€å¦‚æœè¯¥IPåœ°å€å¯¹åº”çš„èŠ‚ç‚¹æœªç¼“å­˜è¯¥èµ„æºï¼Œåˆ™èŠ‚ç‚¹å‘æºç«™å‘èµ·å¯¹è¯¥èµ„æºçš„è¯·æ±‚ã€‚è·å–èµ„æºåï¼Œç»“åˆç”¨æˆ·è‡ªå®šä¹‰é…ç½®çš„ç¼“å­˜ç­–ç•¥ï¼Œå°†èµ„æºç¼“å­˜è‡³èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼Œå›¾ä¸­çš„åŒ—äº¬èŠ‚ç‚¹ï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·ï¼Œè¯·æ±‚ç»“æŸã€‚</p>
<p>æ‰€ä»¥ï¼š<br>ï¼ˆ1ï¼‰CDNçš„åŠ é€Ÿèµ„æºæ˜¯è·ŸåŸŸåç»‘å®šçš„ã€‚<br>ï¼ˆ2ï¼‰é€šè¿‡åŸŸåè®¿é—®èµ„æºï¼Œé¦–å…ˆæ˜¯é€šè¿‡DNSåˆ†æŸ¥æ‰¾ç¦»ç”¨æˆ·æœ€è¿‘çš„CDNèŠ‚ç‚¹ï¼ˆè¾¹ç¼˜æœåŠ¡å™¨ï¼‰çš„IP<br>ï¼ˆ3ï¼‰é€šè¿‡IPè®¿é—®å®é™…èµ„æºæ—¶ï¼Œå¦‚æœCDNä¸Šå¹¶æ²¡æœ‰ç¼“å­˜èµ„æºï¼Œåˆ™ä¼šåˆ°æºç«™è¯·æ±‚èµ„æºï¼Œå¹¶ç¼“å­˜åˆ°CDNèŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·ï¼Œç”¨æˆ·ä¸‹ä¸€æ¬¡è®¿é—®æ—¶ï¼Œè¯¥CDNèŠ‚ç‚¹å°±ä¼šæœ‰å¯¹åº”èµ„æºçš„ç¼“å­˜äº†ã€‚</p>
<hr>
<p>nginxè´Ÿè½½å‡è¡¡ï¼šè´Ÿè½½å‡è¡¡å®é™…ä¸Šå°±æ˜¯å°†å¤§é‡è¯·æ±‚è¿›è¡Œåˆ†å¸ƒå¼å¤„ç†çš„ç­–ç•¥</p>
<p>Nginx ä½œä¸ºä¸€ä¸ªåŸºäº C å®ç°çš„é«˜æ€§èƒ½ Web æœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡ç³»åˆ—ç®—æ³•è§£å†³ä¸Šè¿°çš„è´Ÿè½½å‡è¡¡é—®é¢˜ã€‚å¹¶ä¸”ç”±äºå®ƒå…·æœ‰é«˜å¹¶å‘ã€é«˜å¯é æ€§ã€é«˜æ‰©å±•æ€§ã€å¼€æºç­‰ç‰¹ç‚¹ï¼Œæˆä¸ºå¼€å‘äººå‘˜å¸¸ç”¨çš„åå‘ä»£ç†å·¥å…·</p>
<p>1ã€æ­£å‘ä»£ç†</p>
<p>æ­£å‘ä»£ç†ï¼ˆForward Proxyï¼‰æœ€å¤§çš„ç‰¹ç‚¹æ˜¯ï¼Œå®¢æˆ·ç«¯éå¸¸æ˜ç¡®è¦è®¿é—®çš„æœåŠ¡å™¨åœ°å€ï¼Œå®ƒä»£ç†å®¢æˆ·ç«¯ï¼Œæ›¿å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ã€‚æ¯”å¦‚ï¼šç§‘å­¦ä¸Šç½‘ã€‚</p>
<p>å‡è®¾å®¢æˆ·ç«¯æƒ³è¦è®¿é—® Googleï¼Œå®ƒæ˜ç¡®çŸ¥é“å¾…è®¿é—®çš„æœåŠ¡å™¨åœ°å€æ˜¯ <a target="_blank" rel="noopener" href="https://www.google.com/%EF%BC%8C%E4%BD%86%E7%94%B1%E4%BA%8E%E6%9D%A1%E4%BB%B6%E9%99%90%E5%88%B6%EF%BC%8C%E5%AE%83%E6%89%BE%E6%9D%A5%E4%BA%86%E4%B8%80%E4%B8%AA%E8%83%BD%E5%A4%9F%E8%AE%BF%E9%97%AE%E5%88%B0">https://www.google.com/ï¼Œä½†ç”±äºæ¡ä»¶é™åˆ¶ï¼Œå®ƒæ‰¾æ¥äº†ä¸€ä¸ªèƒ½å¤Ÿè®¿é—®åˆ°</a> Google çš„â€æœ‹å‹â€ï¼šä»£ç†æœåŠ¡å™¨ã€‚å®¢æˆ·ç«¯æŠŠè¯·æ±‚å‘ç»™ä»£ç†æœåŠ¡å™¨ï¼Œç”±ä»£ç†æœåŠ¡å™¨ä»£æ›¿å®ƒè¯·æ±‚ Googleï¼Œæœ€ç»ˆå†å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¾¿æ˜¯ä¸€æ¬¡æ­£å‘ä»£ç†çš„è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¸­æœåŠ¡å™¨å¹¶ä¸çŸ¥é“çœŸæ­£å‘å‡ºè¯·æ±‚çš„æ˜¯è°ã€‚<br>ï¼ˆå®¢æˆ·ç«¯ - æ­£å‘ä»£ç† - æœåŠ¡å™¨ï¼‰</p>
<p>2ã€åå‘ä»£ç†</p>
<p>éšç€è¯·æ±‚é‡çš„çˆ†å‘å¼å¢é•¿ï¼ŒæœåŠ¡å™¨è§‰å¾—è‡ªå·±ä¸€ä¸ªäººå§‹ç»ˆæ˜¯åº”ä»˜ä¸è¿‡æ¥ï¼Œéœ€è¦å…„å¼ŸæœåŠ¡å™¨ä»¬å¸®å¿™ï¼Œäºæ˜¯å®ƒå–Šæ¥äº†è‡ªå·±çš„å…„å¼Ÿä»¥åŠä»£ç†æœåŠ¡å™¨æœ‹å‹ã€‚æ­¤æ—¶ï¼Œæ¥è‡ªä¸åŒå®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚å®é™…ä¸Šéƒ½å‘åˆ°äº†ä»£ç†æœåŠ¡å™¨å¤„ï¼Œå†ç”±ä»£ç†æœåŠ¡å™¨æŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†è¯·æ±‚åˆ†å‘ç»™å„ä¸ªæœåŠ¡å™¨ã€‚è¿™å°±æ˜¯åå‘ä»£ç†ï¼ˆReverse Proxyï¼‰ï¼Œåå‘ä»£ç†éšè—äº†æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œå®ƒä»£ç†çš„æ˜¯æœåŠ¡å™¨ç«¯ï¼Œä»£å…¶æ¥æ”¶è¯·æ±‚ã€‚æ¢å¥è¯è¯´ï¼Œåå‘ä»£ç†çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“å…·ä½“æ˜¯å“ªå°æœåŠ¡å™¨å¤„ç†äº†è‡ªå·±çš„è¯·æ±‚ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œæ—¢æé«˜äº†è®¿é—®é€Ÿåº¦ï¼Œåˆä¸ºå®‰å…¨æ€§æä¾›äº†ä¿è¯<br>ï¼ˆä¸€å †å®¢æˆ·ç«¯ - åå‘ä»£ç† - ä¸€å †æœåŠ¡å™¨ï¼‰</p>
<p>åœ¨è¿™ä¹‹ä¸­ï¼Œåå‘ä»£ç†éœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•è¿›è¡Œå‡è¡¡åˆ†å·¥ï¼Œæ§åˆ¶æµé‡ï¼Œé¿å…å‡ºç°å±€éƒ¨èŠ‚ç‚¹è´Ÿè½½è¿‡å¤§çš„é—®é¢˜ã€‚é€šä¿—çš„è®²ï¼Œå°±æ˜¯å¦‚ä½•ä¸ºæ¯å°æœåŠ¡å™¨åˆç†çš„åˆ†é…è¯·æ±‚ï¼Œä½¿å…¶æ•´ä½“å…·æœ‰æ›´é«˜çš„å·¥ä½œæ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚</p>
<p>3ã€è´Ÿè½½å‡è¡¡å¸¸ç”¨ç®—æ³•</p>
<p>è½®è¯¢ ï¼ˆround-robinï¼‰<br>è½®è¯¢ä¸ºè´Ÿè½½å‡è¡¡ä¸­è¾ƒä¸ºåŸºç¡€ä¹Ÿè¾ƒä¸ºç®€å•çš„ç®—æ³•ï¼Œå®ƒä¸éœ€è¦é…ç½®é¢å¤–å‚æ•°ã€‚å‡è®¾é…ç½®æ–‡ä»¶ä¸­å…±æœ‰ å°æœåŠ¡å™¨ï¼Œè¯¥ç®—æ³•éå†æœåŠ¡å™¨èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¹¶æŒ‰èŠ‚ç‚¹æ¬¡åºæ¯è½®é€‰æ‹©ä¸€å°æœåŠ¡å™¨å¤„ç†è¯·æ±‚ã€‚å½“æ‰€æœ‰èŠ‚ç‚¹å‡è¢«è°ƒç”¨è¿‡ä¸€æ¬¡åï¼Œè¯¥ç®—æ³•å°†ä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹é‡æ–°ä¸€è½®éå†ã€‚ç‰¹ç‚¹ï¼šç”±äºè¯¥ç®—æ³•ä¸­æ¯ä¸ªè¯·æ±‚æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨å¤„ç†ï¼Œå› æ­¤é€‚ç”¨äºæœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘çš„é›†ç¾¤æƒ…å†µï¼Œå…¶ä¸­æ¯ä¸ªæœåŠ¡å™¨æ‰¿è½½ç›¸åŒçš„è´Ÿè½½ã€‚ä½†å¯¹äºæœåŠ¡å™¨æ€§èƒ½ä¸åŒçš„é›†ç¾¤è€Œè¨€ï¼Œè¯¥ç®—æ³•å®¹æ˜“å¼•å‘èµ„æºåˆ†é…ä¸åˆç†ç­‰é—®é¢˜ã€‚</p>
<p>åŠ æƒè½®è¯¢<br>ä¸ºäº†é¿å…æ™®é€šè½®è¯¢å¸¦æ¥çš„å¼Šç«¯ï¼ŒåŠ æƒè½®è¯¢åº”è¿è€Œç”Ÿã€‚åœ¨åŠ æƒè½®è¯¢ä¸­ï¼Œæ¯ä¸ªæœåŠ¡å™¨ä¼šæœ‰å„è‡ªçš„ weightã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œweight çš„å€¼è¶Šå¤§æ„å‘³ç€è¯¥æœåŠ¡å™¨çš„æ€§èƒ½è¶Šå¥½ï¼Œå¯ä»¥æ‰¿è½½æ›´å¤šçš„è¯·æ±‚ã€‚è¯¥ç®—æ³•ä¸­ï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚æŒ‰æƒå€¼æ¯”ä¾‹åˆ†é…ï¼Œå½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œä¼˜å…ˆä¸ºå…¶åˆ†é…æƒå€¼æœ€å¤§çš„æœåŠ¡å™¨ã€‚ç‰¹ç‚¹ï¼šåŠ æƒè½®è¯¢å¯ä»¥åº”ç”¨äºæœåŠ¡å™¨æ€§èƒ½ä¸ç­‰çš„é›†ç¾¤ä¸­ï¼Œä½¿èµ„æºåˆ†é…æ›´åŠ åˆç†åŒ–ã€‚</p>
<p>IP å“ˆå¸Œï¼ˆIP hashï¼‰<br>ip_hash ä¾æ®å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯ IP çš„ hash å€¼æ¥åˆ†é…æœåŠ¡å™¨ï¼Œè¯¥ç®—æ³•å¯ä»¥ä¿è¯åŒ IP å‘å‡ºçš„è¯·æ±‚æ˜ å°„åˆ°åŒä¸€æœåŠ¡å™¨ï¼Œæˆ–è€…å…·æœ‰ç›¸åŒ hash å€¼çš„ä¸åŒ IP æ˜ å°„åˆ°åŒä¸€æœåŠ¡å™¨ã€‚ç‰¹ç‚¹ï¼šè¯¥ç®—æ³•åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†é›†ç¾¤éƒ¨ç½²ç¯å¢ƒä¸‹ Session ä¸å…±äº«çš„é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥ï¼š<br>Nginx ä½œä¸ºä¸€æ¬¾ä¼˜ç§€çš„åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•æ¥è§£å†³è¯·æ±‚é‡è¿‡å¤§æƒ…å†µä¸‹çš„æœåŠ¡å™¨èµ„æºåˆ†é…é—®é¢˜ã€‚è¾ƒä¸ºå¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰è½®è¯¢ã€åŠ æƒè½®è¯¢ã€IP å“ˆå¸Œç­‰ç­‰ï¼Œå¯åˆ†åˆ«åº”å¯¹ä¸åŒçš„è¯·æ±‚åœºæ™¯ã€‚</p>
<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>å¥½æ–‡ç« ï¼šä»å¯¹CDNçš„ç†è§£åˆ°Nginxè´Ÿè½½å‡è¡¡<br>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40409143/article/details/118330238">https://blog.csdn.net/qq_40409143/article/details/118330238</a></p>
<h3 id="âœ…nginxä¸RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#âœ…nginxä¸RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="âœ…nginxä¸RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>âœ…nginxä¸RPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ä»€ä¹ˆå…³ç³»ï¼Ÿ</h3><p>RPCæ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ˜¯ä¸€ç§è®¡ç®—æœºé€šä¿¡æ€æƒ³ã€‚</p>
<p>nginxæ˜¯ä»£ç†æœåŠ¡å™¨ã€‚å®ƒå¯ä»¥ä¸ºåç«¯åˆ†å¸ƒå¼æœåŠ¡æä¾›è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥å°†åç«¯å¤šä¸ªæœåŠ¡åœ°å€èšåˆä¸ºå•ä¸ªåœ°å€æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<p>Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´çš„äº¤äº’åœ¨æœ¬è´¨ä¸Šä¹Ÿå¯ä»¥ç†è§£ä¸º RPC æ•°æ®äº¤äº’ã€‚ä¹Ÿè®¸ä½ ä¼šäº‰è¾©è¯´ Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œèµ°çš„æ˜¯çŸ­è¿æ¥ï¼Œä¸¥æ ¼ä¸Šä¸èƒ½ç®—æ˜¯ RPC è°ƒç”¨ã€‚ Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´è¿˜å¯ä»¥èµ°å…¶å®ƒçš„åè®®ï¼Œæ¯”å¦‚ uwsgi åè®®ã€fastcgi åè®®ç­‰ï¼Œè¿™ä¸¤ä¸ªåè®®éƒ½æ˜¯é‡‡ç”¨äº†æ¯” HTTP åè®®æ›´åŠ èŠ‚çœæµé‡çš„äºŒè¿›åˆ¶åè®®ã€‚</p>
<p>è®²RPCã€RPCä¸nginxã€RPCä¸HTTPé—´çš„å…³ç³»çš„å¥½æ–‡ç« ï¼š<br><a target="_blank" rel="noopener" href="https://www.kancloud.cn/machh03/server/2096716">https://www.kancloud.cn/machh03/server/2096716</a></p>
<h3 id="âœ…ä¸gatewayæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#âœ…ä¸gatewayæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="âœ…ä¸gatewayæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>âœ…ä¸gatewayæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</h3><p>ç½‘å…³(Gateway)å°±æ˜¯ä¸€ä¸ªç½‘ç»œè¿æ¥åˆ°å¦ä¸€ä¸ªç½‘ç»œçš„â€œå…³å£â€ã€‚</p>
<p><img src="/images/gateway.png"></p>
<p>1ã€nginxä¹Ÿå¯ä»¥åšç½‘å…³ï¼Œæ˜¯ç”¨æˆ·è®¿é—®çš„æ€»å…¥å£ï¼Œä¹Ÿå°±æ˜¯å‰ç«¯é¡µé¢çš„å®¹å™¨ï¼Œæµé‡ç½‘å…³ã€‚</p>
<p>æµé‡ç½‘å…³æ˜¯å®šä¹‰å…¨å±€æ€§çš„ã€è·Ÿå…·ä½“çš„åç«¯ä¸šåŠ¡åº”ç”¨å’ŒæœåŠ¡å®Œå…¨æ— å…³çš„ç­–ç•¥ç½‘å…³ã€‚<br>æµé‡ç½‘å…³é€šå¸¸åªä¸“æ³¨äºå…¨å±€çš„Apiç®¡ç†ç­–ç•¥ï¼Œæ¯”å¦‚å…¨å±€æµé‡ç›‘æ§ã€æ—¥å¿—è®°å½•ã€å…¨å±€é™æµã€é»‘ç™½åå•æ§åˆ¶ã€æ¥å…¥è¯·æ±‚åˆ°ä¸šåŠ¡ç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡ç­‰ï¼Œæœ‰ç‚¹ç±»ä¼¼é˜²ç«å¢™ã€‚</p>
<p>2ã€gatewayçš„å®šä¹‰æ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªä¸šåŠ¡å¾®æœåŠ¡æ¥å¾—ï¼Œå±äºä¸šåŠ¡ç½‘å…³ã€‚æ˜¯ä»‹äºnignxä»¥åŠä¸šåŠ¡åº”ç”¨ä¹‹é—´çš„ä¸­é—´å±‚ï¼Œä¸»è¦è´Ÿè´£å°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„å¾®æœåŠ¡ä¸­ä»¥åŠå¯¹è¯·æ±‚çš„åˆæ³•æ€§è¿›è¡Œæ ¡éªŒã€‚</p>
<p>ä¸šåŠ¡ç½‘å…³é’ˆå¯¹å…·ä½“çš„ä¸šåŠ¡éœ€è¦æä¾›ç‰¹å®šçš„æµæ§ç­–ç•¥ã€ç¼“å­˜ç­–ç•¥ã€é‰´æƒè®¤è¯ç­–ç•¥ç­‰ç­‰ã€‚<br>ä¸šåŠ¡ç½‘å…³ä¸€èˆ¬éƒ¨ç½²åœ¨æµé‡ç½‘å…³ä¹‹åã€ä¸šåŠ¡ç³»ç»Ÿä¹‹å‰ï¼Œæ¯”æµé‡ç½‘å…³æ›´é è¿‘ä¸šåŠ¡ç³»ç»Ÿã€‚é€šå¸¸APIç½‘æŒ‡çš„æ˜¯ä¸šåŠ¡ç½‘å…³ã€‚ æœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šæ¨¡ç³Šæµé‡ç½‘å…³å’Œä¸šåŠ¡ç½‘å…³ï¼Œè®©ä¸€ä¸ªç½‘å…³æ‰¿æ‹…æ‰€æœ‰çš„å·¥ä½œ,æ‰€ä»¥è¿™ä¸¤è€…ä¹‹é—´å¹¶æ²¡æœ‰ä¸¥æ ¼çš„ç•Œçº¿ã€‚</p>
<hr>
<p>ç½‘å…³å¯ä»¥çœ‹åšç³»ç»Ÿä¸å¤–ç•Œè”é€šçš„å…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç½‘å…³è¿›è¡Œå¤„ç†ä¸€äº›éä¸šåŠ¡é€»è¾‘çš„é€»è¾‘ï¼Œæ¯”å¦‚æƒé™éªŒè¯ï¼Œç›‘æ§ï¼Œç¼“å­˜ï¼Œè¯·æ±‚è·¯ç”±ç­‰ç­‰ã€‚</p>
<p>1ã€nginxæ˜¯ç”¨æˆ·åˆ° å‰ç«¯å·¥ç¨‹ çš„ç½‘å…³ï¼Œå¯¹å¤–ç½‘å…³<br>nginxæ˜¯ç”¨Cè¯­è¨€å†™çš„<br>nginxåšç½‘å…³ï¼Œæ›´å¤šçš„æ˜¯åšæ€»æµé‡å…¥å£ï¼Œåå‘ä»£ç†ï¼Œè´Ÿè½½å‡è¡¡ç­‰ï¼Œè¿˜å¯ä»¥ç”¨æ¥åšwebæœåŠ¡å™¨ã€‚<br>Nginxåœ¨å…¶ä¸­æ‰®æ¼”çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ<br>åå‘ä»£ç†<br>è´Ÿè½½å‡è¡¡</p>
<p>2ã€gateway æ˜¯å‰ç«¯å·¥ç¨‹ åˆ° åå°æœåŠ¡å™¨ä¹‹é—´çš„ä¸€ä¸ª å¯¹å†…ç½‘å…³<br>gatewayæ˜¯javaè¯­è¨€çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå¯ä»¥åœ¨æ¡†æ¶ä¸Šè¿›è¡Œä»£ç çš„æ‰©å±•ä¸æ§åˆ¶ï¼Œä¾‹å¦‚ï¼šå®‰å…¨æ§åˆ¶ï¼Œç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼ŒXXS,SQLæ³¨å…¥ç­‰ï¼›æƒé™æ§åˆ¶ï¼Œé»‘ç™½åå•ï¼Œæ€§èƒ½ç›‘æ§ï¼Œæ—¥å¿—æ‰“å°ç­‰<br>gatewayçš„ä¸»è¦åŠŸèƒ½æœ‰ï¼Œè·¯ç”±ï¼Œæ–­è¨€ï¼Œè¿‡æ»¤å™¨ï¼Œåˆ©ç”¨å®ƒçš„è¿™äº›ç‰¹æ€§ï¼Œå¯ä»¥åšæµæ§ã€‚<br>SpringGatewayåœ¨å…¶ä¸­æ‰®æ¼”çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ<br>ç»Ÿä¸€é‰´æƒ</p>
<p>nginxä¸gatewayï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/yangbindxj/article/details/125040773">https://blog.csdn.net/yangbindxj/article/details/125040773</a></p>
<hr>
<p>ç½‘å…³æœåŠ¡çš„ç«¯å£å·é»˜è®¤æ˜¯80æˆ–è€…443.<br>ç›¸åŒç‚¹ï¼šéƒ½æ˜¯å¯ä»¥å®ç°å¯¹apiæ¥å£çš„æ‹¦æˆªï¼Œè´Ÿè½½å‡è¡¡ã€åå‘ä»£ç†ã€è¯·æ±‚è¿‡æ»¤ç­‰ï¼Œå¯ä»¥å®ç°å’Œç½‘å…³ä¸€æ ·çš„æ•ˆæœã€‚<br>Nginxå®ç°è´Ÿè½½å‡è¡¡çš„åŸç†å±äºæœåŠ¡å™¨ç«¯è´Ÿè½½å‡è¡¡å™¨ã€‚<br>Gatewayå®ç°è´Ÿè½½å‡è¡¡åŸç†é‡‡ç”¨æœ¬åœ°è´Ÿè½½å‡è¡¡å™¨çš„å½¢å¼ã€‚</p>
<h3 id="âœ…nginxä¸ç»Ÿä¸€æ¥å…¥æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#âœ…nginxä¸ç»Ÿä¸€æ¥å…¥æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="âœ…nginxä¸ç»Ÿä¸€æ¥å…¥æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>âœ…nginxä¸ç»Ÿä¸€æ¥å…¥æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</h3><p>ç»Ÿä¸€æ¥å…¥å±‚æ˜¯ï¼šæŒ‡çš„æ˜¯è®¾ç½®ä¸“å±ä¸€å±‚ï¼Œç»Ÿä¸€æ¥å…¥æ‰€æœ‰æµé‡ï¼ŒåŒ…æ‹¬ PC æµé‡ã€æ— çº¿æµé‡ã€IoT æµé‡ã€‚åœ¨åº”ç”¨å±‚ä¹‹ä¸Šçš„ä¸€å±‚ã€‚</p>
<p>å¦‚æœæ²¡æœ‰ç»Ÿä¸€æ¥å…¥å±‚ï¼Œä¹‹å‰çš„ä¸šåŠ¡æ–¹ï¼Œä¾‹å¦‚è´­ç‰©è½¦ã€å•†å“ç­‰éƒ½è¦è‡ªå·±ç»´æŠ¤ä¸€ä¸ªç½‘å…³ï¼Œè¿™å°±æ¶‰åŠåˆ°ç»´æŠ¤æˆæœ¬å’Œæœºå™¨æˆæœ¬ã€‚ä¾‹å¦‚å¸è½½ HTTPSï¼Œå¦‚æœæ‰€æœ‰ä¸šåŠ¡æ–¹éƒ½è¦ç”³è¯·è¯ä¹¦ï¼Œé‚£é€ æˆçš„åº”ç”¨æˆæœ¬æ˜¯éå¸¸é«˜çš„ã€‚å¯å¦‚æœå°†æ‰€æœ‰åŠŸèƒ½å…¨æ”¾åœ¨è¿™ä¸€å±‚è¿›è¡Œï¼Œå¥½å¤„éå¸¸æ˜æ˜¾ï¼šä¸€æ–¹é¢æ˜¯æœºå™¨é›†ä¸­ç®¡ç†èŠ‚çœæˆæœ¬ï¼›å¦å¤–ä¸€æ–¹é¢ï¼Œå¦‚æœé‡åˆ°æ–°çš„ç“¶é¢ˆå¯ä»¥åœ¨ç»Ÿä¸€æ¥å…¥å±‚é›†ä¸­ä¼˜åŒ–ï¼Œå¦‚è¯·æ±‚å“åº” Body ç»Ÿä¸€åœ¨è¿™ä¸€å±‚è¿›è¡Œå‹ç¼©å‡å°‘å¸¦å®½æ¶ˆè€—ï¼Œå‹ç¼©ä¼šæ¶ˆè€— CPUï¼Œå¯ä»¥åœ¨è¿™ä¸€å±‚é€šè¿‡ç¡¬ä»¶åŠ é€Ÿçš„æ–¹å¼é›†ä¸­ä¼˜åŒ–ç­‰ã€‚</p>
<p>é˜¿é‡Œç»Ÿä¸€æ¥å…¥å±‚ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/96510277?hmsr=toutiao.io">https://zhuanlan.zhihu.com/p/96510277?hmsr=toutiao.io</a></p>
<p>ç»Ÿä¸€æ¥å…¥å±‚æ–¹æ¡ˆï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Leo_wl/archive/2012/10/17/2728541.html">https://www.cnblogs.com/Leo_wl/archive/2012/10/17/2728541.html</a></p>
<p>ç»Ÿä¸€æ¥å…¥å±‚æ˜¯ç½‘å…³ä¸­æœ€å‰ç«¯çš„æœåŠ¡ï¼Œç»Ÿä¸€æ¥å…¥åˆ°é›†ç¾¤ä¸­ã€‚<br>æ‰€ä»¥ï¼Œç»Ÿä¸€æ¥å…¥å±‚åº”è¯¥æ˜¯åœ¨webä»£ç†æœåŠ¡å™¨nginxå‰çš„ã€‚</p>
<h2 id="nginxé…ç½®"><a href="#nginxé…ç½®" class="headerlink" title="nginxé…ç½®"></a>nginxé…ç½®</h2><h3 id="nginxé…ç½®æ–‡ä»¶ç»“æ„"><a href="#nginxé…ç½®æ–‡ä»¶ç»“æ„" class="headerlink" title="nginxé…ç½®æ–‡ä»¶ç»“æ„"></a>nginxé…ç½®æ–‡ä»¶ç»“æ„</h3><p>Main ä½äº nginx.conf é…ç½®æ–‡ä»¶çš„æœ€é«˜å±‚ï¼›<br>Main å±‚ä¸‹å¯ä»¥æœ‰ Eventã€HTTP å±‚ï¼›<br>Http å±‚ä¸‹é¢å…è®¸æœ‰å¤šä¸ª Server å±‚ï¼Œç”¨äºå¯¹ä¸åŒçš„ç½‘ç«™åšä¸åŒçš„é…ç½®ï¼›<br>Server å±‚ä¸‹é¢å…è®¸æœ‰å¤šä¸ª Locationï¼Œç”¨äºå¯¹ä¸åŒçš„è·¯å¾„è¿›è¡Œä¸åŒæ¨¡å—çš„é…ç½®ã€‚</p>
<p>1ã€mainï¼ˆæœ€ä¸Šé¢ï¼‰<br>å…¨å±€é…ç½®éƒ¨åˆ†ç”¨æ¥é…ç½®å¯¹æ•´ä¸ª server éƒ½æœ‰æ•ˆçš„å‚æ•°ã€‚ä¸»è¦ä¼šè®¾ç½®ä¸€äº›å½±å“ nginx æœåŠ¡å™¨æ•´ä½“è¿è¡Œçš„é…ç½®æŒ‡ä»¤ï¼Œä¸»è¦åŒ…æ‹¬é…ç½®è¿è¡Œ Nginx æœåŠ¡å™¨çš„ç”¨æˆ·ï¼ˆç»„ï¼‰ã€å…è®¸ç”Ÿæˆçš„ worker process æ•°ï¼Œè¿›ç¨‹ PID å­˜æ”¾è·¯å¾„ã€æ—¥å¿—å­˜æ”¾è·¯å¾„å’Œç±»å‹ä»¥ åŠé…ç½®æ–‡ä»¶çš„å¼•å…¥ç­‰<br>å…¨å±€Mainé…ç½®<br>user nginx;<br>worker_processes 1; #è®¾ç½®å€¼å’ŒCPUæ ¸å¿ƒæ•°ä¸€è‡´</p>
<p>error_log /var/log/nginx/error.log warn; #æ—¥å¿—ä½ç½®å’Œæ—¥å¿—çº§åˆ«<br>pid       /var/run/nginx.pid;</p>
<p>2.event<br>events å—æ¶‰åŠçš„æŒ‡ä»¤ä¸»è¦å½±å“ Nginx æœåŠ¡å™¨ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ï¼Œå¸¸ç”¨çš„è®¾ç½®åŒ…æ‹¬æ˜¯å¦å¼€å¯å¯¹å¤š worker process ä¸‹çš„ç½‘ç»œè¿æ¥è¿›è¡Œåºåˆ—åŒ–ï¼Œæ˜¯å¦å…è®¸åŒæ—¶æ¥æ”¶å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œé€‰å–å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹æ¥å¤„ç†è¿æ¥è¯·æ±‚ï¼Œæ¯ä¸ª worker process å¯ä»¥åŒæ—¶æ”¯æŒçš„æœ€å¤§è¿æ¥æ•°ç­‰ã€‚<br>Eventé…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3ã€http<br>http å…¨å±€å—é…ç½®çš„æŒ‡ä»¤åŒ…æ‹¬æ–‡ä»¶å¼•å…¥ã€MIME-TYPE å®šä¹‰ã€æ—¥å¿—è‡ªå®šä¹‰ã€è¿æ¥è¶…æ—¶æ—¶é—´ã€å•é“¾æ¥è¯·æ±‚æ•°ä¸Šé™ç­‰ã€‚<br>httpé…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  include       /etc/nginx/mime.types;</span><br><span class="line">  default_type application/octet-stream;</span><br><span class="line">  log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                    &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                    &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">  access_log /var/log/nginx/access.log main;</span><br><span class="line">  sendfile       on;</span><br><span class="line">  #tcp_nopush     on;</span><br><span class="line">  keepalive_timeout 65;</span><br><span class="line">  #gzip on;</span><br><span class="line">  include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4ã€server<br>Server å—ä¹Ÿè¢«å«åšâ€œè™šæ‹Ÿä¸»æœºâ€éƒ¨åˆ†ï¼Œå®ƒæè¿°çš„æ˜¯ä¸€ç»„æ ¹æ®ä¸åŒ server_name æŒ‡ä»¤é€»è¾‘åˆ†å‰²çš„èµ„æºï¼Œè¿™äº›è™šæ‹ŸæœåŠ¡å™¨å“åº” HTTP è¯·æ±‚ï¼Œå› æ­¤éƒ½åŒ…å«åœ¨ http éƒ¨åˆ†ã€‚æœ€å¸¸è§çš„é…ç½®æ˜¯æœ¬è™šæ‹Ÿæœºä¸»æœºçš„ç›‘å¬é…ç½®å’Œæœ¬è™šæ‹Ÿä¸»æœºçš„åç§°æˆ– IP é…ç½®ã€‚ä¸€ä¸ª server å—å¯ä»¥é…ç½®å¤šä¸ª location å—ã€‚<br>serveré…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name localhost;</span><br><span class="line">  location / &#123;</span><br><span class="line">      root   /usr/share/nginx/html;</span><br><span class="line">      index index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">  error_page   500 502 503 504 /50x.html;</span><br><span class="line">  location = /50x.html &#123;</span><br><span class="line">      root   /usr/share/nginx/html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginxé…ç½®ç»“æ„ï¼š<a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1729793004418584302&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1729793004418584302&amp;wfr=spider&amp;for=pc</a></p>
<p>èœé¸Ÿnginxé…ç½®ï¼š<a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/nginx-setup-intro.html">https://www.runoob.com/w3cnote/nginx-setup-intro.html</a></p>
<p>nginxé…ç½®è¯¦ç»†ä»‹ç»ï¼š<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_12218973/2457715">https://blog.51cto.com/u_12218973/2457715</a></p>
<h3 id="nginxè¶…æ—¶é…ç½®"><a href="#nginxè¶…æ—¶é…ç½®" class="headerlink" title="nginxè¶…æ—¶é…ç½®"></a>nginxè¶…æ—¶é…ç½®</h3><p>Nginxä¸»è¦æœ‰å››ç±»è¶…æ—¶è®¾ç½®ï¼šå®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®ã€DNSè§£æè¶…æ—¶è®¾ç½®ã€ä»£ç†è¶…æ—¶è®¾ç½®ï¼Œå¦‚æœä½¿ç”¨ngx_luaï¼Œåˆ™è¿˜æœ‰luaç›¸å…³çš„è¶…æ—¶è®¾ç½®ã€‚</p>
<p>1ã€å®¢æˆ·ç«¯è¶…æ—¶</p>
<p>å®¢æˆ·ç«¯è¶…æ—¶ä¸»è¦è®¾ç½®æœ‰è¯»å–è¯·æ±‚å¤´è¶…æ—¶æ—¶é—´ã€è¯»å–è¯·æ±‚ä½“è¶…æ—¶æ—¶é—´ã€å‘é€å“åº”è¶…æ—¶æ—¶é—´ã€é•¿è¿æ¥è¶…æ—¶æ—¶é—´ã€‚é€šè¿‡å®¢æˆ·ç«¯è¶…æ—¶è®¾ç½®é¿å…å®¢æˆ·ç«¯æ¶æ„æˆ–è€…ç½‘ç»œçŠ¶å†µä¸ä½³é€ æˆè¿æ¥é•¿æœŸå ç”¨ï¼Œå½±å“æœåŠ¡ç«¯çš„å¯å¤„ç†çš„èƒ½åŠ›ã€‚</p>
<p><strong>client_header_timeout time</strong>ï¼šè®¾ç½®è¯»å–å®¢æˆ·ç«¯è¯·æ±‚å¤´è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60sï¼Œå¦‚æœåœ¨æ­¤è¶…æ—¶æ—¶é—´å†…å®¢æˆ·ç«¯æ²¡æœ‰å‘é€å®Œè¯·æ±‚å¤´ï¼Œåˆ™å“åº”408ï¼ˆRequestTime-outï¼‰çŠ¶æ€ç ç»™å®¢æˆ·ç«¯ã€‚</p>
<p><strong>client_body_timeout time</strong>ï¼šè®¾ç½®è¯»å–å®¢æˆ·ç«¯å†…å®¹ä½“è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60sï¼Œæ­¤è¶…æ—¶æ—¶é—´æŒ‡çš„æ˜¯ä¸¤æ¬¡æˆåŠŸè¯»æ“ä½œé—´éš”æ—¶é—´ï¼Œè€Œä¸æ˜¯å‘é€æ•´ä¸ªè¯·æ±‚ä½“çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨æ­¤è¶…æ—¶æ—¶é—´å†…å®¢æˆ·ç«¯æ²¡æœ‰å‘é€ä»»ä½•è¯·æ±‚ä½“ï¼Œåˆ™å“åº”408ï¼ˆRequestTime-outï¼‰çŠ¶æ€ç ç»™å®¢æˆ·ç«¯ã€‚</p>
<p><strong>send_timeout time</strong>ï¼šè®¾ç½®å‘é€å“åº”åˆ°å®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60sï¼Œæ­¤è¶…æ—¶æ—¶é—´æŒ‡çš„ä¹Ÿæ˜¯ä¸¤æ¬¡æˆåŠŸå†™æ“ä½œé—´éš”æ—¶é—´ï¼Œè€Œä¸æ˜¯å‘é€æ•´ä¸ªå“åº”çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœåœ¨æ­¤è¶…æ—¶æ—¶é—´å†…å®¢æˆ·ç«¯æ²¡æœ‰æ¥æ”¶ä»»ä½•å“åº”ï¼Œåˆ™Nginxå…³é—­æ­¤è¿æ¥ã€‚</p>
<p>**keepalive_timeout timeout [header_timeout]**ï¼šè®¾ç½®HTTPé•¿è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°timeoutæ˜¯å‘Šè¯‰Nginxé•¿è¿æ¥è¶…æ—¶æ—¶é—´æ˜¯å¤šå°‘ï¼Œé»˜è®¤ä¸º75sã€‚ç¬¬äºŒä¸ªå‚æ•°header_timeoutæ˜¯ç”¨äºè®¾ç½®å“åº”å¤´â€œKeep-Alive: timeout=timeâ€ï¼Œå³å‘ŠçŸ¥å®¢æˆ·ç«¯é•¿è¿æ¥è¶…æ—¶æ—¶é—´ã€‚å¦‚æœtimeoutè®¾ç½®ä¸º0ï¼Œåˆ™è¡¨ç¤ºç¦ç”¨é•¿è¿æ¥ã€‚</p>
<p>2ã€DNSè§£æè¶…æ—¶</p>
<p><strong>resolver_timeout 30s</strong>ï¼šè®¾ç½®DNSè§£æè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º30s</p>
<p>3ã€ä»£ç†è¶…æ—¶</p>
<p>ä¸»è¦æœ‰ä¸‰ç»„é…ç½®ï¼šç½‘ç»œè¿æ¥/è¯»/å†™è¶…æ—¶è®¾ç½®ã€å¤±è´¥é‡è¯•æœºåˆ¶è®¾ç½®ã€upstreamå­˜æ´»è¶…æ—¶è®¾ç½®</p>
<p><strong>proxy_connect_timeout time</strong>ï¼šä¸åç«¯/ä¸Šæ¸¸æœåŠ¡å™¨å»ºç«‹è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60sï¼Œæ­¤æ—¶é—´ä¸è¶…è¿‡75sã€‚</p>
<p><strong>proxy_read_timeout time</strong>ï¼šè®¾ç½®ä»åç«¯/ä¸Šæ¸¸æœåŠ¡å™¨è¯»å–å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60sï¼Œæ­¤è¶…æ—¶æ—¶é—´æŒ‡çš„æ˜¯ä¸¤æ¬¡æˆåŠŸè¯»æ“ä½œé—´éš”æ—¶é—´ï¼Œè€Œä¸æ˜¯è¯»å–æ•´ä¸ªå“åº”ä½“çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨æ­¤è¶…æ—¶æ—¶é—´å†…ä¸Šæ¸¸æœåŠ¡å™¨æ²¡æœ‰å‘é€ä»»ä½•å“åº”ï¼Œåˆ™Nginxå…³é—­æ­¤è¿æ¥ã€‚</p>
<p><strong>proxy_send_timeout time</strong>ï¼šè®¾ç½®å¾€åç«¯/ä¸Šæ¸¸æœåŠ¡å™¨å‘é€è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60sï¼Œæ­¤è¶…æ—¶æ—¶é—´æŒ‡çš„æ˜¯ä¸¤æ¬¡æˆåŠŸå†™æ“ä½œé—´éš”æ—¶é—´ï¼Œè€Œä¸æ˜¯å‘é€æ•´ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨æ­¤è¶…æ—¶æ—¶é—´å†…ä¸Šæ¸¸æœåŠ¡å™¨æ²¡æœ‰æ¥æ”¶ä»»ä½•å“åº”ï¼Œåˆ™Nginxå…³é—­æ­¤è¿æ¥ã€‚</p>
<p><strong>proxy_next_upstream_tries number</strong>ï¼šè®¾ç½®é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤0è¡¨ç¤ºä¸é™åˆ¶ï¼Œæ³¨æ„æ­¤é‡è¯•æ¬¡æ•°æŒ‡çš„æ˜¯æ‰€æœ‰è¯·æ±‚æ¬¡æ•°ï¼ˆåŒ…æ‹¬ç¬¬ä¸€æ¬¡å’Œä¹‹åçš„é‡è¯•æ¬¡æ•°ä¹‹å’Œï¼‰ã€‚</p>
<p><strong>proxy_next_upstream_timeout time</strong>ï¼šè®¾ç½®é‡è¯•æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤0è¡¨ç¤ºä¸é™åˆ¶ã€‚</p>
<p>Nginxè¶…æ—¶é…ç½®ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/xiao__jia__jia/article/details/124075274">https://blog.csdn.net/xiao__jia__jia/article/details/124075274</a></p>
<h2 id="PoolingHttpClientConnectionManager"><a href="#PoolingHttpClientConnectionManager" class="headerlink" title="PoolingHttpClientConnectionManager"></a>PoolingHttpClientConnectionManager</h2><p>HttpCliené«˜å¹¶å‘è¯·æ±‚è¿æ¥æ±  - PoolingHttpClientConnectionManager</p>
<p>è¿æ¥æ± ï¼š<br>è¿æ¥æ± æŠ€æœ¯ä½œä¸ºåˆ›å»ºå’Œç®¡ç†è¿æ¥çš„ç¼“å†²æ± æŠ€æœ¯ï¼Œç›®å‰å·²å¹¿æ³›ç”¨äºè¯¸å¦‚æ•°æ®åº“è¿æ¥ç­‰é•¿è¿æ¥çš„ç»´æŠ¤å’Œç®¡ç†ä¸­ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘ç³»ç»Ÿçš„å“åº”æ—¶é—´ï¼ŒèŠ‚çœæœåŠ¡å™¨èµ„æºå¼€é”€ã€‚å…¶ä¼˜åŠ¿ä¸»è¦æœ‰ä¸¤ä¸ªï¼šå…¶ä¸€æ˜¯å‡å°‘åˆ›å»ºè¿æ¥çš„èµ„æºå¼€é”€ï¼Œå…¶äºŒæ˜¯èµ„æºçš„è®¿é—®æ§åˆ¶ã€‚è¿æ¥æ± ç®¡ç†çš„å¯¹è±¡æ˜¯é•¿è¿æ¥ã€‚</p>
<p>PoolingHttpClientConnectionManageræ˜¯é€šè¿‡ç§Ÿç”¨è¿æ¥å’Œæ”¶å›é“¾æ¥çš„æ–¹å¼æ¥å®ç°çš„ã€‚è§£å†³äº†httpè¯·æ±‚çš„å¤šçº¿ç¨‹é—®é¢˜ã€‚</p>
<p>ä¾èµ–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;httpclient&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>å®ç°httpè¿æ¥æ± ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34484062/article/details/109470135">https://blog.csdn.net/qq_34484062/article/details/109470135</a></p>
<h2 id="rpc"><a href="#rpc" class="headerlink" title="rpc"></a>rpc</h2><p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRemote Procedure Callï¼Œç¼©å†™ä¸º RPCï¼‰å…è®¸è¿è¡Œäºä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€å°è®¡ç®—æœºçš„å­ç¨‹åºï¼Œè€Œç¨‹åºå‘˜æ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ã€‚ å¦‚æœæ¶‰åŠçš„è½¯ä»¶é‡‡ç”¨é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œé‚£ä¹ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨äº¦å¯ç§°ä½œè¿œç¨‹è°ƒç”¨æˆ–è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼Œæ¯”å¦‚ Java RMIã€‚</p>
<p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è®¡ç®—çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆClient/Serverï¼‰çš„ä¾‹å­ï¼Œå®ƒç®€å•è€Œåˆå¹¿å—æ¬¢è¿ã€‚ è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ€»æ˜¯ç”±å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨å‘å‡ºä¸€ä¸ªæ‰§è¡Œè‹¥å¹²è¿‡ç¨‹è¯·æ±‚ï¼Œå¹¶ç”¨å®¢æˆ·ç«¯æä¾›çš„å‚æ•°ã€‚æ‰§è¡Œç»“æœå°†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ ç”±äºå­˜åœ¨å„å¼å„æ ·çš„å˜ä½“å’Œç»†èŠ‚å·®å¼‚ï¼Œå¯¹åº”åœ°æ´¾ç”Ÿäº†å„å¼è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œè€Œä¸”å®ƒä»¬å¹¶ä¸äº’ç›¸å…¼å®¹ã€‚</p>
<p>ä¸ºäº†å…è®¸ä¸åŒçš„å®¢æˆ·ç«¯å‡èƒ½è®¿é—®æœåŠ¡å™¨ï¼Œè®¸å¤šæ ‡å‡†åŒ–çš„ RPC ç³»ç»Ÿåº”è¿è€Œç”Ÿäº†ã€‚å…¶ä¸­å¤§éƒ¨åˆ†é‡‡ç”¨æ¥å£æè¿°è¯­è¨€ï¼ˆInterface Description Languageï¼ŒIDLï¼‰ï¼Œæ–¹ä¾¿è·¨å¹³å°çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€‚<br>æœ‰äº›å®ç°æ‰©å±•äº†è¿œç¨‹è°ƒç”¨çš„æ¨¡å‹ï¼Œå®ç°äº†åŒå‘çš„æœåŠ¡è°ƒç”¨ï¼Œä½†æ˜¯ä¸ç®¡æ€æ ·ï¼Œè°ƒç”¨è¿‡ç¨‹è¿˜æ˜¯ç”±ä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·ï¼ŒæœåŠ¡å™¨ç«¯æä¾›å“åº”ï¼ŒåŸºæœ¬æ¨¡å‹æ²¡æœ‰å˜åŒ–ã€‚</p>
<p>æœåŠ¡çš„è°ƒç”¨è¿‡ç¨‹ä¸ºï¼š<br>1ã€clientè°ƒç”¨client stubï¼Œè¿™æ˜¯ä¸€æ¬¡æœ¬åœ°è¿‡ç¨‹è°ƒç”¨<br>2ã€client stubå°†å‚æ•°æ‰“åŒ…æˆä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åå‘é€è¿™ä¸ªæ¶ˆæ¯ã€‚æ‰“åŒ…è¿‡ç¨‹ä¹Ÿå«åš marshalling<br>3ã€clientæ‰€åœ¨çš„ç³»ç»Ÿå°†æ¶ˆæ¯å‘é€ç»™server<br>4ã€serverçš„çš„ç³»ç»Ÿå°†æ”¶åˆ°çš„åŒ…ä¼ ç»™server stub<br>5ã€server stubè§£åŒ…å¾—åˆ°å‚æ•°ã€‚ è§£åŒ…ä¹Ÿè¢«ç§°ä½œ unmarshalling<br>6ã€æœ€åserver stubè°ƒç”¨æœåŠ¡è¿‡ç¨‹. è¿”å›ç»“æœæŒ‰ç…§ç›¸åçš„æ­¥éª¤ä¼ ç»™client</p>
<hr>
<p>RPC (Remote Procedure Call)å³è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¸¸è§çš„ä¸€ç§é€šä¿¡æ–¹æ³•ï¼Œå·²ç»æœ‰ 40 å¤šå¹´å†å²ã€‚å½“ä¸¤ä¸ªç‰©ç†åˆ†ç¦»çš„å­ç³»ç»Ÿéœ€è¦å»ºç«‹é€»è¾‘ä¸Šçš„å…³è”æ—¶ï¼ŒRPC æ˜¯ç‰µçº¿æ­æ¡¥çš„å¸¸è§æŠ€æœ¯æ‰‹æ®µä¹‹ä¸€ã€‚é™¤ RPC ä¹‹å¤–ï¼Œå¸¸è§çš„å¤šç³»ç»Ÿæ•°æ®äº¤äº’æ–¹æ¡ˆè¿˜æœ‰åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ã€HTTP è¯·æ±‚è°ƒç”¨ã€æ•°æ®åº“å’Œåˆ†å¸ƒå¼ç¼“å­˜ã€‚</p>
<p>å…¶ä¸­ RPC å’Œ HTTP è°ƒç”¨æ˜¯æ²¡æœ‰ç»è¿‡ä¸­é—´ä»¶çš„ï¼Œå®ƒä»¬æ˜¯ç«¯åˆ°ç«¯ç³»ç»Ÿçš„ç›´æ¥æ•°æ®äº¤äº’ã€‚<strong>HTTP è°ƒç”¨å…¶å®ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯ä¸€ç§ç‰¹æ®Šçš„ RPCï¼Œåªä¸è¿‡ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ RPC æ˜¯æŒ‡é•¿è¿æ¥æ•°æ®äº¤äº’ï¼Œè€Œ HTTP ä¸€èˆ¬æ˜¯æŒ‡å³ç”¨å³èµ°çš„çŸ­é“¾æ¥ã€‚</strong></p>
<p>RPC åœ¨æˆ‘ä»¬ç†ŸçŸ¥çš„å„ç§ä¸­é—´ä»¶ä¸­éƒ½æœ‰å®ƒçš„èº«å½±ã€‚Nginx/Redis/MySQL/Dubbo/Hadoop/Spark/Tensorflow ç­‰é‡é‡çº§å¼€æºäº§å“éƒ½æ˜¯åœ¨ RPC æŠ€æœ¯çš„åŸºç¡€ä¸Šæ„å»ºå‡ºæ¥çš„ï¼Œæˆ‘ä»¬<strong>è¿™é‡Œè¯´çš„ RPC æŒ‡çš„æ˜¯å¹¿ä¹‰çš„ RPCï¼Œä¹Ÿå°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„é€šä¿¡æŠ€æœ¯</strong>ã€‚RPC åœ¨æŠ€æœ¯ä¸­çš„åœ°ä½å¥½æ¯”æˆ‘ä»¬èº«è¾¹çš„ç©ºæ°”ï¼Œå®ƒæ— å¤„ä¸åœ¨ï¼Œä½†æ˜¯åˆæœ‰å¾ˆå¤šäººæ ¹æœ¬ä¸çŸ¥é“å®ƒçš„å­˜åœ¨ã€‚</p>
<p>ä¾‹å¦‚æ•°æ®åº“ï¼š<br>å­ç³»ç»Ÿå’Œæ•°æ®åº“ä¹‹é—´çš„äº¤äº’ä¹Ÿæ˜¯é€šè¿‡ RPC è¿›è¡Œçš„ï¼Œåªä¸è¿‡è¿™é‡Œæ˜¯ä¸‰ä¸ªå­ç³»ç»Ÿä¹‹é—´å¤æ‚çš„ç»„åˆæ¶ˆæ¯äº¤äº’ç½¢äº†ã€‚å¦‚æœå†æ·±å…¥è¿›å»ï¼Œä½ ä¼šå‘ç°ï¼Œè¿™é‡Œçš„æ•°æ®åº“ä¸æ˜¯é‚£ç§å•æœºæ•°æ®åº“ï¼Œè€Œæ˜¯å…·å¤‡ä¸»ä»å¤åˆ¶åŠŸèƒ½çš„æ•°æ®åº“ï¼Œæ¯”å¦‚ MySQLã€‚åœ¨äº’è”ç½‘ä¼ä¸šé‡Œä¸€èˆ¬éƒ½ä¼šä½¿ç”¨è¿™ç§ä¸»ä»è¯»å†™åˆ†ç¦»çš„æ•°æ®åº“ã€‚ä¸€ä¸ªä¸šåŠ¡å­ç³»ç»Ÿå°†æ•°æ®å†™å¾€ä¸»åº“ï¼Œä¸»åº“å†å°†æ•°æ®åŒæ­¥åˆ°ä»åº“ï¼Œç„¶åå¦ä¸€ä¸ªä¸šåŠ¡å­ç³»ç»Ÿåˆä»ä»åº“é‡Œå°†æ•°æ®å–å‡ºæ¥ã€‚è¿™æ—¶åˆå¯ä»¥è¿›ä¸€æ­¥å°†å®ƒä»¬çœ‹æˆæ˜¯å››ä¸ªå­ç³»ç»Ÿä¹‹é—´è¿›è¡Œçš„æ›´åŠ å¤æ‚çš„ RPC æ•°æ®äº¤äº’ã€‚</p>
<hr>
<p>ä¸€äº›åˆ†å¸ƒå¼åœºæ™¯ä¸­RPCçš„ä½¿ç”¨ï¼šï¼ˆå¹¿ä¹‰ä¸Šçš„RPCï¼‰</p>
<p>âœ…nginx<br>Ngnix æ˜¯äº’è”ç½‘ä¼ä¸šä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ä»£ç†æœåŠ¡å™¨ã€‚å®ƒå¯ä»¥ä¸ºåç«¯åˆ†å¸ƒå¼æœåŠ¡æä¾›è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥å°†åç«¯å¤šä¸ªæœåŠ¡åœ°å€èšåˆä¸ºå•ä¸ªåœ°å€æ¥å¯¹å¤–æä¾›æœåŠ¡ã€‚Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´çš„äº¤äº’åœ¨æœ¬è´¨ä¸Šä¹Ÿå¯ä»¥ç†è§£ä¸º RPC æ•°æ®äº¤äº’ã€‚ä¹Ÿè®¸ä½ ä¼šäº‰è¾©è¯´ Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œèµ°çš„æ˜¯çŸ­è¿æ¥ï¼Œä¸¥æ ¼ä¸Šä¸èƒ½ç®—æ˜¯ RPC è°ƒç”¨ã€‚ä¸è¿‡ Nginx å’Œåç«¯æœåŠ¡ä¹‹é—´è¿˜å¯ä»¥èµ°å…¶å®ƒçš„åè®®ï¼Œæ¯”å¦‚ uwsgi åè®®ã€fastcgi åè®®ç­‰ï¼Œè¿™ä¸¤ä¸ªåè®®éƒ½æ˜¯é‡‡ç”¨äº†æ¯” HTTP åè®®æ›´åŠ èŠ‚çœæµé‡çš„äºŒè¿›åˆ¶åè®®ã€‚</p>
<p>âœ…Hadoop<br>åœ¨å¤§æ•°æ®æŠ€æœ¯é¢†åŸŸï¼ŒRPC ä¹Ÿå æ®äº†éå¸¸é‡è¦çš„åœ°ä½ã€‚å¤§æ•°æ®é¢†åŸŸå¹¿æ³›åº”ç”¨äº†éå¸¸å¤šçš„åˆ†å¸ƒå¼æŠ€æœ¯ï¼Œåˆ†å¸ƒå¼æ„å‘³ç€èŠ‚ç‚¹çš„ç‰©ç†éš”ç¦»ï¼Œéš”ç¦»æ„å‘³ç€éœ€è¦é€šä¿¡ï¼Œé€šä¿¡æ„å‘³ç€ RPC çš„å­˜åœ¨ã€‚å¤§æ•°æ®éœ€è¦é€šä¿¡çš„é‡æ¯”ä¸šåŠ¡ç³»ç»Ÿæ›´åŠ åºå¤§ï¼Œæ‰€ä»¥åœ¨æ•°æ®é€šä¿¡ä¼˜åŒ–ä¸Šåšçš„æ›´æ·±ã€‚æ¯”å¦‚æœ€å¸¸è§çš„ Hadoop æ–‡ä»¶ç³»ç»Ÿ hdfsï¼Œä¸€èˆ¬åŒ…æ‹¬ä¸€ä¸ª NameNode å’Œå¤šä¸ª DataNodeï¼ŒNameNode å’Œ DataNode ä¹‹é—´å°±æ˜¯é€šè¿‡ä¸€ç§ç§°ä¸º Hadoop RPC çš„äºŒè¿›åˆ¶åè®®è¿›è¡Œé€šè®¯ã€‚</p>
<p>âœ…TensorFlow<br>åœ¨äººå·¥æ™ºèƒ½é¢†åŸŸï¼ŒRPC ä¹Ÿå¾ˆé‡è¦ï¼Œè‘—åçš„ TensorFlow æ¡†æ¶å¦‚æœéœ€è¦å¤„ç†ä¸Šäº¿çš„æ•°æ®ï¼Œå°±éœ€è¦ä¾é åˆ†å¸ƒå¼è®¡ç®—åŠ›ï¼Œéœ€è¦é›†ç¾¤åŒ–ï¼Œå½“å¤šä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹éœ€è¦é›†ä½“æ™ºæ…§æ—¶ï¼Œå°±å¿…é¡»å¼•å…¥ RPC æŠ€æœ¯è¿›è¡Œé€šè®¯ã€‚Tensorflow Cluster çš„ RPC é€šè®¯æ¡†æ¶ä½¿ç”¨äº† Google å†…éƒ¨è‡ªç ”çš„ gRPC æ¡†æ¶ã€‚</p>
<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://www.kancloud.cn/machh03/server/2096716">https://www.kancloud.cn/machh03/server/2096716</a><br>é‡Œé¢è¿˜æœ‰å®ç°rpc</p>
<h2 id="ç†è§£httpå’Œrpc"><a href="#ç†è§£httpå’Œrpc" class="headerlink" title="ç†è§£httpå’Œrpc"></a>ç†è§£httpå’Œrpc</h2><p>HTTP1.0 åè®®æ—¶ï¼ŒHTTP è°ƒç”¨è¿˜åªèƒ½æ˜¯çŸ­é“¾æ¥è°ƒç”¨ï¼Œä¸€ä¸ªè¯·æ±‚æ¥å›ä¹‹åè¿æ¥å°±ä¼šå…³é—­ã€‚HTTP1.1 åœ¨ HTTP1.0 åè®®çš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œå¼•å…¥äº† KeepAlive ç‰¹æ€§å¯ä»¥ä¿æŒ HTTP è¿æ¥é•¿æ—¶é—´ä¸æ–­å¼€ï¼Œä»¥ä¾¿åœ¨åŒä¸€ä¸ªè¿æ¥ä¹‹ä¸Šè¿›è¡Œå¤šæ¬¡è¿ç»­çš„è¯·æ±‚ï¼Œè¿›ä¸€æ­¥æ‹‰è¿‘äº† HTTP å’Œ RPC ä¹‹é—´çš„è·ç¦»ã€‚</p>
<p>å½“ HTTP åè®®è¿›åŒ–åˆ° 2.0 ä¹‹åï¼ŒGoogle å¼€æºäº†ä¸€ä¸ªå»ºç«‹åœ¨ HTTP2.0 åè®®ä¹‹ä¸Šçš„é€šä¿¡æ¡†æ¶ç›´æ¥å–åä¸º gRPCï¼Œä¹Ÿå°±æ˜¯ Google RPCï¼Œè¿™æ—¶ HTTP å’Œ RPC ä¹‹é—´å·²ç»æ²¡æœ‰éå¸¸æ˜æ˜¾çš„ç•Œé™äº†ã€‚</p>
<p>HTTP ä¸ RPC çš„å…³ç³»å°±å¥½æ¯”æ™®é€šè¯ä¸æ–¹è¨€çš„å…³ç³»ã€‚è¦è¿›è¡Œè·¨ä¼ä¸šæœåŠ¡è°ƒç”¨æ—¶ï¼Œå¾€å¾€éƒ½æ˜¯é€šè¿‡ HTTP APIï¼Œä¹Ÿå°±æ˜¯æ™®é€šè¯ï¼Œè™½ç„¶æ•ˆç‡ä¸é«˜ï¼Œä½†æ˜¯é€šç”¨ï¼Œæ²¡æœ‰å¤ªå¤šæ²Ÿé€šçš„å­¦ä¹ æˆæœ¬ã€‚ä½†æ˜¯åœ¨ä¼ä¸šå†…éƒ¨è¿˜æ˜¯ RPC æ›´åŠ é«˜æ•ˆï¼ŒåŒä¸€ä¸ªä¼ä¸šå…¬ç”¨ä¸€å¥—æ–¹è¨€è¿›è¡Œé«˜æ•ˆç‡çš„äº¤æµï¼Œè¦æ¯”é€šç”¨çš„ HTTP åè®®æ¥äº¤æµæ›´åŠ èŠ‚çœèµ„æºã€‚æ•´ä¸ªä¸­å›½æœ‰éå¸¸å¤šçš„æ–¹è¨€ï¼Œæ­£å¦‚æœ‰å¾ˆå¤šçš„ä¼ä¸šå†…éƒ¨æœåŠ¡å„æœ‰è‡ªå·±çš„ä¸€å¥—äº¤äº’åè®®ä¸€æ ·ã€‚å¥½æ¯”å¼€æº RPC åè®®ä¸­ Protobuf å’Œ Thrift ä¸€æ ·ï¼Œå®ƒä»¬ä¸¤åº”è¯¥æ˜¯ RPC åè®®ä¸­ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸¤ä¸ªã€‚</p>
<p>rpcåŸºäºä»€ä¹ˆå®ç°ç½‘ç»œä¼ è¾“ï¼Ÿ<br>1.rpcå¯ä»¥åŸºäºtcpç›´æ¥å¼€å‘è‡ªå·±çš„åè®®ï¼Œè¿™ä¸ªæ˜¯å¯ä»¥ä¿æŒé•¿è¿æ¥çš„ï¼Œtcpçš„ä¼ è¾“æ•ˆç‡é«˜ï¼Œå¹¶ä¸”å¯ä»¥ä¸€ç›´ç»´æŒé“¾æ¥</p>
<p>2.è‡ªå®šä¹‰åè®®å¯ä»¥ä¼˜åŒ–æ•°æ®çš„ä¼ è¾“ï¼Œä¾‹å¦‚æ›´å¤§çš„å‹ç¼©æ¯”ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éå¸¸æœ‰ç”¨ã€‚</p>
<p>3.httpåè®®1.xä¸€èˆ¬æƒ…å†µä¸‹ä¸€ä¸ªæ¥å›å°±å…³é—­è¿æ¥ï¼Œè™½ç„¶æä¾›äº†keep-aliveå¯ä»¥ä¿æŒé•¿è¿æ¥ï¼Œä½†æ˜¯ä¾ç„¶ä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥å°±å‡ºç°äº†http2.0ï¼Œ http2.0åŸºæœ¬ä¸Šå¯ä»¥å½“åštcpåè®®ä½¿ç”¨äº†ã€‚æ‰€ä»¥grpcå°±ä¼šä½¿ç”¨http2.0å¼€å‘ã€‚</p>
<h2 id="restå’Œrestful"><a href="#restå’Œrestful" class="headerlink" title="restå’Œrestful"></a>restå’Œrestful</h2><p>RESTï¼Œè‹±æ–‡å…¨ç§°Representational State Transferï¼ˆè¡¨è¿°æ€§çŠ¶æ€è½¬ç§»ï¼‰ï¼Œæ˜¯ä¸€ç»„æ¶æ„çº¦æŸæ¡ä»¶å’ŒåŸåˆ™ï¼ˆæ³¨æ„ï¼ŒRESTæ˜¯è®¾è®¡é£æ ¼è€Œä¸æ˜¯æ ‡å‡†ï¼‰ã€‚æ»¡è¶³è¿™äº›çº¦æŸæ¡ä»¶å’ŒåŸåˆ™çš„åº”ç”¨ç¨‹åºæˆ–è®¾è®¡å°±æ˜¯RESTfulã€‚å¯ä»¥é™ä½å¼€å‘çš„å¤æ‚æ€§ï¼Œæé«˜ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§ã€‚ä½“ç°åœ¨Webå¼€å‘ä¸­å°±æ˜¯é€šè¿‡HTTPæ–¹æ³•ä¸­çš„POSTã€DELETEã€PUTã€GETæ¥å¯¹èµ„æºè¿›è¡Œæ“ä½œã€‚</p>
<p>ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ï¼Œè®¾è®¡é£æ ¼è€Œä¸æ˜¯æ ‡å‡†ï¼Œåªæ˜¯æä¾›äº†ä¸€ç»„è®¾è®¡åŸåˆ™å’Œçº¦æŸæ¡ä»¶ã€‚å®ƒä¸»è¦ç”¨äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’ç±»çš„è½¯ä»¶ã€‚åŸºäºè¿™ä¸ªé£æ ¼è®¾è®¡çš„è½¯ä»¶å¯ä»¥æ›´ç®€æ´ï¼Œæ›´æœ‰å±‚æ¬¡ï¼Œæ›´æ˜“äºå®ç°ç¼“å­˜ç­‰æœºåˆ¶ã€‚</p>
<p>åœ¨ REST æ ·å¼çš„ Web æœåŠ¡ä¸­ï¼Œæ¯ä¸ªèµ„æºéƒ½æœ‰ä¸€ä¸ªåœ°å€ã€‚èµ„æºæœ¬èº«éƒ½æ˜¯æ–¹æ³•è°ƒç”¨çš„ç›®æ ‡ï¼Œæ–¹æ³•åˆ—è¡¨å¯¹æ‰€æœ‰èµ„æºéƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™äº›æ–¹æ³•éƒ½æ˜¯æ ‡å‡†æ–¹æ³•ï¼ŒåŒ…æ‹¬ HTTP GETã€POSTã€PUTã€DELETEï¼Œè¿˜å¯èƒ½åŒ…æ‹¬ HEADER å’Œ OPTIONSã€‚</p>
<p>Representationï¼ˆè¡¨ç°å±‚ï¼‰<br>èµ„æºçš„ä¿¡æ¯è½½ä½“å½¢å¼ã€‚å®ƒå¯ä»¥æ˜¯æ–‡æœ¬ã€XMLã€JSONæˆ–è€…æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®ƒçš„è¡¨ç°å½¢å¼åº”è¯¥åœ¨HTTPè¯·æ±‚çš„å¤´ä¿¡æ¯ä¸­ç”¨Acceptå’ŒContent-Typeå­—æ®µæŒ‡å®šæè¿°ã€‚</p>
<p>State Transferï¼ˆçŠ¶æ€è½¬ç§»ï¼‰<br>äº’è”ç½‘é€šä¿¡åè®®HTTPåè®®ï¼Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®ã€‚è¿™æ„å‘³ç€ï¼Œæ‰€æœ‰çš„çŠ¶æ€éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ã€‚å› æ­¤ï¼Œå¦‚æœå®¢æˆ·ç«¯æƒ³è¦æ“ä½œæœåŠ¡å™¨ï¼Œå¿…é¡»é€šè¿‡æŸç§æ‰‹æ®µï¼Œè®©æœåŠ¡å™¨ç«¯å‘ç”Ÿâ€çŠ¶æ€è½¬ç§»â€ã€‚</p>
<p>åœ¨ HTTP ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬é€šè¿‡å››ç§ HTTP åŠ¨è¯æ¥å¯¹åº”èµ„æºçš„å˜åŒ–ï¼š<br>POSTï¼ˆæ–°å»ºèµ„æºï¼Œä¹Ÿå¯ç”¨äºæ›´æ–°èµ„æºï¼‰<br>DELETEï¼ˆåˆ é™¤èµ„æºï¼‰<br>PUTï¼ˆæ›´æ–°èµ„æºï¼‰<br>GETï¼ˆè·å–èµ„æºï¼‰</p>
<p>RESTæ¶æ„åŸåˆ™ï¼š<br>å¯¹ç½‘ç»œä¸Šæ‰€æœ‰èµ„æºéƒ½æœ‰ä¸€ä¸ªèµ„æºæ ‡è¯†ç¬¦<br>å¯¹èµ„æºçš„æ“ä½œä¸ä¼šæ”¹å˜æ ‡è¯†ç¬¦<br>åŒä¸€èµ„æºæœ‰å¤šç§è¡¨ç°å½¢å¼ï¼Œå¦‚XMLã€JSONâ€¦<br>æ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— çŠ¶æ€çš„ï¼ˆStatelessï¼‰</p>
<p>RESTfulï¼Œæ˜¯ä¸€ç§ç½‘ç»œåº”ç”¨ç¨‹åºçš„è®¾è®¡é£æ ¼å’Œå¼€å‘æ–¹å¼ã€‚RESTfulå¯ä»¥é€šè¿‡ä¸€å¥—ç»Ÿä¸€çš„æ¥å£ä¸ºWebï¼ŒiOSå’ŒAndroidæä¾›æœåŠ¡ã€‚æ¯”å¦‚å¾®åšå¼€æ”¾å¹³å°ï¼Œå¾®ä¿¡å¼€æ”¾å¹³å°ç­‰ï¼Œå®ƒä»¬ä¸éœ€è¦æœ‰æ˜¾å¼çš„å‰ç«¯ï¼Œåªéœ€è¦ä¸€å¥—æä¾›æœåŠ¡çš„æ¥å£ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">åœ¨ä½¿ç”¨RESTfulé£æ ¼ä¹‹å‰ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯è¿™æ ·æ“ä½œç”¨æˆ·æ•°æ®:</span><br><span class="line">//åˆ›å»ºç”¨æˆ·ä¿¡æ¯</span><br><span class="line">http://localhost:8080/user/createUser</span><br><span class="line">//åˆ é™¤idä¸º1çš„ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">http://localhost:8080/user/deleteUser/1</span><br><span class="line">//ä¿®æ”¹idä¸º2çš„ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">http://localhost:8080/user/updateUser/2</span><br><span class="line">//è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">http://localhost:8080/user/getUsers</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨RESTfulé£æ ¼ä¹‹å:</span><br><span class="line">//åˆ›å»ºç”¨æˆ·ä¿¡æ¯</span><br><span class="line">POST http://localhost:8080/user</span><br><span class="line">//åˆ é™¤idä¸º1çš„ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">DELETE http://localhost:8080/user/1</span><br><span class="line">//ä¿®æ”¹idä¸º2çš„ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">PUT http://localhost:8080/user/2</span><br><span class="line">//è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">GET http://localhost:8080/userè·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">é€šè¿‡çº¦å®šä¸åŒçš„HTTPæ–¹æ³•æ¥å®ç°ä¸åŒçš„ä¸šåŠ¡ï¼Œæœ‰ä¸€ä¸ªæ›´åŠ ç›´è§‚çš„äº†è§£ã€‚</span><br><span class="line">1ã€çœ‹URLå°±çŸ¥é“è¦æ“ä½œä»€ä¹ˆ</span><br><span class="line">2ã€çœ‹HTTPæ–¹æ³•å°±çŸ¥é“è¦å¦‚ä½•æ“ä½œ</span><br><span class="line">3ã€çœ‹HTTPçŠ¶æ€ç å°±çŸ¥é“è¿”å›ç»“æœå¦‚ä½•</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒï¼š<br>restä¸restfulï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44316527/article/details/106276655">https://blog.csdn.net/weixin_44316527/article/details/106276655</a></p>
<hr>
<p>rpcä¸restfulï¼š</p>
<p>RPCï¼ˆRemote Procedure Call Protocolï¼‰å°±æ˜¯è¿œç¨‹è°ƒç”¨ã€‚æœ€ç®€å•çš„æƒ³æ³•ï¼Œåº”è¯¥å°±æ˜¯æŠŠHTTPåè®®å½“åšRPCæ¥ç”¨ã€‚æ¯”å¦‚æˆ‘ä»¬æŠŠç½‘å€ä½œä¸ºä¸€ä¸ªå€Ÿå£ï¼Œä¼ å…¥çš„å‚æ•°ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œresponseçš„æ•°æ®ä½œä¸ºè¿”å›ä¿¡æ¯ã€‚è¿™å…¶å®å°±æ˜¯ä¸€ä¸ªè°ƒç”¨ã€‚</p>
<p>RESTfulå’ŒRPCæœ€å¤§çš„åŒºåˆ«åº”è¯¥å°±æ˜¯é¢å‘å¯¹è±¡äº†ã€‚<br>ä»è®¾è®¡ä¸Šæ¥çœ‹ï¼ŒRPCï¼Œæ‰€è°“çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ ï¼Œæ˜¯é¢å‘æ–¹æ³•çš„ ï¼›<br>RESTï¼šæ‰€è°“çš„ Representational state transfer ï¼Œæ˜¯é¢å‘èµ„æºçš„ï¼›<br>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§å«åš SOAï¼Œæ‰€è°“çš„é¢å‘æœåŠ¡çš„æ¶æ„ï¼Œå®ƒæ˜¯é¢å‘æ¶ˆæ¯çš„ã€‚<br>å¾ˆå¤šäººåªçŸ¥é“GETå’ŒPOSTï¼Œå› ä¸ºç°åœ¨æœ€å¸¸ç”¨çš„å°±æ˜¯GETå’ŒPOSTäº†ã€‚è™½è¯´è¿™åº”è¯¥æ˜¯è¿èƒŒäº†HTTPè®¾è®¡çš„åˆè¡·ã€‚</p>
<p>åºåˆ—åŒ–åè®®çš„åŒºåˆ«ï¼š<br>æ¥å£è°ƒç”¨é€šå¸¸åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåºåˆ—åŒ–å’Œé€šä¿¡åè®®ã€‚<br>é€šä¿¡åè®®ï¼Œä¸Šé¢å·²ç»æåŠäº†ï¼ŒREST æ˜¯ åŸºäº HTTP åè®®ï¼Œè€Œ RPC å¯ä»¥åŸºäº TCP/UDPï¼Œä¹Ÿå¯ä»¥åŸºäº HTTP åè®®è¿›è¡Œä¼ è¾“çš„ã€‚<br>å¸¸è§çš„åºåˆ—åŒ–åè®®ï¼Œæœ‰ï¼šjsonã€xmlã€hessionã€protobufã€thriftã€textã€bytesç­‰ï¼ŒREST é€šå¸¸ä½¿ç”¨çš„æ˜¯ JSONæˆ–è€…XMLï¼Œè€Œ RPC ä½¿ç”¨çš„æ˜¯ JSON-RPCï¼Œæˆ–è€… XML-RPCã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ<br>REST æ¥å£æ›´åŠ è§„èŒƒï¼Œé€šç”¨é€‚é…æ€§è¦æ±‚é«˜ï¼Œå»ºè®®å¯¹å¤–çš„æ¥å£éƒ½ç»Ÿä¸€æˆ RESTã€‚è€Œç»„ä»¶å†…éƒ¨çš„å„ä¸ªæ¨¡å—ï¼Œå¯ä»¥é€‰æ‹© RPCï¼Œä¸€ä¸ªæ˜¯ä¸ç”¨è€—è´¹å¤ªå¤šç²¾åŠ›å»å¼€å‘å’Œç»´æŠ¤å¤šå¥—çš„HTTPæ¥å£ï¼Œä¸€ä¸ªRPCçš„è°ƒç”¨æ€§èƒ½æ›´é«˜ã€‚ä»æ€§èƒ½è§’åº¦çœ‹ï¼Œç”±äºHTTPæœ¬èº«æä¾›äº†ä¸°å¯Œçš„çŠ¶æ€åŠŸèƒ½ä¸æ‰©å±•åŠŸèƒ½ï¼Œä½†ä¹Ÿæ­£ç”±äºHTTPæä¾›çš„åŠŸèƒ½è¿‡å¤šï¼Œå¯¼è‡´åœ¨ç½‘ç»œä¼ è¾“æ—¶ï¼Œéœ€è¦æºå¸¦çš„ä¿¡æ¯æ›´å¤šï¼Œä»æ€§èƒ½è§’åº¦ä¸Šè®²ï¼Œè¾ƒä¸ºä½æ•ˆã€‚è€ŒRPCæœåŠ¡ç½‘ç»œä¼ è¾“ä¸Šä»…ä¼ è¾“ä¸ä¸šåŠ¡å†…å®¹ç›¸å…³çš„æ•°æ®ï¼Œä¼ è¾“æ•°æ®æ›´å°ï¼Œæ€§èƒ½æ›´é«˜ã€‚</p>
<p>è½¬è‡ªï¼š<br><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/53677">https://developer.aliyun.com/article/53677</a></p>
<hr>
<p>restfulå’Œhttpï¼š</p>
<p>REST æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼ã€‚è¿™ç§é£æ ¼çš„å…¸å‹åº”ç”¨ï¼Œå°±æ˜¯HTTPã€‚å…¶å› ä¸ºç®€å•ã€æ‰©å±•æ€§å¼ºçš„ç‰¹ç‚¹è€Œå¹¿å—å¼€å‘è€…çš„é’çã€‚</p>
<p>æŸç§æ„ä¹‰ä¸‹ï¼Œæˆ‘ä»¬è¯´ REST å¯ä»¥å…¶å®å°±æ˜¯æŒ‡ä»£ HTTP åè®®ã€‚</p>
<hr>
<p>æ€»ç»“ï¼šrpcã€httpã€rest</p>
<p>rpcæ˜¯ä¸€ç§åè®®è¿˜æ˜¯ï¼Œè¿˜æ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„æ€æƒ³ï¼Ÿæ›´æ˜¯åè€…<br>rpcåŒ…å«ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½ã€å®¹å™¨ã€ç½‘ç»œä¼ è¾“ã€åºåˆ—åŒ–ç­‰ç»„ä»¶ã€‚<br>rpcæŒ‡æ˜äº†ç¨‹åºå¦‚ä½•è¿›è¡Œç½‘ç»œä¼ è¾“å’Œåºåˆ—åŒ–ã€‚</p>
<p>å…³äºrpcå’Œhttpçš„æ¯”è¾ƒï¼š<br>rpcçš„ç½‘ç»œä¼ è¾“æ˜¯å¦‚ä½•å®ç°çš„ï¼Œrpcæ˜¯è¿æ¥ï¼Œhttpæ˜¯çŸ­è¿æ¥ã€‚<br>httpæ˜¯ä¸€ç§rpcï¼ˆå¹¿ä¹‰ä¸Šï¼‰ï¼Œè¿˜æ˜¯rpcå¯ä»¥åŸºäºhttpå®ç°ï¼Ÿ<br>RPCå¯ä»¥åŸºäºTCPåè®®ä¹Ÿå¯ä»¥åŸºäºHTTPåè®®ã€‚<br>HTTPéœ€è¦æºå¸¦çš„ä¿¡æ¯æ›´å¤šï¼Œä½æ•ˆï¼ŒRPCä»…ä¼ è¾“ä¸ä¸šåŠ¡ç›¸å…³çš„æ•°æ®ï¼Œä¼ è¾“æ•°æ®æ›´å°ï¼Œæ€§èƒ½æ›´é«˜</p>
<p>å…³äºrpcå’Œrestfulçš„æ¯”è¾ƒï¼š<br>rpcé¢å‘æ–¹æ³•ï¼Œrestfulé¢å‘èµ„æºã€‚<br>æ—¥å¸¸å†™çš„æ¥å£ï¼Œæ›´å¤šåŸºäºrpcé¢å‘æ–¹æ³•çš„ï¼Œè™½ç„¶æœ‰çš„æ˜¯rpcæ¥å£ï¼Œæœ‰çš„æ˜¯httpæ¥å£ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/10/myblog/JAVA/java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/10/myblog/JAVA/java%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">javaè¯Šæ–­</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-10 23:39:58" itemprop="dateCreated datePublished" datetime="2022-09-10T23:39:58+08:00">2022-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-18 17:10:54" itemprop="dateModified" datetime="2023-01-18T17:10:54+08:00">2023-01-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">javaå¼€å‘</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="javaè¯Šæ–­å·¥å…·arthas"><a href="#javaè¯Šæ–­å·¥å…·arthas" class="headerlink" title="javaè¯Šæ–­å·¥å…·arthas"></a>javaè¯Šæ–­å·¥å…·arthas</h2><h3 id="âœ…ç®€ä»‹"><a href="#âœ…ç®€ä»‹" class="headerlink" title="âœ…ç®€ä»‹"></a>âœ…ç®€ä»‹</h3><p>Arthas æ˜¯Alibabaå¼€æºçš„Javaè¯Šæ–­å·¥å…·ã€‚å®‰è£…åœ¨ç³»ç»Ÿæ‰€åœ¨æœåŠ¡å™¨ã€‚å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æˆ–è€…è¿ç»´äººå‘˜æŸ¥æ‰¾é—®é¢˜ï¼Œåˆ†ææ€§èƒ½ï¼Œbugè¿½è¸ªã€‚</p>
<p>è§£å†³é—®é¢˜ï¼š<br>1ã€ä»¥å…¨å±€è§†è§’æ¥æŸ¥çœ‹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µã€å¥åº·çŠ¶å†µã€‚<br>2ã€åç¼–è¯‘æºç ï¼ŒæŸ¥çœ‹jvmåŠ è½½çš„æ˜¯å¦ä¸ºé¢„æœŸçš„æ–‡ä»¶å†…å®¹ã€‚<br>3ã€æŸ¥çœ‹æŸä¸ªæ–¹æ³•çš„è¿”å›å€¼ï¼Œå‚æ•°ç­‰ç­‰ã€‚<br>4ã€æ–¹æ³•å†…è°ƒç”¨è·¯å¾„åŠå„æ–¹æ³•è°ƒç”¨è€—æ—¶ã€‚<br>5ã€æŸ¥çœ‹jvmè¿è¡ŒçŠ¶å†µã€‚<br>6ã€å¤–éƒ¨.classæ–‡ä»¶é‡æ–°åŠ è½½åˆ°jvmé‡Œã€‚<br>ç­‰ç­‰â€¦..</p>
<p>åœºæ™¯ï¼š<br>1ï¼‰è°ƒç”¨æ¥å£æ—¶ï¼Œæ¥å£è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼Œå¦‚æœè¯¥å¼‚å¸¸ä¿¡æ¯æ²¡æœ‰æ¸…æ™°çš„å®šä½åˆ°ä»£ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šå¸¸åªèƒ½ä¾é å¤§è„‘å›å¿†ä»£ç ï¼Œæ¥ä¼°è®¡é”™è¯¯å‘ç”Ÿåœ°äº†ï¼Œå¦‚æœæ— æ³•ä¼°è®¡ï¼Œä¸€èˆ¬æƒ…å†µä¸‹å°±ä¼šè¿›å…¥æµ‹è¯•ç¯å¢ƒï¼Œæ¨¡æ‹Ÿå¤ç°ï¼Œå¦‚æœæ— æ³•å¤ç°ã€‚<br>2ï¼‰è¿™ä¸ªæŸ¥è¯¢ï¼Œè€—æ—¶20sï¼Œæˆ‘ä»¬æƒ³è¦åˆ†æä¸€ä¸‹åˆ°åº•æ˜¯å“ªäº›ä»£ç å¯¼è‡´çš„ã€‚ä½†æ˜¯è¯¥æ–¹æ³•å†…éƒ¨åˆç©¿æ’è°ƒç”¨äº†å…¶å®ƒä¸šåŠ¡åŠŸèƒ½æ–¹æ³•ï¼Œéš¾é“æ‰‹å†™System.currentTimeMillis()è‡ªå·±åšå‡è¿ç®—ï¼Œè¿˜æ˜¯guavaçš„StopWatchäº¦æˆ–æ˜¯commonsçš„StopWatchï¼Ÿè¿™å‡ ç§æ–¹å¼éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åµŒå…¥ä»£ç ï¼Œå®¹æ˜“é—æ¼ã€è´¹åŠ›è¿˜è´¹æ—¶ã€‚<br>ç­‰ç­‰<br>arthaså¯ä»¥ä¸ºæˆ‘ä»¬è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¸®åŠ©ç¨‹åºå‘˜å°½æ—©ä¸‹ç­ï¼Œå°½æ—©äº¤ä»£ã€‚</p>
<h3 id="âœ…å®‰è£…å¯åŠ¨"><a href="#âœ…å®‰è£…å¯åŠ¨" class="headerlink" title="âœ…å®‰è£…å¯åŠ¨"></a>âœ…å®‰è£…å¯åŠ¨</h3><p>ä¸‹è½½: wget <a target="_blank" rel="noopener" href="https://alibaba.github.io/arthas/arthas-boot.jar">https://alibaba.github.io/arthas/arthas-boot.jar</a><br>å¯åŠ¨: java -jar arthas-boot.jar</p>
<p>é€€å‡ºarthas<br>quit â€”â€” é€€å‡ºå½“å‰ Arthas å®¢æˆ·ç«¯ï¼Œå…¶ä»– Arthas å®¢æˆ·ç«¯ä¸å—å½±å“<br>shutdown â€”â€” å…³é—­ Arthas æœåŠ¡ç«¯ï¼Œæ‰€æœ‰ Arthas å®¢æˆ·ç«¯å…¨éƒ¨é€€å‡º &amp; é‡ç½®æ‰€æœ‰å¢å¼ºè¿‡çš„ç±»ï¼Œå°±ä¸ç”¨å•ç‹¬è°ƒç”¨reset</p>
<h3 id="âœ…åº”ç”¨"><a href="#âœ…åº”ç”¨" class="headerlink" title="âœ…åº”ç”¨"></a>âœ…åº”ç”¨</h3><p>1ã€æŸ¥çœ‹æŸæ–¹æ³•è€—æ—¶</p>
<p><code>trace cn.asae.e.contract.web.ContractController getContract</code></p>
<p>2ã€æ˜¾ç¤ºè¿›ç¨‹ç›¸å…³ä¿¡æ¯ï¼Œä»ªè¡¨ç›˜</p>
<p><code>dashboard</code></p>
<p>3ã€æŸ¥çœ‹ç±»é‡ŒæŸä¸ªæ–¹æ³•çš„è¿”å›å€¼å’Œå…¥å‚</p>
<p>å‘½ä»¤+ç±»å®Œå…¨é™å®šå+ç›‘æµ‹æ–¹æ³•+è¡¨è¾¾å¼<br><code>watch cn.asae.e.contract.web.ContractSubjectController getContractSubjectLogs &quot;&#123;params,returnObj&#125;&quot;</code></p>
<p>4ã€æ—¶ç©ºéš§é“</p>
<p>æ–¹æ³•æ‰§è¡Œæ•°æ®çš„æ—¶ç©ºéš§é“ï¼Œè®°å½•ä¸‹æŒ‡å®šæ–¹æ³•æ¯æ¬¡è°ƒç”¨çš„å…¥å‚å’Œè¿”å›ä¿¡æ¯ï¼Œå¹¶èƒ½å¯¹è¿™äº›ä¸åŒçš„æ—¶é—´ä¸‹è°ƒç”¨è¿›è¡Œè§‚æµ‹</p>
<p><code>tt -t cn.asae.e.contract.web.ContractSubjectController getContractSubjectLogs</code><br>-t ä»£è¡¨è®°å½•ä¸‹æ¯æ¬¡æ–¹æ³•æ‰§è¡Œæƒ…å†µ</p>
<p>5ã€æŸ¥çœ‹JVMå·²åŠ è½½çš„ç±»ä¿¡æ¯</p>
<p><code>sc -d cn.asae.e.contract.web.ContractSubjectController</code></p>
<p>-d è¾“å‡ºå½“å‰ç±»çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿™ä¸ªç±»æ‰€åŠ è½½çš„åŸå§‹æ–‡ä»¶æ¥æºã€ç±»çš„å£°æ˜ã€åŠ è½½çš„ClassLoaderç­‰è¯¦ç»†ä¿¡æ¯ã€‚<br>å¦‚æœä¸€ä¸ªç±»è¢«å¤šä¸ªClassLoaderæ‰€åŠ è½½ï¼Œåˆ™ä¼šå‡ºç°å¤šæ¬¡</p>
<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/jiawen010/p/15513454.html">https://www.cnblogs.com/jiawen010/p/15513454.html</a></p>
<p>å…¶ä»–ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_37650458/article/details/123561000">https://blog.csdn.net/weixin_37650458/article/details/123561000</a></p>
<h2 id="fullGC"><a href="#fullGC" class="headerlink" title="fullGC"></a>fullGC</h2><h3 id="âœ…ä»€ä¹ˆæ˜¯GC-amp-heapåˆ†åŒº"><a href="#âœ…ä»€ä¹ˆæ˜¯GC-amp-heapåˆ†åŒº" class="headerlink" title="âœ…ä»€ä¹ˆæ˜¯GC &amp; heapåˆ†åŒº"></a>âœ…ä»€ä¹ˆæ˜¯GC &amp; heapåˆ†åŒº</h3><p>Javaåƒåœ¾å›æ”¶æœºåˆ¶ï¼ŒJavaé€šè¿‡å¯è¾¾æ€§åˆ†æä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨æ˜¯å¦å­˜åœ¨ï¼Œå½“ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œå°†å›æ”¶å †ä¸­çš„å¯¹è±¡ã€‚å›æ”¶æ— ç”¨å†…å­˜ç©ºé—´</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼ŒGCä¸»è¦æ˜¯é’ˆå¯¹è¿è¡Œçš„æ•°æ®åŒºçš„ã€‚ä½œä¸ºç¨‹åºå‘˜è¦å…³æ³¨çš„åŒºåŸŸä¸»è¦æœ‰5å—ï¼Œåˆ†åˆ«æ˜¯æ–¹æ³•åŒº(Method Area)ï¼ŒJavaæ ˆ(Java stack)ï¼Œæœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)ï¼Œå †(Heap)ï¼Œç¨‹åºè®¡æ•°å™¨(Program Counter Register)ã€‚å®é™…jvmåœ¨ç®¡ç†å†…å­˜çš„æ—¶å€™ï¼Œæ¯”è¿™ä¸ªåˆ†çš„æ›´ç»†è‡´ï¼Œåªä¸è¿‡åšåº”ç”¨ç¨‹åºå¼€å‘ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨è¿™5å—å°±å¯ä»¥äº†ã€‚</p>
<p>â€œå †â€ï¼Œä¹Ÿå°±æ˜¯Heapäº†ï¼Œå®ƒæ˜¯Jvmç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚ç¨‹åºçš„ä¸»è¦æ•°æ®ä¹Ÿéƒ½æ˜¯å­˜æ”¾åœ¨å †å†…å­˜ä¸­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºæ‰€åˆ›å»ºçš„å¯¹è±¡åŸºæœ¬ä¸Šéƒ½åœ¨è¯¥åŒºåŸŸè¿›è¡Œå†…å­˜åˆ†é…ï¼Œè¿™ä¸€å—åŒºåŸŸè¢«æ‰€æœ‰çš„çº¿ç¨‹æ‰€å…±äº«ï¼Œé€šå¸¸å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä¸€èˆ¬éƒ½æ˜¯è¿™ä¸ªåŒºåŸŸçš„æ•°æ®å‡ºç°çš„é—®é¢˜ã€‚é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„gcä¸»è¦æ˜¯é’ˆå¯¹java heapè¿™å—åŒºåŸŸçš„ã€‚</p>
<p>HeapåŒºåœ¨è®¾è®¡ä¸Šæ˜¯åˆ†ä»£è®¾è®¡çš„ï¼Œå…¶åˆ’åˆ†ä¸ºäº†Edenã€Survivor å’Œ Tenured/Old ï¼Œå…¶ä¸­EdenåŒºã€Survivor(å­˜æ´»)å±äºå¹´è½»ä»£ï¼ŒTenured/OldåŒºå±äºè€å¹´ä»£æˆ–è€…æŒä¹…ä»£ã€‚</p>
<p>ä¸€èˆ¬æˆ‘ä»¬å°†å¹´è½»ä»£å‘ç”Ÿçš„GCç§°ä¸ºMinor GCï¼Œå¯¹è€å¹´ä»£è¿›è¡ŒGCç§°ä¸ºMajor GCã€‚</p>
<p>è€ŒFullGCæ˜¯å¯¹æ•´ä¸ªå †æ¥è¯´çš„ï¼Œåœ¨æœ€è¿‘å‡ ä¸ªç‰ˆæœ¬çš„JDKé‡Œé»˜è®¤åŒ…æ‹¬äº†å¯¹æ°¸ç”Ÿå¸¦å³æ–¹æ³•åŒºçš„å›æ”¶(JDK8ä¸­æ— æ°¸ç”Ÿå¸¦äº†)ï¼Œå‡ºç°Full GCçš„æ—¶å€™ç»å¸¸ä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GC,ä½†éç»å¯¹çš„ã€‚Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šã€‚</p>
<hr>
<p>JVMçš„å †åŒºå¯¹è±¡åˆ†é…çš„ä¸€èˆ¬è§„åˆ™ï¼š</p>
<ol>
<li><p>å¯¹è±¡ä¼˜å…ˆåœ¨EdenåŒºåˆ†é…ï¼Œå½“edenä¸å¤Ÿåˆ†é…æ—¶ï¼Œè¿›è¡Œä¸€æ¬¡minor gcã€‚ï¼ˆjavaå¯¹è±¡å¤§å¤šå¾ˆå¿«æ²¡æ‰ï¼Œæ‰€ä»¥minor gcå¾ˆé¢‘ç¹ï¼‰</p>
</li>
<li><p>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£(-XX:PretenureSizeThreshold=3145728 è¿™ä¸ªå‚æ•°æ¥å®šä¹‰å¤šå¤§çš„å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£)</p>
</li>
<li><p>é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£(-XX:MaxTenuringThreshold=1è®¾ç½®æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼)</p>
</li>
<li><p>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®šï¼šè™šæ‹Ÿæœºå¹¶ä¸ä¼šæ°¸è¿œåœ°è¦æ±‚å¯¹è±¡çš„å¹´é¾„éƒ½å¿…é¡»è¾¾åˆ°MaxTenuringThresholdæ‰èƒ½æ™‹å‡è€å¹´ä»£ï¼Œå¦‚æœSurvivorç©ºé—´ä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡çš„å¤§å°æ€»å’Œå¤§äºSurvivorçš„ä¸€åŠï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£</p>
</li>
<li><p>ç©ºé—´åˆ†é…æ‹…ä¿ï¼šè®¡ç®—æ–°ç”Ÿä»£minor gcåå‰©ä¸‹çš„å¯¹è±¡è‹¥survivoræ— æ³•å®¹çº³ï¼Œæ˜¯å¦èƒ½é€šè¿‡è€å¹´ä»£æ¥æ‹…ä¿åˆ†é…ç©ºé—´ï¼Œå¦‚æœä¸èƒ½ï¼Œéœ€è¦è§¦å‘ä¸€æ¬¡full gcã€‚HandlePromotionFailure=falseè®¾ç½®æ˜¯å¦å…è®¸è€å¹´ä»£æ‹…ä¿ã€‚</p>
</li>
<li><p>åªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äº(æ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°)å°±ä¼šè¿›è¡Œminor GCï¼Œå¦åˆ™ä¼šè¿›è¡Œfull GCã€‚</p>
</li>
</ol>
<h3 id="âœ…FullGCçš„è§¦å‘æ¡ä»¶"><a href="#âœ…FullGCçš„è§¦å‘æ¡ä»¶" class="headerlink" title="âœ…FullGCçš„è§¦å‘æ¡ä»¶"></a>âœ…FullGCçš„è§¦å‘æ¡ä»¶</h3><p>FullGCæ˜¯é’ˆå¯¹æ•´ä¸ªHeapåŒºè€Œè¨€çš„ï¼Œå®ƒå°†åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µè¢«è§¦å‘ï¼š</p>
<p>1ã€åœ¨ç¨‹åºä¸­è°ƒç”¨äº†System.gc()æ–¹æ³•ã€‚æ­¤æ–¹æ³•çš„è°ƒç”¨æ˜¯å»ºè®®JVMè¿›è¡ŒFull GC,è™½ç„¶åªæ˜¯å»ºè®®è€Œéä¸€å®šï¼Œä½†å¾ˆå¤šæƒ…å†µä¸‹å®ƒä¼šè§¦å‘ Full GC,ä»è€Œå¢åŠ Full GCçš„é¢‘ç‡ï¼Œä¹Ÿå³å¢åŠ äº†é—´æ­‡æ€§åœé¡¿çš„æ¬¡æ•°ã€‚å¼ºçƒˆå½±å“ç³»å»ºè®®èƒ½ä¸ä½¿ç”¨æ­¤æ–¹æ³•å°±åˆ«ä½¿ç”¨ï¼Œè®©è™šæ‹Ÿæœºè‡ªå·±å»ç®¡ç†å®ƒçš„å†…å­˜ï¼Œå¯é€šè¿‡<code>-XX:+ DisableExplicitGC</code>æ¥ç¦æ­¢RMI(Javaè¿œç¨‹æ–¹æ³•è°ƒç”¨)è°ƒç”¨System.gcã€‚</p>
<p>2ã€è€å¹´ä»£ç©ºé—´ä¸è¶³ã€‚è€å¹´ä»£ç©ºé—´åªæœ‰åœ¨æ–°ç”Ÿä»£å¯¹è±¡è½¬å…¥åŠåˆ›å»ºä¸ºå¤§å¯¹è±¡ã€å¤§æ•°ç»„æ—¶æ‰ä¼šå‡ºç°ä¸è¶³çš„ç°è±¡ï¼Œå½“æ‰§è¡ŒFull GCåç©ºé—´ä»ç„¶ä¸è¶³ï¼Œåˆ™æŠ›å‡ºå¦‚ä¸‹é”™è¯¯ã€java.lang.OutOfMemoryError: Java heap spaceã€‘ï¼Œè€Œä¸ºé¿å…ä»¥ä¸Šä¸¤ç§çŠ¶å†µå¼•èµ·çš„Full GCï¼Œè°ƒä¼˜æ—¶åº”å°½é‡åšåˆ°è®©å¯¹è±¡åœ¨Minor GCé˜¶æ®µè¢«å›æ”¶ã€è®©å¯¹è±¡åœ¨æ–°ç”Ÿä»£å¤šå­˜æ´»ä¸€æ®µæ—¶é—´åŠä¸è¦åˆ›å»ºè¿‡å¤§çš„å¯¹è±¡åŠæ•°ç»„ã€‚</p>
<p>3ã€Permanet Generationç©ºé—´æ»¡äº†ã€‚ä¹Ÿå°±æ˜¯ä»¥å‰æ‰€è¯´çš„æ–¹æ³•åŒºï¼ŒPermanet Generationä¸­å­˜æ”¾çš„ä¸ºä¸€äº›classçš„ä¿¡æ¯ç­‰ï¼Œå½“ç³»ç»Ÿä¸­è¦åŠ è½½çš„ç±»ã€åå°„çš„ç±»å’Œè°ƒç”¨çš„æ–¹æ³•è¾ƒå¤šæ—¶ï¼ŒPermanet Generationå¯èƒ½ä¼šè¢«å æ»¡ï¼Œåœ¨æœªé…ç½®ä¸ºé‡‡ç”¨CMS GCï¼ˆconcurrent mark sweep æ ‡è®°æ¸…é™¤ç®—æ³•ï¼‰çš„æƒ…å†µä¸‹ä¼šæ‰§è¡ŒFull GCã€‚å¦‚æœç»è¿‡Full GCä»ç„¶å›æ”¶ä¸äº†ï¼Œé‚£ä¹ˆJVMä¼šæŠ›å‡ºé”™è¯¯ä¿¡æ¯ï¼šjava.lang.OutOfMemoryError: PermGen space ã€‚ä¸ºé¿å…Perm Genå æ»¡é€ æˆFull GCç°è±¡ï¼Œå¯é‡‡ç”¨çš„æ–¹æ³•ä¸ºå¢å¤§Perm Genç©ºé—´æˆ–è½¬ä¸ºä½¿ç”¨CMS GCã€‚</p>
<p>4ã€é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜ã€‚å¦‚æœå‘ç°ç»Ÿè®¡æ•°æ®è¯´ä¹‹å‰Minor GCçš„å¹³å‡æ™‹å‡å¤§å°æ¯”ç›®å‰old genå‰©ä½™çš„ç©ºé—´å¤§ï¼Œåˆ™ä¸ä¼šè§¦å‘Minor GCè€Œæ˜¯è½¬ä¸ºè§¦å‘full GCã€‚ç”±EdenåŒºã€From SpaceåŒºå‘To SpaceåŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œä¸”è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡å¤§å°ã€‚åˆ†é…å¾ˆå¤§çš„å¯¹è±¡ã€‚æ‰€è°“å¤§å¯¹è±¡ï¼Œæ˜¯æŒ‡éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„javaå¯¹è±¡ï¼Œä¾‹å¦‚å¾ˆé•¿çš„æ•°ç»„ï¼Œæ­¤ç§å¯¹è±¡ä¼šç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œè€Œè€å¹´ä»£è™½ç„¶æœ‰å¾ˆå¤§çš„å‰©ä½™ç©ºé—´ï¼Œä½†æ˜¯æ— æ³•æ‰¾åˆ°è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´æ¥åˆ†é…ç»™å½“å‰å¯¹è±¡ï¼Œæ­¤ç§æƒ…å†µå°±ä¼šè§¦å‘JVMè¿›è¡ŒFull GCã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒCMSåƒåœ¾æ”¶é›†å™¨æä¾›äº†ä¸€ä¸ªå¯é…ç½®çš„å‚æ•°ï¼Œå³<code>-XX:+UseCMSCompactAtFullCollection</code>å¼€å…³å‚æ•°ï¼Œç”¨äºåœ¨â€œäº«å—â€å®ŒFull GCæœåŠ¡ä¹‹åé¢å¤–å…è´¹èµ é€ä¸€ä¸ªç¢ç‰‡æ•´ç†çš„è¿‡ç¨‹ï¼Œå†…å­˜æ•´ç†çš„è¿‡ç¨‹æ— æ³•å¹¶å‘çš„ï¼Œç©ºé—´ç¢ç‰‡é—®é¢˜æ²¡æœ‰äº†ï¼Œä½†åœé¡¿æ—¶é—´ä¸å¾—ä¸å˜é•¿äº†ï¼ŒJVMè®¾è®¡è€…ä»¬è¿˜æä¾›äº†å¦å¤–ä¸€ä¸ªå‚æ•° <code>-XX:CMSFullGCsBeforeCompaction</code>ï¼Œè¿™ä¸ªå‚æ•°ç”¨äºè®¾ç½®åœ¨æ‰§è¡Œå¤šå°‘æ¬¡ä¸å‹ç¼©çš„Full GCåï¼Œè·Ÿç€æ¥ä¸€æ¬¡å¸¦å‹ç¼©çš„ã€‚</p>
<h3 id="âœ…åˆ†ä»£æ”¶é›†ç®—æ³•"><a href="#âœ…åˆ†ä»£æ”¶é›†ç®—æ³•" class="headerlink" title="âœ…åˆ†ä»£æ”¶é›†ç®—æ³•"></a>âœ…åˆ†ä»£æ”¶é›†ç®—æ³•</h3><p>é’ˆå¯¹å¹´è½»ä»£å’Œè€å¹´ä»£ï¼ŒJVMå°†ä½¿ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†ç®—æ³•è¿›è¡Œæ”¶é›†ï¼Œè¾¾åˆ°é«˜æ•ˆçš„åƒåœ¾å›æ”¶ã€‚</p>
<p>1ã€å¹´è½»ä»£é‡‡ç”¨çš„æ˜¯æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œå°†éœ€è¦å›æ”¶çš„å¯¹è±¡æ ‡è®°ï¼Œå°†ä¸éœ€è¦çš„å¯¹è±¡ç§»åŠ¨åˆ°Survivorç©ºé—´ï¼Œç„¶åå°†æ ‡è®°å¯¹è±¡å›æ”¶ï¼Œè¯¥ç®—æ³•å¯ä»¥å®ç°å¯¹å¤§å¤šæ•°ä¼šå¤±æ•ˆçš„å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¯¹å°‘éƒ¨åˆ†ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡è¿›è¡Œè½¬ç§»ï¼Œä¿è¯edenåŒºæ‹¥æœ‰è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè€Œä¸”å¤åˆ¶çš„æ•ˆç‡é«˜ã€‚</p>
<p>å› ä¸ºåœ¨å¹´è½»ä»£ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ä¸€èˆ¬æ˜¯å¾ˆå°‘çš„ï¼Œæ¯æ¬¡åƒåœ¾æ”¶é›†æ—¶éƒ½æœ‰å¤§æ‰¹å¯¹è±¡æ­»å»ï¼Œåªæœ‰å°‘é‡å­˜æ´»ï¼Œé€‰ç”¨å¤åˆ¶ç®—æ³•ï¼Œåªéœ€è¦ä»˜å‡ºå°‘é‡å­˜æ´»å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ”¶é›†ã€‚</p>
<p>2ã€è€å¹´ä»£é‡‡ç”¨çš„æ˜¯æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå°†éœ€è¦å›æ”¶çš„å¯¹è±¡æ ‡è®°ï¼Œå°†ä¸éœ€è¦çš„å¯¹è±¡è¿›è¡Œç§»åŠ¨æ•´ç†ï¼Œä½¿ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡å ç”¨è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå†æ¸…é™¤å›æ”¶å¯¹è±¡ï¼Œä¿è¯è€å¹´ä»£æ‹¥æœ‰è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè€Œä¸”æ•´ç†æ•ˆç‡é«˜ã€‚</p>
<p>å› ä¸ºåœ¨è€å¹´ä»£éœ€è¦å›æ”¶çš„å¯¹è±¡ä¸€èˆ¬æ˜¯å¾ˆå°‘çš„ï¼Œå…¶å­˜æ´»ç‡è¾ƒé«˜ã€æ²¡æœ‰é¢å¤–ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ã€‚</p>
<p>3ã€CMS GCï¼ˆconcurrent mark sweep æ ‡è®°æ¸…é™¤ç®—æ³•ï¼‰è€å¹´ä»£ä¸­ä½¿ç”¨ï¼šæ ‡è®°æ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œåç»Ÿä¸€å›æ”¶ã€‚ç¼ºç‚¹ï¼šæ ‡è®°æ¸…é™¤æ•ˆç‡ä¸é«˜ï¼Œäº§ç”Ÿç¢ç‰‡å¤šã€‚ä½†æ˜¯å¹¶å‘æ”¶é›†ï¼Œä½åœé¡¿ã€‚</p>
<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_35291771/article/details/114075710">https://blog.csdn.net/weixin_35291771/article/details/114075710</a></p>
<p>æ¢ç§˜Javaè™šæ‹Ÿæœºâ€”â€”å†…å­˜ç®¡ç†ä¸åƒåœ¾å›æ”¶ï¼š<br><a target="_blank" rel="noopener" href="http://www.blogjava.net/chhbjh/archive/2012/01/28/368936.html">http://www.blogjava.net/chhbjh/archive/2012/01/28/368936.html</a></p>
<h3 id="âœ…ä»€ä¹ˆæ˜¯fullgc"><a href="#âœ…ä»€ä¹ˆæ˜¯fullgc" class="headerlink" title="âœ…ä»€ä¹ˆæ˜¯fullgc"></a>âœ…ä»€ä¹ˆæ˜¯fullgc</h3><p>ä¸€äº›æ¦‚å¿µï¼š</p>
<p>GC<br>GC å…¨ç§°ä¸ºgarbage collection,ä¸­æ–‡å«ä¹‰ä¸ºåƒåœ¾å›æ”¶ï¼Œåœ¨jvmä¸­çš„å«ä¹‰ä¸ºå›æ”¶æ— ç”¨å†…å­˜ç©ºé—´</p>
<p>Young space<br>ä¸­æ–‡åä¸ºå¹´è½»ä»£æˆ–è€…æ–°ç”Ÿä»£ï¼Œä¸ºJVM å †çš„ä¸€éƒ¨åˆ†ï¼Œç”±åˆ†ä»£GCæ¦‚å¿µåˆ’åˆ†è€Œæ¥ï¼Œä¿å­˜ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„å¯¹è±¡</p>
<p>Tenured space<br>ä¸­æ–‡åä¸ºè€å¹´ä»£æˆ–å¹´è€ä»£ï¼Œä¸ºJVM å †çš„ä¸€éƒ¨åˆ†ï¼Œç”±åˆ†ä»£GCæ¦‚å¿µåˆ’åˆ†è€Œæ¥ï¼Œä¿å­˜ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡</p>
<p>Minor GC<br>minor gcæŒ‡çš„æ˜¯å‘ç”Ÿåœ¨å¹´è½»ä»£æˆ–è€…è¯´æ–°ç”Ÿä»£ï¼ˆYoung spaceï¼‰ä¸­çš„gcï¼Œä¹Ÿæœ‰äººç§°å…¶ä¸ºyoung gcæˆ–è€…ygc,åœ¨ä¸‹æ–‡ä¸­æˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨minor gcè¡¨ç¤º</p>
<p>Major GC<br>major gcæŒ‡çš„æ˜¯å‘ç”Ÿåœ¨è€å¹´ä»£ï¼ˆTenured spaceï¼‰ä¸­çš„gcï¼Œä¹Ÿæœ‰äººç§°ä¸ºold gc,o gc,cms gcç­‰ï¼Œåœ¨ä¸‹æ–‡æˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨major gcè¡¨ç¤º</p>
<p>stop the world<br>æŒ‡çš„æ˜¯ç”¨æˆ·çº¿ç¨‹åœ¨è¿è¡Œè‡³å®‰å…¨ç‚¹ï¼ˆsafe pointï¼‰æˆ–å®‰å…¨åŒºåŸŸï¼ˆsafe regionï¼‰ä¹‹åï¼Œå°±è‡ªè¡ŒæŒ‚èµ·ï¼Œè¿›å…¥æš‚åœçŠ¶æ€ï¼Œå¯¹å¤–çš„è¡¨ç°çœ‹èµ·æ¥å°±åƒæ˜¯å…¨ä¸–ç•Œéƒ½åœæ­¢è¿è½¬äº†ä¸€æ ·,è€Œä¸è®ºä½•ç§gcç®—æ³•ï¼Œä¸è®ºæ˜¯minor gcè¿˜æ˜¯major gcéƒ½ä¼šstop the worldï¼ŒåŒºåˆ«åªåœ¨äºstop the worldçš„æ—¶é—´é•¿çŸ­ã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯Full GC</strong></p>
<p>å…ˆè¯´ä¸€ä¸‹ç»“è®ºï¼ŒFull GCè¿™ä¸ªæ¦‚å¿µæ˜¯æ²¡æœ‰å®˜æ–¹å®šä¹‰çš„ï¼Œè€Œä¸”å«ä¹‰è¿˜ç‰¹åˆ«æ··ä¹±ï¼Œåœ¨ä¸åŒåœ°æ–¹è¡¨è¾¾çš„å«ä¹‰æ˜¯ä¸åŒçš„ï¼Œéœ€è¦å°±ä¸åŒçš„åœºæ™¯åˆ†åˆ«è¿›è¡Œè®¨è®ºã€‚</p>
<p>å¤§ä¼—è®¤çŸ¥ä¸Šï¼š<br>åœ¨é€šå¸¸æ„ä¹‰ä¸Šäººä»¬å£ä¸­è¯´çš„Full GCä¸ºä¸€æ¬¡ç‰¹æ®ŠGCè¡Œä¸ºçš„æè¿°ï¼Œè¿™æ¬¡GCä¼šå›æ”¶æ•´ä¸ªå †çš„å†…å­˜ï¼ŒåŒ…å«è€å¹´ä»£ï¼Œæ–°ç”Ÿä»£ï¼Œmetaspaceç­‰ï¼Œè¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ä¸€ç§è®¤çŸ¥ï¼Œå¾ˆå¤šäººä¹Ÿå°±äº†è§£åˆ°è¿™ä¸ªç¨‹åº¦ï¼Œå› æ­¤åœ¨é‡åˆ°ä¸€äº›ç‰¹æ®Šåœºæ™¯çš„æ—¶å€™å°±ä¼šå‘ç°å®é™…æƒ…å†µå’Œè‡ªå·±çš„è®¤çŸ¥ä¼šå‘ç”Ÿå†²çª</p>
<p>ä»GCæ—¥å¿—ä¸Šï¼š<br>åœ¨gc.logä¸­ä¼šå‘ç°åœ¨éƒ¨åˆ†gcæ—¥å¿—å¤´ä¸­ä¹Ÿæœ‰Full GCè¿™æ ·çš„å­—çœ¼ï¼Œè¿™é‡Œè¡¨ç¤ºçš„å«ä¹‰æ˜¯åœ¨è¿™æ¬¡GCçš„å…¨è¿‡ç¨‹ä¸­ï¼Œéƒ½æ˜¯Stop The worldçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿™æ¬¡GCçš„å…¨è¿‡ç¨‹ä¸­æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹éƒ½æ˜¯å¤„äºæš‚åœçš„çŠ¶æ€</p>
<p>é˜¿é‡Œè€å“¥æ€»ç»“çš„ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/kep159/article/details/103088438">https://blog.csdn.net/kep159/article/details/103088438</a></p>
<h3 id="âœ…jstatæŸ¥çœ‹GC"><a href="#âœ…jstatæŸ¥çœ‹GC" class="headerlink" title="âœ…jstatæŸ¥çœ‹GC"></a>âœ…jstatæŸ¥çœ‹GC</h3><p><strong>ä½¿ç”¨jstat æŸ¥å‡ºæ¥çš„FGC æ¬¡æ•°å’Œæ—¶é—´ï¼Œå®é™…ä¸ŠæŒ‡çš„æ˜¯è€å¹´ä»£çš„æ”¶é›†å™¨å‘ç”ŸStop the world çš„æ¬¡æ•°å’ŒæŒç»­æ—¶é—´</strong></p>
<p>1ã€æŸ¥è¯¢GCä½¿ç”¨æƒ…å†µï¼š<br><code>jstat -gcutil 23484 1000 5</code></p>
<p>1000æ˜¯é—´éš”æ—¶é—´ï¼Œ5æ˜¯æ€»å…±æ‰“å°5æ¬¡ï¼Œå¯ç¼ºçœã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">68.75   0.00  62.73   0.17  96.39  90.54      2    0.010     0    0.000    0.010</span><br><span class="line"></span><br><span class="line">S0: æ–°ç”Ÿä»£ä¸­Survivor space 0åŒºå·²ä½¿ç”¨ç©ºé—´çš„ç™¾åˆ†æ¯”</span><br><span class="line">S1: æ–°ç”Ÿä»£ä¸­Survivor space 1åŒºå·²ä½¿ç”¨ç©ºé—´çš„ç™¾åˆ†æ¯”</span><br><span class="line">E: æ–°ç”Ÿä»£å·²ä½¿ç”¨ç©ºé—´çš„ç™¾åˆ†æ¯”</span><br><span class="line">O: è€å¹´ä»£å·²ä½¿ç”¨ç©ºé—´çš„ç™¾åˆ†æ¯”</span><br><span class="line">Mï¼šå…ƒæ•°æ®åŒºä½¿ç”¨æ¯”ä¾‹</span><br><span class="line">CCSï¼šå‹ç¼©ä½¿ç”¨æ¯”ä¾‹</span><br><span class="line">YGC: ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°å½“å‰ï¼Œå‘ç”ŸYang GC çš„æ¬¡æ•°</span><br><span class="line">YGCT: ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°å½“å‰ï¼ŒYang GCæ‰€ç”¨çš„æ—¶é—´ã€å•ä½ç§’ã€‘</span><br><span class="line">FGC: ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°å½“å‰ï¼Œå‘ç”ŸFull GCçš„æ¬¡æ•°</span><br><span class="line">FGCT: ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°å½“å‰ï¼ŒFull GCæ‰€ç”¨çš„æ—¶é—´</span><br><span class="line">GCT: ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°å½“å‰ï¼Œç”¨äºåƒåœ¾å›æ”¶çš„æ€»æ—¶é—´ã€å•ä½ç§’ã€‘</span><br></pre></td></tr></table></figure>

<p>2ã€åƒåœ¾æ€»ä½“å›æ”¶ç»Ÿè®¡<br><code>jstat -gc 91185 1000 5</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line"> 68.75   0.00  62.73   0.17  96.39  90.54      2    0.010     0    0.000    0.010</span><br><span class="line"></span><br><span class="line">S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°</span><br><span class="line">S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°</span><br><span class="line">S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°</span><br><span class="line">S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°</span><br><span class="line">ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°</span><br><span class="line">EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°</span><br><span class="line">OCï¼šè€å¹´ä»£å¤§å°</span><br><span class="line">OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å°</span><br><span class="line">MCï¼šæ–¹æ³•åŒºå¤§å°</span><br><span class="line">MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°</span><br><span class="line">CCSC:å‹ç¼©ç±»ç©ºé—´å¤§å°</span><br><span class="line">CCSU:å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°</span><br><span class="line">YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</span><br><span class="line">YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</span><br><span class="line">FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</span><br><span class="line">FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</span><br><span class="line">GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´</span><br></pre></td></tr></table></figure>

<p>3ã€æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ç»Ÿè®¡<br><code>jstat -gcnew 91185 1000 5</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">S0C    S1C    S0U    S1U   TT MTT  DSS      EC       EU     YGC     YGCT</span><br><span class="line">5120.0 5120.0 3520.2    0.0  7  15 5120.0  33280.0  20877.8      2    0.010</span><br><span class="line"></span><br><span class="line">S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºå¤§å°</span><br><span class="line">S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å°</span><br><span class="line">S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°</span><br><span class="line">S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å°</span><br><span class="line">TT:å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»çš„æ¬¡æ•°</span><br><span class="line">MTT:å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»çš„æœ€å¤§æ¬¡æ•°</span><br><span class="line">DSS:æœŸæœ›çš„å¹¸å­˜åŒºå¤§å°</span><br><span class="line">ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å°</span><br><span class="line">EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å°</span><br><span class="line">YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°</span><br><span class="line">YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´</span><br></pre></td></tr></table></figure>

<p>4ã€å †å†…å­˜ç»Ÿè®¡<br><code>jstat -gccapacity 18528 1000 5 //æ•´ä½“ç»Ÿè®¡</code><br><code>jstat -gcnewcapacity 18528 1000 5 //æ–°ç”Ÿä»£ç»Ÿè®¡</code><br><code>jstat -gcoldcapacity 18528 1000 5 //è€å¹´ä»£ç»Ÿè®¡</code></p>
<h2 id="javaå †æ ˆ"><a href="#javaå †æ ˆ" class="headerlink" title="javaå †æ ˆ"></a>javaå †æ ˆ</h2><h3 id="âœ…javaå†…å­˜ç©ºé—´"><a href="#âœ…javaå†…å­˜ç©ºé—´" class="headerlink" title="âœ…javaå†…å­˜ç©ºé—´"></a>âœ…javaå†…å­˜ç©ºé—´</h3><p>JAVAåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œåœ¨å†…å­˜ä¸­åˆ’åˆ†5ç‰‡ç©ºé—´è¿›è¡Œæ•°æ®çš„å­˜å‚¨ã€‚åˆ†åˆ«æ˜¯ï¼š1ï¼šç¨‹åºè®¡æ•°å™¨ã€‚2ï¼šæœ¬åœ°æ–¹æ³•æ ˆã€‚3ï¼šæ–¹æ³•åŒºã€‚4ï¼šæ ˆã€‚5ï¼šå †ã€‚<br>å †å’Œæ ˆéƒ½æ˜¯Javaç”¨æ¥åœ¨RAMä¸­å­˜æ”¾æ•°æ®çš„åœ°æ–¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ç¨‹åºè®¡æ•°å™¨ï¼šçº¿ç¨‹ç§æœ‰ï¼Œå­˜å‚¨å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç è¡Œå·æŒ‡ç¤ºå™¨ã€‚</span><br><span class="line">å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½ä¾èµ–è¯¥è®¡æ•°å™¨ã€‚æº¢å‡ºæ¦‚ç‡æä½ã€‚</span><br><span class="line"></span><br><span class="line">javaè™šæ‹Ÿæœºæ ˆï¼šçº¿ç¨‹ç§æœ‰ã€‚å±€éƒ¨å˜é‡è¡¨çš„å¤§å°åœ¨ç¼–è¯‘å™¨ç¡®å®šã€‚</span><br><span class="line">æ–¹æ³•çš„ç›¸å…³è°ƒç”¨ä¿¡æ¯ã€å˜é‡ä¿¡æ¯ï¼Œå¯¹è±¡çš„å¼•ç”¨ã€‚</span><br><span class="line">ä¼šæŠ›å‡ºï¼šStackOverflowErrorå’ŒOutOfMemoryError</span><br><span class="line"></span><br><span class="line">æœ¬åœ°æ–¹æ³•æ ˆï¼šä¸ºæœ¬åœ°æ–¹æ³•æ‰€æœåŠ¡</span><br><span class="line"></span><br><span class="line">javaå †ï¼šçº¿ç¨‹å…±äº«åŒºåŸŸï¼Œå­˜å‚¨å¯¹è±¡å®ä¾‹åŠæ•°ç»„ã€‚æœ‰å¯èƒ½æŠ›å‡ºOutOfMemoryError</span><br><span class="line"></span><br><span class="line">æ–¹æ³•åŒºï¼šçº¿ç¨‹å…±äº«åŒºåŸŸï¼Œå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ï¼Œå³æ—¶å˜å¼‚åçš„ä»£ç ã€‚</span><br><span class="line">åˆå«æ°¸ä¹…ä»£ï¼Œjava8ä¸­é€æ­¥å–æ¶ˆï¼Œè¢«metaspaceå…ƒæ•°æ®åŒºå–ä»£ã€‚æœ‰å¯èƒ½æŠ›å‡ºOutOfMemoryError</span><br><span class="line"></span><br><span class="line">ç›´æ¥å†…å­˜ï¼šNIOæœºåˆ¶ï¼Œä½¿ç”¨Nativeå‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ã€‚</span><br></pre></td></tr></table></figure>

<p>1ã€å †</p>
<p>å¯ä»¥æŠŠå †ç†è§£ä¸ºä¸€å®¶é¤å…ï¼Œé‡Œé¢æœ‰200å¼ æ¡Œå­ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šèƒ½åŒæ—¶å®¹çº³200æ¡Œå®¢äººå°±é¤ï¼Œæ¥ä¸€æ‰¹å®¢äººå°±ä¸ºä»–ä»¬å®‰æ’ä¸€äº›æ¡Œå­ï¼Œå¦‚æœæŸå¤©æ¥çš„å®¢äººç‰¹åˆ«å¤šï¼Œè¶…è¿‡200æ¡Œäº†ï¼Œé‚£å°±ä¸èƒ½å†æ¥å¾…è¶…å‡ºçš„å®¢äººäº†ã€‚</p>
<p>å½“ç„¶ï¼Œè¿›æ¥åƒé¥­çš„å®¢äººä¸å¯èƒ½æ˜¯åŒæ—¶çš„ï¼Œæœ‰çš„æ—©ï¼Œæœ‰çš„æ™šï¼Œå…ˆåƒå¥½çš„å®¢äººï¼Œè€æ¿ä¼šå®‰æ’ç»™ä»–ä»¬ç»“è´¦èµ°äººï¼Œç„¶åç©ºå‡ºæ¥çš„æ¡Œå­åˆèƒ½æ¥å¾…æ–°çš„å®¢äººã€‚</p>
<p>è¿™é‡Œï¼Œå †å°±æ˜¯é¤å…ï¼Œæœ€å¤§å®¹é‡200æ¡Œå°±æ˜¯å †å†…å­˜çš„å¤§å°ï¼Œè€æ¿å°±ç›¸å½“äºGC(åƒåœ¾å›æ”¶)ï¼Œç»™å®¢äººå®‰æ’æ¡Œå­å°±ç›¸å½“äºjavaåˆ›å»ºå¯¹è±¡çš„æ—¶å€™åˆ†é…å †å†…å­˜ï¼Œç»“è´¦å°±ç›¸å½“äºGCå›æ”¶å¯¹è±¡å ç”¨çš„ç©ºé—´ã€‚</p>
<p>2ã€æ ˆ</p>
<p>æ¥ç€æŠŠæ ˆæ¯”ä½œä¸€å£åºŸäº•ï¼Œè¿™å£äº•å¤šå¹´ä¸ç”¨å·²ç»æ²¡æ°´äº†ï¼Œä¸»äººç°åœ¨æŠŠå®ƒä½œä¸ºè´®å­˜è‡ªé…¿é…’çš„åœ°æ–¹ï¼Œå­˜é…’çš„æ—¶å€™å°±ç”¨ç»³å­å‹¾ç€é…’å›å­æ…¢æ…¢æ”¾ä¸‹å»ï¼Œåé¢å†å­˜å°±ä¸€å›ä¸€å›å †ç€æ”¾ä¸Šå»ï¼Œå–é…’çš„æ—¶å€™å°±å…ˆå–æœ€ä¸Šé¢çš„å›å­ã€‚</p>
<h3 id="âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°å †Heapé‡Œ"><a href="#âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°å †Heapé‡Œ" class="headerlink" title="âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°å †Heapé‡Œ"></a>âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°å †Heapé‡Œ</h3><p>å­˜æ”¾ï¼šå­˜æ”¾ç”±newåˆ›å»ºçš„å¯¹è±¡å’Œæ•°ç»„ã€‚</p>
<p>åœ¨å †ä¸­åˆ†é…çš„å†…å­˜ï¼Œç”±javaè™šæ‹Ÿæœºè‡ªåŠ¨åƒåœ¾å›æ”¶å™¨æ¥ç®¡ç†ã€‚åœ¨å †ä¸­äº§ç”Ÿäº†ä¸€ä¸ªæ•°ç»„æˆ–è€…å¯¹è±¡åï¼Œä¼šåœ¨æ ˆä¸­å®šä¹‰ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå˜é‡çš„å–å€¼ç­‰äºæ•°ç»„æˆ–è€…å¯¹è±¡åœ¨å †å†…å­˜ä¸­çš„é¦–åœ°å€ï¼Œå¼•ç”¨å˜é‡ç›¸å½“äºä¸ºæ•°ç»„æˆ–è€…å¯¹è±¡èµ·çš„ä¸€ä¸ªåˆ«åï¼Œæˆ–è€…ä»£å·ã€‚</p>
<p>æ•°ç»„ï¼†å¯¹è±¡æœ¬èº«åœ¨å †ä¸­åˆ†é…ï¼Œå³ä½¿ç¨‹åºè¿è¡Œåˆ°ä½¿ç”¨newäº§ç”Ÿæ•°ç»„å’Œå¯¹è±¡çš„è¯­å¥æ‰€åœ¨åœ°ä»£ç å—ä¹‹å¤–ï¼Œæ•°ç»„å’Œå¯¹è±¡æœ¬èº«å ç”¨çš„å †å†…å­˜ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ï¼Œæ•°ç»„å’Œå¯¹è±¡åœ¨æ²¡æœ‰å¼•ç”¨å˜é‡æŒ‡å‘å®ƒçš„æ—¶å€™ï¼Œæ‰å˜æˆåƒåœ¾ï¼Œä¸èƒ½å†è¢«ä½¿ç”¨ï¼Œä½†æ˜¯ä»ç„¶å ç€å†…å­˜ï¼Œåœ¨éšåçš„ä¸€ä¸ªä¸ç¡®å®šçš„æ—¶é—´è¢«åƒåœ¾å›æ”¶å™¨é‡Šæ”¾æ‰ã€‚è¿™ä¸ªä¹Ÿæ˜¯javaæ¯”è¾ƒå å†…å­˜çš„ä¸»è¦åŸå› ï¼Œå®é™…ä¸Šï¼Œæ ˆä¸­çš„å˜é‡æŒ‡å‘å †å†…å­˜ä¸­çš„å˜é‡ï¼Œè¿™å°±æ˜¯ Java ä¸­çš„æŒ‡é’ˆ!</p>
<p>å †å†…å­˜çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ<br>ç¬¬ä¸€ç‚¹ï¼šå †å…¶å®å¯ä»¥ç±»ä¼¼çš„çœ‹åšæ˜¯ç®¡é“ï¼Œæˆ–è€…è¯´æ˜¯å¹³æ—¶å»æ’é˜Ÿä¹°ç¥¨çš„æƒ…å†µå·®ä¸å¤šï¼Œæ‰€ä»¥å †å†…å­˜çš„ç‰¹ç‚¹å°±æ˜¯ï¼šå…ˆè¿›å…ˆå‡ºï¼Œåè¿›åå‡ºï¼Œä¹Ÿå°±æ˜¯ä½ å…ˆæ’é˜Ÿå¥½ï¼Œä½ å…ˆä¹°ç¥¨ã€‚<br>ç¬¬äºŒç‚¹ï¼šå †å¯ä»¥åŠ¨æ€åœ°åˆ†é…å†…å­˜å¤§å°ï¼Œç”Ÿå­˜æœŸä¹Ÿä¸å¿…äº‹å…ˆå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œå› ä¸ºå®ƒæ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ†é…å†…å­˜çš„ï¼Œä½†ç¼ºç‚¹æ˜¯ï¼Œç”±äºè¦åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ†é…å†…å­˜ï¼Œå­˜å–é€Ÿåº¦è¾ƒæ…¢ã€‚<br>newå¯¹è±¡åœ¨å †ä¸­å¦‚ä½•åˆ†é…ï¼Ÿ<br>ç”±Javaè™šæ‹Ÿæœºçš„è‡ªåŠ¨åƒåœ¾å›æ”¶å™¨æ¥ç®¡ç†ã€‚</p>
<h3 id="âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°æ ˆStacké‡Œ"><a href="#âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°æ ˆStacké‡Œ" class="headerlink" title="âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°æ ˆStacké‡Œ"></a>âœ…ä»€ä¹ˆæ—¶å€™å­˜åˆ°æ ˆStacké‡Œ</h3><p>å­˜æ”¾ï¼šåœ¨å‡½æ•°ä¸­å®šä¹‰çš„ä¸€äº›åŸºæœ¬ç±»å‹çš„å˜é‡(8ç§ï¼Œint, short, long, byte, float, double, boolean, charï¼Œä¸åŒ…å«String)å’Œå¯¹è±¡çš„å¼•ç”¨å˜é‡ã€mainæ–¹æ³•ã€æ–¹æ³•å‡½æ•°</p>
<p>å½“åœ¨ä¸€æ®µä»£ç å—ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡æ—¶ï¼Œjavaå°±åœ¨æ ˆä¸­ä¸ºè¿™ä¸ªå˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå½“è¶…è¿‡å˜é‡çš„ä½œç”¨åŸŸåï¼Œjavaä¼šè‡ªåŠ¨é‡Šæ”¾æ‰ä¸ºè¯¥å˜é‡åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œè¯¥å†…å­˜ç©ºé—´å¯ä»¥ç«‹åˆ»è¢«å¦ä½œä»–ç”¨ã€‚</p>
<p>æ ˆå†…å­˜çš„ç‰¹ç‚¹<br>ç¬¬ä¸€ç‚¹ï¼šæ ˆå†…å­˜å°±å¥½åƒä¸€ä¸ªçŸ¿æ³‰æ°´ç“¶ï¼Œå¾€é‡Œé¢æ”¾å…¥ä¸œè¥¿ï¼Œé‚£ä¹ˆå…ˆæ”¾å…¥çš„æ²‰å…¥åº•éƒ¨ï¼Œæ‰€ä»¥å®ƒçš„ç‰¹ç‚¹æ˜¯ï¼šå…ˆè¿›åå‡ºï¼Œåè¿›å…ˆå‡º<br>ç¬¬äºŒç‚¹ï¼šå­˜å–é€Ÿåº¦æ¯”å †è¦å¿«ï¼Œä»…æ¬¡äºå¯„å­˜å™¨ã€‚ä½†ç¼ºç‚¹æ˜¯ï¼Œå­˜åœ¨æ ˆä¸­çš„æ•°æ®å¤§å°ä¸ç”Ÿå­˜æœŸå¿…é¡»æ˜¯ç¡®å®šçš„ï¼Œç¼ºä¹çµæ´»æ€§ã€‚</p>
<p>æ ˆä¸­ä¸»è¦å­˜æ”¾ä¸€äº›åŸºæœ¬ç±»å‹çš„å˜é‡ï¼ˆint, short, long, byte, float, double, boolean, charï¼‰å’Œå¯¹è±¡å¥æŸ„ã€‚<br>æ ˆå†…å­˜åˆ†é…æœºåˆ¶<br>æ ˆå†…å­˜å¯ä»¥ç§°ä¸ºä¸€çº§ç¼“å­˜ï¼Œç”±åƒåœ¾å›æ”¶å™¨è‡ªåŠ¨å›æ”¶<br>ä¾‹å­ï¼š<br>int a = 3;<br>int b = 3;</p>
<h3 id="âœ…å †æ ˆçš„åŒºåˆ«"><a href="#âœ…å †æ ˆçš„åŒºåˆ«" class="headerlink" title="âœ…å †æ ˆçš„åŒºåˆ«"></a>âœ…å †æ ˆçš„åŒºåˆ«</h3><p>JVMæ˜¯åŸºäºå †æ ˆçš„è™šæ‹Ÿæœºï¼ŒJVMä¸ºæ–°åˆ›å»ºçš„çº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªå †æ ˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºä¸€ä¸ªJavaç¨‹åºæ¥è¯´ï¼Œå®ƒçš„è¿è¡Œå°±æ˜¯é€šè¿‡å¯¹å †æ ˆçš„æ“ä½œæ¥å®Œæˆçš„ã€‚å †æ ˆä»¥å¸§ä¸ºå•ä½ä¿å­˜çº¿ç¨‹çš„çŠ¶æ€ã€‚JVMå¯¹å †æ ˆåªè¿›è¡Œä¸¤ç§æ“ä½œï¼šä»¥å¸§ä¸ºå•ä½çš„å‹æ ˆå’Œå‡ºæ ˆæ“ä½œã€‚</p>
<p>å·®å¼‚ï¼š<br>1). å †å†…å­˜ç”¨æ¥å­˜æ”¾ç”±newåˆ›å»ºçš„å¯¹è±¡å’Œæ•°ç»„<br>2). æ ˆå†…å­˜ç”¨æ¥å­˜æ”¾æ–¹æ³•æˆ–è€…å±€éƒ¨å˜é‡ç­‰<br>3). å †æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œåè¿›åå‡º<br>4). æ ˆæ˜¯å…ˆè¿›åå‡ºï¼Œåè¿›å…ˆå‡º<br>5). å…±äº«æ€§çš„ä¸åŒï¼šæ ˆå†…å­˜æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œ<strong>å †å†…å­˜æ˜¯æ‰€æœ‰çº¿ç¨‹å…±æœ‰çš„</strong><br>6). ç”Ÿå­˜ç©ºé—´ä¸åŒï¼šæ ˆä¸­æ•°æ®çš„ç”Ÿå­˜ç©ºé—´ä¸€èˆ¬åœ¨å½“å‰scopeså†…(å°±æ˜¯ç”±{â€¦}æ‹¬èµ·æ¥çš„åŒºåŸŸ).</p>
<p>æ ˆï¼š</p>
<p>å‡½æ•°ä¸­å®šä¹‰çš„åŸºæœ¬ç±»å‹å˜é‡ï¼Œå¯¹è±¡çš„å¼•ç”¨å˜é‡éƒ½åœ¨å‡½æ•°çš„æ ˆå†…å­˜ä¸­åˆ†é…ã€‚<br>æ ˆå†…å­˜ç‰¹ç‚¹ï¼Œæ•°æ•°æ®ä¸€æ‰§è¡Œå®Œæ¯•ï¼Œå˜é‡ä¼šç«‹å³é‡Šæ”¾ï¼ŒèŠ‚çº¦å†…å­˜ç©ºé—´ã€‚<br>æ ˆå†…å­˜ä¸­çš„æ•°æ®ï¼Œæ²¡æœ‰é»˜è®¤åˆå§‹åŒ–å€¼ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®ã€‚</p>
<p>å †ï¼š</p>
<p>å †å†…å­˜ç”¨æ¥å­˜æ”¾newåˆ›å»ºçš„å¯¹è±¡å’Œæ•°ç»„ã€‚<br>å †å†…å­˜ä¸­æ‰€æœ‰çš„å®ä½“éƒ½æœ‰å†…å­˜åœ°å€å€¼ã€‚<br>å †å†…å­˜ä¸­çš„å®ä½“æ˜¯ç”¨æ¥å°è£…æ•°æ®çš„ï¼Œè¿™äº›æ•°æ®éƒ½æœ‰é»˜è®¤åˆå§‹åŒ–å€¼ã€‚<br>å †å†…å­˜ä¸­çš„å®ä½“ä¸å†è¢«æŒ‡å‘æ—¶ï¼ŒJVMå¯åŠ¨åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œè‡ªåŠ¨æ¸…é™¤ï¼Œè¿™ä¹Ÿæ˜¯JAVAä¼˜äºC++çš„è¡¨ç°ä¹‹ä¸€ï¼ˆC++ä¸­éœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨æ¸…é™¤ï¼‰</p>
<h3 id="âœ…String-str-â€œabcâ€çš„å†…éƒ¨å·¥ä½œ"><a href="#âœ…String-str-â€œabcâ€çš„å†…éƒ¨å·¥ä½œ" class="headerlink" title="âœ…String str = â€œabcâ€çš„å†…éƒ¨å·¥ä½œ"></a>âœ…String str = â€œabcâ€çš„å†…éƒ¨å·¥ä½œ</h3><p>(1)å…ˆå®šä¹‰ä¸€ä¸ªåä¸ºstrçš„å¯¹Stringç±»çš„å¯¹è±¡å¼•ç”¨å˜é‡ï¼šString strï¼›</p>
<p>(2)åœ¨æ ˆä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰å­˜æ”¾å€¼ä¸ºâ€abcâ€çš„åœ°å€ï¼ˆå¼•ç”¨ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åœ¨æ ˆä¸­å¼€è¾Ÿä¸€ä¸ªå­˜æ”¾å­—é¢å€¼ä¸ºâ€abcâ€çš„åœ°å€ï¼Œæ¥ç€åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„Stringç±»çš„å¯¹è±¡â€œabcâ€ï¼Œå¹¶å°†è¯¥å­—ç¬¦ä¸²æŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œè€Œä¸”åœ¨æ ˆä¸­è¿™ä¸ªåœ°å€æ—è¾¹è®°ä¸‹è¿™ä¸ªå¼•ç”¨çš„å¯¹è±¡â€œabcâ€ã€‚å¦‚æœå·²ç»æœ‰äº†å€¼ä¸ºâ€abcâ€çš„åœ°å€ï¼Œåˆ™æŸ¥æ‰¾å¯¹è±¡â€œabcâ€ï¼Œå¹¶è¿”å›â€œabcâ€çš„åœ°å€ã€‚</p>
<p>(3)å°†stræŒ‡å‘å¯¹è±¡â€œabcâ€çš„åœ°å€ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬Stringç±»ä¸­å­—ç¬¦ä¸²å€¼éƒ½æ˜¯ç›´æ¥å­˜å€¼çš„ã€‚ä½†åƒString str = â€œabcâ€ï¼›è¿™ç§åœºåˆä¸‹ï¼Œå…¶å­—ç¬¦ä¸²å€¼å´æ˜¯ä¿å­˜äº†ä¸€ä¸ªæŒ‡å‘å­˜åœ¨æ ˆä¸­æ•°æ®çš„å¼•ç”¨ï¼<br><strong>ï¼ˆæœ‰ç‚¹é—®é¢˜ï¼ŒæŒ‡å‘çš„æ˜¯å †ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„å­—ç¬¦ä¸²å§ï¼Ÿï¼Ÿï¼‰</strong></p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str1 = â€œabcâ€;  </span><br><span class="line">String str2 = â€œabcâ€;  </span><br><span class="line">System.out.println(str1==str2); //true</span><br></pre></td></tr></table></figure>

<p>str1.equals(str2)ï¼›çš„æ–¹å¼æ˜¯å°†æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å€¼æ˜¯å¦ç›¸ç­‰ã€‚==å·ï¼Œæ ¹æ®JDKçš„è¯´æ˜ï¼Œåªæœ‰åœ¨ä¸¤ä¸ªå¼•ç”¨éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå¯¹è±¡æ—¶æ‰è¿”å›çœŸå€¼ã€‚è€Œæˆ‘ä»¬åœ¨è¿™é‡Œè¦çœ‹çš„æ˜¯ï¼Œstr1ä¸str2æ˜¯å¦éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªå¯¹è±¡ã€‚<br>ç»“æœè¯´æ˜ï¼ŒJVMåˆ›å»ºäº†ä¸¤ä¸ªå¼•ç”¨str1å’Œstr2ï¼Œä½†åªåˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸”ä¸¤ä¸ªå¼•ç”¨éƒ½æŒ‡å‘äº†è¿™ä¸ªå¯¹è±¡ã€‚å®ç°å †ä¸­æ•°æ®çš„å…±äº«ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String str1 = â€œabcâ€;  </span><br><span class="line">String str2 = â€œabcâ€;  //æ²¡åˆ›å»ºæ–°å¯¹è±¡ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°å¼•ç”¨å˜é‡</span><br><span class="line">str1 = â€œbcdâ€;   //æ”¹å˜å€¼ï¼Œåªèƒ½åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå¼•ç”¨å˜é‡æŒ‡å‘æ–°çš„å¯¹è±¡</span><br><span class="line">System.out.println(str1 + â€œ,â€ + str2); //bcd, abc  </span><br><span class="line">System.out.println(str1==str2); //false</span><br></pre></td></tr></table></figure>

<p>èµ‹å€¼çš„å˜åŒ–å¯¼è‡´äº†ç±»å¯¹è±¡å¼•ç”¨çš„å˜åŒ–ï¼Œstr1æŒ‡å‘äº†å¦å¤–ä¸€ä¸ªæ–°å¯¹è±¡ï¼è€Œstr2ä»æ—§æŒ‡å‘åŸæ¥çš„å¯¹è±¡ã€‚ä¸Šä¾‹ä¸­ï¼Œå½“æˆ‘ä»¬å°†str1çš„å€¼æ”¹ä¸ºâ€bcdâ€æ—¶ï¼ŒJVMå‘ç°åœ¨æ ˆä¸­æ²¡æœ‰å­˜æ”¾è¯¥å€¼çš„åœ°å€ï¼Œä¾¿å¼€è¾Ÿäº†è¿™ä¸ªåœ°å€ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå…¶å­—ç¬¦ä¸²çš„å€¼æŒ‡å‘è¿™ä¸ªåœ°å€ã€‚</p>
<p>ğŸ’¡åŸå› ï¼šäº‹å®ä¸Šï¼ŒStringç±»è¢«è®¾è®¡æˆä¸ºä¸å¯æ”¹å˜(immutable)çš„ç±»ã€‚å¦‚æœä½ è¦æ”¹å˜å…¶å€¼ï¼Œå¯ä»¥ï¼Œä½†JVMåœ¨è¿è¡Œæ—¶æ ¹æ®æ–°å€¼æ‚„æ‚„åˆ›å»ºäº†ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œç„¶åå°†è¿™ä¸ªå¯¹è±¡çš„åœ°å€è¿”å›ç»™åŸæ¥ç±»çš„å¼•ç”¨ã€‚è¿™ä¸ªåˆ›å»ºè¿‡ç¨‹è™½è¯´æ˜¯å®Œå…¨è‡ªåŠ¨è¿›è¡Œçš„ï¼Œä½†å®ƒæ¯•ç«Ÿå ç”¨äº†æ›´å¤šçš„æ—¶é—´ã€‚åœ¨å¯¹æ—¶é—´è¦æ±‚æ¯”è¾ƒæ•æ„Ÿçš„ç¯å¢ƒä¸­ï¼Œä¼šå¸¦æœ‰ä¸€å®šçš„ä¸è‰¯å½±å“ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str1 = new String(â€œabcâ€);</span><br><span class="line">String str2 = â€œabcâ€;</span><br><span class="line">System.out.println(str1==str2); //false</span><br></pre></td></tr></table></figure>

<p>ğŸ’¡åŸå› ï¼šåªè¦æ˜¯ç”¨new()æ¥æ–°å»ºå¯¹è±¡çš„ï¼Œéƒ½ä¼šåœ¨å †ä¸­åˆ›å»ºï¼Œè€Œä¸”å…¶å­—ç¬¦ä¸²æ˜¯å•ç‹¬å­˜å€¼çš„ï¼Œå³ä½¿ä¸æ ˆä¸­çš„æ•°æ®ç›¸åŒï¼Œä¹Ÿä¸ä¼šä¸æ ˆä¸­çš„æ•°æ®å…±äº«ã€‚<br><strong>ï¼ˆä¸å­—ç¬¦ä¸²å¸¸é‡æ± å…±äº«å§ï¼Ÿï¼‰</strong></p>
<p><strong>æ„æ€æ˜¯ï¼šString str = â€œabcâ€ çš„åˆ›å»ºå¯¹è±¡æ–¹å¼ï¼Œä¼šåœ¨æ ˆä¸­ä¿å­˜â€œabcâ€ã€‚ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å§ï¼Ÿï¼‰å¦‚æœå¤šæ¬¡è¿™æ ·åˆ›å»ºä¸€ä¸ªå€¼çš„Stringå¯¹è±¡ï¼Œä¼šå…ˆå»æ ˆé‡Œçœ‹æœ‰æ²¡æœ‰ï¼Œå¦‚æœæœ‰ï¼Œå †é‡Œå°±ä¸æ–°å»ºå¯¹è±¡äº†ï¼Œæ ˆé‡Œæ–°å»ºä¸€ä¸ªå¼•ç”¨å˜é‡æŒ‡å‘é‚£ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å°±æ–°å»ºï¼Œä½†æ˜¯newæ–¹å¼ä¸ä¼šçœ‹ï¼Œéƒ½æ˜¯æ–°å»ºã€‚</strong></p>
<p>ç»“è®ºï¼š</p>
<p>(1)æˆ‘ä»¬åœ¨ä½¿ç”¨è¯¸å¦‚String str = â€œabcâ€; çš„æ ¼å¼å®šä¹‰ç±»æ—¶ï¼Œæ€»æ˜¯æƒ³å½“ç„¶åœ°è®¤ä¸ºï¼Œæˆ‘ä»¬åˆ›å»ºäº†Stringç±»çš„å¯¹è±¡strã€‚æ‹…å¿ƒé™·é˜±ï¼å¯¹è±¡å¯èƒ½å¹¶æ²¡æœ‰è¢«åˆ›å»ºï¼å”¯ä¸€å¯ä»¥è‚¯å®šçš„æ˜¯ï¼ŒæŒ‡å‘Stringç±»çš„å¼•ç”¨è¢«åˆ›å»ºäº†ã€‚è‡³äºè¿™ä¸ªå¼•ç”¨åˆ°åº•æ˜¯å¦æŒ‡å‘äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡æ¥è€ƒè™‘ï¼Œé™¤éä½ é€šè¿‡new()æ–¹æ³•æ¥æ˜¾è¦åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œæ›´ä¸ºå‡†ç¡®çš„è¯´æ³•æ˜¯ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘Stringç±»çš„å¯¹è±¡çš„å¼•ç”¨å˜é‡strï¼Œè¿™ä¸ªå¯¹è±¡å¼•ç”¨å˜é‡æŒ‡å‘äº†æŸä¸ªå€¼ä¸ºâ€abcâ€çš„Stringå¯¹è±¡ã€‚</p>
<p>(2)ä½¿ç”¨String str = â€œabcâ€; çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ï¼Œå› ä¸ºJVMä¼šè‡ªåŠ¨æ ¹æ®æ ˆä¸­æ•°æ®çš„å®é™…æƒ…å†µæ¥å†³å®šæ˜¯å¦æœ‰å¿…è¦åˆ›å»ºæ–°å¯¹è±¡ã€‚è€Œå¯¹äºString str = new String(â€œabcâ€); çš„ä»£ç ï¼Œåˆ™ä¸€æ¦‚åœ¨å †ä¸­åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œä¸ç®¡å…¶å­—ç¬¦ä¸²å€¼æ˜¯å¦ç›¸ç­‰ï¼Œæ˜¯å¦æœ‰å¿…è¦åˆ›å»ºæ–°å¯¹è±¡ï¼Œä»è€ŒåŠ é‡äº†ç¨‹åºçš„è´Ÿæ‹…ã€‚è¿™ä¸ªæ€æƒ³åº”è¯¥æ˜¯äº«å…ƒæ¨¡å¼çš„æ€æƒ³ï¼Œä½†JDKçš„å†…éƒ¨åœ¨è¿™é‡Œå®ç°æ˜¯å¦åº”ç”¨äº†è¿™ä¸ªæ¨¡å¼ï¼Œä¸å¾—è€ŒçŸ¥ã€‚</p>
<p>(3)å½“æ¯”è¾ƒåŒ…è£…ç±»é‡Œé¢çš„æ•°å€¼æ˜¯å¦ç›¸ç­‰æ—¶ï¼Œç”¨equals()æ–¹æ³•ï¼›å½“æµ‹è¯•ä¸¤ä¸ªåŒ…è£…ç±»çš„å¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œç”¨==ã€‚</p>
<p>(4)ç”±äºStringç±»çš„ä¸å¯æ”¹å˜immutableæ€§è´¨ï¼Œå½“Stringå˜é‡éœ€è¦ç»å¸¸å˜æ¢å…¶å€¼æ—¶ï¼Œåº”è¯¥è€ƒè™‘ä½¿ç”¨StringBufferç±»ï¼Œä»¥æé«˜ç¨‹åºæ•ˆç‡ã€‚</p>
<p>å‚è€ƒï¼š<br>ç¨‹åºä¸­å †æ ˆç©ºé—´åŠ è½½è¿‡ç¨‹ï¼š<a target="_blank" rel="noopener" href="https://www.jb51.net/article/229958.htm">https://www.jb51.net/article/229958.htm</a><br>å †æ ˆåŒºåˆ«ã€Stringåˆ›å»ºè¿‡ç¨‹ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/529280783">https://zhuanlan.zhihu.com/p/529280783</a></p>
<h3 id="Stringä¸å¯å˜æ€ä¹ˆç†è§£"><a href="#Stringä¸å¯å˜æ€ä¹ˆç†è§£" class="headerlink" title="Stringä¸å¯å˜æ€ä¹ˆç†è§£"></a>Stringä¸å¯å˜æ€ä¹ˆç†è§£</h3><p>çœ‹äº†ä¸€åœˆä¼˜ç‚¹æ¨¡ç³Šï¼Œä¸»è¦å‡ ä¸ªç–‘é—®ï¼š<br>1ã€<code>String s = &quot;abc&quot;;</code>ï¼Œåˆ°åº•æ€ä¹ˆä¸ªæµç¨‹ï¼Œå·²æœ‰çš„å­—ç¬¦ä¸²æ€ä¹ˆæ‰¾åˆ°çš„ã€‚<br>2ã€å­—ç¬¦ä¸²å¸¸é‡æ± åœ¨å“ªé‡Œå­˜çš„ã€‚åˆæ­¥ç»“è®ºæ˜¯java8åœ¨å †ä¸­ã€‚<br>3ã€è¿è¡Œæ—¶å¸¸é‡æ± å’Œå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Ÿ</p>
<p><strong>çœ‹çœ‹jvmè™šæ‹Ÿæœºå†è§£æƒ‘å§</strong></p>
<p>stringç±»ä¸ºä»€ä¹ˆæ˜¯ä¸å¯å˜çš„ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/liuqinhou/article/details/126160186">https://blog.csdn.net/liuqinhou/article/details/126160186</a></p>
<p>Stringæºç è§’åº¦åˆ†æä¸ºä»€ä¹ˆä¸å¯å˜ï¼Œé€šè¿‡åå°„çš„æ–¹æ³•æ”¹å˜ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhangjg_blog/article/details/18319521">https://blog.csdn.net/zhangjg_blog/article/details/18319521</a></p>
<p>æµ…è°ˆä¸ºä»€ä¹ˆJavaé‡Œé¢Stringç±»æ˜¯ä¸å¯å˜çš„ï¼š<br><a target="_blank" rel="noopener" href="https://www.jb51.net/article/157814.htm">https://www.jb51.net/article/157814.htm</a></p>
<p>Stringæ˜¯å¦‚ä½•å®ç°å…¶å¯¹è±¡ä¸å¯å˜ï¼š<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/498718374">https://zhuanlan.zhihu.com/p/498718374</a></p>
<p>Java å¸¸é‡æ± è¯¦è§£ï¼ˆä¸€ï¼‰å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Prior_SX/article/details/123463430">https://blog.csdn.net/Prior_SX/article/details/123463430</a></p>
<p>å­—ç¬¦ä¸²å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯åœ¨å †è¿˜æ˜¯åœ¨æ–¹æ³•åŒºï¼Ÿ<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cosmos-wong/p/12925299.html">https://www.cnblogs.com/cosmos-wong/p/12925299.html</a></p>
<p>Java8ä¸­å­—ç¬¦ä¸²å¸¸é‡æ± åˆ°åº•æ˜¯åœ¨å“ªé‡Œï¼š<br><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_14234228/2489846">https://blog.51cto.com/u_14234228/2489846</a></p>
<h3 id="âœ…å †å†…å­˜å…±äº«æ€§é—®é¢˜"><a href="#âœ…å †å†…å­˜å…±äº«æ€§é—®é¢˜" class="headerlink" title="âœ…å †å†…å­˜å…±äº«æ€§é—®é¢˜"></a>âœ…å †å†…å­˜å…±äº«æ€§é—®é¢˜</h3><p>é—®é¢˜æ¥æºï¼šæ—¢ç„¶å„ä¸ªjavaè¿›ç¨‹å…±äº«å †å†…å­˜ï¼Œé‚£ä¹ˆçœ‹fullgcçš„æƒ…å†µè·Ÿå“ªä¸ªè¿›ç¨‹çº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p>
<p>æ²¡é”™ï¼Œå †æ˜¯å…¨å±€å…±äº«çš„ï¼Œä½†æ˜¯ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜</p>
<p>å°±æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨å †ä¸ŠåŒæ—¶ç”³è¯·ç©ºé—´ï¼Œå¦‚æœåœ¨å¹¶å‘çš„åœºæ™¯ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹å…ˆåæŠŠå¯¹è±¡å¼•ç”¨æŒ‡å‘äº†åŒä¸€ä¸ªå †çš„å†…å­˜åŒºåŸŸï¼Œé‚£å¯èƒ½å°±ä¼šå‡ºç°é—®é¢˜ï¼›ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œå°±å¾—è¿›è¡ŒåŒæ­¥æ§åˆ¶ï¼Œè¯´åˆ°åŒæ­¥æ§åˆ¶ï¼Œå°±ä¼šå½±å“åˆ°æ•ˆç‡ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªå¹¶å‘é—®é¢˜ï¼Œå¯¹è±¡çš„å†…å­˜åˆ†é…è¿‡ç¨‹å°±å¿…é¡»è¿›è¡ŒåŒæ­¥æ§åˆ¶ã€‚<br>HotSpotè™šæ‹Ÿæœºï¼ˆHotSpotè™šæ‹Ÿæœºæ˜¯ç›®å‰æœ€æµè¡Œçš„è™šæ‹Ÿæœºï¼‰çš„æ–¹æ¡ˆï¼š<br>æ¯ä¸ªçº¿ç¨‹åœ¨Javaå †ä¸­é¢„å…ˆåˆ†é…ä¸€å°å—å†…å­˜ï¼Œç„¶ååœ¨ç»™å¯¹è±¡åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œç›´æ¥åœ¨è‡ªå·±è¿™å—â€ç§æœ‰â€å†…å­˜ä¸­åˆ†é…ï¼Œå½“è¿™éƒ¨åˆ†åŒºåŸŸç”¨å®Œä¹‹åï¼Œå†åˆ†é…æ–°çš„â€ç§æœ‰â€å†…å­˜ã€‚<br>è¿™ç§æ–¹æ¡ˆè¢«ç§°ä¹‹ä¸ºTLABåˆ†é…ï¼Œå³Thread Local Allocation Bufferã€‚è¿™éƒ¨åˆ†Bufferæ˜¯ä»å †ä¸­åˆ’åˆ†å‡ºæ¥çš„ï¼Œä½†æ˜¯æ˜¯æœ¬åœ°çº¿ç¨‹ç‹¬äº«çš„ã€‚</p>
<p><strong>TLAB</strong></p>
<p>TLABæ˜¯è™šæ‹Ÿæœºåœ¨å †å†…å­˜çš„edenåˆ’åˆ†å‡ºæ¥çš„ä¸€å—ä¸“ç”¨ç©ºé—´ï¼Œæ˜¯<strong>çº¿ç¨‹ä¸“å±</strong>çš„ã€‚åœ¨è™šæ‹Ÿæœºçš„TLABåŠŸèƒ½å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œåœ¨çº¿ç¨‹åˆå§‹åŒ–æ—¶ï¼Œè™šæ‹Ÿæœºä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å—TLABç©ºé—´ï¼Œ<strong>åªç»™å½“å‰çº¿ç¨‹ä½¿ç”¨</strong>ï¼Œè¿™æ ·<strong>æ¯ä¸ªçº¿ç¨‹éƒ½å•ç‹¬æ‹¥æœ‰ä¸€ä¸ªç©ºé—´</strong>ï¼Œå¦‚æœéœ€è¦åˆ†é…å†…å­˜ï¼Œå°±åœ¨è‡ªå·±çš„ç©ºé—´ä¸Šåˆ†é…ï¼Œè¿™æ ·å°±ä¸å­˜åœ¨ç«äº‰çš„æƒ…å†µï¼Œå¯ä»¥å¤§å¤§æå‡åˆ†é…æ•ˆç‡ã€‚</p>
<p><strong>æ‰€ä»¥è¯´ï¼Œå› ä¸ºæœ‰äº†TLABæŠ€æœ¯ï¼Œå †å†…å­˜å¹¶ä¸æ˜¯å®Œå®Œå…¨å…¨çš„çº¿ç¨‹å…±äº«ï¼Œå…¶edenåŒºåŸŸä¸­è¿˜æ˜¯æœ‰ä¸€éƒ¨åˆ†ç©ºé—´æ˜¯åˆ†é…ç»™çº¿ç¨‹ç‹¬äº«çš„ã€‚</strong></p>
<p>âš ï¸TLABæ˜¯çº¿ç¨‹ç‹¬äº«çš„ï¼Œä½†æ˜¯åªæ˜¯åœ¨â€œåˆ†é…â€è¿™ä¸ªåŠ¨ä½œä¸Šæ˜¯çº¿ç¨‹ç‹¬äº«çš„ï¼Œè‡³äºåœ¨è¯»å–ã€åƒåœ¾å›æ”¶ç­‰åŠ¨ä½œä¸Šéƒ½æ˜¯çº¿ç¨‹å…±äº«çš„ã€‚è€Œä¸”åœ¨ä½¿ç”¨ä¸Šä¹Ÿæ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶æ¯ä¸ªçº¿ç¨‹åœ¨åˆå§‹åŒ–æ—¶éƒ½ä¼šå»å †å†…å­˜ä¸­ç”³è¯·ä¸€å—TLABï¼Œå¹¶ä¸æ˜¯è¯´è¿™ä¸ªTLABåŒºåŸŸçš„å†…å­˜å…¶ä»–çº¿ç¨‹å°±å®Œå…¨æ— æ³•è®¿é—®äº†ï¼Œå…¶ä»–çº¿ç¨‹çš„è¯»å–è¿˜æ˜¯å¯ä»¥çš„ï¼Œåªä¸è¿‡æ— æ³•åœ¨è¿™ä¸ªåŒºåŸŸä¸­åˆ†é…å†…å­˜è€Œå·²ã€‚å¹¶ä¸”ï¼Œåœ¨TLABåˆ†é…ä¹‹åï¼Œå¹¶ä¸å½±å“å¯¹è±¡çš„ç§»åŠ¨å’Œå›æ”¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶å¯¹è±¡åˆšå¼€å§‹å¯èƒ½é€šè¿‡TLABåˆ†é…å†…å­˜ï¼Œå­˜æ”¾åœ¨EdenåŒºï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šè¢«åƒåœ¾å›æ”¶æˆ–è€…è¢«ç§»åˆ°Survivor Spaceã€Old Genç­‰ã€‚</p>
<p>âš ï¸TLABå¸¦æ¥çš„é—®é¢˜ï¼š<br>TLABæ˜¯åœ¨edenåŒºåˆ†é…çš„ï¼Œå› ä¸ºedenåŒºåŸŸæœ¬èº«å°±ä¸å¤ªå¤§ï¼Œè€Œä¸”TLABç©ºé—´çš„å†…å­˜ä¹Ÿéå¸¸å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1%ã€‚æ‰€ä»¥ï¼Œå¿…ç„¶å­˜åœ¨ä¸€äº›å¤§å¯¹è±¡æ˜¯æ— æ³•åœ¨TLABç›´æ¥åˆ†é…ã€‚<br>é‡åˆ°TLABä¸­æ— æ³•åˆ†é…çš„å¤§å¯¹è±¡ï¼Œå¯¹è±¡è¿˜æ˜¯å¯èƒ½åœ¨edenåŒºæˆ–è€…è€å¹´ä»£ç­‰è¿›è¡Œåˆ†é…çš„ï¼Œä½†æ˜¯è¿™ç§åˆ†é…å°±éœ€è¦è¿›è¡ŒåŒæ­¥æ§åˆ¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç»å¸¸è¯´ï¼šå°çš„å¯¹è±¡æ¯”å¤§çš„å¯¹è±¡åˆ†é…èµ·æ¥æ›´åŠ é«˜æ•ˆã€‚<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªæ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜ï¼Œè™šæ‹Ÿæœºå®šä¹‰äº†ä¸€ä¸ªrefill_wasteçš„å€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥ç¿»è¯‘ä¸ºâ€œæœ€å¤§æµªè´¹ç©ºé—´â€ã€‚</p>
<p>å½“è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§äºrefill_wasteçš„æ—¶å€™ï¼Œä¼šé€‰æ‹©åœ¨å †å†…å­˜ä¸­åˆ†é…ã€‚è‹¥å°äºrefill_wasteå€¼ï¼Œåˆ™ä¼šåºŸå¼ƒå½“å‰TLABï¼Œé‡æ–°åˆ›å»ºTLABè¿›è¡Œå¯¹è±¡å†…å­˜åˆ†é…ã€‚</p>
<p>æ€»ç»“ï¼š<br>ä¸ºäº†ä¿è¯å¯¹è±¡çš„å†…å­˜åˆ†é…è¿‡ç¨‹ä¸­çš„çº¿ç¨‹å®‰å…¨æ€§ï¼ŒHotSpotè™šæ‹Ÿæœºæä¾›äº†ä¸€ç§å«åšTLAB(Thread Local Allocation Buffer)çš„æŠ€æœ¯ã€‚</p>
<p>åœ¨çº¿ç¨‹åˆå§‹åŒ–æ—¶ï¼Œè™šæ‹Ÿæœºä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å—TLABç©ºé—´ï¼Œåªç»™å½“å‰çº¿ç¨‹ä½¿ç”¨ï¼Œå½“éœ€è¦åˆ†é…å†…å­˜æ—¶ï¼Œå°±åœ¨è‡ªå·±çš„ç©ºé—´ä¸Šåˆ†é…ï¼Œè¿™æ ·å°±ä¸å­˜åœ¨ç«äº‰çš„æƒ…å†µï¼Œå¯ä»¥å¤§å¤§æå‡åˆ†é…æ•ˆç‡ã€‚</p>
<p>æ‰€ä»¥ï¼Œâ€œå †æ˜¯çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸâ€è¿™å¥è¯å¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œå› ä¸ºTLABæ˜¯å †å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œä»–åœ¨è¯»å–ä¸Šç¡®å®æ˜¯çº¿ç¨‹å…±äº«çš„ï¼Œä½†æ˜¯åœ¨å†…å­˜åˆ†é…ä¸Šï¼Œæ˜¯çº¿ç¨‹ç‹¬äº«çš„ã€‚</p>
<p>TLABçš„ç©ºé—´å…¶å®å¹¶ä¸å¤§ï¼Œæ‰€ä»¥å¤§å¯¹è±¡è¿˜æ˜¯å¯èƒ½éœ€è¦åœ¨å †å†…å­˜ä¸­ç›´æ¥åˆ†é…ã€‚é‚£ä¹ˆï¼Œå¯¹è±¡çš„å†…å­˜åˆ†é…æ­¥éª¤å°±æ˜¯å…ˆå°è¯•TLABåˆ†é…ï¼Œç©ºé—´ä¸è¶³ä¹‹åï¼Œå†åˆ¤æ–­æ˜¯å¦åº”è¯¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œç„¶åå†ç¡®å®šæ˜¯å†edenåˆ†é…è¿˜æ˜¯åœ¨è€å¹´ä»£åˆ†é…ã€‚<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”<br>åŸæ–‡é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/jiey0407/article/details/125190629">https://blog.csdn.net/jiey0407/article/details/125190629</a></p>
<h2 id="jvmæ€§èƒ½ç›‘æ§å·¥å…·"><a href="#jvmæ€§èƒ½ç›‘æ§å·¥å…·" class="headerlink" title="jvmæ€§èƒ½ç›‘æ§å·¥å…·"></a>jvmæ€§èƒ½ç›‘æ§å·¥å…·</h2><h3 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h3><p>java virtual machine process status tool<br>jps ä¸»è¦ç”¨æ¥è¾“å‡º JVM ä¸­è¿è¡Œçš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯</p>
<p>è¯­æ³•æ ¼å¼ï¼š<code>jps [options] [hostid]</code><br>å¦‚æœä¸æŒ‡å®š hostid å°±é»˜è®¤ä¸ºå½“å‰ä¸»æœºæˆ–æœåŠ¡å™¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-q ä¸è¾“å‡ºç±»åã€Jaråå’Œä¼ å…¥mainæ–¹æ³•çš„å‚æ•°</span><br><span class="line">-m è¾“å‡ºä¼ å…¥mainæ–¹æ³•çš„å‚æ•°</span><br><span class="line">-l è¾“å‡ºmainç±»æˆ–Jarçš„å…¨é™å</span><br><span class="line">-v è¾“å‡ºä¼ å…¥JVMçš„å‚æ•°</span><br></pre></td></tr></table></figure>

<p>jpså‘½ä»¤è·å–å®é™…çš„è¿›ç¨‹idï¼Œæ˜¯å»ç”¨æˆ·çš„ä¸´æ—¶ç›®å½•ä¸‹å»æ‹¿è¿›ç¨‹idçš„ã€‚<br>æ–‡ä»¶è·¯å¾„ï¼š/tmp/hsperfdata_{userName}/ï¼Œå­˜å‚¨äº†å½“å‰ç”¨æˆ·çš„è¿›ç¨‹ä¿¡æ¯ã€‚</p>
<h3 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h3><p>stack trace for java æ˜¾ç¤ºè™šæ‹Ÿæœºçš„çº¿ç¨‹å¿«ç…§ã€‚<br>jstack ä¸»è¦ç”¨æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹å†…çš„çº¿ç¨‹å †æ ˆä¿¡æ¯ã€‚</p>
<p>è¯­æ³•æ ¼å¼ï¼š<code>jstack [option] pid</code><br>å¦‚æœæ˜¯åœ¨64ä½æœºå™¨ä¸Šï¼Œéœ€è¦æŒ‡å®šé€‰é¡¹â€-J-d64â€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-l long listingsï¼Œä¼šæ‰“å°å‡ºé¢å¤–çš„é”ä¿¡æ¯ï¼Œåœ¨å‘ç”Ÿæ­»é”æ—¶å¯ä»¥ç”¨jstack -l pidæ¥è§‚å¯Ÿé”æŒæœ‰æƒ…å†µ</span><br><span class="line">-m mixed modeï¼Œä¸ä»…ä¼šè¾“å‡ºJavaå †æ ˆä¿¡æ¯ï¼Œè¿˜ä¼šè¾“å‡ºC/C++å †æ ˆä¿¡æ¯ï¼ˆæ¯”å¦‚Nativeæ–¹æ³•ï¼‰</span><br></pre></td></tr></table></figure>

<p>jstack å¯ä»¥å®šä½åˆ°çº¿ç¨‹å †æ ˆï¼Œæ ¹æ®å †æ ˆä¿¡æ¯æˆ‘ä»¬å¯ä»¥å®šä½åˆ°å…·ä½“ä»£ç ï¼Œæ‰€ä»¥å®ƒåœ¨ JVM æ€§èƒ½è°ƒä¼˜ä¸­ä½¿ç”¨å¾—éå¸¸å¤šã€‚ä¾‹å¦‚ï¼šæ‰¾å‡ºæŸä¸ª Java è¿›ç¨‹ä¸­æœ€è€—è´¹ CPU çš„ Java çº¿ç¨‹å¹¶å®šä½å †æ ˆä¿¡æ¯ã€‚</p>
<p>ç¬¬ä¸€æ­¥å…ˆæ‰¾å‡º Java è¿›ç¨‹ ID<br><code>ps -ef | grep åº”ç”¨ | grep -v grep</code></p>
<p>ç¬¬äºŒæ­¥æ‰¾å‡ºè¯¥è¿›ç¨‹å†…æœ€è€—è´¹ CPU çš„çº¿ç¨‹<br>å¯ä»¥ä½¿ç”¨ <code>ps -Lfp pid </code>æˆ–è€… <code>ps -mp pid -o THREAD, tid, time</code> æˆ–è€… <code>top -Hp pid</code> .ã€æœ‰æ²¡æœ‰å¯ä»¥è¾“å‡ºæŒ‰æ—¶é—´æ’åºçš„ï¼Œä¸”åŒºåˆ†daemonçš„ã€‘</p>
<p>ä½¿ç”¨<code>printf &quot;%x\n&quot; çº¿ç¨‹id</code> å°†çº¿ç¨‹idè½¬æ¢ä¸º16è¿›åˆ¶å€¼ã€‚</p>
<p><code>jstack è¿›ç¨‹id | grep 16è¿›åˆ¶çº¿ç¨‹id</code><br>ä»è€Œå®šä½ä»£ç ï¼Œå¯èƒ½æ˜¯å“ªé‡Œwaitæ—¶é—´é•¿äº†ã€‚</p>
<p><code>jstack -l è¿›ç¨‹id æŸ¥çœ‹è¿›ç¨‹ä¸‹æ‰€æœ‰çº¿ç¨‹</code></p>
<hr>
<p>jstackæ‰“å°çš„ä¿¡æ¯æ€ä¹ˆçœ‹ï¼š<br>dump æ–‡ä»¶é‡Œï¼Œå€¼å¾—å…³æ³¨çš„çº¿ç¨‹çŠ¶æ€æœ‰ï¼š<br>æ­»é”ï¼ŒDeadlockï¼ˆé‡ç‚¹å…³æ³¨ï¼‰<br>æ‰§è¡Œä¸­ï¼ŒRunnable<br>ç­‰å¾…èµ„æºï¼ŒWaiting on conditionï¼ˆé‡ç‚¹å…³æ³¨ï¼‰<br>ç­‰å¾…è·å–ç›‘è§†å™¨ï¼ŒWaiting on monitor entryï¼ˆé‡ç‚¹å…³æ³¨ï¼‰<br>æš‚åœï¼ŒSuspended<br>å¯¹è±¡ç­‰å¾…ä¸­ï¼ŒObject.wait() æˆ– TIMED_WAITING<br>é˜»å¡ï¼ŒBlockedï¼ˆé‡ç‚¹å…³æ³¨ï¼‰<br>åœæ­¢ï¼ŒParked</p>
<hr>
<p><strong>å®ä¾‹ä¸€ï¼šWaiting to lock å’Œ Blocked</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;RMI TCP Connection(267865)-172.16.5.25&quot; daemon prio=10 tid=0x00007fd508371000 nid=0x55ae waiting for monitor entry [0x00007fd4f8684000]</span><br><span class="line">   java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line">at org.apache.log4j.Category.callAppenders(Category.java:201)</span><br><span class="line">- waiting to lock &lt;0x00000000acf4d0c0&gt; (a org.apache.log4j.Logger)</span><br><span class="line">at org.apache.log4j.Category.forcedLog(Category.java:388)</span><br><span class="line">at org.apache.log4j.Category.log(Category.java:853)</span><br><span class="line">at org.apache.commons.logging.impl.Log4JLogger.warn(Log4JLogger.java:234)</span><br><span class="line">at com.tuan.core.common.lang.cache.remote.SpyMemcachedClient.get(SpyMemcachedClient.java:110)</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š<br>1ï¼‰çº¿ç¨‹çŠ¶æ€æ˜¯ Blockedï¼Œé˜»å¡çŠ¶æ€ã€‚è¯´æ˜çº¿ç¨‹ç­‰å¾…èµ„æºè¶…æ—¶ï¼<br>2ï¼‰â€œ waiting to lock &lt;0x00000000acf4d0c0&gt;â€æŒ‡ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…ç»™è¿™ä¸ª 0x00000000acf4d0c0 åœ°å€ä¸Šé”ï¼ˆè‹±æ–‡å¯æè¿°ä¸ºï¼štrying to obtain  0x00000000acf4d0c0 lockï¼‰ã€‚<br>3ï¼‰åœ¨ dump æ—¥å¿—é‡ŒæŸ¥æ‰¾å­—ç¬¦ä¸² 0x00000000acf4d0c0ï¼Œå‘ç°æœ‰å¤§é‡çº¿ç¨‹éƒ½åœ¨ç­‰å¾…ç»™è¿™ä¸ªåœ°å€ä¸Šé”ã€‚å¦‚æœèƒ½åœ¨æ—¥å¿—é‡Œæ‰¾åˆ°è°è·å¾—äº†è¿™ä¸ªé”ï¼ˆå¦‚locked &lt; 0x00000000acf4d0c0 &gt;ï¼‰ï¼Œå°±å¯ä»¥é¡ºè—¤æ‘¸ç“œäº†ã€‚<br>4ï¼‰â€œwaiting for monitor entryâ€è¯´æ˜æ­¤çº¿ç¨‹é€šè¿‡ synchronized(obj) {â€¦â€¦} ç”³è¯·è¿›å…¥äº†ä¸´ç•ŒåŒºï¼Œä»è€Œè¿›å…¥äº†ä¸‹å›¾1ä¸­çš„â€œEntry Setâ€é˜Ÿåˆ—ï¼Œä½†è¯¥ obj å¯¹åº”çš„ monitor è¢«å…¶ä»–çº¿ç¨‹æ‹¥æœ‰ï¼Œæ‰€ä»¥æœ¬çº¿ç¨‹åœ¨ Entry Set é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚<br>5ï¼‰ç¬¬ä¸€è¡Œé‡Œï¼Œâ€RMI TCP Connection(267865)-172.16.5.25â€æ˜¯ Thread Name ã€‚tidæŒ‡Java Thread idã€‚nidæŒ‡nativeçº¿ç¨‹çš„idã€‚prioæ˜¯çº¿ç¨‹ä¼˜å…ˆçº§ã€‚[0x00007fd4f8684000]æ˜¯çº¿ç¨‹æ ˆèµ·å§‹åœ°å€ã€‚</p>
<hr>
<p><strong>å®ä¾‹äºŒï¼šWaiting on condition å’Œ TIMED_WAITING</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&quot;RMI TCP Connection(idle)&quot; daemon prio=10 tid=0x00007fd50834e800 nid=0x56b2 waiting on condition [0x00007fd4f1a59000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (parking)</span><br><span class="line">at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">- parking to wait for  &lt;0x00000000acd84de8&gt; (a java.util.concurrent.SynchronousQueue$TransferStack)</span><br><span class="line">at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:198)</span><br><span class="line">at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:424)</span><br><span class="line">at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:323)</span><br><span class="line">at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:874)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:945)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)</span><br><span class="line">at java.lang.Thread.run(Thread.java:662)</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<p>1ï¼‰â€œTIMED_WAITING (parking)â€ä¸­çš„ timed_waiting æŒ‡ç­‰å¾…çŠ¶æ€ï¼Œä½†è¿™é‡ŒæŒ‡å®šäº†æ—¶é—´ï¼Œåˆ°è¾¾æŒ‡å®šçš„æ—¶é—´åè‡ªåŠ¨é€€å‡ºç­‰å¾…çŠ¶æ€ï¼›parkingæŒ‡çº¿ç¨‹å¤„äºæŒ‚èµ·ä¸­ã€‚</p>
<p>2ï¼‰â€œwaiting on conditionâ€éœ€è¦ä¸å †æ ˆä¸­çš„â€œparking to wait for  &lt;0x00000000acd84de8&gt; (a java.util.concurrent.SynchronousQueue$TransferStack)â€ç»“åˆæ¥çœ‹ã€‚é¦–å…ˆï¼Œæœ¬çº¿ç¨‹è‚¯å®šæ˜¯åœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶çš„å‘ç”Ÿï¼Œæ¥æŠŠè‡ªå·±å”¤é†’ã€‚å…¶æ¬¡ï¼ŒSynchronousQueue å¹¶ä¸æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåªæ˜¯çº¿ç¨‹ä¹‹é—´ç§»äº¤ä¿¡æ¯çš„æœºåˆ¶ï¼Œå½“æˆ‘ä»¬æŠŠä¸€ä¸ªå…ƒç´ æ”¾å…¥åˆ° SynchronousQueue ä¸­æ—¶å¿…é¡»æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…æ¥å—ç§»äº¤çš„ä»»åŠ¡ï¼Œå› æ­¤è¿™å°±æ˜¯æœ¬çº¿ç¨‹åœ¨ç­‰å¾…çš„æ¡ä»¶ã€‚<br>3ï¼‰åˆ«çš„å°±çœ‹ä¸å‡ºæ¥äº†ã€‚</p>
<hr>
<p><strong>å®ä¾‹ä¸‰ï¼šin Obejct.wait() å’Œ TIMED_WAITING</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;RMI RenewClean-[172.16.5.19:28475]&quot; daemon prio=10 tid=0x0000000041428800 nid=0xb09 in Object.wait() [0x00007f34f4bd0000]</span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (on object monitor)</span><br><span class="line">at java.lang.Object.wait(Native Method)</span><br><span class="line">- waiting on &lt;0x00000000aa672478&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:118)</span><br><span class="line">- locked &lt;0x00000000aa672478&gt; (a java.lang.ref.ReferenceQueue$Lock)</span><br><span class="line">at sun.rmi.transport.DGCClient$EndpointEntry$RenewCleanThread.run(DGCClient.java:516)</span><br><span class="line">at java.lang.Thread.run(Thread.java:662)</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼š</p>
<p>1ï¼‰â€œTIMED_WAITING (on object monitor)â€ï¼Œå¯¹äºæœ¬ä¾‹è€Œè¨€ï¼Œæ˜¯å› ä¸ºæœ¬çº¿ç¨‹è°ƒç”¨äº† java.lang.Object.wait(long timeout) è€Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>2ï¼‰â€œWait Setâ€ä¸­ç­‰å¾…çš„çº¿ç¨‹çŠ¶æ€å°±æ˜¯â€œ in Object.wait() â€ã€‚å½“çº¿ç¨‹è·å¾—äº† Monitorï¼Œè¿›å…¥äº†ä¸´ç•ŒåŒºä¹‹åï¼Œå¦‚æœå‘ç°çº¿ç¨‹ç»§ç»­è¿è¡Œçš„æ¡ä»¶æ²¡æœ‰æ»¡è¶³ï¼Œå®ƒåˆ™è°ƒç”¨å¯¹è±¡ï¼ˆä¸€èˆ¬å°±æ˜¯è¢« synchronized çš„å¯¹è±¡ï¼‰çš„ wait() æ–¹æ³•ï¼Œæ”¾å¼ƒäº† Monitorï¼Œè¿›å…¥ â€œWait Setâ€é˜Ÿåˆ—ã€‚åªæœ‰å½“åˆ«çš„çº¿ç¨‹åœ¨è¯¥å¯¹è±¡ä¸Šè°ƒç”¨äº† notify() æˆ–è€… notifyAll() ï¼Œâ€œ Wait Setâ€é˜Ÿåˆ—ä¸­çº¿ç¨‹æ‰å¾—åˆ°æœºä¼šå»ç«äº‰ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—å¯¹è±¡çš„ Monitorï¼Œæ¢å¤åˆ°è¿è¡Œæ€ã€‚</p>
<p>3ï¼‰RMI RenewClean æ˜¯ DGCClient çš„ä¸€éƒ¨åˆ†ã€‚DGC æŒ‡çš„æ˜¯ Distributed GCï¼Œå³åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ã€‚</p>
<p>4ï¼‰è¯·æ³¨æ„ï¼Œæ˜¯å…ˆ locked &lt;0x00000000aa672478&gt;ï¼Œå waiting on &lt;0x00000000aa672478&gt;ï¼Œä¹‹æ‰€ä»¥å…ˆé”å†ç­‰åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¯·çœ‹ä¸‹é¢å®ƒçš„ä»£ç å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static private class  Lock &#123; &#125;;</span><br><span class="line">private Lock lock = new Lock();</span><br><span class="line">public Reference&lt;? extends T&gt; remove(long timeout)</span><br><span class="line">&#123;</span><br><span class="line">    synchronized (lock) &#123;</span><br><span class="line">        Reference&lt;? extends T&gt; r = reallyPoll();</span><br><span class="line">        if (r != null) return r;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            lock.wait(timeout);</span><br><span class="line">            r = reallyPoll();</span><br><span class="line">            â€¦â€¦</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å³ï¼Œçº¿ç¨‹çš„æ‰§è¡Œä¸­ï¼Œå…ˆç”¨ synchronized è·å¾—äº†è¿™ä¸ªå¯¹è±¡çš„ Monitorï¼ˆå¯¹åº”äº  locked &lt;0x00000000aa672478&gt; ï¼‰ï¼›å½“æ‰§è¡Œåˆ° lock.wait(timeout);ï¼Œçº¿ç¨‹å°±æ”¾å¼ƒäº† Monitor çš„æ‰€æœ‰æƒï¼Œè¿›å…¥â€œWait Setâ€é˜Ÿåˆ—ï¼ˆå¯¹åº”äº  waiting on &lt;0x00000000aa672478&gt; ï¼‰ã€‚<br>5ï¼‰ä»å †æ ˆä¿¡æ¯çœ‹ï¼Œæ˜¯æ­£åœ¨æ¸…ç† remote references to remote objects ï¼Œå¼•ç”¨çš„ç§Ÿçº¦åˆ°äº†ï¼Œåˆ†å¸ƒå¼åƒåœ¾å›æ”¶åœ¨é€ä¸€æ¸…ç†å‘¢ã€‚</p>
<p>è½¬è‡ªï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/nexiyi/p/java_thread_jstack.html">https://www.cnblogs.com/nexiyi/p/java_thread_jstack.html</a></p>
<h3 id="jmapå’Œjhat"><a href="#jmapå’Œjhat" class="headerlink" title="jmapå’Œjhat"></a>jmapå’Œjhat</h3><p>jmapï¼ˆMemory Mapï¼‰å’Œjhatï¼ˆJava Heap Analysis Toolï¼‰</p>
<p>jmapç”¨æ¥æŸ¥çœ‹<strong>å †å†…å­˜</strong>ä½¿ç”¨çŠ¶å†µï¼Œä¸€èˆ¬ç»“åˆjhatä½¿ç”¨ã€‚<br>jmapè¯­æ³•æ ¼å¼ï¼š<code>jmap [option] pid</code>  pidä¸ºè¿›ç¨‹id</p>
<p>æ‰“å°è¿›ç¨‹çš„ç±»åŠ è½½å™¨å’Œç±»åŠ è½½å™¨åŠ è½½çš„æŒä¹…ä»£å¯¹è±¡ä¿¡æ¯ï¼Œè¾“å‡ºï¼šç±»åŠ è½½å™¨åç§°ã€å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼ˆä¸å¯é ï¼‰ã€å¯¹è±¡åœ°å€ã€çˆ¶ç±»åŠ è½½å™¨ã€å·²åŠ è½½çš„ç±»å¤§å°ç­‰ä¿¡æ¯</p>
<p>ä½¿ç”¨<strong>jmap -heap pid</strong>æŸ¥çœ‹è¿›ç¨‹å †å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„GCç®—æ³•ã€å †é…ç½®å‚æ•°å’Œå„ä»£ä¸­å †å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p>
<p>ä½¿ç”¨<code>jmap -histo pid</code> / <code>jmap -histo:live pid</code>æŸ¥çœ‹å †å†…å­˜ä¸­çš„å¯¹è±¡æ•°ç›®ã€å¤§å°ç»Ÿè®¡ç›´æ–¹å›¾ï¼Œå¦‚æœå¸¦ä¸Šliveåˆ™åªç»Ÿè®¡æ´»å¯¹è±¡.<br>åŠ ä¸Š<code>| more</code> æŒ‰ç±»åˆ«ç»Ÿè®¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo:live 21711 | more </span><br><span class="line">num     #instances         #bytes  class name------------</span><br><span class="line">   1:         38445        5597736  &lt;constMethodKlass&gt;</span><br><span class="line">   2:         38445        5237288  &lt;methodKlass&gt;</span><br><span class="line"></span><br><span class="line">class nameæ˜¯å¯¹è±¡ç±»å‹</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„æƒ…å†µæ˜¯ï¼šç”¨jmapæŠŠè¿›ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µdumpåˆ°æ–‡ä»¶ä¸­ï¼Œå†ç”¨jhatåˆ†ææŸ¥çœ‹ã€‚jmapè¿›è¡Œdumpå‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š<code>jmap -dump:format=b,file=dumpFileName pid</code></p>
<p>ä¾‹å¦‚ï¼š<code>jmap -dump:format=b,file=/tmp/dump.dat è¿›ç¨‹id</code></p>
<p>dump.datæ–‡ä»¶å¾ˆå¤§ã€‚<br>dumpå‡ºæ¥çš„æ–‡ä»¶å¯ä»¥ç”¨MATã€VisualVMç­‰å·¥å…·æŸ¥çœ‹ï¼Œè¿™é‡Œç”¨jhatæŸ¥çœ‹ï¼š<code>jhat -port 9998 /tmp/dump.dat</code><br>ç„¶åå°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä¸»æœºåœ°å€ï¼š9998 æŸ¥çœ‹äº†ã€‚##### ###</p>
<h3 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h3><p>JVMç»Ÿè®¡ç›‘æµ‹å·¥å…·<br>jvm statistics monitoring toolï¼šç”¨äºæ”¶é›†è™šæ‹Ÿæœºå„æ–¹é¢çš„è¿è¡Œæ•°æ®ã€‚</p>
<p>è¯­æ³•æ ¼å¼ï¼š<code>jstat [ generalOption | outputOptions vmid [interval[s|ms] [count]] ]</code></p>
<p>vmidæ˜¯Javaè™šæ‹ŸæœºIDï¼Œåœ¨Linux/Unixç³»ç»Ÿä¸Šä¸€èˆ¬å°±æ˜¯è¿›ç¨‹IDã€‚intervalæ˜¯é‡‡æ ·æ—¶é—´é—´éš”ã€‚countæ˜¯é‡‡æ ·æ•°ç›®ã€‚ ä¾‹å¦‚ï¼š<code>jstat -gc è¿›ç¨‹id 250 4</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jstat -gc 21711 250 4 </span><br><span class="line">S0C    S1C    S0U    S1U      EC       EU        OC         OU       PC     PU    YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line">192.0  192.0   64.0   0.0    6144.0   1854.9   32000.0     4111.6   55296.0 25472.7    702    0.431   3      0.218    0.649</span><br><span class="line">192.0  192.0   64.0   0.0    6144.0   1972.2   32000.0     4111.6   55296.0 25472.7    702    0.431   3      0.218    0.649</span><br><span class="line"></span><br><span class="line">S0Cã€S1Cã€S0Uã€S1Uï¼šSurvivor 0/1åŒºå®¹é‡ï¼ˆCapacityï¼‰å’Œä½¿ç”¨é‡ï¼ˆUsedï¼‰</span><br><span class="line">è¿è¡Œä»¥æ¥ï¼Œæ€»è€—æ—¶ï¼Œå•ä½s</span><br><span class="line">ECã€EUï¼šEdenåŒºå®¹é‡å’Œä½¿ç”¨é‡</span><br><span class="line">OCã€OUï¼šå¹´è€ä»£å®¹é‡å’Œä½¿ç”¨é‡</span><br><span class="line">PCã€PUï¼šæ°¸ä¹…ä»£å®¹é‡å’Œä½¿ç”¨é‡</span><br><span class="line">YGCã€YGTï¼šå¹´è½»ä»£GCæ¬¡æ•°å’ŒGCè€—æ—¶</span><br><span class="line">FGCã€FGCTï¼šFull GCæ¬¡æ•°å’ŒFull GCè€—æ—¶</span><br><span class="line">GCTï¼šGCæ€»è€—æ—¶</span><br></pre></td></tr></table></figure>

<p>JVMå †å†…å­˜å¸ƒå±€ï¼š<br>å †å†…å­˜ = å¹´è½»ä»£ + å¹´è€ä»£ + æ°¸ä¹…ä»£<br>å¹´è½»ä»£ = EdenåŒº + ä¸¤ä¸ªSurvivoråŒºï¼ˆFromå’ŒToï¼‰</p>
<p><code>jstat -gcutil 23484 1000 5</code> ç›‘è§†å†…å®¹åŸºæœ¬ä¸gcç›¸åŒï¼Œä½†è¾“å‡ºçš„ä¸»è¦æ˜¯å·²å ç”¨çš„æ€»ç©ºé—´çš„ç™¾åˆ†æ¯”ã€‚</p>
<p><code>jstat -gccause 23484 1000 5</code> æŸ¥è¯¢gcçš„åŸå› ã€‚</p>
<h3 id="hprof"><a href="#hprof" class="headerlink" title="hprof"></a>hprof</h3><p>ï¼ˆHeap/CPU Profiling Toolï¼‰<br>hprofèƒ½å¤Ÿå±•ç°CPUä½¿ç”¨ç‡ï¼Œç»Ÿè®¡å †å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p>
<p>è¯­æ³•æ ¼å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java -agentlib:hprof[=options] ToBeProfiledClass</span><br><span class="line">java -Xrunprof[:options] ToBeProfiledClass</span><br><span class="line">javac -J-agentlib:hprof[=options] ToBeProfiledClass</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼š<code>java -agentlib:hprof=cpu=samples,interval=20,depth=3 ä¸»ç±»</code><br>æ¯éš”20æ¯«ç§’é‡‡æ ·CPUæ¶ˆè€—ä¿¡æ¯ï¼Œå †æ ˆæ·±åº¦ä¸º3ï¼Œç”Ÿæˆçš„profileæ–‡ä»¶åç§°æ˜¯java.hprof.txtï¼Œåœ¨å½“å‰ç›®å½•ã€‚</p>
<p>ä¾‹å¦‚ï¼š<code>javac -J-agentlib:hprof=cpu=times Hello.java</code><br>èƒ½å¤Ÿè·å¾—æ›´åŠ ç»†ç²’åº¦çš„CPUæ¶ˆè€—ä¿¡æ¯ï¼Œèƒ½å¤Ÿç»†åˆ°æ¯ä¸ªæ–¹æ³•è°ƒç”¨çš„å¼€å§‹å’Œç»“æŸï¼Œå®ƒçš„å®ç°ä½¿ç”¨äº†å­—èŠ‚ç æ³¨å…¥æŠ€æœ¯ï¼ˆBCIï¼‰ã€‚</p>
<p>JVMæ€§èƒ½è°ƒä¼˜ç›‘æ§å·¥å…·jpsã€jstackã€jmapã€jhatã€jstatã€hprofä½¿ç”¨è¯¦è§£ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/294950372?utm_medium=social&amp;utm_oi=690843302169178112">https://zhuanlan.zhihu.com/p/294950372?utm_medium=social&amp;utm_oi=690843302169178112</a></p>
<h3 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h3><p>è™šæ‹Ÿæœºé…ç½®ä¿¡æ¯ï¼Œ<code>jinfo è¿›ç¨‹id</code></p>
<h3 id="å›¾åƒåŒ–ç•Œé¢åˆ†æå·¥å…·"><a href="#å›¾åƒåŒ–ç•Œé¢åˆ†æå·¥å…·" class="headerlink" title="å›¾åƒåŒ–ç•Œé¢åˆ†æå·¥å…·"></a>å›¾åƒåŒ–ç•Œé¢åˆ†æå·¥å…·</h3><p>VisualVMã€JProfileã€MAT</p>
<h2 id="å‡ ç§æ’æŸ¥æ€è·¯"><a href="#å‡ ç§æ’æŸ¥æ€è·¯" class="headerlink" title="å‡ ç§æ’æŸ¥æ€è·¯"></a>å‡ ç§æ’æŸ¥æ€è·¯</h2><h3 id="çº¿ç¨‹cpuå ç”¨é«˜"><a href="#çº¿ç¨‹cpuå ç”¨é«˜" class="headerlink" title="çº¿ç¨‹cpuå ç”¨é«˜"></a>çº¿ç¨‹cpuå ç”¨é«˜</h3><p>1.<code>ps -ef|grep java</code> æˆ–è€… jps æŸ¥æ‰¾å‡ºè¿›ç¨‹id<br>2.<code>top -Hp è¿›ç¨‹id</code> æŸ¥æ‰¾å‡ºæœ€è€—cpuçš„çº¿ç¨‹id <code>top -c</code>çœ‹è¿›ç¨‹çš„<br>3.<code>printf &quot;%x\n&quot;</code> çº¿ç¨‹id  è½¬æ¢ä¸º16è¿›åˆ¶çš„id<br>4.ä½¿ç”¨<code>jstack è¿›ç¨‹id | grep 16è¿›åˆ¶çº¿ç¨‹id</code>  æŸ¥æ‰¾å‡ºå †æ ˆä¿¡æ¯ï¼Œåˆ†æ</p>
<p>å¦å¤–ï¼Œarthasä¹Ÿå¯ä»¥æ‰“å°å‡ºå‰å¤šå°‘ä¸ªçº¿ç¨‹åŠå æœ‰cpuæƒ…å†µ<br><code>thread -n 5</code></p>
<h3 id="OOM"><a href="#OOM" class="headerlink" title="OOM"></a>OOM</h3><p>é™¤äº†ç¨‹åºè®¡æ•°å™¨ï¼Œå…¶ä»–å†…å­˜å­˜å‚¨éƒ½å¯èƒ½OOMã€‚<br>æœ‰å¯èƒ½ï¼šæ•°æ®é‡å¤§ã€JVMå†…å­˜å®¹é‡å‚æ•°åˆ†é…ä¸åˆç†ã€ä»£ç bugæ­»å¾ªç¯æ— é™åˆ†é…å®¹é‡<br>1ã€å†…å­˜æ³„éœ²ï¼Œå¯¹è±¡å·²ç»æ­»äº†ï¼Œæ— æ³•é€šè¿‡åƒåœ¾æ”¶é›†å™¨è¿›è¡Œè‡ªåŠ¨å›æ”¶ï¼Œé€šè¿‡æ‰¾å‡ºæ³„éœ²çš„ä»£ç ä½ç½®å’ŒåŸå› ï¼Œæ‰å¥½ç¡®å®šè§£å†³æ–¹æ¡ˆï¼›<br>2ã€å†…å­˜æº¢å‡ºï¼Œå†…å­˜ä¸­çš„å¯¹è±¡éƒ½è¿˜å¿…é¡»å­˜æ´»ç€ï¼Œè¿™è¯´æ˜Javaå †åˆ†é…ç©ºé—´ä¸è¶³ï¼Œæ£€æŸ¥å †è®¾ç½®å¤§å°ï¼ˆ-Xmxä¸-Xmsï¼‰ï¼Œæ£€æŸ¥ä»£ç æ˜¯å¦å­˜åœ¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå¤ªé•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µã€‚</p>
<p>1.å…ˆä½¿ç”¨jmapçœ‹ä¸€ä¸‹å †å†…å­˜ä½¿ç”¨æƒ…å†µ<br>2.<code>jmap -dump:format=b,file=/tmp/dump.dat è¿›ç¨‹id</code> dumpæ–‡ä»¶<br>3.ä½¿ç”¨MATå·¥å…·åˆ†æ<br>matå·¥å…·çš„ä½¿ç”¨ï¼š<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/44641">https://developer.aliyun.com/article/44641</a></p>
<h3 id="full-gc"><a href="#full-gc" class="headerlink" title="full gc"></a>full gc</h3><p>1.<code>jstat -gcutil è¿›ç¨‹id 1000 40</code>æŸ¥çœ‹gcæƒ…å†µï¼Œ1sä¸€æ¬¡ï¼Œ40æ¬¡åŠ¨æ€çœ‹gcå¢é•¿<br>2.æ‰¾åˆ°gc.log<br>é‡Œé¢æœ‰gcå‰å †ä½¿ç”¨ç©ºé—´&gt;gcåå †å·²ä½¿ç”¨ç©ºé—´ï¼Œè¿˜æœ‰ç”¨æˆ·æ€æ¶ˆè€—çš„cpuæ—¶é—´ã€å†…æ ¸æ€æ¶ˆè€—çš„cpuæ—¶é—´ã€æ“ä½œä»å¼€å§‹åˆ°ç»“æŸç»è¿‡çš„æ—¶é—´ã€‚</p>
<p>æ¨¡æ‹Ÿgcçœ‹æ—¥å¿—ï¼š<br><a target="_blank" rel="noopener" href="https://javastack.blog.csdn.net/article/details/109006521">https://javastack.blog.csdn.net/article/details/109006521</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/25/myblog/%E7%AC%94%E8%AE%B0/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Jade liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jadeliu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/25/myblog/%E7%AC%94%E8%AE%B0/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF/" class="post-title-link" itemprop="url">ã€Šjavaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹ç¬”è®°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-25 23:05:34" itemprop="dateCreated datePublished" datetime="2022-08-25T23:05:34+08:00">2022-08-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-08-20 15:43:39" itemprop="dateModified" datetime="2023-08-20T15:43:39+08:00">2023-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">ç¬”è®°</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç¬¬ä¸€ç« -å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜"><a href="#ç¬¬ä¸€ç« -å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜" class="headerlink" title="ç¬¬ä¸€ç«  å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜"></a>ç¬¬ä¸€ç«  å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜</h2><h3 id="1-ä¸Šä¸‹æ–‡åˆ‡æ¢"><a href="#1-ä¸Šä¸‹æ–‡åˆ‡æ¢" class="headerlink" title="1.ä¸Šä¸‹æ–‡åˆ‡æ¢"></a>1.ä¸Šä¸‹æ–‡åˆ‡æ¢</h3><p>CPUé€šè¿‡ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…CPUæ—¶é—´ç‰‡æ¥å®ç°å¤šçº¿ç¨‹ï¼Œæ—¶é—´ç‰‡ä¸€èˆ¬å‡ åæ¯«ç§’ã€‚</p>
<p>ä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯æŒ‡åˆ‡æ¢å‰éœ€è¦ä¿å­˜ä¸Šä¸€ä¸ªä»»åŠ¡çš„çŠ¶æ€ã€‚</p>
<p>ç”±äºçº¿ç¨‹æœ‰åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œå¹¶å‘æ‰§è¡Œçš„é€Ÿåº¦ä¸ä¸€å®šæ¯”ä¸²è¡Œå¿«ã€‚</p>
<p>ä¸Šä¸‹æ–‡æ¯1såˆ‡æ¢1000å¤šæ¬¡ã€‚</p>
<p>å¦‚ä½•å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ<br>1ã€æ— é”å¹¶å‘ç¼–ç¨‹ï¼Œå¤šçº¿ç¨‹ç«äº‰é”æ—¶ä¼šå¼•èµ·ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¯ä»¥å°†æ•°æ®idæ ¹æ®hashç®—æ³•å–æ¨¡åˆ†æ®µï¼Œä¸åŒçº¿ç¨‹å¤„ç†ä¸åŒæ®µçš„æ•°æ®ã€‚<br>2ã€CASç®—æ³•ï¼ŒAtomicåŒ…ä¸‹ï¼Œä¸éœ€è¦åŠ é”ã€‚<br>3ã€é¿å…åˆ›å»ºä¸éœ€è¦çš„çº¿ç¨‹ã€‚æ¯æ¬¡ä»waitingåˆ°runnableéƒ½éœ€è¦è¿›è¡Œä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚<br>4ã€åç¨‹ï¼šåœ¨å•çº¿ç¨‹ä¸­å®ç°å¤šä»»åŠ¡è°ƒåº¦ï¼Œç»´æŒå¤šä¸ªä»»åŠ¡é—´çš„åˆ‡æ¢ã€‚</p>
<h3 id="2-æ­»é”"><a href="#2-æ­»é”" class="headerlink" title="2.æ­»é”"></a>2.æ­»é”</h3><p>çº¿ç¨‹aå’Œçº¿ç¨‹bäº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ã€‚</p>
<p>ä¸€æ—¦å‡ºç°æ­»é”ï¼Œä¸šåŠ¡å¯æ„ŸçŸ¥ï¼Œä½¿ç”¨jstackå‘½ä»¤dumpçº¿ç¨‹ã€‚</p>
<p>é¿å…æ­»é”çš„å‡ ä¸ªæ–¹æ³•ï¼š<br>1ã€é¿å…ä¸€ä¸ªçº¿ç¨‹åŒæ—¶è·å–å¤šä¸ªé”ã€‚<br>2ã€é¿å…ä¸€ä¸ªçº¿ç¨‹åœ¨é”å†…åŒæ—¶å ç”¨å¤šä¸ªèµ„æºã€‚<br>3ã€å°è¯•ä½¿ç”¨å®šæ—¶é”ï¼Œä½¿ç”¨lock.tryLock(timeout)æ¥æ›¿ä»£å†…éƒ¨é”æœºåˆ¶<br>4ã€å¯¹äºæ•°æ®åº“é”ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä¸­ï¼Œå¦åˆ™ä¼šå‡ºç°è§£é”å¤±è´¥ã€‚</p>
<h3 id="3-èµ„æºé™åˆ¶"><a href="#3-èµ„æºé™åˆ¶" class="headerlink" title="3.èµ„æºé™åˆ¶"></a>3.èµ„æºé™åˆ¶</h3><p>å¹¶å‘ç¼–ç¨‹æ—¶çš„èµ„æºé™åˆ¶ï¼š<br>ç¡¬ä»¶é™åˆ¶ï¼šå¸¦å®½çš„ä¸Šä¼ /ä¸‹è½½é€Ÿåº¦ï¼ˆ2Mb/sï¼‰ã€ç¡¬ç›˜è¯»å†™é€Ÿåº¦ã€CPUå¤„ç†é€Ÿåº¦<br>è½¯ä»¶é™åˆ¶ï¼šæ•°æ®åº“è¿æ¥æ•°ã€socketè¿æ¥æ•°<br>ä¾‹å¦‚ï¼šçº¿ç¨‹æ•°æ¯”æ•°æ®åº“è¿æ¥æ•°å¤§å¾ˆå¤šï¼Œåˆ™æŸäº›çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç­‰å¾…æ•°æ®åº“è¿æ¥ã€‚</p>
<p>ä½¿ç”¨ç­‰å¾…è¶…æ—¶æ¨¡å¼æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥æ± ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_52043808/article/details/125759727">https://blog.csdn.net/m0_52043808/article/details/125759727</a></p>
<p>å—åˆ°èµ„æºé™åˆ¶æ—¶ï¼Œå¹¶å‘æ‰§è¡Œå¯èƒ½ä¼šç¼–ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œä½†æ˜¯å¢åŠ äº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œèµ„æºè°ƒåº¦çš„æ—¶é—´ï¼Œæ¯”ä¸²è¡Œè¿˜æ…¢ã€‚</p>
<p>å¦‚ä½•è§£å†³ï¼Ÿ<br>1ã€å¯¹äºç¡¬ä»¶çº¦æŸï¼Œè€ƒè™‘ä½¿ç”¨é›†ç¾¤å¹¶è¡Œæ‰§è¡Œç¨‹åºï¼Œä¸åŒæœºå™¨å¤„ç†ä¸åŒæ•°æ®ã€‚<br>2ã€å¯¹äºè½¯ä»¶é™åˆ¶ï¼Œè€ƒè™‘ä½¿ç”¨èµ„æºæ± å°†èµ„æºå¤ç”¨ã€‚</p>
<h3 id="4-jstackå‘½ä»¤dumpçº¿ç¨‹"><a href="#4-jstackå‘½ä»¤dumpçº¿ç¨‹" class="headerlink" title="4.jstackå‘½ä»¤dumpçº¿ç¨‹"></a>4.jstackå‘½ä»¤dumpçº¿ç¨‹</h3><h4 id="âœ…ä»€ä¹ˆæ˜¯jstackï¼Ÿ"><a href="#âœ…ä»€ä¹ˆæ˜¯jstackï¼Ÿ" class="headerlink" title="âœ…ä»€ä¹ˆæ˜¯jstackï¼Ÿ"></a>âœ…ä»€ä¹ˆæ˜¯jstackï¼Ÿ</h4><p>å¦‚æœæœ‰ä¸€å¤©ï¼Œä½ çš„Javaç¨‹åºé•¿æ—¶é—´åœé¡¿ï¼Œä¹Ÿè®¸æ˜¯å®ƒç—…äº†ï¼Œéœ€è¦ç”¨jstackæ‹ä¸ªç‰‡å­åˆ†æåˆ†æï¼Œæ‰èƒ½è¯Šæ–­å…·ä½“ä»€ä¹ˆç—…ç—‡ï¼Œæ˜¯æ­»é”ç»¼åˆå¾ï¼Œè¿˜æ˜¯æ­»å¾ªç¯ç­‰å…¶ä»–ç—…ç—‡ã€‚</p>
<p>jstackæ˜¯JVMè‡ªå¸¦çš„Javaå †æ ˆè·Ÿè¸ªå·¥å…·ï¼Œå®ƒç”¨äºæ‰“å°å‡ºç»™å®šçš„javaè¿›ç¨‹IDã€core fileã€è¿œç¨‹è°ƒè¯•æœåŠ¡çš„Javaå †æ ˆä¿¡æ¯.</p>
<pre><code>1ã€jstackå‘½ä»¤ç”¨äºç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ã€‚
2ã€çº¿ç¨‹å¿«ç…§æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆï¼Œç”Ÿæˆçº¿ç¨‹å¿«ç…§çš„ä¸»è¦ç›®çš„æ˜¯å®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› ï¼Œ å¦‚çº¿ç¨‹é—´æ­»é”ã€æ­»å¾ªç¯ã€è¯·æ±‚å¤–éƒ¨èµ„æºå¯¼è‡´çš„é•¿æ—¶é—´ç­‰å¾…ç­‰é—®é¢˜ã€‚
3ã€çº¿ç¨‹å‡ºç°åœé¡¿çš„æ—¶å€™é€šè¿‡jstackæ¥æŸ¥çœ‹å„ä¸ªçº¿ç¨‹çš„è°ƒç”¨å †æ ˆï¼Œå°±å¯ä»¥çŸ¥é“æ²¡æœ‰å“åº”çš„çº¿ç¨‹åˆ°åº•åœ¨åå°åšä»€ä¹ˆäº‹æƒ…ï¼Œæˆ–è€…ç­‰å¾…ä»€ä¹ˆèµ„æºã€‚
4ã€å¦‚æœjavaç¨‹åºå´©æºƒç”Ÿæˆcoreæ–‡ä»¶ï¼Œjstackå·¥å…·å¯ä»¥ç”¨æ¥è·å¾—coreæ–‡ä»¶çš„java stackå’Œnative stackçš„ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥è½»æ¾åœ°çŸ¥é“javaç¨‹åºæ˜¯å¦‚ä½•å´©æºƒå’Œåœ¨ç¨‹åºä½•å¤„å‘ç”Ÿé—®é¢˜ã€‚
5ã€å¦å¤–ï¼Œjstackå·¥å…·è¿˜å¯ä»¥é™„å±åˆ°æ­£åœ¨è¿è¡Œçš„javaç¨‹åºä¸­ï¼Œçœ‹åˆ°å½“æ—¶è¿è¡Œçš„javaç¨‹åºçš„java stackå’Œnative stackçš„ä¿¡æ¯, å¦‚æœç°åœ¨è¿è¡Œçš„javaç¨‹åºå‘ˆç°hungçš„çŠ¶æ€ï¼Œjstackæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚
</code></pre>
<h4 id="âœ…æ€ä¹ˆç”¨ï¼š"><a href="#âœ…æ€ä¹ˆç”¨ï¼š" class="headerlink" title="âœ…æ€ä¹ˆç”¨ï¼š"></a>âœ…æ€ä¹ˆç”¨ï¼š</h4><p>é¦–å…ˆä½¿ç”¨ jpså‘½ä»¤æŸ¥çœ‹éœ€è¦æ‰“å°çº¿ç¨‹æ ˆçš„javaè¿›ç¨‹å·pidã€‚<br>ç„¶å jstack pidã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-F	å½“æ­£å¸¸è¾“å‡ºçš„è¯·æ±‚ä¸è¢«å“åº”æ—¶ï¼Œå¼ºåˆ¶è¾“å‡ºçº¿ç¨‹å †æ ˆ</span><br><span class="line">-m	å¦‚æœè°ƒç”¨åˆ°æœ¬åœ°æ–¹æ³•çš„è¯ï¼Œå¯ä»¥æ˜¾ç¤ºC/C++çš„å †æ ˆ</span><br><span class="line">-l	é™¤å †æ ˆå¤–ï¼Œæ˜¾ç¤ºå…³äºé”çš„é™„åŠ ä¿¡æ¯ï¼Œåœ¨å‘ç”Ÿæ­»é”æ—¶å¯ä»¥ç”¨jstack -l pidæ¥è§‚å¯Ÿé”æŒæœ‰æƒ…å†µ</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºè§£è¯»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt;jstack 9348</span><br><span class="line">Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.281-b09 mixed mode):</span><br><span class="line"></span><br><span class="line">&quot;DestroyJavaVM&quot; #13 prio=5 os_prio=0 tid=0x0000018da5881000 nid=0x34c8 waiting on condition [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">[é€šè¿‡ jstackæŸ¥çœ‹çº¿ç¨‹æ ˆä¿¡æ¯æ—¶é€šå¸¸çœ‹åˆ°çš„æœ€å¤šçš„æ˜¯RUNNABLE,BLOCKED,WAITINGå’ŒTIMED_WAITINGè¿™å‡ ç§çŠ¶æ€ï¼Œ</span><br><span class="line">æˆ‘ä»¬ä¸€èˆ¬çœ‹ä¸åˆ°çº¿ç¨‹çš„NEWå’ŒTERMINATEDçŠ¶æ€ï¼Œæ˜¯å› ä¸ºåœ¨ä»£ç çš„è¿è¡Œè¿‡ç¨‹ä¸­è¿™ä¸¤ç§çŠ¶æ€åªå å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œ</span><br><span class="line">æˆ‘ä»¬æ•æ‰åˆ°è¿™ä¸¤ç§çŠ¶æ€å‰è¿™ä¸¤ç§çŠ¶æ€å·²ç»ä¸€é—ªè€Œè¿‡äº†ã€‚</span><br><span class="line"></span><br><span class="line">&quot;main&quot; #1 prio=5 os_prio=0 tid=0x0000000002e7e800 nid=0x2a1c in Object.wait() [0x0000000002f7f000]</span><br><span class="line">   java.lang.Thread.State: WAITING (on object monitor)</span><br><span class="line"></span><br><span class="line">å…¶ä¸­å¼€å¤´æ˜¯çº¿ç¨‹åç§°ï¼Œåé¢çš„ä¸ºçº¿ç¨‹ä¿¡æ¯ï¼š</span><br><span class="line"> #1 è¡¨ç¤ºå½“å‰çº¿ç¨‹IDï¼Œä» mainçº¿ç¨‹å¼€å§‹ï¼ŒJVM æ ¹æ®çº¿ç¨‹åˆ›å»ºçš„é¡ºåºä¸ºçº¿ç¨‹ç¼–å·.</span><br><span class="line">prio æ˜¯priorityä¼˜å…ˆçº§çš„ç¼©å†™ï¼Œè¡¨åäº†å½“å‰çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå–å€¼èŒƒå›´ä¸º[1-10]ï¼Œé»˜è®¤ä¸º 5ã€‚åœ¨è™šæ‹Ÿæœºè¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„æ—¶å€™ä¼šå‚è€ƒè¯¥ä¼˜å…ˆçº§ä¸ºçº¿ç¨‹åˆ†é…è®¡ç®—èµ„æºï¼Œè¿™ä¸ªæ•°å€¼è¶Šä½è¶Šæœ‰ä¼˜å…ˆè·å–åˆ°è®¡ç®—èµ„æºï¼Œä¸€èˆ¬ä¸è®¾ç½®ç›´æ¥ä½¿ç”¨é»˜è®¤çš„ä¼˜å…ˆçº§ã€‚</span><br><span class="line">os_prioä¸ºçº¿ç¨‹å¯¹åº”ç³»ç»Ÿçš„ä¼˜å…ˆçº§ã€‚</span><br><span class="line">nid æœ¬åœ°çº¿ç¨‹ç¼–å·NativeIDçš„ç¼©å†™,å¯¹åº”JVM è™šæ‹Ÿæœºä¸­çº¿ç¨‹æ˜ å°„åœ¨æ“ä½œç³»ç»Ÿä¸­çš„çº¿ç¨‹ç¼–å·ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ top æŸ¥çœ‹è¿›ç¨‹å¯¹åº”çš„çº¿ç¨‹æƒ…å†µè¿›è¡Œç›¸å…³æ˜ å°„ã€‚</span><br></pre></td></tr></table></figure>

<p>nidè¡¨ç¤ºçš„æ˜¯çº¿ç¨‹å¯¹åº”çš„ç³»ç»Ÿæœ¬åœ°çš„çº¿ç¨‹ç¼–å·.</p>
<h4 id="âœ…æ¡ˆä¾‹ï¼šjstack-åˆ†ææ­»é”é—®é¢˜"><a href="#âœ…æ¡ˆä¾‹ï¼šjstack-åˆ†ææ­»é”é—®é¢˜" class="headerlink" title="âœ…æ¡ˆä¾‹ï¼šjstack åˆ†ææ­»é”é—®é¢˜"></a>âœ…æ¡ˆä¾‹ï¼šjstack åˆ†ææ­»é”é—®é¢˜</h4><p>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•è¿›è¡Œä¸‹å»</p>
<p>æ­»é”demoï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Java æ­»é”demo</span><br><span class="line"> */</span><br><span class="line">public class DeathLockTest &#123;</span><br><span class="line">    private static Lock lock1 = new ReentrantLock();</span><br><span class="line">    private static Lock lock2 = new ReentrantLock();</span><br><span class="line"> </span><br><span class="line">    public static void deathLock() &#123;</span><br><span class="line">        Thread t1 = new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    lock1.lock();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + &quot; get the lock1&quot;);</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                    lock2.lock();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + &quot; get the lock2&quot;);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Thread t2 = new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    lock2.lock();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + &quot; get the lock2&quot;);</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                    lock1.lock();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + &quot; get the lock1&quot;);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        //è®¾ç½®çº¿ç¨‹åå­—ï¼Œæ–¹ä¾¿åˆ†æå †æ ˆä¿¡æ¯</span><br><span class="line">        t1.setName(&quot;mythread-jay&quot;);</span><br><span class="line">        t2.setName(&quot;mythread-tianluo&quot;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        deathLock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ’æŸ¥æ­¥éª¤ï¼š<br>1ã€åœ¨ç»ˆç«¯ä¸­è¾“å…¥jspæŸ¥çœ‹å½“å‰è¿è¡Œçš„javaç¨‹åº<br>2ã€ä½¿ç”¨ jstack -l pid æŸ¥çœ‹çº¿ç¨‹å †æ ˆä¿¡æ¯<br>3ã€åˆ†æå †æ ˆä¿¡æ¯</p>
<p>ä¼šå‡ºç°ï¼šFound one Java-level deadlock: ä¿¡æ¯ã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹å æœ‰ä¸€ä¸ªé”çš„æ—¶å€™ï¼Œçº¿ç¨‹å †æ ˆä¼šæ‰“å°ä¸€ä¸ªï¼locked&lt;0x22bffb60&gt;<br>å½“ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰åœ¨å…¶ä»–çº¿ç¨‹é‡Šæ”¾è¯¥é”ï¼Œçº¿ç¨‹å †æ ˆä¼šæ‰“å°ä¸€ä¸ªï¼waiting to lock&lt;0x22bffb60&gt;<br>å½“ä¸€ä¸ªçº¿ç¨‹å æœ‰ä¸€ä¸ªé”ï¼Œä½†åˆæ‰§è¡Œåœ¨è¯¥é”çš„waitä¸Šï¼Œçº¿ç¨‹å †æ ˆä¸­é¦–å…ˆæ‰“å°blocked,ç„¶åæ‰“å°ï¼waiting on &lt;0x22c03c60&gt;</p>
<h4 id="âœ…æ¡ˆä¾‹ï¼šåˆ†æCPUè¿‡é«˜"><a href="#âœ…æ¡ˆä¾‹ï¼šåˆ†æCPUè¿‡é«˜" class="headerlink" title="âœ…æ¡ˆä¾‹ï¼šåˆ†æCPUè¿‡é«˜"></a>âœ…æ¡ˆä¾‹ï¼šåˆ†æCPUè¿‡é«˜</h4><p>å¯¼è‡´CPUè¿‡é«˜çš„demoç¨‹åºï¼Œä¸€ä¸ªæ­»å¾ªç¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æœ‰ä¸ªå¯¼è‡´CPUè¿‡é«˜ç¨‹åºçš„demoï¼Œæ­»å¾ªç¯</span><br><span class="line"> */</span><br><span class="line">public class JstackCase &#123;</span><br><span class="line"> </span><br><span class="line">     private static ExecutorService executorService = Executors.newFixedThreadPool(5);</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"> </span><br><span class="line">        Task task1 = new Task();</span><br><span class="line">        Task task2 = new Task();</span><br><span class="line">        executorService.execute(task1);</span><br><span class="line">        executorService.execute(task2);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static Object lock = new Object();</span><br><span class="line"> </span><br><span class="line">    static class Task implements Runnable&#123;</span><br><span class="line"> </span><br><span class="line">        public void run() &#123;</span><br><span class="line">            synchronized (lock)&#123;</span><br><span class="line">                long sum = 0L;</span><br><span class="line">                while (true)&#123;</span><br><span class="line">                    sum += 1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ’æŸ¥æ­¥éª¤ï¼š<br>1ã€jps å‘½ä»¤è·å–ç›®æ ‡ java è¿›ç¨‹å·<br>2ã€åœ¨æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡topå‘½ä»¤æŸ¥çœ‹å„ä¸ªè¿›ç¨‹çš„cpuä½¿ç”¨æƒ…å†µï¼Œå®ƒé»˜è®¤æ˜¯æŒ‰cpuä½¿ç”¨ç‡ç”±é«˜åˆ°ä½æ’åºçš„ï¼Œæ‹¿åˆ°pid<br>top -Hp pid ã€å¥‡æ€ªï¼Œä¸èƒ½ç”¨ï¼Œåªèƒ½top -p pidã€‘<br>é€šè¿‡top -Hp pidå¯ä»¥æŸ¥çœ‹è¯¥è¿›ç¨‹ä¸‹ï¼Œå„ä¸ªçº¿ç¨‹çš„cpuä½¿ç”¨æƒ…å†µ<br>3ã€æŠŠçº¿ç¨‹pidæ¢æˆnid<br>å°†è¯¥çº¿ç¨‹å¥½æ‰“å°æˆ 16è¿›åˆ¶çš„<br><code>printf &quot;%x\n&quot; 19343</code><br>4ã€jstack -l [PID] &gt;/tmp/log.txt<br>ä¸€èˆ¬åœ¨ç”Ÿæˆç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›å †æ ˆä¿¡æ¯æ‰“åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œå†å›å¤´ä»”ç»†åˆ†æ<br>jstack è¿›ç¨‹pid | grep -10 çº¿ç¨‹<br>nid<br>å¯ä»¥çœ‹åˆ°ç›®æ ‡çº¿ç¨‹çš„çº¿ç¨‹å †æ ˆä¿¡æ¯äº†</p>
<p>è½¬è‡ªï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44588186/article/details/124680586">https://blog.csdn.net/weixin_44588186/article/details/124680586</a><br>ã€jstackæ¡ˆä¾‹ã€‘<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_19922839/article/details/115379649">https://blog.csdn.net/qq_19922839/article/details/115379649</a><br>ã€é‡Œé¢è¿˜æœ‰pstree æŸ¥çœ‹è¿›ç¨‹æ ‘ï¼Œjvm ç›‘æ§å·¥å…·Liberica Mission Controlã€‘</p>
<h4 id="âœ…dumpçº¿ç¨‹"><a href="#âœ…dumpçº¿ç¨‹" class="headerlink" title="âœ…dumpçº¿ç¨‹"></a>âœ…dumpçº¿ç¨‹</h4><p>çº¿ç¨‹dumpçš„ç›®çš„æ˜¯è½¬å­˜çº¿ç¨‹å¿«ç…§ã€‚å¿«ç…§ä¸­æ˜¯å½“å‰JVMæ‰€æœ‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œæ–¹æ³•çš„å †æ ˆä¿¡æ¯ã€‚</p>
<p>é€šè¿‡çº¿ç¨‹dumpæ¥åˆ†æå®šä½çº¿ç¨‹å‡ºç°é•¿æ—¶é—´åœé¡¿çš„åŸå› ï¼Œå¦‚çº¿ç¨‹æ­»é”ã€çº¿ç¨‹æ­»å¾ªç¯ã€çº¿ç¨‹è¯·æ±‚å¤–éƒ¨èµ„æºé•¿æ—¶é—´ç­‰å¾…ç­‰ã€‚</p>
<p>å¯ä»¥ç”¨arthasè·å–dumpæ–‡ä»¶ï¼Œdumpæ–‡ä»¶å¾ˆå¤§ï¼Œå‡ ä¸ªGï¼Œå¯ä»¥ç”¨IDEAæ‰“å¼€ï¼Œæˆ–è€…ç”¨å…¶ä»–åˆ†æå·¥å…·ã€‚arthasä¹Ÿå¯ä»¥è¾“å‡ºæ‰€æœ‰çº¿ç¨‹ã€‚</p>
<p>çº¿ç¨‹dumpï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/HaierFiller/article/details/117367228">https://blog.csdn.net/HaierFiller/article/details/117367228</a></p>
<h2 id="ç¬¬äºŒç« -javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†"><a href="#ç¬¬äºŒç« -javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†" class="headerlink" title="ç¬¬äºŒç«  javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†"></a>ç¬¬äºŒç«  javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†</h2><p>.javaä»£ç  -ç¼–è¯‘ä¸º- .classå­—èŠ‚ç æ–‡ä»¶ -åŠ è½½åˆ°- jvm -æ‰§è¡Œå­—èŠ‚ç - è½¬åŒ–ä¸ºæ±‡ç¼–è¯­è¨€åœ¨cpuæ‰§è¡Œã€‚</p>
<p>javaçš„å¹¶å‘æœºåˆ¶ä¾èµ–äºjvmçš„å®ç°å’Œcpuçš„æ‰§è¡Œã€‚</p>
<h3 id="1-volatile"><a href="#1-volatile" class="headerlink" title="1.volatile"></a>1.volatile</h3><h4 id="âœ…volatileåº•å±‚"><a href="#âœ…volatileåº•å±‚" class="headerlink" title="âœ…volatileåº•å±‚"></a>âœ…volatileåº•å±‚</h4><p>volatileæ˜¯è½»é‡çº§çš„synchronizedï¼Œåœ¨å¤šå¤„ç†å™¨å¼€å‘ä¸­ä¿è¯äº†å…±äº«å˜é‡çš„å¯è§æ€§ï¼ˆæ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„è¿™ä¸ªå˜é‡çš„å€¼æ˜¯ä¸€è‡´çš„ï¼‰ã€‚æ¯”synchronizedæ‰§è¡Œæˆæœ¬ä½ï¼Œä¸ä¼šå¼•èµ·çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å’Œè°ƒåº¦ã€‚</p>
<p>é¦–å…ˆï¼Œäº†è§£ä¸€ä¸‹cpuå¤„ç†é€»è¾‘ï¼š<br>ä¸ºäº†æé«˜å¤„ç†é€Ÿåº¦ï¼Œcpuä¸ç›´æ¥ä¸å†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯å…ˆå°†å†…å­˜çš„æ•°æ®è¯»åˆ°è‡ªå·±çš„å†…å­˜ç¼“å­˜ï¼ˆä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼‰ä¸­ã€‚</p>
<p>å¤„ç†å™¨ - é«˜é€Ÿç¼“å­˜ - ç¼“å­˜   \<br>å¤„ç†å™¨ - é«˜é€Ÿç¼“å­˜ - ä¸€è‡´æ€§  - æ€»çº¿ - ä¸»å†…å­˜<br>å¤„ç†å™¨ - é«˜é€Ÿç¼“å­˜ - åè®®   /</p>
<p>å­˜å‚¨å¤§ä½“ä¸Šåˆ†ä¸¤ç§, ä¸»å­˜æ˜¯å †å†…å­˜, å·¥ä½œå†…å­˜æ˜¯æ ˆå†…å­˜, å±äºçº¿ç¨‹ç§æœ‰ã€‚<br>å¯¹å­—æ®µæ“ä½œéƒ½éœ€è¦å…ˆä»ä¸»å­˜è¯»å–æ•°æ®åŠ è½½è¿›å·¥ä½œå†…å­˜, å·¥ä½œå†…å­˜å¯¹è¿™ä¸ªå‰¯æœ¬æ•°æ®è¿›è¡Œæ“ä½œ<br>volatileä¿®é¥°çš„å˜é‡, ç­‰äºåœ¨å †ä¸­è¿™ä¸ªå˜é‡çš„å†…å­˜åŒºåŸŸä¸Šæ‰“äº†ä¸ªæ ‡, æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»ä»ä¸»å­˜ä¸­è¯»å–, ç”±MESI&lt;ç¼“å­˜ä¸€è‡´æ€§åè®®&gt;å®ç°</p>
<p>å¯¹volatileå£°æ˜çš„å˜é‡è¿›è¡Œå†™æ“ä½œä¼šå‘ç”Ÿä»€ä¹ˆï¼š<br>1ã€jvmå‘å¤„ç†å™¨å‘é€ä¸€æ¡lockå‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªå˜é‡æ‰€åœ¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›ç³»ç»Ÿå†…å­˜ã€‚lockæŒ‡ä»¤æ‰§è¡ŒæœŸé—´ä¼šé”ä½æ€»çº¿/ç¼“å­˜ï¼Œä¿è¯ä¸ä¼šåŒæ—¶å¤šä¸ªcpuä¿®æ”¹å…±äº«å˜é‡ã€‚<br>2ã€å¤šå¤„ç†ä¸‹ï¼Œå®ç°ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œæ¯ä¸ªå¤„ç†å™¨ä½¿ç”¨å—…æ¢æŠ€æœ¯ï¼Œä¿è¯å®ƒçš„å†…éƒ¨ç¼“å­˜å’Œç³»ç»Ÿå†…å­˜çš„æ•°æ®åœ¨æ€»çº¿ä¸Šä¿æŒä¸€è‡´ï¼ˆå‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œé¦–å…ˆå°†ç¼“å­˜è¡Œç½®ä¸ºæ— æ•ˆï¼Œé‡æ–°ä»ç³»ç»Ÿå†…å­˜ä¸­å°†æ•°æ®è¯»åˆ°ç¼“å­˜ï¼‰ã€‚</p>
<p>volitaleçš„ä½¿ç”¨ä¼˜åŒ–ï¼š<br>jdk7ä¸­çš„LinkedTransferQueueï¼Œä½¿ç”¨volitaleæ—¶ï¼Œé‡‡ç”¨è¿½åŠ å­—èŠ‚çš„æ–¹å¼ä¼˜åŒ–å‡ºé˜Ÿå…¥é˜Ÿæ•ˆç‡ã€‚</p>
<p>ä¸ºä»€ä¹ˆï¼Ÿ<br>å› ä¸ºå¤„ç†å™¨çš„é«˜é€Ÿç¼“å­˜è¡Œæ˜¯64ä¸ªå­—èŠ‚å®½ï¼Œä¸æ”¯æŒéƒ¨åˆ†å¡«å……ç¼“å­˜è¡Œã€‚è¿™æ ·å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹åœ¨ä¸€ä¸ªé«˜é€Ÿç¼“å­˜è¡Œä¸­ï¼Œå¤šå¤„ç†å™¨ä¸‹ï¼Œä¸€ä¸ªå¤„ç†å™¨ä¿®æ”¹å¤´èŠ‚ç‚¹ï¼Œä¼šå°†æ•´ä¸ªç¼“å­˜è¡Œé”å®šï¼Œåœ¨ç¼“å­˜ä¸€è‡´æ€§çš„ä½œç”¨ä¸‹ï¼Œå¯¼è‡´å…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è‡ªå·±é«˜é€Ÿç¼“å­˜è¡Œä¸­çš„å°¾èŠ‚ç‚¹ã€‚<br>èŠ‚ç‚¹è¿½åŠ åˆ°64å­—èŠ‚ï¼Œå¯ä»¥é¿å…å¤´å°¾èŠ‚ç‚¹åŠ è½½åˆ°åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œä¿®æ”¹æ—¶ä¸ä¼šç›¸äº’é”å®šã€‚</p>
<p>æ³¨æ„ï¼šç¼“å­˜è¡Œé64å­—èŠ‚çš„åˆ«è¿™ä¹ˆåšï¼Œå…±äº«å˜é‡ä¸ä¼šè¢«é¢‘ç¹å†™çš„è¯åˆ«è¿™ä¹ˆåšã€‚</p>
<h4 id="âœ…volatileä½¿ç”¨"><a href="#âœ…volatileä½¿ç”¨" class="headerlink" title="âœ…volatileä½¿ç”¨"></a>âœ…volatileä½¿ç”¨</h4><p>âš ï¸æ³¨æ„ï¼švolatileèƒ½ä¿è¯å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯åŸå­æ€§ã€‚<br>åœ¨ volatile å­—æ®µä¸Šè¿›è¡Œäº†éåŸå­ç±»æ“ä½œï¼Œä¼šideaæç¤ºï¼š<code>Non-atomic operations on volatile fields</code><br>æ¯”å¦‚ï¼šcount++ å°±æ˜¯éåŸå­æ“ä½œï¼Œåˆ†ä¸‰æ­¥ï¼š<br>1ã€ä»ä¸»å­˜è¯»å– i<br>2ã€åœ¨å¯„å­˜å™¨ä¸­è¿›è¡ŒåŠ ä¸€è¿ç®—, è‡ªå¢æ“ä½œ, æ­¤æ—¶å·²ç»ä¿®æ”¹å·¥ä½œå†…å­˜ä¸­çš„å€¼<br>3ã€å°†è®¡ç®—åçš„å€¼èµ‹ç»™ i, ä¹Ÿå°±æ˜¯åˆ·å›ä¸»å­˜</p>
<p><strong>å¯è§æ€§</strong></p>
<p>volatileå’Œstaticçš„å¯è§æ€§ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//private boolean tag = false;  //ä¸ä¼šè¿è¡Œtag is true,exit</span><br><span class="line">//private static boolean tag = false;  //ä¸ä¼šè¿è¡Œtag is true,exit</span><br><span class="line">private volatile  boolean tag = false; //ä¼šè¿è¡Œtag is true,exit</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void visibleTest() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    Thread t1 = new Thread(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            //å½“tagæ ‡å¿—å˜ä¸ºtrueæ—¶ç»“æŸå¾ªç¯å¹¶æ‰“å°é€€å‡ºä¿¡æ¯</span><br><span class="line">            while(!tag)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;tag is true,exit......&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Thread t2 = new Thread(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            tag = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(100);</span><br><span class="line">    t2.start();</span><br><span class="line">    Thread.sleep(2000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š<br>volatileçš„å¯è§æ€§ï¼šæ˜¯å¤šä¸ªçº¿ç¨‹é—´çš„å…±äº«å˜é‡ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹èƒ½å¤ŸçŸ¥é“è¿™ä¸ªä¿®æ”¹ã€‚<br>staticä¸èƒ½çŸ¥é“å˜åŒ–ï¼Œå®ƒçš„å¯è§æ€§ï¼šå¯è®¿é—®ã€‚</p>
<p>volatileä¿®é¥°çš„å…±äº«å˜é‡å¯¹å…¶ä»–çº¿ç¨‹å…·æœ‰å¯è§æ€§ï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚<br>staticä¿®é¥°çš„å˜é‡ä¸ºå…¨å±€å˜é‡, å¯¹æ‰€æœ‰çº¿ç¨‹å¯è®¿é—®, å¯ç”¨äºçº¿ç¨‹é—´çš„é€šä¿¡ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>staticçº¿ç¨‹å®‰å…¨æµ‹è¯•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class VolatileDemo &#123;</span><br><span class="line"></span><br><span class="line">    private static int count = 0;</span><br><span class="line"></span><br><span class="line">    private static void count() &#123;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line"></span><br><span class="line">        ExecutorService es = Executors.newCachedThreadPool();</span><br><span class="line">        long start = System.nanoTime();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            es.execute(VolatileDemo::count);</span><br><span class="line">        &#125;</span><br><span class="line">        es.shutdown();</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            if (es.isTerminated()) &#123;</span><br><span class="line">                System.out.println(&quot;end...&quot;);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(2);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        long end = System.nanoTime();</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;count:&quot; + count);</span><br><span class="line">        System.out.println(&quot;cost:&quot; + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨ä¸€ä¸ªç¼“å­˜çº¿ç¨‹æ± è¿›è¡Œå¯¹staticå­—æ®µè¿›è¡Œè‡ªå¢ï¼Œç»“æœä¸æ˜¯100.<br>t1çº¿ç¨‹ä¸ t2çº¿ç¨‹è¯»å– count å€¼, ç„¶ååŒæ­¥ä¿®æ”¹ä¸º 1, å†å†™å›å†…å­˜, å†™äº†ä¸¤é 1ã€‚</p>
<p>å› æ­¤ï¼Œstaticä¿®é¥°çš„å˜é‡ç¡®å®å¯ä»¥åœ¨çº¿ç¨‹é—´é€šä¿¡, å¯¹å„ä¸ªçº¿ç¨‹éƒ½æ˜¯å¯è§çš„ã€‚ä½†æ˜¯ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>é‚£ä¹ˆç”¨volatileï¼Œç›¸å½“äºæ¯æ¬¡ä¿®æ”¹volatileå˜é‡éƒ½éœ€è¦é‡æ–°è¯»å–æ•°æ®ã€‚<br>ä½†æ˜¯ç»“æœä¾ç„¶ä¸æ˜¯100.</p>
<p>volatileçš„å¯è§æ€§æµ‹è¯•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//private boolean tag = false;  //ä¸ä¼šè¿è¡Œtag is true,exit</span><br><span class="line">//private static boolean tag = false;  //ä¸ä¼šè¿è¡Œtag is true,exit</span><br><span class="line">private volatile  boolean tag = false; //ä¼šè¿è¡Œtag is true,exit</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line">public void visibleTest() throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    Thread t1 = new Thread(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            //å½“tagæ ‡å¿—å˜ä¸ºtrueæ—¶ç»“æŸå¾ªç¯å¹¶æ‰“å°é€€å‡ºä¿¡æ¯</span><br><span class="line">            while(!tag)&#123;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;tag is true,exit......&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Thread t2 = new Thread(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            tag = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(100);</span><br><span class="line">    t2.start();</span><br><span class="line">    Thread.sleep(2000);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>éåŸå­æ€§</strong></p>
<p>t1çº¿ç¨‹ä¸t2çº¿ç¨‹åŒæ—¶ä»ä¸»å­˜ä¸­è¯»å–äº†count = 1,è‡ªå¢, è¿™æ—¶å€™ä¸¤ä¸ªçº¿ç¨‹çš„å¯„å­˜å™¨ä¸­å­˜çš„è®¡ç®—åçš„å€¼éƒ½æ˜¯ 2, ç„¶åè¦å†™å›countçš„ä¸»å­˜, å‡è®¾è¿™æ—¶ t1æˆåŠŸäº†, é‚£ä¹ˆä¸»å­˜ä¸­çš„countå°±æ˜¯2, ç„¶åæ ¹æ®MESIåè®®, t2éœ€è¦é‡æ–°ä»ä¸»å­˜è¯»å–countå€¼, å¾—åˆ°çš„æ˜¯2, å†å°†å¯„å­˜å™¨ä¸­çš„è®¡ç®—ç»“æœ2 èµ‹å€¼ç»™count, åˆ·å›ä¸»å­˜, æ­¤æ—¶ä¸»å­˜ä¸­çš„countå€¼è¿˜æ˜¯2, è€Œä¸æ˜¯æœŸæœ›ä¸­çš„3ã€‚</p>
<p>æ€ä¹ˆè§£å†³ï¼Ÿ<br>synchronizedå…³é”®å­—ï¼Œæˆ–è€… atomicåŸå­ç±» + volatile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private volatile static AtomicInteger count = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">private static void count() &#123;</span><br><span class="line">    count.incrementAndGet();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import lombok.SneakyThrows;</span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-09-12 20:14</span><br><span class="line"> **/</span><br><span class="line">public class VolatileDemo &#123;</span><br><span class="line"></span><br><span class="line">    private volatile AtomicInteger count = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testVolatile() throws InterruptedException &#123;</span><br><span class="line">        Thread thread1 = new Thread(new Runnable() &#123;</span><br><span class="line">            @SneakyThrows</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                for(int i = 0; i &lt; 50; i++) &#123;</span><br><span class="line">                    count.incrementAndGet();</span><br><span class="line">                    System.out.println(Thread.currentThread() + &quot; count:&quot; + count);</span><br><span class="line">                    Thread.sleep(100);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread thread2 = new Thread(new Runnable() &#123;</span><br><span class="line">            @SneakyThrows</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                for(int i = 0; i &lt; 50; i++) &#123;</span><br><span class="line">                    count.incrementAndGet();</span><br><span class="line">                    System.out.println(Thread.currentThread() + &quot; count:&quot; + count);</span><br><span class="line">                    Thread.sleep(100);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">        System.out.println(&quot;count:&quot; + count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š<br>1ã€staticä¿®é¥°çš„å˜é‡æ˜¯é™æ€å˜é‡, è¡¨ç¤ºä¸ç®¡å¯¹è±¡æœ‰å¤šå°‘å®ä¾‹, åªæœ‰è¿™ä¸€ä¸ªå˜é‡, å¼ºè°ƒå˜é‡çš„å”¯ä¸€æ€§<br>2ã€volatileæ˜¯åŸºäºJMMä¸MESIæå‡ºçš„ä¸€ç§å†…å­˜ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ, å¼ºè°ƒçš„æ˜¯å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹æ˜¯å¯è§çš„, å˜é‡å€¼æ˜¯å”¯ä¸€çš„<br>3ã€volatile å¯ä»¥ä¿è¯å¯¹å…¶æ‰€ä¿®é¥°çš„å…±äº«å˜é‡çš„åŸå­æ€§æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>è½¬è‡ªï¼š<br>volatileçš„å¯è§æ€§å’ŒéåŸå­æ€§ï¼š<a target="_blank" rel="noopener" href="https://www.codenong.com/js5a773b9fb9cb/">https://www.codenong.com/js5a773b9fb9cb/</a></p>
<h3 id="2-synchronized"><a href="#2-synchronized" class="headerlink" title="2.synchronized"></a>2.synchronized</h3><p>synchronizedä¹‹å‰è¢«ç§°ä¸ºé‡é‡çº§é”ï¼Œä½†æ˜¯java se 1.6 å¯¹synchronizedè¿›è¡Œä¼˜åŒ–ï¼šå‡å°‘è·å–é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—è€Œå¼•å…¥åå‘é”ã€è½»é‡çº§é”ã€‚</p>
<h4 id="âœ…synchronizedé”ä¸‰ç§å½¢å¼"><a href="#âœ…synchronizedé”ä¸‰ç§å½¢å¼" class="headerlink" title="âœ…synchronizedé”ä¸‰ç§å½¢å¼"></a>âœ…synchronizedé”ä¸‰ç§å½¢å¼</h4><p>1.å¯¹äºæ™®é€šåŒæ­¥â½…æ³•ï¼šé”çš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ï¼Œé€šå¸¸æŒ‡thisï¼Œæ‰€æœ‰çš„æ™®é€šåŒæ­¥â½…æ³•â½¤çš„éƒ½æ˜¯åŒâ¼€æŠŠé”ï¼Œå³å®ä¾‹å¯¹è±¡æœ¬èº«ã€‚</p>
<p>2.å¯¹äºé™æ€åŒæ­¥â½…æ³•ï¼šé”çš„æ˜¯å½“å‰ç±»çš„Classå¯¹è±¡ã€‚</p>
<p>3.å¯¹äºåŒæ­¥â½…æ³•å—ï¼šé”çš„æ˜¯synchronized æ‹¬å·å†…çš„å¯¹è±¡ã€‚</p>
<p>âš ï¸å‡ ä¸ªé”çš„åŒºåˆ«ï¼š<br>1.é™æ€æ–¹æ³•åŒæ­¥å’Œé™æ€ä»£ç å—åŒæ­¥ï¼šæ‰€æœ‰çš„é™æ€åŒæ­¥â½…æ³•â½¤çš„ä¹Ÿæ˜¯åŒâ¼€æŠŠé”â€”â€”ç±»å¯¹è±¡æœ¬èº«ï¼Œâ¼€æ—¦â¼€ä¸ªé™æ€åŒæ­¥â½…æ³•è·å–é”åï¼Œå…¶ä»–çš„é™æ€åŒæ­¥â½…æ³•éƒ½å¿…é¡»ç­‰å¾…è¯¥â½…æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”ã€‚ï¼ˆå’Œå®ä¾‹æ²¡å…³ç³»ï¼‰</p>
<p>2.é™æ€åŒæ­¥å’Œæ™®é€šåŒæ­¥ï¼šå…·ä½“å®ä¾‹å¯¹è±¡thiså’Œå”¯â¼€æ¨¡æ¿Classï¼Œè¿™ä¸¤æŠŠé”æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥é™æ€åŒæ­¥â½…æ³•ä¸æ™®é€šåŒæ­¥â½…æ³•ä¹‹é—´æ˜¯ä¸ä¼šæœ‰ç«æ€æ¡ä»¶çš„</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-09-17 14:11</span><br><span class="line"> **/</span><br><span class="line">//èµ„æºç±»</span><br><span class="line">class Phone&#123;</span><br><span class="line">    //1.é™æ€æ–¹æ³•ï¼ˆåŠ é”ï¼‰</span><br><span class="line">    public static synchronized void sendEmail() &#123;</span><br><span class="line">        //æš‚åœå‡ ç§’é’Ÿçº¿ç¨‹</span><br><span class="line">        try &#123; TimeUnit.SECONDS.sleep(3); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">        System.out.println(System.currentTimeMillis() + &quot;,&quot; + Thread.currentThread() + &quot;-------sendEmail&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //2.æ™®é€šæ–¹æ³•ï¼ˆåŠ é”ï¼‰</span><br><span class="line">    public synchronized void sendSMS() &#123;</span><br><span class="line">        System.out.println(System.currentTimeMillis() + &quot;,&quot; + Thread.currentThread() + &quot;-------sendSMS&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //3. æ™®é€šæ–¹æ³•ä¸åŠ é”</span><br><span class="line">    public void hello() &#123;</span><br><span class="line">        System.out.println(System.currentTimeMillis() + &quot;,&quot; + Thread.currentThread() + &quot;-------hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ä¸»æ–¹æ³•</span><br><span class="line">public class SynchronizedDemo&#123;</span><br><span class="line">    //ä¸€åˆ‡ç¨‹åºçš„å…¥å£ï¼Œä¸»çº¿ç¨‹</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        Phone phone = new Phone();//èµ„æºç±»1</span><br><span class="line">        Phone phone2 = new Phone();//èµ„æºç±»2</span><br><span class="line"></span><br><span class="line">        Thread t1 = new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                //phone.sendSMS(); //1ã€2</span><br><span class="line">                //phone.hello();</span><br><span class="line">                phone.sendEmail();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread t2 = new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                //phone.sendSMS(); //1ã€2</span><br><span class="line">                //phone.hello();</span><br><span class="line">                phone2.sendEmail();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        try &#123; TimeUnit.MILLISECONDS.sleep(300); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line">        t2.start();</span><br><span class="line">        try &#123; TimeUnit.MILLISECONDS.sleep(3000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="âœ…synchronizedé”çš„å®ç°åŸç†"><a href="#âœ…synchronizedé”çš„å®ç°åŸç†" class="headerlink" title="âœ…synchronizedé”çš„å®ç°åŸç†"></a>âœ…synchronizedé”çš„å®ç°åŸç†</h4><p>åç¼–è¯‘å‘½ä»¤ï¼š<code>javap -v -p *.class &gt; ç±».txt </code>ï¼ˆå°†è¿›â¾è¾“å‡ºåˆ°txtä¸­ï¼‰</p>
<p>synchronizedåœ¨jvmä¸­çš„å®ç°åŸç†ï¼šjvmåŸºäºè¿›å…¥å’Œé€€å‡ºMonitorå¯¹è±¡æ¥å®ç°æ–¹æ³•åŒæ­¥å’Œä»£ç å—åŒæ­¥ï¼Œmonitoræ˜¯ä¸€ä¸ªå¯¹è±¡çš„ç›‘è§†å™¨ã€‚</p>
<p><strong>åŒæ­¥ä»£ç å—ï¼š</strong></p>
<p>åŒæ­¥ä»£ç å—æ˜¯é€šè¿‡monitorenterå’ŒmonitorexitæŒ‡ä»¤å®ç°çš„ã€‚</p>
<p>monitorenterï¼šåœ¨ç¼–è¯‘åæ’å…¥åˆ°åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œä¼šå°è¯•è·å–å¯¹è±¡æ‰€å¯¹åº”çš„monitorçš„æ‰€æœ‰æƒï¼Œå³å°è¯•è·å–å¯¹è±¡çš„é”ã€‚</p>
<p>monitorexitï¼šä»£è¡¨æ‰§è¡Œå®Œsynchronizedä»£ç å—ä¹‹åï¼Œè¦ä»å¯¹è±¡ç›‘è§†å™¨ä¸­é€€å‡ºï¼Œä¹Ÿå°±æ˜¯é‡Šæ”¾é”ã€‚</p>
<p><strong>åŒæ­¥æ™®é€šâ½…æ³•ï¼š</strong></p>
<p>1.åŒæ­¥æ™®é€šâ½…æ³•åç¼–è¯‘åçš„ç»“æ„ï¼šå¯ä»¥çœ‹åˆ°åœ¨synchronizedä¿®é¥°å®ä¾‹æ–¹æ³•ä¸­ï¼Œä¸ä¼šå†æœ‰monitorenterå’ŒmonitorexitæŒ‡ä»¤ï¼Œè€Œæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸Šå¤šäº†ä¸€ä¸ªACC_SYNCHRONIZEDçš„flagã€‚</p>
<p>2.è°ƒç”¨æ™®é€šæ–¹æ³•çš„æµç¨‹ï¼šå½“ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œè°ƒç”¨method()æ–¹æ³•æ—¶ï¼Œä¼šæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦æœ‰ACC_SYNCHRONIZEDè®¿é—®æ ‡è¯†ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¡¨æ˜è¯¥æ–¹æ³•æ˜¯åŒæ­¥æ–¹æ³•ï¼Œè¿™æ—¶å€™è¯¥çº¿ç¨‹ä¼šå…ˆå°è¯•å»è·å–è¯¥æ–¹æ³•å¯¹åº”çš„ç›‘è§†å™¨ï¼ˆmonitorï¼‰å¯¹è±¡ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç»§ç»­æ‰§è¡Œè¯¥method()æ–¹æ³•ã€‚</p>
<p>3.åœ¨æ‰§è¡ŒæœŸé—´ï¼Œä»»ä½•å…¶ä»–çº¿ç¨‹éƒ½ä¸èƒ½å†è·å–è¯¥æ–¹æ³•ç›‘è§†å™¨çš„ä½¿ç”¨æƒï¼Œç›´åˆ°è¯¥æ–¹æ³•æ­£å¸¸é€€å‡ºæˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰ä¼šé‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥é‡æ–°è·å¾—è¯¥ç›‘è§†å™¨ã€‚</p>
<p><strong>åŒæ­¥é™æ€æ–¹æ³•ï¼š</strong></p>
<p>synchronizedä¿®é¥°é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•æ²¡æœ‰åŒºåˆ«ï¼Œéƒ½æ˜¯å¢åŠ ä¸€ä¸ªACC_SYNCHRONIZEDçš„flagï¼Œé™æ€æ–¹æ³•åªæ˜¯æ¯”å®ä¾‹æ–¹æ³•å¤šä¸€ä¸ªACC_STATICæ ‡è¯†ä»£è¡¨è¿™ä¸ªæ–¹æ³•æ˜¯é™æ€çš„ã€‚</p>
<p><strong>é˜¿é‡Œå¼€å‘æ‰‹å†Œè¯´æ˜ï¼š</strong></p>
<p>â¾¼å¹¶å‘æ—¶ï¼ŒåŒæ­¥è°ƒâ½¤åº”è¯¥å»è€ƒé‡é”çš„æ€§èƒ½æŸè€—ã€‚<br>1.èƒ½â½¤â½†é”æ•°æ®ç»“æ„ï¼Œå°±ä¸è¦â½¤æœ‰é”ï¼›<br>2.èƒ½é”åŒºå—ï¼Œå°±ä¸è¦é”æ•´ä¸ªâ½…æ³•ä½“ï¼›<br>3.èƒ½â½¤å¯¹è±¡é”ï¼Œå°±ä¸è¦â½¤ç±»é”ï¼›</p>
<p>å‚è€ƒï¼š<br>synchronizedä¸‰ç§åŠ é”æ–¹å¼ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38963649/article/details/126139304">https://blog.csdn.net/weixin_38963649/article/details/126139304</a></p>
<h4 id="âœ…javaå¯¹è±¡å¤´"><a href="#âœ…javaå¯¹è±¡å¤´" class="headerlink" title="âœ…javaå¯¹è±¡å¤´"></a>âœ…javaå¯¹è±¡å¤´</h4><p>HotSpotè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼šå¯¹è±¡å¤´ï¼ˆHeaderï¼‰ã€å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰å’Œå¯¹é½å¡«å……ï¼ˆPaddingï¼‰ã€‚</p>
<p>HotSpotè™šæ‹Ÿæœºçš„å¯¹è±¡å¤´åŒ…æ‹¬ä¸‰éƒ¨åˆ†ä¿¡æ¯ï¼š<br>1ã€mark word 2ã€å…ƒç±»æŒ‡é’ˆ 3ã€æ•°ç»„é•¿åº¦<br>æ™®é€šå¯¹è±¡å¤´æœ‰ä¸¤ä¸ªåŒºåŸŸï¼ˆ1ï¼Œ2ï¼‰ã€æ•°ç»„å¯¹è±¡å¤´æœ‰ä¸‰ä¸ªåŒºåŸŸï¼ˆ1,2,3ï¼‰</p>
<p><strong>Mark Word</strong></p>
<p>è¿™éƒ¨åˆ†ä¸»è¦å­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ•°æ®ï¼Œå¦‚Hashcodeã€gcåˆ†ä»£å¹´é¾„ã€å¯¹è±¡é”ï¼Œé”çŠ¶æ€æ ‡å¿—ï¼Œåå‘é”ï¼ˆçº¿ç¨‹ï¼‰IDï¼Œåå‘æ—¶é—´ç­‰ç­‰ã€‚mark wordçš„ä½é•¿åº¦ä¸ºJVMçš„ä¸€ä¸ªWordå¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´32ä½JVMçš„Mark wordä¸º32ä½ã€‚</p>
<p>Javaå¯¹è±¡å¤´ä¸€èˆ¬å æœ‰2ä¸ªæœºå™¨ç ï¼ˆ64ä½è™šæ‹Ÿæœºä¸­ï¼Œ1ä¸ªæœºå™¨ç æ˜¯8ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯64bitï¼‰ï¼Œä½†æ˜¯ å¦‚æœå¯¹è±¡æ˜¯æ•°ç»„ç±»å‹ï¼Œåˆ™éœ€è¦3ä¸ªæœºå™¨ç ï¼Œå› ä¸ºJVMè™šæ‹Ÿæœºå¯ä»¥é€šè¿‡Javaå¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯ç¡®å®šJavaå¯¹è±¡çš„å¤§å°ï¼Œä½†æ˜¯æ— æ³•ä»æ•°ç»„çš„å…ƒæ•°æ®æ¥ç¡®è®¤æ•°ç»„çš„å¤§å°ï¼Œæ‰€ä»¥ç”¨ä¸€å—æ¥è®°å½•æ•°ç»„é•¿åº¦ã€‚</p>
<p><strong>æŒ‡å‘ç±»çš„æŒ‡é’ˆ</strong></p>
<p>è¯¥æŒ‡é’ˆåœ¨32ä½JVMçš„é•¿åº¦æ˜¯32Bitï¼Œ64æ˜¯64bit<br>å®ƒä¸»è¦æŒ‡å‘ç±»çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘æ–¹æ³•åŒºä¸­çš„ä½ç½®ã€‚</p>
<p><strong>æ•°ç»„é•¿åº¦</strong></p>
<p>åªæœ‰æ•°ç»„å¯¹è±¡ä¿å­˜äº†è¿™éƒ¨åˆ†æ•°æ®<br>è¯¥æ•°æ®åœ¨32ä½å’Œ64ä½JVMéƒ½æ˜¯32bit</p>
<p>å‚è€ƒï¼š<br>javaå¯¹è±¡å¤´ä»¥åŠæ‰“å°å¯¹è±¡å¤´ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/sumengnan/article/details/125035218">https://blog.csdn.net/sumengnan/article/details/125035218</a><br>javaå¯¹è±¡å¤´ä»¥åŠé”å‡çº§è¿‡ç¨‹ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/Alei777/p/16308553.html">https://www.cnblogs.com/Alei777/p/16308553.html</a></p>
<h4 id="âœ…é”çš„å‡çº§ä¸å¯¹æ¯”"><a href="#âœ…é”çš„å‡çº§ä¸å¯¹æ¯”" class="headerlink" title="âœ…é”çš„å‡çº§ä¸å¯¹æ¯”"></a>âœ…é”çš„å‡çº§ä¸å¯¹æ¯”</h4><p>Java SE 1.6ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†â€œåå‘é”â€å’Œâ€œè½»é‡çº§é”â€ã€‚<br>åœ¨ Java SE 1.6ä¸­ï¼Œé”ä¸€å…±æœ‰4ç§çŠ¶æ€ï¼Œçº§åˆ«ä»ä½åˆ°é«˜ä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶ æ€å’Œé‡é‡çº§é”çŠ¶æ€ï¼Œè¿™å‡ ä¸ªçŠ¶æ€ä¼šéšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ã€‚<br>é”å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§ï¼Œæ„å‘³ç€åå‘é”å‡çº§æˆè½»é‡çº§é”åä¸èƒ½é™çº§æˆåå‘é”ã€‚è¿™ç§é”å‡çº§å´ä¸èƒ½é™çº§çš„ç­–ç•¥ï¼Œç›®çš„æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚</p>
<p><strong>åå‘é”</strong></p>
<p>èƒŒæ™¯ï¼š<br>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒ ä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½è€Œå¼•å…¥äº†åå‘é”ã€‚</p>
<p>åå‘é”åŸç†ï¼š<br>å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—å¹¶è·å–é”æ—¶ï¼Œä¼šåœ¨<strong>å¯¹è±¡å¤´</strong>å’Œ<strong>æ ˆå¸§</strong>ä¸­çš„é”è®°å½•é‡Œå­˜å‚¨é”åå‘çš„çº¿ç¨‹IDï¼Œä»¥åè¯¥çº¿ç¨‹åœ¨è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸éœ€è¦è¿›è¡ŒCASæ“ä½œæ¥åŠ é”å’Œè§£é”ï¼Œåªéœ€ç®€å•åœ°æµ‹è¯•ä¸€ä¸‹å¯¹è±¡å¤´çš„Mark Wordé‡Œæ˜¯å¦å­˜å‚¨ç€æŒ‡å‘å½“å‰çº¿ç¨‹çš„åå‘é”ã€‚å¦‚æœæµ‹è¯•æˆåŠŸï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»è·å¾—äº†é”ã€‚å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œåˆ™éœ€è¦å†æµ‹è¯•ä¸€ä¸‹Mark Wordä¸­åå‘é”çš„æ ‡è¯†æ˜¯å¦è®¾ç½®æˆ1ï¼ˆè¡¨ç¤ºå½“å‰æ˜¯åå‘é”ï¼‰ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨CASç«äº‰é”ï¼›å¦‚æœè®¾ç½®äº†ï¼Œåˆ™å°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´çš„åå‘é”æŒ‡å‘å½“å‰çº¿ç¨‹ã€‚</p>
<p>åå‘é”é‡Šæ”¾å’Œå‡çº§ï¼š<br>åå‘é”ä½¿ç”¨äº†ä¸€ç§ç­‰åˆ°ç«äº‰å‡ºç°æ‰é‡Šæ”¾é”çš„æœºåˆ¶ï¼Œæ‰€ä»¥å½“å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾é”ã€‚<br>åå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼ˆåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰æ­£ åœ¨æ‰§è¡Œçš„å­—èŠ‚ç ï¼‰ã€‚<br>1ã€é¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹<br>2ã€ç„¶åæ£€æŸ¥æŒæœ‰åå‘é”çš„çº¿ç¨‹æ˜¯å¦æ´»ç€ï¼Œå¦‚æœçº¿ç¨‹ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å°†å¯¹è±¡å¤´è®¾ç½®æˆæ— é”çŠ¶æ€ï¼›<br>3ã€å¦‚æœçº¿ç¨‹ä»ç„¶æ´»ç€ï¼Œæ‹¥æœ‰åå‘é”çš„æ ˆä¼šè¢«æ‰§è¡Œï¼Œéå†åå‘å¯¹è±¡çš„é”è®°å½•ï¼Œæ ˆä¸­çš„é”è®°å½•å’Œå¯¹è±¡å¤´çš„Mark Wordè¦ä¹ˆé‡æ–°åå‘äºå…¶ä»–çº¿ç¨‹ï¼Œè¦ä¹ˆæ¢å¤åˆ°æ— é”æˆ–è€…æ ‡è®°å¯¹è±¡ä¸é€‚åˆä½œä¸ºåå‘é”ï¼ˆå‡çº§ä¸ºè½»é‡çº§é”ï¼‰ï¼Œæœ€åå”¤é†’æš‚åœçš„çº¿ç¨‹ã€‚</p>
<p>å…³é—­åå‘é”<br>åå‘é”åœ¨Java 6å’ŒJava 7é‡Œæ˜¯é»˜è®¤å¯ç”¨ï¼Œå¦‚æœä½ ç¡®å®šåº”ç”¨ç¨‹åºé‡Œæ‰€æœ‰çš„é”é€šå¸¸æƒ…å†µä¸‹å¤„äºç«äº‰çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡JVMå‚æ•°å…³é—­åå‘é”ï¼š<br><code>-XX:-UseBiasedLocking=false</code></p>
<p><strong>è½»é‡çº§é”</strong></p>
<p>å‡çº§ä¸ºè½»é‡çº§é”åï¼Œçº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆæ¡¢ä¸­åˆ›å»ºç”¨äºå­˜å‚¨é”è®°å½•çš„ç©ºé—´ï¼Œå¹¶å°†å¯¹è±¡å¤´ä¸­çš„Mark Wordå¤åˆ¶åˆ°é”è®°å½•ä¸­ï¼Œå®˜æ–¹ç§°ä¸ºDisplaced Mark Wordã€‚ç„¶åçº¿ç¨‹å°è¯•ä½¿ç”¨CASå°†å¯¹è±¡å¤´ä¸­çš„Mark Wordæ›¿æ¢ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆã€‚å¦‚æœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå…¶ä»–çº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹ä¾¿å°è¯•ä½¿ç”¨<strong>è‡ªæ—‹</strong>æ¥è·å–é”ã€‚è‡ªæ—‹é”é‡è¯•ä¹‹åå¦‚æœæŠ¢é”ä¾ç„¶å¤±è´¥ï¼ŒåŒæ­¥é”ä¼šå‡çº§è‡³é‡é‡çº§é”ã€‚</p>
<p><strong>é‡é‡çº§é”</strong></p>
<p>è½»é‡çº§é” -&gt; é‡é‡çº§é” çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<p>1 è‹¥å½“å‰åªæœ‰ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œåˆ™è¯¥çº¿ç¨‹å°†é€šè¿‡è‡ªæ—‹è¿›è¡Œç­‰å¾…ã€‚ä½†æ˜¯å½“è‡ªæ—‹è¶…è¿‡ä¸€å®šçš„æ¬¡æ•°æ—¶ï¼Œè½»é‡çº§é”ä¾¿ä¼šå‡çº§ä¸ºé‡é‡çº§é”ï¼ˆé”è†¨èƒ€ï¼‰ã€‚</p>
<p>2 å¦å¤–ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å·²æŒæœ‰é”ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨è‡ªæ—‹ï¼Œè€Œæ­¤æ—¶åˆæœ‰ç¬¬ä¸‰ä¸ªçº¿ç¨‹æ¥è®¿æ—¶ï¼Œè½»é‡çº§é”ä¹Ÿä¼šå‡çº§ä¸ºé‡é‡çº§é”ï¼ˆé”è†¨èƒ€ï¼‰ã€‚</p>
<p>è‡ªæ—‹ä¼šæ¶ˆè€—CPUï¼Œä¸€æ—¦é‡é‡çº§é”ï¼Œå°±ä¸ä¼šæ¢å¤ä¸ºè½»é‡çº§é”ã€‚å½“é”å¤„äºè¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œå…¶ä»–çº¿ç¨‹è¯•å›¾è·å–é”æ—¶ï¼Œ éƒ½ä¼šè¢«é˜»å¡ä½ï¼Œå½“æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åä¼šå”¤é†’è¿™äº›çº¿ç¨‹ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°±ä¼šè¿›è¡Œæ–°ä¸€è½®çš„å¤ºé”ä¹‹äº‰ã€‚</p>
<p><strong>å‡ ç§é”çš„å¯¹æ¯”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">é”	ä¼˜ç‚¹	ç¼ºç‚¹	ä½¿ç”¨åœºæ™¯</span><br><span class="line">åå‘é”	åŠ é”å’Œè§£é”ä¸éœ€è¦é¢å¤–çš„æ¶ˆè€—,å’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•ç›¸æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è·	å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„æ’¤é”€æ¶ˆè€—	é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—åœºæ™¯</span><br><span class="line">è½»é‡çº§é”	ç«äº‰çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜äº†ç¨‹åºçš„å“åº”é€Ÿåº¦	å¦‚æœå§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ï¼Œä¼šè‡ªæ—‹æ¶ˆè€—CPU	è¿½æ±‚å“åº”æ—¶é—´ã€åŒæ­¥å—æ‰§è¡Œéå¸¸å¿«</span><br><span class="line">é‡é‡çº§é”	çº¿ç¨‹ä¸ä½¿ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPU	çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢	è¿½æ±‚ååé‡ã€åŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒå¿«</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒï¼š<br>ã€Šä¹¦ä¸­å†…å®¹ã€‹ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/Hello_mengkebao/article/details/119874999">https://blog.csdn.net/Hello_mengkebao/article/details/119874999</a></p>
<p><strong>æ€»ç»“ï¼šé”çš„å‡çº§è¿‡ç¨‹</strong></p>
<p>JVMä¸€èˆ¬æ˜¯è¿™æ ·ä½¿ç”¨é”å’ŒMark Wordçš„ï¼š</p>
<p>1ï¼Œå½“æ²¡æœ‰è¢«å½“æˆé”æ—¶ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼ŒMark Wordè®°å½•å¯¹è±¡çš„HashCodeï¼Œé”æ ‡å¿—ä½æ˜¯01ï¼Œæ˜¯å¦åå‘é”é‚£ä¸€ä½æ˜¯0ã€‚</p>
<p>2ï¼Œå½“å¯¹è±¡è¢«å½“åšåŒæ­¥é”å¹¶æœ‰ä¸€ä¸ªçº¿ç¨‹AæŠ¢åˆ°äº†é”æ—¶ï¼Œé”æ ‡å¿—ä½è¿˜æ˜¯01ï¼Œä½†æ˜¯å¦åå‘é”é‚£ä¸€ä½æ”¹æˆ1ï¼Œå‰23bitè®°å½•æŠ¢åˆ°é”çš„çº¿ç¨‹idï¼Œè¡¨ç¤ºè¿›å…¥åå‘é”çŠ¶æ€ã€‚</p>
<p>3ï¼Œå½“çº¿ç¨‹Aå†æ¬¡è¯•å›¾æ¥è·å¾—é”æ—¶ï¼ŒJVMå‘ç°åŒæ­¥é”å¯¹è±¡çš„æ ‡å¿—ä½æ˜¯01ï¼Œæ˜¯å¦åå‘é”æ˜¯1ï¼Œä¹Ÿå°±æ˜¯åå‘çŠ¶æ€ï¼ŒMark Wordä¸­è®°å½•çš„çº¿ç¨‹idå°±æ˜¯çº¿ç¨‹Aè‡ªå·±çš„idï¼Œè¡¨ç¤ºçº¿ç¨‹Aå·²ç»è·å¾—äº†è¿™ä¸ªåå‘é”ï¼Œå¯ä»¥æ‰§è¡ŒåŒæ­¥é”çš„ä»£ç ã€‚</p>
<p>4ï¼Œå½“çº¿ç¨‹Bè¯•å›¾è·å¾—è¿™ä¸ªé”æ—¶ï¼ŒJVMå‘ç°åŒæ­¥é”å¤„äºåå‘çŠ¶æ€ï¼Œä½†æ˜¯Mark Wordä¸­çš„çº¿ç¨‹idè®°å½•çš„ä¸æ˜¯Bï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¼šå…ˆç”¨CASæ“ä½œè¯•å›¾è·å¾—é”ï¼Œè¿™é‡Œçš„è·å¾—é”æ“ä½œæ˜¯æœ‰å¯èƒ½æˆåŠŸçš„ï¼Œå› ä¸ºçº¿ç¨‹Aä¸€èˆ¬ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾åå‘é”ã€‚å¦‚æœæŠ¢é”æˆåŠŸï¼Œå°±æŠŠMark Wordé‡Œçš„çº¿ç¨‹idæ”¹ä¸ºçº¿ç¨‹Bçš„idï¼Œä»£è¡¨çº¿ç¨‹Bè·å¾—äº†è¿™ä¸ªåå‘é”ï¼Œå¯ä»¥æ‰§è¡ŒåŒæ­¥é”ä»£ç ã€‚å¦‚æœæŠ¢é”å¤±è´¥ï¼Œåˆ™ç»§ç»­æ‰§è¡Œæ­¥éª¤5ã€‚</p>
<p>5ï¼Œåå‘é”çŠ¶æ€æŠ¢é”å¤±è´¥ï¼Œä»£è¡¨å½“å‰é”æœ‰ä¸€å®šçš„ç«äº‰ï¼Œåå‘é”å°†å‡çº§ä¸ºè½»é‡çº§é”ã€‚JVMä¼šåœ¨å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æ ˆä¸­å¼€è¾Ÿä¸€å—å•ç‹¬çš„ç©ºé—´ï¼Œé‡Œé¢ä¿å­˜æŒ‡å‘å¯¹è±¡é”Mark Wordçš„æŒ‡é’ˆï¼ŒåŒæ—¶åœ¨å¯¹è±¡é”Mark Wordä¸­ä¿å­˜æŒ‡å‘è¿™ç‰‡ç©ºé—´çš„æŒ‡é’ˆã€‚ä¸Šè¿°ä¸¤ä¸ªä¿å­˜æ“ä½œéƒ½æ˜¯CASæ“ä½œï¼Œå¦‚æœä¿å­˜æˆåŠŸï¼Œä»£è¡¨çº¿ç¨‹æŠ¢åˆ°äº†åŒæ­¥é”ï¼Œå°±æŠŠMark Wordä¸­çš„é”æ ‡å¿—ä½æ”¹æˆ00ï¼Œå¯ä»¥æ‰§è¡ŒåŒæ­¥é”ä»£ç ã€‚å¦‚æœä¿å­˜å¤±è´¥ï¼Œè¡¨ç¤ºæŠ¢é”å¤±è´¥ï¼Œç«äº‰å¤ªæ¿€çƒˆï¼Œç»§ç»­æ‰§è¡Œæ­¥éª¤6ã€‚</p>
<p>6ï¼Œè½»é‡çº§é”æŠ¢é”å¤±è´¥ï¼ŒJVMä¼šä½¿ç”¨è‡ªæ—‹é”ï¼Œè‡ªæ—‹é”ä¸æ˜¯ä¸€ä¸ªé”çŠ¶æ€ï¼Œåªæ˜¯ä»£è¡¨ä¸æ–­çš„é‡è¯•ï¼Œå°è¯•æŠ¢é”ã€‚ä»JDK1.7å¼€å§‹ï¼Œè‡ªæ—‹é”é»˜è®¤å¯ç”¨ï¼Œè‡ªæ—‹æ¬¡æ•°ç”±JVMå†³å®šã€‚å¦‚æœæŠ¢é”æˆåŠŸåˆ™æ‰§è¡ŒåŒæ­¥é”ä»£ç ï¼Œå¦‚æœå¤±è´¥åˆ™ç»§ç»­æ‰§è¡Œæ­¥éª¤7ã€‚</p>
<p>7ï¼Œè‡ªæ—‹é”é‡è¯•ä¹‹åå¦‚æœæŠ¢é”ä¾ç„¶å¤±è´¥ï¼ŒåŒæ­¥é”ä¼šå‡çº§è‡³é‡é‡çº§é”ï¼Œé”æ ‡å¿—ä½æ”¹ä¸º10ã€‚åœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼ŒæœªæŠ¢åˆ°é”çš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚</p>
<h3 id="3-AtomicåŸå­æ“ä½œ"><a href="#3-AtomicåŸå­æ“ä½œ" class="headerlink" title="3.AtomicåŸå­æ“ä½œ"></a>3.AtomicåŸå­æ“ä½œ</h3><p>åŸå­æ“ä½œï¼ˆatomic operationï¼‰æ„ä¸ºâ€œä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œâ€ã€‚</p>
<h4 id="âœ…å¤„ç†å™¨å¦‚ä½•å®ç°åŸå­æ“ä½œ"><a href="#âœ…å¤„ç†å™¨å¦‚ä½•å®ç°åŸå­æ“ä½œ" class="headerlink" title="âœ…å¤„ç†å™¨å¦‚ä½•å®ç°åŸå­æ“ä½œ"></a>âœ…å¤„ç†å™¨å¦‚ä½•å®ç°åŸå­æ“ä½œ</h4><p>é¦–å…ˆå¤„ç†å™¨ä¼šè‡ªåŠ¨ä¿è¯<strong>åŸºæœ¬çš„å†…å­˜æ“ä½œçš„åŸå­æ€§</strong>ã€‚å¤„ç†å™¨ä¿è¯ä»ç³»ç»Ÿå†…å­˜ä¸­è¯»å–æˆ–è€…å†™å…¥ä¸€ä¸ªå­—èŠ‚æ˜¯åŸå­çš„ï¼Œæ„æ€æ˜¯å½“ä¸€ä¸ªå¤„ç†å™¨è¯»å–ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è¿™ä¸ªå­—èŠ‚çš„å†…å­˜åœ°å€ã€‚Pentium 6å’Œæœ€æ–°çš„å¤„ç†å™¨èƒ½è‡ªåŠ¨ä¿è¯å•å¤„ç†å™¨å¯¹åŒä¸€ä¸ªç¼“å­˜è¡Œé‡Œè¿›è¡Œ16/32/64ä½çš„æ“ä½œæ˜¯åŸå­çš„ã€‚</p>
<p>ä½†æ˜¯<strong>å¤æ‚çš„å†…å­˜æ“ä½œå¤„ç†å™¨æ˜¯ä¸èƒ½è‡ªåŠ¨ä¿è¯å…¶åŸå­æ€§çš„</strong>ï¼Œæ¯”å¦‚è·¨æ€»çº¿å®½åº¦ã€è·¨å¤šä¸ªç¼“å­˜è¡Œå’Œè·¨é¡µè¡¨çš„è®¿é—®ã€‚ä½†æ˜¯ï¼Œå¤„ç†å™¨æä¾›<strong>æ€»çº¿é”å®š</strong>å’Œ<strong>ç¼“å­˜é”å®š</strong>ä¸¤ä¸ªæœºåˆ¶æ¥ä¿è¯å¤æ‚å†…å­˜æ“ä½œçš„åŸå­æ€§ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ä¸€ç‚¹ï¼ša++æ˜¯ä¸‰æ­¥æ“ä½œï¼ˆå–æ•°ï¼ŒåŠ ä¸€ï¼Œèµ‹å€¼ï¼‰ï¼Œè€Œè®¡ç®—æœºå’ŒJavaéƒ½åªä¿è¯ä¸€æ­¥æ“ä½œçš„åŸå­æ€§ï¼Œå¤šæ­¥æ“ä½œæ˜¯ä¸ä¿è¯åŸå­æ€§çš„ã€‚æ‰€ä»¥a++ä¸æ˜¯åŸå­æ€§çš„ã€‚æƒ³è¦ä¿è¯è¯»æ”¹å†™å…±äº«å˜é‡çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œå°±å¿…é¡»ä¿è¯CPU1è¯»æ”¹å†™å…±äº«å˜é‡çš„æ—¶å€™ï¼ŒCPU2ä¸èƒ½æ“ä½œç¼“å­˜äº†è¯¥å…±äº«å˜é‡å†…å­˜åœ°å€çš„ç¼“å­˜ã€‚</p>
<p>âš ï¸volitaleä¿è¯å¯è§æ€§ä¸ºä»€ä¹ˆä¸èƒ½å®ç°i++çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ</p>
<blockquote>
<p>å¯è§æ€§æ˜¯æŒ‡ç¬æ—¶å¯è§æ€§ï¼Œæ˜¯æŒ‡é‚£ä¸€æ—¶åˆ»çš„å¯è§æ€§ã€‚æ”¾åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œå°±æ˜¯æŒ‡å½“çº¿ç¨‹1æŠŠï¼ˆa=0ï¼Œa++ï¼‰çš„ç»“æœa=1åˆ·å›åˆ°ä¸»å­˜ä¸­æ—¶ï¼Œæ‰€æœ‰ç›®å‰æœ‰aè¿™ä¸ªå˜é‡çš„ç¼“å­˜æ­¤æ—¶éƒ½åº”è¯¥å˜ä¸ºa=1ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŸæ¥çš„å€¼ã€‚æ‰€ä»¥ï¼Œçº¿ç¨‹2ä¹Ÿæ‰§è¡ŒåŠ ä¸€åï¼Œè¿˜æ²¡æœ‰å†™å›åˆ°ç¼“å­˜ä¸­ï¼Œä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼Œçº¿ç¨‹2ç¼“å­˜é‡Œé¢çš„a=0è¢«ç½®ä¸ºæ— æ•ˆï¼Œæ‰€ä»¥çº¿ç¨‹2åˆä»ä¸»å­˜ä¸­å–å¾—a=1æ›¿æ¢æ‰äº†è‡ªå·±ç¼“å­˜ä¸­çš„a=0ï¼Œç„¶åçº¿ç¨‹2å°†a=1å†™å…¥è‡ªå·±çš„ç¼“å­˜ä¸­ï¼Œéšåa=1åˆä¸€æ¬¡è¢«ç«‹åˆ»åˆ·å›åˆ°ä¸»å­˜ä¸­ã€‚æœ€åä¸»å­˜ä¸­çš„å€¼è¿˜æ˜¯a=1ã€‚</p>
</blockquote>
<p><strong>æ€»çº¿é”</strong></p>
<p>æ€»çº¿é”å°±æ˜¯ä½¿ç”¨å¤„ç†å™¨æä¾›çš„ä¸€ä¸ªLOCKï¼ƒä¿¡å·ï¼Œå½“ä¸€ä¸ªå¤„ç†å™¨åœ¨æ€»çº¿ä¸Šè¾“å‡ºæ­¤ä¿¡å·æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨çš„è¯·æ±‚å°†è¢«é˜»å¡ä½ï¼Œé‚£ä¹ˆè¯¥å¤„ç†å™¨å¯ä»¥ç‹¬å å…±äº«å†…å­˜ã€‚</p>
<p><strong>ç¼“å­˜é”</strong></p>
<p>æ€»çº¿é”å®šæŠŠCPUå’Œå†…å­˜ä¹‹é—´çš„é€šä¿¡é”ä½äº†ï¼Œè¿™ä½¿å¾—é”å®šæœŸé—´ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½æ“ä½œå…¶ä»–å†…å­˜åœ°å€çš„æ•°æ®ï¼Œæ‰€ä»¥æ€»çº¿é”å®šçš„å¼€é”€æ¯”è¾ƒå¤§ã€‚</p>
<p>é¢‘ç¹ä½¿ç”¨çš„å†…å­˜ä¼šç¼“å­˜åœ¨å¤„ç†å™¨çš„L1ã€L2å’ŒL3é«˜é€Ÿç¼“å­˜é‡Œï¼Œé‚£ä¹ˆåŸå­æ“ä½œå°±å¯ä»¥ç›´æ¥åœ¨å¤„ç†å™¨å†…éƒ¨ç¼“å­˜ä¸­è¿›è¡Œï¼Œå¹¶ä¸éœ€è¦å£°æ˜æ€»çº¿é”ï¼Œåœ¨Pentium 6å’Œç›®å‰çš„å¤„ç†å™¨ä¸­å¯ä»¥ä½¿ç”¨â€œç¼“å­˜é”å®šâ€çš„æ–¹å¼æ¥å®ç°å¤æ‚çš„åŸå­æ€§ã€‚</p>
<p>â€œç¼“å­˜é”å®šâ€æ˜¯æŒ‡å†…å­˜åŒºåŸŸå¦‚æœè¢«ç¼“å­˜åœ¨å¤„ç†å™¨çš„ç¼“å­˜è¡Œä¸­ï¼Œå¹¶ä¸”åœ¨Lockæ“ä½œæœŸé—´è¢«é”å®šï¼Œé‚£ä¹ˆå½“å®ƒæ‰§è¡Œé”æ“ä½œå›å†™åˆ°å†…å­˜æ—¶ï¼Œå¤„ç†å™¨ä¸åœ¨æ€»çº¿ä¸Šå£°è¨€LOCKï¼ƒä¿¡å·ï¼Œè€Œæ˜¯ä¿®æ”¹å†…éƒ¨çš„å†…å­˜åœ°å€ï¼Œå¹¶å…è®¸å®ƒçš„ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå› ä¸º<strong>ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶ä¼šé˜»æ­¢åŒæ—¶ä¿®æ”¹ç”±ä¸¤ä¸ªä»¥ä¸Šå¤„ç†å™¨ç¼“å­˜çš„å†…å­˜åŒºåŸŸæ•°æ®</strong>ï¼Œå½“å…¶ä»–å¤„ç†å™¨å›å†™å·²è¢«é”å®šçš„ç¼“å­˜è¡Œçš„æ•°æ®æ—¶ï¼Œä¼šä½¿ç¼“å­˜è¡Œæ— æ•ˆã€‚</p>
<p>ä¸èƒ½ä½¿ç”¨ç¼“å­˜é”çš„æƒ…å†µï¼š<br>1ã€ç¬¬ä¸€ç§æƒ…å†µæ˜¯ï¼šå½“æ“ä½œçš„æ•°æ®ä¸èƒ½è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œæˆ–æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œã€‚<br>2ã€æœ‰äº›å¤„ç†å™¨ä¸æ”¯æŒç¼“å­˜é”å®š</p>
<h4 id="âœ…javaå¦‚ä½•å®ç°åŸå­æ“ä½œ"><a href="#âœ…javaå¦‚ä½•å®ç°åŸå­æ“ä½œ" class="headerlink" title="âœ…javaå¦‚ä½•å®ç°åŸå­æ“ä½œ"></a>âœ…javaå¦‚ä½•å®ç°åŸå­æ“ä½œ</h4><p><strong>å¾ªç¯CAS</strong></p>
<p>CAS å…¨ç§°æ˜¯ compare and swapï¼Œæ˜¯ä¸€ç§ç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®ç°åŒæ­¥åŠŸèƒ½çš„æœºåˆ¶ã€‚CAS æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€“ å†…å­˜ä½ç½®ã€é¢„æœŸæ•°å€¼å’Œæ–°å€¼ã€‚CAS çš„å®ç°é€»è¾‘æ˜¯å°†å†…å­˜ä½ç½®å¤„çš„æ•°å€¼ä¸é¢„æœŸæ•°å€¼ç›¸æ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜ä½ç½®å¤„çš„å€¼æ›¿æ¢ä¸ºæ–°å€¼ã€‚è‹¥ä¸ç›¸ç­‰ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œã€‚ï¼ˆåƒæ”¹å¯†ç éœ€è¦å…ˆéªŒè¯æ—§å¯†ç ä¸€æ ·ï¼‰</p>
<p>JVMä¸­çš„CASæ“ä½œæ­£æ˜¯åˆ©ç”¨äº†å¤„ç†å™¨æä¾›çš„CMPXCHGæŒ‡ä»¤å®ç°çš„ã€‚è‡ªæ—‹CASå®ç°çš„åŸºæœ¬æ€è·¯å°±æ˜¯å¾ªç¯è¿›è¡ŒCASæ“ä½œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚</p>
<p>ä»Java 1.5å¼€å§‹ï¼ŒJDKçš„å¹¶å‘åŒ…é‡Œæä¾›äº†ä¸€äº›ç±»æ¥æ”¯æŒåŸå­æ“ä½œï¼Œå¦‚AtomicBooleanï¼ˆç”¨åŸå­æ–¹å¼æ›´æ–°çš„booleanå€¼ï¼‰ã€AtomicIntegerï¼ˆç”¨åŸå­æ–¹å¼æ›´æ–°çš„intå€¼ï¼‰å’ŒAtomicLongï¼ˆç”¨åŸå­æ–¹å¼æ›´æ–°çš„longå€¼ï¼‰ã€‚è¿™äº›åŸå­åŒ…è£…ç±»è¿˜æä¾›äº†æœ‰ç”¨çš„å·¥å…·æ–¹æ³•ï¼Œæ¯”å¦‚ä»¥åŸå­çš„æ–¹å¼å°†å½“å‰å€¼è‡ªå¢1å’Œè‡ªå‡1ã€‚</p>
<p>CASä»ç„¶å­˜åœ¨<strong>ä¸‰å¤§é—®é¢˜</strong>ã€‚ABAé—®é¢˜ï¼Œå¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ï¼Œä»¥åŠåªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œã€‚</p>
<p>1ã€ABAé—®é¢˜<br>CASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™ï¼Œæ£€æŸ¥å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†ã€‚ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ 1ï¼Œé‚£ä¹ˆAâ†’Bâ†’Aå°±ä¼šå˜æˆ1Aâ†’2Bâ†’3Aã€‚</p>
<p>ä»Java 1.5å¼€å§‹ï¼ŒJDKçš„AtomicåŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±»AtomicStampedReferenceæ¥è§£å†³ABAé—®é¢˜ã€‚è¿™ä¸ªç±»çš„compareAndSetæ–¹æ³•çš„ä½œç”¨æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚</p>
<p>2ã€å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§<br>è‡ªæ—‹CASå¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™CPUå¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚</p>
<p>3ã€åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ<br>å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚è¿˜æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªå…±äº«å˜é‡iï¼2ï¼Œj=aï¼Œåˆå¹¶ä¸€ä¸‹ij=2aï¼Œç„¶åç”¨CASæ¥æ“ä½œijã€‚ä»Java 1.5å¼€å§‹ï¼ŒJDKæä¾›äº†AtomicReferenceç±»æ¥ä¿è¯<strong>å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§</strong>ï¼Œå°±å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡ŒCASæ“ä½œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private AtomicInteger count = new AtomicInteger(0);</span><br><span class="line">count.incrementAndGet(); //åŸå­è‡ªå¢</span><br><span class="line">int i = count.get();</span><br><span class="line">boolean suc = count.compareAndSet(i, ++i); //cas</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨é”å®ç°åŸå­æ“ä½œ</strong></p>
<p>ä½¿ç”¨é”æœºåˆ¶å®ç°åŸå­æ“ä½œé”æœºåˆ¶ä¿è¯äº†åªæœ‰è·å¾—é”çš„çº¿ç¨‹æ‰èƒ½å¤Ÿæ“ä½œé”å®šçš„å†…å­˜åŒºåŸŸã€‚JVMå†…éƒ¨å®ç°äº†å¾ˆå¤šç§é”æœºåˆ¶ï¼Œæœ‰åå‘é”ã€è½»é‡çº§é”å’Œäº’æ–¥é”ã€‚æœ‰æ„æ€çš„æ˜¯é™¤äº†åå‘é”ï¼ŒJVMå®ç°é”çš„æ–¹å¼éƒ½ç”¨äº†å¾ªç¯CASï¼Œå³å½“ä¸€ä¸ªçº¿ç¨‹æƒ³è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥è·å–é”ï¼Œå½“å®ƒé€€å‡ºåŒæ­¥å—çš„æ—¶å€™ä½¿ç”¨å¾ªç¯CASé‡Šæ”¾é”ã€‚</p>
<p>å‚è€ƒï¼š<br>ä¹¦çš„ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/412363896">https://zhuanlan.zhihu.com/p/412363896</a><br>jdkä¸­çš„åŸå­æ“ä½œç±»ï¼š<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a47285790467">https://www.jianshu.com/p/a47285790467</a><br>casåŸç†ã€synchronizedæ‚²è§‚é”å’Œcasä¹è§‚é”ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/huansky/p/15746624.html">https://www.cnblogs.com/huansky/p/15746624.html</a></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å‡ ä¸ªjavaå®ç°å¤šçº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼š<br>1ã€synchronizedåŠ é”<br>2ã€Volatileå…³é”®å­—<br>3ã€CAS</p>
<h2 id="ç¬¬ä¸‰ç« -Javaå†…å­˜æ¨¡å‹"><a href="#ç¬¬ä¸‰ç« -Javaå†…å­˜æ¨¡å‹" class="headerlink" title="ç¬¬ä¸‰ç«  Javaå†…å­˜æ¨¡å‹"></a>ç¬¬ä¸‰ç«  Javaå†…å­˜æ¨¡å‹</h2><h3 id="1-javaå†…å­˜æ¨¡å‹çš„åŸºç¡€"><a href="#1-javaå†…å­˜æ¨¡å‹çš„åŸºç¡€" class="headerlink" title="1.javaå†…å­˜æ¨¡å‹çš„åŸºç¡€"></a>1.javaå†…å­˜æ¨¡å‹çš„åŸºç¡€</h3><h4 id="âœ…å¹¶å‘ç¼–ç¨‹çš„ä¸¤ä¸ªå…³é”®é—®é¢˜"><a href="#âœ…å¹¶å‘ç¼–ç¨‹çš„ä¸¤ä¸ªå…³é”®é—®é¢˜" class="headerlink" title="âœ…å¹¶å‘ç¼–ç¨‹çš„ä¸¤ä¸ªå…³é”®é—®é¢˜"></a>âœ…å¹¶å‘ç¼–ç¨‹çš„ä¸¤ä¸ªå…³é”®é—®é¢˜</h4><p>1ã€çº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡ï¼š<br>é€šä¿¡æ˜¯æŒ‡çº¿ç¨‹ä¹‹é—´ä»¥ä½•ç§æœºåˆ¶æ¥äº¤æ¢ä¿¡æ¯<br>é€šä¿¡æœºåˆ¶æœ‰ä¸¤ç§ï¼šå…±äº«å†…å­˜å’Œæ¶ˆæ¯ä¼ é€’</p>
<p>2ã€çº¿ç¨‹ä¹‹é—´å¦‚ä½•åŒæ­¥ï¼š<br>åŒæ­¥ï¼šæŒ‡ç¨‹åºä¸­ç”¨äºæ§åˆ¶ä¸åŒçº¿ç¨‹é—´æ“ä½œå‘ç”Ÿç›¸å¯¹é¡ºåºçš„æœºåˆ¶</p>
<p>javaçš„å¹¶å‘é‡‡ç”¨çš„æ˜¯å…±äº«å†…å­˜æ¨¡å‹ï¼Œjavaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æ€»æ˜¯éšå¼è¿›è¡Œï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹ç¨‹åºå‘˜å®Œå…¨é€æ˜ã€‚</p>
<h4 id="âœ…javaå†…å­˜æ¨¡å‹"><a href="#âœ…javaå†…å­˜æ¨¡å‹" class="headerlink" title="âœ…javaå†…å­˜æ¨¡å‹"></a>âœ…javaå†…å­˜æ¨¡å‹</h4><p>å †å†…å­˜ï¼šå®ä¾‹åŸŸã€é™æ€åŸŸã€æ•°ç»„å…ƒç´ ï¼›åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚<br>æ ˆå†…å­˜ï¼šå±€éƒ¨å˜é‡ã€æ–¹æ³•å®šä¹‰å‚æ•°ã€å¼‚å¸¸å¤„ç†å™¨å‚æ•°ï¼›ä¸åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œæ²¡æœ‰å†…å­˜å¯è§æ€§é—®é¢˜ã€‚</p>
<p>Javaçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç”±Javaå†…å­˜æ¨¡å‹(JMM)æ§åˆ¶ï¼ŒJMMå†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§</p>
<p>çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜(æŠ½è±¡æ¦‚å¿µ)ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚</p>
<p>JMMé€šè¿‡æ§åˆ¶ä¸»å†…å­˜ä¸æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¹‹é—´çš„äº¤äº’ï¼Œæ¥ä¸ºJavaç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯<br>ä¸¤ä¸ªçº¿ç¨‹è¦é€šä¿¡ï¼Œè¦ç»å†ä¸‹é¢2ä¸ªæ­¥éª¤ï¼š<br>çº¿ç¨‹AæŠŠæœ¬åœ°å†…å­˜Aä¸­æ›´æ–°è¿‡çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­å»ã€‚<br>çº¿ç¨‹Båˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aä¹‹å‰å·²æ›´æ–°è¿‡çš„å…±äº«å˜é‡</p>
<h4 id="âœ…ä»æºä»£ç åˆ°æŒ‡ä»¤åºåˆ—çš„é‡æ’åº"><a href="#âœ…ä»æºä»£ç åˆ°æŒ‡ä»¤åºåˆ—çš„é‡æ’åº" class="headerlink" title="âœ…ä»æºä»£ç åˆ°æŒ‡ä»¤åºåˆ—çš„é‡æ’åº"></a>âœ…ä»æºä»£ç åˆ°æŒ‡ä»¤åºåˆ—çš„é‡æ’åº</h4><p>åœ¨æ‰§è¡Œç¨‹åºæ—¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åº</p>
<p>é‡æ’åºåˆ†3ç§ç±»å‹ï¼Œç¬¬ä¸€ç§å±äºç¼–è¯‘å™¨é‡æ’ï¼Œåä¸¤ç§å±äºå¤„ç†å™¨é‡æ’ï¼š<br>ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åº<br>æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åº<br>å†…å­˜ç³»ç»Ÿçš„é‡æ’åº</p>
<p>JMMé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼ˆæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼‰ï¼Œæä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<p>å¤„ç†å™¨åˆ©ç”¨å†™ç¼“å†²åŒºæ¥ä¸´æ—¶ä¿å­˜å‘å†…å­˜å†™å…¥çš„æ•°æ®ã€‚ä½†æ˜¯ï¼Œç”±äºå†™ç¼“å†²åŒºä»…å¯¹è‡ªå·±çš„å¤„ç†å™¨å¯è§ï¼Œå®ƒä¼šå¯¼è‡´å¤„ç†å™¨æ‰§è¡Œå†…å­˜æ“ä½œçš„é¡ºåºå¯èƒ½ä¼šä¸å†…å­˜å®é™…çš„æ“ä½œæ‰§è¡Œé¡ºåºä¸ä¸€è‡´ã€‚ä¾‹å¦‚a=1ï¼Œå…ˆå†™åœ¨ç¼“å†²åŒºï¼Œç„¶åä¸‹ä¸€ä¸ªè¯­å¥ç”¨äº†aï¼Œç„¶åç¼“å†²åŒºæ‰å°†a=1å†™å…¥ä¸»å†…å­˜ã€‚è¿™å°±ç®—é‡æ’åºäº†ã€‚</p>
<h4 id="âœ…happens-before"><a href="#âœ…happens-before" class="headerlink" title="âœ…happens-before"></a>âœ…happens-before</h4><p>JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ‰§è¡Œçš„ç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»è¦å­˜åœ¨happens-beforeå…³ç³»ï¼ˆä¸€ç§é˜è¿°å†…å­˜å¯è§æ€§çš„æ¦‚å¿µï¼‰ã€‚å°±æ˜¯è¦æ±‚å‰ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå¯¹åä¸€ä¸ªæ“ä½œå¯è§ã€‚å¹¶ä¸æ„å‘³ç€æ“ä½œAå°±ä¸€å®šåœ¨æ“ä½œBä¹‹å‰æ‰§è¡Œã€‚</p>
<p>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚<br>ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚<br>volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™ï¼Œhappens-beforeäºä»»æ„åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»</p>
<h3 id="2-é‡æ’åº"><a href="#2-é‡æ’åº" class="headerlink" title="2.é‡æ’åº"></a>2.é‡æ’åº</h3><p>é‡æ’åºæ˜¯æŒ‡ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†ä¼˜åŒ–ç¨‹åºæ€§èƒ½è€Œå¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œé‡æ–°æ’åºçš„ä¸€ç§æ‰‹æ®µ</p>
<h4 id="âœ…æ•°æ®ä¾èµ–æ€§"><a href="#âœ…æ•°æ®ä¾èµ–æ€§" class="headerlink" title="âœ…æ•°æ®ä¾èµ–æ€§"></a>âœ…æ•°æ®ä¾èµ–æ€§</h4><p>å¦‚æœä¸¤ä¸ªæ“ä½œè®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œä¸”è¿™ä¸¤ä¸ªæ“ä½œä¸­æœ‰ä¸€ä¸ªä¸ºå†™æ“ä½œï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å°±å­˜åœ¨æ•°æ®ä¾èµ–æ€§ã€‚<br>æ•°æ®ä¾èµ–å¯åˆ†ä¸ºï¼šè¯»åå†™ã€å†™åè¯»ã€å†™åå†™ã€‚</p>
<p>ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šæ”¹å˜å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„ä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>æ•°æ®ä¾èµ–æ€§ä»…é’ˆå¯¹å•ä¸ªå¤„ç†å™¨ä¸­æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å’Œå•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„æ“ä½œï¼Œä¸åŒå¤„ç†å™¨ä¹‹é—´å’Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§ä¸è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è€ƒè™‘</p>
<h4 id="âœ…as-if-serialè¯­ä¹‰"><a href="#âœ…as-if-serialè¯­ä¹‰" class="headerlink" title="âœ…as-if-serialè¯­ä¹‰"></a>âœ…as-if-serialè¯­ä¹‰</h4><p>ä¸€ä¸ªæ¦‚å¿µï¼Œæ„æ€æ˜¯ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹çš„ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜</p>
<p>ä¸ºäº†éµå®ˆas-if-serialè¯­ä¹‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºã€‚</p>
<p>æ„æ€å°±æ˜¯ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æé«˜å•çº¿ç¨‹çš„å¹¶è¡Œåº¦ï¼Œä¼šå¯¹æ²¡æœ‰ä¾èµ–å…³ç³»çš„æ“ä½œé‡æ’åºï¼Œä½†æ˜¯ä¸å½±å“ç»“æœå’Œå¯è§æ€§ã€‚</p>
<h4 id="âœ…é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“"><a href="#âœ…é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“" class="headerlink" title="âœ…é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“"></a>âœ…é‡æ’åºå¯¹å¤šçº¿ç¨‹çš„å½±å“</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class ReorderExample &#123;</span><br><span class="line">    int a = 0;</span><br><span class="line">    boolean flag = false;</span><br><span class="line">    public void writer() &#123;</span><br><span class="line">        a = 1; // 1</span><br><span class="line">        flag = true; // 2</span><br><span class="line">    &#125;</span><br><span class="line">    Public void reader() &#123;</span><br><span class="line">        if (flag) &#123; // 3</span><br><span class="line">        int i = a * a; // 4</span><br><span class="line">    â€¦â€¦</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBï¼ŒAé¦–å…ˆæ‰§è¡Œwriter()æ–¹æ³•ï¼ŒéšåBçº¿ç¨‹æ¥ç€æ‰§è¡Œreader()æ–¹æ³•.</p>
<p>æ“ä½œ1å’Œæ“ä½œ2æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œä¸”æ“ä½œ3å’Œæ“ä½œ4æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¹Ÿå¯ä»¥å¯¹è¿™ä¸¤å¯¹æ“ä½œé‡æ’åº.</p>
<p>å¯¹çº¿ç¨‹Açš„ä¸¤ä¸ªæ“ä½œè¿›è¡Œé‡æ’åºï¼š<br>1ã€çº¿ç¨‹Aé¦–å…ˆå†™æ ‡è®°å˜é‡flag<br>2ã€éšåçº¿ç¨‹Bè¯»è¿™ä¸ªå˜é‡ã€‚ç”±äºæ¡ä»¶åˆ¤æ–­ä¸ºçœŸï¼Œçº¿ç¨‹Bå°†è¯»å–å˜é‡a<br>3ã€æ­¤æ—¶ï¼Œå˜é‡aè¿˜æ²¡æœ‰è¢«çº¿ç¨‹Aå†™å…¥ï¼Œå¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰è¢«é‡æ’åºç ´å</p>
<p>å¯¹çº¿ç¨‹Bçš„ä¸¤ä¸ªæ“ä½œè¿›è¡Œé‡æ’åºï¼š<br>1ã€ç”±äºæ“ä½œ3å’Œæ“ä½œ4å­˜åœ¨æ§åˆ¶ä¾èµ–å…³ç³»ï¼Œæ‰§è¡Œçº¿ç¨‹Bçš„å¤„ç†å™¨å¯æå‰è¯»å–å¹¶è®¡ç®—a*a<br>2ã€ç„¶åæŠŠè®¡ç®—ç»“æœä¸´æ—¶ä¿å­˜åˆ°ä¸€ä¸ªåä¸ºé‡æ’åºç¼“å†²(Reorder Bufferï¼ŒROB)çš„ç¡¬ä»¶ç¼“å­˜ä¸­<br>3ã€å½“æ“ä½œ3çš„æ¡ä»¶åˆ¤æ–­ä¸ºçœŸæ—¶ï¼Œå°±æŠŠè¯¥è®¡ç®—ç»“æœå†™å…¥å˜é‡iä¸­ï¼Œå¤šçº¿ç¨‹ç¨‹åºçš„è¯­ä¹‰è¢«é‡æ’åºç ´å</p>
<h3 id="3-é¡ºåºä¸€è‡´æ€§"><a href="#3-é¡ºåºä¸€è‡´æ€§" class="headerlink" title="3.é¡ºåºä¸€è‡´æ€§"></a>3.é¡ºåºä¸€è‡´æ€§</h3><p>æ•°æ®ç«äº‰çš„å®šä¹‰ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å†™ä¸€ä¸ªå˜é‡ï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¯»åŒä¸€ä¸ªå˜é‡ï¼Œè€Œä¸”å†™å’Œè¯»æ²¡æœ‰é€šè¿‡åŒæ­¥æ¥æ’åº</p>
<p>é¡ºåºä¸€è‡´æ€§ï¼šå¦‚æœç¨‹åºæ˜¯æ­£ç¡®åŒæ­¥çš„ï¼Œç¨‹åºçš„æ‰§è¡Œå°†å…·æœ‰é¡ºåºä¸€è‡´æ€§(å³ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒ)ã€æ˜¯ä¸€ä¸ªç†æƒ³åŒ–çš„æ¦‚å¿µã€‘</p>
<h4 id="âœ…é¡ºåºä¸€è‡´æ€§æ¨¡å‹"><a href="#âœ…é¡ºåºä¸€è‡´æ€§æ¨¡å‹" class="headerlink" title="âœ…é¡ºåºä¸€è‡´æ€§æ¨¡å‹"></a>âœ…é¡ºåºä¸€è‡´æ€§æ¨¡å‹</h4><p>åœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ï¼ˆç†è®ºå‚è€ƒæ¨¡å‹ï¼‰ä¸­ï¼ˆä¸ç®¡æœ‰æ²¡æœ‰åŒæ­¥ï¼‰ï¼š<br>ä»»æ„æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿æ¥åˆ°å†…å­˜ã€‚<br>ä¸€ä¸ªçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œæŒ‰ç¨‹åºçš„é¡ºåºä¸²è¡Œæ‰§è¡Œã€‚<br>æ¯ä¸ªæ“ä½œå¿…é¡»ç«‹å³å¯¹ä»»æ„çº¿ç¨‹å¯è§ã€‚<br>æ‰€æœ‰çº¿ç¨‹éƒ½åªèƒ½çœ‹åˆ°ä¸€ä¸ªä¸€è‡´çš„æ•´ä½“æ‰§è¡Œé¡ºåºã€‚</p>
<blockquote>
<p>JMMä¸­æ²¡æœ‰ä¸Šè¿°ä¿è¯ã€‚æœªåŒæ­¥ç¨‹åºåœ¨JMMä¸­ä¸ä½†æ•´ä½“çš„æ‰§è¡Œé¡ºåºæ˜¯æ— åºçš„ï¼Œè€Œä¸”æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ“ä½œæ‰§è¡Œé¡ºåºä¹Ÿå¯èƒ½ä¸ä¸€è‡´</p>
</blockquote>
<h4 id="âœ…åŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ"><a href="#âœ…åŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ" class="headerlink" title="âœ…åŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ"></a>âœ…åŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ</h4><p>åœ¨JMMä¸­ï¼Œä¸´ç•ŒåŒºï¼ˆä¸€ä¸ªåŒæ­¥å—å„¿ï¼‰å†…çš„ä»£ç å¯ä»¥é‡æ’åº(å› ä¸ºJMMç›®çš„æ˜¯åœ¨ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå°½å¯èƒ½ä¼˜åŒ–ç¼–è¯‘å™¨å’Œå¤„ç†å™¨)ã€‚</p>
<p>ç»“æœæ˜¯ï¼šé‡æ’åºæé«˜äº†æ‰§è¡Œæ•ˆç‡ï¼Œè€Œä¸”æ²¡æœ‰æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚</p>
<h4 id="âœ…æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ"><a href="#âœ…æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ" class="headerlink" title="âœ…æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ"></a>âœ…æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œæ•ˆæœ</h4><p>JMMä¸ä¿è¯æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´ï¼ˆä¸€è‡´ä¹Ÿæ²¡æ„ä¹‰ï¼‰ã€‚å› ä¸ºå¦‚æœæƒ³è¦ä¿è¯æ‰§è¡Œç»“æœä¸€è‡´ï¼ŒJMMéœ€è¦ç¦æ­¢å¤§é‡çš„å¤„ç†å™¨å’Œç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œè¿™å¯¹ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ä¼šäº§ç”Ÿå¾ˆå¤§çš„å½±å“ã€‚</p>
<p>JMMä¸ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºé¡ºåºæ‰§è¡Œã€‚æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ“ä½œé¡ºåºå¯èƒ½ä¸ä¸€è‡´ã€‚æ‰§è¡Œé¡ºåºå¯èƒ½æ˜¯ï¼š2-3-4-1ï¼Œè¯­ä¹‰è¢«ç ´åã€‚å¯èƒ½æ˜¯4çš„å³è¾¹-1-2-3-4çš„å·¦è¾¹ï¼Œè¯­ä¹‰è¢«ç ´åã€‚</p>
<h4 id="âœ…å¤„ç†å™¨æ€»çº¿äº‹åŠ¡"><a href="#âœ…å¤„ç†å™¨æ€»çº¿äº‹åŠ¡" class="headerlink" title="âœ…å¤„ç†å™¨æ€»çº¿äº‹åŠ¡"></a>âœ…å¤„ç†å™¨æ€»çº¿äº‹åŠ¡</h4><p>æ€»çº¿äº‹åŠ¡åŒ…æ‹¬è¯»äº‹åŠ¡ï¼ˆå†…å­˜-å¤„ç†å™¨ï¼‰å’Œå†™äº‹åŠ¡ï¼ˆå¤„ç†å™¨-å†…å­˜ï¼‰ï¼Œä¸­é—´éƒ½è¦é€šè¿‡æ€»çº¿ï¼Œæ€»çº¿ä¼šåŒæ­¥è¯•å›¾å¹¶å‘ä½¿ç”¨æ€»çº¿çš„äº‹åŠ¡ï¼Œä¸€æ¬¡åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ“ä½œæ€»çº¿è®¿é—®å†…å­˜ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸€æ¬¡æœ€å¤šåªæœ‰ä¸€ä¸ªå¤„ç†å™¨å¯ä»¥è®¿é—®å†…å­˜ï¼Œè¿™ä¿è¯äº†å•ä¸ªæ€»çº¿äº‹åŠ¡ä¹‹ä¸­çš„å†…å­˜è¯»å†™ï¼ˆè¯»è·Ÿå†™ï¼Œä¸æ˜¯i++ï¼‰å…·æœ‰åŸå­æ€§ã€‚</p>
<p>ä½†æ˜¯ï¼š32ä½çš„å¤„ç†å™¨ä¸Šï¼Œå¯¹longå‹å’Œdoubleå‹è¿™ä¿©64ä½çš„æ•°æ®çš„å†™æ“ä½œæ‹†åˆ†æˆäº†ä¸¤ä¸ªå†™äº‹åŠ¡ï¼Œä¼šåˆ†é…åœ¨ä¸åŒçš„æ€»çº¿äº‹åŠ¡ä¸­æ‰§è¡Œã€‚æ‰€ä»¥ä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<h3 id="4-volatileçš„å†…å­˜è¯­ä¹‰"><a href="#4-volatileçš„å†…å­˜è¯­ä¹‰" class="headerlink" title="4.volatileçš„å†…å­˜è¯­ä¹‰"></a>4.volatileçš„å†…å­˜è¯­ä¹‰</h3><h4 id="âœ…volatileçš„ç‰¹æ€§ï¼š"><a href="#âœ…volatileçš„ç‰¹æ€§ï¼š" class="headerlink" title="âœ…volatileçš„ç‰¹æ€§ï¼š"></a>âœ…volatileçš„ç‰¹æ€§ï¼š</h4><p>1ã€å¯è§æ€§ï¼šå¯¹volatileå˜é‡çš„å•ä¸ªè¯»å†™ï¼Œç›¸å½“äºæ˜¯ç”¨åŒä¸€ä¸ªé”å¯¹å•ä¸ªè¯»å†™æ–¹æ³•åšäº†åŒæ­¥ã€‚å¯¹volatileå˜é‡çš„è¯»ï¼Œæ€»èƒ½çœ‹åˆ°æœ€åçš„å†™å…¥ã€‚è¢«volatileä¿®é¥°çš„å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹æ€»æ˜¯ç«‹å³å¯è§çš„ï¼Œå¯¹volatileå˜é‡çš„æ‰€æœ‰å†™æ“ä½œæ€»æ˜¯èƒ½ç«‹åˆ»ååº”åˆ°å…¶ä»–çº¿ç¨‹ä¸­ã€‚</p>
<p>2ã€åŸå­æ€§ï¼šå¯¹å•ä¸ªvolatileå˜é‡çš„è¯»å†™ï¼ˆ64ä½çš„longå’Œdoubleç±»å‹ä¹Ÿæ˜¯ï¼‰å…·æœ‰åŸå­æ€§ï¼Œvolatile++çš„å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚</p>
<h4 id="âœ…volatileå˜é‡è¯»å†™å®ç°çº¿ç¨‹ä¹‹é—´é€šä¿¡"><a href="#âœ…volatileå˜é‡è¯»å†™å®ç°çº¿ç¨‹ä¹‹é—´é€šä¿¡" class="headerlink" title="âœ…volatileå˜é‡è¯»å†™å®ç°çº¿ç¨‹ä¹‹é—´é€šä¿¡"></a>âœ…volatileå˜é‡è¯»å†™å®ç°çº¿ç¨‹ä¹‹é—´é€šä¿¡</h4><p>volatileå˜é‡çš„å†™ã€è¯»ï¼Œä¸é”çš„é‡Šæ”¾ã€è·å–æœ‰ç›¸åŒçš„å†…å­˜æ•ˆæœã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int a = 0;</span><br><span class="line">volatile boolean flag = false;</span><br><span class="line"></span><br><span class="line">public void writer() &#123;</span><br><span class="line">    a = 1;//1</span><br><span class="line">    flag = true;//2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void reader() &#123;</span><br><span class="line">    if (flag) &#123;  //3</span><br><span class="line">        int i = a; //4</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1 happens-before 2  (æ‰§è¡Œé¡ºåºå¯èƒ½åœ¨ä¸€ä¸ªä¸´ç•ŒåŒºå†…é‡æ’åº)<br>3 happens-before 4<br>2 happens-before 3 ï¼ˆvolatileå¸¦æ¥çš„ï¼‰<br>so: 1 happens-before 4</p>
<p>ç–‘é—®ï¼š1.2æ²¡æœ‰æ•°æ®ä¾èµ–ï¼Œå¯èƒ½è¢«é‡æ’åºã€‚<br>æŒ‡ä»¤é‡æ’ä½¿å¾—æ‰§è¡Œé¡ºåºä¸ä¼šå˜æˆï¼š2-3-4-1 å—ï¼Ÿ ä¸‹é¢ç»™ç­”æ¡ˆã€‚</p>
<h4 id="âœ…volatileå†™è¯»çš„å†…å­˜è¯­ä¹‰"><a href="#âœ…volatileå†™è¯»çš„å†…å­˜è¯­ä¹‰" class="headerlink" title="âœ…volatileå†™è¯»çš„å†…å­˜è¯­ä¹‰"></a>âœ…volatileå†™è¯»çš„å†…å­˜è¯­ä¹‰</h4><p>çº¿ç¨‹ - æœ¬åœ°å†…å­˜ - ä¸»å†…å­˜</p>
<p>1ã€å½“å†™ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠçº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡ï¼ˆé‚£ä¸ªaï¼‰å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚ï¼ˆå®è´¨å°±æ˜¯Aå‘æ¥ä¸‹æ¥è¦è¯»è¿™ä¸ªvolatileå˜é‡çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†æ¶ˆæ¯ï¼ˆæˆ‘å¯¹å…±äº«å˜é‡åšå‡ºçš„ä¿®æ”¹ï¼‰ï¼‰</p>
<p>2ã€å½“è¯»ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆã€‚çº¿ç¨‹æ¥ä¸‹æ¥å°†ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚ï¼ˆå®è´¨å°±æ˜¯æ¥å—äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„æ¶ˆæ¯ï¼‰</p>
<p>3ã€Aå†™ï¼ŒBè¯»ï¼Œå®è´¨å°±æ˜¯Aé€šè¿‡ä¸»å†…å­˜å‘Bå‘é€æ¶ˆæ¯ï¼Œå®ç°çº¿ç¨‹ä¹‹é—´é€šä¿¡</p>
<h4 id="âœ…volatileå†…å­˜è¯­ä¹‰çš„å®ç°-ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚"><a href="#âœ…volatileå†…å­˜è¯­ä¹‰çš„å®ç°-ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚" class="headerlink" title="âœ…volatileå†…å­˜è¯­ä¹‰çš„å®ç°-ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚"></a>âœ…volatileå†…å­˜è¯­ä¹‰çš„å®ç°-ç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚</h4><p>èƒŒæ™¯ï¼šä¸Šé¢å®ç°çº¿ç¨‹é—´é€šä¿¡é‚£ä¸€å°èŠ‚ï¼Œç–‘æƒ‘çš„æ˜¯1.2æ˜¯ä¸æ˜¯èƒ½é‡æ’åºï¼Œ3.4æ˜¯ä¸æ˜¯èƒ½é‡æ’åºã€‚åœ¨è¿™é‡Œç»™å‡ºç­”æ¡ˆï¼Œ</p>
<p>ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼ŒJMMä¼šé™åˆ¶é‡æ’åºç±»å‹ã€‚</p>
<p>1ã€å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°å†™ä¹‹åã€‚</p>
<p>2ã€å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºã€‚è¿™ä¸ªè§„åˆ™ç¡®ä¿volatileè¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°è¯»ä¹‹å‰ã€‚</p>
<p>3ã€å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œä¸èƒ½é‡æ’åºã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•å®ç°é™åˆ¶æŒ‡ä»¤é‡æ’ï¼Ÿ<br>ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚<br>å°½ç®¡å†…å­˜å±éšœä¼šé™ä½æ•ˆç‡ï¼Œä½†æ˜¯JMM åœ¨å®ç°ä¸Šçš„ä¸€ä¸ªç‰¹ç‚¹ï¼šé¦–å…ˆç¡®ä¿æ­£ç¡®æ€§ï¼Œç„¶åå†å»è¿½æ±‚æ‰§è¡Œæ•ˆç‡ã€‚</p>
<h4 id="âœ…JSR-133å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰"><a href="#âœ…JSR-133å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰" class="headerlink" title="âœ…JSR-133å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰"></a>âœ…JSR-133å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰</h4><p>Javaå†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªé›„å¿ƒå‹ƒå‹ƒçš„è®¡åˆ’ï¼Œå®ƒæ˜¯ç¼–ç¨‹è¯­è¨€è§„èŒƒç¬¬ä¸€æ¬¡å°è¯•åˆå¹¶ä¸€ä¸ªèƒ½å¤Ÿåœ¨å„ç§å¤„ç†å™¨æ¶æ„ä¸­ä¸ºå¹¶å‘æä¾›ä¸€è‡´è¯­ä¹‰çš„å†…å­˜æ¨¡å‹ã€‚ä¸è¿‡ï¼Œå®šä¹‰ä¸€ä¸ªæ—¢ä¸€è‡´åˆç›´è§‚çš„å†…å­˜æ¨¡å‹è¿œæ¯”æƒ³è±¡è¦æ›´éš¾ã€‚JSR133ä¸ºJavaè¯­è¨€å®šä¹‰äº†ä¸€ä¸ªæ–°çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒä¿®å¤äº†æ—©æœŸå†…å­˜æ¨¡å‹ä¸­çš„ç¼ºé™·ã€‚ä¸ºäº†å®ç°JSR133ï¼Œfinalå’Œvolatileçš„è¯­ä¹‰éœ€è¦é‡æ–°å®šä¹‰ã€‚</p>
<p>æ—§çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œvolatileçš„å†™è¯»æ²¡æœ‰é”çš„é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯å®ç°çº¿ç¨‹ä¹‹é—´é€šä¿¡é‚£ä¸€å°èŠ‚é‡Œï¼Œä¼šæŒ‡ä»¤é‡æ’ã€‚</p>
<p>JSR-133ï¼Œä¸¥æ ¼é™åˆ¶ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹volatileå˜é‡ä¸æ™®é€šå˜é‡çš„é‡æ’åºï¼Œç¡®ä¿äº†volatileçš„å†™è¯»æœ‰é”çš„é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>volatileä¸é”å¯¹æ¯”ï¼š<br>é”åœ¨åŠŸèƒ½ä¸Šæ¯”volatileæ›´å¼ºå¤§ï¼Œå¯ä»¥ç¡®ä¿æ•´ä¸ªä¸´ç•ŒåŒºä»£ç å…·æœ‰åŸå­æ€§ã€‚volatileåªèƒ½å¯¹å•ä¸ªvolatileå˜é‡è¯»å†™å…·æœ‰åŸå­æ€§ã€‚ï¼ˆæ‰€ä»¥ä¸èƒ½å•çº¯ç”¨volatileå®ç°è®¡æ•°å™¨ï¼‰<br>åœ¨å¯ä¼¸ç¼©æ€§å’Œæ‰§è¡Œæ€§èƒ½ä¸Šï¼Œvolatileæ›´å…·æœ‰ä¼˜åŠ¿ã€‚</p>
<h3 id="5-é”çš„å†…å­˜è¯­ä¹‰"><a href="#5-é”çš„å†…å­˜è¯­ä¹‰" class="headerlink" title="5.é”çš„å†…å­˜è¯­ä¹‰"></a>5.é”çš„å†…å­˜è¯­ä¹‰</h3><p>è¾¾åˆ°æ•ˆæœï¼šçº¿ç¨‹Aåœ¨é‡Šæ”¾é”ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨çº¿ç¨‹Bè·å–åŒä¸€ä¸ªé”ä¹‹åï¼Œå°†ç«‹å³å˜å¾—å¯¹Bçº¿ç¨‹å¯è§ã€‚</p>
<h4 id="âœ…é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰"><a href="#âœ…é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰" class="headerlink" title="âœ…é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰"></a>âœ…é”é‡Šæ”¾å’Œè·å–çš„å†…å­˜è¯­ä¹‰</h4><p>1ã€å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚ï¼ˆå®è´¨ä¸Šæ˜¯çº¿ç¨‹Aå‘æ¥ä¸‹æ¥è¦è·å–è¿™ä¸ªé”çš„æŸä¸ªçº¿ç¨‹å‘å‡ºäº†ï¼ˆçº¿ç¨‹Aå¯¹å…±äº«å˜é‡æ‰€åšä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚ï¼‰</p>
<p>2ã€å½“çº¿ç¨‹è·å–é”æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆã€‚ä»è€Œä½¿å¾—è¢«ç›‘è§†å™¨é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºä»£ç å¿…é¡»ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚ï¼ˆå®è´¨ä¸Šæ˜¯çº¿ç¨‹Bæ¥å—äº†ä¹‹å‰æŸä¸ªçº¿ç¨‹å‘å‡ºçš„ï¼ˆåœ¨é‡Šæ”¾è¿™ä¸ªé”å¯¹å…±äº«å˜é‡é”åšçš„ä¿®æ”¹çš„ï¼‰æ¶ˆæ¯ã€‚ï¼‰</p>
<p>3ã€çº¿ç¨‹Aé‡Šæ”¾é”ï¼Œéšåçº¿ç¨‹Bè·å–è¿™ä¸ªé”ï¼Œè¿™ä¸ªè¿‡ç¨‹å®è´¨ä¸Šæ˜¯çº¿ç¨‹Aé€šè¿‡ä¸»å†…å­˜å‘çº¿ç¨‹Bå‘é€æ¶ˆæ¯ã€‚</p>
<h4 id="âœ…é”å†…å­˜è¯­ä¹‰çš„å®ç°"><a href="#âœ…é”å†…å­˜è¯­ä¹‰çš„å®ç°" class="headerlink" title="âœ…é”å†…å­˜è¯­ä¹‰çš„å®ç°"></a>âœ…é”å†…å­˜è¯­ä¹‰çš„å®ç°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock lock = new ReentrantLock();</span><br><span class="line">lock.lock();                 // è·å–é”</span><br><span class="line">try &#123;</span><br><span class="line">    a++;</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    lock.unlock();          // é‡Šæ”¾é”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReentrantLockçš„å®ç°ä¾èµ–äºJavaåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronized(AQS) ã€‚AQSä½¿ç”¨ä¸€ä¸ªæ•´å‹çš„volatileå˜é‡ï¼ˆstateï¼‰æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œè¿™ä¸ªvolatileå˜é‡æ˜¯ReentrantLockå†…å­˜è¯­ä¹‰å®ç°çš„å…³é”®ã€‚</p>
<p><strong>å…¬å¹³é”ï¼š</strong></p>
<p>åŠ é”æ–¹æ³•é¦–å…ˆè¯»å–volatileå˜é‡stateã€‚<br>é‡Šæ”¾é”çš„æœ€åå†™volatileå˜é‡stateã€‚</p>
<p>æ•ˆæœï¼šé‡Šæ”¾é”çš„çº¿ç¨‹åœ¨å†™volatileå˜é‡ä¹‹å‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨è·å–é”çš„çº¿ç¨‹è¯»å–åˆ°åŒä¸€ä¸ªvolatileå˜é‡åå°†ç«‹å³å˜å¾—å¯¹è·å–é”çš„çº¿ç¨‹å¯è§ã€‚</p>
<p><strong>éå…¬å¹³é”ï¼š</strong></p>
<p>éå…¬å¹³é”çš„é‡Šæ”¾å’Œå…¬å¹³é”çš„é‡Šæ”¾å®Œå…¨ä¸€è‡´ã€‚</p>
<p>åŠ é”ï¼šç”¨äº†ï¼š<code>unsafe.compareAndSwapInt(this, stateOffset, expect, update);</code></p>
<p>è¯¥æ–¹æ³•ä»¥åŸå­æ“ä½œçš„æ–¹å¼æ›´æ–°stateå˜é‡ï¼Œä¹Ÿå°±æ˜¯compareAndSet() (CAS)æ“ä½œã€‚JDKæ–‡æ¡£å¯¹è¯¥æ–¹æ³•è¯´æ˜å¦‚ä¸‹ï¼šå¦‚æœå½“å‰çŠ¶æ€å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼åŒæ­¥çŠ¶æ€è®¾ç½®ä¸ºç»™å®šæ›´æ–°çš„å€¼ã€‚æ­¤æ“ä½œå…·æœ‰volatileè¯»å’Œå†™çš„å†…å­˜è¯­ä¹‰ã€‚<br>ï¼ˆç¼–è¯‘å™¨ä¸èƒ½å¯¹CASä¸CASå‰é¢å’Œåé¢ä»»æ„å†…å­˜æ“ä½œé‡æ’åºã€‚ï¼‰</p>
<p>CASå…·æœ‰volatileè¯»å†™å†…å­˜è¯­ä¹‰çš„å®ç°æ–¹å¼ï¼šlockå‰ç¼€<br>intelæ‰‹å†Œå¯¹lockå‰ç¼€çš„è¯´æ˜ï¼š<br>å¯¹å†…å­˜çš„è¯»-æ”¹-å†™æ“ä½œåŸå­æ‰§è¡Œã€‚ï¼ˆæ€»çº¿é”å®š/ç¼“å­˜é”å®šï¼‰<br>ç¦æ­¢è¯¥æŒ‡ä»¤ï¼Œä¸ä¹‹å‰çš„è¯»å’Œå†™æŒ‡ä»¤é‡æ’åº<br>æŠŠå†™ç¼“å†²åŒºçš„æ‰€æœ‰æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­<br>ä¸Šé¢çš„2ã€3ä¸¤ç‚¹æ‰€å…·æœ‰çš„å†…å­˜å±éšœçš„æ•ˆæœï¼Œè¶³ä»¥åŒæ—¶å®ç°volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ã€‚æ‰€ä»¥JDKæ–‡æ¡£è¯´CAS å…·æœ‰volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰å¯¹äºå¤„ç†å™¨ä¹Ÿæ˜¯ç¬¦åˆçš„ã€‚</p>
<p><strong>æ€»ç»“ï¼š</strong><br>é‡Šæ”¾é”-è·å–é”çš„å†…å­˜è¯­ä¹‰çš„å®ç°æ–¹å¼æ€»ç»“ ï¼š<br>åˆ©ç”¨volatileå˜é‡çš„å†™-è¯»æ‰€å…·æœ‰çš„å†…å­˜è¯­ä¹‰<br>åˆ©ç”¨CASæ‰€é™„å¸¦çš„volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰</p>
<h4 id="âœ…concurrentåŒ…çš„å®ç°"><a href="#âœ…concurrentåŒ…çš„å®ç°" class="headerlink" title="âœ…concurrentåŒ…çš„å®ç°"></a>âœ…concurrentåŒ…çš„å®ç°</h4><p>Javaçš„CASä¼šä½¿ç”¨ç°ä»£å¤„ç†å™¨ä¸Šæä¾›çš„é«˜æ•ˆæœºå™¨çº§åˆ«çš„åŸå­æŒ‡ä»¤ï¼Œè¿™äº›åŸå­æŒ‡ä»¤ä»¥åŸå­æ–¹å¼å¯¹å†…å­˜æ‰§è¡Œè¯»-æ”¹-å†™æ“ä½œï¼Œè¿™æ˜¯åœ¨å¤šå¤„ç†å™¨å®ç°åŒæ­¥çš„å…³é”®ã€‚åŒæ—¶volatileå˜é‡çš„è¯»/å†™å’ŒCASå¯ä»¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚è¿™äº›ç‰¹æ€§å°±æ˜¯Javaæ•´ä¸ªconcurrentåŒ…çš„åŸºçŸ³ã€‚</p>
<p>concurrentåŒ…çš„é€šç”¨åŒ–å®ç°æ¨¡å¼ï¼š<br>1ã€å£°æ˜å…±äº«å˜é‡volatile<br>2ã€ä½¿ç”¨CASçš„åŸå­æ¡ä»¶æ›´æ–°æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥<br>3ã€é…åˆvolatileçš„è¯»/å†™å’ŒCASå…·æœ‰çš„volatileè¯»å’Œå†™çš„å†…å­˜è¯­ä¹‰æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚</p>
<p>AQSï¼ˆjava.util.concurrent.locks.AbstractQueuedSynchronizerï¼‰ã€éé˜»å¡æ•°æ®ç»“æ„å’ŒåŸå­å˜é‡ç±»ï¼ˆjava.util.concurrent.atomicåŒ…ä¸­çš„ç±»ï¼‰ï¼Œè¿™äº›concurrentåŒ…ä¸­åŸºç¡€ç±»éƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªæ¨¡å¼æ¥å®ç°çš„ï¼Œè€ŒconcurrentåŒ…ä¸­çš„é«˜å±‚ç±»åˆæ˜¯ä¾èµ–äºè¿™äº›åŸºç¡€ç±»ã€‚</p>
<p>å›¾ç¤ºconcurrentåŒ…çš„å®ç°ç¤ºæ„å›¾ï¼š</p>
<p><img src="/images/concurrent%E5%8C%85.png"></p>
<h3 id="6-finalåŸŸçš„å†…å­˜è¯­ä¹‰"><a href="#6-finalåŸŸçš„å†…å­˜è¯­ä¹‰" class="headerlink" title="6.finalåŸŸçš„å†…å­˜è¯­ä¹‰"></a>6.finalåŸŸçš„å†…å­˜è¯­ä¹‰</h3><p>æ–‡ä¸­æ¢è®¨çš„å˜é‡å¯¹çº¿ç¨‹å¯è§ï¼Œæ˜¯ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ï¼Œå¦‚æœä¸å¯è§ï¼Œé‚£å°±è¦åŒæ­¥åŠ é”ï¼Œåè¨€ä¹‹ï¼ŒåŠ é”ä¹Ÿæ˜¯ä¸ºäº†å˜é‡å¯¹çº¿ç¨‹å¯è§ã€‚</p>
<h4 id="âœ…finalåŸŸçš„é‡æ’åºè§„åˆ™"><a href="#âœ…finalåŸŸçš„é‡æ’åºè§„åˆ™" class="headerlink" title="âœ…finalåŸŸçš„é‡æ’åºè§„åˆ™"></a>âœ…finalåŸŸçš„é‡æ’åºè§„åˆ™</h4><p>å¯¹äºfinalåŸŸï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨è¦éµå®ˆä¸¤ä¸ªé‡æ’åºè§„åˆ™ã€‚</p>
<p>1ï¼‰åœ¨æ„é€ å‡½æ•°å†…å¯¹ä¸€ä¸ªfinalåŸŸçš„å†™å…¥ï¼Œä¸éšåæŠŠè¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</p>
<blockquote>
<p>å†™finalåŸŸçš„é‡æ’åºè§„åˆ™ç¦æ­¢æŠŠfinalåŸŸçš„å†™é‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚</p>
<p>å†™æ™®é€šåŸŸçš„æ“ä½œå¯èƒ½è¢«ç¼–è¯‘å™¨é‡æ’åºåˆ°äº†æ„é€ å‡½æ•°ä¹‹å¤–ï¼Œè¯»çº¿ç¨‹Bé”™è¯¯åœ°è¯»å–äº†æ™®é€šå˜é‡iåˆå§‹åŒ–ä¹‹å‰çš„å€¼ï¼Œå¾ˆå¯èƒ½objå¯¹è±¡è¿˜æ²¡æœ‰æ„é€ å®Œæˆï¼Œåˆå§‹å€¼1è¿˜æ²¡æœ‰å†™å…¥æ™®é€šåŸŸiã€‚è€Œå†™finalåŸŸçš„æ“ä½œï¼Œè¢«å†™finalåŸŸçš„é‡æ’åºè§„åˆ™â€œé™å®šâ€åœ¨äº†æ„é€ å‡½æ•°ä¹‹å†…ï¼Œè¯»çº¿ç¨‹Bæ­£ç¡®åœ°è¯»å–äº†finalå˜é‡åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
</blockquote>
<blockquote>
<p>å†™finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨å¯¹è±¡å¼•ç”¨ä¸ºä»»æ„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œå¯¹è±¡çš„finalåŸŸå·²ç»è¢«æ­£ç¡®åˆå§‹åŒ–è¿‡äº†ï¼Œè€Œæ™®é€šåŸŸä¸å…·æœ‰è¿™ä¸ªä¿éšœã€‚</p>
</blockquote>
<p>2ï¼‰åˆæ¬¡è¯»ä¸€ä¸ªåŒ…å«finalåŸŸçš„å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸éšååˆæ¬¡è¯»è¿™ä¸ªfinalåŸŸï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</p>
<blockquote>
<p>ç¼–è¯‘å™¨éµå®ˆé—´æ¥ä¾èµ–å…³ç³»ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¸ä¼šé‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚å¤§å¤šæ•°å¤„ç†å™¨ä¹Ÿä¼šéµå®ˆé—´æ¥ä¾èµ–ï¼Œä¹Ÿä¸ä¼šé‡æ’åºè¿™ä¸¤ä¸ªæ“ä½œã€‚ä½†æœ‰å°‘æ•°å¤„ç†å™¨å…è®¸å¯¹å­˜åœ¨é—´æ¥ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼ˆæ¯”å¦‚alphaå¤„ç†å™¨ï¼‰ï¼Œè¿™ä¸ªè§„åˆ™å°±æ˜¯ä¸“é—¨ç”¨æ¥é’ˆå¯¹è¿™ç§å¤„ç†å™¨çš„ã€‚</p>
</blockquote>
<blockquote>
<p>è¯»finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨è¯»ä¸€ä¸ªå¯¹è±¡çš„finalåŸŸä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆè¯»åŒ…å«è¿™ä¸ªfinalåŸŸçš„å¯¹è±¡çš„å¼•ç”¨ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public class FinalExample &#123;</span><br><span class="line">    int i;  //æ™®é€šå˜é‡</span><br><span class="line">    final int j;  //finalå˜é‡</span><br><span class="line">    static FinalExample obj;</span><br><span class="line">    public FinalExample() &#123; //æ„é€ å‡½æ•°</span><br><span class="line">        i = 1; //å†™æ™®é€šåŸŸ</span><br><span class="line">        j = 2; //å†™finalåŸŸ</span><br><span class="line">    &#125;</span><br><span class="line">    public static void writer() &#123; //å†™çº¿ç¨‹Aæ‰§è¡Œ</span><br><span class="line">        obj = new FinalExample();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void reader() &#123; //è¯»çº¿ç¨‹Bæ‰§è¡Œ</span><br><span class="line">        FinalExample object = obj; //è¯»å¯¹è±¡å¼•ç”¨</span><br><span class="line">        int a = object.i; //è¯»æ™®é€šåŸŸ</span><br><span class="line">        int b = object.j; //è¯»finalåŸŸ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="âœ…finalåŸŸä¸ºå¼•ç”¨ç±»å‹"><a href="#âœ…finalåŸŸä¸ºå¼•ç”¨ç±»å‹" class="headerlink" title="âœ…finalåŸŸä¸ºå¼•ç”¨ç±»å‹"></a>âœ…finalåŸŸä¸ºå¼•ç”¨ç±»å‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class FinalReferenceExample &#123;</span><br><span class="line">    final int[] intArray; //finalæ˜¯å¼•ç”¨ç±»å‹</span><br><span class="line">    static FinalReferenceExample obj;</span><br><span class="line">    public FinalReferenceExample() &#123; //æ„é€ å‡½æ•°</span><br><span class="line">        intArray = new int[1]; //1</span><br><span class="line">        intArray[0] = 1; //2</span><br><span class="line">    &#125;</span><br><span class="line">    public static void writerOne() &#123; //å†™çº¿ç¨‹Aæ‰§è¡Œ</span><br><span class="line">        obj = new FinalReferenceExample(); //3</span><br><span class="line">    &#125;</span><br><span class="line">    public static void writerTwo() &#123; //å†™çº¿ç¨‹Bæ‰§è¡Œ</span><br><span class="line">        obj.intArray[0] = 2; //4</span><br><span class="line">    &#125;</span><br><span class="line">    public static void reader() &#123; //è¯»çº¿ç¨‹Cæ‰§è¡Œ</span><br><span class="line">        if (obj != null) &#123; //5</span><br><span class="line">            int temp1 = obj.intArray[0]; //6</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬ä¾‹finalåŸŸä¸ºä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œå®ƒå¼•ç”¨ä¸€ä¸ªintå‹çš„æ•°ç»„å¯¹è±¡ã€‚å¯¹äºå¼•ç”¨ç±»å‹ï¼Œå†™finalåŸŸçš„é‡æ’åºè§„åˆ™å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¢åŠ äº†å¦‚ä¸‹çº¦æŸï¼šåœ¨<strong>æ„é€ å‡½æ•°å†…</strong>å¯¹ä¸€ä¸ªfinalå¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥(2)ï¼Œä¸éšååœ¨æ„é€ å‡½æ•°å¤–æŠŠè¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡(3)ï¼Œè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸èƒ½é‡æ’åºã€‚</p>
<p>1æ˜¯å¯¹finalåŸŸçš„å†™å…¥ï¼Œ2æ˜¯å¯¹è¿™ä¸ªfinalåŸŸå¼•ç”¨çš„å¯¹è±¡çš„æˆå‘˜åŸŸçš„å†™å…¥ï¼Œ3æ˜¯æŠŠè¢«æ„é€ çš„å¯¹è±¡çš„å¼•ç”¨èµ‹å€¼ç»™æŸä¸ªå¼•ç”¨å˜é‡ã€‚è¿™é‡Œé™¤äº†å‰é¢æåˆ°çš„1ä¸èƒ½å’Œ3é‡æ’åºå¤–ï¼Œ2å’Œ3ä¹Ÿä¸èƒ½é‡æ’åºã€‚</p>
<p>å†™çº¿ç¨‹Bå¯¹æ•°ç»„å…ƒç´ çš„å†™å…¥ï¼Œè¯»çº¿ç¨‹Cå¯èƒ½çœ‹å¾—åˆ°ï¼Œä¹Ÿå¯èƒ½çœ‹ä¸åˆ°ã€‚JMMä¸ä¿è¯çº¿ç¨‹Bçš„å†™å…¥å¯¹è¯»çº¿ç¨‹Cå¯è§ï¼Œå› ä¸ºå†™çº¿ç¨‹Bå’Œè¯»çº¿ç¨‹Cä¹‹é—´å­˜åœ¨æ•°æ®ç«äº‰ï¼Œæ­¤æ—¶çš„æ‰§è¡Œç»“æœä¸å¯é¢„çŸ¥ã€‚</p>
<p>å¦‚æœæƒ³è¦ç¡®ä¿è¯»çº¿ç¨‹Cçœ‹åˆ°å†™çº¿ç¨‹Bå¯¹æ•°ç»„å…ƒç´ çš„å†™å…¥ï¼Œå†™çº¿ç¨‹Bå’Œè¯»çº¿ç¨‹Cä¹‹é—´éœ€è¦ä½¿ç”¨åŒæ­¥åŸè¯­ï¼ˆlockæˆ–volatileï¼‰æ¥ç¡®ä¿å†…å­˜å¯è§æ€§ã€‚</p>
<h4 id="âœ…ä¸ºä»€ä¹ˆå«finalçš„å¯¹è±¡å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œæº¢å‡ºâ€"><a href="#âœ…ä¸ºä»€ä¹ˆå«finalçš„å¯¹è±¡å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œæº¢å‡ºâ€" class="headerlink" title="âœ…ä¸ºä»€ä¹ˆå«finalçš„å¯¹è±¡å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œæº¢å‡ºâ€"></a>âœ…ä¸ºä»€ä¹ˆå«finalçš„å¯¹è±¡å¼•ç”¨ä¸èƒ½ä»æ„é€ å‡½æ•°å†…â€œæº¢å‡ºâ€</h4><p>å†™finalåŸŸçš„é‡æ’åºè§„åˆ™å¯ä»¥ç¡®ä¿ï¼šåœ¨å¼•ç”¨å˜é‡ä¸ºä»»æ„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œè¯¥å¼•ç”¨å˜é‡æŒ‡å‘çš„å¯¹è±¡çš„finalåŸŸå·²ç»åœ¨æ„é€ å‡½æ•°ä¸­è¢«æ­£ç¡®åˆå§‹åŒ–è¿‡äº†ã€‚å…¶å®ï¼Œè¦å¾—åˆ°è¿™ä¸ªæ•ˆæœï¼Œè¿˜éœ€è¦ä¸€ä¸ªä¿è¯ï¼šåœ¨æ„é€ å‡½æ•°å†…éƒ¨ï¼Œä¸èƒ½è®©è¿™ä¸ªè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨ä¸ºå…¶ä»–çº¿ç¨‹æ‰€è§ï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡å¼•ç”¨ä¸èƒ½åœ¨æ„é€ å‡½æ•°ä¸­â€œé€¸å‡ºâ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class FinalReferenceEscapeExample &#123;</span><br><span class="line">    final int                          i;</span><br><span class="line">    static FinalReferenceEscapeExample obj;</span><br><span class="line">    public FinalReferenceEscapeExample() &#123;</span><br><span class="line">        i = 1; //1å†™finalåŸŸ</span><br><span class="line">        obj = this; //2 thiså¼•ç”¨åœ¨æ­¤â€œé€¸å‡ºâ€</span><br><span class="line">    &#125;</span><br><span class="line">    public static void writer() &#123;</span><br><span class="line">        new FinalReferenceEscapeExample();</span><br><span class="line">    &#125;</span><br><span class="line">    public static void reader() &#123;  //çº¿ç¨‹B</span><br><span class="line">        if (obj != null) &#123; //3</span><br><span class="line">            int temp = obj.i; //4</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ“ä½œ2ä½¿å¾—å¯¹è±¡è¿˜æœªå®Œæˆæ„é€ å‰å°±ä¸ºçº¿ç¨‹Bå¯è§ã€‚è¿™é‡Œçš„æ“ä½œ1å’Œæ“ä½œ2ä¹‹é—´å¯èƒ½è¢«é‡æ’åºã€‚çº¿ç¨‹Bçœ‹åˆ°äº†æ­¤æ—¶çš„finalåŸŸå¯èƒ½è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚</p>
<p>finalä¸åŒäºæ™®é€šå˜é‡è¾¾åˆ°çš„æ•ˆæœæ˜¯ï¼šåœ¨æ„é€ å‡½æ•°è¿”å›åï¼Œä»»æ„çº¿ç¨‹éƒ½å°†ä¿è¯èƒ½çœ‹åˆ°finalåŸŸæ­£ç¡®åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
<h4 id="âœ…å¤„ç†å™¨ä¸­å¦‚ä½•å®ç°finalè¯­ä¹‰"><a href="#âœ…å¤„ç†å™¨ä¸­å¦‚ä½•å®ç°finalè¯­ä¹‰" class="headerlink" title="âœ…å¤„ç†å™¨ä¸­å¦‚ä½•å®ç°finalè¯­ä¹‰"></a>âœ…å¤„ç†å™¨ä¸­å¦‚ä½•å®ç°finalè¯­ä¹‰</h4><p>æœ¬æ¥åº”è¯¥è¦æ’å…¥å†…å­˜å±éšœçš„ã€‚<br>X86å¤„ç†å™¨ä¸ä¼šå¯¹å†™-å†™æ“ä½œåšé‡æ’åºï¼ŒX86å¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨é—´æ¥ä¾èµ–å…³ç³»çš„æ“ä½œåšé‡æ’åºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨X86å¤„ç†å™¨ä¸­ï¼ŒfinalåŸŸçš„è¯»/å†™ä¸ä¼šæ’å…¥ä»»ä½•å†…å­˜å±éšœï¼ï¼ˆæ™®é€šå˜é‡ä¹Ÿæœ‰ä¾èµ–å…³ç³»å§ï¼Œä¹Ÿæœ‰finalè¯­ä¹‰ï¼Ÿï¼‰</p>
<h4 id="âœ…JSR-133ä¸ºä»€ä¹ˆè¦å¢å¼ºfinalçš„è¯­ä¹‰"><a href="#âœ…JSR-133ä¸ºä»€ä¹ˆè¦å¢å¼ºfinalçš„è¯­ä¹‰" class="headerlink" title="âœ…JSR-133ä¸ºä»€ä¹ˆè¦å¢å¼ºfinalçš„è¯­ä¹‰"></a>âœ…JSR-133ä¸ºä»€ä¹ˆè¦å¢å¼ºfinalçš„è¯­ä¹‰</h4><p>åœ¨æ—§çš„Javaå†…å­˜æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªæœ€ä¸¥é‡çš„ç¼ºé™·å°±æ˜¯çº¿ç¨‹å¯èƒ½çœ‹åˆ°finalåŸŸçš„å€¼ä¼šæ”¹å˜ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªçº¿ç¨‹å½“å‰çœ‹åˆ°ä¸€ä¸ªæ•´å‹finalåŸŸçš„å€¼ä¸º0ï¼ˆè¿˜æœªåˆå§‹åŒ–ä¹‹å‰çš„é»˜è®¤å€¼ï¼‰ï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¹‹åè¿™ä¸ªçº¿ç¨‹å†å»è¯»è¿™ä¸ªfinalåŸŸçš„å€¼æ—¶ï¼Œå´å‘ç°å€¼å˜ä¸º1ï¼ˆè¢«æŸä¸ªçº¿ç¨‹åˆå§‹åŒ–ä¹‹åçš„å€¼ï¼‰ã€‚</p>
<p>ä¸ºäº†ä¿®è¡¥è¿™ä¸ªæ¼æ´ï¼ŒJSR-133ä¸“å®¶ç»„å¢å¼ºäº†finalçš„è¯­ä¹‰ã€‚é€šè¿‡ä¸ºfinalåŸŸå¢åŠ å†™å’Œè¯»é‡æ’åºè§„åˆ™ï¼Œå¯ä»¥ä¸ºJavaç¨‹åºå‘˜æä¾›åˆå§‹åŒ–å®‰å…¨ä¿è¯ï¼šåªè¦å¯¹è±¡æ˜¯æ­£ç¡®æ„é€ çš„ï¼ˆè¢«æ„é€ å¯¹è±¡çš„å¼•ç”¨åœ¨æ„é€ å‡½æ•°ä¸­æ²¡æœ‰â€œé€¸å‡ºâ€ï¼‰ï¼Œé‚£ä¹ˆä¸éœ€è¦ä½¿ç”¨åŒæ­¥ï¼ˆæŒ‡lockå’Œvolatileçš„ä½¿ç”¨ï¼‰å°±å¯ä»¥ä¿è¯ä»»æ„çº¿ç¨‹éƒ½èƒ½çœ‹åˆ°è¿™ä¸ªfinalåŸŸåœ¨æ„é€ å‡½æ•°ä¸­è¢«åˆå§‹åŒ–ä¹‹åçš„å€¼ã€‚</p>
<h3 id="7-happens-before"><a href="#7-happens-before" class="headerlink" title="7.happens-before"></a>7.happens-before</h3><h4 id="âœ…è®¾è®¡åˆè¡·"><a href="#âœ…è®¾è®¡åˆè¡·" class="headerlink" title="âœ…è®¾è®¡åˆè¡·"></a>âœ…è®¾è®¡åˆè¡·</h4><p>è®¾è®¡å†…å­˜æ¨¡å‹JMMçš„åˆè¡·ï¼šè®©ç¨‹åºå‘˜æ˜“äºç†è§£ï¼Œæ˜“äºç¼–ç¨‹ï¼Œæä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„æŸç¼šè¶Šå°‘è¶Šå¥½ï¼Œæ–¹ä¾¿å®ƒä»¬ä¼˜åŒ–æ¥æé«˜æ€§èƒ½ã€‚</p>
<p>JMM å¯¹äºè¿™ä¸¤ç§ç±»å‹çš„é‡æ’åºåšäº†ä¸åŒçš„å¤„ç†ï¼š<br>å¯¹äºæœ‰æ•°æ®ä¾èµ–çš„é‡æ’åºï¼ŒJMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ç¦æ­¢è¿™ç§é‡æ’åº<br>å¯¹äºæ²¡æœ‰æ•°æ®ä¾èµ–çš„é‡æ’åºï¼ŒJMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸åšå¤„ç†</p>
<p>JMM çš„ happens - before å‘ç¨‹åºå‘˜æä¾›äº†è¶³å¤Ÿå¼ºçš„å†…å­˜å¯è§æ€§ä¿è¯ï¼Œä½†æ˜¯å…¶ä¸­æœ‰äº›å†…å­˜å¯è§æ€§ä¿è¯å…¶å®ä¸ä¸€å®šå­˜åœ¨ï¼Œã€æ¯”å¦‚ int a=1; int b=2; è¿™ä¸ªå°±åªæ˜¯å¯è§ï¼Œä¸ä¿è¯æ‰§è¡Œé¡ºåºï¼Œä½†ä¹Ÿæ˜¯happens-beforeã€‘ã€‚</p>
<p>JMM å¯¹äºç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„ä¼˜åŒ–å·²ç»å°½å¯èƒ½å°‘äº†ã€‚JMM å…¶å®åœ¨éµå¾ªä¸€ä¸ªè§„åˆ™ï¼šå•çº¿ç¨‹ä¸‹æˆ–è€…å·²ç»åŒæ­¥çš„å¤šçº¿ç¨‹ä¸‹ï¼ˆsynchronizedï¼Œvolatileç­‰ï¼‰ï¼Œåªè¦ä¸æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æƒ³è¦æ€ä¹ˆä¼˜åŒ–éƒ½å¯ä»¥ã€‚ã€æ¯”å¦‚ å¯¹äºvolatile å˜é‡ï¼Œå¦‚æœç¼–è¯‘å™¨åˆ†æåè®¤å®šè¿™ä¸ªå˜é‡åªä¼šè¢«å•çº¿ç¨‹è®¿é—®ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹çš„å¯è§æ€§é—®é¢˜ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¼šæŠŠ volatile å˜é‡å½“ä½œæ™®é€šå˜é‡è¿›è¡Œå¤„ç†ã€‘ã€‚</p>
<h4 id="âœ…happens-beforeçš„å®šä¹‰"><a href="#âœ…happens-beforeçš„å®šä¹‰" class="headerlink" title="âœ…happens-beforeçš„å®šä¹‰"></a>âœ…happens-beforeçš„å®šä¹‰</h4><p>JSR - 133ä¸­æå‡ºï¼ŒJSR - 133 ä½¿ç”¨ happens - before å…³ç³»æ¥å‘ç¨‹åºå‘˜æä¾›è·¨çº¿ç¨‹çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<p>1ã€å¦‚æœä¸€ä¸ªæ“ä½œ happens - before å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ã€‚</p>
<p>2ã€ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ happens - before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³è¿™ Java å¹³å°å¿…é¡»è¦æŒ‰ç…§ happens - before è§„å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚åªè¦é‡æ’åºä¹‹åçš„ç»“æœæ˜¯ä¸æ”¹å˜çš„ï¼Œé‚£ä¹ˆ JMM æ˜¯é»˜è®¤ä¸å¯¹è¿™ç§é‡æ’åºå¤„ç†çš„</p>
<p>æ ¸å¿ƒåŸåˆ™æ˜¯ï¼šåªè¦ä¸æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼ˆ<strong>å•çº¿ç¨‹å’Œæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹</strong>ï¼‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€ä¹ˆä¼˜åŒ–éƒ½è¡Œã€‚ç¨‹åºå‘˜å¯¹äºè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¦çœŸçš„è¢«é‡æ’åºå¹¶ä¸å…³å¿ƒï¼Œç¨‹åºå‘˜åªéœ€è¦å…³ç³»çš„æ˜¯ç¨‹åºæ‰§è¡Œæ—¶çš„è¯­ä¹‰ä¸èƒ½è¢«æ”¹å˜ï¼ˆå°±æ˜¯æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ï¼‰ã€‚</p>
<p>happens - before ç»™ç¼–å†™æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„ç¨‹åºå‘˜ä¸€ä¸ªå¹»è§‰ï¼šæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç…§ happens - before æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚å®é™…ä¸Šä¸æ˜¯ï¼Œä½†æ˜¯è¯­ä¹‰å’ŒæŒ‰é¡ºåºæ‰§è¡Œæ˜¯ä¸€æ ·çš„ã€‚<br>ï¼ˆå®é™…ä¸Šæ˜¯å¯è§æ€§ï¼Œä½†ä¹Ÿæ˜¯ä¸€ç§å‡çš„é¡ºåºï¼‰</p>
<h4 id="âœ…happens-beforeè§„åˆ™"><a href="#âœ…happens-beforeè§„åˆ™" class="headerlink" title="âœ…happens-beforeè§„åˆ™"></a>âœ…happens-beforeè§„åˆ™</h4><p>1ã€ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens - before äºè¯¥ç¨‹åºçš„ä»»æ„åç»­æ“ä½œã€‚</p>
<p>2ã€ç›‘è§†å™¨è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens - before äºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚</p>
<p>3ã€volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens - before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚</p>
<p>4ã€ä¼ é€’æ€§ï¼Œå¦‚æœ A happens - before Bï¼Œ B happens - before Cï¼Œé‚£ä¹ˆ A happens - before C</p>
<p>5ã€start() è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹ A æ‰§è¡Œæ“ä½œ ThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆçº¿ç¨‹ A çš„ ThreadB.start() æ“ä½œ happens - before çº¿ç¨‹ B ä¸­çš„ä»»æ„æ“ä½œã€‚</p>
<p>6ã€join() è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹ A æ‰§è¡Œæ“ä½œ ThreadB.join() å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹ B ä¸­çš„ä»»æ„æ“ä½œ happens- before äºçº¿ç¨‹ A ä» Thread.join() æ“ä½œæˆåŠŸè¿”å›ã€‚</p>
<p>âš ï¸åƒvolitaleå˜é‡ä¸€æ ·ï¼Œçº¿ç¨‹aå†™volatileå˜é‡å‰è¿˜å†™ä¸€ä¸ªå…±äº«å˜é‡ï¼Œçº¿ç¨‹bè¯»é‚£ä¸ªvolatileå˜é‡åè¿˜è¯»é‚£ä¸ªå…±äº«å˜é‡ï¼Œå¦‚ä½•ä¿è¯å…±äº«å˜é‡çš„å®‰å…¨æ€§ï¼Œå› ä¸ºçº¿ç¨‹aé‡Œçš„æ“ä½œå¯èƒ½é‡æ’åºï¼Œæ˜¯ç”±volitileçš„å†…å­˜å±éšœæ’å…¥ç­–ç•¥å’Œvolatileçš„ç¦æ­¢ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™æ¥ä¿è¯çš„ï¼Œå…¶ä»–startæ–¹æ³•å’Œjoinæ–¹æ³•ä¹Ÿä¸€æ ·ã€‚å› ä¸ºé‡æ’åºäº†çš„è¯ï¼Œæ‰§è¡Œç»“æœä¼šä¸ä¸€æ ·ã€‚</p>
<p>åŸä¹¦ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/laohuangaa/article/details/122773633">https://blog.csdn.net/laohuangaa/article/details/122773633</a></p>
<h3 id="8-åŒé‡æ£€æŸ¥é”å®šä¸å»¶è¿Ÿåˆå§‹åŒ–"><a href="#8-åŒé‡æ£€æŸ¥é”å®šä¸å»¶è¿Ÿåˆå§‹åŒ–" class="headerlink" title="8.åŒé‡æ£€æŸ¥é”å®šä¸å»¶è¿Ÿåˆå§‹åŒ–"></a>8.åŒé‡æ£€æŸ¥é”å®šä¸å»¶è¿Ÿåˆå§‹åŒ–</h3><p>åœ¨Javaå¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦é‡‡ç”¨å»¶è¿Ÿåˆå§‹åŒ–æ¥é™ä½åˆå§‹åŒ–ç±»å’Œåˆ›å»ºå¯¹è±¡çš„å¼€é”€ã€‚åŒé‡æ£€æŸ¥é”å®šæ˜¯å¸¸è§çš„å»¶è¿Ÿåˆå§‹åŒ–æŠ€æœ¯ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªé”™è¯¯çš„ç”¨æ³•ã€‚</p>
<p>ä¸‹é¢ä¼šè®²è¿°åŒé‡æ£€æŸ¥é”å®šä¸ºä»€ä¹ˆé”™è¯¯ï¼Œä»¥åŠä¸¤ç§çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–æ–¹æ¡ˆã€‚</p>
<h4 id="âœ…åŒé‡æ£€æŸ¥é”å®šçš„ç”±æ¥"><a href="#âœ…åŒé‡æ£€æŸ¥é”å®šçš„ç”±æ¥" class="headerlink" title="âœ…åŒé‡æ£€æŸ¥é”å®šçš„ç”±æ¥"></a>âœ…åŒé‡æ£€æŸ¥é”å®šçš„ç”±æ¥</h4><p>åœ¨Javaç¨‹åºä¸­ï¼Œæœ‰æ—¶å€™å¯èƒ½éœ€è¦æ¨è¿Ÿä¸€äº›é«˜å¼€é”€çš„å¯¹è±¡åˆå§‹åŒ–æ“ä½œï¼Œå¹¶ä¸”åªæœ‰åœ¨ä½¿ç”¨è¿™äº›å¯¹è±¡æ—¶æ‰è¿›è¡Œåˆå§‹åŒ–ã€‚æ­¤æ—¶ï¼Œç¨‹åºå‘˜å¯èƒ½ä¼šé‡‡ç”¨å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<p>å› ä¸ºåˆå§‹åŒ–å¯èƒ½åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå®ƒä»¬å…±ç”¨ä¸€ä¸ªå¯¹è±¡ï¼Œæ˜¯éœ€è¦ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå°±å¥½äº†ã€‚éçº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–å¯¹è±¡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class UnsafeLazyInitialization &#123;</span><br><span class="line">    private static Instance instance;</span><br><span class="line">    public static Instance getInstance() &#123;</span><br><span class="line">        if (instance == null) //1ï¼šAçº¿ç¨‹æ‰§è¡Œ</span><br><span class="line">            instance = new Instance(); //2ï¼šBçº¿ç¨‹æ‰§è¡Œ</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">    static class Instance &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Açº¿ç¨‹æ‰§è¡Œä»£ç 1çš„åŒæ—¶ï¼ŒBçº¿ç¨‹æ‰§è¡Œä»£ç 2ã€‚æ­¤æ—¶ï¼Œçº¿ç¨‹Aå¯èƒ½ä¼šçœ‹åˆ°instanceå¼•ç”¨çš„å¯¹è±¡è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–. å¯¼è‡´ABçº¿ç¨‹éƒ½åˆå§‹åŒ–å¯¹è±¡ã€‚</p>
<p>åŒæ­¥å¤„ç†æ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class SafeLazyInitialization &#123;</span><br><span class="line">    private static Instance instance;</span><br><span class="line">    public synchronized static Instance getInstance() &#123;</span><br><span class="line">        if (instance == null)</span><br><span class="line">            instance = new Instance();</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">    static class Instance &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼ºç‚¹ï¼šsynchronizedå°†å¯¼è‡´æ€§èƒ½å¼€é”€ã€‚å¦‚æœgetInstance()æ–¹æ³•è¢«å¤šä¸ªçº¿ç¨‹é¢‘ç¹çš„è°ƒç”¨ï¼Œå°†ä¼šå¯¼è‡´ç¨‹åºæ‰§è¡Œæ€§èƒ½çš„ä¸‹é™ã€‚</p>
<p>å› æ­¤ï¼ŒåŒé‡æ£€æŸ¥é”å®šæ¥å®ç°å»¶è¿Ÿåˆå§‹åŒ–è¯ç”Ÿï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class DoubleCheckedLocking &#123; //1</span><br><span class="line">    private static Instance instance; //2</span><br><span class="line">    public static Instance getInstance() &#123; //3</span><br><span class="line">        if (instance == null) &#123; //4:ç¬¬ä¸€æ¬¡æ£€æŸ¥</span><br><span class="line">            synchronized (DoubleCheckedLocking.class) &#123; //5:åŠ é”</span><br><span class="line">                if (instance == null) //6:ç¬¬äºŒæ¬¡æ£€æŸ¥</span><br><span class="line">                    instance = new Instance(); //7:é—®é¢˜çš„æ ¹æºå‡ºåœ¨è¿™é‡Œ</span><br><span class="line">            &#125; //8</span><br><span class="line">        &#125; //9</span><br><span class="line">        return instance; //10</span><br><span class="line">    &#125; //11</span><br><span class="line">    static class Instance &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒæ€æƒ³ï¼šä¸ä¼šæ¯ä¸ªçº¿ç¨‹éƒ½åŠ é”ï¼Œæ£€æŸ¥instanceä¸ä¸ºnullï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦æ‰§è¡Œä¸‹é¢çš„åŠ é”å’Œåˆå§‹åŒ–æ“ä½œã€‚è·å–é”ä¹‹åï¼Œå†æ£€æŸ¥ä¸€æ¬¡æ˜¯ä¸æ˜¯ä¸ºnullï¼Œå› ä¸ºåœ¨ç¬¬ä¸€æ¬¡åˆ¤æ–­æ˜¯å¦ä¸ºnullæ—¶ï¼Œå¯èƒ½å¦ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–ã€‚<br>ï¼ˆè·å–é”ä¹‹å‰æ£€æŸ¥ä¸€æ¬¡ï¼Œè·å–é”ä¹‹åæ£€æŸ¥ä¸€æ¬¡ï¼‰</p>
<p>ä½†æ˜¯æ˜¯é”™è¯¯çš„ï¼šåœ¨çº¿ç¨‹æ‰§è¡Œåˆ°ç¬¬4è¡Œï¼Œä»£ç è¯»å–åˆ°instanceä¸ä¸ºnullæ—¶ï¼Œinstanceå¼•ç”¨çš„å¯¹è±¡æœ‰å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚</p>
<h4 id="âœ…åŒé‡æ£€æŸ¥é”å®šçš„é—®é¢˜"><a href="#âœ…åŒé‡æ£€æŸ¥é”å®šçš„é—®é¢˜" class="headerlink" title="âœ…åŒé‡æ£€æŸ¥é”å®šçš„é—®é¢˜"></a>âœ…åŒé‡æ£€æŸ¥é”å®šçš„é—®é¢˜</h4><p>ç¬¬7è¡Œï¼ˆinstance=new Singleton();ï¼‰åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸€è¡Œä»£ç å¯ä»¥åˆ†è§£ä¸ºå¦‚ä¸‹çš„3è¡Œä¼ªä»£ç ã€‚</p>
<p>memory = allocate();ã€€ã€€// 1<strong>ï¼šåˆ†é…å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼ˆå¼•ç”¨å˜é‡ï¼‰<br>ctorInstance(memory);ã€€ // 2</strong>ï¼šåˆå§‹åŒ–å¯¹è±¡<br>instance = memory;ã€€ã€€ // 3**ï¼šè®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€ï¼ˆèµ‹å€¼å¼•ç”¨å˜é‡ï¼‰ï¼ˆè¿™ä¸ªæ—¶å€™å°±ä¸ä¸ºnulläº†ï¼‰</p>
<p>ä¸Šé¢3è¡Œä¼ªä»£ç ä¸­çš„2å’Œ3ä¹‹é—´ï¼Œå¯èƒ½ä¼šè¢«é‡æ’åºï¼Œå› ä¸ºè¿™ä¸ªé‡æ’åºåœ¨æ²¡æœ‰æ”¹å˜å•çº¿ç¨‹ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œå¯ä»¥æé«˜ç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ã€‚</p>
<p>å¦‚æœå‘ç”Ÿé‡æ’åºï¼Œå¦ä¸€ä¸ªå¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹Bå°±æœ‰å¯èƒ½åœ¨ç¬¬4è¡Œåˆ¤æ–­instanceä¸ä¸ºnullã€‚çº¿ç¨‹Bæ¥ä¸‹æ¥å°†è®¿é—®instanceæ‰€å¼•ç”¨çš„å¯¹è±¡ï¼Œä½†æ­¤æ—¶è¿™ä¸ªå¯¹è±¡å¯èƒ½è¿˜æ²¡æœ‰è¢«Açº¿ç¨‹åˆå§‹åŒ–ã€‚<strong>çº¿ç¨‹Bå°†ä¼šè®¿é—®åˆ°ä¸€ä¸ªè¿˜æœªåˆå§‹åŒ–çš„å¯¹è±¡</strong>ã€‚</p>
<p>å¦‚ä½•è§£å†³ï¼Œæ¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ï¼š<br>1ï¼‰ ä¸å…è®¸2å’Œ3é‡æ’åºã€‚<br>2ï¼‰å…è®¸2å’Œ3é‡æ’åºï¼Œä½†ä¸å…è®¸å…¶ä»–çº¿ç¨‹â€œçœ‹åˆ°â€è¿™ä¸ªé‡æ’åºã€‚</p>
<h4 id="âœ…åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ"><a href="#âœ…åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="âœ…åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ"></a>âœ…åŸºäºvolatileçš„è§£å†³æ–¹æ¡ˆ</h4><p>æŠŠinstanceå£°æ˜ä¸ºvolatileå‹ï¼Œå°±å¯ä»¥å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class SafeDoubleCheckedLocking &#123;</span><br><span class="line">    private volatile static Instance instance;</span><br><span class="line">    public static Instance getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            synchronized (SafeDoubleCheckedLocking.class) &#123;</span><br><span class="line">                if (instance == null)</span><br><span class="line">                    instance = new Instance();//instanceä¸ºvolatileï¼Œç°åœ¨æ²¡é—®é¢˜äº†</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">    static class Instance &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦JDK 5æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆå› ä¸ºä»JDK 5å¼€å§‹ä½¿ç”¨æ–°çš„JSR-133å†…å­˜æ¨¡å‹è§„èŒƒ).</p>
<p>åŸç†ï¼šä½¿ç”¨äº†volatileä¿®é¥°åï¼Œ2ã€3å°†ä¸ä¼šé‡æ’åºã€‚</p>
<h4 id="âœ…åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ"><a href="#âœ…åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="âœ…åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ"></a>âœ…åŸºäºç±»åˆå§‹åŒ–çš„è§£å†³æ–¹æ¡ˆ</h4><p>JVMåœ¨ç±»çš„åˆå§‹åŒ–é˜¶æ®µï¼ˆå³åœ¨Classè¢«åŠ è½½åï¼Œä¸”è¢«çº¿ç¨‹ä½¿ç”¨ä¹‹å‰ï¼‰ï¼Œä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ã€‚åœ¨æ‰§è¡Œç±»çš„åˆå§‹åŒ–æœŸé—´ï¼ŒJVMä¼šå»è·å–ä¸€ä¸ªé”ã€‚è¿™ä¸ªé”å¯ä»¥åŒæ­¥å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªç±»çš„åˆå§‹åŒ–ã€‚</p>
<p>ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class InstanceFactory &#123;</span><br><span class="line">    private static class InstanceHolder &#123;</span><br><span class="line">        public static Instance instance = new Instance();</span><br><span class="line">    &#125;</span><br><span class="line">    public static Instance getInstance() &#123;</span><br><span class="line">        return InstanceHolder.instance; //è¿™é‡Œå°†å¯¼è‡´InstanceHolderç±»è¢«åˆå§‹åŒ–</span><br><span class="line">    &#125;</span><br><span class="line">    static class Instance &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡ŒgetInstance()æ–¹æ³•ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–classå¯¹è±¡çš„åˆå§‹åŒ–é”ï¼Œç„¶åæ‰§è¡Œå¯¹è±¡åˆå§‹åŒ–ã€‚</p>
<p>ğŸ’¡åˆå§‹åŒ–ç±»çš„æ—¶æœºå’ŒåŸç†ï¼š</p>
<p>åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼ŒåŒ…æ‹¬<strong>æ‰§è¡Œè¿™ä¸ªç±»çš„é™æ€åˆå§‹åŒ–å’Œåˆå§‹åŒ–åœ¨è¿™ä¸ªç±»ä¸­å£°æ˜çš„é™æ€å­—æ®µ</strong>ã€‚æ ¹æ®Javaè¯­è¨€è§„èŒƒï¼Œåœ¨é¦–æ¬¡å‘ç”Ÿä¸‹åˆ—ä»»æ„ä¸€ç§æƒ…å†µæ—¶ï¼Œä¸€ä¸ªç±»æˆ–æ¥å£ç±»å‹Tå°†è¢«ç«‹å³åˆå§‹åŒ–ï¼š<br>1ï¼‰Tæ˜¯ä¸€ä¸ªç±»ï¼Œè€Œä¸”ä¸€ä¸ªTç±»å‹çš„å®ä¾‹è¢«åˆ›å»ºã€‚<br>2ï¼‰Tæ˜¯ä¸€ä¸ªç±»ï¼Œä¸”Tä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€æ–¹æ³•è¢«è°ƒç”¨ã€‚<br>3ï¼‰Tä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€å­—æ®µè¢«èµ‹å€¼ã€‚<br>4ï¼‰Tä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€å­—æ®µè¢«ä½¿ç”¨ï¼Œè€Œä¸”è¿™ä¸ªå­—æ®µä¸æ˜¯ä¸€ä¸ªå¸¸é‡å­—æ®µã€‚<br>5ï¼‰Tæ˜¯ä¸€ä¸ªé¡¶çº§ç±»ï¼ˆTop Level Classï¼‰ï¼Œè€Œä¸”ä¸€ä¸ªæ–­è¨€è¯­å¥åµŒå¥—åœ¨Tå†…éƒ¨è¢«æ‰§è¡Œã€‚</p>
<p>åœ¨InstanceFactoryç¤ºä¾‹ä»£ç ä¸­ï¼Œé¦–æ¬¡æ‰§è¡ŒgetInstance()æ–¹æ³•çš„çº¿ç¨‹å°†å¯¼è‡´InstanceHolderç±»è¢«åˆå§‹åŒ–ï¼Œæ˜¯æƒ…å†µ4.<br>ï¼ˆç›¸å½“äºæ˜¯ç”¨ä¸€ä¸ªå·¥å‚ç±»æ¥åˆå§‹åŒ–å¦ä¸€ä¸ªç±»ï¼Ÿï¼‰</p>
<p>Javaè¯­è¨€æ˜¯å¤šçº¿ç¨‹çš„ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åœ¨åŒä¸€æ—¶é—´å°è¯•å»åˆå§‹åŒ–åŒä¸€ä¸ªç±»æˆ–æ¥å£ï¼ˆæ¯”å¦‚è¿™é‡Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åœ¨åŒä¸€æ—¶åˆ»è°ƒç”¨getInstance()æ–¹æ³•æ¥åˆå§‹åŒ–InstanceHolderç±»ï¼‰ã€‚å› æ­¤ï¼Œåœ¨Javaä¸­åˆå§‹åŒ–ä¸€ä¸ªç±»æˆ–è€…æ¥å£æ—¶ï¼Œéœ€è¦åšç»†è‡´çš„åŒæ­¥å¤„ç†ã€‚</p>
<p>Javaè¯­è¨€è§„èŒƒè§„å®šï¼Œå¯¹äºæ¯ä¸€ä¸ªç±»æˆ–æ¥å£Cï¼Œéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åˆå§‹åŒ–é”LCä¸ä¹‹å¯¹åº”ã€‚ä»Cåˆ°LCçš„æ˜ å°„ï¼Œç”±JVMçš„å…·ä½“å®ç°å»è‡ªç”±å®ç°ã€‚JVMåœ¨ç±»åˆå§‹åŒ–æœŸé—´ä¼šè·å–è¿™ä¸ªåˆå§‹åŒ–é”ï¼Œå¹¶ä¸”æ¯ä¸ªçº¿ç¨‹è‡³å°‘è·å–ä¸€æ¬¡é”æ¥ç¡®ä¿è¿™ä¸ªç±»å·²ç»è¢«åˆå§‹åŒ–è¿‡äº†ã€‚</p>
<p>ï¼ˆ<strong>å¤šä¸ªçº¿ç¨‹åˆå§‹åŒ–ç±»ä¸æ˜¯åˆ›å»ºä¸åŒçš„å¯¹è±¡å—ï¼Ÿéš¾é“åˆå§‹åŒ–ç±»å’Œåˆ›å»ºå¯¹è±¡ä¸ä¸€æ ·ï¼Ÿ</strong> æ˜¯çš„ï¼Œå…ˆåˆå§‹åŒ–ç±»å†åˆ›å»ºå¯¹è±¡ï¼‰</p>
<p>å¯¹äºç±»æˆ–æ¥å£çš„åˆå§‹åŒ–ï¼ŒJavaè¯­è¨€è§„èŒƒåˆ¶å®šäº†ç²¾å·§è€Œå¤æ‚çš„ç±»åˆå§‹åŒ–å¤„ç†è¿‡ç¨‹ã€‚Javaåˆå§‹åŒ–ä¸€ä¸ªç±»æˆ–æ¥å£çš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>ç¬¬1é˜¶æ®µï¼šé€šè¿‡åœ¨Classå¯¹è±¡ä¸ŠåŒæ­¥ï¼ˆå³è·å–Classå¯¹è±¡çš„åˆå§‹åŒ–é”ï¼‰ï¼Œæ¥æ§åˆ¶ç±»æˆ–æ¥å£çš„åˆå§‹åŒ–ï¼Œè·å–é”ä¹‹åï¼Œåˆå§‹åŒ–ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œè®¾ç½®state=initialingï¼Œç„¶åé‡Šæ”¾é”ã€‚è·å–ä¸åˆ°çš„è¯ï¼Œè¿™ä¸ªè·å–é”çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¿™ä¸ªåˆå§‹åŒ–é”ã€‚</p>
<p>ç¬¬2é˜¶æ®µï¼šçº¿ç¨‹Aæ‰§è¡Œç±»çš„åˆå§‹åŒ–ï¼ˆä¸Šé¢çš„ä¸‰æ­¥ï¼‰ï¼ŒåŒæ—¶çº¿ç¨‹Bè·å–åˆ°åˆå§‹åŒ–é”ï¼Œå‘ç°çŠ¶æ€æ˜¯initialingï¼Œç„¶åé‡Šæ”¾é”ã€‚ååœ¨åˆå§‹åŒ–é”å¯¹åº”çš„conditionä¸Šç­‰å¾…ã€‚</p>
<p>ç¬¬3é˜¶æ®µï¼šçº¿ç¨‹Aè·å–åˆå§‹åŒ–é”ï¼Œè®¾ç½®state=initializedåï¼Œå”¤é†’åœ¨conditionä¸­ç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ï¼Œé‡Šæ”¾é”ã€‚</p>
<p>ç¬¬4é˜¶æ®µï¼šçº¿ç¨‹Bè·å–é”ï¼Œå‘ç°çŠ¶æ€æ˜¯initialedï¼Œé‡Šæ”¾é”ï¼Œç»“æŸç±»çš„åˆå§‹åŒ–å¤„ç†ã€‚</p>
<p>æ‰€ä»¥ï¼Œçº¿ç¨‹Aæ‰§è¡Œç±»çš„åˆå§‹åŒ–æ—¶çš„å†™å…¥æ“ä½œï¼ˆæ‰§è¡Œç±»çš„é™æ€åˆå§‹åŒ–å’Œåˆå§‹åŒ–ç±»ä¸­å£°æ˜çš„é™æ€å­—æ®µï¼‰ï¼Œçº¿ç¨‹Bä¸€å®šèƒ½çœ‹åˆ°ã€‚</p>
<p>æ³¨æ„ï¼šè¿™é‡Œçš„conditionå’Œstateæ ‡è®°æ˜¯æœ¬æ–‡è™šæ„å‡ºæ¥çš„ã€‚</p>
<p><strong>æ€»ç»“ï¼š</strong></p>
<p>åŸºäºç±»åˆå§‹åŒ–çš„æ–¹æ¡ˆçš„å®ç°ä»£ç æ›´ç®€æ´ï¼Œä½†åªèƒ½å¯¹é™æ€å­—æ®µä½¿ç”¨ã€‚ä½†åŸºäºvolatileçš„åŒé‡æ£€æŸ¥é”å®šçš„æ–¹æ¡ˆæœ‰ä¸€ä¸ªé¢å¤–çš„ä¼˜åŠ¿ï¼šé™¤äº†å¯ä»¥å¯¹é™æ€å­—æ®µå®ç°å»¶è¿Ÿåˆå§‹åŒ–å¤–ï¼Œè¿˜å¯ä»¥å¯¹å®ä¾‹å­—æ®µå®ç°å»¶è¿Ÿåˆå§‹åŒ–ã€‚</p>
<p>å­—æ®µå»¶è¿Ÿåˆå§‹åŒ–é™ä½äº†åˆå§‹åŒ–ç±»æˆ–åˆ›å»ºå®ä¾‹çš„å¼€é”€ï¼Œä½†å¢åŠ äº†è®¿é—®è¢«å»¶è¿Ÿåˆå§‹åŒ–çš„å­—æ®µçš„å¼€é”€ã€‚</p>
<p>åŸä¹¦ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://dandelioncloud.cn/article/details/1462953051467345921/">https://dandelioncloud.cn/article/details/1462953051467345921/</a></p>
<h3 id="9-javaå†…å­˜æ¨¡å‹ç»¼è¿°"><a href="#9-javaå†…å­˜æ¨¡å‹ç»¼è¿°" class="headerlink" title="9.javaå†…å­˜æ¨¡å‹ç»¼è¿°"></a>9.javaå†…å­˜æ¨¡å‹ç»¼è¿°</h3><h4 id="âœ…å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹"><a href="#âœ…å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹" class="headerlink" title="âœ…å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹"></a>âœ…å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹</h4><p>JMMï¼šç›¸å½“äºæ˜¯javaç¼–è¯‘å™¨çš„å†…å­˜æ¨¡å‹</p>
<p>é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªç†è®ºå‚è€ƒæ¨¡å‹ï¼ŒJMMå’Œå¤„ç†å™¨å†…å­˜æ¨¡å‹åœ¨è®¾è®¡æ—¶é€šå¸¸ä¼šä»¥é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸ºå‚ç…§ã€‚åœ¨è®¾è®¡æ—¶ï¼ŒJMMå’Œå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¼šå¯¹é¡ºåºä¸€è‡´æ€§æ¨¡å‹åšä¸€äº›æ”¾æ¾ï¼Œå› ä¸ºå¦‚æœå®Œå…¨æŒ‰ç…§é¡ºåºä¸€è‡´æ€§æ¨¡å‹æ¥å®ç°å¤„ç†å™¨å’ŒJMMï¼Œé‚£ä¹ˆå¾ˆå¤šçš„å¤„ç†å™¨å’Œç¼–è¯‘å™¨ä¼˜åŒ–éƒ½è¦è¢«ç¦æ­¢ï¼Œè¿™å¯¹æ‰§è¡Œæ€§èƒ½å°†ä¼šæœ‰å¾ˆå¤§çš„å½±å“ã€‚å†…å­˜æ¨¡å‹çš„æŸç¼šè¶Šå°‘ï¼Œå¤„ç†å™¨æ€§èƒ½è¶Šå¥½ã€‚</p>
<p>æ ¹æ®å¯¹ä¸åŒç±»å‹çš„è¯»/å†™æ“ä½œç»„åˆçš„æ‰§è¡Œé¡ºåºçš„æ”¾æ¾ï¼Œå¯ä»¥æŠŠå¸¸è§å¤„ç†å™¨çš„å†…å­˜æ¨¡å‹åˆ’åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ç±»å‹ï¼š<br>1ã€æ”¾æ¾ç¨‹åºä¸­å†™-è¯»æ“ä½œçš„é¡ºåºï¼Œç”±æ­¤äº§ç”Ÿäº†Total Store Orderingå†…å­˜æ¨¡å‹ï¼ˆç®€ç§°ä¸ºTSOï¼‰<br>2ã€åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ”¾æ¾ç¨‹åºä¸­å†™-å†™æ“ä½œçš„é¡ºåºï¼Œç”±æ­¤äº§ç”Ÿäº†Partial Store Orderå†…å­˜æ¨¡å‹ï¼ˆç®€ç§°ä¸ºPSOï¼‰ã€‚<br>3ã€åœ¨å‰é¢ä¸¤æ¡çš„åŸºç¡€ä¸Šï¼Œç»§ç»­æ”¾æ¾ç¨‹åºä¸­è¯»-å†™å’Œè¯»-è¯»æ“ä½œçš„é¡ºåºï¼Œç”±æ­¤äº§ç”Ÿäº†Relaxed Memory Orderå†…å­˜æ¨¡å‹ï¼ˆç®€ç§°ä¸ºRMOï¼‰å’ŒPowerPCå†…å­˜æ¨¡å‹ã€‚</p>
<p>è¿™é‡Œå¤„ç†å™¨å¯¹è¯»/å†™æ“ä½œçš„æ”¾æ¾ï¼Œæ˜¯ä»¥ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ä¸ºå‰æçš„ï¼ˆå› ä¸ºå¤„ç†å™¨è¦éµå®ˆas-if-serialè¯­ä¹‰ï¼Œ<strong>å¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–æ€§çš„ä¸¤ä¸ªå†…å­˜æ“ä½œåšé‡æ’åº</strong>ï¼‰ã€‚</p>
<p>æ‰€æœ‰å¤„ç†å™¨å†…å­˜æ¨¡å‹éƒ½å…è®¸å†™-è¯»é‡æ’åºï¼ŒåŸå› æ˜¯ï¼šä½¿ç”¨äº†å†™ç¼“å­˜åŒºã€‚å†™ç¼“å­˜åŒºå¯èƒ½å¯¼è‡´å†™-è¯»æ“ä½œé‡æ’åºã€‚éƒ½å…è®¸æ›´æ—©è¯»åˆ°å½“å‰å¤„ç†å™¨çš„å†™ï¼ŒåŸå› åŒæ ·æ˜¯å› ä¸ºå†™ç¼“å­˜åŒºã€‚ç”±äºå†™ç¼“å­˜åŒºä»…å¯¹å½“å‰å¤„ç†å™¨å¯è§ï¼Œè¿™ä¸ªç‰¹æ€§å¯¼è‡´å½“å‰å¤„ç†å™¨å¯ä»¥æ¯”å…¶ä»–å¤„ç†å™¨å…ˆçœ‹åˆ°ä¸´æ—¶ä¿å­˜åœ¨è‡ªå·±å†™ç¼“å­˜åŒºä¸­çš„å†™ã€‚</p>
<p><strong>è™šæ‹Ÿæœºå¯¹ä¸åŒæ“ä½œç³»ç»Ÿåæ˜ çš„ä¸€è‡´æ€§ï¼š</strong></p>
<p>ç”±äºå¸¸è§çš„å¤„ç†å™¨å†…å­˜æ¨¡å‹æ¯”JMMè¦å¼±ï¼ŒJavaç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æ‰§è¡ŒæŒ‡ä»¤åºåˆ—çš„é€‚å½“ä½ç½®æ’å…¥å†…å­˜å±éšœæ¥é™åˆ¶å¤„ç†å™¨çš„é‡æ’åºã€‚åŒæ—¶ï¼Œç”±äºå„ç§å¤„ç†å™¨å†…å­˜æ¨¡å‹çš„å¼ºå¼±ä¸åŒï¼Œä¸ºäº†åœ¨ä¸åŒçš„å¤„ç†å™¨å¹³å°å‘ç¨‹åºå‘˜å±•ç¤ºä¸€ä¸ªä¸€è‡´çš„å†…å­˜æ¨¡å‹ï¼ŒJMMåœ¨ä¸åŒçš„å¤„ç†å™¨ä¸­éœ€è¦æ’å…¥çš„å†…å­˜å±éšœçš„æ•°é‡å’Œç§ç±»ä¹Ÿä¸ç›¸åŒã€‚JMMå±è”½äº†ä¸åŒå¤„ç†å™¨å†…å­˜æ¨¡å‹çš„å·®å¼‚ï¼Œå®ƒåœ¨ä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šä¸ºJavaç¨‹åºå‘˜å‘ˆç°äº†ä¸€ä¸ªä¸€è‡´çš„å†…å­˜æ¨¡å‹ã€‚</p>
<h4 id="âœ…å„ç§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»"><a href="#âœ…å„ç§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»" class="headerlink" title="âœ…å„ç§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»"></a>âœ…å„ç§å†…å­˜æ¨¡å‹ä¹‹é—´çš„å…³ç³»</h4><p>JMMæ˜¯ä¸€ä¸ªè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå¤„ç†å™¨å†…å­˜æ¨¡å‹æ˜¯ç¡¬ä»¶çº§çš„å†…å­˜æ¨¡å‹ï¼Œé¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹æ˜¯ä¸€ä¸ªç†è®ºå‚è€ƒæ¨¡å‹ã€‚</p>
<p>å¤„ç†å™¨å†…å­˜æ¨¡å‹å’Œè¯­è¨€å†…å­˜æ¨¡å‹éƒ½æ¯”é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹è¦å¼±ã€‚åŒå¤„ç†å™¨å†…å­˜æ¨¡å‹ä¸€æ ·ï¼Œè¶Šæ˜¯è¿½æ±‚æ‰§è¡Œæ€§èƒ½çš„è¯­è¨€ï¼Œå†…å­˜æ¨¡å‹è®¾è®¡å¾—ä¼šè¶Šå¼±ã€‚</p>
<p>æ‰§è¡Œæ€§èƒ½è¶Šå¥½ï¼Œæ˜“ç¼–ç¨‹æ€§è¶Šå·®ã€‚</p>
<h4 id="âœ…JMMçš„å†…å­˜å¯è§æ€§ä¿è¯"><a href="#âœ…JMMçš„å†…å­˜å¯è§æ€§ä¿è¯" class="headerlink" title="âœ…JMMçš„å†…å­˜å¯è§æ€§ä¿è¯"></a>âœ…JMMçš„å†…å­˜å¯è§æ€§ä¿è¯</h4><p>1ã€å•çº¿ç¨‹ç¨‹åºã€‚å•çº¿ç¨‹ç¨‹åºä¸ä¼šå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚ç¼–è¯‘å™¨ã€runtimeå’Œå¤„ç†å™¨ä¼šå…±åŒç¡®ä¿å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒã€‚</p>
<p>2ã€æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œå°†å…·æœ‰é¡ºåºä¸€è‡´æ€§ï¼ˆç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒï¼‰ã€‚è¿™æ˜¯JMMå…³æ³¨çš„é‡ç‚¹ï¼ŒJMMé€šè¿‡é™åˆ¶ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„é‡æ’åºæ¥ä¸ºç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚</p>
<p>3ã€æœªåŒæ­¥/æœªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚JMMä¸ºå®ƒä»¬æä¾›äº†æœ€å°å®‰å…¨æ€§ä¿éšœï¼šçº¿ç¨‹æ‰§è¡Œæ—¶è¯»å–åˆ°çš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¹‹å‰æŸä¸ªçº¿ç¨‹å†™å…¥çš„å€¼ï¼Œè¦ä¹ˆæ˜¯é»˜è®¤å€¼ï¼ˆ0ã€nullã€falseï¼‰ã€‚</p>
<p>æœ€å°å®‰å…¨æ€§â€œå‘ç”Ÿâ€åœ¨å¯¹è±¡è¢«ä»»æ„çº¿ç¨‹ä½¿ç”¨ä¹‹å‰ã€‚64ä½æ•°æ®çš„éåŸå­æ€§å†™â€œå‘ç”Ÿâ€åœ¨å¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼ˆå†™å…±äº«å˜é‡ï¼‰ã€‚å¦‚æœæ˜¯å†™äº†ä¸€åŠçš„ï¼Œé‚£å°±æ˜¯çº¿ç¨‹Bå†™äº†ä¸€åŠçš„ï¼Œå¹¶ä¸æ˜¯nullã€‚<br>æœ€å°å®‰å…¨æ€§ä¿è¯çº¿ç¨‹è¯»å–åˆ°çš„å€¼ä¸ä¼šæ— ä¸­ç”Ÿæœ‰çš„å†’å‡ºæ¥ï¼Œä½†å¹¶ä¸ä¿è¯çº¿ç¨‹è¯»å–åˆ°çš„å€¼ä¸€å®šæ˜¯æ­£ç¡®çš„ã€‚</p>
<p>åªè¦å¤šçº¿ç¨‹ç¨‹åºæ˜¯æ­£ç¡®åŒæ­¥çš„ï¼ŒJMMä¿è¯è¯¥ç¨‹åºåœ¨ä»»æ„çš„å¤„ç†å™¨å¹³å°ä¸Šçš„æ‰§è¡Œç»“æœï¼Œä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœä¸€è‡´ã€‚</p>
<h4 id="âœ…JSR-133å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥"><a href="#âœ…JSR-133å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥" class="headerlink" title="âœ…JSR-133å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥"></a>âœ…JSR-133å¯¹æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥</h4><p>JSR-133å¯¹JDK 5ä¹‹å‰çš„æ—§å†…å­˜æ¨¡å‹çš„ä¿®è¡¥ä¸»è¦æœ‰ä¸¤ä¸ªã€‚</p>
<p>Â· å¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰ã€‚æ—§å†…å­˜æ¨¡å‹å…è®¸volatileå˜é‡ä¸æ™®é€šå˜é‡é‡æ’åºã€‚JSR-133ä¸¥æ ¼é™åˆ¶volatileå˜é‡ä¸æ™®é€šå˜é‡çš„é‡æ’åºï¼Œä½¿volatileçš„å†™-è¯»å’Œé”çš„é‡Šæ”¾-è·å–å…·æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚</p>
<p>Â· å¢å¼ºfinalçš„å†…å­˜è¯­ä¹‰ã€‚åœ¨æ—§å†…å­˜æ¨¡å‹ä¸­ï¼Œå¤šæ¬¡è¯»å–åŒä¸€ä¸ªfinalå˜é‡çš„å€¼å¯èƒ½ä¼šä¸ç›¸åŒã€‚ä¸ºæ­¤ï¼ŒJSR-133ä¸ºfinalå¢åŠ äº†ä¸¤ä¸ªé‡æ’åºè§„åˆ™ã€‚åœ¨ä¿è¯finalå¼•ç”¨ä¸ä¼šä»æ„é€ å‡½æ•°å†…é€¸å‡ºçš„æƒ…å†µä¸‹ï¼Œfinalå…·æœ‰äº†åˆå§‹åŒ–å®‰å…¨æ€§ã€‚</p>
<h2 id="ç¬¬å››ç« -javaå¹¶å‘ç¼–ç¨‹"><a href="#ç¬¬å››ç« -javaå¹¶å‘ç¼–ç¨‹" class="headerlink" title="ç¬¬å››ç«  javaå¹¶å‘ç¼–ç¨‹"></a>ç¬¬å››ç«  javaå¹¶å‘ç¼–ç¨‹</h2><p>Javaä»è¯ç”Ÿå¼€å§‹å°±æ˜æ™ºåœ°é€‰æ‹©äº†å†…ç½®å¯¹å¤šçº¿ç¨‹çš„æ”¯æŒï¼Œè¿™ä½¿å¾—Javaè¯­è¨€ç›¸æ¯”åŒä¸€æ—¶æœŸçš„å…¶ä»–è¯­è¨€å…·æœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚</p>
<p>çº¿ç¨‹ä½œä¸ºæ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•å…ƒï¼Œå¤šä¸ªçº¿ç¨‹èƒ½å¤ŸåŒæ—¶æ‰§è¡Œï¼ˆå¤šæ ¸åŒæ—¶ï¼Œå•æ ¸å¹¶å‘ï¼‰ï¼Œè¿™å°†æ˜¾è‘—æå‡ç¨‹åºæ€§èƒ½ï¼Œåœ¨å¤šæ ¸ç¯å¢ƒä¸­è¡¨ç°å¾—æ›´åŠ æ˜æ˜¾ã€‚ä½†æ˜¯ï¼Œè¿‡å¤šåœ°åˆ›å»ºçº¿ç¨‹å’Œå¯¹çº¿ç¨‹çš„ä¸å½“ç®¡ç†ä¹Ÿå®¹æ˜“é€ æˆé—®é¢˜ã€‚</p>
<h3 id="1-çº¿ç¨‹ç®€ä»‹"><a href="#1-çº¿ç¨‹ç®€ä»‹" class="headerlink" title="1.çº¿ç¨‹ç®€ä»‹"></a>1.çº¿ç¨‹ç®€ä»‹</h3><h4 id="âœ…ä»€ä¹ˆæ˜¯çº¿ç¨‹"><a href="#âœ…ä»€ä¹ˆæ˜¯çº¿ç¨‹" class="headerlink" title="âœ…ä»€ä¹ˆæ˜¯çº¿ç¨‹"></a>âœ…ä»€ä¹ˆæ˜¯çº¿ç¨‹</h4><p>ç°ä»£æ“ä½œç³»ç»Ÿåœ¨è¿è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•å…ƒæ˜¯çº¿ç¨‹ï¼Œä¹Ÿå«è½»é‡çº§è¿›ç¨‹ï¼ˆLight Weight Processï¼‰ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œå¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹éƒ½æ‹¥æœ‰å„è‡ªçš„è®¡æ•°å™¨ã€å †æ ˆå’Œå±€éƒ¨å˜é‡ç­‰å±æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®å…±äº«çš„å†…å­˜å˜é‡ã€‚</p>
<p>å¤„ç†å™¨åœ¨è¿™äº›çº¿ç¨‹ä¸Šé«˜é€Ÿåˆ‡æ¢ï¼Œè®©ä½¿ç”¨è€…æ„Ÿè§‰åˆ°è¿™äº›çº¿ç¨‹åœ¨åŒæ—¶æ‰§è¡Œã€‚</p>
<p>Javaç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œä½¿ç”¨JMXæ¥æŸ¥çœ‹ä¸€ä¸ªæ™®é€šçš„Javaç¨‹åºåŒ…å«å“ªäº›çº¿ç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class MultiThread&#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // è·å–Javaçº¿ç¨‹ç®¡ç† MXBean</span><br><span class="line">        ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();</span><br><span class="line">        // ä¸éœ€è¦è·å–åŒæ­¥çš„ monitor å’Œ synchronizer ä¿¡æ¯ï¼Œä»…è·å–çº¿ç¨‹å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯</span><br><span class="line">        ThreadInfo[] threadInfos = threadMXBean.dumpAllThreads(false, false);</span><br><span class="line">        // éå†çº¿ç¨‹ä¿¡æ¯ï¼Œä»…æ‰“å°çº¿ç¨‹ ID å’Œ çº¿ç¨‹åç§°ä¿¡æ¯</span><br><span class="line">        for (ThreadInfo threadInfo : threadInfos) &#123;</span><br><span class="line">            System.out.println(&quot;[&quot; + threadInfo.getThreadId() + &quot;] &quot; + threadInfo.getThreadName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="âœ…ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹"><a href="#âœ…ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹" class="headerlink" title="âœ…ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹"></a>âœ…ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹</h4><p>1ã€æ›´å¤šçš„å¤„ç†å™¨æ ¸å¿ƒ<br>å¦‚æœè¯¥ç¨‹åºä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ï¼Œå°†è®¡ç®—é€»è¾‘åˆ†é…åˆ°å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒä¸Šï¼Œå°±ä¼šæ˜¾è‘—å‡å°‘ç¨‹åºçš„å¤„ç†æ—¶é—´ï¼Œå¹¶ä¸”éšç€æ›´å¤šå¤„ç†å™¨æ ¸å¿ƒçš„åŠ å…¥è€Œå˜å¾—æ›´æœ‰æ•ˆç‡ã€‚</p>
<p>2ã€æ›´å¿«çš„å“åº”æ—¶é—´<br>ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ï¼Œå°†æ•°æ®ä¸€è‡´æ€§ä¸å¼ºçš„æ“ä½œæ´¾å‘ç»™ä¸åŒçº¿ç¨‹å¤„ç†ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå¯ä»¥åšåˆ°ï¼‰ï¼Œå“åº”ç”¨æˆ·è¯·æ±‚çš„çº¿ç¨‹èƒ½å¤Ÿå°½å¯èƒ½å¿«åœ°å¤„ç†å®Œæˆï¼Œç¼©çŸ­äº†å“åº”æ—¶é—´ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒã€‚</p>
<p>3ã€æ›´å¥½çš„ç¼–ç¨‹æ¨¡å¼<br>Javaä¸ºå¤šçº¿ç¨‹ç¼–ç¨‹æä¾›äº†è‰¯å¥½ã€è€ƒç©¶å¹¶ä¸”ä¸€è‡´çš„ç¼–ç¨‹æ¨¡å‹ï¼Œä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿæ›´åŠ ä¸“æ³¨äºé—®é¢˜çš„è§£å†³</p>
<h4 id="âœ…çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#âœ…çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="âœ…çº¿ç¨‹ä¼˜å…ˆçº§"></a>âœ…çº¿ç¨‹ä¼˜å…ˆçº§</h4><p>ç°ä»£æ“ä½œç³»ç»ŸåŸºæœ¬é‡‡ç”¨æ—¶åˆ†çš„å½¢å¼è°ƒåº¦è¿è¡Œçš„çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†å‡ºä¸€ä¸ªä¸ªæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹ä¼šåˆ†é…åˆ°è‹¥å¹²æ—¶é—´ç‰‡ï¼Œå½“çº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œäº†å°±ä¼šå‘ç”Ÿçº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ç­‰å¾…ç€ä¸‹æ¬¡åˆ†é…ã€‚</p>
<p>æ—¶é—´ç‰‡å°±æ˜¯åˆ†é…ç»™çº¿ç¨‹çš„å¤„ç†å™¨èµ„æºï¼Œåœ¨Javaçº¿ç¨‹ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ•´å‹æˆå‘˜å˜é‡priorityæ¥æ§åˆ¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§çš„èŒƒå›´ä»1~10ï¼Œåœ¨çº¿ç¨‹æ„å»ºçš„æ—¶å€™å¯ä»¥é€šè¿‡setPriority(int)æ–¹æ³•æ¥ä¿®æ”¹ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¼˜å…ˆçº§æ˜¯5ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡çš„æ•°é‡è¦å¤šäºä¼˜å…ˆçº§ä½çš„çº¿ç¨‹ã€‚</p>
<p>è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§æ—¶ï¼Œé’ˆå¯¹é¢‘ç¹é˜»å¡ï¼ˆä¼‘çœ æˆ–è€…I/Oæ“ä½œï¼‰çš„çº¿ç¨‹éœ€è¦è®¾ç½®è¾ƒé«˜ä¼˜å…ˆçº§ï¼Œè€Œåé‡è®¡ç®—ï¼ˆéœ€è¦è¾ƒå¤šCPUæ—¶é—´æˆ–è€…åè¿ç®—ï¼‰çš„çº¿ç¨‹åˆ™è®¾ç½®è¾ƒä½çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿å¤„ç†å™¨ä¸ä¼šè¢«ç‹¬å ã€‚</p>
<p>ä¸€ä¸ªè®¡æ•°çº¿ç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">static class Job implements Runnable &#123;</span><br><span class="line">            private int priority;</span><br><span class="line">            private long jobCount;</span><br><span class="line">            public Job(int priority) &#123;</span><br><span class="line">                    this.priority = priority;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            public void run() &#123;</span><br><span class="line">                while (notStart) &#123;</span><br><span class="line">                    Thread.yield();</span><br><span class="line">                &#125;</span><br><span class="line">                while (notEnd) &#123;</span><br><span class="line">                    Thread.yield();</span><br><span class="line">                    jobCount++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹10så¤šä¸ªä¸åŒä¼˜å…ˆçº§çš„è®¡æ•°ï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½ä¼šå¿½ç•¥å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„è®¾å®šã€‚</p>
<h4 id="âœ…çº¿ç¨‹çš„çŠ¶æ€"><a href="#âœ…çº¿ç¨‹çš„çŠ¶æ€" class="headerlink" title="âœ…çº¿ç¨‹çš„çŠ¶æ€"></a>âœ…çº¿ç¨‹çš„çŠ¶æ€</h4><p>çº¿ç¨‹åˆ›å»ºä¹‹åï¼Œè°ƒç”¨start()æ–¹æ³•å¼€å§‹è¿è¡Œã€‚å½“çº¿ç¨‹æ‰§è¡Œwait()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆé‡Šæ”¾é”ï¼‰ã€‚</p>
<p>è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ä¾é å…¶ä»–çº¿ç¨‹çš„é€šçŸ¥æ‰èƒ½å¤Ÿè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ï¼Œè€Œè¶…æ—¶ç­‰å¾…çŠ¶æ€ç›¸å½“äºåœ¨ç­‰å¾…çŠ¶æ€çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¶…æ—¶æ—¶é—´åˆ°è¾¾æ—¶å°†ä¼šè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ã€‚</p>
<p>å½“çº¿ç¨‹è°ƒç”¨åŒæ­¥æ–¹æ³•æ—¶ï¼Œåœ¨æ²¡æœ‰è·å–åˆ°é”çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å°†ä¼šè¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚çº¿ç¨‹åœ¨æ‰§è¡ŒRunnableçš„run()æ–¹æ³•ä¹‹åå°†ä¼šè¿›å…¥åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚</p>
<p>ç­‰å¾…å’Œè¶…æ—¶ç­‰å¾…çš„åŒºåˆ«ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//è¯¥çº¿ç¨‹åœ¨waiting.classå®ä¾‹ä¸Šç­‰å¾…</span><br><span class="line">static class Waiting implements Runnable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            synchronized (Waiting.class) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Waiting.class.wait();</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//è¯¥çº¿ç¨‹ä¸æ–­è¿›è¡Œç¡çœ ï¼Œè¶…æ—¶ç­‰å¾…</span><br><span class="line">static class TimeWaiting implements Runnable &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            SleepUtils.second(100);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Javaå°†æ“ä½œç³»ç»Ÿä¸­çš„è¿è¡Œå’Œå°±ç»ªä¸¤ä¸ªçŠ¶æ€åˆå¹¶ç§°ä¸ºè¿è¡ŒçŠ¶æ€ã€‚<br>é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹é˜»å¡åœ¨è¿›å…¥synchronizedå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼ˆè·å–é”ï¼‰æ—¶çš„çŠ¶æ€ï¼Œä½†æ˜¯é˜»å¡åœ¨java.concurrentåŒ…ä¸­Lockæ¥å£çš„çº¿ç¨‹çŠ¶æ€å´æ˜¯ç­‰å¾…çŠ¶æ€ï¼Œå› ä¸ºjava.concurrentåŒ…ä¸­Lockæ¥å£å¯¹äºé˜»å¡çš„å®ç°å‡ä½¿ç”¨äº†LockSupportç±»ä¸­çš„ç›¸å…³æ–¹æ³•ã€‚</p>
</blockquote>
<h4 id="âœ…Daemonçº¿ç¨‹"><a href="#âœ…Daemonçº¿ç¨‹" class="headerlink" title="âœ…Daemonçº¿ç¨‹"></a>âœ…Daemonçº¿ç¨‹</h4><p>å®ˆæŠ¤çº¿ç¨‹ã€‚</p>
<p>Daemonçº¿ç¨‹æ˜¯ä¸€ç§æ”¯æŒå‹çº¿ç¨‹ï¼Œå› ä¸ºå®ƒä¸»è¦è¢«ç”¨ä½œç¨‹åºä¸­åå°è°ƒåº¦ä»¥åŠæ”¯æŒæ€§å·¥ä½œã€‚è¿™æ„å‘³ç€ï¼Œå½“ä¸€ä¸ªJavaè™šæ‹Ÿæœºä¸­ä¸å­˜åœ¨éDaemonçº¿ç¨‹çš„æ—¶å€™ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šé€€å‡ºï¼Œæ‰€æœ‰Daemonçº¿ç¨‹éƒ½éœ€è¦ç«‹å³ç»ˆæ­¢ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨Thread.setDaemon(true)å°†çº¿ç¨‹è®¾ç½®ä¸ºDaemonçº¿ç¨‹ã€‚</p>
<p>Daemonå±æ€§éœ€è¦åœ¨å¯åŠ¨çº¿ç¨‹ä¹‹å‰è®¾ç½®ï¼Œä¸èƒ½åœ¨å¯åŠ¨çº¿ç¨‹ä¹‹åè®¾ç½®ã€‚Daemonçº¿ç¨‹è¢«ç”¨ä½œå®Œæˆæ”¯æŒæ€§å·¥ä½œï¼Œä½†æ˜¯åœ¨Javaè™šæ‹Ÿæœºé€€å‡ºæ—¶Daemonçº¿ç¨‹ä¸­çš„finallyå—å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œã€‚å› æ­¤ï¼Œä¸èƒ½ä¾é finallyå—ä¸­çš„å†…å®¹æ¥ç¡®ä¿æ‰§è¡Œå…³é—­æˆ–æ¸…ç†èµ„æºçš„é€»è¾‘ã€‚</p>
<h3 id="2-å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹"><a href="#2-å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹" class="headerlink" title="2.å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹"></a>2.å¯åŠ¨å’Œç»ˆæ­¢çº¿ç¨‹</h3><p>è°ƒç”¨startæ–¹æ³•è¿›è¡Œå¯åŠ¨çº¿ç¨‹ï¼Œéšç€runæ–¹æ³•çš„æ‰§è¡Œå®Œæ¯•ï¼Œçº¿ç¨‹éšä¹‹ç»ˆæ­¢ã€‚</p>
<h4 id="âœ…æ„é€ çº¿ç¨‹"><a href="#âœ…æ„é€ çº¿ç¨‹" class="headerlink" title="âœ…æ„é€ çº¿ç¨‹"></a>âœ…æ„é€ çº¿ç¨‹</h4><p>åœ¨è¿è¡Œçº¿ç¨‹ä¹‹å‰é¦–å…ˆè¦æ„é€ ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œçº¿ç¨‹å¯¹è±¡åœ¨æ„é€ çš„æ—¶å€™éœ€è¦æä¾›çº¿ç¨‹æ‰€éœ€è¦çš„å±æ€§ï¼Œå¦‚çº¿ç¨‹æ‰€å±çš„çº¿ç¨‹ç»„ã€çº¿ç¨‹ä¼˜å…ˆçº§ã€æ˜¯å¦æ˜¯Daemonçº¿ç¨‹ç­‰ä¿¡æ¯ã€‚</p>
<p>ä¸ªæ–°æ„é€ çš„çº¿ç¨‹å¯¹è±¡æ˜¯ç”±å…¶parentçº¿ç¨‹æ¥è¿›è¡Œç©ºé—´åˆ†é…çš„ï¼Œè€Œchildçº¿ç¨‹ç»§æ‰¿äº†parentæ˜¯å¦ä¸ºDaemonã€ä¼˜å…ˆçº§å’ŒåŠ è½½èµ„æºçš„contextClassLoaderä»¥åŠå¯ç»§æ‰¿çš„ThreadLocalï¼ŒåŒæ—¶è¿˜ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDæ¥æ ‡è¯†è¿™ä¸ªchildçº¿ç¨‹ã€‚</p>
<p>ä¸€ä¸ªèƒ½å¤Ÿè¿è¡Œçš„çº¿ç¨‹å¯¹è±¡å°±åˆå§‹åŒ–å¥½äº†ï¼Œåœ¨å †å†…å­˜ä¸­ç­‰å¾…ç€è¿è¡Œã€‚</p>
<h4 id="âœ…å¯åŠ¨çº¿ç¨‹"><a href="#âœ…å¯åŠ¨çº¿ç¨‹" class="headerlink" title="âœ…å¯åŠ¨çº¿ç¨‹"></a>âœ…å¯åŠ¨çº¿ç¨‹</h4><p>çº¿ç¨‹å¯¹è±¡åœ¨åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè°ƒç”¨start()æ–¹æ³•å°±å¯ä»¥å¯åŠ¨è¿™ä¸ªçº¿ç¨‹ã€‚</p>
<p>çº¿ç¨‹start()æ–¹æ³•çš„å«ä¹‰æ˜¯ï¼šå½“å‰çº¿ç¨‹ï¼ˆå³parentçº¿ç¨‹ï¼‰åŒæ­¥å‘ŠçŸ¥Javaè™šæ‹Ÿæœºï¼Œåªè¦çº¿ç¨‹è§„åˆ’å™¨ç©ºé—²ï¼Œåº”ç«‹å³å¯åŠ¨è°ƒç”¨start()æ–¹æ³•çš„çº¿ç¨‹ã€‚</p>
<h4 id="âœ…ä¸­æ–­çº¿ç¨‹"><a href="#âœ…ä¸­æ–­çº¿ç¨‹" class="headerlink" title="âœ…ä¸­æ–­çº¿ç¨‹"></a>âœ…ä¸­æ–­çº¿ç¨‹</h4><p>ä¸­æ–­ï¼Œæ•ˆæœæ˜¯ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹çš„ä¸€ä¸ªæ ‡è¯†ä½å±æ€§ ï¼ˆå¹¶ä¸èƒ½ç›´æ¥ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¸­æ–­æ“ä½œã€‚</p>
<p>ä¸­æ–­å¥½æ¯”å…¶ä»–çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æ‰“äº†ä¸ªæ‹›å‘¼ï¼Œå…¶ä»–çº¿ç¨‹é€šè¿‡è°ƒç”¨è¯¥çº¿ç¨‹çš„ interrupt() æ–¹æ³•å¯¹å…¶è¿›è¡Œä¸­æ–­æ“ä½œã€‚çº¿ç¨‹é€šè¿‡æ£€æŸ¥è‡ªèº«æ˜¯å¦è¢«ä¸­æ–­æ¥è¿›è¡Œå“åº”ï¼Œçº¿ç¨‹é€šè¿‡æ–¹æ³• isInterrupted() æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ã€‚</p>
<p>ä»Javaçš„APIä¸­å¯ä»¥çœ‹åˆ°ï¼Œè®¸å¤šå£°æ˜æŠ›å‡ºInterruptedExceptionçš„æ–¹æ³•ï¼ˆä¾‹å¦‚Thread.sleep ï¼ˆlong millisï¼‰æ–¹æ³•ï¼‰è¿™äº›æ–¹æ³•åœ¨æŠ›å‡ºInterruptedExceptionä¹‹å‰ï¼ŒJavaè™šæ‹Ÿæœºä¼šå…ˆå°†è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ä½æ¸…é™¤ï¼Œç„¶åæŠ›å‡ºInterruptedExceptionï¼Œæ­¤æ—¶è°ƒç”¨isInterrupted()æ–¹æ³•å°†ä¼šè¿”å›falseã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹ï¼ŒSleepThreadå’ŒBusyThreadï¼Œå‰è€…ä¸åœåœ°ç¡çœ ï¼Œåè€…ä¸€ç›´è¿è¡Œï¼Œç„¶åå¯¹è¿™ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œä¸­æ–­æ“ä½œï¼Œè§‚å¯ŸäºŒè€…çš„ä¸­æ–­æ ‡è¯†ä½ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">public class Interrupted &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        // sleepThreadä¸åœçš„å°è¯•ç¡çœ </span><br><span class="line">        Thread sleepThread = new Thread(new SleepRunner(), &quot;SleepThread&quot;);</span><br><span class="line">        sleepThread.setDaemon(true);</span><br><span class="line">        // busyThreadä¸åœçš„è¿è¡Œ</span><br><span class="line">        Thread busyThread = new Thread(new BusyRunner(), &quot;BusyThread&quot;);</span><br><span class="line">        busyThread.setDaemon(true);</span><br><span class="line">        sleepThread.start();</span><br><span class="line">        busyThread.start();</span><br><span class="line">        // ä¼‘çœ 5ç§’ï¼Œè®©sleepThreadå’ŒbusyThreadå……åˆ†è¿è¡Œ</span><br><span class="line">        TimeUnit.SECONDS.sleep(5);</span><br><span class="line">        sleepThread.interrupt();</span><br><span class="line">        busyThread.interrupt();</span><br><span class="line">        System.out.println(&quot;SleepThread interrupted is &quot; + sleepThread.isInterrupted());</span><br><span class="line">        System.out.println(&quot;BusyThread interrupted is &quot; + busyThread.isInterrupted());</span><br><span class="line">        // é˜²æ­¢sleepThreadå’ŒbusyThreadç«‹åˆ»é€€å‡º</span><br><span class="line">        Thread.sleep(2000);</span><br><span class="line">    &#125;</span><br><span class="line">    static class SleepRunner implements Runnable &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(10000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    // å¯¹äºSleepï¼Œå¦‚æœå‘ç”Ÿäº†ä¸­æ–­ï¼Œå°±ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚æŠ›å‡ºåï¼Œinterruptçš„è¡¨ç¤ºä½ä¼šè¢«é‡ç½®ã€‚</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    static class BusyRunner implements Runnable &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒæŠ›å‡ºInterruptedExceptionçš„çº¿ç¨‹SleepThreadï¼Œå…¶ä¸­æ–­æ ‡è¯†ä½è¢«æ¸…é™¤äº†ï¼Œè¿”å›falseã€‚è€Œä¸€ç›´å¿™ç¢Œè¿ä½œçš„çº¿ç¨‹BusyThreadï¼Œä¸­æ–­æ ‡è¯†ä½æ²¡æœ‰è¢«æ¸…é™¤ï¼Œè¿”å›trueã€‚</p>
<h4 id="âœ…è¿‡æœŸçš„suspend-ã€resume-å’Œstop"><a href="#âœ…è¿‡æœŸçš„suspend-ã€resume-å’Œstop" class="headerlink" title="âœ…è¿‡æœŸçš„suspend()ã€resume()å’Œstop()"></a>âœ…è¿‡æœŸçš„suspend()ã€resume()å’Œstop()</h4><p>suspend()ã€resume()å’Œstop()æ–¹æ³•å®Œæˆäº†çº¿ç¨‹çš„æš‚åœã€æ¢å¤å’Œç»ˆæ­¢å·¥ä½œï¼Œè€Œä¸”éå¸¸â€œäººæ€§åŒ–â€ã€‚ä½†æ˜¯è¿™äº›APIæ˜¯è¿‡æœŸçš„ï¼Œä¹Ÿå°±æ˜¯ä¸å»ºè®®ä½¿ç”¨çš„ã€‚</p>
<p>ä¸å»ºè®®ä½¿ç”¨çš„åŸå› ä¸»è¦æ˜¯ï¼š</p>
<p>ä»¥suspend()æ–¹æ³•ä¸ºä¾‹ï¼Œåœ¨è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šé‡Šæ”¾å·²ç»å æœ‰çš„èµ„æºï¼ˆæ¯”å¦‚é”ï¼‰ï¼Œè€Œæ˜¯å æœ‰ç€èµ„æºè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¿™æ ·å®¹æ˜“å¼•å‘æ­»é”é—®é¢˜ã€‚<br>åŒæ ·ï¼Œstop()æ–¹æ³•åœ¨ç»ˆç»“ä¸€ä¸ªçº¿ç¨‹æ—¶ä¸ä¼šä¿è¯çº¿ç¨‹çš„èµ„æºæ­£å¸¸é‡Šæ”¾ï¼Œé€šå¸¸æ˜¯æ²¡æœ‰ç»™äºˆçº¿ç¨‹å®Œæˆèµ„æºé‡Šæ”¾å·¥ä½œçš„æœºä¼šï¼Œå› æ­¤ä¼šå¯¼è‡´ç¨‹åºå¯èƒ½å·¥ä½œåœ¨ä¸ç¡®å®šçŠ¶æ€ä¸‹ã€‚</p>
<p>æš‚åœå’Œæ¢å¤æ“ä½œå¯ä»¥ç”¨åé¢æåˆ°çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶æ¥æ›¿ä»£ã€‚</p>
<h4 id="âœ…å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹"><a href="#âœ…å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹" class="headerlink" title="âœ…å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹"></a>âœ…å®‰å…¨åœ°ç»ˆæ­¢çº¿ç¨‹</h4><p>ä¸­æ–­çŠ¶æ€æ˜¯çº¿ç¨‹çš„ä¸€ä¸ªæ ‡è¯†ä½ï¼Œè€Œä¸­æ–­æ“ä½œæ˜¯ä¸€ç§ç®€ä¾¿çš„çº¿ç¨‹é—´äº¤äº’æ–¹å¼ï¼Œè€Œè¿™ç§äº¤äº’æ–¹å¼æœ€é€‚åˆç”¨æ¥å–æ¶ˆæˆ–åœæ­¢ä»»åŠ¡ã€‚</p>
<p>é™¤äº†ä¸­æ–­ä»¥å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨ä¸€ä¸ªbooleanå˜é‡æ¥æ§åˆ¶æ˜¯å¦éœ€è¦åœæ­¢ä»»åŠ¡å¹¶ç»ˆæ­¢è¯¥çº¿ç¨‹ã€‚</p>
<p>æ–¹æ³•1ï¼šä½¿ç”¨ä¸­æ–­interruptæ–¹æ³•è¿›è¡Œä¸­æ–­ã€‚æŒ‰è¯´æ˜¯ç›´æ¥ä¸­æ–­çº¿ç¨‹äº†ï¼Œæ²¡åŠ ä»£ç ä¸­çš„åˆ¤æ–­ä¹Ÿåº”è¯¥ä¸­æ–­çš„ã€‚â“<br>æ–¹æ³•2ï¼šä½¿ç”¨ä¸€ä¸ªvolatileçš„booleanç±»å‹å˜é‡æ¥æ§åˆ¶ï¼Œå®é™…ä¸Šæ˜¯ä¸­æ–­whileæ–¹æ³•ï¼Œç„¶åæ‰§è¡Œå®Œrunæ–¹æ³•ï¼Œç»ˆæ­¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class Shutdown &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Runner one = new Runner();</span><br><span class="line">        Thread countThread = new Thread(one, &quot;CountThread&quot;);</span><br><span class="line">        countThread.start();</span><br><span class="line">        // ç¡çœ 1ç§’ï¼Œmainçº¿ç¨‹å¯¹CountThreadè¿›è¡Œä¸­æ–­ï¼Œä½¿CountThreadèƒ½å¤Ÿæ„ŸçŸ¥ä¸­æ–­è€Œç»“æŸ</span><br><span class="line">        TimeUnit.SECONDS.sleep(1);</span><br><span class="line">        countThread.interrupt();</span><br><span class="line">        Runner two = new Runner();</span><br><span class="line">        countThread = new Thread(two, &quot;CountThread&quot;);</span><br><span class="line">        countThread.start();</span><br><span class="line">        // ç¡çœ 1ç§’ï¼Œmainçº¿ç¨‹å¯¹Runner twoè¿›è¡Œå–æ¶ˆï¼Œä½¿CountThreadèƒ½å¤Ÿæ„ŸçŸ¥onä¸ºfalseè€Œç»“æŸ</span><br><span class="line">        TimeUnit.SECONDS.sleep(1);</span><br><span class="line">        two.cancel();</span><br><span class="line">    &#125;</span><br><span class="line">    private static class Runner implements Runnable &#123;</span><br><span class="line">        private long i;</span><br><span class="line">            private volatile boolean on = true;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">            while (on &amp;&amp; !Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;Count i = &quot; + i);</span><br><span class="line">        &#125;</span><br><span class="line">        public void cancel() &#123;</span><br><span class="line">            on = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œmainçº¿ç¨‹é€šè¿‡ä¸­æ–­æ“ä½œå’Œcancel()æ–¹æ³•å‡å¯ä½¿CountThreadå¾—ä»¥ç»ˆæ­¢ã€‚</p>
<p>è¿™ç§é€šè¿‡æ ‡è¯†ä½æˆ–è€…ä¸­æ–­æ“ä½œçš„æ–¹å¼èƒ½å¤Ÿä½¿çº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶æœ‰æœºä¼šå»æ¸…ç†èµ„æºï¼Œè€Œä¸æ˜¯æ­¦æ–­åœ°å°†çº¿ç¨‹åœæ­¢ï¼Œå› æ­¤è¿™ç§ç»ˆæ­¢çº¿ç¨‹çš„åšæ³•æ˜¾å¾—æ›´åŠ å®‰å…¨å’Œä¼˜é›…ã€‚</p>
<h3 id="3-çº¿ç¨‹é—´é€šä¿¡"><a href="#3-çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="3.çº¿ç¨‹é—´é€šä¿¡"></a>3.çº¿ç¨‹é—´é€šä¿¡</h3><p>çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œæ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œå°±å¦‚åŒä¸€ä¸ªè„šæœ¬ä¸€æ ·ï¼ŒæŒ‰ç…§æ—¢å®šçš„ä»£ç ä¸€æ­¥ä¸€æ­¥åœ°æ‰§è¡Œï¼Œç›´åˆ°ç»ˆæ­¢ã€‚å¤šä¸ªçº¿ç¨‹é…åˆå·¥ä½œï¼Œæ‰æ›´æœ‰ä»·å€¼ã€‚</p>
<h4 id="âœ…volatileå’Œsynchronizedå…³é”®å­—"><a href="#âœ…volatileå’Œsynchronizedå…³é”®å­—" class="headerlink" title="âœ…volatileå’Œsynchronizedå…³é”®å­—"></a>âœ…volatileå’Œsynchronizedå…³é”®å­—</h4><p>èƒŒæ™¯ï¼š<br>Javaæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªå¯¹è±¡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œç”±äºæ¯ä¸ªçº¿ç¨‹å¯ä»¥æ‹¥æœ‰è¿™ä¸ªå˜é‡çš„æ‹·è´ï¼ˆè™½ç„¶å¯¹è±¡ä»¥åŠæˆå‘˜å˜é‡åˆ†é…çš„å†…å­˜æ˜¯åœ¨å…±äº«å†…å­˜ä¸­çš„ï¼Œä½†æ˜¯æ¯ä¸ªæ‰§è¡Œçš„çº¿ç¨‹è¿˜å¯ä»¥æ‹¥æœ‰ä¸€ä»½æ‹·è´ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯åŠ é€Ÿç¨‹åºçš„æ‰§è¡Œï¼Œè¿™æ˜¯ç°ä»£å¤šæ ¸å¤„ç†å™¨çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹æ€§ï¼‰ï¼ˆå°±æ˜¯çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ï¼‰ï¼Œæ‰€ä»¥ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹çœ‹åˆ°çš„å˜é‡å¹¶ä¸ä¸€å®šæ˜¯æœ€æ–°çš„ã€‚</p>
<p>volatileæ€ä¹ˆè§£å†³ï¼š<br>å…³é”®å­—volatileå¯ä»¥ç”¨æ¥ä¿®é¥°å­—æ®µï¼ˆæˆå‘˜å˜é‡ï¼‰ï¼Œå°±æ˜¯å‘ŠçŸ¥ç¨‹åºä»»ä½•å¯¹è¯¥å˜é‡çš„è®¿é—®å‡éœ€è¦ä»å…±äº«å†…å­˜ä¸­è·å–ï¼Œè€Œå¯¹å®ƒçš„æ”¹å˜å¿…é¡»åŒæ­¥åˆ·æ–°å›å…±äº«å†…å­˜ï¼Œå®ƒèƒ½ä¿è¯æ‰€æœ‰çº¿ç¨‹å¯¹å˜é‡è®¿é—®çš„å¯è§æ€§ã€‚</p>
<p>sychronizedæ€ä¹ˆè§£å†³ï¼š<br>å…³é”®å­—synchronizedå¯ä»¥ä¿®é¥°æ–¹æ³•æˆ–è€…ä»¥åŒæ­¥å—çš„å½¢å¼æ¥è¿›è¡Œä½¿ç”¨ï¼Œå®ƒä¸»è¦ç¡®ä¿å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºæ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­ï¼Œå®ƒä¿è¯äº†çº¿ç¨‹å¯¹å˜é‡è®¿é—®çš„å¯è§æ€§å’Œæ’ä»–æ€§ã€‚</p>
<p>ä¸€ç‚¹sychronizedçš„å®ç°åŸç†ï¼š</p>
<p>çœ‹å­—èŠ‚ç æ–‡ä»¶ï¼Œmonitorenterå’ŒmonitorexitæŒ‡ä»¤ï¼Œæ˜¯å¯¹ä¸€ä¸ªå¯¹è±¡çš„ç›‘è§†å™¨çš„è·å–ï¼Œè¿™ä¸ªè·å–è¿‡ç¨‹æ˜¯æ’ä»–çš„ï¼Œä¸€ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°ç”±sychronizedä¿æŠ¤çš„å¯¹è±¡çš„ç›‘è§†å™¨ã€‚</p>
<p>ä»»æ„ä¸€ä¸ªå¯¹è±¡éƒ½æ‹¥æœ‰è‡ªå·±çš„ç›‘è§†å™¨ï¼Œå½“è¿™ä¸ªå¯¹è±¡ç”±åŒæ­¥å—æˆ–è€…è¿™ä¸ªå¯¹è±¡çš„åŒæ­¥æ–¹æ³•è°ƒç”¨æ—¶ï¼Œæ‰§è¡Œæ–¹æ³•çš„çº¿ç¨‹å¿…é¡»å…ˆè·å–åˆ°è¯¥å¯¹è±¡çš„ç›‘è§†å™¨æ‰èƒ½è¿›å…¥åŒæ­¥å—æˆ–è€…åŒæ­¥æ–¹æ³•ï¼Œè€Œæ²¡æœ‰è·å–åˆ°ç›‘è§†å™¨ï¼ˆæ‰§è¡Œè¯¥æ–¹æ³•ï¼‰çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡åœ¨åŒæ­¥å—å’ŒåŒæ­¥æ–¹æ³•çš„å…¥å£å¤„ï¼ˆè¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼‰ï¼Œè¿›å…¥BLOCKEDçŠ¶æ€ã€‚å½“è·é”çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œè¯¥é‡Šæ”¾æ“ä½œå”¤é†’é˜»å¡åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œé‡æ–°å°è¯•å¯¹ç›‘è§†å™¨çš„è·å–ã€‚</p>
<h4 id="âœ…ç­‰å¾…-é€šçŸ¥æœºåˆ¶"><a href="#âœ…ç­‰å¾…-é€šçŸ¥æœºåˆ¶" class="headerlink" title="âœ…ç­‰å¾…/é€šçŸ¥æœºåˆ¶"></a>âœ…ç­‰å¾…/é€šçŸ¥æœºåˆ¶</h4><p>èƒŒæ™¯ï¼šç”Ÿäº§è€…çº¿ç¨‹ä¿®æ”¹æŸä¸ªå˜é‡çš„å€¼ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹èƒ½å¤Ÿæ„ŸçŸ¥åˆ°ã€‚ç®€å•çš„åŠæ³•æ˜¯è®©æ¶ˆè´¹è€…çº¿ç¨‹ä¸æ–­åœ°å¾ªç¯æ£€æŸ¥å˜é‡æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚ä½†æ˜¯å¼€é”€å¤§ã€‚</p>
<p>Javaé€šè¿‡å†…ç½®çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶èƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³è¿™ä¸ªçŸ›ç›¾å¹¶å®ç°æ‰€éœ€çš„åŠŸèƒ½ã€‚<br>ç­‰å¾…/é€šçŸ¥çš„ç›¸å…³æ–¹æ³•æ˜¯ä»»æ„Javaå¯¹è±¡éƒ½å…·å¤‡çš„ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•è¢«å®šä¹‰åœ¨æ‰€æœ‰å¯¹è±¡çš„è¶…ç±»java.lang.Objectä¸Šã€‚ï¼ˆç›‘è§†å™¨æ–¹æ³•ï¼‰</p>
<p>ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œæ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†å¯¹è±¡Oçš„wait()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Bè°ƒç”¨äº†å¯¹è±¡Oçš„notify()æˆ–è€…notifyAll()æ–¹æ³•ï¼Œçº¿ç¨‹Aæ”¶åˆ°é€šçŸ¥åä»å¯¹è±¡Oçš„wait()æ–¹æ³•è¿”å›ï¼Œè¿›è€Œæ‰§è¡Œåç»­æ“ä½œã€‚<br>ä¸Šè¿°ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹è±¡Oæ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„wait()å’Œnotify/notifyAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚ï¼ˆä¸¤ä¸ªnotifyéƒ½æ˜¯é€šçŸ¥ç­‰å¾…é˜Ÿåˆ—é‡Œçš„ï¼Œä¸æ˜¯é˜»å¡çŠ¶æ€çš„åŒæ­¥é˜Ÿåˆ—ï¼Œnotifyé€šçŸ¥ä¸€ä¸ªï¼ŒnotifyAllé€šçŸ¥æ‰€æœ‰ï¼‰ã€‚</p>
<p>ä¾‹å­ï¼šåˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹â€”â€”WaitThreadå’ŒNotifyThreadï¼Œå‰è€…æ£€æŸ¥flagå€¼æ˜¯å¦ä¸ºfalseï¼Œå¦‚æœç¬¦åˆè¦æ±‚ï¼Œè¿›è¡Œåç»­æ“ä½œï¼Œå¦åˆ™åœ¨lockä¸Šç­‰å¾…ï¼Œåè€…åœ¨ç¡çœ äº†ä¸€æ®µæ—¶é—´åå¯¹lockè¿›è¡Œé€šçŸ¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">public class WaitNotify &#123;</span><br><span class="line">    static boolean flag = true;</span><br><span class="line">    static Object lock = new Object();</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Thread waitThread = new Thread(new Wait(), &quot;WaitThread&quot;);</span><br><span class="line">        waitThread.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(1);</span><br><span class="line">        Thread notifyThread = new Thread(new Notify(), &quot;NotifyThread&quot;);</span><br><span class="line">        notifyThread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    static class Wait implements Runnable &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            // åŠ é”ï¼Œæ‹¥æœ‰lockçš„Monitor</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                // å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œç»§ç»­waitï¼ŒåŒæ—¶é‡Šæ”¾äº†lockçš„é”</span><br><span class="line">                while (flag) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread() + &quot; flag is true. wait@ &quot; + new SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new Date()));</span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                // æ¡ä»¶æ»¡è¶³æ—¶ï¼Œå®Œæˆå·¥ä½œ</span><br><span class="line">                System.out.println(Thread.currentThread() + &quot; flag is false. running@ &quot; + new SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new Date()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    static class Notify implements Runnable &#123;</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            // åŠ é”ï¼Œæ‹¥æœ‰lockçš„Monitor</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                // è·å–lockçš„é”ï¼Œç„¶åè¿›è¡Œé€šçŸ¥ï¼Œé€šçŸ¥æ—¶ä¸ä¼šé‡Šæ”¾lockçš„é”ï¼Œ</span><br><span class="line">                // ç›´åˆ°å½“å‰çº¿ç¨‹é‡Šæ”¾äº†lockåï¼ŒWaitThreadæ‰èƒ½ä»waitæ–¹æ³•ä¸­è¿”å›</span><br><span class="line">                System.out.println(Thread.currentThread() + &quot; hold lock. notify @ &quot; +</span><br><span class="line">                        new SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new Date()));</span><br><span class="line">                lock.notifyAll();</span><br><span class="line">                flag = false;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(5000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    throw new RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // å†æ¬¡åŠ é”</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + &quot; hold lock again. sleep@ &quot; + new SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new Date()));</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(5000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    throw new RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨wait()ã€notify()ä»¥åŠnotifyAll()æ—¶éœ€è¦æ³¨æ„çš„ç»†èŠ‚:</p>
<p>1ã€ä½¿ç”¨wait()ã€notify()å’ŒnotifyAll()æ—¶éœ€è¦å…ˆå¯¹è°ƒç”¨å¯¹è±¡åŠ é”ã€‚</p>
<p>2ã€è°ƒç”¨wait()æ–¹æ³•åï¼Œçº¿ç¨‹çŠ¶æ€ç”±RUNNINGå˜ä¸ºWAITINGï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ”¾ç½®åˆ°å¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶é‡Šæ”¾é”ã€‚</p>
<p>3ã€notify()æˆ–notifyAll()æ–¹æ³•è°ƒç”¨åï¼Œç­‰å¾…çº¿ç¨‹ä¾æ—§ä¸ä¼šä»wait()è¿”å›ï¼Œéœ€è¦è°ƒç”¨notify()æˆ–notifAll()çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œç­‰å¾…çº¿ç¨‹æ‰æœ‰æœºä¼šä»wait()è¿”å›ã€‚</p>
<p>4ã€notify()æ–¹æ³•å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè€ŒnotifyAll()æ–¹æ³•åˆ™æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„çº¿ç¨‹å…¨éƒ¨ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè¢«ç§»åŠ¨çš„çº¿ç¨‹çŠ¶æ€ç”±WAITINGå˜ä¸ºBLOCKEDã€‚</p>
<p>5ã€ä»wait()æ–¹æ³•è¿”å›çš„å‰ææ˜¯è·å¾—äº†è°ƒç”¨å¯¹è±¡çš„é”ã€‚<strong>ç­‰å¾…/é€šçŸ¥æœºåˆ¶ä¾æ‰˜äºåŒæ­¥æœºåˆ¶</strong>ï¼Œå…¶ç›®çš„å°±æ˜¯ç¡®ä¿ç­‰å¾…çº¿ç¨‹ä»wait()æ–¹æ³•è¿”å›æ—¶èƒ½å¤Ÿæ„ŸçŸ¥åˆ°é€šçŸ¥çº¿ç¨‹å¯¹å˜é‡åšå‡ºçš„ä¿®æ”¹ï¼ˆä¹Ÿå°±æ˜¯flagå˜é‡ï¼‰ã€‚</p>
<p>æ¢³ç†ä¸€ä¸‹ç­‰å¾…çº¿ç¨‹çš„çŠ¶æ€å˜åŒ–ï¼š<br>1ã€waitçº¿ç¨‹é¦–å…ˆè·å–é”ï¼Œè°ƒç”¨lockçš„waitæ–¹æ³•ï¼Œæ”¾å¼ƒäº†é”ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…çŠ¶æ€ã€‚ï¼ˆå¯ä»¥æœ‰å¾ˆå¤šä¸ªwaitçº¿ç¨‹ï¼‰<br>2ã€notifyçº¿ç¨‹è·å–äº†é”ï¼Œè°ƒç”¨lockçš„notifyæ–¹æ³•ï¼Œå°†waitçº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ç§»åŠ¨åˆ°äº†åŒæ­¥é˜Ÿåˆ—ï¼Œæ˜¯é˜»å¡çŠ¶æ€ã€‚ï¼ˆnotifyåªèƒ½å”¤é†’ä¸€ä¸ªï¼‰<br>3ã€notifyçº¿ç¨‹è¿è¡Œå®Œäº†ï¼Œé‡Šæ”¾é”ï¼Œwaitçº¿ç¨‹è·å–åˆ°é”ï¼Œä»waitæ–¹æ³•è¿”å›å¹¶ç»§ç»­æ‰§è¡Œã€‚</p>
<p>sleepä¸ä¼šé‡Šæ”¾é”<br>waitä¼šé‡Šæ”¾é”</p>
<h4 id="âœ…ç­‰å¾…-é€šçŸ¥çš„ç»å…¸èŒƒå¼"><a href="#âœ…ç­‰å¾…-é€šçŸ¥çš„ç»å…¸èŒƒå¼" class="headerlink" title="âœ…ç­‰å¾…/é€šçŸ¥çš„ç»å…¸èŒƒå¼"></a>âœ…ç­‰å¾…/é€šçŸ¥çš„ç»å…¸èŒƒå¼</h4><p>èŒƒå¼åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«é’ˆå¯¹ç­‰å¾…æ–¹ï¼ˆæ¶ˆè´¹è€…ï¼‰å’Œé€šçŸ¥æ–¹ï¼ˆç”Ÿäº§è€…ï¼‰</p>
<p>ç­‰å¾…æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™ï¼š<br>1ã€è·å–å¯¹è±¡çš„é”ã€‚<br>2ã€å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼ˆflagå˜é‡ï¼‰ï¼Œé‚£ä¹ˆè°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œè¢«é€šçŸ¥åä»è¦æ£€æŸ¥æ¡ä»¶ã€‚<br>3ã€æ¡ä»¶æ»¡è¶³åˆ™æ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">synchronized(å¯¹è±¡) &#123;</span><br><span class="line">	while(æ¡ä»¶ä¸æ»¡è¶³) &#123;</span><br><span class="line">		å¯¹è±¡.wait();</span><br><span class="line">	&#125;</span><br><span class="line">	å¯¹åº”çš„å¤„ç†é€»è¾‘</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šçŸ¥æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™ï¼š<br>1ã€è·å¾—å¯¹è±¡çš„é”ã€‚<br>2ã€æ”¹å˜æ¡ä»¶ã€‚<br>3ã€é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚ï¼ˆå…ˆæ”¹å˜æ¡ä»¶è¿˜æ˜¯å…ˆé€šçŸ¥éƒ½è¡Œï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">synchronized(å¯¹è±¡) &#123;</span><br><span class="line">	æ”¹å˜æ¡ä»¶(flag)</span><br><span class="line">	å¯¹è±¡.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š<br>1ã€flagçš„ç›®çš„ï¼šç›¸å½“äºæ˜¯ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå€¼ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹èƒ½æ„ŸçŸ¥åˆ°ï¼Œèµ·åˆ°ä¸€ä¸ªå¤šçº¿ç¨‹é€šä¿¡è¾¾åˆ°ä»€ä¹ˆæ¡ä»¶åšä»€ä¹ˆäº‹çš„æ•ˆæœã€‚<br>2ã€åŒæ­¥çš„ç›®çš„ï¼šè·å–äº†é”æ‰èƒ½waitå’Œnotifyï¼ŒåŒæ­¥çš„ç›®çš„æ˜¯æŠŠä¿®æ”¹å˜é‡å’ŒnotifyåŒ…åœ¨ä¸€èµ·ï¼Œè®©waitå‡ºæ¥çš„æ—¶å€™èƒ½æ„ŸçŸ¥åˆ°å˜é‡çš„å˜åŒ–ã€‚<br>3ã€å…¶å®è¿™ä¸ªæ¨¡å¼å·²ç»æ˜¯ååº•å±‚äº†ã€‚<br>4ã€flagå’Œlockå¯ä»¥ç”¨ä¸€ä¸ªï¼Œç›´æ¥ç”¨flagæ¥å½“é”ï¼ˆå°±åƒåé¢çš„æ‰‹å†™çº¿ç¨‹æ± ï¼‰</p>
<h4 id="âœ…ç®¡é“è¾“å…¥-è¾“å‡ºæµ"><a href="#âœ…ç®¡é“è¾“å…¥-è¾“å‡ºæµ" class="headerlink" title="âœ…ç®¡é“è¾“å…¥/è¾“å‡ºæµ"></a>âœ…ç®¡é“è¾“å…¥/è¾“å‡ºæµ</h4><p>ç®¡é“è¾“å…¥/è¾“å‡ºæµå’Œæ™®é€šçš„æ–‡ä»¶è¾“å…¥/è¾“å‡ºæµæˆ–è€…ç½‘ç»œè¾“å…¥/è¾“å‡ºæµä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¸»è¦ç”¨äºçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œè€Œä¼ è¾“çš„åª’ä»‹ä¸ºå†…å­˜ã€‚</p>
<p>ç®¡é“è¾“å…¥/è¾“å‡ºæµä¸»è¦åŒ…æ‹¬äº†å¦‚ä¸‹4ç§å…·ä½“å®ç°ï¼šPipedOutputStreamã€PipedInputStreamã€PipedReaderå’ŒPipedWriterï¼Œå‰ä¸¤ç§é¢å‘å­—èŠ‚ï¼Œè€Œåä¸¤ç§é¢å‘å­—ç¬¦ã€‚</p>
<p>ä¾‹å­ï¼šprintThreadçº¿ç¨‹æ¥å—mainçº¿ç¨‹çš„è¾“å…¥ï¼Œä»»ä½•mainçº¿ç¨‹çš„è¾“å…¥å‡é€šè¿‡PipedWriterå†™å…¥ï¼Œè€ŒprintThreadåœ¨å¦ä¸€ç«¯é€šè¿‡PipedReaderå°†å†…å®¹è¯»å‡ºå¹¶æ‰“å°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class Piped &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        PipedWriter out = new PipedWriter();</span><br><span class="line">        PipedReader in = new PipedReader();</span><br><span class="line">        // å°†è¾“å‡ºæµå’Œè¾“å…¥æµè¿›è¡Œè¿æ¥ï¼Œå¦åˆ™åœ¨ä½¿ç”¨æ—¶ä¼šæŠ›å‡ºIOException</span><br><span class="line">        out.connect(in);</span><br><span class="line">        Thread printThread = new Thread(new Print(in), &quot;PrintThread&quot;);</span><br><span class="line">        printThread.start();</span><br><span class="line">        int receive = 0;</span><br><span class="line">        try &#123;</span><br><span class="line">            while ((receive = System.in.read()) != -1) &#123;</span><br><span class="line">                out.write(receive);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Print implements Runnable &#123;</span><br><span class="line">        private PipedReader in;</span><br><span class="line"></span><br><span class="line">        public Print(PipedReader in) &#123;</span><br><span class="line">            this.in = in;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void run() &#123;</span><br><span class="line">            int receive = 0;</span><br><span class="line">            try &#123;</span><br><span class="line">                while ((receive = in.read()) != -1) &#123;</span><br><span class="line">                    System.out.print((char) receive);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (IOException ex) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>âš ï¸å¯¹äºPipedç±»å‹çš„æµï¼Œå¿…é¡»å…ˆè¦è¿›è¡Œç»‘å®šï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨connect()æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å°†è¾“å…¥/è¾“å‡ºæµç»‘å®šèµ·æ¥ï¼Œå¯¹äºè¯¥æµçš„è®¿é—®å°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h4 id="âœ…Thread-join-çš„ä½¿ç”¨"><a href="#âœ…Thread-join-çš„ä½¿ç”¨" class="headerlink" title="âœ…Thread.join()çš„ä½¿ç”¨"></a>âœ…Thread.join()çš„ä½¿ç”¨</h4><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹Aæ‰§è¡Œäº†thread.join()è¯­å¥ï¼Œå…¶å«ä¹‰æ˜¯ï¼š<br>å½“å‰çº¿ç¨‹Aç­‰å¾…threadçº¿ç¨‹ç»ˆæ­¢ä¹‹åæ‰ä»thread.join()è¿”å›ï¼Œè¿˜æä¾›äº†join(long millis)å’Œjoin(long millis,int nanos)ä¸¤ä¸ªå…·å¤‡è¶…æ—¶ç‰¹æ€§çš„æ–¹æ³•ã€‚</p>
<p>ä¾‹å­ï¼šåˆ›å»ºäº†10ä¸ªçº¿ç¨‹ï¼Œç¼–å·0~9ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨å‰ä¸€ä¸ªçº¿ç¨‹çš„join()æ–¹æ³•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">public class Join &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Thread previous = Thread.currentThread();</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">			// æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å‰ä¸€ä¸ªçº¿ç¨‹çš„å¼•ç”¨ï¼Œéœ€è¦ç­‰å¾…å‰ä¸€ä¸ªçº¿ç¨‹ç»ˆæ­¢ï¼Œæ‰èƒ½ä»ç­‰å¾…ä¸­è¿”å›</span><br><span class="line">            Thread thread = new Thread(new Domino(previous), String.valueOf(i));</span><br><span class="line">            thread.start();</span><br><span class="line">            previous = thread;</span><br><span class="line">        &#125;</span><br><span class="line">        TimeUnit.SECONDS.sleep(5);</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + &quot; terminate.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Domino implements Runnable &#123;</span><br><span class="line">        private Thread thread;</span><br><span class="line"></span><br><span class="line">        public Domino(Thread thread) &#123;</span><br><span class="line">            this.thread = thread;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                thread.join();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + &quot; terminate.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸç†ï¼šç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼ˆç­‰å¾…å‰é©±çº¿ç¨‹ç»“æŸï¼Œæ¥æ”¶å‰é©±çº¿ç¨‹ç»“æŸé€šçŸ¥ï¼‰ã€‚åŠ é”ã€å¾ªç¯å’Œå¤„ç†é€»è¾‘3ä¸ªæ­¥éª¤ã€‚</p>
<p>1ã€çº¿ç¨‹aæ‰§è¡Œçº¿ç¨‹bçš„joinæ–¹æ³•ï¼Œç›¸å½“äºç”¨çº¿ç¨‹bå¯¹è±¡åšåŒæ­¥ï¼Œå†…éƒ¨æœ¬çº¿ç¨‹waitè¿›å…¥ç­‰å¾…ï¼Œå¹¶ç”¨ä¸€ä¸ªå˜é‡flagè¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚<br>2ã€çº¿ç¨‹bç»ˆæ­¢æ—¶ï¼Œä¼šè°ƒç”¨çº¿ç¨‹è‡ªèº«çš„notifyAll()æ–¹æ³•ï¼Œä¼šé€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨è¯¥çº¿ç¨‹å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚</p>
<h4 id="âœ…ThreadLocalçš„ä½¿ç”¨"><a href="#âœ…ThreadLocalçš„ä½¿ç”¨" class="headerlink" title="âœ…ThreadLocalçš„ä½¿ç”¨"></a>âœ…ThreadLocalçš„ä½¿ç”¨</h4><p>ThreadLocalï¼Œå³çº¿ç¨‹å˜é‡ï¼Œæ˜¯ä¸€ä¸ªä»¥ThreadLocalå¯¹è±¡ä¸ºé”®ã€ä»»æ„å¯¹è±¡ä¸ºå€¼çš„å­˜å‚¨ç»“æ„ã€‚å®ƒä¸æ˜¯çº¿ç¨‹å…±æœ‰çš„ï¼Œè€Œæ˜¯ç§æœ‰çš„ã€‚å³ä¿®æ”¹ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ ¹æ®ä¸€ä¸ªThreadLocalå¯¹è±¡æŸ¥è¯¢åˆ°ç»‘å®šåœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šçš„å€¼ã€‚set()æ–¹æ³•è®¾ç½®ï¼Œget()æ–¹æ³•è·å–è®¾ç½®çš„å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Thread t = Thread.currentThread();</span><br><span class="line">ThreadLocalMap map = getMap(t);</span><br><span class="line">å–å‡ºåï¼Œ(T)valueå¼ºè½¬å³å¯</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ï¼šä¸€ä¸ªProfileç±»ï¼Œå…·æœ‰begin()å’Œend()ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œend()æ–¹æ³•è¿”å›ä»begin()æ–¹æ³•è°ƒç”¨å¼€å§‹åˆ°end()æ–¹æ³•è¢«è°ƒç”¨æ—¶çš„æ—¶é—´å·®ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public class Profiler &#123;</span><br><span class="line">    // ç¬¬ä¸€æ¬¡get()æ–¹æ³•è°ƒç”¨æ—¶ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼ˆå¦‚æœsetæ–¹æ³•æ²¡æœ‰è°ƒç”¨ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šè°ƒç”¨ä¸€æ¬¡</span><br><span class="line">    private static final ThreadLocal&lt;Long&gt; TIME_THREADLOCAL = new ThreadLocal&lt;Long&gt;() &#123;</span><br><span class="line">        protected Long initialValue() &#123;</span><br><span class="line">            return System.currentTimeMillis();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    public static final void begin() &#123;</span><br><span class="line">        TIME_THREADLOCAL.set(System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static final long end() &#123;</span><br><span class="line">        return System.currentTimeMillis() - TIME_THREADLOCAL.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Profiler.begin();</span><br><span class="line">        TimeUnit.SECONDS.sleep(1);</span><br><span class="line">        System.out.println(&quot;Cost: &quot; + Profiler.end() + &quot; mills&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨é€”ï¼šProfilerå¯ä»¥è¢«å¤ç”¨åœ¨æ–¹æ³•è°ƒç”¨è€—æ—¶ç»Ÿè®¡çš„åŠŸèƒ½ä¸Šï¼Œåœ¨æ–¹æ³•çš„å…¥å£å‰æ‰§è¡Œbegin()æ–¹æ³•ï¼Œåœ¨æ–¹æ³•è°ƒç”¨åæ‰§è¡Œend()æ–¹æ³•ã€‚å¥½å¤„æ˜¯ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨ä¸ç”¨åœ¨ä¸€ä¸ªæ–¹æ³•æˆ–è€…ç±»ä¸­ã€‚</p>
<h3 id="4-çº¿ç¨‹åº”ç”¨æ¡ˆä¾‹"><a href="#4-çº¿ç¨‹åº”ç”¨æ¡ˆä¾‹" class="headerlink" title="4.çº¿ç¨‹åº”ç”¨æ¡ˆä¾‹"></a>4.çº¿ç¨‹åº”ç”¨æ¡ˆä¾‹</h3><h4 id="âœ…ç­‰å¾…è¶…æ—¶æ¨¡å¼"><a href="#âœ…ç­‰å¾…è¶…æ—¶æ¨¡å¼" class="headerlink" title="âœ…ç­‰å¾…è¶…æ—¶æ¨¡å¼"></a>âœ…ç­‰å¾…è¶…æ—¶æ¨¡å¼</h4><p>åœ¨å‰é¢ç­‰å¾…/é€šçŸ¥æ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œå¦‚æœè¯¥æ–¹æ³•èƒ½å¤Ÿåœ¨ç»™å®šçš„æ—¶é—´æ®µä¹‹å†…å¾—åˆ°ç»“æœï¼Œé‚£ä¹ˆå°†ç»“æœç«‹åˆ»è¿”å›ï¼Œåä¹‹ï¼Œè¶…æ—¶è¿”å›é»˜è®¤ç»“æœã€‚</p>
<p>èŒƒå¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// å¯¹å½“å‰å¯¹è±¡åŠ é”</span><br><span class="line">public synchronized Object get(long mills) throws InterruptedException &#123;</span><br><span class="line">	long future = System.currentTimeMillis() + mills;</span><br><span class="line">	long remaining = mills;</span><br><span class="line">	// å½“è¶…æ—¶å¤§äº0å¹¶ä¸”resultè¿”å›å€¼ä¸æ»¡è¶³è¦æ±‚</span><br><span class="line">	while ((result == null) &amp;&amp; remaining &gt; 0) &#123;</span><br><span class="line">		wait(remaining);</span><br><span class="line">		remaining = future - System.currentTimeMillis();</span><br><span class="line">	&#125;</span><br><span class="line">	return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç­‰å¾…è¶…æ—¶æ¨¡å¼å°±æ˜¯åœ¨ç­‰å¾…/é€šçŸ¥èŒƒå¼åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶æ§åˆ¶ï¼Œè¿™ä½¿å¾—è¯¥æ¨¡å¼ç›¸æ¯”åŸæœ‰èŒƒå¼æ›´å…·æœ‰çµæ´»æ€§ï¼Œå› ä¸ºå³ä½¿æ–¹æ³•æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œä¹Ÿä¸ä¼šâ€œæ°¸ä¹…â€é˜»å¡è°ƒç”¨è€…ï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§è°ƒç”¨è€…çš„è¦æ±‚â€œæŒ‰æ—¶â€è¿”å›ã€‚</p>
<p>å¹¶ä¸”ï¼Œä¸æ˜¯åªwaitå›ºå®šçš„æ—¶é—´å°±å®Œäº‹ï¼Œè€Œæ˜¯å¾ªç¯æ£€æŸ¥æ˜¯ä¸æ˜¯waitå¤Ÿäº†ï¼Œå¤Ÿäº†å°±ç›´æ¥è¿”å›ä¸waitäº†ã€‚</p>
<h4 id="âœ…ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹"><a href="#âœ…ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹" class="headerlink" title="âœ…ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹"></a>âœ…ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹</h4><p>ä½¿ç”¨ç­‰å¾…è¶…æ—¶æ¨¡å¼æ¥æ„é€ ä¸€ä¸ªç®€å•çš„æ•°æ®åº“è¿æ¥æ± ï¼Œåœ¨ç¤ºä¾‹ä¸­æ¨¡æ‹Ÿä»è¿æ¥æ± ä¸­è·å–ã€ä½¿ç”¨å’Œé‡Šæ”¾è¿æ¥çš„è¿‡ç¨‹ï¼Œè€Œå®¢æˆ·ç«¯è·å–è¿æ¥çš„è¿‡ç¨‹è¢«è®¾å®šä¸ºç­‰å¾…è¶…æ—¶çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨1000æ¯«ç§’å†…å¦‚æœæ— æ³•è·å–åˆ°å¯ç”¨è¿æ¥ï¼Œå°†ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ä¸€ä¸ªnullã€‚</p>
<p>è®¾å®šè¿æ¥æ± çš„å¤§å°ä¸º10ä¸ªï¼Œç„¶åé€šè¿‡è°ƒèŠ‚å®¢æˆ·ç«¯çš„çº¿ç¨‹æ•°æ¥æ¨¡æ‹Ÿæ— æ³•è·å–è¿æ¥çš„åœºæ™¯ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹è¿æ¥æ± çš„å®šä¹‰ã€‚å®ƒé€šè¿‡æ„é€ å‡½æ•°åˆå§‹åŒ–è¿æ¥çš„æœ€å¤§ä¸Šé™ï¼Œé€šè¿‡ä¸€ä¸ªåŒå‘é˜Ÿåˆ—æ¥ç»´æŠ¤è¿æ¥ï¼Œè°ƒç”¨æ–¹éœ€è¦å…ˆè°ƒç”¨fetchConnection(long)æ–¹æ³•æ¥æŒ‡å®šåœ¨å¤šå°‘æ¯«ç§’å†…è¶…æ—¶è·å–è¿æ¥ï¼Œå½“è¿æ¥ä½¿ç”¨å®Œæˆåï¼Œéœ€è¦è°ƒç”¨releaseConnection(Connection)æ–¹æ³•å°†è¿æ¥æ”¾å›çº¿ç¨‹æ± ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public class ConnectionPool &#123;</span><br><span class="line">	//è¿æ¥æ± </span><br><span class="line">    private LinkedList&lt;Connection&gt; pool = new LinkedList&lt;Connection&gt;();</span><br><span class="line"></span><br><span class="line">    //æ„é€ </span><br><span class="line">    public ConnectionPool(int initialSize) &#123;</span><br><span class="line">        if (initialSize &gt; 0) &#123;</span><br><span class="line">        	//åˆ›å»ºæ•°æ®åº“è¿æ¥</span><br><span class="line">            for (int i = 0; i &lt; initialSize; i++) &#123;</span><br><span class="line">                pool.addLast(ConnectionDriver.createConnection());//è¯¥ç±»åœ¨åé¢å®ç°ï¼Œç”¨äºåˆå§‹åŒ–çº¿ç¨‹æ± </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void releaseConnection(Connection connection) &#123;</span><br><span class="line">        if (connection != null) &#123;</span><br><span class="line">            synchronized (pool) &#123;</span><br><span class="line">                // è¿æ¥é‡Šæ”¾åéœ€è¦è¿›è¡Œé€šçŸ¥ï¼Œè¿™æ ·å…¶ä»–æ¶ˆè´¹è€…èƒ½å¤Ÿæ„ŸçŸ¥åˆ°è¿æ¥æ± ä¸­å·²ç»å½’è¿˜äº†ä¸€ä¸ªè¿æ¥</span><br><span class="line">                pool.addLast(connection);</span><br><span class="line">                // å”¤é†’æ‰€æœ‰ç­‰å¾…ï¼Œè®©ä»–ä»¬å»ç«äº‰é”</span><br><span class="line">                pool.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // åœ¨millså†…æ— æ³•è·å–åˆ°è¿æ¥ï¼Œå°†ä¼šè¿”å›null</span><br><span class="line">    //è·å–è¿æ¥</span><br><span class="line">    public Connection fetchConnection(long mills) throws InterruptedException &#123;</span><br><span class="line">        synchronized (pool) &#123;</span><br><span class="line">        	// è¯¥éƒ¨åˆ†ä»£ç é€»è¾‘ä¸º</span><br><span class="line">        	// å½“å®Œå…¨è¶…æ—¶æ—¶ï¼Œå¿…ç„¶ä¼šè·å¾—ä¸€ä¸ªè¿æ¥æ± å¯¹è±¡,ä¹Ÿå³æ˜¯æ— çº¿ç­‰å¾…æ—¶é—´ã€‚å½“ä¼ å…¥mills &gt; 0æ—¶ï¼Œä¸ä¼šèµ°å…¥è¯¥åˆ†æ”¯ã€‚å› ä¸ºelseåˆ†æ”¯ä¼šå¤„ç†å…¶ä¸­è¶…æ—¶æƒ…å†µ</span><br><span class="line">        	// éå®Œå…¨è¶…æ—¶æ—¶ï¼Œè·å¾—å°±è¿”å›ä¸€ä¸ªè¿æ¥æ± å¯¹è±¡ï¼Œä¸ç„¶å°±è¿”å›ç©º</span><br><span class="line">        	</span><br><span class="line">            // å®Œå…¨è¶…æ—¶</span><br><span class="line">            if (mills &lt;= 0) &#123;</span><br><span class="line">            	// è¿æ¥æ± ä¸ºç©º</span><br><span class="line">                while (pool.isEmpty()) &#123;</span><br><span class="line">                    //ä»¥è¿æ¥æ± ä¸ºé€šçŸ¥å¯¹è±¡ï¼Œç­‰å¾…ç›´åˆ°è¢«å”¤é†’ï¼Œä¸åœ¨ä¸»åŠ¨é†’æ¥</span><br><span class="line">                    pool.wait();</span><br><span class="line">                &#125;</span><br><span class="line">                // æ‹¿å‡ºè¿æ¥æ± ä¸­ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œå¹¶è¿”å›ç»™å½“å‰è¯·æ±‚è€…</span><br><span class="line">                return pool.removeFirst();</span><br><span class="line">            &#125;</span><br><span class="line">            //æœªè¶…æ—¶ </span><br><span class="line">            else &#123;</span><br><span class="line">                long future = System.currentTimeMillis() + mills;</span><br><span class="line">                long remaining = mills;</span><br><span class="line">                //è¿æ¥æ± ä¸ºç©ºä¸”æœªè¶…æ—¶</span><br><span class="line">                while (pool.isEmpty() &amp;&amp; remaining &gt; 0) &#123;</span><br><span class="line">                	//ä»¥è¿æ¥æ± ä¸ºé€šçŸ¥å¯¹è±¡ï¼Œç­‰å¾…remainingæ¯«ç§’,æˆ–è€…è¢«å”¤é†’</span><br><span class="line">                    pool.wait(remaining);</span><br><span class="line">                    // è·å–å‰©ä½™æ—¶é—´ï¼Œé€šè¿‡å®ƒæ¥åˆ¤æ–­æ˜¯ä¸»åŠ¨é†’æ¥ï¼ˆè¶…æ—¶ï¼‰ï¼Œè¿˜æ˜¯è¢«åŠ¨å”¤é†’ï¼ˆnotifyï¼‰</span><br><span class="line">                    // æ— è®ºæ˜¯è¢«åŠ¨è¿˜æ˜¯ä¸»åŠ¨é†’æ¥ï¼Œéƒ½å°è¯•è·å–è¿æ¥æ± è¿™ä¸ªå¯¹è±¡é”</span><br><span class="line">                    remaining = future - System.currentTimeMillis();</span><br><span class="line">                    // è·å¾—é”ä»¥ååˆ¤æ–­è¿æ¥æ± æ˜¯ä¸æ˜¯ç©ºçš„ï¼Œç©ºçš„çš„è¯å†åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶å°±ç¦»å¼€å¾ªç¯</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Connection result = null;</span><br><span class="line">                //æŠ¢åˆ°è¿æ¥æ± è¿™ä¸ªå¯¹è±¡é”åï¼Œè‹¥æ­¤æ—¶è¿æ¥æ± ä¸ä¸ºç©º</span><br><span class="line">                if (!pool.isEmpty()) &#123;</span><br><span class="line">                	// æ‹¿å‡ºè¿æ¥æ± ä¸­ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œå¹¶è¿”å›ç»™å½“å‰è¯·æ±‚è€…</span><br><span class="line">                    result = pool.removeFirst();</span><br><span class="line">                &#125;</span><br><span class="line">                // å¦åˆ™æ­¤æ—¶ä¸ºç©º</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºjava.sql.Connectionæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ€ç»ˆçš„å®ç°æ˜¯ç”±æ•°æ®åº“é©±åŠ¨æä¾›æ–¹æ¥å®ç°çš„ï¼Œè€ƒè™‘åˆ°åªæ˜¯ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡<strong>åŠ¨æ€ä»£ç†</strong>æ„é€ äº†ä¸€ä¸ªConnectionï¼Œè¯¥Connectionçš„ä»£ç†å®ç°ä»…ä»…æ˜¯åœ¨commit()æ–¹æ³•ï¼ˆæäº¤sqlï¼‰è°ƒç”¨æ—¶ä¼‘çœ 100æ¯«ç§’ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class ConnectionDriver &#123;</span><br><span class="line"></span><br><span class="line">    static class ConnectionHandler implements InvocationHandler &#123;</span><br><span class="line">        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable&#123;</span><br><span class="line">         // åœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰</span><br><span class="line">        // å½“æ–¹æ³•æ˜¯æäº¤æ—¶ï¼Œæˆ‘ä»¬ç¡çœ 100æ¯«ç§’</span><br><span class="line">        if (method.getName().equals(&quot;commit&quot;))&#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(100);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // æ‰§è¡ŒåŸæœ¬æ–¹æ³•ï¼Œæ­¤å¤„å°±ä¸æ‰§è¡Œäº†</span><br><span class="line">       	// Object invoke = method.invoke(vehical, args);</span><br><span class="line">       	</span><br><span class="line">		// æ‰§è¡Œæ–¹æ³•ä¹‹åï¼Œæ­¤å¤„ä¹Ÿä¸å¤„ç†ï¼Œç›´æ¥æ”¾å›null</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    // åˆ›å»ºä¸€ä¸ªConnectionçš„ä»£ç†ï¼Œåœ¨commitæ—¶ä¼‘çœ 100æ¯«ç§’</span><br><span class="line">    public static final Connection createConnection() &#123;</span><br><span class="line">    	// åˆ›å»ºä¸€ä¸ªä»£ç†å®ä¾‹</span><br><span class="line">    	// ç±»åŠ è½½å™¨(ç”¨å“ªä¸ªç±»åŠ è½½å™¨å»åŠ è½½ä»£ç†å¯¹è±¡) + ä»£ç†çš„ç±»(æ¥å£ï¼Œåˆ‡å…¥ç‚¹) + ä»£ç†æ–¹æ³•</span><br><span class="line">    	// å¯ä»¥ç†è§£æˆ‘ä»¬ä¸ºConnectionçš„&quot;commit&quot;æ–¹æ³•ï¼Œé€šè¿‡JDKçš„æ–¹å¼ä»£ç†äº†ä¸€å±‚(AOP)</span><br><span class="line">    	// è¿”å›çš„å°±æ˜¯æˆ‘ä»¬Springä¸­å­¦ä¹ çš„ ä»£ç†é¢å¤–å¢åŠ çš„å±‚ + åŸæœ¬çš„ç±»å¯¹è±¡</span><br><span class="line">        return (Connection) Proxy.newProxyInstance(ConnectionDriver.class.getClassLoader(),new Class &lt;?&gt;[]&#123;</span><br><span class="line">            Connection.class</span><br><span class="line">        &#125;,new ConnectionHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥æµ‹è¯•ç®€æ˜“æ•°æ®åº“è¿æ¥æ± çš„å·¥ä½œæƒ…å†µï¼Œæ¨¡æ‹Ÿå®¢æˆ·ç«¯ConnectionRunnerè·å–ã€ä½¿ç”¨ã€æœ€åé‡Šæ”¾è¿æ¥çš„è¿‡ç¨‹ï¼Œå½“å®ƒä½¿ç”¨æ—¶è¿æ¥å°†ä¼šå¢åŠ è·å–åˆ°è¿æ¥çš„æ•°é‡ï¼Œåä¹‹ï¼Œå°†ä¼šå¢åŠ æœªè·å–åˆ°è¿æ¥çš„æ•°é‡ï¼Œç¤ºä¾‹å¦‚ä¸‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public class ConnectionPoolTest &#123;</span><br><span class="line">    static ConnectionPool pool = new ConnectionPool(10);</span><br><span class="line">    // ä¿è¯æ‰€æœ‰ConnectionRunnerèƒ½å¤ŸåŒæ—¶å¼€å§‹</span><br><span class="line">    static CountDownLatch start = new CountDownLatch(1);</span><br><span class="line">    // mainçº¿ç¨‹å°†ä¼šç­‰å¾…æ‰€æœ‰ConnectionRunnerç»“æŸåæ‰èƒ½ç»§ç»­æ‰§è¡Œ</span><br><span class="line">    static CountDownLatch end;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        // çº¿ç¨‹æ•°é‡ï¼Œå¯ä»¥ä¿®æ”¹çº¿ç¨‹æ•°é‡è¿›è¡Œè§‚å¯Ÿ</span><br><span class="line">        int threadCount = 10;</span><br><span class="line">        end = new CountDownLatch(threadCount);</span><br><span class="line">        int count = 20;</span><br><span class="line">        // ç”¨åŸå­è®°å½• è·å–åˆ°çš„ä¸æ²¡æœ‰è·å–åˆ°çš„</span><br><span class="line">        AtomicInteger got = new AtomicInteger();</span><br><span class="line">        AtomicInteger notGot = new AtomicInteger();</span><br><span class="line">        </span><br><span class="line">        for (int i = 0; i &lt; threadCount; i++) &#123;</span><br><span class="line">        	// è¿è¡Œçº¿ç¨‹</span><br><span class="line">            Thread thread = new Thread(new ConnetionRunner(count, got, notGot),</span><br><span class="line">                    &quot;ConnectionRunnerThread&quot;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        //è¿è¡Œåˆ°è¿™é‡Œstartå€¼-1ï¼Œæ­¤æ—¶ä¸º0ï¼Œå› æ­¤æ‰€æœ‰çº¿ç¨‹ä¸å†ä¼šè¢«é˜»å¡ï¼Œå¼€å§‹æ‰§è¡Œ</span><br><span class="line">        start.countDown();</span><br><span class="line">        //ä¸»çº¿ç¨‹é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…endä¸º0ï¼Œå³ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ</span><br><span class="line">        end.await();   //ç­‰10ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå®Œ</span><br><span class="line">        System.out.println(&quot;total invoke: &quot; + (threadCount * count));</span><br><span class="line">        System.out.println(&quot;got connection: &quot; + got);</span><br><span class="line">        System.out.println(&quot;not got connection &quot; + notGot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class ConnetionRunner implements Runnable &#123;</span><br><span class="line">        int count;</span><br><span class="line">        AtomicInteger got;</span><br><span class="line">        AtomicInteger notGot;</span><br><span class="line"></span><br><span class="line">		// gotã€noteGotå› ä¸ºæ˜¯å¼•ç”¨ï¼Œæ‰€ä»¥æœ¬è´¨è¿˜æ˜¯åŸæ¥çš„é‚£ä¸ª</span><br><span class="line">        public ConnetionRunner(int count, AtomicInteger got, AtomicInteger notGot) &#123;</span><br><span class="line">            this.count = count;</span><br><span class="line">            this.got = got;</span><br><span class="line">            this.notGot = notGot;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">            	// é˜»å¡åœ¨è¿™é‡Œï¼Œç­‰å¾…startä¸º0</span><br><span class="line">                start.await();  //ç­‰10ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºå¥½åä¸€èµ·æ‰§è¡Œ</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            // å½“count &gt; 0 æ—¶ï¼Œå†æ¬¡æ‰§è¡Œ</span><br><span class="line">            while (count &gt; 0) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    // ä»çº¿ç¨‹æ± ä¸­è·å–è¿æ¥ï¼Œå¦‚æœ1000mså†…æ— æ³•è·å–åˆ°ï¼Œå°†ä¼šè¿”å›null</span><br><span class="line">                    // åˆ†åˆ«ç»Ÿè®¡è¿æ¥è·å–çš„æ•°é‡gotå’Œæœªè·å–åˆ°çš„æ•°é‡notGot</span><br><span class="line">                    Connection connection = pool.fetchConnection(1000);</span><br><span class="line">                    // å¦‚æœè·å–åˆ°äº†</span><br><span class="line">                    if (connection != null) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                        	// åˆ›å»ºSQLè¯­å¥</span><br><span class="line">                            connection.createStatement();</span><br><span class="line">                            // æ‰§è¡Œæäº¤</span><br><span class="line">                            connection.commit();</span><br><span class="line">                        &#125; finally &#123;</span><br><span class="line">                        	// é‡Šæ”¾</span><br><span class="line">                            pool.releaseConnection(connection);</span><br><span class="line">                            // è·å–åˆ°got + 1</span><br><span class="line">                            got.incrementAndGet();</span><br><span class="line">                        &#125;</span><br><span class="line">                     // æ²¡æœ‰è·å–åˆ°</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                    	// æ²¡æœ‰è·å–åˆ°notGot + 1</span><br><span class="line">                        notGot.incrementAndGet();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception ex) &#123;</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                </span><br><span class="line">                    count--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // çº¿ç¨‹ç»“æŸ end - 1</span><br><span class="line">            end.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ç¤ºä¾‹ä¸­ä½¿ç”¨äº†CountDownLatchæ¥ç¡®ä¿ConnectionRunnerThreadèƒ½å¤ŸåŒæ—¶å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨å…¨éƒ¨ç»“æŸä¹‹åï¼Œæ‰ä½¿mainçº¿ç¨‹ä»ç­‰å¾…çŠ¶æ€ä¸­è¿”å›ã€‚</p>
<p>åœ¨èµ„æºä¸€å®šçš„æƒ…å†µä¸‹ï¼ˆè¿æ¥æ± ä¸­çš„10ä¸ªè¿æ¥ï¼‰ï¼Œéšç€å®¢æˆ·ç«¯çº¿ç¨‹çš„é€æ­¥å¢åŠ ï¼Œå®¢æˆ·ç«¯å‡ºç°è¶…æ—¶æ— æ³•è·å–è¿æ¥çš„æ¯”ç‡ä¸æ–­å‡é«˜ã€‚</p>
<h4 id="âœ…çº¿ç¨‹æ± æŠ€æœ¯åŠå…¶ç¤ºä¾‹"><a href="#âœ…çº¿ç¨‹æ± æŠ€æœ¯åŠå…¶ç¤ºä¾‹" class="headerlink" title="âœ…çº¿ç¨‹æ± æŠ€æœ¯åŠå…¶ç¤ºä¾‹"></a>âœ…çº¿ç¨‹æ± æŠ€æœ¯åŠå…¶ç¤ºä¾‹</h4><p>å¦‚æœæœåŠ¡ç«¯æ¯æ¬¡æ¥å—åˆ°ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç„¶åè¿›è¡Œæ‰§è¡Œï¼Œè¿™ä¼šä½¿æ“ä½œç³»ç»Ÿé¢‘ç¹çš„è¿›è¡Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ— æ•…å¢åŠ ç³»ç»Ÿçš„è´Ÿè½½ï¼Œè€Œçº¿ç¨‹çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½æ˜¯éœ€è¦è€—è´¹ç³»ç»Ÿèµ„æºçš„ï¼Œä¹Ÿæ— ç–‘æµªè´¹äº†ç³»ç»Ÿèµ„æºã€‚</p>
<p>çº¿ç¨‹æ± æŠ€æœ¯èƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé¢„å…ˆåˆ›å»ºäº†è‹¥å¹²æ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸èƒ½ç”±ç”¨æˆ·ç›´æ¥å¯¹çº¿ç¨‹çš„åˆ›å»ºè¿›è¡Œæ§åˆ¶ï¼Œåœ¨è¿™ä¸ªå‰æä¸‹é‡å¤ä½¿ç”¨å›ºå®šæˆ–è¾ƒä¸ºå›ºå®šæ•°ç›®çš„çº¿ç¨‹æ¥å®Œæˆä»»åŠ¡çš„æ‰§è¡Œã€‚</p>
<p>çº¿ç¨‹æ± çš„å¥½å¤„ï¼š<br>1ã€æ¶ˆé™¤äº†é¢‘ç¹åˆ›å»ºå’Œæ¶ˆäº¡çº¿ç¨‹çš„ç³»ç»Ÿèµ„æºå¼€é”€<br>2ã€é¢å¯¹è¿‡é‡ä»»åŠ¡çš„æäº¤èƒ½å¤Ÿå¹³ç¼“çš„åŠ£åŒ–ã€‚</p>
<p>çº¿ç¨‹æ± æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public interface ThreadPool&lt;Job extends Runnable&gt; &#123;</span><br><span class="line">    // æ‰§è¡Œä¸€ä¸ªJobï¼Œè¿™ä¸ªJobéœ€è¦å®ç°Runnable</span><br><span class="line">    void execute(Job job);</span><br><span class="line"></span><br><span class="line">    // å…³é—­çº¿ç¨‹æ± </span><br><span class="line">    void shutdown();</span><br><span class="line"></span><br><span class="line">    // å¢åŠ å·¥ä½œè€…çº¿ç¨‹</span><br><span class="line">    void addWorkers(int num);</span><br><span class="line"></span><br><span class="line">    // å‡å°‘å·¥ä½œè€…çº¿ç¨‹</span><br><span class="line">    void removeWorker(int num);</span><br><span class="line"></span><br><span class="line">    // å¾—åˆ°æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡</span><br><span class="line">    int getJobSize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡execute(Job)æ–¹æ³•å°†Jobæäº¤å…¥çº¿ç¨‹æ± æ‰§è¡Œï¼Œè€Œå®¢æˆ·ç«¯è‡ªèº«ä¸ç”¨ç­‰å¾…Jobçš„æ‰§è¡Œå®Œæˆã€‚<br>é™¤äº†execute(Job)æ–¹æ³•ä»¥å¤–ï¼Œçº¿ç¨‹æ± æ¥å£æä¾›äº†å¢å¤§/å‡å°‘å·¥ä½œè€…çº¿ç¨‹ä»¥åŠå…³é—­çº¿ç¨‹æ± çš„æ–¹æ³•ã€‚<br>è¿™é‡Œå·¥ä½œè€…çº¿ç¨‹ä»£è¡¨ç€ä¸€ä¸ªé‡å¤æ‰§è¡ŒJobçš„çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªç”±å®¢æˆ·ç«¯æäº¤çš„Jobéƒ½å°†è¿›å…¥åˆ°ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ä¸­ç­‰å¾…å·¥ä½œè€…çº¿ç¨‹çš„å¤„ç†ã€‚</p>
<p>æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸ç”¨Executoråˆ›å»ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">public class DefaultThreadPool&lt;Job extends Runnable&gt; implements ThreadPool&lt;Job&gt; &#123;</span><br><span class="line">    // çº¿ç¨‹æ± æœ€å¤§é™åˆ¶æ•°</span><br><span class="line">    private static final int MAX_WORKER_NUMBERS = 10;</span><br><span class="line">    // çº¿ç¨‹æ± é»˜è®¤çš„æ•°é‡</span><br><span class="line">    private static final int DEFAULT_WORKER_NUMBERS = 5;</span><br><span class="line">    // çº¿ç¨‹æ± æœ€å°çš„æ•°é‡</span><br><span class="line">    private static final int MIN_WORKER_NUMBERS = 1;</span><br><span class="line">    // è¿™æ˜¯ä¸€ä¸ªå·¥ä½œåˆ—è¡¨ï¼Œå°†ä¼šå‘é‡Œé¢æ’å…¥å·¥ä½œ</span><br><span class="line">    private final LinkedList&lt;Job&gt; jobs = new LinkedList&lt;Job&gt;();</span><br><span class="line">    // å·¥ä½œè€…åˆ—è¡¨</span><br><span class="line">    private final List&lt;Worker&gt; workers = Collections.synchronizedList(new ArrayList&lt;Worker&gt;());</span><br><span class="line">    // å·¥ä½œè€…çº¿ç¨‹çš„æ•°é‡</span><br><span class="line">    private int workerNum = DEFAULT_WORKER_NUMBERS;</span><br><span class="line">    // çº¿ç¨‹ç¼–å·ç”Ÿæˆ</span><br><span class="line">    private AtomicLong threadNum = new AtomicLong();</span><br><span class="line">	</span><br><span class="line">    //æ„é€ å‡½æ•°</span><br><span class="line">    public DefaultThreadPool() &#123;</span><br><span class="line">        initializeWokers(DEFAULT_WORKER_NUMBERS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public DefaultThreadPool(int num) &#123;</span><br><span class="line">    	// num &gt; max ï¼Œ å– maxï¼Œnum &lt; min å– minã€‚å…¶ä»–å– num</span><br><span class="line">        workerNum = num &gt; MAX_WORKER_NUMBERS ? MAX_WORKER_NUMBERS:(num &lt; MIN_WORKER_NUMBERS ? MIN_WORKER_NUMBERS : num);</span><br><span class="line">        initializeWokers(workerNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Job job) &#123;</span><br><span class="line">        if (job != null) &#123;</span><br><span class="line">            // æ·»åŠ ä¸€ä¸ªå·¥ä½œï¼Œç„¶åè¿›è¡Œé€šçŸ¥</span><br><span class="line">            synchronized (jobs) &#123;</span><br><span class="line">                jobs.addLast(job);</span><br><span class="line">                jobs.notify();   //é€šçŸ¥ï¼ˆè¿™é‡Œjobsæ—¢æ˜¯flagåˆæ˜¯lockï¼‰</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void shutdown() &#123;</span><br><span class="line">        for (Worker worker : workers) &#123;</span><br><span class="line">            worker.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void addWorkers(int num) &#123;</span><br><span class="line">        synchronized (jobs) &#123;</span><br><span class="line">            // é™åˆ¶æ–°å¢çš„Workeræ•°é‡ä¸èƒ½è¶…è¿‡æœ€å¤§å€¼</span><br><span class="line">            if (num + this.workerNum &gt; MAX_WORKER_NUMBERS) &#123;</span><br><span class="line">                num = MAX_WORKER_NUMBERS - this.workerNum;</span><br><span class="line">            &#125;</span><br><span class="line">            initializeWokers(num);</span><br><span class="line">            this.workerNum += num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void removeWorker(int num) &#123;</span><br><span class="line">        synchronized (jobs) &#123;</span><br><span class="line">            if (num &gt;= this.workerNum) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;beyond workNum&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            // æŒ‰ç…§ç»™å®šçš„æ•°é‡åœæ­¢Worker</span><br><span class="line">            int count = 0;</span><br><span class="line">            while (count &lt; num) &#123;</span><br><span class="line">                Worker worker = workers.get(count);</span><br><span class="line">                if (workers.remove(worker)) &#123;</span><br><span class="line">                    worker.shutdown();</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            this.workerNum -= count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getJobSize() &#123;</span><br><span class="line">        return jobs.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // åˆå§‹åŒ–çº¿ç¨‹å·¥ä½œè€…</span><br><span class="line">    private void initializeWokers(int num) &#123;</span><br><span class="line">        for (int i = 0; i &lt; num; i++) &#123;</span><br><span class="line">            Worker worker = new Worker();</span><br><span class="line">            workers.add(worker);</span><br><span class="line">            Thread thread = new Thread(worker, &quot;ThreadPool-Worker-&quot; + threadNum.inrementAndGet());</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å·¥ä½œè€…ï¼Œè´Ÿè´£æ¶ˆè´¹ä»»åŠ¡</span><br><span class="line">    class Worker implements Runnable &#123;</span><br><span class="line">        // æ˜¯å¦å·¥ä½œ</span><br><span class="line">        private volatile boolean running = true;</span><br><span class="line"></span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (running) &#123;</span><br><span class="line">                Job job = null;</span><br><span class="line">                synchronized (jobs) &#123;</span><br><span class="line">                    // å¦‚æœå·¥ä½œè€…åˆ—è¡¨æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±wait</span><br><span class="line">                    while (jobs.isEmpty()) &#123;</span><br><span class="line">                        try &#123;</span><br><span class="line">                            jobs.wait();  //ç­‰å¾…</span><br><span class="line">                        &#125; catch (InterruptedException ex) &#123;</span><br><span class="line">                            // æ„ŸçŸ¥åˆ°å¤–éƒ¨å¯¹WorkerThreadçš„ä¸­æ–­æ“ä½œï¼Œè¿”å›</span><br><span class="line">                            Thread.currentThread().interrupt();</span><br><span class="line">                            return;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // å–å‡ºä¸€ä¸ªJob</span><br><span class="line">                    job = jobs.removeFirst();</span><br><span class="line">                &#125;</span><br><span class="line">                if (job != null) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        job.run();</span><br><span class="line">                    &#125; catch (Exception ex) &#123;</span><br><span class="line">                        // å¿½ç•¥Jobæ‰§è¡Œä¸­çš„Exception</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void shutdown() &#123;</span><br><span class="line">            running = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒJobæ˜¯è¦æ”¾å…¥çº¿ç¨‹æ± çš„çº¿ç¨‹ï¼ŒWorkeræ˜¯çº¿ç¨‹æ± å†…æ‰§è¡ŒJobçº¿ç¨‹çš„å·¥ä½œçº¿ç¨‹ã€‚é‡Œé¢ç”¨äº†ç­‰å¾…é€šçŸ¥æ¨¡å¼ï¼Œæ”¾å…¥ä¸€ä¸ªjobä¼šé€šçŸ¥ä¸€ä¸‹ï¼Œjobsä¸ºç©ºäº†å°±ä¼šç­‰å¾…ã€‚</p>
<p>å½“å®¢æˆ·ç«¯è°ƒç”¨execute(Job)æ–¹æ³•æ—¶ï¼Œä¼šä¸æ–­åœ°å‘ä»»åŠ¡åˆ—è¡¨jobsä¸­æ·»åŠ Jobï¼Œè€Œæ¯ä¸ªå·¥ä½œè€…çº¿ç¨‹ä¼šä¸æ–­åœ°ä»jobsä¸Šå–å‡ºä¸€ä¸ªJobè¿›è¡Œæ‰§è¡Œï¼Œå½“jobsä¸ºç©ºæ—¶ï¼Œå·¥ä½œè€…çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>æ·»åŠ ä¸€ä¸ªJobåï¼Œå¯¹å·¥ä½œé˜Ÿåˆ—jobsè°ƒç”¨äº†å…¶notify()æ–¹æ³•ï¼Œè€Œä¸æ˜¯notifyAll()æ–¹æ³•ï¼Œå› ä¸ºèƒ½å¤Ÿç¡®å®šæœ‰å·¥ä½œè€…çº¿ç¨‹è¢«å”¤é†’ï¼Œè¿™æ—¶ä½¿ç”¨notify()æ–¹æ³•å°†ä¼šæ¯”notifyAll()æ–¹æ³•è·å¾—æ›´å°çš„å¼€é”€ï¼ˆé¿å…å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å…¨éƒ¨ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼‰ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹æ± çš„æœ¬è´¨å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å·¥ä½œé˜Ÿåˆ—è¿æ¥å·¥ä½œè€…çº¿ç¨‹å’Œå®¢æˆ·ç«¯çº¿ç¨‹ï¼Œå®¢æˆ·ç«¯çº¿ç¨‹å°†ä»»åŠ¡æ”¾å…¥å·¥ä½œé˜Ÿåˆ—åä¾¿è¿”å›ï¼Œè€Œå·¥ä½œè€…çº¿ç¨‹åˆ™ä¸æ–­åœ°ä»å·¥ä½œé˜Ÿåˆ—ä¸Šå–å‡ºå·¥ä½œå¹¶æ‰§è¡Œã€‚å½“å·¥ä½œé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰€æœ‰çš„å·¥ä½œè€…çº¿ç¨‹å‡ç­‰å¾…åœ¨å·¥ä½œé˜Ÿåˆ—ä¸Šï¼Œå½“æœ‰å®¢æˆ·ç«¯æäº¤äº†ä¸€ä¸ªä»»åŠ¡ä¹‹åä¼šé€šçŸ¥ä»»æ„ä¸€ä¸ªå·¥ä½œè€…çº¿ç¨‹ï¼Œéšç€å¤§é‡çš„ä»»åŠ¡è¢«æäº¤ï¼Œæ›´å¤šçš„å·¥ä½œè€…çº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚</p>
<h4 id="âœ…ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æŠ€æœ¯çš„ç®€å•WebæœåŠ¡å™¨"><a href="#âœ…ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æŠ€æœ¯çš„ç®€å•WebæœåŠ¡å™¨" class="headerlink" title="âœ…ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æŠ€æœ¯çš„ç®€å•WebæœåŠ¡å™¨"></a>âœ…ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± æŠ€æœ¯çš„ç®€å•WebæœåŠ¡å™¨</h4><p>ç›®å‰çš„æµè§ˆå™¨éƒ½æ”¯æŒå¤šçº¿ç¨‹è®¿é—®ï¼Œæ¯”å¦‚è¯´åœ¨è¯·æ±‚ä¸€ä¸ªHTMLé¡µé¢çš„æ—¶å€™ï¼Œé¡µé¢ä¸­åŒ…å«çš„å›¾ç‰‡èµ„æºã€æ ·å¼èµ„æºä¼šè¢«æµè§ˆå™¨å‘èµ·å¹¶å‘çš„è·å–ã€‚</p>
<p>å¤§éƒ¨åˆ†WebæœåŠ¡å™¨ä¹Ÿéƒ½æ˜¯æ”¯æŒå¹¶å‘è®¿é—®çš„ã€‚å¸¸ç”¨çš„Java WebæœåŠ¡å™¨ï¼Œå¦‚Tomcatã€Jettyï¼Œåœ¨å…¶å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­éƒ½ä½¿ç”¨åˆ°äº†çº¿ç¨‹æ± æŠ€æœ¯ã€‚</p>
<p>ä½¿ç”¨å‰ä¸€èŠ‚ä¸­çš„çº¿ç¨‹æ± æ¥æ„é€ ä¸€ä¸ªç®€å•çš„WebæœåŠ¡å™¨ï¼Œè¿™ä¸ªWebæœåŠ¡å™¨ç”¨æ¥å¤„ç†HTTPè¯·æ±‚ï¼Œç›®å‰åªèƒ½å¤„ç†ç®€å•çš„æ–‡æœ¬å’ŒJPGå›¾ç‰‡å†…å®¹ã€‚è¿™ä¸ªWebæœåŠ¡å™¨ä½¿ç”¨mainçº¿ç¨‹ä¸æ–­åœ°æ¥å—å®¢æˆ·ç«¯Socketçš„è¿æ¥ï¼Œå°†è¿æ¥ä»¥åŠè¯·æ±‚æäº¤ç»™çº¿ç¨‹æ± å¤„ç†ï¼Œè¿™æ ·ä½¿å¾—WebæœåŠ¡å™¨èƒ½å¤ŸåŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">public class SimpleHttpServer &#123;</span><br><span class="line">    // å¤„ç†HttpRequestçš„çº¿ç¨‹æ± </span><br><span class="line">    static ThreadPool&lt;HttpRequestHandler&gt; threadPool = new DefaultThreadPool&lt;HttpRequestHandler&gt;(1);</span><br><span class="line">    // SimpleHttpServerçš„æ ¹è·¯å¾„</span><br><span class="line">    static String basePath;</span><br><span class="line">    static ServerSocket serverSocket;</span><br><span class="line">    // æœåŠ¡ç›‘å¬ç«¯å£</span><br><span class="line">    static int port = 8080;</span><br><span class="line"></span><br><span class="line">    public static void setPort(int port) &#123;</span><br><span class="line">        if (port &gt; 0) &#123;</span><br><span class="line">            SimpleHttpServer.port = port;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setBasePath(String basePath) &#123;</span><br><span class="line">         if (basePath != null &amp;&amp; new File(basePath).exists() &amp;&amp; new File(basePath).isDirectory()) &#123;</span><br><span class="line">            SimpleHttpServer.basePath = basePath;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å¯åŠ¨SimpleHttpServerï¼Œä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚</span><br><span class="line">    public static void start() throws Exception &#123;</span><br><span class="line">        serverSocket = new ServerSocket(port);</span><br><span class="line">        Socket socket = null;</span><br><span class="line">        //accept():3æ¬¡æ¡æ‰‹ç»“æŸï¼Œæ¥å—è¿æ¥</span><br><span class="line">        while ((socket = serverSocket.accept()) != null) &#123;</span><br><span class="line">            // æ¥æ”¶ä¸€ä¸ªå®¢æˆ·ç«¯Socketï¼Œç”Ÿæˆä¸€ä¸ªHttpRequestHandlerï¼Œæ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ</span><br><span class="line">            threadPool.execute(new HttpRequestHandler(socket));</span><br><span class="line">        &#125;</span><br><span class="line">        serverSocket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class HttpRequestHandler implements Runnable &#123;</span><br><span class="line">        private Socket socket;</span><br><span class="line"></span><br><span class="line">        public HttpRequestHandler(Socket socket) &#123;</span><br><span class="line">            this.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            String line = null;</span><br><span class="line">            BufferedReader br = null;</span><br><span class="line">            BufferedReader reader = null;</span><br><span class="line">            PrintWriter out = null;</span><br><span class="line">            InputStream in = null;</span><br><span class="line">            try &#123;</span><br><span class="line">                reader = new BufferedReader(new InputStreamReader(socket.getInputStream()));</span><br><span class="line">                String header = reader.readLine();</span><br><span class="line">                // ç”±ç›¸å¯¹è·¯å¾„è®¡ç®—å‡ºç»å¯¹è·¯å¾„</span><br><span class="line">                String filePath = basePath + header.split(&quot; &quot;)[1];</span><br><span class="line">                out = new PrintWriter(socket.getOutputStream());</span><br><span class="line">                 // å¦‚æœè¯·æ±‚èµ„æºçš„åç¼€ä¸ºjpgæˆ–è€…icoï¼Œåˆ™è¯»å–èµ„æºå¹¶è¾“å‡º</span><br><span class="line">                if (filePath.endsWith(&quot;jpg&quot;) || filePath.endsWith(&quot;ico&quot;)) &#123;</span><br><span class="line">                    in = new FileInputStream(filePath);</span><br><span class="line">                    ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">                    int i = 0;</span><br><span class="line">                    while ((i = in.read()) != -1) &#123;</span><br><span class="line">                        baos.write(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                    byte[] array = baos.toByteArray();</span><br><span class="line">                    out.println(&quot;HTTP/1.1 200 OK&quot;);</span><br><span class="line">                    out.println(&quot;Server: yjx23332&quot;);</span><br><span class="line">                    out.println(&quot;Content-Type: image/jpeg&quot;);</span><br><span class="line">                    out.println(&quot;Content-Length: &quot; + array.length);</span><br><span class="line">                    out.println(&quot;&quot;);</span><br><span class="line">                    System.out.println(&quot;ä¼ å›ï¼&quot;);</span><br><span class="line">                    socket.getOutputStream().write(array, 0, array.length);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    br = new BufferedReader(new InputStreamReader(new</span><br><span class="line">                            FileInputStream(filePath)));</span><br><span class="line">                    out = new PrintWriter(socket.getOutputStream());</span><br><span class="line">                    out.println(&quot;HTTP/1.1 200 OK&quot;);</span><br><span class="line">                    out.println(&quot;Server: yjx23332&quot;);</span><br><span class="line">                    out.println(&quot;Content-Type: text/html; charset=UTF-8&quot;);</span><br><span class="line">                    out.println(&quot;&quot;);</span><br><span class="line">                    while ((line = br.readLine()) != null) &#123;</span><br><span class="line">                        out.println(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                out.flush();</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                out.println(&quot;HTTP/1.1 500&quot;);</span><br><span class="line">                out.println(&quot;&quot;);</span><br><span class="line">                out.flush();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                close(br, in, reader, out, socket);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å…³é—­æµæˆ–è€…Socket</span><br><span class="line">    private static void close(Closeable... closeables) &#123;</span><br><span class="line">        if (closeables != null) &#123;</span><br><span class="line">            for (Closeable closeable : closeables) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    closeable.close();</span><br><span class="line">                &#125; catch (Exception ex) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleHttpServeræä¾›è®¾ç½®ç«¯å£å’Œè·Ÿè·¯å¾„çš„æ–¹æ³•ï¼ŒSimpleHttpServeråœ¨å»ºç«‹äº†ä¸å®¢æˆ·ç«¯çš„è¿æ¥ä¹‹åï¼Œå¹¶ä¸ä¼šå¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè€Œæ˜¯å°†å…¶åŒ…è£…æˆHttpRequestHandlerå¹¶äº¤ç”±çº¿ç¨‹æ± å¤„ç†ã€‚</p>
<p>åœ¨çº¿ç¨‹æ± ä¸­çš„Workerå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„åŒæ—¶ï¼ŒSimpleHttpServerèƒ½å¤Ÿç»§ç»­å®Œæˆåç»­å®¢æˆ·ç«¯è¿æ¥çš„å»ºç«‹ï¼Œä¸ä¼šé˜»å¡åç»­å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚Workerå¤„ç†è¯·æ±‚èµ„æºç”Ÿæˆå“åº”å†…å®¹åï¼Œå¼‚æ­¥è¾“å‡ºå†…å®¹åˆ°å®¢æˆ·ç«¯ã€‚</p>
<p>htmlé¡µé¢ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;æµ‹è¯•é¡µé¢&lt;/title&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">&lt;body &gt;</span><br><span class="line">	&lt;h1&gt;ç¬¬ä¸€å¼ å›¾ç‰‡&lt;/h1&gt;</span><br><span class="line">	&lt;img src=&quot;1.jpg&quot; /&gt;</span><br><span class="line">	&lt;h1&gt;ç¬¬äºŒå¼ å›¾ç‰‡&lt;/h1&gt;</span><br><span class="line">	&lt;img src=&quot;2.jpg&quot; /&gt;</span><br><span class="line">	&lt;h1&gt;ç¬¬ä¸‰å¼ å›¾ç‰‡&lt;/h1&gt;</span><br><span class="line">	&lt;img src=&quot;3.jpg&quot; /&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>å°†SimpleHttpServerçš„æ ¹ç›®å½•è®¾å®šåˆ°è¯¥HTMLé¡µé¢æ‰€åœ¨ç›®å½•ï¼Œå¹¶å¯åŠ¨SimpleHttpServerã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws Exception &#123;</span><br><span class="line">    SimpleHttpServer.setBasePath(&quot;C:\Users\Administrator\Desktop\server&quot;);</span><br><span class="line">    SimpleHttpServer.setPort(8080);</span><br><span class="line">    SimpleHttpServer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>âš ï¸çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼š<br>çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå…·ä½“çš„æ•°é‡éœ€è¦è¯„ä¼°æ¯ä¸ªä»»åŠ¡çš„å¤„ç†æ—¶é—´ï¼Œä»¥åŠå½“å‰è®¡ç®—æœºçš„å¤„ç†å™¨èƒ½åŠ›å’Œæ•°é‡ã€‚ä½¿ç”¨çš„çº¿ç¨‹è¿‡å°‘ï¼Œæ— æ³•å‘æŒ¥å¤„ç†å™¨çš„æ€§èƒ½ï¼›ä½¿ç”¨çš„çº¿ç¨‹è¿‡å¤šï¼Œå°†ä¼šå¢åŠ ç³»ç»Ÿçš„æ— æ•…å¼€é”€ï¼Œèµ·åˆ°ç›¸åçš„ä½œç”¨ã€‚</p>
<p>åŸä¹¦ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46949627/article/details/127009251">https://blog.csdn.net/weixin_46949627/article/details/127009251</a></p>
<h2 id="ç¬¬äº”ç« -javaä¸­çš„é”"><a href="#ç¬¬äº”ç« -javaä¸­çš„é”" class="headerlink" title="ç¬¬äº”ç«  javaä¸­çš„é”"></a>ç¬¬äº”ç«  javaä¸­çš„é”</h2><p>ä»‹ç»javaå¹¶å‘åŒ…ä¸­ä¸é”ç›¸å…³çš„APIå’Œç»„ä»¶ï¼Œä»¥åŠè¿™äº›APIå’Œç»„ä»¶çš„ä½¿ç”¨æ–¹å¼å’Œå®ç°ç»†èŠ‚ã€‚</p>
<h3 id="1-Lockæ¥å£"><a href="#1-Lockæ¥å£" class="headerlink" title="1.Lockæ¥å£"></a>1.Lockæ¥å£</h3><p>é”æ˜¯ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ–¹å¼ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªé”èƒ½å¤Ÿé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å…±äº«èµ„æºï¼ˆä½†æ˜¯æœ‰äº›é”å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚è¯»å†™é”ï¼‰ã€‚</p>
<h4 id="âœ…Lockæ¥å£å’Œsynchronizedå…³é”®å­—çš„å¯¹æ¯”"><a href="#âœ…Lockæ¥å£å’Œsynchronizedå…³é”®å­—çš„å¯¹æ¯”" class="headerlink" title="âœ…Lockæ¥å£å’Œsynchronizedå…³é”®å­—çš„å¯¹æ¯”"></a>âœ…Lockæ¥å£å’Œsynchronizedå…³é”®å­—çš„å¯¹æ¯”</h4><p>åœ¨Lockæ¥å£å‡ºç°ä¹‹å‰ï¼ŒJavaç¨‹åºæ˜¯é synchronizedå…³é”®å­—å®ç°é”åŠŸèƒ½çš„ï¼Œè€ŒJava SE 5ä¹‹åï¼Œå¹¶å‘åŒ…ä¸­æ–°å¢äº†Lockæ¥å£ï¼ˆä»¥åŠç›¸å…³å®ç°ç±»ï¼‰ç”¨æ¥å®ç°é”åŠŸèƒ½ï¼Œå®ƒæä¾›äº†ä¸synchronizedå…³é”®å­—ç±»ä¼¼çš„åŒæ­¥åŠŸèƒ½ï¼Œåªæ˜¯åœ¨ä½¿ç”¨æ—¶éœ€è¦æ˜¾å¼åœ°è·å–å’Œé‡Šæ”¾é”ã€‚</p>
<p>è™½ç„¶å®ƒç¼ºå°‘äº†ï¼ˆé€šè¿‡synchronizedå—æˆ–è€…æ–¹æ³•æ‰€æä¾›çš„ï¼‰éšå¼è·å–é‡Šæ”¾é”çš„ä¾¿æ·æ€§ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†é”è·å–ä¸é‡Šæ”¾çš„å¯æ“ä½œæ€§ã€å¯ä¸­æ–­çš„è·å–é”ä»¥åŠè¶…æ—¶è·å–é”ç­‰å¤šç§synchronizedå…³é”®å­—æ‰€ä¸å…·å¤‡çš„åŒæ­¥ç‰¹æ€§ã€‚</p>
<p>ä½¿ç”¨synchronizedå…³é”®å­—å°†ä¼šéšå¼åœ°è·å–é”ï¼Œä½†æ˜¯å®ƒå°†é”çš„è·å–å’Œé‡Šæ”¾å›ºåŒ–äº†ï¼Œä¹Ÿå°±æ˜¯å…ˆè·å–å†é‡Šæ”¾ã€‚å½“ç„¶ï¼Œè¿™ç§æ–¹å¼ç®€åŒ–äº†åŒæ­¥çš„ç®¡ç†ï¼Œå¯æ˜¯æ‰©å±•æ€§æ²¡æœ‰æ˜¾ç¤ºçš„é”è·å–å’Œé‡Šæ”¾æ¥çš„å¥½ã€‚ä¾‹å¦‚ï¼šå…ˆè·å¾—é”Aï¼Œç„¶åå†è·å–é”Bã€‚</p>
<p>Lockçš„ä½¿ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Lock lock = new ReentrantLock();</span><br><span class="line">lock.lock();</span><br><span class="line">try &#123;</span><br><span class="line"></span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨finallyå—ä¸­é‡Šæ”¾é”ï¼Œç›®çš„æ˜¯ä¿è¯åœ¨è·å–åˆ°é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾ã€‚ä¸è¦å°†è·å–é”çš„è¿‡ç¨‹å†™åœ¨tryå—ä¸­ï¼Œå› ä¸ºå¦‚æœåœ¨è·å–é”ï¼ˆè‡ªå®šä¹‰é”çš„å®ç°ï¼‰æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸æŠ›å‡ºçš„åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´é”æ— æ•…é‡Šæ”¾ã€‚</p>
<p>Lockå…·å¤‡çš„sychronizedå…³é”®å­—ä¸å…·å¤‡çš„ç‰¹ç‚¹ï¼š<br>1ã€éé˜»å¡åœ°è·å–é”<br>2ã€èƒ½è¢«ä¸­æ–­åœ°è·å–é”ï¼ˆè·å–åˆ°é”çš„çº¿ç¨‹èƒ½å“åº”ä¸­æ–­ï¼Œä¸­æ–­å¼‚å¸¸è¢«æŠ›å‡ºï¼ŒåŒæ—¶é”é‡Šæ”¾ï¼‰<br>3ã€è¶…æ—¶è·å–é”ï¼ˆæˆªæ­¢æ—¶é—´æ— æ³•è·å–é”ï¼Œåˆ™è¿”å›ï¼‰</p>
<h4 id="âœ…Lockæ¥å£ä¸­çš„API"><a href="#âœ…Lockæ¥å£ä¸­çš„API" class="headerlink" title="âœ…Lockæ¥å£ä¸­çš„API"></a>âœ…Lockæ¥å£ä¸­çš„API</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void lock()</span><br><span class="line">è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å½“å‰çº¿ç¨‹å°†ä¼šè·å–é”ï¼Œå½“é”è·å¾—åï¼Œä»è¯¥æ–¹æ³•è¿”å›</span><br><span class="line"></span><br><span class="line">void lockInterruptibly() throws InterruptedException	</span><br><span class="line">å¯ä¸­æ–­åœ°è·å–é”ï¼Œå’Œ lock()æ–¹æ³•çš„ä¸åŒä¹‹å¤„åœ¨äºè¯¥æ–¹æ³•ä¼šå“åº”ä¸­æ–­ï¼Œå³åœ¨é”çš„è·å–ä¸­å¯ä»¥ä¸­æ–­å½“å‰çº¿ç¨‹</span><br><span class="line"></span><br><span class="line">boolean tryLock()	</span><br><span class="line">å°è¯•éé˜»å¡çš„è·å–é”ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åç«‹åˆ»è¿”å›ï¼Œå¦‚æœèƒ½å¤Ÿè·å–åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span><br><span class="line"></span><br><span class="line">boolean tryLock(1ong time,TimeUnit unit) throws InterruptedException	</span><br><span class="line">è¶…æ—¶çš„è·å–é”ï¼Œå½“å‰çº¿ç¨‹åœ¨ä»¥ä¸‹3ç§æƒ…å†µä¸‹ä¼šè¿”å›ï¼šâ‘ å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è·å¾—äº†é” â‘¡å½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…è¢«ä¸­æ–­ â‘¢è¶…æ—¶æ—¶é—´ç»“æŸï¼Œè¿”å›false</span><br><span class="line"></span><br><span class="line">void unlock() </span><br><span class="line">é‡Šæ”¾é”</span><br><span class="line"></span><br><span class="line">Condition newCondition()	</span><br><span class="line">è·å–ç­‰å¾…é€šçŸ¥ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å’Œå½“å‰çš„é”ç»‘å®šï¼Œå½“å‰çº¿ç¨‹åªæœ‰è·å¾—äº†é”ï¼Œæ‰èƒ½è°ƒç”¨è¯¥ç»„ä»¶çš„ wait()æ–¹æ³•ï¼Œè€Œè°ƒç”¨åï¼Œå½“å‰çº¿ç¨‹å°†é‡Šæ”¾é”</span><br></pre></td></tr></table></figure>

<p>éšåä¼šè¯¦ç»†ä»‹ç»åŒæ­¥å™¨AbstractQueuedSynchronizerä»¥åŠå¸¸ç”¨Lockæ¥å£çš„å®ç°ReentrantLockã€‚Lockæ¥å£çš„å®ç°åŸºæœ¬éƒ½æ˜¯é€šè¿‡èšåˆäº†ä¸€ä¸ªåŒæ­¥å™¨çš„å­ç±»æ¥å®Œæˆçº¿ç¨‹è®¿é—®æ§åˆ¶çš„ã€‚</p>
<h3 id="2-é˜Ÿåˆ—åŒæ­¥å™¨"><a href="#2-é˜Ÿåˆ—åŒæ­¥å™¨" class="headerlink" title="2.é˜Ÿåˆ—åŒæ­¥å™¨"></a>2.é˜Ÿåˆ—åŒæ­¥å™¨</h3><p>é˜Ÿåˆ—åŒæ­¥å™¨ AbstractQueuedSynchronizerï¼ˆAQSï¼Œä»¥ä¸‹ç®€ç§°åŒæ­¥å™¨ï¼‰ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªintæˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚</p>
<p>åŒæ­¥å™¨æä¾›çš„3ä¸ªæ–¹æ³•æ¥å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œæ›´æ”¹ï¼Œå®ƒä»¬èƒ½å¤Ÿä¿è¯çŠ¶æ€çš„æ”¹å˜æ˜¯å®‰å…¨çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getState()  è·å–å½“å‰åŒæ­¥çŠ¶æ€ã€‚</span><br><span class="line">setState(int newState)  è®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ã€‚</span><br><span class="line">compareAndSetState(int expect,int update)ï¼‰ ä½¿ç”¨CASè®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€</span><br></pre></td></tr></table></figure>

<p>å­ç±»é€šè¿‡ç»§æ‰¿åŒæ­¥å™¨å¹¶å®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œå­ç±»æ¨èè¢«å®šä¹‰ä¸ºè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„é™æ€å†…éƒ¨ç±»ã€‚åŒæ­¥å™¨è‡ªèº«æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ï¼Œå®ƒä»…ä»…æ˜¯å®šä¹‰äº†ä¸Šé¢åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æ¥ä¾›è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä½¿ç”¨ï¼ŒåŒæ­¥å™¨æ—¢å¯ä»¥æ”¯æŒç‹¬å å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå…±äº«å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿å®ç°ä¸åŒç±»å‹çš„åŒæ­¥ç»„ä»¶ï¼š<br>ReentrantLock<br>ReentrantReadWriteLock<br>CountDownLatch</p>
<p>é˜Ÿåˆ—åŒæ­¥å™¨ä¸é”çš„å…³ç³»ï¼š</p>
<p>åŒæ­¥å™¨æ˜¯å®ç°é”ï¼ˆä¹Ÿå¯ä»¥æ˜¯ä»»æ„åŒæ­¥ç»„ä»¶ï¼‰çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ï¼Œåˆ©ç”¨åŒæ­¥å™¨å®ç°é”çš„è¯­ä¹‰ã€‚</p>
<p>1ã€é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸é”äº¤äº’çš„æ¥å£ï¼ˆæ¯”å¦‚å¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œè®¿é—®ï¼‰ï¼Œéšè—äº†å®ç°ç»†èŠ‚<br>2ã€åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚é”å’ŒåŒæ­¥å™¨å¾ˆå¥½åœ°éš”ç¦»äº†ä½¿ç”¨è€…å’Œå®ç°è€…æ‰€éœ€å…³æ³¨çš„é¢†åŸŸã€‚</p>
<h4 id="âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹"><a href="#âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹" class="headerlink" title="âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹"></a>âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„æ¥å£ä¸ç¤ºä¾‹</h4><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œéšåå°†åŒæ­¥å™¨ä½œä¸ºé™æ€å†…éƒ¨ç±»ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ã€‚</p>
<p><strong>åŒæ­¥å™¨å¯é‡å†™çš„æ–¹æ³•</strong>ï¼ŒåŒ…å«ä¸¤ç§ï¼Œä¸€ç§æ˜¯è·å–ç‹¬å é”ï¼Œä¸€ç§æ˜¯è·å–å…±äº«é”ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œå®ç°è¯¥æ–¹æ³•éœ€è¦æŸ¥è¯¢å½“å‰çŠ¶æ€ï¼Œå¹¶åˆ¤æ–­åŒæ­¥çŠ¶æ€æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç„¶åé€šè¿‡CASè®¾ç½®åŒæ­¥çŠ¶æ€ï¼ˆéé˜»å¡çš„ï¼Ÿï¼‰</span><br><span class="line"> */</span><br><span class="line">protected boolean tryAcquire(int arg) &#123;</span><br><span class="line">    throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œæ­¤æ—¶ç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹å°†æœ‰æœºä¼šè·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> */</span><br><span class="line">protected boolean tryRelease(int arg) &#123;</span><br><span class="line">    throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿”å›ç»“æœå¤§äºç­‰äº0ï¼Œè¡¨ç¤ºè·å–æˆåŠŸï¼Œå¦åˆ™è·å–å¤±è´¥</span><br><span class="line"> */</span><br><span class="line">protected int tryAcquireShared(int arg) &#123;</span><br><span class="line">    throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</span><br><span class="line"> */</span><br><span class="line">protected boolean tryReleaseShared(int arg) &#123;</span><br><span class="line">    throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * æ˜¯å¦è¢«å½“å‰çº¿ç¨‹æ‰€ç‹¬å </span><br><span class="line"> */</span><br><span class="line">protected boolean isHeldExclusively() &#123;</span><br><span class="line">    throw new UnsupportedOperationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°è‡ªå®šä¹‰çš„åŒæ­¥å™¨ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨<strong>åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•</strong>ï¼ŒåŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•åˆ†ä¸ºä¸‰ç±»ï¼šä¸€æ˜¯ç‹¬å å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€äºŒæ˜¯å…±äº«å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€ä¸‰æ˜¯æŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…çº¿ç¨‹çš„æƒ…å†µã€‚è‡ªå®šä¹‰çš„åŒæ­¥å™¨å°†ä½¿ç”¨è¿™äº›æä¾›çš„æ¨¡æ¿æ–¹æ³•æ¥å®ç°è‡ªå·±çš„åŒæ­¥è¯­ä¹‰ã€‚åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> * å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™è¯¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦åˆ™ï¼Œå½“å‰çº¿ç¨‹å°†ä¼šè¿›å…¥</span><br><span class="line"> * åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œè¯¥æ–¹æ³•å°†ä¼šè°ƒç”¨é‡å†™çš„tryAcquireæ–¹æ³•ï¼ˆåŒºåˆ«ï¼šä¸€ä¸ªæœ‰è¿”å›ï¼Œä¸€ä¸ªæ²¡æœ‰ï¼Œè¾“å…¥æ²¡ä»€ä¹ˆç”¨ï¼Ÿï¼‰</span><br><span class="line"> */</span><br><span class="line">public final void acquire(int arg) &#123;</span><br><span class="line">    if (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> * ä¸acquire ç›¸åŒï¼Œä½†æ˜¯è¯¥æ–¹æ³•å“åº”ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹æœªè·å–åˆ°åŒæ­¥çŠ¶æ€åˆ™è¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼›å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸å¹¶è¿”å›</span><br><span class="line"> */</span><br><span class="line">public final void acquireInterruptibly(int arg)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    if (!tryAcquire(arg))</span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> * è¯¥æ–¹æ³•åœ¨ acquireInterruptibly(int arg) åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰è·å–åŒæ­¥çŠ¶æ€ï¼Œé‚£ä¹ˆå°†è¿”å›falseï¼Œå¦åˆ™è¿”å›true</span><br><span class="line"> */</span><br><span class="line">public final boolean tryAcquireNanos(int arg, long nanosTimeout)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    return tryAcquire(arg) ||</span><br><span class="line">        doAcquireNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ç‹¬å å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</span><br><span class="line"> * è¯¥æ–¹æ³•ä¼šåœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†åŒæ­¥é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’</span><br><span class="line"> */</span><br><span class="line">public final boolean release(int arg) &#123;</span><br><span class="line">    if (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        if (h != null &amp;&amp; h.waitStatus != 0)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> * ä¸ç‹¬å å¼çš„åŒºåˆ«åœ¨äºï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è·å¾—åŒæ­¥çŠ¶æ€</span><br><span class="line"> */</span><br><span class="line">public final void acquireShared(int arg) &#123;</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> * ä¸æ–¹æ³•acquireShared(int arg) ä¸€æ ·ï¼Œåªæ˜¯è¯¥æ–¹æ³•å“åº”ä¸­æ–­</span><br><span class="line"> */</span><br><span class="line">public final void acquireSharedInterruptibly(int arg)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€</span><br><span class="line"> * åœ¨æ–¹æ³• acquireSharedInterruptibly(int arg) åŸºç¡€ä¸Šï¼Œå¢åŠ äº†è¶…æ—¶é™åˆ¶</span><br><span class="line"> */</span><br><span class="line">public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout)</span><br><span class="line">        throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    return tryAcquireShared(arg) &gt;= 0 ||</span><br><span class="line">        doAcquireSharedNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å…±äº«å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€</span><br><span class="line"> */</span><br><span class="line">public final boolean releaseShared(int arg) &#123;</span><br><span class="line">    if (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * è·å–åœ¨åŒæ­¥é˜Ÿåˆ—ä¸Šç­‰å¾…çš„çº¿ç¨‹çš„é›†åˆ</span><br><span class="line"> */</span><br><span class="line">public final Collection&lt;Thread&gt; getQueuedThreads() &#123;</span><br><span class="line">    ArrayList&lt;Thread&gt; list = new ArrayList&lt;Thread&gt;();</span><br><span class="line">    for (Node p = tail; p != null; p = p.prev) &#123;</span><br><span class="line">        Thread t = p.thread;</span><br><span class="line">        if (t != null)</span><br><span class="line">            list.add(t);</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¾è€Œæ˜“è§ï¼Œç‹¬å é”æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—é”ï¼Œè€Œå…¶ä»–è·å–é”çš„çº¿ç¨‹åªèƒ½åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œåªæœ‰æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾äº†ï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½è·å¾—é”ã€‚<strong>ç‹¬å é”çš„ç¤ºä¾‹</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">public class Mutex implements Lock &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * é™æ€å†…éƒ¨ç±»è‡ªå®šä¹‰åŒæ­¥å™¨</span><br><span class="line">     */</span><br><span class="line">    private static class Sync extends AbstractQueuedSynchronizer &#123;</span><br><span class="line">        /**</span><br><span class="line">         * æ˜¯å¦å¤„äºç‹¬å çŠ¶æ€</span><br><span class="line">         */</span><br><span class="line">        @Override</span><br><span class="line">        protected boolean isHeldExclusively() &#123;</span><br><span class="line">            return getState() == 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * ç‹¬å å¼è·å–é”ï¼ŒçŠ¶æ€ä¸º0æ—¶è·å–é”</span><br><span class="line">         * å¦‚æœç»è¿‡CASè®¾ç½®æˆåŠŸï¼ˆåŒæ­¥çŠ¶æ€è®¾ç½®ä¸º1ï¼‰</span><br><span class="line">         */</span><br><span class="line">        @Override</span><br><span class="line">        public boolean tryAcquire(int acquires) &#123;</span><br><span class="line">            if (compareAndSetState(0, 1)) &#123;  //0æ˜¯æœŸæœ›ï¼Œ1æ˜¯æ›´æ–°</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * ç‹¬å å¼é‡Šæ”¾é”ï¼Œåªæ˜¯å°†çŠ¶æ€ç½®ä¸º0</span><br><span class="line">         */</span><br><span class="line">        @Override</span><br><span class="line">        protected boolean tryRelease(int releases) &#123;</span><br><span class="line">            if (getState() == 0) &#123;</span><br><span class="line">                throw new IllegalMonitorStateException();</span><br><span class="line">            &#125;</span><br><span class="line">            setExclusiveOwnerThread(null);</span><br><span class="line">            setState(0);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * å®ä¾‹åŒ–ä¸€ä¸ª Conditionï¼Œæ¯ä¸ª Condition éƒ½åŒ…å«ä¸€ä¸ªé˜Ÿåˆ—</span><br><span class="line">         */</span><br><span class="line">        Condition newCondition() &#123;</span><br><span class="line">            return new ConditionObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static final Sync sync = new Sync();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void lock() &#123;</span><br><span class="line">        sync.acquire(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean tryLock() &#123;</span><br><span class="line">        return sync.tryAcquire(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void unlock() &#123;</span><br><span class="line">        sync.release(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Condition newCondition() &#123;</span><br><span class="line">        return sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isLocked() &#123;</span><br><span class="line">        return sync.isHeldExclusively();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean hasQueuedThreads() &#123;</span><br><span class="line">        return sync.hasQueuedThreads();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void lockInterruptibly() throws InterruptedException &#123;</span><br><span class="line">        sync.acquireInterruptibly(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean tryLock(long timeout, TimeUnit unit) throws InterruptedException &#123;</span><br><span class="line">        return sync.tryAcquireNanos(1, unit.toNanos(timeout));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¥éª¤ï¼š<br>1ã€è‡ªå®šä¹‰å®šä¹‰ç‹¬å é”å®ç°Lockï¼Œæ‰€ä»¥éœ€è¦å®ç°Lockæ¥å£ä¸­çš„API<br>2ã€è‡ªå®šä¹‰åŒæ­¥å™¨ä½œä¸ºé™æ€å†…éƒ¨ç±»ç»§æ‰¿è‡ªåŒæ­¥å™¨ï¼Œé‡å†™åŒæ­¥å™¨æ–¹æ³•ï¼Œå®ç°ç‹¬å å¼è·å–å’Œé‡Šæ”¾åŒæ­¥çŠ¶æ€<br>3ã€Lockçš„APIä¸­ä½¿ç”¨åŒæ­¥å™¨çš„é‡å†™æ–¹æ³•/æ¨¡ç‰ˆæ–¹æ³•</p>
<p>åœ¨ä½¿ç”¨è‡ªå®šä¹‰åŒæ­¥å™¨Mutex æ—¶ï¼Œä¸ä¼šç›´æ¥ä¸å†…éƒ¨åŒæ­¥å™¨äº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡Mutex æä¾›çš„æ–¹æ³•ã€‚</p>
<p>lockå’ŒtryLockçš„åŒºåˆ«ï¼š<br>lockæ˜¯éé˜»å¡çš„ï¼Œä¼šä¸€ç›´å°è¯•æˆ–é”ï¼Œç”¨acquireæ–¹æ³•ï¼ˆå†…éƒ¨ç”¨tryAcquireæ–¹æ³•ï¼‰çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åä¼šè¢«åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼›tryLockæ˜¯é˜»å¡çš„ï¼Œè·å–ä¸€æ¬¡ï¼Œæ‰€ä»¥ç›´æ¥ç”¨tryAcquireæ–¹æ³•ã€‚</p>
<p>Conditionæ˜¯ä»€ä¹ˆï¼Ÿ<br>ConditionObject æ˜¯AQSçš„å†…éƒ¨ç±»ï¼Œç”¨æ¥ç»´æŠ¤ç­‰å¾…é˜Ÿåˆ—<br>AQSå†…éƒ¨å®é™…ä¸Šæœ‰ä¸¤ä¸ªé˜Ÿåˆ—<br>åŒæ­¥é˜Ÿåˆ—ï¼šå…¬å¹³/éå…¬å¹³ï¼Œå…±äº«/éå…±äº«<br>ç­‰å¾…é˜Ÿåˆ—ï¼šæ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯Condition<br>ç­‰å¾…é˜Ÿåˆ—ä¸­å°±æ˜¯ç”¨awaitæ–¹æ³•æ—¶ä»»åŠ¡è¿›å…¥çš„é˜Ÿåˆ—ï¼ˆç±»ä¼¼ä¹‹å‰ä½¿ç”¨çš„waitï¼Œè¯¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åªæœ‰å”¤é†’æ‰ä¼šå°è¯•è·å–é”ï¼Œä»¥æ­¤å‡å°‘CPUé¢‘ç¹çš„è·å–é”ï¼‰ï¼Œé€šè¿‡signalå”¤é†’ã€‚</p>
<h4 id="âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ"><a href="#âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ" class="headerlink" title="âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ"></a>âœ…é˜Ÿåˆ—åŒæ­¥å™¨çš„å®ç°åˆ†æ</h4><p>æ¥ä¸‹æ¥å°†ä»å®ç°è§’åº¦åˆ†æåŒæ­¥å™¨æ˜¯å¦‚ä½•å®Œæˆçº¿ç¨‹åŒæ­¥çš„ã€‚<br>ä¸»è¦åŒ…æ‹¬ï¼šåŒæ­¥é˜Ÿåˆ—ã€ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾ã€å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾ä»¥åŠè¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ç­‰åŒæ­¥å™¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸æ¨¡æ¿æ–¹æ³•ã€‚</p>
<h5 id="ä¸€ã€åŒæ­¥é˜Ÿåˆ—"><a href="#ä¸€ã€åŒæ­¥é˜Ÿåˆ—" class="headerlink" title="ä¸€ã€åŒæ­¥é˜Ÿåˆ—"></a>ä¸€ã€åŒæ­¥é˜Ÿåˆ—</h5><p>åŒæ­¥å™¨ä¾èµ–å†…éƒ¨çš„åŒæ­¥é˜Ÿåˆ—ï¼ˆä¸€ä¸ªFIFOåŒå‘é˜Ÿåˆ—,FIFOå…ˆè¿›å…ˆå‡ºï¼‰æ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ã€‚</p>
<p>å½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒåŒæ­¥å™¨ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼Œå®ƒä¹Ÿæ˜¯AQSçš„å†…éƒ¨ç±»ï¼‰å¹¶å°†å…¶åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å”¤é†’ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚åŒæ­¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼ˆNodeï¼‰ç”¨æ¥ä¿å­˜è·å–åŒæ­¥çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹å¼•ç”¨ã€ç­‰å¾…çŠ¶æ€ä»¥åŠå‰é©±å’Œåç»§èŠ‚ç‚¹ã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹æˆåŠŸåœ°è·å–äº†åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…é”ï¼‰ï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œè½¬è€Œè¢«æ„é€ æˆä¸ºèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè€Œè¿™ä¸ªåŠ å…¥é˜Ÿåˆ—çš„è¿‡ç¨‹å¿…é¡»è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå› æ­¤åŒæ­¥å™¨æä¾›äº†ä¸€ä¸ªåŸºäºCASçš„è®¾ç½®å°¾èŠ‚ç‚¹çš„æ–¹æ³•ï¼š<code>compareAndSetTail(Node expect,Node update)</code>ï¼Œå®ƒéœ€è¦ä¼ é€’å½“å‰çº¿ç¨‹â€œè®¤ä¸ºâ€çš„å°¾èŠ‚ç‚¹å’Œå½“å‰èŠ‚ç‚¹ï¼Œåªæœ‰è®¾ç½®æˆåŠŸåï¼Œå½“å‰èŠ‚ç‚¹æ‰æ­£å¼ä¸ä¹‹å‰çš„å°¾èŠ‚ç‚¹å»ºç«‹å…³è”ã€‚</p>
<p>åŒæ­¥é˜Ÿåˆ—éµå¾ªFIFOï¼Œé¦–èŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€æˆåŠŸçš„èŠ‚ç‚¹ï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œå°†ä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œè€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ã€‚ï¼ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œæ‰€ä»¥è®¾ç½®å¤´èŠ‚ç‚¹çš„æ–¹æ³•å¹¶ä¸éœ€è¦ä½¿ç”¨CASæ¥ä¿è¯ï¼Œå®ƒåªéœ€è¦å°†é¦–èŠ‚ç‚¹è®¾ç½®æˆä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯ã€‚ï¼‰</p>
<h5 id="äºŒã€ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾"><a href="#äºŒã€ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾" class="headerlink" title="äºŒã€ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾"></a>äºŒã€ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾</h5><p>åŒæ­¥å™¨çš„ <code>acquire(int arg)</code> æ–¹æ³•å¯ä»¥è·å–åŒæ­¥çŠ¶æ€ï¼ˆé˜»å¡å‹çš„ï¼Œç›¸å½“äºæ˜¯è·é”ï¼‰ï¼Œè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿï¼Œä¹Ÿå°±æ˜¯ç”±äºçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥åè¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåç»­å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œæ—¶ï¼Œ<strong>çº¿ç¨‹ä¸ä¼šä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»å‡º</strong>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public final void acquire(int arg) &#123;</span><br><span class="line">	if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">		selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å®Œæˆäº†åŒæ­¥çŠ¶æ€è·å–ã€èŠ‚ç‚¹æ„é€ ã€åŠ å…¥åŒæ­¥é˜Ÿåˆ—ä»¥åŠåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­è‡ªæ—‹ç­‰å¾…çš„ç›¸å…³å·¥ä½œã€‚é¦–å…ˆtryAcquireéé˜»å¡å‹åœ°è·å–ï¼Œå¦‚æœè·å–åˆ°ç›´æ¥è¿”å›äº†ï¼Œè·å–ä¸åˆ°ï¼Œå°±æ„é€ èŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ä¼šä¸€ç›´è‡ªæ—‹å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚</p>
<p>æ­¥éª¤ï¼š<br>1ã€è°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°çš„ tryAcquire(int arg) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¿è¯çº¿ç¨‹å®‰å…¨çš„è·å–åŒæ­¥çŠ¶æ€</p>
<p>2ã€å¦‚æœåŒæ­¥çŠ¶æ€è·å–å¤±è´¥ï¼Œåˆ™æ„é€ åŒæ­¥èŠ‚ç‚¹ï¼ˆç‹¬å å¼Node.EXCLUSIVEï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼‰å¹¶é€šè¿‡ addWaiter(Node node) æ–¹æ³•å°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</p>
<blockquote>
<p>enq(final Node node) æ–¹æ³•ä¸­ï¼ŒåŒæ­¥å™¨é€šè¿‡ â€œæ­»å¾ªç¯â€ æ¥ä¿è¯èŠ‚ç‚¹çš„æ­£ç¡®æ·»åŠ ï¼Œåœ¨ â€œæ­»å¾ªç¯â€ ä¸­åªæœ‰é€šè¿‡CASå°†èŠ‚ç‚¹è®¾ç½®æˆä¸ºå°¾èŠ‚ç‚¹ä¹‹åï¼Œå½“å‰çº¿ç¨‹æ‰èƒ½ä»è¯¥æ–¹æ³•è¿”å›ï¼Œå¦åˆ™ï¼Œå½“å‰çº¿ç¨‹ä¸æ–­åœ°å°è¯•è®¾ç½®ã€‚<br>å¯ä»¥çœ‹å‡ºï¼Œenq(final Node node) æ–¹æ³•å°†å¹¶å‘æ·»åŠ èŠ‚ç‚¹çš„è¯·æ±‚é€šè¿‡CASå˜å¾— â€œä¸²è¡ŒåŒ–â€ äº†ã€‚</p>
</blockquote>
<p>3ã€èŠ‚ç‚¹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ä¹‹åï¼Œå°±è¿›å…¥äº†ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼ˆacquireQueued(Node node,int arg) æ–¹æ³•ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆæˆ–è€…è¯´æ¯ä¸ªçº¿ç¨‹ï¼‰éƒ½åœ¨è‡ªçœåœ°è§‚å¯Ÿï¼Œå½“æ¡ä»¶æ»¡è¶³ï¼Œè·å–åˆ°äº†åŒæ­¥çŠ¶æ€ï¼Œå°±å¯ä»¥ä»è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºï¼Œä»£è¡¨è·å–äº†é”ï¼Œå¦åˆ™ä¾æ—§ç•™åœ¨è¿™ä¸ªè‡ªæ—‹è¿‡ç¨‹ä¸­ï¼ˆå¹¶ä¼šé˜»å¡èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œé˜»å¡çº¿ç¨‹ä¹Ÿå°±æ˜¯è¿›å…¥ç­‰å¾…ï¼Œè‡ªæ—‹ä¸åœï¼Ÿï¼‰</p>
<blockquote>
<p>è™½ç„¶åŒæ­¥é˜Ÿåˆ—ä¸­æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè‡ªæ—‹ï¼Œä½†æ˜¯åªæœ‰å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹æ‰èƒ½å¤Ÿå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼š<br>å¤´èŠ‚ç‚¹æ˜¯æˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œè€Œå¤´èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼Œåç»§èŠ‚ç‚¹çš„çº¿ç¨‹è¢«å”¤é†’åéœ€è¦æ£€æŸ¥è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦æ˜¯å¤´èŠ‚ç‚¹ã€‚<br>ç»´æŠ¤åŒæ­¥é˜Ÿåˆ—çš„FIFOåŸåˆ™ã€‚</p>
</blockquote>
<p>4ã€å¦‚æœè·å–ä¸åˆ°åˆ™é˜»å¡èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œè€Œ<strong>è¢«é˜»å¡çº¿ç¨‹çš„å”¤é†’ä¸»è¦ä¾é å‰é©±èŠ‚ç‚¹çš„å‡ºé˜Ÿæˆ–é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­æ¥å®ç°</strong>ã€‚</p>
<blockquote>
<p>èŠ‚ç‚¹è‡ªæ—‹ï¼Œå‘ç°å‰é©±ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œå°±è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåªæœ‰çº¿ç¨‹è¢«ä¸­æ–­æˆ–å‰é©±èŠ‚ç‚¹è¢«é‡Šæ”¾æ‰ä¼šå†åˆ¤æ–­æ˜¯ä¸æ˜¯å‰é©±æ˜¯å¤´èŠ‚ç‚¹ã€‚å‰é©±æ˜¯å¤´èŠ‚ç‚¹åï¼Œè·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ï¼ˆå‡ ä¸ªç­‰å¾…çŠ¶æ€åº”è¯¥ä¸ä¸€æ ·ï¼Ÿï¼‰</p>
</blockquote>
<p>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–æµç¨‹ï¼Œè§P128</p>
<p>5ã€çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¹¶æ‰§è¡Œäº†ç›¸åº”é€»è¾‘ä¹‹åï¼Œå°±éœ€è¦é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œä½¿å¾—åç»­èŠ‚ç‚¹èƒ½å¤Ÿç»§ç»­è·å–åŒæ­¥çŠ¶æ€ã€‚è°ƒç”¨åŒæ­¥å™¨çš„ release(int arg) æ¨¡ç‰ˆæ–¹æ³•ï¼ˆå†…éƒ¨ç”¨tryReleaseé‡å†™æ–¹æ³•ï¼‰å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè¯¥æ–¹æ³•åœ¨é‡Šæ”¾äº†åŒæ­¥çŠ¶æ€ä¹‹åï¼Œä¼šå”¤é†’å…¶åç»§èŠ‚ç‚¹ï¼ˆè¿›è€Œä½¿åç»§èŠ‚ç‚¹é‡æ–°å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public final boolean release(int arg) &#123;</span><br><span class="line">    // å°è¯•é‡Šæ”¾é”</span><br><span class="line">    if (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        //å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºæˆ–è€…çŠ¶æ€ä¸æ˜¯0</span><br><span class="line">        if (h != null &amp;&amp; h.waitStatus != 0)</span><br><span class="line">            // å”¤é†’åç»§èŠ‚ç‚¹</span><br><span class="line">            unparkSuccessor(h);  //ç”¨æ¥å”¤é†’å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‹¬å å¼åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾è¿‡ç¨‹æ€»ç»“ï¼š<br>1ã€åœ¨è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨ç»´æŠ¤ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œè·å–çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹éƒ½ä¼šè¢«è‡ªæ—‹åœ°åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶åœ¨é˜Ÿåˆ—ä¸­è¿›è¡Œè‡ªæ—‹<br>2ã€ç§»å‡ºé˜Ÿåˆ—ï¼ˆæˆ–åœæ­¢è‡ªæ—‹ï¼‰çš„æ¡ä»¶æ˜¯å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ä¸”æˆåŠŸè·å–äº†åŒæ­¥çŠ¶æ€ã€‚åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨è°ƒç”¨tryRelease(int arg)æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç„¶åå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚<br>3ã€å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåªæ˜¯ä¼šå”¤é†’è¢«é˜»å¡çº¿ç¨‹ï¼Œæ˜¯ä¸ä¼šç«‹åˆ»è¢«ç§»å‡ºé˜Ÿåˆ—çš„ï¼Œè€Œæ˜¯FIFOåˆ°è¯¥èŠ‚ç‚¹æ‰ç§»å‡ºã€‚<br>4ã€ä¸ç®¡æ˜¯è·å–è¿˜æ˜¯é‡Šæ”¾ï¼Œéƒ½æ˜¯æ¨¡ç‰ˆæ–¹æ³•é‡Œè°ƒç”¨äº†é‡å†™çš„tryæ–¹æ³•ã€‚acquireæ˜¯é˜»å¡çš„ï¼ŒtryAcquireæ˜¯éé˜»å¡çš„ï¼Œè¯•ä¸€æ¬¡ï¼Œä¼šè¿”å›æ˜¯å¦æˆåŠŸã€‚</p>
<p>ç–‘é—®â“ï¼š<br>åŒæ­¥é˜Ÿåˆ—ä¸­èŠ‚ç‚¹çš„è‡ªæ—‹å’Œçº¿ç¨‹è¢«é˜»å¡çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿè‡ªæ—‹å‘ç°å‰é©±èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹æˆ–è€…è·å–ä¸åˆ°åŒæ­¥çŠ¶æ€çš„è¯ï¼Œä¼šé˜»å¡çº¿ç¨‹ï¼Œé˜»å¡åæ˜¯ä¾é å‰é©±èŠ‚ç‚¹é‡Šæ”¾åŒæ­¥çŠ¶æ€åå”¤é†’æˆ–æ˜¯ä¸­æ–­å”¤é†’è¿˜æ˜¯ä¸€ç›´è‡ªæ—‹ï¼Ÿ</p>
<h5 id="ä¸‰ã€å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾"><a href="#ä¸‰ã€å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾" class="headerlink" title="ä¸‰ã€å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾"></a>ä¸‰ã€å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ä¸é‡Šæ”¾</h5><p>å…±äº«å¼è·å–ä¸ç‹¬å å¼è·å–æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºåŒä¸€æ—¶åˆ»èƒ½å¦æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚ä»¥æ–‡ä»¶çš„è¯»å†™ä¸ºä¾‹ï¼Œè¯»å¯ä»¥æ˜¯å…±äº«é”ï¼Œå¯ä»¥åŒæ—¶è¯»ï¼Œå†™æ˜¯ç‹¬å é”ï¼Œä¸€ä¸ªåœ¨å†™ï¼Œå…¶ä»–æ—¢ä¸èƒ½è¯»ä¹Ÿä¸èƒ½å†™ã€‚</p>
<p>åœ¨ acquireShared(int arg) æ–¹æ³•ä¸­ï¼ŒåŒæ­¥å™¨è°ƒç”¨ tryAcquireShared(int arg) æ–¹æ³•å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼ŒtryAcquireShared(int arg)æ–¹æ³•è¿”å›å€¼ä¸ºintç±»å‹ï¼Œå½“è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œè¡¨ç¤ºèƒ½å¤Ÿè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚åœ¨doAcquireShared(int arg)æ–¹æ³•çš„è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±ä¸ºå¤´èŠ‚ç‚¹æ—¶ï¼Œå°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè¿”å›å€¼å¤§äºç­‰äº0ï¼Œè¡¨ç¤ºè¯¥æ¬¡è·å–åŒæ­¥çŠ¶æ€æˆåŠŸå¹¶ä»è‡ªæ—‹è¿‡ç¨‹ä¸­é€€å‡ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public final void acquireShared(int arg) &#123;</span><br><span class="line">    // å°äºé›¶è·å–é”å¤±è´¥</span><br><span class="line">    if (tryAcquireShared(arg) &lt; 0)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void doAcquireShared(int arg) &#123;</span><br><span class="line">    // å…±äº«æ¨¡å¼åŠ å…¥åŒæ­¥é˜Ÿåˆ—</span><br><span class="line">    final Node node = addWaiter(Node.SHARED);</span><br><span class="line">    boolean failed = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        boolean interrupted = false;</span><br><span class="line">        for (; ; ) &#123;</span><br><span class="line">            final Node p = node.predecessor();</span><br><span class="line">            // å¦‚æœå‰ä¸€ä¸ªçº¿ç¨‹ä¸ºå¤´ç»“ç‚¹</span><br><span class="line">            if (p == head) &#123;</span><br><span class="line">                // å°è¯•è·å–é”</span><br><span class="line">                int r = tryAcquireShared(arg);</span><br><span class="line">                // æˆåŠŸ</span><br><span class="line">                if (r &gt;= 0) &#123;</span><br><span class="line">                    // å°†è‡ªå·±è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹åŒæ—¶ï¼Œä¼ æ’­çŠ¶æ€ï¼Œrå°±æ˜¯ä¹‹å‰è¿”å›çš„å€¼</span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = null;</span><br><span class="line">                    // å¦‚æœè¿‡è¢«å½“å‰çº¿ç¨‹çŠ¶æ€ä¸ºtrueï¼Œå°±è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</span><br><span class="line">                    if (interrupted)</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = false;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // é€»è¾‘åŒå‰</span><br><span class="line">            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt())</span><br><span class="line">                interrupted = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // é€»è¾‘åŒå‰</span><br><span class="line">        if (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨releaseShared(int arg)æ–¹æ³•å¯ä»¥é‡Šæ”¾åŒæ­¥çŠ¶æ€:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public final boolean releaseShared(int arg) &#123;</span><br><span class="line">    // å°è¯•é‡Šæ”¾é”</span><br><span class="line">    if (tryReleaseShared(arg)) &#123;</span><br><span class="line">        // æˆåŠŸå°±ä¿®æ”¹è‡ªå·±èŠ‚ç‚¹çŠ¶æ€</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†ä¼šå”¤é†’åç»­å¤„äºç­‰å¾…çŠ¶æ€çš„èŠ‚ç‚¹ã€‚å› ä¸ºå¯èƒ½å¤šä¸ªçº¿ç¨‹è·å–é”ï¼Œæ‰€ä»¥ï¼Œå®ƒå’Œç‹¬å å¼ä¸»è¦åŒºåˆ«åœ¨äºtryReleaseShared(int arg)æ–¹æ³•å¿…é¡»ç¡®ä¿åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…èµ„æºæ•°ï¼‰çº¿ç¨‹å®‰å…¨é‡Šæ”¾ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡å¾ªç¯å’ŒCASæ¥ä¿è¯çš„ï¼Œå› ä¸ºé‡Šæ”¾åŒæ­¥çŠ¶æ€çš„æ“ä½œä¼šåŒæ—¶æ¥è‡ªå¤šä¸ªçº¿ç¨‹ã€‚</p>
<h5 id="å››ã€ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€"><a href="#å››ã€ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€" class="headerlink" title="å››ã€ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€"></a>å››ã€ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€</h5><p>é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„ doAcquireNanos(int arg,long nanosTimeout) ã€æ¨¡ç‰ˆæ–¹æ³•ã€‘æ–¹æ³•å¯ä»¥è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€ï¼Œå³åœ¨æŒ‡å®šçš„æ—¶é—´æ®µå†…è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–åˆ°åŒæ­¥çŠ¶æ€åˆ™è¿”å›trueï¼Œå¦åˆ™ï¼Œè¿”å›falseã€‚è¯¥æ–¹æ³•æä¾›äº†ä¼ ç»ŸJavaåŒæ­¥æ“ä½œï¼ˆæ¯”å¦‚synchronizedå…³é”®å­—ï¼‰æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§ã€‚</p>
<p>åœ¨Java 5ä¹‹å‰ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–ä¸åˆ°é”è€Œè¢«é˜»å¡åœ¨synchronizedä¹‹å¤–æ—¶ï¼Œå¯¹è¯¥çº¿ç¨‹è¿›è¡Œä¸­æ–­æ“ä½œï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«ä¿®æ”¹ï¼Œä½†çº¿ç¨‹ä¾æ—§ä¼šé˜»å¡åœ¨synchronizedä¸Šï¼Œç­‰å¾…ç€è·å–é”ã€‚</p>
<p>åœ¨Java 5ä¸­ï¼ŒåŒæ­¥å™¨æä¾›äº†acquireInterruptibly(int arg)æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ç­‰å¾…è·å–åŒæ­¥çŠ¶æ€æ—¶ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œä¼šç«‹åˆ»è¿”å›ï¼Œå¹¶æŠ›å‡ºInterruptedExceptionã€‚</p>
<p>è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€è¿‡ç¨‹å¯ä»¥è¢«è§†ä½œå“åº”ä¸­æ–­è·å–åŒæ­¥çŠ¶æ€è¿‡ç¨‹çš„â€œå¢å¼ºç‰ˆâ€ï¼ŒdoAcquireNanos(int arg,long nanosTimeout)æ–¹æ³•åœ¨æ”¯æŒå“åº”ä¸­æ–­çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†è¶…æ—¶è·å–çš„ç‰¹æ€§ã€‚</p>
<p>è¯¥æ–¹æ³•åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œå½“èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹æ—¶å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™ä»è¯¥æ–¹æ³•è¿”å›ï¼Œè¿™ä¸ªè¿‡ç¨‹å’Œç‹¬å å¼åŒæ­¥è·å–çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œä½†æ˜¯åœ¨åŒæ­¥çŠ¶æ€è·å–å¤±è´¥çš„å¤„ç†ä¸Šæœ‰æ‰€ä¸åŒã€‚</p>
<p>å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼ˆnanosTimeoutå°äºç­‰äº0è¡¨ç¤ºå·²ç»è¶…æ—¶ï¼‰ï¼Œå¦‚æœæ²¡æœ‰è¶…æ—¶ï¼Œé‡æ–°è®¡ç®—è¶…æ—¶é—´éš”nanosTimeoutï¼Œç„¶åä½¿å½“å‰çº¿ç¨‹ç­‰å¾… nanosTimeout çº³ç§’ï¼ˆå½“å·²åˆ°è®¾ç½®çš„è¶…æ—¶æ—¶é—´ï¼Œè¯¥çº¿ç¨‹ä¼šä»LockSupport.parkNanos(Object<br>blocker,long nanos)æ–¹æ³•è¿”å›ï¼‰ã€‚</p>
<p><strong>æ€»ç»“ï¼š</strong><br>ç‹¬å å¼è¶…æ—¶è·å–åŒæ­¥çŠ¶æ€doAcquireNanos(int arg,long nanosTimeout)å’Œç‹¬å å¼è·å–åŒæ­¥çŠ¶æ€acquire(int args)åœ¨æµç¨‹ä¸Šéå¸¸ç›¸ä¼¼ï¼Œå…¶ä¸»è¦åŒºåˆ«åœ¨äºæœªè·å–åˆ°åŒæ­¥çŠ¶æ€æ—¶çš„å¤„ç†é€»è¾‘ï¼š<br>1ã€acquire(int args)åœ¨æœªè·å–åˆ°åŒæ­¥çŠ¶æ€æ—¶ï¼Œå°†ä¼šä½¿å½“å‰çº¿ç¨‹ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€<br>2ã€doAcquireNanos(int arg,long nanosTimeout)ä¼šä½¿å½“å‰çº¿ç¨‹ç­‰å¾…nanosTimeoutçº³ç§’ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨nanosTimeoutçº³ç§’å†…æ²¡æœ‰è·å–åˆ°åŒæ­¥çŠ¶æ€ï¼Œå°†ä¼šä»ç­‰å¾…é€»è¾‘ä¸­è‡ªåŠ¨è¿”å›ã€‚</p>
<h5 id="äº”ã€è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock"><a href="#äº”ã€è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock" class="headerlink" title="äº”ã€è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock"></a>äº”ã€è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶â€”â€”TwinsLock</h5><p>è®¾è®¡ä¸€ä¸ªåŒæ­¥å·¥å…·ï¼šè¯¥å·¥å…·åœ¨åŒä¸€æ—¶åˆ»ï¼Œåªå…è®¸è‡³å¤šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œè¶…è¿‡ä¸¤ä¸ªçº¿ç¨‹çš„è®¿é—®å°†è¢«é˜»å¡ã€‚</p>
<p>TwinsLockåœ¨åŒä¸€æ—¶åˆ»å…è®¸è‡³å¤šä¸¤ä¸ªçº¿ç¨‹çš„åŒæ—¶è®¿é—®ï¼Œè¡¨æ˜åŒæ­¥èµ„æºæ•°ä¸º2ï¼Œè¿™æ ·å¯ä»¥è®¾ç½®åˆå§‹çŠ¶æ€statusä¸º2ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè·å–ï¼Œstatuså‡1ï¼Œè¯¥çº¿ç¨‹é‡Šæ”¾ï¼Œåˆ™statusåŠ 1ï¼ŒçŠ¶æ€çš„åˆæ³•èŒƒå›´ä¸º0ã€1å’Œ2ï¼Œå…¶ä¸­0è¡¨ç¤ºå½“å‰å·²ç»æœ‰ä¸¤ä¸ªçº¿ç¨‹è·å–äº†åŒæ­¥èµ„æºï¼Œæ­¤æ—¶å†æœ‰å…¶ä»–çº¿ç¨‹å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œè·å–ï¼Œè¯¥çº¿ç¨‹åªèƒ½è¢«é˜»å¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public class TwinsLock implements Lock &#123;</span><br><span class="line">    private final Sync sync = new Sync(2);</span><br><span class="line"></span><br><span class="line">    private static final class Sync extends AbstractQueuedSynchronizer &#123;</span><br><span class="line">        Sync(int count) &#123;</span><br><span class="line">            if (count &lt;= 0) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;count must large than zero.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            // åœ¨æœ¬æ–¹æ³•ä¸­ï¼Œç”¨çŠ¶æ€å»ä»£æŒ‡èµ„æºæ•°ç›®</span><br><span class="line">            setState(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int tryAcquireShared(int reduceCount) &#123;</span><br><span class="line">            for (; ; ) &#123;</span><br><span class="line">                int current = getState();</span><br><span class="line">                int newCount = current - reduceCount;</span><br><span class="line">                if (newCount &lt; 0 || compareAndSetState(current,newCount)) &#123;</span><br><span class="line">                	// è¿”å›å½“å‰å‰©ä½™èµ„æº</span><br><span class="line">                    return newCount;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public boolean tryReleaseShared(int returnCount) &#123;</span><br><span class="line">            for (; ; ) &#123;</span><br><span class="line">                int current = getState();</span><br><span class="line">                // å½“å‰æ•°ç›® + é‡Šæ”¾æ•°ç›®</span><br><span class="line">                int newCount = current + returnCount;</span><br><span class="line">                if (compareAndSetState(current, newCount)) &#123;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void lock() &#123;</span><br><span class="line">    	// è·å–å…±äº«é”ï¼Œstate + 1</span><br><span class="line">    	// ä½¿ç”¨çš„æ˜¯nodeèŠ‚ç‚¹çš„æ–¹æ³•</span><br><span class="line">        sync.acquireShared(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	// é‡Šæ”¾å…±äº«é” -1</span><br><span class="line">    public void unlock() &#123;</span><br><span class="line">        sync.releaseShared(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // å…¶ä»–æ¥å£æ–¹æ³•ç•¥</span><br><span class="line">    @Override</span><br><span class="line">    public void lockInterruptibly() throws InterruptedException &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean tryLock() &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean tryLock(long time, @NotNull TimeUnit unit) throws InterruptedException &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    @NotNull</span><br><span class="line">    @Override</span><br><span class="line">    public Condition newCondition() &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¥éª¤ï¼š<br>1ã€TwinsLockå®ç°Lockæ¥å£ï¼Œæä¾›é¢å‘ä½¿ç”¨è€…çš„æ¥å£ï¼Œä½¿ç”¨è€…è°ƒç”¨lock()<br>æ–¹æ³•è·å–é”ï¼Œéšåè°ƒç”¨unlock()æ–¹æ³•é‡Šæ”¾é”ï¼Œè€ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å–åˆ°é”ã€‚<br>2ã€è‡ªå®šä¹‰åŒæ­¥å™¨Syncä½œä¸ºé™æ€å†…éƒ¨ç±»ï¼Œè¯¥åŒæ­¥å™¨é¢å‘çº¿ç¨‹è®¿é—®å’ŒåŒæ­¥çŠ¶æ€æ§åˆ¶ã€‚å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ã€‚<br>3ã€é‡å†™tryAcquireShared(int reduceCount)ç­‰æ–¹æ³•ï¼Œå†…éƒ¨ç”¨è¿‡CASç¡®ä¿çŠ¶æ€çš„æ­£ç¡®è®¾ç½®ã€‚acquireSharedæ–¹æ³•é‡Œæ˜¯åˆ¤æ–­tryAcquireSharedæ–¹æ³•è¿”å›å€¼å¤§äºç­‰äº0æ—¶ï¼Œå½“å‰çº¿ç¨‹æ‰è·å–åŒæ­¥çŠ¶æ€ã€‚</p>
<p>æ€»ç»“ï¼š<br>1ã€acquireSharedæ–¹æ³•é‡Œè¾“å…¥çš„intï¼Œéƒ½æ˜¯1å‘¢ã€‚å•¥æ„æ€ï¼Ÿ<br>2ã€åŒæ­¥å™¨ä½œä¸ºä¸€ä¸ªæ¡¥æ¢ï¼Œè¿æ¥çº¿ç¨‹è®¿é—®ä»¥åŠåŒæ­¥çŠ¶æ€æ§åˆ¶ç­‰åº•å±‚æŠ€æœ¯ä¸ä¸åŒå¹¶å‘ç»„ä»¶ï¼ˆæ¯”å¦‚Lockã€CountDownLatchç­‰ï¼‰çš„æ¥å£è¯­ä¹‰ã€‚</p>
<p>æµ‹è¯•ç±»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package com.test;</span><br><span class="line"></span><br><span class="line">import org.junit.jupiter.api.Test;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line">public class TwinsLockTest &#123;</span><br><span class="line">    @Test</span><br><span class="line">    public void test() throws InterruptedException &#123;</span><br><span class="line">        final Lock lock = new TwinsLock();</span><br><span class="line">        class Worker extends Thread &#123;</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                while (true) &#123;</span><br><span class="line">                    lock.lock();</span><br><span class="line">                    try &#123;</span><br><span class="line">                        Thread.sleep(1000);</span><br><span class="line">                        System.out.println(Thread.currentThread().getName());</span><br><span class="line">                        Thread.sleep(1000);</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        throw new RuntimeException(e);</span><br><span class="line">                    &#125; finally &#123;</span><br><span class="line">                        lock.unlock();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // å¯åŠ¨10ä¸ªçº¿ç¨‹</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            Worker w = new Worker();</span><br><span class="line">            w.setDaemon(true);</span><br><span class="line">            w.start();</span><br><span class="line">        &#125;</span><br><span class="line">        // æ¯éš”1ç§’æ¢è¡Œ</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹åç§°æˆå¯¹è¾“å‡ºï¼Œåœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸¤ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°é”ã€‚</p>
<p>åŸä¹¦ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46949627/article/details/127078972">https://blog.csdn.net/weixin_46949627/article/details/127078972</a><br><a target="_blank" rel="noopener" href="http://t.zoukankan.com/liukaifeng-p-10052596.html">http://t.zoukankan.com/liukaifeng-p-10052596.html</a><br>Lockå’ŒsychronizedåŒºåˆ«ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41010294/article/details/123528508">https://blog.csdn.net/weixin_41010294/article/details/123528508</a></p>
<h3 id="3-é‡å…¥é”"><a href="#3-é‡å…¥é”" class="headerlink" title="3.é‡å…¥é”"></a>3.é‡å…¥é”</h3><p>é‡å…¥é”ReentrantLockï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ”¯æŒé‡è¿›å…¥çš„é”ï¼Œå®ƒè¡¨ç¤ºè¯¥é”èƒ½å¤Ÿæ”¯æŒä¸€ä¸ªçº¿ç¨‹å¯¹èµ„æºçš„é‡å¤åŠ é”ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥é”çš„è¿˜æ”¯æŒè·å–é”æ—¶çš„å…¬å¹³å’Œéå…¬å¹³æ€§é€‰æ‹©ã€‚</p>
<p>ä¸Šä¸€èŠ‚çš„ç‹¬å é”ç¤ºä¾‹ä¸­ï¼Œè°ƒç”¨Mutexçš„lock()æ–¹æ³•è·å–é”ä¹‹åï¼Œå¦‚æœå†æ¬¡è°ƒç”¨lock()æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹å°†ä¼šè¢«è‡ªå·±æ‰€é˜»å¡ï¼ŒåŸå› æ˜¯Mutexåœ¨å®ç°tryAcquire(int acquires)æ–¹æ³•æ—¶æ²¡æœ‰è€ƒè™‘å æœ‰é”çš„çº¿ç¨‹å†æ¬¡è·å–é”çš„åœºæ™¯ï¼Œè€Œåœ¨è°ƒç”¨tryAcquire(int acquires)æ–¹æ³•æ—¶è¿”å›äº†falseï¼Œå¯¼è‡´è¯¥çº¿ç¨‹è¢«é˜»å¡ã€‚</p>
<p>æ‰€ä»¥è¯´ï¼ŒMutexæ˜¯ä¸€ä¸ªä¸æ”¯æŒé‡è¿›å…¥çš„é”ã€‚è€Œsynchronizedå…³é”®å­—éšå¼çš„æ”¯æŒé‡è¿›å…¥ï¼Œæ¯”å¦‚ä¸€ä¸ªsynchronizedä¿®é¥°çš„é€’å½’æ–¹æ³•ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œæ‰§è¡Œçº¿ç¨‹åœ¨è·å–äº†é”ä¹‹åä»èƒ½è¿ç»­å¤šæ¬¡åœ°è·å¾—è¯¥é”ï¼Œè€Œä¸åƒMutexç”±äºè·å–äº†é”ï¼Œè€Œåœ¨ä¸‹ä¸€æ¬¡è·å–é”æ—¶å‡ºç°é˜»å¡è‡ªå·±çš„æƒ…å†µã€‚</p>
<p>é‡å…¥é”ï¼šåœ¨è°ƒç”¨lock()æ–¹æ³•æ—¶ï¼Œå·²ç»è·å–åˆ°é”çš„çº¿ç¨‹ï¼Œèƒ½å¤Ÿå†æ¬¡è°ƒç”¨lock()æ–¹æ³•è·å–é”è€Œä¸è¢«é˜»å¡ã€‚</p>
<p>å…¬å¹³çš„è·å–é”ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹æœ€ä¼˜å…ˆè·å–é”ï¼Œä¹Ÿå¯ä»¥è¯´é”è·å–æ˜¯é¡ºåºçš„ã€‚ReentrantLockæä¾›äº†ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œèƒ½å¤Ÿæ§åˆ¶é”æ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚</p>
<h4 id="âœ…å®ç°é‡è¿›å…¥"><a href="#âœ…å®ç°é‡è¿›å…¥" class="headerlink" title="âœ…å®ç°é‡è¿›å…¥"></a>âœ…å®ç°é‡è¿›å…¥</h4><p>é‡è¿›å…¥æ˜¯æŒ‡ä»»æ„çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é”æ‰€é˜»å¡ï¼Œè¯¥ç‰¹æ€§çš„å®ç°éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚</p>
<p>1ã€çº¿ç¨‹å†æ¬¡è·å–é”ã€‚é”éœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰å æ®é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚</p>
<p>2ã€é”çš„æœ€ç»ˆé‡Šæ”¾ã€‚çº¿ç¨‹é‡å¤næ¬¡è·å–äº†é”ï¼Œéšååœ¨ç¬¬næ¬¡é‡Šæ”¾è¯¥é”åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¯¥é”ã€‚é”çš„æœ€ç»ˆé‡Šæ”¾è¦æ±‚é”å¯¹äºè·å–è¿›è¡Œè®¡æ•°è‡ªå¢ï¼Œè®¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œè®¡æ•°è‡ªå‡ï¼Œå½“è®¡æ•°ç­‰äº0æ—¶è¡¨ç¤ºé”å·²ç»æˆåŠŸé‡Šæ”¾ã€‚</p>
<p>éå…¬å¹³é”è·å–çš„å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// éå…¬å¹³é”è·å–</span><br><span class="line">final boolean nonfairTryAcquire(int acquires) &#123;</span><br><span class="line">    // å½“å‰çº¿ç¨‹</span><br><span class="line">    final Thread current = Thread.currentThread();</span><br><span class="line">    // è·å–é”çŠ¶æ€</span><br><span class="line">    int c = getState();</span><br><span class="line">    // 0 ä»£è¡¨æ— é”</span><br><span class="line">    if (c == 0) &#123;</span><br><span class="line">        // è®¾ç½®çŠ¶æ€</span><br><span class="line">        if (compareAndSetState(0, acquires)) &#123;</span><br><span class="line">            // è®¾ç½®ç‹¬äº«é”çš„æ‹¥æœ‰è€…</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    // å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç‹¬æœ‰çº¿ç¨‹çš„çº¿ç¨‹ID</span><br><span class="line">    &#125; else if (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        // æ˜¯åˆ™å¢åŠ æ¬¡æ•°</span><br><span class="line">        int nextc = c + acquires;</span><br><span class="line">        if (nextc &lt; 0)</span><br><span class="line">            throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">        //è®¾ç½®</span><br><span class="line">        setState(nextc);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè·å–é”çš„çº¿ç¨‹æ¥å†³å®šè·å–æ“ä½œæ˜¯å¦æˆåŠŸï¼Œå¦‚æœæ˜¯è·å–é”çš„çº¿ç¨‹å†æ¬¡è¯·æ±‚ï¼Œåˆ™å°†åŒæ­¥çŠ¶æ€å€¼è¿›è¡Œå¢åŠ å¹¶è¿”å›trueï¼Œè¡¨ç¤ºè·å–åŒæ­¥çŠ¶æ€æˆåŠŸã€‚æˆåŠŸè·å–é”çš„çº¿ç¨‹å†æ¬¡è·å–é”ï¼Œåªæ˜¯å¢åŠ äº†åŒæ­¥çŠ¶æ€å€¼.</p>
<p>éå…¬å¹³é”é‡Šæ”¾çš„å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryRelease(int releases) &#123;</span><br><span class="line">    // å‡å»é‡Šæ”¾çš„å€¼</span><br><span class="line">    int c = getState() - releases;</span><br><span class="line">    // å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æ‹¥æœ‰è€…</span><br><span class="line">    if (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        throw new IllegalMonitorStateException();</span><br><span class="line">    // æ˜¯å¦å®Œå…¨é‡Šæ”¾</span><br><span class="line">    boolean free = false;</span><br><span class="line">    // å¦‚æœæ˜¯ 0 åˆ™å®Œå…¨é‡Šæ”¾</span><br><span class="line">    if (c == 0) &#123;</span><br><span class="line">        free = true;</span><br><span class="line">        // æŠ¹å»æ‹¥æœ‰è€…</span><br><span class="line">        setExclusiveOwnerThread(null);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    return free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¯¥é”è¢«è·å–äº†næ¬¡ï¼Œé‚£ä¹ˆå‰(n-1)æ¬¡tryRelease(int releases)æ–¹æ³•å¿…é¡»è¿”å›falseï¼Œè€Œåªæœ‰åŒæ­¥çŠ¶æ€å®Œå…¨é‡Šæ”¾äº†ï¼Œæ‰èƒ½è¿”å›trueã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•å°†åŒæ­¥çŠ¶æ€æ˜¯å¦ä¸º0ä½œä¸ºæœ€ç»ˆé‡Šæ”¾çš„æ¡ä»¶ï¼Œå½“åŒæ­¥çŠ¶æ€ä¸º0æ—¶ï¼Œå°†å æœ‰çº¿ç¨‹è®¾ç½®ä¸ºnullï¼Œå¹¶è¿”å›trueï¼Œè¡¨ç¤ºé‡Šæ”¾æˆåŠŸã€‚</p>
<h4 id="âœ…å…¬å¹³ä¸éå…¬å¹³è·å–é”çš„åŒºåˆ«"><a href="#âœ…å…¬å¹³ä¸éå…¬å¹³è·å–é”çš„åŒºåˆ«" class="headerlink" title="âœ…å…¬å¹³ä¸éå…¬å¹³è·å–é”çš„åŒºåˆ«"></a>âœ…å…¬å¹³ä¸éå…¬å¹³è·å–é”çš„åŒºåˆ«</h4><p>å…¬å¹³æ€§ä¸å¦æ˜¯é’ˆå¯¹è·å–é”è€Œè¨€çš„ï¼Œå¦‚æœä¸€ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œé‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚çš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œä¹Ÿå°±æ˜¯FIFOã€‚</p>
<p>å¯¹äºéå…¬å¹³é”ï¼Œåªè¦CASè®¾ç½®åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œå…¬å¹³é”åˆ™ä¸åŒã€‚åˆ¤æ–­æ¡ä»¶å¤šäº†hasQueuedPredecessors()æ–¹æ³•ï¼Œå³åŠ å…¥äº†åŒæ­¥é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›trueï¼Œåˆ™è¡¨ç¤ºæœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ›´æ—©åœ°è¯·æ±‚è·å–é”ï¼Œå› æ­¤éœ€è¦ç­‰å¾…å‰é©±çº¿ç¨‹è·å–å¹¶é‡Šæ”¾é”ä¹‹åæ‰èƒ½ç»§ç»­è·å–é”ã€‚<br>ã€å› æ­¤ï¼Œä¸Šé¢çš„ç‹¬å é”å’Œå…±äº«é”ä¹Ÿéƒ½æ˜¯å…¬å¹³çš„ã€‘</p>
<p>æµ‹è¯•å…¬å¹³å’Œéå…¬å¹³é”åœ¨è·å–é”æ—¶çš„åŒºåˆ«ï¼Œäº”ä¸ªçº¿ç¨‹å¾ªç¯è·å–é”ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import org.junit.Test;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.concurrent.locks.Lock;</span><br><span class="line">import java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line">public class FairAndUnfairTest &#123;</span><br><span class="line">    private static Lock fairLock = new ReentrantLock2(true);</span><br><span class="line">    private static Lock unfairLock = new ReentrantLock2(false);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void fair() &#123;</span><br><span class="line">        testLock(fairLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void unfair() &#123;</span><br><span class="line">        testLock(unfairLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void testLock(Lock lock)&#123;</span><br><span class="line">        // å¯åŠ¨5ä¸ªJob</span><br><span class="line">        for(int i = 0; i &lt; 5;i++)&#123;</span><br><span class="line">            new Job(lock).start();</span><br><span class="line">        &#125;</span><br><span class="line">        while (true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class Job extends Thread &#123;</span><br><span class="line">        private Lock lock;</span><br><span class="line"></span><br><span class="line">        public Job(Lock lock) &#123;</span><br><span class="line">            this.lock = lock;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                // è¿ç»­2æ¬¡æ‰“å°å½“å‰çš„Threadå’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„Thread</span><br><span class="line">                lock.lock();</span><br><span class="line">                ReentrantLock2 reentrantLock2 = (ReentrantLock2) lock;</span><br><span class="line">                System.out.println(&quot;Fair:&quot; + reentrantLock2.isFair() + &quot;,Lock By ã€&quot; + Thread.currentThread().getName() + &quot;ã€‘ï¼Œwaitting by  &quot; + reentrantLock2.getQueuedThreads().toString());</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    throw new RuntimeException(e);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class ReentrantLock2 extends ReentrantLock &#123;</span><br><span class="line">        public ReentrantLock2(boolean fair) &#123;</span><br><span class="line">            super(fair);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Collection&lt;Thread&gt; getQueuedThreads() &#123;</span><br><span class="line">            List&lt;Thread&gt; arrayList = new ArrayList&lt;Thread&gt;(super.getQueuedThreads());</span><br><span class="line">            Collections.reverse(arrayList);</span><br><span class="line">            return arrayList;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1ã€å…¬å¹³æ€§é”æ¯æ¬¡éƒ½æ˜¯ä»åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è·å–åˆ°é”ï¼Œè€Œéå…¬å¹³æ€§é”å‡ºç°äº†ä¸€ä¸ªçº¿ç¨‹è¿ç»­è·å–é”çš„æƒ…å†µã€‚ï¼ˆåˆšé‡Šæ”¾é”çš„çº¿ç¨‹å†æ¬¡è·å–åŒæ­¥çŠ¶æ€çš„å‡ ç‡ä¼šéå¸¸å¤§ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹åªèƒ½åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ï¼‰</p>
<p>2ã€å…¬å¹³æ€§é”ä¿è¯äº†é”çš„è·å–æŒ‰ç…§FIFOåŸåˆ™ï¼Œè€Œä»£ä»·æ˜¯è¿›è¡Œå¤§é‡çš„çº¿ç¨‹åˆ‡æ¢ã€‚éå…¬å¹³é”è™½ç„¶å¯èƒ½é€ æˆçº¿ç¨‹é¥¥é¥¿ï¼Œä½†æ˜¯æå°‘çš„çº¿ç¨‹åˆ‡æ¢ï¼Œä¿è¯äº†å…¶æ›´å¤§çš„ååé‡ã€‚</p>
<h3 id="4-è¯»å†™é”"><a href="#4-è¯»å†™é”" class="headerlink" title="4.è¯»å†™é”"></a>4.è¯»å†™é”</h3><p>ä¹‹å‰æåˆ°é”ï¼ˆå¦‚Mutexå’ŒReentrantLockï¼‰åŸºæœ¬éƒ½æ˜¯æ’ä»–é”ï¼Œè¿™äº›é”åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œè®¿é—®ï¼Œè€Œè¯»å†™é”åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥å…è®¸å¤šä¸ªè¯»çº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯åœ¨å†™çº¿ç¨‹è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„è¯»çº¿ç¨‹å’Œå…¶ä»–å†™çº¿ç¨‹å‡è¢«é˜»å¡ã€‚è¯»å†™é”ç»´æŠ¤äº†ä¸€å¯¹é”ï¼Œä¸€ä¸ªè¯»é”å’Œä¸€ä¸ªå†™é”ï¼Œé€šè¿‡åˆ†ç¦»è¯»é”å’Œå†™é”ï¼Œä½¿å¾—å¹¶å‘æ€§ç›¸æ¯”ä¸€èˆ¬çš„æ’ä»–é”æœ‰äº†å¾ˆå¤§æå‡ï¼Œæä¾›å†™æ“ä½œå¯¹è¯»æ“ä½œçš„å¯è§æ€§ä»¥åŠå¹¶å‘æ€§çš„æå‡ã€‚</p>
<p>é€‚ç”¨åœºæ™¯ï¼šåœ¨ç¨‹åºä¸­å®šä¹‰ä¸€ä¸ªå…±äº«çš„ç”¨ä½œç¼“å­˜æ•°æ®ç»“æ„ï¼Œå®ƒå¤§éƒ¨åˆ†æ—¶é—´æä¾›è¯»æœåŠ¡ï¼ˆä¾‹å¦‚æŸ¥è¯¢å’Œæœç´¢ï¼‰ï¼Œè€Œå†™æ“ä½œå æœ‰çš„æ—¶é—´å¾ˆå°‘ï¼Œä½†æ˜¯å†™æ“ä½œå®Œæˆä¹‹åçš„æ›´æ–°éœ€è¦å¯¹åç»­çš„è¯»æœåŠ¡å¯è§ã€‚</p>
<p>åœ¨æ²¡æœ‰è¯»å†™é”æ”¯æŒçš„ï¼ˆJava 5ä¹‹å‰ï¼‰æ—¶å€™ï¼Œå¦‚æœéœ€è¦å®Œæˆä¸Šè¿°å·¥ä½œå°±è¦ä½¿ç”¨Javaçš„ç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå°±æ˜¯å½“å†™æ“ä½œå¼€å§‹æ—¶ï¼Œæ‰€æœ‰æ™šäºå†™æ“ä½œçš„è¯»æ“ä½œå‡ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåªæœ‰å†™æ“ä½œå®Œæˆå¹¶è¿›è¡Œé€šçŸ¥ä¹‹åï¼Œæ‰€æœ‰ç­‰å¾…çš„è¯»æ“ä½œæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼ˆå†™æ“ä½œä¹‹é—´ä¾é synchronizedå…³é”®è¿›è¡ŒåŒæ­¥ï¼‰ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä½¿è¯»æ“ä½œèƒ½è¯»å–åˆ°æ­£ç¡®çš„æ•°æ®ï¼Œä¸ä¼šå‡ºç°è„è¯»ã€‚</p>
<h4 id="âœ…è¯»å†™é”çš„æ¥å£å’Œç¤ºä¾‹"><a href="#âœ…è¯»å†™é”çš„æ¥å£å’Œç¤ºä¾‹" class="headerlink" title="âœ…è¯»å†™é”çš„æ¥å£å’Œç¤ºä¾‹"></a>âœ…è¯»å†™é”çš„æ¥å£å’Œç¤ºä¾‹</h4><p>ReadWriteLockä»…å®šä¹‰äº†è·å–è¯»é”å’Œå†™é”çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå³readLock()æ–¹æ³•å’ŒwriteLock()æ–¹æ³•ï¼Œè€Œå…¶å®ç°â€”â€”ReentrantReadWriteLockï¼Œé™¤äº†æ¥å£æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜æä¾›äº†ä¸€äº›ä¾¿äºå¤–ç•Œç›‘æ§å…¶å†…éƒ¨å·¥ä½œçŠ¶æ€çš„æ–¹æ³•ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class Cache &#123;</span><br><span class="line">    static Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span><br><span class="line">    static ReentrantReadWriteLock rwl = new ReentrantReadWriteLock();</span><br><span class="line">    static Lock r = rwl.readLock();</span><br><span class="line">    static Lock w = rwl.writeLock();</span><br><span class="line"></span><br><span class="line">    // è·å–ä¸€ä¸ªkeyå¯¹åº”çš„value</span><br><span class="line">    public static final Object get(String key) &#123;</span><br><span class="line">        r.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            return map.get(key);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // è®¾ç½®keyå¯¹åº”çš„valueï¼Œå¹¶è¿”å›æ—§çš„value</span><br><span class="line">    public static final Object put(String key, Object value) &#123;</span><br><span class="line">        w.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            return map.put(key, value);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ¸…ç©ºæ‰€æœ‰çš„å†…å®¹</span><br><span class="line">    public static final void clear() &#123;</span><br><span class="line">        w.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            map.clear();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„HashMapä½œä¸ºç¼“å­˜,ä½¿ç”¨è¯»å†™é”çš„è¯»é”å’Œå†™é”æ¥ä¿è¯Cacheæ˜¯çº¿ç¨‹å®‰å…¨çš„.Cacheä½¿ç”¨è¯»å†™é”æå‡è¯»æ“ä½œçš„å¹¶å‘æ€§ï¼Œä¹Ÿä¿è¯æ¯æ¬¡å†™æ“ä½œå¯¹æ‰€æœ‰çš„è¯»å†™æ“ä½œçš„å¯è§æ€§ï¼ŒåŒæ—¶ç®€åŒ–äº†ç¼–ç¨‹æ–¹å¼ã€‚</p>
<h4 id="âœ…è¯»å†™é”çš„å®ç°åˆ†æ"><a href="#âœ…è¯»å†™é”çš„å®ç°åˆ†æ" class="headerlink" title="âœ…è¯»å†™é”çš„å®ç°åˆ†æ"></a>âœ…è¯»å†™é”çš„å®ç°åˆ†æ</h4><h5 id="ä¸€ã€è¯»å†™çŠ¶æ€çš„è®¾è®¡"><a href="#ä¸€ã€è¯»å†™çŠ¶æ€çš„è®¾è®¡" class="headerlink" title="ä¸€ã€è¯»å†™çŠ¶æ€çš„è®¾è®¡"></a>ä¸€ã€è¯»å†™çŠ¶æ€çš„è®¾è®¡</h5><p>è¯»å†™é”åŒæ ·ä¾èµ–è‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°åŒæ­¥åŠŸèƒ½ï¼Œè€Œè¯»å†™çŠ¶æ€å°±æ˜¯å…¶åŒæ­¥å™¨çš„åŒæ­¥çŠ¶æ€ã€‚</p>
<p>å›æƒ³ReentrantLockä¸­è‡ªå®šä¹‰åŒæ­¥å™¨çš„å®ç°ï¼ŒåŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œè¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€ï¼ˆä¸€ä¸ªæ•´å‹å˜é‡ï¼‰ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœåœ¨ä¸€ä¸ªæ•´å‹å˜é‡ä¸Šç»´æŠ¤å¤šç§çŠ¶æ€ï¼Œå°±ä¸€å®šéœ€è¦ â€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€ è¿™ä¸ªå˜é‡ï¼Œè¯»å†™é”å°†å˜é‡åˆ‡åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œé«˜16ä½è¡¨ç¤ºè¯»ï¼Œä½16ä½è¡¨ç¤ºå†™ã€‚</p>
<p>é€šè¿‡ä½è¿ç®—å¯ä»¥è¿…é€Ÿç¡®å®šè¯»å’Œå†™å„è‡ªçš„çŠ¶æ€ï¼Œå‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸º S ï¼Œå†™çŠ¶æ€ç­‰äº S&amp;0x0000FFFF ï¼ˆå°†é«˜16ä½å…¨éƒ¨æŠ¹å»ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äºS&gt;&gt;&gt;16ï¼ˆæ— ç¬¦å·è¡¥0å³ç§»16ä½ï¼‰ã€‚å½“å†™çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+1ï¼Œå½“è¯»çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+(1&lt;&lt;16)ï¼Œä¹Ÿå°±æ˜¯S+0x00010000ã€‚</p>
<h5 id="äºŒã€å†™é”çš„è·å–ä¸é‡Šæ”¾"><a href="#äºŒã€å†™é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="äºŒã€å†™é”çš„è·å–ä¸é‡Šæ”¾"></a>äºŒã€å†™é”çš„è·å–ä¸é‡Šæ”¾</h5><p>å†™é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„æ’å®ƒé”ã€‚å¦‚æœå½“å‰çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å¢åŠ å†™çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹åœ¨è·å–å†™é”æ—¶ï¼Œè¯»é”å·²ç»è¢«è·å–ï¼ˆè¯»çŠ¶æ€ä¸ä¸º0ï¼‰æˆ–è€…è¯¥çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protected final boolean tryAcquire(int acquires) &#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    // é”çŠ¶æ€</span><br><span class="line">    int c = getState();</span><br><span class="line">    // é€šè¿‡çŠ¶æ€è®¡ç®—å†™é”æ•°é‡</span><br><span class="line">    int w = exclusiveCount(c);</span><br><span class="line">    // é”ä¸ä¸º0ï¼Œè¯´æ˜æœ‰è¯»æˆ–è€…å†™</span><br><span class="line">    if (c != 0) &#123;</span><br><span class="line">        // å†™é”ä¸å­˜åœ¨ï¼ˆè¯´æ˜ç°åœ¨æ˜¯è¯»é”ï¼‰æˆ–è€…å½“å‰è·å–çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹</span><br><span class="line">        if (w == 0 || current != getExclusiveOwnerThread())</span><br><span class="line">            return false;</span><br><span class="line">        // å¦‚æœé‡å…¥æ¬¡æ•°å¤§äºæœ€å¤§å†²å…¥æ•°ç›®</span><br><span class="line">        if (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    // å°è¯•è·å–å†™é”</span><br><span class="line">    // writerShouldBlockï¼šå…¬å¹³é”ä¼šè°ƒç”¨ hasQueuedPredecessorsåˆ¤æ–­è½®å¾—åˆ°è‡ªå·±å—ï¼Œéå…¬å¹³ç›´æ¥è¿”å›falseå»ç«äº‰é”</span><br><span class="line">    //  compareAndSetState å¤±è´¥å°±ä¼šè¿”å›false</span><br><span class="line">    if (writerShouldBlock() || !compareAndSetState(c, c + acquires)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    // è®¾ç½®å½“å‰çº¿ç¨‹æ‹¥æœ‰é”</span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•é™¤äº†é‡å…¥æ¡ä»¶ï¼ˆå½“å‰çº¿ç¨‹ä¸ºè·å–äº†å†™é”çš„çº¿ç¨‹ï¼‰ä¹‹å¤–ï¼Œå¢åŠ äº†ä¸€ä¸ªè¯»é”æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­ã€‚</p>
<p>å¦‚æœå­˜åœ¨è¯»é”ï¼Œåˆ™å†™é”ä¸èƒ½è¢«è·å–ï¼ŒåŸå› åœ¨äºï¼šè¯»å†™é”è¦ç¡®ä¿å†™é”çš„æ“ä½œå¯¹è¯»é”å¯è§ï¼Œå¦‚æœå…è®¸è¯»é”åœ¨å·²è¢«è·å–çš„æƒ…å†µä¸‹å¯¹å†™é”çš„è·å–ï¼Œé‚£ä¹ˆæ­£åœ¨è¿è¡Œçš„å…¶ä»–è¯»çº¿ç¨‹å°±æ— æ³•æ„ŸçŸ¥åˆ°å½“å‰å†™çº¿ç¨‹çš„æ“ä½œã€‚</p>
<p>å†™é”çš„é‡Šæ”¾ä¸ReentrantLockçš„é‡Šæ”¾è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œæ¯æ¬¡é‡Šæ”¾å‡å‡å°‘å†™çŠ¶æ€ï¼Œå½“å†™çŠ¶æ€ä¸º0æ—¶è¡¨ç¤ºå†™é”å·²è¢«é‡Šæ”¾ï¼Œä»è€Œç­‰å¾…çš„è¯»å†™çº¿ç¨‹èƒ½å¤Ÿç»§ç»­è®¿é—®è¯»å†™é”ï¼ŒåŒæ—¶å‰æ¬¡å†™çº¿ç¨‹çš„ä¿®æ”¹å¯¹åç»­è¯»å†™çº¿ç¨‹å¯è§ã€‚</p>
<h5 id="ä¸‰ã€è¯»é”çš„è·å–ä¸é‡Šæ”¾"><a href="#ä¸‰ã€è¯»é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="ä¸‰ã€è¯»é”çš„è·å–ä¸é‡Šæ”¾"></a>ä¸‰ã€è¯»é”çš„è·å–ä¸é‡Šæ”¾</h5><p>è¯»é”æ˜¯ä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„å…±äº«é”ï¼Œå®ƒèƒ½å¤Ÿè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–ï¼Œåœ¨ æ²¡æœ‰å…¶ä»–å†™çº¿ç¨‹è®¿é—®ï¼ˆæˆ–è€…å†™çŠ¶æ€ä¸º0ï¼‰ æ—¶ï¼Œè¯»é”æ€»ä¼šè¢«æˆåŠŸåœ°è·å–ï¼Œè€Œæ‰€åšçš„ä¹Ÿåªæ˜¯ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰å¢åŠ è¯»çŠ¶æ€ã€‚</p>
<p>è·å–è¯»é”çš„å®ç°ä»Java 5åˆ°Java 6å˜å¾—å¤æ‚è®¸å¤šï¼Œä¸»è¦åŸå› æ˜¯æ–°å¢äº†ä¸€äº›åŠŸèƒ½ï¼Œä¾‹å¦‚getReadHoldCount() æ–¹æ³•ï¼Œä½œç”¨æ˜¯è¿”å›å½“å‰çº¿ç¨‹è·å–è¯»é”çš„æ¬¡æ•°ã€‚ç”±äºè¯»çŠ¶æ€æ˜¯ æ‰€æœ‰çº¿ç¨‹è·å–è¯»é”æ¬¡æ•°çš„æ€»å’Œ ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹ å„è‡ªè·å–è¯»é”çš„æ¬¡æ•°åªèƒ½é€‰æ‹©ä¿å­˜åœ¨ThreadLocalä¸­ ï¼Œç”±çº¿ç¨‹è‡ªèº«ç»´æŠ¤ï¼Œäºæ˜¯ä½¿è·å–è¯»é”çš„å®ç°å˜å¾—å¤æ‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protected final int tryAcquireShared(int unused) &#123;</span><br><span class="line">    for (; ; ) &#123;</span><br><span class="line">        // è·å–é”çŠ¶æ€</span><br><span class="line">        int c = getState();</span><br><span class="line">        // è¯»æ•°ç›®+1</span><br><span class="line">        int nextc = c + (1 &lt;&lt; 16);</span><br><span class="line">        // æº¢å‡º</span><br><span class="line">        if (nextc &lt; c)</span><br><span class="line">            throw new Error(&quot;Maximum lock count exceeded&quot;);</span><br><span class="line">        // ç°åœ¨æ˜¯å†™çŠ¶æ€ ä¸” æ‹¥æœ‰è€…ä¸æ˜¯è‡ªå·±</span><br><span class="line">        if (exclusiveCount(c) != 0 &amp;&amp; owner != Thread.currentThread())</span><br><span class="line">            return -1;</span><br><span class="line">        // ä¿®æ”¹çŠ¶æ€</span><br><span class="line">        if (compareAndSetState(c, nextc))</span><br><span class="line">            return 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨tryAcquireShared(int unused)æ–¹æ³•ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–äº†å†™é”æˆ–è€…å†™é”æœªè¢«è·å–ï¼Œåˆ™å½“å‰çº¿ç¨‹ï¼ˆçº¿ç¨‹å®‰å…¨ï¼Œä¾é CASä¿è¯ï¼‰å¢åŠ è¯»çŠ¶æ€ï¼ŒæˆåŠŸè·å–è¯»é”ã€‚</p>
<p>è¯»é”çš„æ¯æ¬¡é‡Šæ”¾ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶é‡Šæ”¾è¯»é”ï¼‰å‡å‡å°‘è¯»çŠ¶æ€ï¼Œå‡å°‘çš„å€¼æ˜¯ï¼ˆ1&lt;&lt;16ï¼‰ã€‚</p>
<h5 id="å››ã€é”é™çº§"><a href="#å››ã€é”é™çº§" class="headerlink" title="å››ã€é”é™çº§"></a>å››ã€é”é™çº§</h5><p>é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§æˆä¸ºè¯»é”ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ‹¥æœ‰å†™é”ï¼Œç„¶åå°†å…¶é‡Šæ”¾ï¼Œæœ€åå†è·å–è¯»é”ï¼Œè¿™ç§åˆ†æ®µå®Œæˆçš„è¿‡ç¨‹ä¸èƒ½ç§°ä¹‹ä¸ºé”é™çº§ã€‚é”é™çº§æ˜¯æŒ‡æŠŠæŒä½ï¼ˆå½“å‰æ‹¥æœ‰çš„ï¼‰å†™é”ï¼Œå†è·å–åˆ°è¯»é”ï¼Œéšåé‡Šæ”¾ï¼ˆå…ˆå‰æ‹¥æœ‰çš„ï¼‰å†™é”çš„è¿‡ç¨‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public void processData() &#123;</span><br><span class="line">		//é”ä½è¯»é”</span><br><span class="line">        readLock.lock();</span><br><span class="line">        // æ•°æ®åœ¨æ›´æ–°å—</span><br><span class="line">        if (!update) &#123;</span><br><span class="line">			// å¿…é¡»å…ˆé‡Šæ”¾è¯»é”</span><br><span class="line">            readLock.unlock();</span><br><span class="line">			// é”é™çº§ä»å†™é”è·å–åˆ°å¼€å§‹</span><br><span class="line">            writeLock.lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                if (!update) &#123;</span><br><span class="line">					// å‡†å¤‡æ•°æ®çš„æµç¨‹ï¼ˆç•¥ï¼‰</span><br><span class="line">                    update = true;</span><br><span class="line">                &#125;</span><br><span class="line">                //å¼€å§‹é™çº§</span><br><span class="line">                readLock.lock();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">            	// é”é™çº§å®Œæˆï¼Œå†™é”é™çº§ä¸ºè¯»é”</span><br><span class="line">                writeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">			// ä½¿ç”¨æ•°æ®çš„æµç¨‹ï¼ˆç•¥ï¼‰</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>é”é™çº§ï¼šå…ˆè·å–å†™é”ï¼Œå˜æ›´æ•°æ®ï¼Œå†è·å–è¯»é”ï¼Œå†é‡Šæ”¾å†™é”ã€‚æ­¤æ—¶è¿˜æœ‰è¯»é”ï¼Œè¿˜å¯ä»¥è¯»æ•°æ®ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿå¯ä»¥è·å–è¯»é”è¯»æ•°æ®ã€‚<br>è¿™æ ·å˜æ›´å®Œæ•°æ®ä¹‹åï¼Œå¯ä»¥å¤šä¸ªè¯»çº¿ç¨‹ä¸€èµ·è¯»å–æ•°æ®ã€‚</p>
<p>ä¸æ”¯æŒé”å‡çº§ï¼šæœ‰çº¿ç¨‹è·å–è¯»é”çš„æ—¶å€™ï¼Œä¸èƒ½è·å–å†™é”ï¼Œæ•°æ®æ›´æ–°å¯¹å…¶ä»–çº¿ç¨‹çš„å¯è§æ€§ã€‚</p>
<h3 id="5-LockSupportå·¥å…·"><a href="#5-LockSupportå·¥å…·" class="headerlink" title="5.LockSupportå·¥å…·"></a>5.LockSupportå·¥å…·</h3><p>é˜Ÿåˆ—åŒæ­¥å™¨ä¸­ï¼Œå½“éœ€è¦é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿ç”¨LockSupportå·¥å…·ç±»æ¥å®Œæˆç›¸åº”å·¥ä½œã€‚LockSupportå®šä¹‰äº†ä¸€ç»„çš„å…¬å…±é™æ€æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æä¾›äº†æœ€åŸºæœ¬çš„çº¿ç¨‹é˜»å¡å’Œå”¤é†’åŠŸèƒ½ï¼Œè€ŒLockSupportä¹Ÿæˆä¸ºæ„å»ºåŒæ­¥ç»„ä»¶çš„åŸºç¡€å·¥å…·ã€‚LockSupportå®šä¹‰äº†ä¸€ç»„ä»¥parkå¼€å¤´çš„æ–¹æ³•ç”¨æ¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä»¥åŠunpark(Thread thread)æ–¹æ³•æ¥å”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„çº¿ç¨‹ã€‚</p>
<p>åœ¨Java 6ä¸­ï¼ŒLockSupportå¢åŠ äº†park(Object blocker)ã€parkNanos(Object blocker,long nanos)å’ŒparkUntil(Object blocker,long deadline)3ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­å‚æ•°blockeræ˜¯ç”¨æ¥æ ‡è¯†å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼ˆä»¥ä¸‹ç§°ä¸ºé˜»å¡å¯¹è±¡ï¼‰ï¼Œè¯¥å¯¹è±¡ä¸»è¦ç”¨äºé—®é¢˜æ’æŸ¥å’Œç³»ç»Ÿç›‘æ§ã€‚</p>
<p>æ¯”å¦‚è¯´ï¼Œçº¿ç¨‹dumpç»“æœç»“æœä¸­ï¼Œæœ‰é˜»å¡å¯¹è±¡çš„parkNanosæ–¹æ³•èƒ½å¤Ÿä¼ é€’ç»™å¼€å‘äººå‘˜é˜»å¡å¯¹è±¡çš„ä¿¡æ¯ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦åŠ é˜»å¡å¯¹è±¡ä¿¡æ¯ï¼Ÿ<br>ç”±äºåœ¨Java 5ä¹‹å‰ï¼Œå½“çº¿ç¨‹é˜»å¡ï¼ˆä½¿ç”¨synchronizedå…³é”®å­—ï¼‰åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šæ—¶ï¼Œé€šè¿‡çº¿ç¨‹dumpèƒ½å¤ŸæŸ¥çœ‹åˆ°è¯¥çº¿ç¨‹çš„é˜»å¡å¯¹è±¡ï¼Œæ–¹ä¾¿é—®é¢˜å®šä½ï¼Œè€ŒJava 5æ¨å‡ºçš„Lockç­‰å¹¶å‘å·¥å…·æ—¶å´é—æ¼äº†è¿™ä¸€ç‚¹ï¼Œè‡´ä½¿åœ¨çº¿ç¨‹dumpæ—¶æ— æ³•æä¾›é˜»å¡å¯¹è±¡çš„ä¿¡æ¯ã€‚å› æ­¤ï¼Œåœ¨Java 6ä¸­ï¼ŒLockSupportæ–°å¢äº†ä¸Šè¿°3ä¸ªå«æœ‰é˜»å¡å¯¹è±¡çš„parkæ–¹æ³•ï¼Œç”¨ä»¥æ›¿ä»£åŸæœ‰çš„parkæ–¹æ³•ã€‚</p>
<h3 id="6-Conditionæ¥å£"><a href="#6-Conditionæ¥å£" class="headerlink" title="6.Conditionæ¥å£"></a>6.Conditionæ¥å£</h3><p>ä»»æ„ä¸€ä¸ªJavaå¯¹è±¡ï¼Œéƒ½æ‹¥æœ‰ä¸€ç»„ç›‘è§†å™¨æ–¹æ³•ï¼ˆå®šä¹‰åœ¨java.lang.Objectä¸Šï¼‰ï¼Œä¸»è¦åŒ…æ‹¬wait()ã€wait(long timeout)ã€notify()ä»¥åŠnotifyAll()æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸synchronizedåŒæ­¥å…³é”®å­—é…åˆï¼Œå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ã€‚</p>
<p>Conditionæ¥å£ä¹Ÿæä¾›äº†ç±»ä¼¼Objectçš„ç›‘è§†å™¨æ–¹æ³•ï¼Œä¸Locké…åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸¤è€…åœ¨ä½¿ç”¨æ–¹å¼ä»¥åŠåŠŸèƒ½ç‰¹æ€§ä¸Šè¿˜æ˜¯æœ‰å·®åˆ«çš„ï¼š<br>1ã€å‰ç½®æ¡ä»¶ä¸ä½†è¦è·å–é”ï¼Œè¿˜è¦è°ƒç”¨<code>Lock.newCondition()</code>è·å–Conditionå¯¹è±¡<br>2ã€ç­‰å¾…é˜Ÿåˆ—æ”¯æŒå¤šä¸ª<br>3ã€æ”¯æŒè¶…æ—¶ç­‰å¾…çŠ¶æ€<br>4ã€æ”¯æŒåœ¨ç­‰å¾…çŠ¶æ€ä¸­ä¸å“åº”ä¸­æ–­ï¼ˆå¯ä»¥å¯¹ä¸­æ–­ä¸æ•æ„Ÿï¼‰</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š<br>synchronized + Objectç›‘è§†å™¨æ–¹æ³• - å®ç°ç­‰å¾…é€šçŸ¥ - æ¡ˆä¾‹çº¿ç¨‹æ± <br>Lock(é˜Ÿåˆ—åŒæ­¥å™¨) + Conditionæ¥å£ - å®ç°ç­‰å¾…é€šçŸ¥ - æ¡ˆä¾‹æœ‰ç•Œé˜Ÿåˆ—<br>å¯ä»¥ç›´æ¥ä½¿ç”¨synchronizedå®ç°åŒæ­¥<br>å¯ä»¥ç›´æ¥ä½¿ç”¨Lockå®ç°é”ï¼Œåªä¸è¿‡åªæœ‰åŒæ­¥é˜Ÿåˆ—ï¼Œé‡Œé¢çº¿ç¨‹æ˜¯é˜»å¡çŠ¶æ€ï¼Œæ²¡æœ‰ç­‰å¾…é˜Ÿåˆ—</p>
<h4 id="âœ…Conditionæ¥å£ä¸ç¤ºä¾‹"><a href="#âœ…Conditionæ¥å£ä¸ç¤ºä¾‹" class="headerlink" title="âœ…Conditionæ¥å£ä¸ç¤ºä¾‹"></a>âœ…Conditionæ¥å£ä¸ç¤ºä¾‹</h4><p>Conditionå®šä¹‰äº†ç­‰å¾…/é€šçŸ¥ä¸¤ç§ç±»å‹çš„æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œéœ€è¦æå‰è·å–åˆ°Conditionå¯¹è±¡å…³è”çš„é”ã€‚</p>
<p>Conditionå¯¹è±¡æ˜¯ç”±Lockå¯¹è±¡ï¼ˆè°ƒç”¨Lockå¯¹è±¡çš„newCondition()æ–¹æ³•ï¼‰åˆ›å»ºå‡ºæ¥çš„ï¼Œæ¢å¥è¯è¯´ï¼ŒConditionæ˜¯ä¾èµ–Lockå¯¹è±¡çš„ã€‚</p>
<p>ç­‰å¾…é€šçŸ¥æ¨¡å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Lock lock = new ReentrantLock();</span><br><span class="line">Condition condition = lock.newCondition();</span><br><span class="line"></span><br><span class="line">public void conditionWait() throws InterruptedException &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        condition.await();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void conditionSignal() throws InterruptedException &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        condition.signal();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†Conditionå¯¹è±¡ä½œä¸ºæˆå‘˜å˜é‡ã€‚é€šè¿‡Lockçš„newCondition()æ–¹æ³•</p>
<p>å½“è°ƒç”¨await()æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹ä¼šé‡Šæ”¾é”å¹¶åœ¨æ­¤ç­‰å¾…ï¼Œè€Œå…¶ä»–çº¿ç¨‹è°ƒç”¨Conditionå¯¹è±¡çš„signal()æ–¹æ³•ï¼Œé€šçŸ¥å½“å‰çº¿ç¨‹åï¼Œå½“å‰çº¿ç¨‹æ‰ä»await()æ–¹æ³•è¿”å›ï¼Œå¹¶ä¸”åœ¨è¿”å›å‰å·²ç»è·å–äº†é”ã€‚</p>
<p>Conditionæ¥å£æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">await() ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·æˆ–è¢«ä¸­æ–­ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¯¹ä¸­æ–­æ•æ„Ÿã€‚</span><br><span class="line">await(long time, TimeUnit unit) ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚</span><br><span class="line">awaitNanos(long nanosTimeout) ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šç­‰å¾…æ—¶é—´ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚è¿”å›å€¼è¡¨ç¤ºå‰©ä½™æ—¶é—´ï¼Œå¦‚æœåœ¨nanosTimesoutä¹‹å‰å”¤é†’ï¼Œé‚£ä¹ˆè¿”å›å€¼ = nanosTimeout - æ¶ˆè€—æ—¶é—´ï¼Œå¦‚æœè¿”å›å€¼ &lt;= 0 ,åˆ™å¯ä»¥è®¤å®šå®ƒå·²ç»è¶…æ—¶äº†ã€‚</span><br><span class="line">awaitUninterruptibly() ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚ã€æ³¨æ„ï¼šè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸æ•æ„Ÿã€‘ã€‚</span><br><span class="line">awaitUntil(Date deadline) ï¼šé€ æˆå½“å‰çº¿ç¨‹åœ¨æ¥åˆ°ä¿¡å·ã€è¢«ä¸­æ–­æˆ–åˆ°è¾¾æŒ‡å®šæœ€åæœŸé™ä¹‹å‰ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚å¦‚æœæ²¡æœ‰åˆ°æŒ‡å®šæ—¶é—´å°±è¢«é€šçŸ¥ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¡¨ç¤ºåˆ°äº†æŒ‡å®šæ—¶é—´ï¼Œè¿”å›è¿”å›falseã€‚</span><br><span class="line">signal() ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚è¯¥çº¿ç¨‹ä»ç­‰å¾…æ–¹æ³•è¿”å›å‰å¿…é¡»è·å¾—ä¸Conditionç›¸å…³çš„é”ã€‚</span><br><span class="line">signalAll() ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚èƒ½å¤Ÿä»ç­‰å¾…æ–¹æ³•è¿”å›çš„çº¿ç¨‹å¿…é¡»è·å¾—ä¸Conditionç›¸å…³çš„é”ã€‚</span><br></pre></td></tr></table></figure>

<p>æœ‰ç•Œé˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œé˜Ÿåˆ—çš„è·å–æ“ä½œå°†ä¼šé˜»å¡è·å–çº¿ç¨‹ï¼ˆè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼‰ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰æ–°å¢å…ƒç´ ï¼Œå½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œé˜Ÿåˆ—çš„æ’å…¥æ“ä½œå°†ä¼šé˜»å¡æ’å…¥çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å‡ºç°â€œç©ºä½â€ã€‚æœ‰ç‚¹åƒçº¿ç¨‹æ± ã€‚</p>
<p>çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public class BoundedQueue&lt;T&gt; &#123;</span><br><span class="line">    private Object[] items;</span><br><span class="line">    // æ·»åŠ çš„ä¸‹æ ‡ï¼Œåˆ é™¤çš„ä¸‹æ ‡å’Œæ•°ç»„å½“å‰æ•°é‡</span><br><span class="line">    private int addIndex, removeIndex, count;</span><br><span class="line">    private Lock lock = new ReentrantLock();</span><br><span class="line">    private Condition notEmpty = lock.newCondition();</span><br><span class="line">    private Condition notFull = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    public BoundedQueue(int size) &#123;</span><br><span class="line">        items = new Object[size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ•°ç»„æ»¡ï¼Œåˆ™æ·»åŠ çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°æœ‰&quot;ç©ºä½&quot;</span><br><span class="line">    public void add(T t) throws InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            while (count == items.length)</span><br><span class="line">                notFull.await();</span><br><span class="line">            items[addIndex] = t;</span><br><span class="line">            if (++addIndex == items.length)</span><br><span class="line">                addIndex = 0;</span><br><span class="line">            ++count;</span><br><span class="line">            notEmpty.signal();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ç”±å¤´éƒ¨åˆ é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ•°ç»„ç©ºï¼Œåˆ™åˆ é™¤çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ–°æ·»åŠ å…ƒç´ </span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public T remove() throws InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            while (count == 0)</span><br><span class="line">                notEmpty.await();</span><br><span class="line">            Object x = items[removeIndex];</span><br><span class="line">            if (++removeIndex == items.length)</span><br><span class="line">                removeIndex = 0;</span><br><span class="line">            --count;</span><br><span class="line">            notFull.signal();</span><br><span class="line">            return (T) x;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥æ·»åŠ æ–¹æ³•ä¸ºä¾‹ï¼šé¦–å…ˆéœ€è¦è·å¾—é”ï¼Œç›®çš„æ˜¯ç¡®ä¿æ•°ç»„ä¿®æ”¹çš„å¯è§æ€§å’Œæ’ä»–æ€§ã€‚å½“æ•°ç»„æ•°é‡ç­‰äºæ•°ç»„é•¿åº¦æ—¶ï¼Œè¡¨ç¤ºæ•°ç»„å·²æ»¡ï¼Œåˆ™è°ƒç”¨notFull.await()ï¼Œå½“å‰çº¿ç¨‹éšä¹‹é‡Šæ”¾é”å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å¦‚æœæ•°ç»„æ•°é‡ä¸ç­‰äºæ•°ç»„é•¿åº¦ï¼Œè¡¨ç¤ºæ•°ç»„æœªæ»¡ï¼Œåˆ™æ·»åŠ å…ƒç´ åˆ°æ•°ç»„ä¸­ï¼ŒåŒæ—¶é€šçŸ¥ç­‰å¾…åœ¨notEmptyä¸Šçš„çº¿ç¨‹ï¼Œæ•°ç»„ä¸­å·²ç»æœ‰æ–°å…ƒç´ å¯ä»¥è·å–ã€‚</p>
<p>åœ¨æ·»åŠ å’Œåˆ é™¤æ–¹æ³•ä¸­ä½¿ç”¨whileå¾ªç¯è€Œéifåˆ¤æ–­ï¼Œç›®çš„æ˜¯é˜²æ­¢è¿‡æ—©æˆ–æ„å¤–çš„é€šçŸ¥ï¼Œåªæœ‰æ¡ä»¶ç¬¦åˆæ‰èƒ½å¤Ÿé€€å‡ºå¾ªç¯ã€‚å›æƒ³ä¹‹å‰æåˆ°çš„ç­‰å¾…/é€šçŸ¥çš„ç»å…¸èŒƒå¼ï¼ŒäºŒè€…æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚</p>
<p>âš ï¸çº¿ç¨‹çš„é˜»å¡ã€ç­‰å¾…çš„åŒºåˆ«ï¼š<br>åœ¨javaä¸­ï¼Œçº¿ç¨‹é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«ä¸å¯è®¡åˆ’çš„ï¼Œè€Œçº¿ç¨‹ç­‰å¾…çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«è®¡åˆ’ä¹‹å†…çš„ã€‚<br>ç›¸åŒç‚¹ï¼š<br>ï¼ˆ1ï¼‰éƒ½ä¼šæš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚<br>åŒºåˆ«ç‚¹ï¼š<br>ï¼ˆ1ï¼‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€æ˜¯è¢«åŠ¨çš„, è€Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€æ˜¯ä¸»åŠ¨çš„ã€‚<br>é˜»å¡çŠ¶æ€çš„è¢«åŠ¨ï¼šçº¿ç¨‹åœ¨åŒæ­¥ä»£ç å¤–ï¼Œè·å–å¯¹è±¡é”å¤±è´¥æ—¶ï¼Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›ä½•æ—¶è·å–å¯¹è±¡é”å¤±è´¥ä¸å¯çŸ¥ï¼Œå³çº¿ç¨‹é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«ä¸å¯è®¡åˆ’çš„ã€‚<br>ç­‰å¾…çŠ¶æ€çš„ä¸»åŠ¨ï¼šçº¿ç¨‹åœ¨åŒæ­¥ä»£ç å†…awaitï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹å”¤é†’æ—¶ï¼Œçº¿ç¨‹æ¥å…¥ç­‰å¾…çŠ¶æ€ï¼›ä½•æ—¶ç­‰å¾…å…¶ä»–çº¿ç¨‹æ“ä½œå¯çŸ¥ï¼Œå³çº¿ç¨‹ç­‰å¾…çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«è®¡åˆ’ä¹‹å†…çš„ã€‚</p>
<h4 id="âœ…Conditionçš„å®ç°åˆ†æ"><a href="#âœ…Conditionçš„å®ç°åˆ†æ" class="headerlink" title="âœ…Conditionçš„å®ç°åˆ†æ"></a>âœ…Conditionçš„å®ç°åˆ†æ</h4><p>ConditionObjectæ˜¯åŒæ­¥å™¨AbstractQueuedSynchronizerçš„å†…éƒ¨ç±»ï¼Œå› ä¸ºConditionçš„æ“ä½œéœ€è¦è·å–ç›¸å…³è”çš„é”ï¼Œæ‰€ä»¥ä½œä¸ºåŒæ­¥å™¨çš„å†…éƒ¨ç±»ä¹Ÿè¾ƒä¸ºåˆç†ã€‚</p>
<p>æ¯ä¸ªConditionå¯¹è±¡éƒ½åŒ…å«ç€ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆä»¥ä¸‹ç§°ä¸ºç­‰å¾…é˜Ÿåˆ—ï¼‰ï¼Œè¯¥é˜Ÿåˆ—æ˜¯Conditionå¯¹è±¡å®ç°ç­‰å¾…/é€šçŸ¥åŠŸèƒ½çš„å…³é”®ã€‚</p>
<h5 id="ä¸€ã€ç­‰å¾…é˜Ÿåˆ—"><a href="#ä¸€ã€ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="ä¸€ã€ç­‰å¾…é˜Ÿåˆ—"></a>ä¸€ã€ç­‰å¾…é˜Ÿåˆ—</h5><p>ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†ä¸€ä¸ªçº¿ç¨‹å¼•ç”¨ï¼Œè¯¥çº¿ç¨‹å°±æ˜¯åœ¨Conditionå¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Condition.await()æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ä¼šé‡Šæ”¾é”ã€æ„é€ æˆèŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚èŠ‚ç‚¹çš„å®šä¹‰å¤ç”¨äº†åŒæ­¥å™¨ä¸­èŠ‚ç‚¹çš„å®šä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ä¸­èŠ‚ç‚¹ç±»å‹éƒ½æ˜¯åŒæ­¥å™¨çš„é™æ€å†…éƒ¨ç±»AbstractQueuedSynchronizer.Nodeã€‚</p>
<p>ç­‰å¾…é˜Ÿåˆ—ï¼šå½“å‰çº¿ç¨‹è°ƒç”¨Condition.await()æ–¹æ³•ï¼Œå°†ä¼šä»¥å½“å‰çº¿ç¨‹æ„é€ èŠ‚ç‚¹ï¼Œå¹¶å°†èŠ‚ç‚¹ä»å°¾éƒ¨åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚èŠ‚ç‚¹å¼•ç”¨æ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨CASä¿è¯ï¼ŒåŸå› åœ¨äºè°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹å¿…å®šæ˜¯è·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥è¿‡ç¨‹æ˜¯ç”±é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>åœ¨Objectçš„ç›‘è§†å™¨æ¨¡å‹ä¸Šï¼Œä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œå¹¶å‘åŒ…ä¸­çš„Lockï¼ˆæ›´ç¡®åˆ‡åœ°è¯´æ˜¯åŒæ­¥å™¨ï¼‰æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œå¤šä¸ªç­‰å¾…é˜Ÿåˆ—ï¼ˆæ¯ä¸ªConditionå¯¹è±¡ä¸€ä¸ªï¼‰ã€‚</p>
<h5 id="äºŒã€ç­‰å¾…"><a href="#äºŒã€ç­‰å¾…" class="headerlink" title="äºŒã€ç­‰å¾…"></a>äºŒã€ç­‰å¾…</h5><p>è°ƒç”¨Conditionçš„await()æ–¹æ³•ï¼ˆæˆ–è€…ä»¥awaitå¼€å¤´çš„æ–¹æ³•ï¼‰ï¼Œä¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é‡Šæ”¾é”ï¼ŒåŒæ—¶çº¿ç¨‹çŠ¶æ€å˜ä¸ºç­‰å¾…çŠ¶æ€ã€‚å½“ä»await()æ–¹æ³•è¿”å›æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¸€å®šè·å–äº†Conditionç›¸å…³è”çš„é”ã€‚</p>
<p>å¦‚æœä»é˜Ÿåˆ—ï¼ˆåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼‰çš„è§’åº¦çœ‹await()æ–¹æ³•ï¼Œå½“è°ƒç”¨await()æ–¹æ³•æ—¶ï¼Œç›¸å½“äºåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼ˆè·å–äº†é”çš„èŠ‚ç‚¹ï¼‰ç§»åŠ¨åˆ°Conditionçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p>
<p>ConditionObjectçš„awaitæ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public final void await() throws InterruptedException &#123;</span><br><span class="line">    if (Thread.interrupted())</span><br><span class="line">        throw new InterruptedException();</span><br><span class="line">    // å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    // é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯é‡Šæ”¾é”</span><br><span class="line">    int savedState = fullyRelease(node);</span><br><span class="line">    int interruptMode = 0;</span><br><span class="line">    // èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­</span><br><span class="line">    // Returns true if a node, always one that was initially placed on a condition queue, is now waiting to reacquire on sync queue.</span><br><span class="line">    // å¦‚æœèŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œç°åœ¨ç­‰å¾…é‡æ–°å»è·å–é”ï¼Œè¿”å›true</span><br><span class="line">    // ä¸€èˆ¬æ€»æ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—</span><br><span class="line">    while (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        // æš‚åœè‡ªå·±ï¼Œç­‰å¾…è¢«å”¤é†’æˆ–è€…è¢«ä¸­æ–­</span><br><span class="line">        LockSupport.park(this);</span><br><span class="line">        // æ˜¯å¦è¢«ä¸­æ–­äº†</span><br><span class="line">        if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    // è·å–é”æˆåŠŸä¸”å¼‚å¸¸æ¨¡å¼ä¸ä¸ºTHROW_IEï¼Œå°±ä¿®æ”¹interruptMode</span><br><span class="line">    if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    // è¯¥æ–¹æ³•æ˜¯å†…éƒ¨ç±»Conditionä¸­çš„ï¼Œè®¾ç½®ä¸‹ä¸€ä¸ªåœ¨é¦–ä½çš„ç­‰å¾…è€…</span><br><span class="line">    if (node.nextWaiter != null)</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    // å¦‚æœinterruptMode ä¸æ˜¯0ï¼Œå”¤é†’åæŠ¥å‘Šä¸­æ–­</span><br><span class="line">    if (interruptMode != 0)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ1ï¼‰è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹æˆåŠŸè·å–äº†é”çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥é˜Ÿåˆ—ä¸­çš„é¦–èŠ‚ç‚¹ï¼Œè¯¥æ–¹æ³•ä¼šå°†å½“å‰çº¿ç¨‹æ„é€ æˆèŠ‚ç‚¹å¹¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ï¼Œç„¶åå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ï¼ˆåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹å¹¶ä¸ä¼šç›´æ¥åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡addConditionWaiter()æ–¹æ³•æŠŠå½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å¹¶å°†å…¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ï¼‰</p>
<p>ï¼ˆ2ï¼‰å½“ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹è¢«å”¤é†’ï¼Œåˆ™å”¤é†’èŠ‚ç‚¹çš„çº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå¼€å§‹å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚å¦‚æœä¸æ˜¯é€šè¿‡å…¶ä»–çº¿ç¨‹è°ƒç”¨Condition.signal()æ–¹æ³•å”¤é†’ï¼Œè€Œæ˜¯å¯¹ç­‰å¾…çº¿ç¨‹è¿›è¡Œä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡ºInterruptedExceptionã€‚</p>
<h5 id="ä¸‰ã€é€šçŸ¥"><a href="#ä¸‰ã€é€šçŸ¥" class="headerlink" title="ä¸‰ã€é€šçŸ¥"></a>ä¸‰ã€é€šçŸ¥</h5><p>è°ƒç”¨Conditionçš„signal()æ–¹æ³•çš„å‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹å¿…é¡»è·å–äº†é”ï¼Œå°†åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰ï¼Œçº¿ç¨‹å®‰å…¨åœ°ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œå¹¶ä½¿ç”¨LockSupportå”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œç„¶åå°±ç«äº‰é”ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public final void signal() &#123;</span><br><span class="line">    // é”æ˜¯å¦å¤„äºå ç”¨çŠ¶æ€</span><br><span class="line">    if (!isHeldExclusively())</span><br><span class="line">        throw new IllegalMonitorStateException();</span><br><span class="line">    // è·å–ç¬¬ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    if (first != null)</span><br><span class="line">        // å”¤é†’</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¢«å”¤é†’åçš„çº¿ç¨‹ï¼Œå°†ä»await()æ–¹æ³•ä¸­çš„whileå¾ªç¯ä¸­é€€å‡ºï¼ˆisOnSyncQueue(Node node)æ–¹æ³•è¿”å›trueï¼ŒèŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼‰ï¼Œè¿›è€Œè°ƒç”¨åŒæ­¥å™¨çš„acquireQueued()æ–¹æ³•åŠ å…¥åˆ°è·å–åŒæ­¥çŠ¶æ€çš„ç«äº‰ä¸­ã€‚</p>
<p>æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…è¯´é”ï¼‰ä¹‹åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°†ä»å…ˆå‰è°ƒç”¨çš„await()æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å·²ç»æˆåŠŸåœ°è·å–äº†é”ã€‚å¦‚æœæœªè·å–åˆ°é”ï¼Œå°†åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­é˜»å¡ã€‚</p>
<p>Conditionçš„signalAll()æ–¹æ³•ï¼Œç›¸å½“äºå¯¹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œä¸€æ¬¡signal()æ–¹æ³•ï¼Œæ•ˆæœå°±æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ¨ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶å”¤é†’æ¯ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹ã€‚</p>
<h2 id="ç¬¬å…­ç« -javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶"><a href="#ç¬¬å…­ç« -javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶" class="headerlink" title="ç¬¬å…­ç«  javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶"></a>ç¬¬å…­ç«  javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶</h2><h3 id="1-ConcurrentHashMapçš„å®ç°åŸç†ä¸ä½¿ç”¨"><a href="#1-ConcurrentHashMapçš„å®ç°åŸç†ä¸ä½¿ç”¨" class="headerlink" title="1.ConcurrentHashMapçš„å®ç°åŸç†ä¸ä½¿ç”¨"></a>1.ConcurrentHashMapçš„å®ç°åŸç†ä¸ä½¿ç”¨</h3><p>ConcurrentHashMapæ˜¯çº¿ç¨‹å®‰å…¨ä¸”é«˜æ•ˆçš„HashMapã€‚</p>
<h4 id="âœ…ä¸ºä»€ä¹ˆä½¿ç”¨ConcurrentHashMap"><a href="#âœ…ä¸ºä»€ä¹ˆä½¿ç”¨ConcurrentHashMap" class="headerlink" title="âœ…ä¸ºä»€ä¹ˆä½¿ç”¨ConcurrentHashMap"></a>âœ…ä¸ºä»€ä¹ˆä½¿ç”¨ConcurrentHashMap</h4><p>ï¼ˆ1ï¼‰<strong>HashMapçº¿ç¨‹ä¸å®‰å…¨ä¼šæ­»å¾ªç¯</strong></p>
<p>HashMap åœ¨å¹¶å‘æ‰§è¡Œputæ“ä½œæ—¶ä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œæ˜¯å› ä¸ºå¤šçº¿ç¨‹ä¼šå¯¼è‡´HashMapçš„Entryé“¾è¡¨å½¢æˆç¯å½¢æ•°æ®ç»“æ„ï¼Œä¸€æ—¦å½¢æˆç¯å½¢æ•°æ®ç»“æ„ï¼ŒEntryçš„nextèŠ‚ç‚¹æ°¸è¿œä¸ä¸ºç©ºï¼Œå°±ä¼šäº§ç”Ÿæ­»å¾ªç¯è·å–Entryã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">final HashMap&lt;String,String&gt; map = new HashMap&lt;&gt;(2); // å®¹é‡ä¸º2çš„Map</span><br><span class="line">Thread thread = new Thread(new Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        for (int i=0;i&lt;10000;i++)&#123;</span><br><span class="line">            new Thread(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    map.put(UUID.randomUUID().toString(),&quot;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,&quot;ftf&quot;+i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,&quot;ftf&quot;);</span><br><span class="line">thread.start();</span><br><span class="line">thread.join();</span><br></pre></td></tr></table></figure>

<p>HashMapçš„å®ç°åŸç†ï¼š<br>HashMapçš„ä¸»å¹²æ˜¯ä¸€ä¸ªEntryæ•°ç»„ï¼ˆEntryæ˜¯ä»¥é“¾è¡¨çš„å½¢å¼å­˜å‚¨çš„ï¼‰ã€‚Entryæ˜¯HashMapçš„åŸºæœ¬ç»„æˆå•å…ƒï¼Œæ¯ä¸€ä¸ªEntryåŒ…å«ä¸€ä¸ªkey-valueé”®å€¼å¯¹ã€‚(å…¶å®æ‰€è°“Mapå…¶å®å°±æ˜¯ä¿å­˜äº†ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´çš„æ˜ å°„å…³ç³»çš„ä¸€ç§é›†åˆ)ã€‚</p>
<p>Entryç»“æ„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static class Entry&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; &#123;</span><br><span class="line">    final K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next; // å­˜å‚¨æŒ‡å‘ä¸‹ä¸€ä¸ªEntryçš„å¼•ç”¨ï¼Œå•é“¾è¡¨ç»“æ„ã€‚</span><br><span class="line"> </span><br><span class="line">    int hash;	   // å¯¹keyçš„hashcodeå€¼è¿›è¡Œhashè¿ç®—åå¾—åˆ°çš„å€¼ï¼Œå­˜å‚¨åœ¨Entryï¼Œé¿å…é‡å¤è®¡ç®—ã€‚</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼šHashMapç”±æ•°ç»„+é“¾è¡¨ç»„æˆçš„ï¼Œæ•°ç»„æ˜¯HashMapçš„ä¸»ä½“ï¼Œé“¾è¡¨åˆ™æ˜¯ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨çš„ã€‚</p>
<p>HashMapåœ¨putçš„æ—¶å€™ï¼Œæ’å…¥çš„å…ƒç´ è¶…è¿‡äº†å®¹é‡(ç”±è´Ÿè½½å› å­å†³å®š)çš„èŒƒå›´å°±ä¼šè§¦å‘æ‰©å®¹æ“ä½œï¼Œå°±æ˜¯rehashï¼Œè¿™ä¸ªä¼šé‡æ–°å°†åŸæ•°ç»„çš„å†…å®¹é‡æ–°hashåˆ°æ–°çš„æ‰©å®¹æ•°ç»„ä¸­ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œå­˜åœ¨å…¶ä»–çš„å…ƒç´ ä¹Ÿåœ¨putæ“ä½œï¼Œå¦‚æœhashå€¼ç›¸åŒï¼Œå¯èƒ½å‡ºç°åŒæ—¶åœ¨åŒä¸€æ•°ç»„ä¸‹ç”¨é“¾è¡¨è¡¨ç¤ºï¼Œé€ æˆé—­ç¯ï¼Œå¯¼è‡´åœ¨getæ—¶ä¼šå‡ºç°æ­»å¾ªç¯ï¼Œæ‰€ä»¥HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p>
<p>HashMapçš„çº¿ç¨‹ä¸å®‰å…¨ä¸»è¦ä½“ç°åœ¨ä¼šé€ æˆæ­»å¾ªç¯ï¼Œæ•°æ®ä¸¢å¤±ï¼Œæ•°æ®è¦†ç›–è¿™äº›é—®é¢˜ã€‚å…¶ä¸­æ­»å¾ªç¯å’Œæ•°æ®ä¸¢å¤±æ˜¯åœ¨JDK1.7ä¸­å‡ºç°çš„é—®é¢˜ï¼Œåœ¨Jdk1.8ä¸­å·²ç»å¾—åˆ°è§£å†³ï¼Œç„¶è€ŒJDK1.8ä»ä¼šæœ‰æ•°æ®è¦†ç›–è¿™æ ·çš„é—®é¢˜ã€‚</p>
<p>ï¼ˆ2ï¼‰<strong>æ•ˆç‡ä½ä¸‹çš„HashTable</strong></p>
<p>HashTableå®¹å™¨ä½¿ç”¨synchronizedæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†åœ¨çº¿ç¨‹ç«äº‰æ¿€çƒˆçš„æƒ…å†µä¸‹HashTableçš„æ•ˆç‡éå¸¸ä½ä¸‹ã€‚å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹ä¹Ÿè®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥é˜»å¡æˆ–è½®è¯¢çŠ¶æ€ï¼Œæ‰€ä»¥ç«äº‰è¶Šæ¿€çƒˆæ•ˆç‡è¶Šä½ã€‚</p>
<p>ï¼ˆ3ï¼‰ConcurrentHashMapçš„é”åˆ†æ®µæŠ€æœ¯å¯æœ‰æ•ˆæå‡å¹¶å‘è®¿é—®ç‡ã€‚</p>
<p>HashTableçš„çº¿ç¨‹éƒ½å¿…é¡»ç«äº‰åŒä¸€æŠŠé”ï¼Œå‡å¦‚å®¹å™¨é‡Œæœ‰å¤šæŠŠé”æ¯ä¸€æŠŠé”ç”¨äºé”å®¹å™¨å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®ï¼Œé‚£ä¹ˆå½“å¤šçº¿ç¨‹è®¿é—®å®¹å™¨é‡Œä¸åŒæ•°æ®æ®µçš„æ•°æ®æ—¶ï¼Œçº¿ç¨‹é—´å°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œä»è€Œå¯ä»¥æœ‰æ•ˆæé«˜å¹¶å‘ç‡ï¼Œè¿™å°±æ˜¯ConcurrentHashMapæ‰€ä½¿ç”¨çš„é”åˆ†æ®µæŠ€æœ¯ã€‚é¦–å…ˆå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µåœ°å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®çš„æ—¶å€™ï¼Œå…¶å®ƒæ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</p>
<h4 id="âœ…ConcurrentHashMapçš„ç»“æ„"><a href="#âœ…ConcurrentHashMapçš„ç»“æ„" class="headerlink" title="âœ…ConcurrentHashMapçš„ç»“æ„"></a>âœ…ConcurrentHashMapçš„ç»“æ„</h4><p>ç±»å›¾ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public class ConcurrentHashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;</span><br><span class="line">    implements ConcurrentMap&lt;K,V&gt;, Serializable</span><br></pre></td></tr></table></figure>

<p>ConcurrentHashMapæ˜¯ç”±Segmentæ•°ç»„ç»“æ„å’ŒHashEntryæ•°ç»„ç»“æ„ç»„æˆã€‚Segmentæ˜¯ä¸€ç§å¯é‡å…¥é”(ReentrantLock),åœ¨ConcurrentHashMapé‡Œæ‰®æ¼”é”çš„è§’è‰²ï¼›HashEntryåˆ™ç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®ã€‚ä¸€ä¸ªConcurrentHashMapé‡ŒåŒ…å«ä¸€ä¸ªSegmentæ•°ç»„ã€‚Segmentçš„ç»“æ„å’ŒHashMapç±»ä¼¼ï¼Œæ˜¯ä¸€ç§æ•°ç»„å’Œé“¾è¡¨ç»“æ„ã€‚<strong>ä¸€ä¸ªSegmenté‡ŒåŒ…å«ä¸€ä¸ªHashEntryæ•°ç»„</strong>ï¼Œ<strong>æ¯ä¸ªHashEntryæ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„çš„å…ƒç´ ï¼ˆä¸€ä¸ªåŒ…å«æ•°æ®çš„é“¾è¡¨ï¼‰</strong>ï¼Œæ¯ä¸ªSegmenté‡Œå®ˆæŠ¤ç€ä¸€ä¸ªHashEntryæ•°ç»„é‡Œçš„å…ƒç´ ï¼Œå½“å¯¹HashEntryæ•°ç»„çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¿…é¡»é¦–å…ˆè·å¾—ä¸å®ƒå¯¹åº”çš„Segmenté”ã€‚</p>
<h4 id="âœ…ConcurrentHashMapçš„åˆå§‹åŒ–ä¸å®šä½"><a href="#âœ…ConcurrentHashMapçš„åˆå§‹åŒ–ä¸å®šä½" class="headerlink" title="âœ…ConcurrentHashMapçš„åˆå§‹åŒ–ä¸å®šä½"></a>âœ…ConcurrentHashMapçš„åˆå§‹åŒ–ä¸å®šä½</h4><p>ConcurrentHashMapåˆå§‹åŒ–æ–¹æ³•æ˜¯é€šè¿‡initialCapacity, loadFactorå’ŒconcurrencyLevelç­‰å‡ ä¸ªå‚æ•°æ¥åˆå§‹åŒ–segmentæ•°ç»„ï¼Œæ®µåç§»é‡segmentShiftï¼Œæ®µæ©ç segmentMaskå’Œæ¯ä¸ªsegmenté‡Œçš„HashEntryæ•°ç»„æ¥å®ç°ã€‚</p>
<p>ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”Segmentæ¥ä¿æŠ¤ä¸åŒæ®µçš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨æ’å…¥å’Œè·å–å…ƒç´ çš„æ—¶å€™ï¼Œå¿…é¡»å…ˆé€šè¿‡æ•£åˆ—ç®—æ³•å®šä½åˆ°Segmentã€‚è€Œä¸”ï¼Œä¼šä½¿ç”¨å†æ•£è£‚ç®—æ³•å¯¹å…ƒç´ çš„hashCodeè¿›è¡Œä¸€æ¬¡å†æ•£åˆ—ã€‚</p>
<p>å†æ•£åˆ—çš„ç›®çš„ï¼šå‡å°‘æ•£åˆ—å†²çªï¼Œä½¿å…ƒç´ å‡åŒ€åœ°åˆ†å¸ƒåœ¨ä¸åŒçš„segmrntä¸Šï¼Œæé«˜å®¹å™¨çš„å­˜å–æ•ˆç‡ã€‚</p>
<h4 id="âœ…ConcurrentHashMapçš„æ“ä½œ"><a href="#âœ…ConcurrentHashMapçš„æ“ä½œ" class="headerlink" title="âœ…ConcurrentHashMapçš„æ“ä½œ"></a>âœ…ConcurrentHashMapçš„æ“ä½œ</h4><p>ï¼ˆ1ï¼‰get(key)</p>
<p>ç»è¿‡ä¸€æ¬¡å†æ•£åˆ—ï¼Œå…ˆå®šä½åˆ°segmentï¼Œç„¶åå†é€šè¿‡æ•£åˆ—è¿ç®—å®šä½åˆ°å…ƒç´ ã€‚<br>ä¸éœ€è¦åŠ é”ï¼Œé™¤éè¯»åˆ°çš„å€¼æ˜¯ç©ºçš„æ‰ä¼šåŠ é”é‡è¯»ã€‚åŸå› æ˜¯ï¼šå°†å…±äº«å˜é‡ï¼ˆsegmentå¤§å°ã€HashEntryé‡Œçš„valueï¼‰å®šä¹‰ä¸ºvolatileã€‚åˆ©ç”¨volatileåœ¨å¤šçº¿ç¨‹ä¸­çš„å¯è§æ€§ï¼Œå¯ä»¥è¢«å¤šçº¿ç¨‹è¯»ï¼Œä¿è¯ä¸ä¼šè¯»åˆ°è¿‡æœŸçš„å€¼ã€‚</p>
<p>ï¼ˆ2ï¼‰put(key, value)</p>
<p>å…ˆå®šä½åˆ°segmentï¼Œç„¶ååœ¨segmenté‡Œè¿›è¡Œæ’å…¥æ“ä½œã€‚åˆ†ä¸¤æ­¥ï¼š<br>1.æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Ÿ<br>å…ˆåˆ¤æ–­HashEntryæ•°ç»„æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œå¦‚æœè¶…è¿‡äº†å°±æ‰©å®¹ï¼Œæ‰©å®¹ä¹‹åå†æ’å…¥æ•°æ®ã€‚è€ŒHashMapæ˜¯å…ˆæ’å…¥å†æ‰©å®¹ï¼Œè¿™æ ·ä¸å¥½ï¼Œå› ä¸ºä¸‹æ¬¡å¯èƒ½å°±æ²¡æœ‰æ•°æ®è¿›æ¥äº†ï¼Œé‚£å°±ç™½æ‰©å®¹äº†ã€‚<br>2.å¦‚ä½•æ‰©å®¹ï¼Ÿ<br>å…ˆåˆ›å»ºä¸€ä¸ªå®¹é‡æ˜¯åŸæ¥2å€çš„æ•°ç»„ï¼Œç„¶åé€šè¿‡å¯¹åŸæ•°ç»„å…ƒç´ è¿›è¡Œå†æ•£åˆ—åæ’å…¥åˆ°æ–°æ•°ç»„ã€‚æ‰©å®¹åªä¼šå¯¹æŸä¸ªsegmentè¿›è¡Œã€‚</p>
<p>ï¼ˆ3ï¼‰size()</p>
<p>Segmentä¸­æœ‰ä¸€ä¸ªå…¨å±€å˜é‡countæ˜¯ä¸€ä¸ªvolatileå˜é‡ï¼Œå¯ä»¥ç´¯åŠ å„ä¸ªsegmentçš„countæ¥è®¡ç®—å¤§å°ã€‚ä½†æ˜¯å¯èƒ½ç´¯åŠ å‰countå‘ç”Ÿäº†å˜åŒ–ï¼Œç»Ÿè®¡ç»“æœä¸å‡†ã€‚ä½†æ˜¯é”ä½æ‰€æœ‰çš„segmentå†è®¡ç®—ä¹Ÿä¸åˆé€‚ã€‚</p>
<p>åœ¨æ¯ä¸ªsegmentä¸­æœ‰ä¸€ä¸ªvolatileä¿®é¥°çš„countå±æ€§ï¼Œè¡¨ç¤ºè¿™ä¸ªsegmentä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå…ˆé€šè¿‡2æ¬¡ä¸åŠ é”çš„æ–¹æ³•ç»Ÿè®¡æ‰€æœ‰countçš„æ€»å’Œï¼Œå¦‚æœä¸¤æ¬¡ç»“æœä¸ç›¸ç­‰ï¼Œæˆ–è€…å®¹å™¨è¢«ä¿®æ”¹è¿‡äº†ï¼Œå°±å°†SegmentåŠ é”ï¼Œå†è¿›è¡Œç¬¬ä¸‰æ¬¡ç»Ÿè®¡ã€‚</p>
<p>ConcurrentHashMapä¸­æœ‰ä¸€ä¸ªmodCountå˜é‡ï¼Œæ¯æ¬¡put\remove\cleanæ“ä½œï¼Œéƒ½ä¼šå¯¹è¿™ä¸ªå€¼åŠ ä¸€ï¼Œé€šè¿‡æ¯”è¾ƒè¿™ä¸ªå€¼ï¼Œå°±çŸ¥é“æ˜¯å¦å®¹å™¨æ˜¯å¦è¢«ä¿®æ”¹äº†ã€‚</p>
<h3 id="2-ConcurrentLinkedQueue"><a href="#2-ConcurrentLinkedQueue" class="headerlink" title="2.ConcurrentLinkedQueue"></a>2.ConcurrentLinkedQueue</h3><p>æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ã€‚</p>
<p>åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„å¯¹åˆ—ã€‚å¦‚æœè¦å®ç°ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å¯¹åˆ—æœ‰2ç§æ–¹å¼ï¼šä¸€ç§æ˜¯ä½¿ç”¨é˜»å¡ç®—æ³•ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨éé˜»å¡ç®—æ³•ã€‚ä½¿ç”¨é˜»å¡ç®—æ³•çš„å¯¹åˆ—å¯ä»¥ç”¨ä¸€ä¸ªé”ï¼ˆå…¥é˜Ÿå’Œå‡ºé˜Ÿç”¨åŒä¸€æŠŠé”ï¼‰æˆ–ä¸¤ä¸ªé”ï¼ˆå…¥é˜Ÿå’Œå‡ºé˜Ÿç”¨ä¸åŒçš„é”ï¼‰ç­‰æ–¹å¼æ¥å®ç°ã€‚éé˜»å¡çš„å®ç°æ–¹å¼åˆ™å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥å®ç°ã€‚ã€é”ä¹Ÿæ˜¯åŸºäºCASå’Œvolatileæ¥å®ç°çš„å§ã€‘</p>
<p>ConcurrentLinkedQueueæ˜¯ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨å¯¹åˆ—ï¼Œå®ƒé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œå½“æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå®ƒä¼šæ·»åŠ åˆ°å¯¹åˆ—çš„å°¾éƒ¨ï¼›å½“æˆ‘ä»¬è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®ƒä¼šè¿”å›å¯¹åˆ—å¤´éƒ¨çš„å…ƒç´ ã€‚å®ƒé‡‡ç”¨äº†â€wait-freeâ€ç®—æ³•(å³CASç®—æ³•)æ¥å®ç°ã€‚</p>
<h4 id="âœ…ConcurrentLinkedQueueçš„ç»“æ„"><a href="#âœ…ConcurrentLinkedQueueçš„ç»“æ„" class="headerlink" title="âœ…ConcurrentLinkedQueueçš„ç»“æ„"></a>âœ…ConcurrentLinkedQueueçš„ç»“æ„</h4><p>ConcurrentLinkedQueueç”±headèŠ‚ç‚¹å’ŒtailèŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ç”±èŠ‚ç‚¹å…ƒç´ (item)å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹(next)çš„å¼•ç”¨ç»„æˆï¼ŒèŠ‚ç‚¹å’ŒèŠ‚ç‚¹ä¹‹é—´å°±æ˜¯é€šè¿‡è¿™ä¸ªnextå…³è”èµ·æ¥ï¼Œä»è€Œç»„æˆä¸€å¼ é“¾è¡¨ç»“æ„çš„å¯¹åˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹headèŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä¸ºç©ºï¼ŒtailèŠ‚ç‚¹ç­‰äºheadèŠ‚ç‚¹ã€‚</p>
<p>ç»§æ‰¿äº†AbstractQueueï¼Œä¸æ˜¯é˜»å¡é˜Ÿåˆ—ã€‚</p>
<p>ConcurrentLinkedQueueç”±headèŠ‚ç‚¹å’ŒtailèŠ‚ç‚¹ç»„æˆã€‚headã€tailã€nextã€itemå‡ä½¿ç”¨volatileä¿®é¥°ï¼Œä¿è¯å…¶å†…å­˜å¯è§æ€§ã€‚</p>
<h4 id="âœ…å…¥é˜Ÿåˆ—-offer-E-e"><a href="#âœ…å…¥é˜Ÿåˆ—-offer-E-e" class="headerlink" title="âœ…å…¥é˜Ÿåˆ—:offer(E e)"></a>âœ…å…¥é˜Ÿåˆ—:offer(E e)</h4><p>å…¥é˜Ÿåˆ—å°±æ˜¯å°†å…¥é˜ŸèŠ‚ç‚¹æ·»åŠ åˆ°å¯¹åˆ—çš„å°¾éƒ¨ã€‚å…¥é˜Ÿä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼š<br>ç¬¬ä¸€ï¼šæ˜¯å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆå½“å‰é˜Ÿåˆ—å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼›<br>ç¬¬äºŒï¼šæ˜¯æ›´æ–°tailèŠ‚ç‚¹ï¼Œå¦‚æœtailèŠ‚ç‚¹çš„nextä¸ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®ä¸ºtialèŠ‚ç‚¹ï¼Œæˆä¸ºé˜Ÿå°¾èŠ‚ç‚¹çš„nextèŠ‚ç‚¹ï¼Œå¦‚æœtailèŠ‚ç‚¹çš„nextä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹çš„è®¾ç½®ä¸ºtailçš„nextèŠ‚ç‚¹ã€‚æ‰€ä»¥tailèŠ‚ç‚¹ä¸æ€»æ˜¯å°¾èŠ‚ç‚¹ã€‚ã€æ•ˆæœæ˜¯ä¸¤æ ¼ä¸¤æ ¼å¾—è·³ã€‘</p>
<p>1.å®šä½å°¾èŠ‚ç‚¹<br>tailèŠ‚ç‚¹å¹¶ä¸æ€»æ˜¯å°¾èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ¯æ¬¡å…¥é˜Ÿéƒ½å¿…é¡»å…ˆé€šè¿‡tailèŠ‚ç‚¹æ¥æ‰¾åˆ°å°¾èŠ‚ç‚¹ã€‚å°¾èŠ‚ç‚¹å¯èƒ½æ˜¯tailèŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯tailèŠ‚ç‚¹çš„nextèŠ‚ç‚¹ã€‚</p>
<p>2.è®¾ç½®å…¥é˜ŸèŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹<br>p.casNext(null,n)æ–¹æ³•ç”¨äºå°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰å¯¹å°¾èŠ‚ç‚¹çš„nextèŠ‚ç‚¹ï¼Œå¦‚æœpæ˜¯nullï¼Œè¡¨ç¤ºpæ˜¯å½“å‰èŠ‚ç‚¹çš„å°¾èŠ‚ç‚¹ï¼Œå¦‚æœä¸ä¸ºnullï¼Œè¡¨ç¤ºæœ‰å…¶å®ƒçº¿ç¨‹æ›´æ–°äº†å°¾èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦é‡æ–°è·å–å½“å‰å¯¹åˆ—çš„å°¾èŠ‚ç‚¹ã€‚</p>
<p>âš ï¸ä¸æ˜¯æ¯æ¬¡å…¥é˜Ÿéƒ½æ›´æ–°tailèŠ‚ç‚¹ï¼š<br>å¦‚æœå°†tailèŠ‚ç‚¹æ°¸è¿œä½œä¸ºå°¾èŠ‚ç‚¹ï¼Œè¿™æ ·æ¯æ¬¡éƒ½éœ€è¦å¾ªç¯CASæ›´æ–°tailèŠ‚ç‚¹ï¼Œè€Œè®¾ç½®ä¸€ä¸ªåˆ°å°¾èŠ‚ç‚¹çš„è·ç¦»ï¼Œå½“tailåˆ°å°¾èŠ‚ç‚¹çš„è·ç¦»å¤§äºæŸä¸ªå€¼ï¼ˆé€šå¸¸ä¸º1ï¼‰çš„æ—¶å€™å†æ›´æ–°tailï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ›´æ–°çš„æ¬¡æ•°ï¼Œæé«˜å…¥é˜Ÿçš„æ•ˆç‡ã€‚å®šä½å°¾èŠ‚ç‚¹æ—¶å°±éœ€è¦å¢åŠ å¯¹volatileå˜é‡è¯»æ“ä½œï¼Œä½†æ˜¯å¯¹volatileå˜é‡çš„å†™æ“ä½œå¼€é”€è¦è¿œè¿œå¤§äºè¯»æ“ä½œï¼Œæ‰€ä»¥å…¥é˜Ÿæ•ˆç‡ä¼šæœ‰æ‰€æå‡ã€‚</p>
<p><strong>å…¥é˜Ÿæ–¹æ³•æ°¸è¿œè¿”å›trueï¼Œæ‰€ä»¥ä¸è¦é€šè¿‡è¿”å›å€¼åˆ¤æ–­å…¥é˜Ÿæ˜¯å¦æˆåŠŸã€‚</strong></p>
<h4 id="âœ…å‡ºé˜Ÿåˆ—ï¼špoll"><a href="#âœ…å‡ºé˜Ÿåˆ—ï¼špoll" class="headerlink" title="âœ…å‡ºé˜Ÿåˆ—ï¼špoll()"></a>âœ…å‡ºé˜Ÿåˆ—ï¼špoll()</h4><p>ä¸æ˜¯æ¯æ¬¡å‡ºé˜Ÿéƒ½æ›´æ–°headèŠ‚ç‚¹ï¼Œå½“headä¸­æœ‰å…ƒç´ ï¼Œå°±ç›´æ¥å¼¹å‡ºheadçš„å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œå°±å¼¹å‡ºheadçš„nextï¼Œç„¶åæ›´æ–°headèŠ‚ç‚¹ï¼ŒheadèŠ‚ç‚¹å˜ä¸ºå¼¹å‡ºèŠ‚ç‚¹çš„nextèŠ‚ç‚¹ã€‚ã€ä¸€æ¬¡èµ°ä¸¤æ ¼ã€‘<br>ä¹Ÿæ˜¯é€šè¿‡æ§åˆ¶è·ç¦»çš„æ–¹å¼ï¼Œå‡å°‘CASæ›´æ–°èŠ‚ç‚¹çš„æ¶ˆè€—ã€‚</p>
<h3 id="3-é˜»å¡é˜Ÿåˆ—"><a href="#3-é˜»å¡é˜Ÿåˆ—" class="headerlink" title="3.é˜»å¡é˜Ÿåˆ—"></a>3.é˜»å¡é˜Ÿåˆ—</h3><p>é˜»å¡å¯¹åˆ—(BlockingQueue)æ˜¯ä¸€ä¸ªæ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„å¯¹åˆ—ã€‚è¿™ä¸¤ä¸ªé™„åŠ æ“ä½œæ”¯æŒé˜»å¡çš„æ’å…¥å’Œç§»é™¤æ–¹æ³•ã€‚</p>
<p>1ï¼‰æ”¯æŒé˜»å¡çš„æ’å…¥æ–¹æ³•ï¼šæ„æ€æ˜¯å½“å¯¹åˆ—æ»¡æ—¶ï¼Œå¯¹åˆ—ä¼šé˜»å¡æ’å…¥å…ƒç´ çš„çº¿ç¨‹ï¼Œç›´åˆ°å¯¹åˆ—ä¸æ»¡ã€‚<br>2ï¼‰æ”¯æŒé˜»å¡çš„ç§»é™¤æ–¹æ³•ï¼šæ„æ€æ˜¯å½“å¯¹åˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…å¯¹åˆ—ä¸ä¸ºç©ºã€‚</p>
<p>é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å‘å¯¹åˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œå–å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…ç”¨æ¥å­˜æ”¾å…ƒç´ ï¼Œæ¶ˆè´¹è€…ç”¨æ¥è·å–å…ƒç´ çš„å®¹å™¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--------------------æ’å…¥å’Œç§»é™¤æ“ä½œçš„4ç§å¤„ç†æ–¹å¼--------------</span><br><span class="line"></span><br><span class="line">æ–¹æ³•/å¤„ç†æ–¹å¼    æŠ›å‡ºå¼‚å¸¸    è¿”å›ç‰¹æ®Šå€¼    ä¸€ç›´é˜»å¡    è¶…æ—¶é€€å‡º</span><br><span class="line">æ’å…¥æ–¹æ³•        add(e)     offer(e)     put(e)      offer(e,time,unit)</span><br><span class="line">ç§»é™¤æ–¹æ³•       remove()    poll()       take()     poll(time,unit)</span><br><span class="line">æ£€æŸ¥æ–¹æ³•      element()    peek()       ä¸å¯ç”¨      ä¸å¯ç”¨</span><br><span class="line"></span><br><span class="line">1ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼šå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœå†å¾€å¯¹åˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œä¼šæŠ›å‡ºIllegalStateException(&quot;Queue full&quot;)å¼‚å¸¸ã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ ä¼šæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸ã€‚</span><br><span class="line">2ï¼‰è¿”å›ç‰¹æ®Šå€¼ï¼šå½“å¾€é˜Ÿåˆ—æ’å…¥å…ƒç´ æ—¶ï¼Œä¼šè¿”å›å…ƒç´ æ˜¯å¦æ’å…¥æˆåŠŸï¼ŒæˆåŠŸè¿”å›trueã€‚å¦‚æœæ˜¯ç§»é™¤æ–¹æ³•ï¼Œåˆ™æ˜¯ä»é˜Ÿåˆ—é‡Œå–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰è¿”å›nullã€‚</span><br><span class="line">3ï¼‰ä¸€ç›´é˜»å¡ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°å¯¹åˆ—å¯ç”¨æˆ–è€…å“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¦‚æœæ¶ˆè´¹è€…çº¿ç¨‹ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ä½æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚</span><br><span class="line">4ï¼‰è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸å¯èƒ½å‡ºç°æ»¡çš„æƒ…å†µï¼Œå²æœˆä½¿ç”¨putå’Œofferæ°¸è¿œä¸ä¼šè¢«é˜»å¡ï¼Œè€Œä¸”ä½¿ç”¨offeræ–¹æ³•æ—¶ï¼Œæ€»è¿”å›trueã€‚</p>
<h4 id="âœ…javaæä¾›çš„å‡ ç§é˜»å¡é˜Ÿåˆ—"><a href="#âœ…javaæä¾›çš„å‡ ç§é˜»å¡é˜Ÿåˆ—" class="headerlink" title="âœ…javaæä¾›çš„å‡ ç§é˜»å¡é˜Ÿåˆ—"></a>âœ…javaæä¾›çš„å‡ ç§é˜»å¡é˜Ÿåˆ—</h4><p>ArrayBlockingQueue:    ä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ArrayBlockingQueueæ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</span><br><span class="line">æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡º(FIFO)çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><br><span class="line">é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯çº¿ç¨‹å…¬å¹³çš„è®¿é—®é˜Ÿï¼Œå³ä¸ä¿è¯å…ˆé˜»å¡çº¿ç¨‹å…ˆè®¿é—®é˜Ÿåˆ—ã€‚</span><br><span class="line"></span><br><span class="line">å¦‚æœæƒ³ä¿è¯å…¬å¹³æ€§ï¼Œå¯ä»¥ç”¨å¯é‡å…¥é”æ¥å®ç°</span><br><span class="line">ArrayBlockingQueue fairQueue = new ArrayBlockingQueue&lt;&gt;(1000, true);</span><br><span class="line">public ArrayBlockingQueue(int capacity, boolean fair) &#123;</span><br><span class="line">    if (capacity &lt;= 0)</span><br><span class="line">        throw new IllegalArgumentException();</span><br><span class="line">    this.items = new Object[capacity];</span><br><span class="line">    lock = new ReentrantLock(fair);</span><br><span class="line">    notEmpty = lock.newCondition();</span><br><span class="line">    notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LinkedBlockingQueue:    ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LinkedBlockingQueueæ˜¯ä¸€ä¸ªç”¨é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</span><br><span class="line">æ­¤é˜Ÿåˆ—çš„é»˜è®¤å’Œæœ€å¤§é•¿åº¦ä¸ºInter.MAX_VALUEã€‚</span><br><span class="line">æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><br></pre></td></tr></table></figure>

<p>PriorityBlockingQueue:    ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</span><br><span class="line">é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡å–è‡ªç„¶é¡ºåºå‡åºæ’åˆ—ã€‚</span><br><span class="line">ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å®ç°compareTo()æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œ</span><br><span class="line">æˆ–è€…åˆå§‹åŒ–PriorityBlockingQueueæ—¶ï¼ŒæŒ‡å®šæ„é€ å‚æ•°(Comparator)æ¥å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ä¿è¯åŒä¼˜å…ˆçº§å…ƒç´ çš„æ’åºã€‚</span><br></pre></td></tr></table></figure>

<p>DelayQueue:    ä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">DelayQueueæ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—.</span><br><span class="line">é˜Ÿåˆ—ä½¿ç”¨PriorityQueueæ¥å®ç°ã€‚</span><br><span class="line">é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œåœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…ï¼ˆå…ƒç´ å­˜åœ¨äº†å¤šä¹…ï¼‰æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚</span><br><span class="line">åªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—é‡Œæå–å…ƒç´ ã€‚</span><br><span class="line"></span><br><span class="line">åº”ç”¨åœºæ™¯ï¼š</span><br><span class="line">1ï¼‰ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡ï¼šå¯ä»¥ç”¨DelayQueueä¿å­˜ç¼“å­˜å…ƒç´ çš„æœ‰æ•ˆæœŸï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯æŸ¥è¯¢DelayQueueï¼Œä¸€æ—¦èƒ½ä»DelayQueueè·å–å…ƒç´ æ—¶ï¼Œè¡¨ç¤ºç¼“å­˜æœ‰æ•ˆæœŸåˆ°äº†ã€‚</span><br><span class="line">2ï¼‰å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼šä½¿ç”¨DelayQueueä¿å­˜å½“å¤©å°†ä¼šæ‰§è¡Œçš„ä»»åŠ¡å’Œæ‰§è¡Œæ—¶é—´ï¼Œä¸€æ—¦ä»DelayQueueä¸­è·å–åˆ°ä»»åŠ¡å°±å¼€å§‹æ‰§è¡Œï¼Œæ¯”å¦‚TimeQueueå°±æ˜¯ä½¿ç”¨DelayQueueå®ç°çš„ã€‚</span><br><span class="line"></span><br><span class="line">a.å¦‚ä½•å®ç°Delayedæ¥å£</span><br><span class="line">DelayQueueé˜Ÿåˆ—çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ã€‚æˆ‘ä»¬å¯ä»¥å‚è€ƒScheduledThreadPoolExecutoré‡ŒScheduledFutureTaskç±»çš„å®ç°ï¼Œä¸€å…±æœ‰ä¸‰æ­¥ã€‚</span><br><span class="line"></span><br><span class="line">ç¬¬ä¸€æ­¥ï¼šåœ¨å¯¹è±¡åˆ›å»ºçš„æ—¶å€™ï¼Œåˆå§‹åŒ–åŸºæœ¬æ•°æ®ã€‚ä½¿ç”¨timeè®°å½•å½“å‰å¯¹è±¡å»¶è¿Ÿåˆ°ä»€ä¹ˆæ—¶å€™å¯ä»¥ä½¿ç”¨ï¼Œä½¿ç”¨sequenceNumberæ¥æ ‡è¯†å…ƒç´ åœ¨é˜Ÿåˆ—ä¸­çš„å…ˆåé¡ºåºã€‚</span><br><span class="line"></span><br><span class="line">private static final AtomicLong sequencer = new AtomicLong(0);</span><br><span class="line">private class ScheduledFutureTask&lt;V&gt; extends FutureTask&lt;V&gt; implements RunnableScheduledFuture&lt;V&gt; &#123;</span><br><span class="line">ScheduledFutureTask(Runnable r, V result, long ns) &#123;</span><br><span class="line">    super(r, result);</span><br><span class="line">    this.time = ns;</span><br><span class="line">    this.period = 0;</span><br><span class="line">    this.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç¬¬äºŒæ­¥ï¼šå®ç°getDelayæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›å½“å‰å…ƒç´ è¿˜éœ€è¦å»¶æ—¶å¤šé•¿æ—¶é—´ï¼Œå•ä½æ˜¯çº³ç§’</span><br><span class="line"></span><br><span class="line">public long getDelay(TimeUnit unit) &#123;</span><br><span class="line">    return unit.convert(time - now(), TimeUnit.NANOSECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç¬¬ä¸‰æ­¥ï¼šå®ç°compareTo()æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ çš„é¡ºåºã€‚ä¾‹å¦‚ï¼Œè®©å»¶æ—¶æ—¶é—´æœ€é•¿çš„æ”¾åœ¨é˜Ÿåˆ—çš„æœ«å°¾ã€‚</span><br><span class="line"></span><br><span class="line">public int compareTo(Delayed other) &#123;</span><br><span class="line">    if (other == this) // compare zero ONLY if same object</span><br><span class="line">        return 0;</span><br><span class="line">    if (other instanceof ScheduledFutureTask) &#123;</span><br><span class="line">        ScheduledFutureTask&lt;?&gt; x = (ScheduledFutureTask&lt;?&gt;)other;</span><br><span class="line">        long diff = time - x.time;</span><br><span class="line">        if (diff &lt; 0)</span><br><span class="line">            return -1;</span><br><span class="line">        else if (diff &gt; 0)</span><br><span class="line">            return 1;</span><br><span class="line">        else if (sequenceNumber &lt; x.sequenceNumber)</span><br><span class="line">            return -1;</span><br><span class="line">        else</span><br><span class="line">            return 1;</span><br><span class="line">    &#125;</span><br><span class="line">    long d = (getDelay(TimeUnit.NANOSECONDS) -</span><br><span class="line">            other.getDelay(TimeUnit.NANOSECONDS));</span><br><span class="line">    return (d == 0) ? 0 : ((d &lt; 0) ? -1 : 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">b. å¦‚ä½•å®ç°å»¶æ—¶é˜»å¡é˜Ÿåˆ—</span><br><span class="line">å»¶æ—¶é˜»å¡é˜Ÿåˆ—çš„å®ç°å¾ˆç®€å•ï¼Œå½“æ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ æ—¶ï¼Œå¦‚æœå…ƒç´ æ²¡æœ‰è¾¾åˆ°å»¶æ—¶æ—¶é—´ï¼Œå°±é˜»å¡å½“å‰çº¿ç¨‹ã€‚</span><br><span class="line"></span><br><span class="line">public RunnableScheduledFuture take() throws InterruptedException &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    try &#123;</span><br><span class="line">        for (;;) &#123;</span><br><span class="line">            RunnableScheduledFuture first = queue[0];</span><br><span class="line">            if (first == null)</span><br><span class="line">                available.await();</span><br><span class="line">            else &#123;</span><br><span class="line">                long delay = first.getDelay(TimeUnit.NANOSECONDS);</span><br><span class="line">                if (delay &lt;= 0)</span><br><span class="line">                    return finishPoll(first);</span><br><span class="line">                else if (leader != null)</span><br><span class="line">                    available.await();</span><br><span class="line">                else &#123;</span><br><span class="line">                    Thread thisThread = Thread.currentThread();</span><br><span class="line">                    leader = thisThread;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        available.awaitNanos(delay);</span><br><span class="line">                    &#125; finally &#123;</span><br><span class="line">                        if (leader == thisThread)</span><br><span class="line">                            leader = null;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (leader == null &amp;&amp; queue[0] != null)</span><br><span class="line">            available.signal();</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä»£ç ä¸­çš„å˜é‡leaderæ˜¯ä¸€ä¸ªç­‰å¾…è·å–é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ çš„çº¿ç¨‹ã€‚</span><br><span class="line">å¦‚æœleaderä¸ç­‰äºç©ºï¼Œè¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹åœ¨ç­‰å¾…è·å–é˜Ÿåˆ—çš„å¤´å…ƒç´ ã€‚</span><br><span class="line">æ‰€ä»¥ï¼Œä½¿ç”¨await()æ–¹æ³•è®©å½“å‰çº¿ç¨‹ç­‰å¾…ä¿¡å·ã€‚</span><br><span class="line">å¦‚æœleaderç­‰äºç©ºï¼Œåˆ™æŠŠå½“å‰çº¿ç¨‹è®¾ç½®æˆleaderï¼Œå¹¶ä½¿ç”¨awaitNanos()æ–¹æ³•è®©å½“å‰çº¿ç¨‹ç­‰å¾…æ¥æ”¶ä¿¡å·æˆ–ç­‰å¾…delayæ—¶é—´ã€‚</span><br></pre></td></tr></table></figure>

<p>SynchronousQueue:    ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚</span><br><span class="line">å®ƒæ”¯æŒå…¬å¹³è®¿é—®é˜Ÿåˆ—.</span><br><span class="line">é»˜è®¤æƒ…å†µä¸‹çº¿ç¨‹é‡‡ç”¨éå…¬å¹³æ€§ç­–ç•¥è®¿é—®é˜Ÿåˆ—ã€‚åˆ›å»ºå…¬å¹³æ€§è®¿é—®çš„SynchronousQueueï¼Œå¦‚æœè®¾ç½®trueï¼Œåˆ™ç­‰å¾…çš„çº¿ç¨‹ä¼šé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„é¡ºåºè®¿é—®é˜Ÿåˆ—ã€‚</span><br><span class="line">è´Ÿè´£æŠŠç”Ÿäº§è€…çº¿ç¨‹å¤„ç†çš„æ•°æ®ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…çº¿ç¨‹ã€‚</span><br><span class="line">é˜Ÿåˆ—æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œéå¸¸é€‚åˆä¼ é€’æ€§åœºæ™¯ã€‚</span><br><span class="line">SynchronousQueueçš„ååé‡é«˜äºLinkedBlockingQueueå’ŒArrayBlockingQueueã€‚</span><br><span class="line">æœ‰ç‚¹åƒgoçš„channel</span><br></pre></td></tr></table></figure>

<p>LinkedTransferQueue:    ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">LinkedTransferQueueæ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡TransferQueueé˜Ÿåˆ—ã€‚</span><br><span class="line">ç›¸å¯¹äºå…¶å®ƒé˜»å¡é˜Ÿåˆ—ï¼ŒlinkedTransferQueueå¤šäº†tryTransferå’Œtransferæ–¹æ³•ã€‚</span><br><span class="line"></span><br><span class="line">ï¼ˆ1ï¼‰transferæ–¹æ³•</span><br><span class="line">å¦‚æœå½“å‰æœ‰æ¶ˆè´¹è€…æ­£åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ (æ¶ˆè´¹è€…ä½¿ç”¨take()æ–¹æ³•æˆ–å¸¦æœ‰æ—¶é—´é™åˆ¶çš„poll()æ–¹æ³•æ—¶)ï¼Œ</span><br><span class="line">transferæ–¹æ³•å¯ä»¥æŠŠç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ ç«‹åˆ»transfer(ä¼ è¾“)ç»™æ¶ˆè´¹è€…ã€‚</span><br><span class="line">å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œtransferæ–¹æ³•ä¼šå°†å…ƒç´ å­˜æ”¾åœ¨é˜Ÿåˆ—çš„tailèŠ‚ç‚¹ï¼Œå¹¶ç­‰åˆ°è¯¥å…ƒç´ è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚</span><br><span class="line">ä¼šè®©CPUè‡ªæ—‹ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹å…ƒç´ ã€‚</span><br><span class="line">å› ä¸ºè‡ªæ—‹ä¼šæ¶ˆè€—CPUï¼Œæ‰€ä»¥è‡ªæ—‹ä¸€å®šçš„æ¬¡æ•°åä½¿ç”¨Thread.yield()æ–¹æ³•æ¥æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå…¶å®ƒçº¿ç¨‹ã€‚</span><br><span class="line"></span><br><span class="line">ï¼ˆ2ï¼‰tryTransferæ–¹æ³•</span><br><span class="line">tryTransferæ–¹æ³•æ˜¯ç”¨æ¥è¯•æ¢ç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ æ˜¯å¦èƒ½ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…ã€‚</span><br><span class="line">å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œåˆ™è¿”å›falseã€‚</span><br><span class="line">å’Œtransferæ–¹æ³•çš„åŒºåˆ«æ˜¯tryTransferæ–¹æ³•æ— è®ºæ¶ˆè´¹è€…æ˜¯å¦æ¥æ”¶ï¼Œæ–¹æ³•ç«‹å³è¿”å›ï¼Œ</span><br><span class="line">è€Œtransferæ–¹æ³•æ˜¯å¿…é¡»ç­‰åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚</span><br><span class="line"></span><br><span class="line">å¯¹äºå¸¦æœ‰æ—¶é—´é™åˆ¶çš„tryTransfer(E e,long timeout,TimeUnit unit)æ–¹æ³•ï¼Œ</span><br><span class="line">è¯•å›¾æŠŠç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ ç›´æ¥ä¼ ç»™æ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹è¯¥å…ƒç´ åˆ™ç­‰å¾…æŒ‡å®šçš„æ—¶é—´å†è¿”å›ã€‚</span><br><span class="line">å¦‚æœè¶…æ—¶è¿˜æ²¡æœ‰æ¶ˆè´¹å…ƒç´ ï¼Œåˆ™è¿”å›falseï¼Œå¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ¶ˆè´¹äº†å…ƒç´ ï¼Œåˆ™è¿”å›true.</span><br></pre></td></tr></table></figure>

<p>LinkedBlockingDeque:    ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LinkedBlockingDequeæ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</span><br><span class="line">æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„æ˜¯å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚</span><br><span class="line">åŒå‘é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚</span><br><span class="line">ç›¸æ¯”å…¶å®ƒçš„é˜»å¡é˜Ÿåˆ—ï¼ŒLinkedBlockingDequeå¤šäº†addFirst,addLast,offerFirst,offerLast,peekFirstå’ŒpeekLastç­‰æ–¹æ³•ï¼Œ</span><br><span class="line">ä»¥Firstå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–(peek)æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</span><br><span class="line">ä»¥Lastå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ï¼Œè·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</span><br><span class="line">å¦å¤–ï¼Œæ’å…¥æ–¹æ³•addç­‰åŒäºaddLastï¼Œç§»é™¤æ–¹æ³•removeç­‰æ•ˆäºremoveFirstã€‚ä½†æ˜¯takeæ–¹æ³•å´ç­‰åŒäºtakeFirst.</span><br><span class="line"></span><br><span class="line">åœ¨åˆå§‹åŒ–LinkedBlockingDequeæ—¶å¯ä»¥è®¾ç½®å®¹é‡é˜²æ­¢å…¶è¿‡åº¦è†¨èƒ€ã€‚å¦å¤–åŒå‘é˜»å¡é˜Ÿåˆ—å¯ä»¥è¿ç”¨åœ¨&quot;å·¥ä½œçªƒå–&quot;æ¨¡å¼ä¸­ã€‚</span><br></pre></td></tr></table></figure>

<h4 id="âœ…é˜»å¡é˜Ÿåˆ—çš„å®ç°åŸç†"><a href="#âœ…é˜»å¡é˜Ÿåˆ—çš„å®ç°åŸç†" class="headerlink" title="âœ…é˜»å¡é˜Ÿåˆ—çš„å®ç°åŸç†"></a>âœ…é˜»å¡é˜Ÿåˆ—çš„å®ç°åŸç†</h4><p>ä½¿ç”¨é€šçŸ¥æ¨¡å¼å®ç°ã€‚æ‰€è°“é€šçŸ¥æ¨¡å¼ï¼Œå°±æ˜¯å½“ç”Ÿäº§è€…å¾€æ»¡çš„é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ æ—¶ä¼šé˜»å¡ä½ç”Ÿäº§è€…ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹äº†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„å…ƒç´ åï¼Œä¼šé€šçŸ¥ç”Ÿäº§è€…å½“å‰é˜Ÿåˆ—å¯ç”¨ã€‚é€šè¿‡æŸ¥çœ‹JDKæºä»£ç å‘ç°ArrayBlockingQueueä½¿ç”¨äº†Conditionæ¥å®ç°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">notEmpty = lock.newCondition();</span><br><span class="line">notFull = lock.newChonditon();</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœé˜Ÿåˆ—æ»¡ï¼šæ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé€šè¿‡è°ƒç”¨notFull.await()é˜»å¡å½“å‰çº¿ç¨‹ï¼›ç§»é™¤å…ƒç´ é¢æ—¶å€™ï¼Œç”¨notFull.signal()å”¤é†’åœ¨notFullä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚</li>
<li>å¦‚æœé˜Ÿåˆ—ç©ºï¼šè¯»å–å…ƒç´ çš„æ—¶å€™ï¼Œé€šè¿‡notEmpty.await()é˜»å¡å½“å‰çº¿ç¨‹ï¼›å½“æ·»åŠ å…ƒç´ æ—¶ï¼Œè°ƒç”¨notEmpty.signal()å”¤é†’åœ¨notEmptyä¸Šç­‰å¾…çš„çº¿ç¨‹ã€‚</li>
</ul>
<p>é˜»å¡ç”Ÿäº§è€…await()ä¸»è¦é€šè¿‡LockSupport.park(this)æ¥å®ç°ã€‚å…¶ä¸­ï¼Œé¦–å…ˆè°ƒç”¨setBlockerå…ˆä¿å­˜ä¸€ä¸‹å°†è¦é˜»å¡çš„çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨unsafe.parké˜»å¡å½“å‰çº¿ç¨‹ã€‚</p>
<h3 id="4-Fork-Joinæ¡†æ¶"><a href="#4-Fork-Joinæ¡†æ¶" class="headerlink" title="4.Fork/Joinæ¡†æ¶"></a>4.Fork/Joinæ¡†æ¶</h3><p>Fork/Joinæ¡†æ¶æ˜¯Java 7 æä¾›çš„ä¸€ä¸ªç”¨äºå¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªæŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡ç»“æœåå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„æ¡†æ¶ã€‚</p>
<h4 id="âœ…å·¥ä½œçªƒå–-work-stealing-ç®—æ³•"><a href="#âœ…å·¥ä½œçªƒå–-work-stealing-ç®—æ³•" class="headerlink" title="âœ…å·¥ä½œçªƒå–(work-stealing)ç®—æ³•"></a>âœ…å·¥ä½œçªƒå–(work-stealing)ç®—æ³•</h4><p>å·¥ä½œçªƒå–(work-stealing)ç®—æ³•æ˜¯æŒ‡æŸä¸ªçº¿ç¨‹ä»å…¶ä»–é˜Ÿåˆ—é‡Œçªƒå–ä»»åŠ¡æ¥æ‰§è¡Œã€‚</p>
<p>åšä¸€ä¸ªæ¯”è¾ƒå¤§çš„ä»»åŠ¡ï¼Œå¯ä»¥æŠŠè¿™ä¸ªä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²äº’ä¸ä¾èµ–çš„å­ä»»åŠ¡ï¼Œä¸ºäº†å‡å°‘çº¿ç¨‹é—´çš„ç«äº‰ï¼ŒæŠŠè¿™äº›å­ä»»åŠ¡åˆ†åˆ«æ”¾åˆ°ä¸åŒçš„é˜Ÿåˆ—é‡Œï¼Œå¹¶ä¸ºæ¯ä¸ªé˜Ÿåˆ—åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œçº¿ç¨‹å’Œé˜Ÿåˆ—ä¸€ä¸€å¯¹åº”ã€‚<br>æ¯”å¦‚Açº¿ç¨‹è´Ÿè´£å¤„ç†Aé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œæœ‰çš„çº¿ç¨‹ä¼šæŠŠè‡ªå·±é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¹²å®Œï¼Œè€Œå…¶å®ƒçº¿ç¨‹å¯¹åº”çš„é˜Ÿåˆ—é‡Œè¿˜æœ‰ä»»åŠ¡ç­‰å¾…å¤„ç†ã€‚å¹²å®Œæ´»çš„çº¿ç¨‹ä¸å…¶ç­‰ç€ï¼Œä¸å¦‚å»å¸®å…¶ä»–çº¿ç¨‹å¹²æ´»ï¼Œäºæ˜¯å®ƒå°±å»å…¶ä»–çº¿ç¨‹é˜Ÿåˆ—é‡Œçªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚è€Œåœ¨è¿™æ—¶å®ƒä»¬ä¼šè®¿é—®åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ºäº†å‡å°‘çªƒå–ä»»åŠ¡çº¿ç¨‹å’Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œé€šå¸¸ä½¿ç”¨åŒç«¯é˜Ÿåˆ—ï¼Œè¢«çªƒå–ä»»åŠ¡çº¿ç¨‹æ°¸è¿œä»åŒç«¯é˜Ÿåˆ—å¤´éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œè€Œçªƒå–ä»»åŠ¡çš„çº¿ç¨‹æ°¸è¿œä»åŒé˜Ÿåˆ—çš„å°¾éƒ¨æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚</p>
<p>å·¥ä½œçªƒå–ç®—æ³•çš„ä¼˜ç‚¹ï¼šå……åˆ†åˆ©ç”¨çº¿ç¨‹è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œå‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ã€‚</p>
<p>å·¥ä½œçªƒå–ç®—æ³•çš„ç¼ºç‚¹ï¼šåœ¨æŸäº›æƒ…å†µä¸‹è¿˜æ˜¯å­˜åœ¨ç«äº‰ï¼Œæ¯”å¦‚åŒç«¯é˜Ÿåˆ—é‡Œåªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ã€‚å¹¶ä¸”è¯¥ç®—æ³•ä¼šæ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚åˆ›å»ºå¤šä¸ªçº¿ç¨‹å’Œå¤šä¸ªåŒç«¯é˜Ÿåˆ—ã€‚</p>
<h4 id="âœ…Fork-Joinæ¡†æ¶çš„è®¾è®¡"><a href="#âœ…Fork-Joinæ¡†æ¶çš„è®¾è®¡" class="headerlink" title="âœ…Fork/Joinæ¡†æ¶çš„è®¾è®¡"></a>âœ…Fork/Joinæ¡†æ¶çš„è®¾è®¡</h4><p>æ­¥éª¤1ï¼šåˆ†å‰²ä»»åŠ¡ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªforkç±»æ¥æŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆå­ä»»åŠ¡ï¼Œæœ‰å¯èƒ½å­ä»»åŠ¡è¿˜æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸åœåœ°åˆ†å‰²ï¼Œç›´åˆ°åˆ†å‰²å‡ºçš„å­ä»»åŠ¡è¶³å¤Ÿå°ã€‚</p>
<p>æ­¥éª¤2ï¼šæ‰§è¡Œä»»åŠ¡å¹¶åˆå¹¶ç»“æœã€‚åˆ†å‰²çš„å­ä»»åŠ¡åˆ†åˆ«æ”¾åœ¨åŒç«¯é˜Ÿåˆ—ï¼Œç„¶åå‡ ä¸ªå¯åŠ¨çº¿ç¨‹åˆ†åˆ«ä»åŒç«¯é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡æ‰§è¡Œã€‚å­ä»»åŠ¡æ‰§è¡Œå®Œçš„ç»“æœéƒ½ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—é‡Œæ‹¿æ•°æ®ï¼Œç„¶ååˆå¹¶è¿™äº›æ•°æ®ã€‚</p>
<p>Fork/Joinä½¿ç”¨ä¸¤ä¸ªç±»æ¥å®Œæˆä»¥ä¸Šä¸¤ä¸ªäº‹æƒ…ï¼š</p>
<p>1)ForkJoinTaskï¼šæˆ‘ä»¬è¦ä½¿ç”¨ForkJoinæ¡†æ¶ï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ªForkJoinä»»åŠ¡ã€‚å®ƒæä¾›åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œfork()å’Œjoin()æ“ä½œçš„æœºåˆ¶ã€‚<br>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç›´æ¥ç»§æ‰¿ForkJoinTaskç±»ï¼Œåªéœ€è¦ç»§æ‰¿å®ƒçš„å­ç±»ï¼ŒFork/Joinæ¡†æ¶æä¾›äº†ä»¥ä¸‹ä¸¤ä¸ªå­ç±»ã€‚<br>a.RecursiveAction: ç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚<br>b.RecursiveTask:ç”¨äºæœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚</p>
<p>2ï¼‰ForkJoinPoolï¼šForkJoinTaskéœ€è¦é€šè¿‡ForkJoinPoolæ¥æ‰§è¡Œã€‚</p>
<p>ä»»åŠ¡åˆ†å‰²å‡ºçš„å­ä»»åŠ¡ä¼šæ·»åŠ åˆ°å½“å‰å·¥ä½œçº¿ç¨‹æ‰€ç»´æŠ¤çš„åŒç«¯é˜Ÿåˆ—ä¸­ï¼Œè¿›å…¥é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å½“ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„é˜Ÿåˆ—é‡Œæš‚æ—¶æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œå®ƒä¼šéšæœºä»å…¶ä»–å·¥ä½œçº¿ç¨‹é˜Ÿåˆ—çš„å°¾éƒ¨è·å–ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<h4 id="âœ…ä½¿ç”¨Fork-Joinçš„ä¾‹å­"><a href="#âœ…ä½¿ç”¨Fork-Joinçš„ä¾‹å­" class="headerlink" title="âœ…ä½¿ç”¨Fork/Joinçš„ä¾‹å­"></a>âœ…ä½¿ç”¨Fork/Joinçš„ä¾‹å­</h4><p>è®¡ç®—1+2+3+4çš„ç»“æœï¼š</p>
<p>1.å¦‚ä½•forkï¼šè®¾ç½®åˆ†å‰²çš„é˜ˆå€¼æ˜¯2ï¼Œç”±äºæ˜¯4ä¸ªæ•°å­—ç›¸åŠ ï¼Œæ‰€ä»¥Fork/Joinæ¡†æ¶ä¼šæŠŠè¿™ä¸ªä»»åŠ¡forkæˆä¸¤ä¸ªå­ä»»åŠ¡</p>
<p>2.å¦‚ä½•joinï¼šjoinä¸¤ä¸ªå­ä»»åŠ¡çš„ç»“æœã€‚å› ä¸ºæ˜¯æœ‰ç»“æœçš„ä»»åŠ¡ï¼Œå› æ­¤å¿…é¡»ç»§æ‰¿RecursiveTask</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">public class CountTask extends RecursiveTask&lt;Integer&gt;&#123;</span><br><span class="line"> </span><br><span class="line">    private static final int THRESHOLD = 2;//é˜ˆå€¼</span><br><span class="line"> </span><br><span class="line">    private int start;</span><br><span class="line"> </span><br><span class="line">    private int end;</span><br><span class="line"> </span><br><span class="line">    public CountTask(int start,int end)&#123;</span><br><span class="line">        this.start = start;</span><br><span class="line">        this.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    protected Integer compute() &#123;</span><br><span class="line">        int sum = 0;</span><br><span class="line">        // å¦‚æœä»»åŠ¡è¶³å¤Ÿå°å°±è®¡ç®—ä»»åŠ¡</span><br><span class="line">        boolean canCompute = (end - start) &lt;= THRESHOLD;</span><br><span class="line">        if (canCompute)&#123;</span><br><span class="line">            for (int i=start;i&lt;=end;i++)&#123;</span><br><span class="line">                sum += i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            // å¦‚æœä»»åŠ¡å¤§äºé˜ˆå€¼ï¼Œå°±åˆ†è£‚æˆä¸¤ä¸ªå­ä»»åŠ¡è®¡ç®—</span><br><span class="line">            int middle = (start + end)/2;</span><br><span class="line">            CountTask leftTask = new CountTask(start,middle);</span><br><span class="line">            CountTask rightTask = new CountTask(middle+1,end);</span><br><span class="line"> </span><br><span class="line">            // æ‰§è¡Œå­ä»»åŠ¡</span><br><span class="line">            leftTask.fork();</span><br><span class="line">            rightTask.fork();</span><br><span class="line"> </span><br><span class="line">            // ç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå¹¶å¾—åˆ°ç»“æœ</span><br><span class="line">            int leftResult = leftTask.join();</span><br><span class="line">            int rightResult = rightTask.join();</span><br><span class="line"> </span><br><span class="line">            // åˆå¹¶å­ä»»åŠ¡</span><br><span class="line">            sum = leftResult + rightResult;</span><br><span class="line">        &#125;</span><br><span class="line">        return sum;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        ForkJoinPool forkJoinPool = new ForkJoinPool();</span><br><span class="line">        // ç”Ÿæˆä¸€ä¸ªè®¡ç®—ä»»åŠ¡ï¼Œè´Ÿè´£è®¡ç®— 1+2+3+4</span><br><span class="line">        CountTask task = new CountTask(1,4);</span><br><span class="line">        // æ‰§è¡Œä¸€ä¸ªä»»åŠ¡</span><br><span class="line">        Future&lt;Integer&gt; result = forkJoinPool.submit(task);</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;é­”æ³•é©çš„æ—¥å¿—ä¿¡æ¯ï¼š----&gt;&quot;+ result.get());</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>forkæ–¹æ³•æ˜¯æ‰§è¡Œï¼Œjoinæ–¹æ³•æ˜¯ç­‰å¾…æ‰§è¡Œå®Œè·å–è¿è¡Œç»“æœã€‚éœ€è¦å®ç°computeræ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œçœ‹æ€ä¹ˆæ‹†åˆ†ä»»åŠ¡ï¼Œæ¯ä¸ªå­ä»»åŠ¡åœ¨è°ƒç”¨forkæ–¹æ³•æ—¶ï¼Œåˆä¼šè¿›å…¥computeæ–¹æ³•ï¼Œçœ‹çœ‹å½“å‰å­ä»»åŠ¡æ˜¯å¦éœ€è¦ç»§ç»­åˆ†å‰²æˆå­ä»»åŠ¡ï¼Œå¦‚æœä¸éœ€è¦ç»§ç»­åˆ†å‰²ï¼Œåˆ™æ‰§è¡Œå½“å‰å­ä»»åŠ¡å¹¶è¿”å›ç»“æœã€‚ä½¿ç”¨joinæ–¹æ³•ä¼šç­‰å¾…å­ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶å¾—åˆ°ç»“æœã€‚</p>
<h4 id="âœ…Fork-Joinæ¡†æ¶çš„å¼‚å¸¸å¤„ç†"><a href="#âœ…Fork-Joinæ¡†æ¶çš„å¼‚å¸¸å¤„ç†" class="headerlink" title="âœ…Fork/Joinæ¡†æ¶çš„å¼‚å¸¸å¤„ç†"></a>âœ…Fork/Joinæ¡†æ¶çš„å¼‚å¸¸å¤„ç†</h4><p>ForkJoinTaskåœ¨æ‰§è¡Œçš„æ—¶å€™å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡åŠæ³•åœ¨ä¸»çº¿ç¨‹é‡Œç›´æ¥æ•è·å¼‚å¸¸ï¼Œæ‰€ä»¥ForkJoinTaskæä¾›äº†isCompletedAbnormally()æ–¹æ³•æ¥æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²ç»æŠ›å‡ºå¼‚å¸¸æˆ–å·²ç»è¢«å–æ¶ˆäº†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ForkJoinTaskçš„getExceptionæ–¹æ³•è·å–å¼‚å¸¸ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (task.isCompletedAbnormally())&#123;</span><br><span class="line">    System.out.println(task.getException());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getExceptionæ–¹æ³•è¿”å›Throwableå¯¹è±¡ï¼Œå¦‚æœä»»åŠ¡è¢«å–æ¶ˆäº†åˆ™è¿”å›CancellationExceptionã€‚å¦‚æœä»»åŠ¡æ²¡æœ‰å®Œæˆæˆ–è€…æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸åˆ™è¿”å› nullã€‚</p>
<h4 id="âœ…Fork-Joinæ¡†æ¶çš„å®ç°åŸç†"><a href="#âœ…Fork-Joinæ¡†æ¶çš„å®ç°åŸç†" class="headerlink" title="âœ…Fork/Joinæ¡†æ¶çš„å®ç°åŸç†"></a>âœ…Fork/Joinæ¡†æ¶çš„å®ç°åŸç†</h4><p>ForkJoinPoolç”±ForkJoinTaskæ•°ç»„å’ŒForkJoinWorkerThreadæ•°ç»„ç»„æˆçš„ï¼ŒForkJoinTaskæ•°ç»„è´Ÿè´£å°†å­˜æ”¾ç¨‹åºæäº¤ç»™ForkJoinPoolçš„ä»»åŠ¡ï¼Œè€ŒForkJoinWorkerThreadæ•°ç»„è´Ÿè´£æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚</p>
<p>ï¼ˆ1ï¼‰forkæ–¹æ³•å®ç°åŸç†ï¼š</p>
<p>è°ƒç”¨ForkJoinTaskçš„fork()æ–¹æ³•æ—¶ï¼Œç¨‹åºä¼šè°ƒç”¨ForkJoinWorkerThreadçš„pushTaskæ–¹æ³•å¼‚æ­¥åœ°æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œç„¶åç«‹å³è¿”å›ç»“æœã€‚</p>
<p>pushTaskæ–¹æ³•æŠŠå½“å‰ä»»åŠ¡å­˜æ”¾åœ¨ForkJoinTaskæ•°ç»„é˜Ÿåˆ—é‡Œã€‚ç„¶åå†è°ƒç”¨ForkJoinPoolçš„signalWork()æ–¹æ³•å”¤é†’æˆ–åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p>
<p>ï¼ˆ2ï¼‰joinæ–¹æ³•å®ç°åŸç†</p>
<p>Joinæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯é˜»å¡å½“å‰çº¿ç¨‹å¹¶ç­‰å¾…è·å–ç»“æœã€‚</p>
<p>å®ƒè°ƒç”¨äº†doJoin()æ–¹æ³•ï¼Œé€šè¿‡doJoin()æ–¹æ³•å¾—åˆ°å½“å‰ä»»åŠ¡çš„çŠ¶æ€æ¥åˆ¤æ–­è¿”å›ä»€ä¹ˆç»“æœï¼Œä»»åŠ¡çŠ¶æ€æœ‰4ç§ï¼š<br>å·²å®Œæˆ(NORMAL)ï¼Œè¢«å–æ¶ˆ(CANCELLED)ï¼Œä¿¡å·(SIGNAL)å’Œå‡ºç°å¼‚å¸¸(EXCEPTION)ã€‚</p>
<p>a. å¦‚æœä»»åŠ¡çŠ¶æ€å·²å®Œæˆï¼Œåˆ™ç›´æ¥è¿”å›ä»»åŠ¡ç»“æœã€‚<br>b. å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯è¢«å–æ¶ˆï¼Œåˆ™ç›´æ¥æŠ›å‡ºCancellationExceptionã€‚<br>c. å¦‚æœä»»åŠ¡çŠ¶æ€æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¯¹åº”çš„å¼‚å¸¸ã€‚</p>
<p>åœ¨doJoin()æ–¹æ³•é‡Œï¼Œé¦–å…ˆé€šè¿‡ä»»åŠ¡çš„çŠ¶æ€ï¼Œçœ‹ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆï¼Œå¦‚æœæ‰§è¡Œå®Œæˆï¼Œåˆ™ç›´æ¥è¿”å›ä»»åŠ¡çŠ¶æ€ï¼›å¦‚æœæ²¡æœ‰æ‰§è¡Œå®Œï¼Œåˆ™ä»ä»»åŠ¡æ•°ç»„é‡Œå–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œã€‚<br>å¦‚æœä»»åŠ¡é¡ºåˆ©æ‰§è¡Œå®Œæˆï¼Œåˆ™è®¾ç½®ä»»åŠ¡çŠ¶æ€ä¸ºNORMALï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™è®°å½•å¼‚å¸¸ï¼Œå¹¶å°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸ºEXCEPTIONALã€‚</p>
<h2 id="ç¬¬ä¸ƒç« -javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±»"><a href="#ç¬¬ä¸ƒç« -javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±»" class="headerlink" title="ç¬¬ä¸ƒç«  javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±»"></a>ç¬¬ä¸ƒç«  javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±»</h2><p>å¤šçº¿ç¨‹åŒæ—¶æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨synchronizedæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œsynchronizedä¼šä¿è¯å¤šçº¿ç¨‹ä¸ä¼šåŒæ—¶æ›´æ–°å˜é‡iã€‚</p>
<p>Javaä»JDK 1.5å¼€å§‹æä¾›äº†java.util.concurrent.atomicåŒ…ï¼ˆä»¥ä¸‹ç®€ç§°AtomicåŒ…ï¼‰ï¼Œè¿™ä¸ªåŒ…ä¸­çš„åŸå­æ“ä½œç±»æä¾›äº†ä¸€ç§ç”¨æ³•ç®€å•ã€æ€§èƒ½é«˜æ•ˆã€çº¿ç¨‹å®‰å…¨åœ°æ›´æ–°ä¸€ä¸ªå˜é‡çš„æ–¹å¼ã€‚</p>
<p>AtomicåŒ…é‡Œä¸€å…±æä¾›äº†13ä¸ªç±»ï¼Œå±äº4ç§ç±»å‹çš„åŸå­æ›´æ–°æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ã€åŸå­æ›´æ–°æ•°ç»„ã€åŸå­æ›´æ–°å¼•ç”¨å’ŒåŸå­æ›´æ–°å±æ€§ï¼ˆå­—æ®µï¼‰ã€‚AtomicåŒ…é‡Œçš„ç±»åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨Unsafeå®ç°çš„åŒ…è£…ç±»ã€‚</p>
<blockquote>
<p>Unsafeç±»ä½äºsun.miscåŒ…ä¸‹ï¼Œå®ƒæ˜¯javaå®ç°é«˜å¹¶å‘çš„åŸºç¡€ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰§è¡Œä¸€äº›ä¸å®‰å…¨çš„æ“ä½œï¼Œå¦‚åƒCè¯­è¨€ä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜èµ„æºï¼Œ<br>å®ƒæä¾›çš„è¿™äº›æ–¹æ³•å¢å¼ºäº†javaå¯¹åº•å±‚èµ„æºçš„æ“ä½œèƒ½åŠ›ï¼Œä½†åŒæ—¶ä¹Ÿå¢åŠ äº†ç¨‹åºå‡ºé”™çš„é£é™©.<br>Unsafeæä¾›çš„APIå¤§è‡´å¯åˆ†ä¸ºå†…å­˜æ“ä½œã€CASã€Classç›¸å…³ã€å¯¹è±¡æ“ä½œã€çº¿ç¨‹è°ƒåº¦ã€ç³»ç»Ÿä¿¡æ¯è·å–ã€å†…å­˜å±éšœç›¸å…³ã€æ•°ç»„ç›¸å…³ç­‰ã€‚</p>
</blockquote>
<blockquote>
<p>CAS(compareAndSwap)å³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œæ˜¯å®ç°å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨åˆ°çš„ä¸€ç§æŠ€æœ¯ã€‚CASåº•å±‚ä¸ºä¸€æ¡åŸå­æŒ‡ä»¤cmpxchgï¼Œå¯ä»¥ä¿è¯åŸå­æ€§ï¼ŒUnsafeæä¾›çš„CASæ–¹æ³•å¦‚compareAndSwapIntåº•å±‚å°±æ˜¯CPUæŒ‡ä»¤cmpxchgã€‚<br>CASåœ¨javaå¹¶å‘åŒ…ä¸­çš„åŸå­ç±»å¦‚AtomicIntegerï¼ŒAQS(AbstractQueuedSynchronizer)ï¼ŒConcurrentHashMapç­‰å®ç°ä¸­éƒ½æœ‰å¹¿æ³›çš„ä½¿ç”¨ã€‚<br>å› æ­¤ï¼Œä¸ç®¡æ˜¯Atomicè¿˜æ˜¯ä»€ä¹ˆé”é‡Œçš„CASéƒ½ä¾æ‰˜äºUnsafeåŒ…é‡Œçš„æ–¹æ³•ã€‚</p>
</blockquote>
<p>Unsafeç±»ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/strongmore/p/15468423.html">https://www.cnblogs.com/strongmore/p/15468423.html</a></p>
<h3 id="1-åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ç±»"><a href="#1-åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ç±»" class="headerlink" title="1.åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ç±»"></a>1.åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ç±»</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä¸‰ä¸ªç±»ï¼š</span><br><span class="line">Â· AtomicBooleanï¼šåŸå­æ›´æ–°å¸ƒå°”ç±»å‹ã€‚</span><br><span class="line">Â· AtomicIntegerï¼šåŸå­æ›´æ–°æ•´å‹ã€‚</span><br><span class="line">Â· AtomicLongï¼šåŸå­æ›´æ–°é•¿æ•´å‹ã€‚</span><br><span class="line"></span><br><span class="line">AtomicIntegerä¸ºä¾‹ï¼š</span><br><span class="line">Â· int addAndGetï¼ˆint deltaï¼‰ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ï¼ˆAtomicIntegeré‡Œçš„valueï¼‰ç›¸åŠ ï¼Œå¹¶è¿”å›ç»“æœã€‚</span><br><span class="line"></span><br><span class="line">Â· boolean compareAndSetï¼ˆint expectï¼Œint updateï¼‰ï¼šå¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥çš„å€¼ã€‚</span><br><span class="line"></span><br><span class="line">Â· int getAndIncrement()ï¼šä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ 1ï¼Œæ³¨æ„ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼ã€‚</span><br><span class="line"></span><br><span class="line">Â· void lazySetï¼ˆint newValueï¼‰ï¼šæœ€ç»ˆä¼šè®¾ç½®æˆnewValueï¼Œä½¿ç”¨lazySetè®¾ç½®å€¼åï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span><br><span class="line"></span><br><span class="line">Â·int getAndSetï¼ˆint newValueï¼‰ï¼šä»¥åŸå­æ–¹å¼è®¾ç½®ä¸ºnewValueçš„å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ã€‚</span><br></pre></td></tr></table></figure>

<p>æºç åˆ†æï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public final int getAndIncrement() &#123;</span><br><span class="line">  for (;;) &#123;</span><br><span class="line">    int current = get(); </span><br><span class="line">    int next = current + 1;</span><br><span class="line">    if (compareAndSet(current, next)) </span><br><span class="line">        return current;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public final boolean compareAndSet(int expect, int update) &#123;</span><br><span class="line">    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AtomicåŒ…é‡Œçš„ç±»åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨Unsafeå®ç°çš„.<br>Unsafeåªæä¾›äº†3ç§CASæ–¹æ³•ï¼šcompareAndSwapObjectã€compare- AndSwapIntå’ŒcompareAndSwapLong.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public final native boolean compareAndSwapObject(Object o,  long offset, Object expected, Object x);  </span><br><span class="line">  </span><br><span class="line">public final native boolean compareAndSwapInt(Object o, long offset,  int expected, int x);  </span><br><span class="line">  </span><br><span class="line">public final native boolean compareAndSwapLong(Object o, long offset,  long expected, long x);  </span><br></pre></td></tr></table></figure>

<h3 id="2-åŸå­æ›´æ–°æ•°ç»„"><a href="#2-åŸå­æ›´æ–°æ•°ç»„" class="headerlink" title="2.åŸå­æ›´æ–°æ•°ç»„"></a>2.åŸå­æ›´æ–°æ•°ç»„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ä¸‰ä¸ªç±»ï¼š</span><br><span class="line">Â· AtomicIntegerArrayï¼šåŸå­æ›´æ–°æ•´å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚</span><br><span class="line">Â· AtomicLongArrayï¼šåŸå­æ›´æ–°é•¿æ•´å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚</span><br><span class="line">Â· AtomicReferenceArrayï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚</span><br><span class="line"></span><br><span class="line">AtomicIntegerArrayä¸ºä¾‹ï¼š</span><br><span class="line">Â· int addAndGetï¼ˆint iï¼Œint deltaï¼‰ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥å€¼ä¸æ•°ç»„ä¸­ç´¢å¼•içš„å…ƒç´ ç›¸åŠ ã€‚</span><br><span class="line"></span><br><span class="line">Â· boolean compareAndSetï¼ˆint iï¼Œint expectï¼Œint updateï¼‰ï¼šå¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†æ•°ç»„ä½ç½®içš„å…ƒç´ è®¾ç½®æˆupdateå€¼ã€‚</span><br><span class="line"></span><br><span class="line">static int[] value = new int[] &#123; 1ï¼Œ 2 &#125;;  </span><br><span class="line">static AtomicIntegerArray ai = new AtomicIntegerArray(value); </span><br><span class="line">ai.getAndSet(0ï¼Œ 3);</span><br><span class="line">System.out.println(ai.get(0)); //3</span><br><span class="line">System.out.println(value[0]);  //1</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•°ç»„valueé€šè¿‡æ„é€ æ–¹æ³•ä¼ é€’è¿›å»ï¼Œç„¶åAtomicIntegerArrayä¼šå°†å½“å‰æ•°ç»„å¤åˆ¶ä¸€ä»½ï¼Œæ‰€ä»¥å½“AtomicIntegerArrayå¯¹å†…éƒ¨çš„æ•°ç»„å…ƒç´ è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¸ä¼šå½±å“ä¼ å…¥çš„æ•°ç»„ã€‚</p>
<h3 id="3-åŸå­æ›´æ–°å¼•ç”¨ç±»å‹"><a href="#3-åŸå­æ›´æ–°å¼•ç”¨ç±»å‹" class="headerlink" title="3.åŸå­æ›´æ–°å¼•ç”¨ç±»å‹"></a>3.åŸå­æ›´æ–°å¼•ç”¨ç±»å‹</h3><p>åŸå­æ›´æ–°åŸºæœ¬ç±»å‹çš„AtomicIntegerï¼Œåªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœè¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨è¿™ä¸ªåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æä¾›çš„ç±»ã€‚AtomicåŒ…æä¾›äº†ä»¥ä¸‹3ä¸ªç±»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Â· AtomicReferenceï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹ã€‚</span><br><span class="line">Â· AtomicReferenceFieldUpdaterï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µã€‚</span><br><span class="line">Â· AtomicMarkableReferenceï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹ã€‚å¯ä»¥åŸå­æ›´æ–°ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„æ ‡è®°ä½å’Œå¼•ç”¨ç±»å‹ã€‚æ„é€ æ–¹æ³•æ˜¯AtomicMarkableReferenceï¼ˆV initialRefï¼Œboolean initialMarkï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">AtomicReferenceä¸ºä¾‹ï¼š</span><br><span class="line"></span><br><span class="line">public class AtomicReferenceTest &#123;</span><br><span class="line"></span><br><span class="line">    public static AtomicReference&lt;user&gt; atomicUserRef = new AtomicReference&lt;user&gt;();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        User user = new User(&quot;conan&quot;ï¼Œ 15); atomicUserRef.set(user);</span><br><span class="line">        User updateUser = new User(&quot;Shinichi&quot;ï¼Œ 17); atomicUserRef.compareAndSet(userï¼Œ updateUser);</span><br><span class="line">        System.out.println(atomicUserRef.get().getName());</span><br><span class="line">        System.out.println(atomicUserRef.get().getOld());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-åŸå­æ›´æ–°å­—æ®µç±»"><a href="#4-åŸå­æ›´æ–°å­—æ®µç±»" class="headerlink" title="4.åŸå­æ›´æ–°å­—æ®µç±»"></a>4.åŸå­æ›´æ–°å­—æ®µç±»</h3><p>æ›´æ–°é™æ€ç±»é‡Œçš„æˆå‘˜å˜é‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Â· AtomicIntegerFieldUpdaterï¼šåŸå­æ›´æ–°æ•´å‹çš„å­—æ®µçš„æ›´æ–°å™¨ã€‚</span><br><span class="line">Â· AtomicLongFieldUpdaterï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨ã€‚</span><br><span class="line">Â· AtomicStampedReferenceï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºåŸå­çš„æ›´æ–°æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨CASè¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ABAé—®é¢˜ã€‚</span><br></pre></td></tr></table></figure>

<p>è¦æƒ³åŸå­åœ°æ›´æ–°å­—æ®µç±»éœ€è¦ä¸¤æ­¥ã€‚ç¬¬ä¸€æ­¥ï¼Œå› ä¸ºåŸå­æ›´æ–°å­—æ®µç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³•newUpdater()åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚ç¬¬äºŒæ­¥ï¼Œæ›´æ–°ç±»çš„å­—æ®µï¼ˆå±æ€§ï¼‰å¿…é¡»ä½¿ç”¨public volatileä¿®é¥°ç¬¦ã€‚</p>
<p>AstomicIntegerFieldUpdaterä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class AtomicIntegerFieldUpdaterTest &#123;</span><br><span class="line"></span><br><span class="line">   // åˆ›å»ºåŸå­æ›´æ–°å™¨ï¼Œå¹¶è®¾ç½®éœ€è¦æ›´æ–°çš„å¯¹è±¡ç±»å’Œå¯¹è±¡çš„å±æ€§</span><br><span class="line">    private static AtomicIntegerFieldUpdater&lt;User&gt; a = AtomicIntegerFieldUpdater.newUpdater(User.classï¼Œ &quot;old&quot;);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        User conan = new User(&quot;conan&quot;ï¼Œ 10);</span><br><span class="line">        System.out.println(a.getAndIncrement(conan)); //10</span><br><span class="line">        System.out.println(a.get(conan));  //11</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class User &#123;</span><br><span class="line">        private String name;</span><br><span class="line">        public volatile int old;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">é™æ€å˜é‡å’Œæˆå‘˜å˜é‡ï¼š</span><br><span class="line">ç”±staticä¿®é¥°çš„å˜é‡ç§°ä¸ºé™æ€å˜é‡ï¼Œå…¶å®è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ã€‚</span><br><span class="line">å¦‚æœæŸä¸ªå†…å®¹æ˜¯è¢«æ‰€æœ‰å¯¹è±¡æ‰€å…±äº«ï¼Œé‚£ä¹ˆè¯¥å†…å®¹å°±åº”è¯¥ç”¨é™æ€ä¿®é¥°ï¼›</span><br><span class="line">æ²¡æœ‰è¢«é™æ€ä¿®é¥°çš„å†…å®¹ï¼Œå…¶å®æ˜¯å±äºå¯¹è±¡çš„ç‰¹æ®Šæè¿°ã€‚</span><br><span class="line"></span><br><span class="line">æˆå‘˜å˜é‡å’Œé™æ€å˜é‡çš„åŒºåˆ«ï¼š</span><br><span class="line">1.ç”Ÿå‘½å‘¨æœŸä¸åŒ</span><br><span class="line">æˆå‘˜å˜é‡éšç€å¯¹è±¡çš„åˆ›å»ºè€Œå­˜åœ¨ï¼Œéšç€å¯¹è±¡è¢«å›æ”¶è€Œé‡Šæ”¾ã€‚</span><br><span class="line">é™æ€å˜é‡éšç€ç±»çš„åŠ è½½è€Œå­˜åœ¨ï¼Œéšç€ç±»çš„æ¶ˆå¤±è€Œæ¶ˆå¤±ã€‚</span><br><span class="line">2.è°ƒç”¨æ–¹å¼ä¸åŒ</span><br><span class="line">æˆå‘˜å˜é‡åªèƒ½è¢«å¯¹è±¡è°ƒç”¨ã€‚</span><br><span class="line">é™æ€å˜é‡å¯ä»¥è¢«å¯¹è±¡è°ƒç”¨ï¼Œè¿˜å¯ä»¥è¢«ç±»åè°ƒç”¨ã€‚</span><br><span class="line">3.åˆ«åä¸åŒ</span><br><span class="line">æˆå‘˜å˜é‡ä¹Ÿç§°ä¸ºå®ä¾‹å˜é‡ã€‚</span><br><span class="line">é™æ€å˜é‡ä¹Ÿç§°ä¸ºç±»å˜é‡ã€‚</span><br><span class="line">4.æ•°æ®å­˜å‚¨ä½ç½®ä¸åŒ</span><br><span class="line">æˆå‘˜å˜é‡å­˜å‚¨åœ¨å †å†…å­˜çš„å¯¹è±¡ä¸­ï¼Œæ‰€ä»¥ä¹Ÿå«å¯¹è±¡çš„ç‰¹æœ‰æ•°æ®ã€‚</span><br><span class="line">é™æ€å˜é‡æ•°æ®å­˜å‚¨åœ¨æ–¹æ³•åŒºï¼ˆå…±äº«æ•°æ®åŒºï¼‰çš„é™æ€åŒºï¼Œæ‰€ä»¥ä¹Ÿå«å¯¹è±¡çš„å…±äº«æ•°æ®ã€‚ </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">é™æ€æ–¹æ³•å’Œéé™æ€æ–¹æ³•ï¼š</span><br><span class="line">é™æ€æ–¹æ³•:æ˜¯ä½¿ç”¨staticå…³é”®å­—ä¿®é¥°çš„æ–¹æ³•ï¼Œåˆå«ç±»æ–¹æ³•.å±äºç±»çš„ï¼Œ</span><br><span class="line">ä¸å±äºå¯¹è±¡ï¼Œ åœ¨å®ä¾‹åŒ–å¯¹è±¡ä¹‹å‰å°±å¯ä»¥é€šè¿‡ç±»å.æ–¹æ³•åè°ƒç”¨é™æ€æ–¹æ³•ã€‚</span><br><span class="line">éé™æ€æ–¹æ³•ï¼šåˆç§°ä¸ºå®ä¾‹æ–¹æ³•ï¼Œæˆå‘˜æ–¹æ³•ã€‚å±äºå¯¹è±¡çš„ï¼Œä¸å±äºç±»çš„ã€‚</span><br><span class="line"></span><br><span class="line">é™æ€æ–¹æ³•å’Œéé™æ€æ–¹æ³•çš„åŒºåˆ«ï¼š</span><br><span class="line">1.è°ƒç”¨æ–¹æ³•</span><br><span class="line">é™æ€æ–¹æ³•ä¸­ï¼Œå¯ä»¥è°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¸èƒ½è°ƒç”¨éé™æ€æ–¹æ³•ã€‚åœ¨é™æ€æ–¹æ³•ä¸­ï¼Œä¸èƒ½ä½¿ç”¨superå’Œthiså…³é”®å­—ã€‚ä¸èƒ½å¼•ç”¨æˆå‘˜å˜é‡ã€‚</span><br><span class="line">æ™®é€šæ–¹æ³•ä¸­ï¼Œå¯ä»¥è°ƒç”¨æ™®é€šæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨é™æ€æ–¹æ³•ã€‚</span><br><span class="line">2.ä½¿ç”¨æ–¹æ³•</span><br><span class="line">é™æ€æ–¹æ³•å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œç±»åè°ƒç”¨å’Œå¯¹è±¡è°ƒç”¨ã€‚</span><br><span class="line">ä½†æ˜¯éé™æ€æ–¹æ³•åªèƒ½é€šè¿‡å¯¹è±¡è°ƒç”¨ã€‚ï¼ˆå¯¹è±¡å.æ–¹æ³•åï¼‰</span><br><span class="line">3.ç”Ÿå‘½å‘¨æœŸä¸åŒ</span><br><span class="line">é™æ€æ–¹æ³•çš„ç”Ÿå‘½å‘¨æœŸè·Ÿç›¸åº”çš„ç±»ä¸€æ ·é•¿ï¼Œé™æ€æ–¹æ³•å’Œé™æ€å˜é‡ä¼šéšç€ç±»çš„å®šä¹‰è€Œè¢«åˆ†é…å’Œè£…è½½å…¥å†…å­˜ä¸­ã€‚ä¸€ç›´åˆ°çº¿ç¨‹ç»“æŸï¼Œé™æ€å±æ€§å’Œæ–¹æ³•æ‰ä¼šè¢«é”€æ¯ã€‚</span><br><span class="line">éé™æ€æ–¹æ³•çš„ç”Ÿå‘½å‘¨æœŸå’Œç±»çš„å®ä¾‹åŒ–å¯¹è±¡ä¸€æ ·é•¿ï¼Œåªæœ‰å½“ç±»å®ä¾‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡ï¼Œéé™æ€æ–¹æ³•æ‰ä¼šè¢«åˆ›å»ºï¼Œè€Œå½“è¿™ä¸ªå¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œéé™æ€æ–¹æ³•ä¹Ÿé©¬ä¸Šè¢«é”€æ¯ã€‚</span><br><span class="line"></span><br><span class="line">é™æ€æ–¹æ³•ä¼˜ç‚¹ï¼šå¸¸ä½åœ¨å†…å­˜ä¸­ï¼Œè°ƒç”¨å¿«æ·æ–¹ä¾¿ï¼Œå…¨å‰§å”¯ä¸€ï¼Œç”¨ç±»è°ƒç”¨å°±è¡Œã€‚</span><br><span class="line">åº”ç”¨åœºæ™¯ï¼š</span><br><span class="line">1. é™æ€æ–¹æ³•æœ€é€‚åˆå·¥å…·ç±»ä¸­æ–¹æ³•çš„å®šä¹‰ï¼›æ¯”å¦‚æ–‡ä»¶æ“ä½œï¼Œæ—¥æœŸå¤„ç†æ–¹æ³•ç­‰.</span><br><span class="line">2. é™æ€æ–¹æ³•é€‚åˆå…¥å£æ–¹æ³•çš„å®šä¹‰ï¼›å¦‚å•ä¾‹æ¨¡å¼ï¼Œå› ä¸ºä»å¤–éƒ¨æ‹¿ä¸åˆ°æ„é€ å‡½æ•°ï¼Œæ‰€æœ‰å®šä¹‰ä¸€ä¸ªé™æ€çš„æ–¹æ³•è·å–å¯¹è±¡éå¸¸æœ‰å¿…è¦.</span><br><span class="line">3. é™æ€å˜é‡é€‚åˆå…¨å±€å˜é‡çš„å®šä¹‰.ï¼ˆå¦‚å¸ƒå°”å‹é™æ€æˆå‘˜å˜é‡åšæ§åˆ¶ç¬¦ï¼‰</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">é™æ€ç±»ï¼š</span><br><span class="line">javaå…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªç±»é‡Œé¢å®šä¹‰é™æ€ç±»ã€‚æ¯”å¦‚å†…éƒ¨ç±»ï¼ˆnested classï¼‰ã€‚</span><br><span class="line">æŠŠnested classå°é—­èµ·æ¥çš„ç±»å«å¤–éƒ¨ç±»ã€‚</span><br><span class="line">åœ¨javaä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨staticä¿®é¥°é¡¶çº§ç±»ï¼ˆtop level classï¼‰ã€‚åªæœ‰å†…éƒ¨ç±»å¯ä»¥ä¸ºstaticã€‚</span><br><span class="line">ï¼ˆä¸€èˆ¬å·¥å…·ç±»ä¹Ÿä¸æ˜¯staticçš„ï¼Œæ–¹æ³•æ˜¯staticçš„ï¼‰</span><br><span class="line">ï¼ˆä¸€èˆ¬åœ¨ä¸€ä¸ªç±»é‡Œå†å®šä¹‰ä¸€ä¸ªç±»ç”¨äºåŒ…è£…æ•°æ®ï¼Œç”¨public static classï¼‰</span><br><span class="line"></span><br><span class="line">é™æ€å†…éƒ¨ç±»å’Œéé™æ€å†…éƒ¨ç±»çš„åŒºåˆ«ï¼š</span><br><span class="line">1.å†…éƒ¨é™æ€ç±»ä¸éœ€è¦æœ‰æŒ‡å‘å¤–éƒ¨ç±»çš„å¼•ç”¨ã€‚ä½†éé™æ€å†…éƒ¨ç±»éœ€è¦æŒæœ‰å¯¹å¤–éƒ¨ç±»çš„å¼•ç”¨ã€‚ï¼ˆæ­¤è¯æ€æ ·ï¼Œæ„æ€æ˜¯éé™æ€å†…éƒ¨ç±»éœ€è¦å¯¹è±¡.ç±»åï¼Œé™æ€å†…éƒ¨ç±»éœ€è¦å¤–éƒ¨ç±»å.ç±»åï¼‰</span><br><span class="line">2.éé™æ€å†…éƒ¨ç±»èƒ½å¤Ÿè®¿é—®å¤–éƒ¨ç±»çš„é™æ€å’Œéé™æ€æˆå‘˜ã€‚é™æ€ç±»ä¸èƒ½è®¿é—®å¤–éƒ¨ç±»çš„éé™æ€æˆå‘˜ã€‚ä»–åªèƒ½è®¿é—®å¤–éƒ¨ç±»çš„é™æ€æˆå‘˜ã€‚</span><br><span class="line">3.ä¸€ä¸ªéé™æ€å†…éƒ¨ç±»ä¸èƒ½è„±ç¦»å¤–éƒ¨ç±»å®ä½“è¢«åˆ›å»ºï¼Œä¸€ä¸ªéé™æ€å†…éƒ¨ç±»å¯ä»¥è®¿é—®å¤–éƒ¨ç±»çš„æ•°æ®å’Œæ–¹æ³•ï¼Œå› ä¸ºä»–å°±åœ¨å¤–éƒ¨ç±»é‡Œé¢ã€‚</span><br><span class="line"></span><br><span class="line">class OuterClass&#123;</span><br><span class="line">  private static String msg = &quot;GeeksForGeeks&quot;;</span><br><span class="line">  // é™æ€å†…éƒ¨ç±»</span><br><span class="line">  public static class NestedStaticClass&#123;</span><br><span class="line">    // é™æ€å†…éƒ¨ç±»åªèƒ½è®¿é—®å¤–éƒ¨ç±»çš„é™æ€æˆå‘˜</span><br><span class="line">    public void printMessage() &#123;</span><br><span class="line">     // è¯•ç€å°†msgæ”¹æˆéé™æ€çš„ï¼Œè¿™å°†å¯¼è‡´ç¼–è¯‘é”™è¯¯ </span><br><span class="line">     System.out.println(&quot;Message from nested static class: &quot; + msg); </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // éé™æ€å†…éƒ¨ç±»</span><br><span class="line">  public class InnerClass&#123;</span><br><span class="line">    // ä¸ç®¡æ˜¯é™æ€æ–¹æ³•è¿˜æ˜¯éé™æ€æ–¹æ³•éƒ½å¯ä»¥åœ¨éé™æ€å†…éƒ¨ç±»ä¸­è®¿é—®</span><br><span class="line">    public void display()&#123;</span><br><span class="line">     System.out.println(&quot;Message from non-static nested class: &quot;+ msg);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line">class Main</span><br><span class="line">&#123;</span><br><span class="line">  // æ€ä¹ˆåˆ›å»ºé™æ€å†…éƒ¨ç±»å’Œéé™æ€å†…éƒ¨ç±»çš„å®ä¾‹</span><br><span class="line">  public static void main(String args[])&#123;</span><br><span class="line">    // åˆ›å»ºé™æ€å†…éƒ¨ç±»çš„å®ä¾‹</span><br><span class="line">    OuterClass.NestedStaticClass printer = new OuterClass.NestedStaticClass();</span><br><span class="line">    // åˆ›å»ºé™æ€å†…éƒ¨ç±»çš„éé™æ€æ–¹æ³•</span><br><span class="line">    printer.printMessage();  </span><br><span class="line">    // ä¸ºäº†åˆ›å»ºéé™æ€å†…éƒ¨ç±»ï¼Œæˆ‘ä»¬éœ€è¦å¤–éƒ¨ç±»çš„å®ä¾‹</span><br><span class="line">    OuterClass outer = new OuterClass();    </span><br><span class="line">    OuterClass.InnerClass inner = outer.new InnerClass();</span><br><span class="line">    // è°ƒç”¨éé™æ€å†…éƒ¨ç±»çš„éé™æ€æ–¹æ³•</span><br><span class="line">    inner.display();</span><br><span class="line">    // æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»“åˆä»¥ä¸Šæ­¥éª¤ï¼Œä¸€æ­¥åˆ›å»ºçš„å†…éƒ¨ç±»å®ä¾‹</span><br><span class="line">    OuterClass.InnerClass innerObject = new OuterClass().new InnerClass();</span><br><span class="line">    // åŒæ ·æˆ‘ä»¬ç°åœ¨å¯ä»¥è°ƒç”¨å†…éƒ¨ç±»æ–¹æ³•</span><br><span class="line">    innerObject.display();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Inner class &#x27;Person&#x27; may be &#x27;static&#x27; </span><br><span class="line">ideæç¤ºå†…éƒ¨ç±»æœ€å¥½æ˜¯é™æ€çš„. ä¸ç„¶ä¸èƒ½åœ¨æ‰€åœ¨å¤–éƒ¨ç±»é‡Œç›´æ¥newä¸€ä¸ªå¯¹è±¡ã€‚</span><br><span class="line"></span><br><span class="line">ä¸€ä¸ªç±»åŒ…åœ¨å¦ä¸€ä¸ªå¤–éƒ¨ç±»é‡Œé¢ï¼Œå«åšå†…éƒ¨ç±»ï¼Œå¯ä»¥å’Œå…¶ä»–å†…éƒ¨ç±»é‡åã€‚</span><br><span class="line">ä½†æ˜¯å’Œä¸€ä¸ªç±»å¹¶åˆ—åœ¨ä¸€ä¸ªç±»æ–‡ä»¶é‡Œï¼Œä¸æ˜¯å†…éƒ¨ç±»ï¼Œä¸èƒ½é‡åã€‚ä¸åŒäºå†…éƒ¨ç±»ï¼Œæ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ï¼Œç›¸å½“äºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œä¸å»ºè®®è¿™ä¹ˆåšã€‚</span><br></pre></td></tr></table></figure>

<p>é™æ€å†…éƒ¨ç±»å’Œéé™æ€å†…éƒ¨ç±»ï¼š<a target="_blank" rel="noopener" href="https://www.jb51.net/article/74838.htm">https://www.jb51.net/article/74838.htm</a></p>
<h2 id="ç¬¬å…«ç« -javaä¸­çš„å¹¶å‘å·¥å…·ç±»"><a href="#ç¬¬å…«ç« -javaä¸­çš„å¹¶å‘å·¥å…·ç±»" class="headerlink" title="ç¬¬å…«ç«  javaä¸­çš„å¹¶å‘å·¥å…·ç±»"></a>ç¬¬å…«ç«  javaä¸­çš„å¹¶å‘å·¥å…·ç±»</h2><p>JDKçš„å¹¶å‘åŒ…é‡Œæä¾›äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„å¹¶å‘å·¥å…·ç±»ã€‚CountDownLatchã€CyclicBarrierå’ŒSemaphoreå·¥å…·ç±»æä¾›äº†ä¸€ç§å¹¶å‘æµç¨‹æ§åˆ¶çš„æ‰‹æ®µï¼ŒExchangerå·¥å…·ç±»æä¾›äº†åœ¨çº¿ç¨‹é—´äº¤æ¢æ•°æ®çš„ä¸€ç§æ–¹æ³•ã€‚</p>
<h3 id="1-ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆçš„CountDownLatch"><a href="#1-ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆçš„CountDownLatch" class="headerlink" title="1.ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆçš„CountDownLatch"></a>1.ç­‰å¾…å¤šçº¿ç¨‹å®Œæˆçš„CountDownLatch</h3><p>åº”ç”¨åœºæ™¯ï¼šç­‰å¾…å…¶ä»–å¤šä¸ªçº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œå†æ‰§è¡Œå½“å‰çº¿ç¨‹ã€‚</p>
<p>åœ¨JDK1.5ä¹‹åçš„å¹¶å‘åŒ…ä¸­æä¾›çš„CountDownLatchå¯ä»¥å®ç°joinçš„åŠŸèƒ½ï¼Œä¸€ä¸ªcountDownLatchçš„await()æ–¹æ³•ç›¸å½“äºå¤šä¸ªçº¿ç¨‹çš„joinæ–¹æ³•ã€‚joinçº¿ç¨‹ç»ˆæ­¢åï¼Œå…¶å®æ˜¯è°ƒç”¨äº†<code>this.notifyAll()æ–¹æ³•</code>ï¼Œåœ¨JVMé‡Œå®ç°çš„ï¼Œåœ¨JDKé‡Œçœ‹ä¸åˆ°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    CountDownLatch countDownLatch = new CountDownLatch(2);</span><br><span class="line">    new Thread(new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(1);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            System.out.println(2);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">    countDownLatch.await();</span><br><span class="line">    System.out.println(3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨CountDownLatchçš„countDownæ–¹æ³•æ—¶ï¼ŒCountDownLatchçš„awaitæ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°Nå˜ä¸º0ã€‚å¯ä»¥æ˜¯Nä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯1ä¸ªçº¿ç¨‹çš„Nä¸ªæ‰§è¡Œæ­¥éª¤ã€‚ç”¨åœ¨å¤šä¸ªçº¿ç¨‹æ—¶ï¼Œåªéœ€è¦æŠŠè¿™ä¸ªCountDownLatchçš„å¼•ç”¨ä¼ é€’åˆ°çº¿ç¨‹é‡Œå³å¯ã€‚</p>
<p>è¶…æ—¶æœºåˆ¶ï¼š<code>await(long time, TimeUnit unit)</code>ï¼Œè¿™ä¸ªæ–¹æ³•ç­‰å¾…ç‰¹å®šæ—¶é—´åï¼Œå°±ä¼šä¸å†é˜»æŒ¡å½“å‰çº¿ç¨‹ã€‚</p>
<p>âš ï¸CountDownLatchä¸å¯èƒ½é‡æ–°åˆå§‹åŒ–æˆ–è€…ä¿®æ”¹å…¶å†…éƒ¨è®¡æ•°å™¨çš„å€¼ã€‚</p>
<h3 id="2-åŒæ­¥å±éšœCyclicBarrier"><a href="#2-åŒæ­¥å±éšœCyclicBarrier" class="headerlink" title="2.åŒæ­¥å±éšœCyclicBarrier"></a>2.åŒæ­¥å±éšœCyclicBarrier</h3><p>CyclicBarrierçš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šä¸€è¾†è½¦è£…10ä¸ªäººï¼Œä¸Šå¤Ÿ10ä¸ªäººæ‰å¼€è½¦ã€‚</p>
<p>CyclicBarrieré»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯CyclicBarrier(int parties)ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•å‘Šè¯‰CyclicBarrieræˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    CyclicBarrier cyclicBarrier = new CyclicBarrier(2);</span><br><span class="line">    new Thread(() -&gt; &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(1);</span><br><span class="line">    &#125;).start();</span><br><span class="line">    try &#123;</span><br><span class="line">        cyclicBarrier.await();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹çš„è°ƒåº¦æ˜¯æœ‰CPUå†³å®šçš„ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æœ‰å¯èƒ½å…ˆæ‰§è¡Œã€‚å¯èƒ½æ˜¯1ï¼Œ2ï¼Œä¹Ÿå¯èƒ½æ˜¯2ï¼Œ1.</p>
<p>CyclicBarrierè¿˜æä¾›äº†ä¸€ä¸ªé«˜çº§çš„æ„é€ å‡½æ•°<code>CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼Œç”¨äºåœ¨æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœæ—¶ï¼Œä¼˜å…ˆæ‰§è¡ŒbarrierActionã€‚æ³¨æ„ï¼Œè¿™ä¸ªbarrierActionä¸ä¸€å®šæ˜¯è¦ç”¨cyclicBarrier.await()çš„çº¿ç¨‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CyclicBarrier;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-18 22:50</span><br><span class="line"> **/</span><br><span class="line">public class CyclicTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CyclicBarrier c = new CyclicBarrier(2, new A());</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                c.await();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(2);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        try &#123;</span><br><span class="line">            c.await();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class A implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            System.out.println(3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º3-1-2 æˆ–è€…3-2-1.</p>
<h4 id="âœ…çº¿ç¨‹çš„é˜»å¡çŠ¶æ€å’Œä¸­æ–­çŠ¶æ€"><a href="#âœ…çº¿ç¨‹çš„é˜»å¡çŠ¶æ€å’Œä¸­æ–­çŠ¶æ€" class="headerlink" title="âœ…çº¿ç¨‹çš„é˜»å¡çŠ¶æ€å’Œä¸­æ–­çŠ¶æ€"></a>âœ…çº¿ç¨‹çš„é˜»å¡çŠ¶æ€å’Œä¸­æ–­çŠ¶æ€</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹çš„é˜»å¡çŠ¶æ€å’Œä¸­æ–­çŠ¶æ€</span><br><span class="line"></span><br><span class="line">å·²çŸ¥ï¼š</span><br><span class="line">waitå’Œnotifyï¼š</span><br><span class="line">æ‰§è¡Œäº†ç›‘è§†å™¨çš„wait()æ–¹æ³•åï¼Œæ”¾å¼ƒé”è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</span><br><span class="line">æ‰§è¡Œäº†ç›‘è§†å™¨çš„notify()æ–¹æ³•åï¼Œè®©ä¸€ä¸ªçº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚</span><br><span class="line">wait()å’Œnotify()æ–¹æ³•ä½¿ç”¨çš„å‰ææ˜¯è¦è·å–å¯¹è±¡çš„é”çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨synchronized(obj)&#123;&#125;å†…ã€‚</span><br><span class="line">sleepæ–¹æ³•è¿›å…¥å®šæ—¶ç­‰å¾…çŠ¶æ€ï¼Œä¸ä¼šé‡Šæ”¾é”(å¦‚æœå†™åœ¨synchronizedå†…)ã€‚</span><br><span class="line"></span><br><span class="line">sleepå’ŒwaitåŒºåˆ«ï¼š</span><br><span class="line">1.sleepæ˜¯Threadç±»çš„æ–¹æ³•ï¼Œæ˜¯ã€Œé™æ€æ–¹æ³•ã€ã€‚waitæ˜¯Objectç±»çš„æ–¹æ³•ï¼Œè°ƒç”¨éœ€è¦å…·ä½“çš„å¯¹è±¡ã€‚</span><br><span class="line">2.sleepæ˜¯ä¸é‡Šæ”¾é”çš„ï¼Œè§£é™¤æ–¹æ³•è¦ä¹ˆæ˜¯timeoutï¼Œæˆ–è€…interruptä¸€ä¸‹è®©å®ƒæŠ›å‡ºInterruptedExceptionã€‚waitæ˜¯é‡Šæ”¾é”çš„ï¼Œå¯ä»¥è¢«notify/notifyAllæ¢å¤ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥timeoutæˆ–è€…interruptã€‚</span><br><span class="line">3.sleepåœ¨å“ªé‡Œéƒ½å¯ä»¥è°ƒç”¨ï¼Œwaitå¿…é¡»åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—é‡Œè°ƒç”¨ï¼Œå¹¶ä¸”åŒæ­¥çš„å¯¹è±¡è¦è·Ÿwaitçš„å¯¹è±¡ä¸€æ ·ã€‚</span><br><span class="line">4.sleepä½œç”¨åªæ˜¯çº¿ç¨‹çš„æ“ä½œï¼Œç”¨äºçŸ­æ—¶é—´æš‚åœçº¿ç¨‹ï¼Œwait/notifyå¯ä»¥ç”¨ä½œçº¿ç¨‹é—´é€šä¿¡ï¼Œè¾¾åˆ°èµ„æºè°ƒåº¦çš„åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line">Thread.yield():</span><br><span class="line">yieldæ–¹æ³•ä¹Ÿæ˜¯Threadç±»çš„é™æ€æ–¹æ³•ï¼Œé‡æ–°åˆ†é…ã€‚</span><br><span class="line">ä¼šæŠŠå½“å‰çº¿ç¨‹ä»å¯è¿è¡ŒçŠ¶æ€å˜æˆå°±ç»ªçŠ¶æ€ã€‚</span><br><span class="line">ä¹‹åä¼šcpuä¼šä»ä¼—å¤šå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹ä¸­é€‰æ‹©ä¸€ä¸ªæ¥æ‰§è¡Œã€‚</span><br><span class="line"></span><br><span class="line">thread.join():</span><br><span class="line">joinæ˜¯Threadç±»æ–¹æ³•ï¼Œéé™æ€ï¼Œè¡¨ç¤ºç­‰å¾…è¯¥çº¿ç¨‹ç»“æŸï¼Œå½“å‰çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œ</span><br><span class="line">joinè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹ä¸­æ–­ï¼š</span><br><span class="line">suspend()æš‚åœå’Œresume()ç»§ç»­å®¹æ˜“é€ æˆæ­»é”ï¼Œstop()å…·æœ‰å›ºæœ‰çš„ä¸å®‰å…¨æ€§ã€‚å·²åºŸå¼ƒã€‚</span><br><span class="line">ç»ˆæ­¢çº¿ç¨‹çš„å‡ ç§æ–¹å¼ï¼š</span><br><span class="line">1.è®¾è®¡æ ‡è®°ä½æ³•ï¼švolatileçš„booleanç±»å‹å˜é‡æ¥æ§åˆ¶</span><br><span class="line">ç¼ºç‚¹ï¼šå¦‚æœä»£ç å¹¶æ²¡æœ‰è¿™ç§å¾ªç¯è¯­å¥ï¼Œæˆ–è€…çº¿ç¨‹è¢«å…¶ä»–è¯­å¥é˜»å¡äº†ï¼Œçº¿ç¨‹å¯èƒ½ä¸€ç›´ä¸ä¼šå»æ£€æŸ¥æ ‡è®°ä½ã€‚</span><br><span class="line">2.thread.interrupt()æ–¹æ³•ä¸­æ–­</span><br><span class="line">çº¿ç¨‹é‡Œæœ‰ä¸€ä¸ªbooleanç±»å‹çš„ä¸­æ–­çŠ¶æ€ï¼Œæ˜¯ä¸€ä¸ªæ ‡è®°ä½ï¼Œæ˜¯å­˜åœ¨Nativeå±‚çš„ã€‚</span><br><span class="line">å½“ä½¿ç”¨Threadçš„interrupt()æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºtrueã€‚</span><br><span class="line">ä¸€äº›é˜»å¡æ–¹æ³•å°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸InterruptedExceptionã€‚å¦‚æœæ²¡æœ‰è¿™ç§é˜»å¡æ–¹æ³•ï¼Œé‚£å°±ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚</span><br><span class="line">interrupt()æ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•</span><br><span class="line">è¿˜æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šisInterrupted() å’Œ interrupted() </span><br><span class="line">ç›¸åŒç‚¹æ˜¯è¿™ä¸¤ä¸ªéƒ½æ˜¯è¿”å›ä¸€ä¸ªbooleanå€¼ï¼Œtrueè¡¨ç¤ºä¸­æ–­ï¼Œfalseè¡¨ç¤ºæœªè¢«ä¸­æ–­ã€‚</span><br><span class="line">ä¸åŒç‚¹æ˜¯interrupted()æ˜¯é™æ€æ–¹æ³•ï¼Œåªèƒ½åœ¨å½“å‰çº¿ç¨‹è°ƒç”¨ï¼Œåˆ¤æ–­æ˜¯trueåä¼šæ¸…é™¤æ ‡è®°ï¼Œä¹Ÿå°±æ˜¯é‡ç½®ä¸ºfalseã€‚isInterrupted()æ˜¯å®ä¾‹æ–¹æ³•ï¼Œä¸ä¼šæ¸…é™¤æ ‡è®°ï¼Œæ‰€ä»¥å¯ä»¥å¤šæ¬¡åˆ¤æ–­ã€‚</span><br><span class="line"></span><br><span class="line">*åœ¨Thread.sleepè¿™äº›æ–¹æ³•ï¼ŒæŠ›å‡ºInterruptedExceptionå¼‚å¸¸åä¼šæ¸…é™¤æ ‡è®°ä½çŠ¶æ€ã€‚</span><br><span class="line">ä¸€ä¸ªå…³äºä¸­æ–­çš„ä¾‹å­è§ä¸‹é¢ä»£ç </span><br><span class="line"></span><br><span class="line">*æ‰€è°“çš„interruptçº¿ç¨‹ä¸­æ–­ï¼Œåªæ˜¯ä¿®æ”¹äº†ä¸€ä¸ªæ ‡è®°ä½ï¼Œéœ€è¦æˆ‘ä»¬åˆ¤æ–­æ ‡è®°ä½åšåç»­çš„å¤„ç†ã€‚</span><br><span class="line">å¦‚æœcatchä»£ç å—ä»€ä¹ˆéƒ½ä¸å¤„ç†ï¼Œä¼šç»§ç»­è·‘å®Œå‰©ä¸‹çš„ä»£ç ã€‚æ‰€ä»¥åº”è¯¥ç†è§£ä¸ºã€å¹¶ä¸æ˜¯ä¸­æ–­ï¼Œè€Œæ˜¯é€šçŸ¥ä½ åº”è¯¥è‡ªè¡Œä¸­æ–­äº†ã€</span><br><span class="line">çº¿ç¨‹ä¸åº”è¯¥äº¤ç»™åˆ«çš„çº¿ç¨‹ä¸­æ–­ï¼Œåº”è¯¥ç”±è‡ªå·±ä¸­æ–­è‡ªå·±ï¼Œè¿‡ç¨‹ä¸­ä¿è¯èµ„æºå’Œå˜é‡å·²åˆç†çš„å¤„ç†äº†ï¼ˆè¯¥å…³çš„å…³ï¼Œè¯¥é‡Šæ”¾çš„é‡Šæ”¾ï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹é˜»å¡ï¼š</span><br><span class="line">é˜»å¡å’Œéé˜»å¡æ˜¯å½¢å®¹å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„ç›¸äº’å½±å“çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å ç”¨äº†ä¸´ç•ŒåŒºèµ„æºï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹å¿…é¡»åœ¨ä¸´ç•ŒåŒºå¤–ç­‰å¾…ã€‚</span><br><span class="line">å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸€ç›´å ç”¨ä¸é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå…¶ä»–éœ€è¦è¯¥ä¸´ç•ŒåŒºèµ„æºçš„çº¿ç¨‹éƒ½å¿…é¡»ä¸€ç›´ç­‰å¾…ã€‚</span><br><span class="line">éé˜»å¡å°±æ˜¯è¿è¡Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œåªè¦ä¿è¯ä¸æŠŠæ•°æ®ä¿®æ”¹åå°±è¡Œã€‚</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹é˜»å¡çš„åœºæ™¯ï¼š</span><br><span class="line">è¿è¡Œçš„çº¿ç¨‹åœ¨è·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«åˆ«çš„çº¿ç¨‹å ç”¨ï¼Œåˆ™JVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ± ä¸­ã€‚</span><br><span class="line">å‘å‡ºI/Oè¯·æ±‚æ—¶ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹ç½®ä¸ºé˜»å¡çŠ¶æ€ï¼ŒI/Oå¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å°±ç»ªçŠ¶æ€ã€‚</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹é˜»å¡å’Œç­‰å¾…çš„åŒºåˆ«ï¼š</span><br><span class="line">åœ¨javaä¸­ï¼Œçº¿ç¨‹é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«ä¸å¯è®¡åˆ’çš„ï¼Œè€Œçº¿ç¨‹ç­‰å¾…çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«è®¡åˆ’ä¹‹å†…çš„ã€‚</span><br><span class="line">ç›¸åŒç‚¹ï¼š</span><br><span class="line">ï¼ˆ1ï¼‰éƒ½ä¼šæš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚</span><br><span class="line">åŒºåˆ«ç‚¹ï¼š</span><br><span class="line">ï¼ˆ1ï¼‰çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€æ˜¯è¢«åŠ¨çš„, è€Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€æ˜¯ä¸»åŠ¨çš„ã€‚</span><br><span class="line">é˜»å¡çŠ¶æ€çš„è¢«åŠ¨ï¼šçº¿ç¨‹åœ¨åŒæ­¥ä»£ç å¤–ï¼Œè·å–å¯¹è±¡é”å¤±è´¥æ—¶ï¼Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼›ä½•æ—¶è·å–å¯¹è±¡é”å¤±è´¥ä¸å¯çŸ¥ï¼Œå³çº¿ç¨‹é˜»å¡çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«ä¸å¯è®¡åˆ’çš„ã€‚</span><br><span class="line">ç­‰å¾…çŠ¶æ€çš„ä¸»åŠ¨ï¼šçº¿ç¨‹åœ¨åŒæ­¥ä»£ç å†…ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹æ“ä½œæ—¶ï¼Œçº¿ç¨‹æ¥å…¥ç­‰å¾…çŠ¶æ€ï¼›ä½•æ—¶ç­‰å¾…å…¶ä»–çº¿ç¨‹æ“ä½œå¯çŸ¥ï¼Œå³çº¿ç¨‹ç­‰å¾…çŠ¶æ€æ˜¯çº¿ç¨‹æœ¬èº«è®¡åˆ’ä¹‹å†…çš„ã€‚</span><br><span class="line"></span><br><span class="line">countDownLatch/cyclicBarrierçš„awaitæ–¹æ³•è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¼šä¸ä¼šé‡Šæ”¾é”ï¼Ÿ</span><br><span class="line">ç»æµ‹è¯•ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼Œä¸ä¼šé‡Šæ”¾é”ã€‚</span><br><span class="line"></span><br><span class="line">æ€»ç»“ï¼š</span><br><span class="line">waitè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é”ã€‚</span><br><span class="line">sleepè¿›å…¥å®šæ—¶ç­‰å¾…çŠ¶æ€ï¼Œä¸é‡Šæ”¾é”ã€‚</span><br><span class="line">awaitè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¸é‡Šæ”¾é”ã€‚</span><br></pre></td></tr></table></figure>

<p>çº¿ç¨‹ä¸­æ–­çš„è®²è§£ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/alcoholdi/article/details/79475029">https://blog.csdn.net/alcoholdi/article/details/79475029</a></p>
<p>å…³äºçº¿ç¨‹ä¸­æ–­çš„æºç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public class Thread implements Runnable &#123;</span><br><span class="line"> </span><br><span class="line">    // ä¸­æ–­ç›®æ ‡çº¿ç¨‹</span><br><span class="line">    public void interrupt() &#123;</span><br><span class="line">        if (this != Thread.currentThread())</span><br><span class="line">            checkAccess();</span><br><span class="line"> </span><br><span class="line">        synchronized (blockerLock) &#123;</span><br><span class="line">            Interruptible b = blocker;</span><br><span class="line">            if (b != null) &#123;</span><br><span class="line">                interrupt0();           // Just to set the interrupt flag</span><br><span class="line">                b.interrupt(this);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        interrupt0();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // è¿”å›ç›®æ ‡çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€	staticåœ¨è¿™é‡Œç†è§£ä¸ºï¼šåªä¾›å½“å‰çº¿ç¨‹ä½¿ç”¨è¿™ä¸ªæ–¹æ³•</span><br><span class="line">    public static boolean interrupted() &#123;</span><br><span class="line">        return currentThread().isInterrupted(true);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    // åˆ¤æ–­ç›®æ ‡çº¿ç¨‹æ˜¯å¦ä¸­æ–­</span><br><span class="line">    public boolean isInterrupted() &#123;</span><br><span class="line">        return isInterrupted(false);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private native boolean isInterrupted(boolean ClearInterrupted);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªå…³äºä¸­æ–­çš„ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-18 09:06</span><br><span class="line"> **/</span><br><span class="line">public class InterruptDemo &#123;</span><br><span class="line"></span><br><span class="line">    private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;HH:mm:ss:SSS&quot;);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">//        InterruptThread t = new InterruptThread();</span><br><span class="line">        Interrupt2Thread t = new Interrupt2Thread();</span><br><span class="line">//        Interrupt3Thread t = new Interrupt3Thread();</span><br><span class="line"></span><br><span class="line">        t.start();</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(3500);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        t.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class InterruptThread extends Thread &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    // æŠ›å‡ºInterruptedExceptionåä¸­æ–­æ ‡å¿—è¢«æ¸…é™¤</span><br><span class="line">                    // åœ¨catchä¸­ç›´æ¥returnç»“æŸçº¿ç¨‹</span><br><span class="line">                    System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; catch &quot; + isInterrupted() + &quot; &quot; + interrupted()); //false false</span><br><span class="line">                    System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; &quot; + isInterrupted()+ &quot; &quot; + interrupted()); //false false</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; &quot; + isInterrupted()+ &quot; &quot; + interrupted()); //ä¸è¾“å‡º</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Interrupt2Thread extends Thread &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (!isInterrupted()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    // æŠ›å‡ºInterruptedExceptionåä¸­æ–­æ ‡å¿—è¢«æ¸…é™¤</span><br><span class="line">                    // å¯ä»¥å†æ¬¡è°ƒç”¨interruptæ¢å¤ä¸­æ–­</span><br><span class="line">                    // catchä¸­å†æ¬¡è°ƒç”¨interruptæ¢å¤ä¸­æ–­çŠ¶æ€ï¼Œwhileä¸­ä¸‹æ¬¡åˆ¤æ–­isInterrupted()ä¸­ç»“æŸçº¿ç¨‹</span><br><span class="line">                    System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; catch &quot; + isInterrupted()+ &quot; &quot; + interrupted()); //false false</span><br><span class="line">                    //interrupt();</span><br><span class="line">                    //å¦‚æœä¸åœ¨catché‡Œå†ä¸­æ–­ï¼Œä¼šä¸€ç›´æ‰§è¡Œ</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; &quot; + isInterrupted()+ &quot; &quot;);</span><br><span class="line">//                System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; &quot; + isInterrupted()+ &quot; &quot; + interrupted());</span><br><span class="line">                //å¦‚æœç”¨äº†ä¸Šé¢çš„é‚£ä¸ªï¼Œä¸­æ–­æ ‡è¯†ä¸ºä¼šè¾“å‡ºtrueåè¢«é‡ç½®ä¸ºfalseï¼Œç»§ç»­å¾ªç¯ï¼Œä¸ä¼šåœ</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Interrupt3Thread extends Thread &#123;</span><br><span class="line"></span><br><span class="line">        @SneakyThrows</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (!isInterrupted()) &#123;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">                // æŠ›å‡ºInterruptedExceptionåä¸­æ–­æ ‡å¿—è¢«æ¸…é™¤</span><br><span class="line">                // å¯ä»¥å†æ¬¡è°ƒç”¨interruptæ¢å¤ä¸­æ–­</span><br><span class="line">                // catchä¸­å†æ¬¡è°ƒç”¨interruptæ¢å¤ä¸­æ–­çŠ¶æ€ï¼Œwhileä¸­ä¸‹æ¬¡åˆ¤æ–­isInterrupted()ä¸­ç»“æŸçº¿ç¨‹</span><br><span class="line">                System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; catch &quot; + isInterrupted()+ &quot; &quot; + interrupted()); //false false</span><br><span class="line">                interrupt();</span><br><span class="line">                //System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; &quot; + isInterrupted()+ &quot; &quot;);</span><br><span class="line">                System.out.println(sdf.format(new Date()) + Thread.currentThread() + &quot; &quot; + isInterrupted()+ &quot; &quot; + interrupted());</span><br><span class="line">                //å¦‚æœç”¨äº†ä¸Šé¢çš„é‚£ä¸ªï¼Œä¸­æ–­æ ‡è¯†ä¸ºä¼šè¾“å‡ºtrueåè¢«é‡ç½®ä¸ºfalseï¼Œç»§ç»­å¾ªç¯ï¼Œç›´åˆ°åœ¨ä¸»çº¿ç¨‹å†…ä¸­æ–­ï¼ŒæŠ›å‡ºInterruptedException</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•awaitæ–¹æ³•ä¼šä¸ä¼šé‡Šæ”¾é”ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CountDownLatch;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-18 22:33</span><br><span class="line"> **/</span><br><span class="line">public class AwaitTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Object lock = 1;</span><br><span class="line">        CountDownLatch countDownLatch = new CountDownLatch(1);</span><br><span class="line">        Thread thread1 = new Thread()&#123;</span><br><span class="line">            @SneakyThrows</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                synchronized (lock) &#123;</span><br><span class="line">                    System.out.println(&quot;thread1 get lock&quot;);</span><br><span class="line">                    countDownLatch.await();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Thread thread2 = new Thread(() -&gt; &#123;</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                System.out.println(&quot;thread2 get lock&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CyclicBarrierçš„ä½¿ç”¨åœºæ™¯ï¼šå¤šç”¨äºå¤šçº¿ç¨‹è®¡ç®—æ•°æ®ï¼Œæœ€ååˆå¹¶è®¡ç®—ç»“æœçš„åœºæ™¯ã€‚<br>ä¸€ä¸ªåˆå¹¶è®¡ç®—ç»“æœçš„ä¾‹å­ï¼Œç”¨äº†barrierActionå‚æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line">import java.util.concurrent.CyclicBarrier;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-18 23:02</span><br><span class="line"> **/</span><br><span class="line">public class CyclicDemo &#123;</span><br><span class="line"></span><br><span class="line">    private static SimpleDateFormat sdf = new SimpleDateFormat(&quot;HH:mm:ss:SSS&quot;);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        BankWaterService bankWaterService = new BankWaterService();</span><br><span class="line">        bankWaterService.count();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class BankWaterService implements Runnable &#123;</span><br><span class="line">        private final CyclicBarrier c = new CyclicBarrier(4, this);  //è¿™é‡Œå±éšœè§£é™¤åæ‰§è¡Œæœ¬çº¿ç¨‹ã€‚</span><br><span class="line">        private final ExecutorService executor = Executors.newFixedThreadPool(4);</span><br><span class="line">        private final ConcurrentHashMap&lt;String, Integer&gt; sheetBankWaterCount = new ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        private void count() &#123;</span><br><span class="line">            for (int i = 0; i &lt; 4; i++) &#123;</span><br><span class="line">                executor.execute(new Runnable() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void run() &#123;</span><br><span class="line">                        sheetBankWaterCount.put(Thread.currentThread().getName(), 3);</span><br><span class="line">                        try &#123;</span><br><span class="line">                            c.await();</span><br><span class="line">                            System.out.println(sdf.format(new Date()) + &quot; &quot; + Thread.currentThread().getName());</span><br><span class="line">                        &#125; catch (Exception e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            int result = 0;</span><br><span class="line">            for (Map.Entry&lt;String, Integer&gt; sheet : sheetBankWaterCount.entrySet()) &#123;</span><br><span class="line">                result += sheet.getValue();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(sdf.format(new Date()) + &quot; &quot; + &quot;result:&quot; + result);</span><br><span class="line">            executor.shutdownNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-CyclicBarrierå’ŒCountDownLatchçš„åŒºåˆ«"><a href="#3-CyclicBarrierå’ŒCountDownLatchçš„åŒºåˆ«" class="headerlink" title="3.CyclicBarrierå’ŒCountDownLatchçš„åŒºåˆ«"></a>3.CyclicBarrierå’ŒCountDownLatchçš„åŒºåˆ«</h3><p>1ã€ä½¿ç”¨çš„åœºæ™¯ä¸ä¸€æ ·ï¼ŒCyclicBarrieré˜»å¡æ¯ä¸ªçº¿ç¨‹ï¼ˆæ¯ä¸ªçº¿ç¨‹éƒ½ç­‰å¾…æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœï¼‰ï¼Œåƒåˆ†å¸ƒå¼é—®é¢˜ï¼Œå±éšœæ¸…é™¤äº†ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥ç»§ç»­åšè‡ªå·±çš„äº‹æƒ…ï¼›CountDownLatché˜»å¡ç­‰å¾…çº¿ç¨‹ï¼ˆç­‰å¾…çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆï¼‰å‘é›†ä¸­å¼çš„ï¼Œæœ€åç”±ç­‰å¾…çº¿ç¨‹ç»Ÿä¸€å¤„ç†ã€‚</p>
<p>2ã€CountDownLatchçš„è®¡æ•°å™¨åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè€ŒCyclicBarrierçš„è®¡æ•°å™¨å¯ä»¥ä½¿ç”¨reset()æ–¹æ³•é‡ç½®ã€‚æ‰€ä»¥CyclicBarrierèƒ½å¤„ç†æ›´ä¸ºå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè®¡ç®—å‘ç”Ÿé”™è¯¯ï¼Œå¯ä»¥é‡ç½®è®¡æ•°å™¨ï¼Œå¹¶è®©çº¿ç¨‹é‡å¼„ä¸‹æ‰§è¡Œä¸€æ¬¡ã€‚</p>
<p>3ã€CyclicBarrierè¿˜æä¾›å…¶ä»–æœ‰ç”¨çš„æ–¹æ³•ï¼Œæ¯”å¦‚getNumberWaitingæ–¹æ³•å¯ä»¥è·å¾—CyclicBarrieré˜»å¡çš„çº¿ç¨‹æ•°é‡ã€‚isBroken()æ–¹æ³•ç”¨æ¥äº†è§£é˜»å¡çš„çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ã€‚</p>
<p>cyclicBarrierçº¿ç¨‹ä¸­æ–­ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.CyclicBarrier;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-19 18:37</span><br><span class="line"> **/</span><br><span class="line">public class CyclicInterruptTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        CyclicBarrier c = new CyclicBarrier(3);</span><br><span class="line">        Thread thread = new Thread(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                c.await();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                //e.printStackTrace();</span><br><span class="line">                System.out.println(e);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(2);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">        thread.interrupt();</span><br><span class="line">        try &#123;</span><br><span class="line">            c.await();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(c.isBroken());</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">è¾“å‡ºï¼š</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">2</span><br><span class="line">true</span><br><span class="line">java.util.concurrent.BrokenBarrierException</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜ï¼šå°½ç®¡å±éšœæ•°æ˜¯3ï¼Œä½†æ˜¯å…¶ä¸­ä¸€ä¸ªä¸­æ–­äº†çš„è¯ï¼Œå…¶ä»–çš„awaitä¹Ÿä¼šè·‘å‡ºå¼‚å¸¸ã€‚è¢«ä¸­æ–­çš„æŠ›å‡ºInterruptedExceptionï¼Œå…¶ä»–çš„æŠ›å‡ºBrokenBarrierExceptionã€‚</p>
<h3 id="4-æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°çš„Semaphore"><a href="#4-æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°çš„Semaphore" class="headerlink" title="4.æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°çš„Semaphore"></a>4.æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•°çš„Semaphore</h3><p>Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šSemaphoreå¯ä»¥åšæµé‡æ§åˆ¶ï¼Œç‰¹åˆ«æ˜¯å…¬ç”¨èµ„æºæœ‰é™çš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥ã€‚<br>å‡å¦‚æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œè¦è¯»å–å‡ ä¸‡ä¸ªæ–‡ä»¶çš„æ•°æ®ï¼Œå› ä¸ºéƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥å¯åŠ¨å‡ åä¸ªçº¿ç¨‹å¹¶å‘çš„è¯»å–ï¼Œä½†æ˜¯å¦‚æœè¯»åˆ°å†…å­˜åï¼Œè¿˜éœ€è¦å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œæ•°æ®åº“è¿æ¥æ•°åªæœ‰10ä¸ªï¼Œè¿™æ˜¯æˆ‘ä»¬å¿…é¡»æ§åˆ¶åªæœ‰10ä¸ªçº¿ç¨‹åŒæ—¶è·å–æ•°æ®åº“è¿æ¥ä¿æŒæ•°æ®ï¼Œå¦åˆ™ä¼šæŠ¥é”™æ— æ³•è·å–æ•°æ®åº“è¿æ¥ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨Semaphoreæ¥åšæµé‡æ§åˆ¶ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private static final int THREAD_COUNT = 30;</span><br><span class="line">private static final ExecutorService executorService = Executors.newFixedThreadPool(THREAD_COUNT);</span><br><span class="line">private static final Semaphore s = new Semaphore(10);</span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    for (int i = 0; i &lt; THREAD_COUNT; i++) &#123;</span><br><span class="line">        executorService.execute(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                s.acquire();</span><br><span class="line">                System.out.println(&quot;save data&quot;);</span><br><span class="line">                s.release();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    executorService.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶æœ‰30ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œä½†æ˜¯åªå…è®¸10ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚<br>ä¸ºä»€ä¹ˆä¸å¼€å§‹åˆ›å»º10ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± å‘¢ï¼Ÿå› ä¸ºå‰é¢éœ€è¦30ä¸ªï¼Œåªæ˜¯åœ¨ä»£ç æŸéƒ¨åˆ†é™åˆ¶10ä¸ªã€‚<br>æ„é€ æ–¹æ³•Semaphore(int permits)æ¥æ”¶ä¸€ä¸ªæ•´å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºå¯ç”¨çš„è®¸å¯è¯æ•°é‡ã€‚<br>Semaphoreçš„acquire()æ–¹æ³•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œè·å–ä¸åˆ°å°±é˜»å¡ï¼Œä½¿ç”¨å®Œä¹‹åè°ƒç”¨release()æ–¹æ³•å½’è¿˜è®¸å¯è¯ã€‚è¿˜å¯ä»¥ä½¿ç”¨tryAcquire()æ–¹æ³•å°è¯•è·å–è®¸å¯è¯ã€‚</p>
<p>å…¶ä»–æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">intavailablePermits():è¿”å›ä¿¡å·é‡ä¸­å½“å‰å¯ç”¨çš„è®¸å¯è¯æ•°ç›®ã€‚</span><br><span class="line">ingetQueueLength():è¿”å›æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹æ•°ã€‚</span><br><span class="line">booleanhasQueueThreads():æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–è®¸å¯è¯</span><br><span class="line">void reducePermits(int reduction):å‡å°‘reductionä¸ªè®¸å¯è¯ï¼Œæ˜¯ä¸ªprotectedæ–¹æ³•ã€‚</span><br><span class="line">Collection getQueuedThreads():è¿”å›æ‰€æœ‰ç­‰å¾…è·å–è®¸å¯è¯çš„çº¿ç¨‹é›†åˆï¼Œæ˜¯ä¸ªprotectedæ–¹æ³•ã€‚</span><br></pre></td></tr></table></figure>

<h3 id="5-çº¿ç¨‹é—´äº¤äº’æ•°æ®çš„Exchanger"><a href="#5-çº¿ç¨‹é—´äº¤äº’æ•°æ®çš„Exchanger" class="headerlink" title="5.çº¿ç¨‹é—´äº¤äº’æ•°æ®çš„Exchanger"></a>5.çº¿ç¨‹é—´äº¤äº’æ•°æ®çš„Exchanger</h3><p>Exchangerï¼ˆäº¤æ¢è€…ï¼‰æ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ã€‚Exchangerç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢ã€‚å®ƒæä¾›ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œåœ¨è¿™ä¸ªåŒæ­¥ç‚¹ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯ä»¥äº¤æ¢å½¼æ­¤çš„æ•°æ®ã€‚è¿™ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡exhange()æ–¹æ³•äº¤æ¢æ•°æ®ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œexhange()æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œexchangeæ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½è¾¾åˆ°åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œå°†æœ¬çº¿ç¨‹ç”Ÿäº§å‡ºæ¥çš„æ•°æ®ä¼ é€’ç»™å¯¹æ–¹ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼šå¯ç”¨äºé—ä¼ ç®—æ³•ï¼Œå°†ä¸¤ä¸ªäººä½œä¸ºäº¤é…å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªäººçš„æ•°æ®ã€‚è¿˜å¯ä»¥ç”¨äºæ ¡å¯¹å·¥ä½œï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦å°†çº¸è´¨é“¶è¡Œæµæ°´é€šè¿‡äººå·¥çš„æ–¹å¼å½•å…¥æˆç”µå­é“¶è¡Œæµæ°´ï¼Œä¸ºäº†é¿å…é”™è¯¯ï¼Œé‡‡ç”¨ABå²—ä¸¤äººè¿›è¡Œå½•å…¥ï¼Œå½•å…¥ä¹‹åæ¯”å¯¹ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package org.example.javaer;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.Exchanger;</span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author: liuxuan</span><br><span class="line"> * @date: 2022-11-19 19:23</span><br><span class="line"> **/</span><br><span class="line">public class ExchangerTest &#123;</span><br><span class="line">    private static final Exchanger&lt;String&gt; exgr = new Exchanger&lt;&gt;();</span><br><span class="line">    private static final ExecutorService threadPool = Executors.newFixedThreadPool(2);</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        threadPool.execute(() -&gt; &#123;</span><br><span class="line">            String a = &quot;é“¶è¡Œæµæ°´A&quot;;</span><br><span class="line">            try &#123;</span><br><span class="line">                String exchange = exgr.exchange(a);</span><br><span class="line">                System.out.println(&quot;B å½•å…¥çš„æ˜¯:&quot; + exchange + &quot; Aå½•å…¥çš„æ˜¯ï¼š&quot; + a);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        threadPool.execute(() -&gt; &#123;</span><br><span class="line">            String b = &quot;é“¶è¡Œæµæ°´B&quot;;</span><br><span class="line">            try &#123;</span><br><span class="line">                String exchange = exgr.exchange(b);</span><br><span class="line">                System.out.println(&quot;A å½•å…¥çš„æ˜¯:&quot; + exchange + &quot; Bå½•å…¥çš„æ˜¯ï¼š&quot; + b);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ªæ²¡æœ‰æ‰§è¡Œexchange()æ–¹æ³•ï¼Œåˆ™ä¼šä¸€ç›´ç­‰å¾…ï¼Œå¦‚æœå•å‘ç‰¹æ®Šæƒ…å†µå‘ç”Ÿï¼Œé¿å…ä¸€ç›´ç­‰å¾…ï¼Œå¯ä»¥ä½¿ç”¨<code>exchange(V x, long timeout, TimeUnit unit)</code>è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ã€‚</p>
<p>åŸä¹¦ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/tianzhonghaoqing/article/details/123976376">https://blog.csdn.net/tianzhonghaoqing/article/details/123976376</a></p>
<h2 id="ç¬¬ä¹ç« -javaä¸­çš„çº¿ç¨‹æ± "><a href="#ç¬¬ä¹ç« -javaä¸­çš„çº¿ç¨‹æ± " class="headerlink" title="ç¬¬ä¹ç«  javaä¸­çš„çº¿ç¨‹æ± "></a>ç¬¬ä¹ç«  javaä¸­çš„çº¿ç¨‹æ± </h2><p>åˆç†åœ°ä½¿ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥3ä¸ªå¥½å¤„ï¼š<br>é™ä½èµ„æºæ¶ˆè€—(é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—)<br>æé«˜å“åº”é€Ÿåº¦(å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œ)<br>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§(çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§çº¿ç¨‹)</p>
<h3 id="1-çº¿ç¨‹æ± çš„å®ç°åŸç†"><a href="#1-çº¿ç¨‹æ± çš„å®ç°åŸç†" class="headerlink" title="1.çº¿ç¨‹æ± çš„å®ç°åŸç†"></a>1.çº¿ç¨‹æ± çš„å®ç°åŸç†</h3><p>ThreadPoolExecutoræ‰§è¡Œexecuteæ–¹æ³•åˆ†ä¸‹é¢4ç§æƒ…å†µï¼š</p>
<p>1ã€å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¸ç®¡å·²æœ‰çº¿ç¨‹æ˜¯ä¸æ˜¯ç©ºé—²(éœ€è¦è·å–å…¨å±€é”)</p>
<p>2ã€å¦‚æœè¿è¡Œçš„çº¿ç¨‹ç­‰äºæˆ–å¤šäºcorePoolSizeï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥BlockingQueue</p>
<p>3ã€å¦‚æœBlockingQueueé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹(éæ ¸å¿ƒçº¿ç¨‹)æ¥å¤„ç†ä»»åŠ¡(éœ€è¦è·å–å…¨å±€é”ï¼‰</p>
<p>4ã€å¦‚æœåˆ›å»ºæ–°çº¿ç¨‹å°†ä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºmaximumPoolSizeï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ï¼Œå¹¶è°ƒç”¨RejectedExecutionHandler.rejectedExecution()æ–¹æ³•</p>
<p>å·¥ä½œçº¿ç¨‹ï¼šçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šå°†çº¿ç¨‹å°è£…æˆå·¥ä½œçº¿ç¨‹Workerï¼ŒWorkeråœ¨æ‰§è¡Œå®Œä»»åŠ¡åï¼Œè¿˜ä¼šå¾ªç¯è·å–å·¥ä½œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡æ¥æ‰§è¡Œã€‚</p>
<h3 id="2-çº¿ç¨‹æ± çš„åˆ›å»º"><a href="#2-çº¿ç¨‹æ± çš„åˆ›å»º" class="headerlink" title="2.çº¿ç¨‹æ± çš„åˆ›å»º"></a>2.çº¿ç¨‹æ± çš„åˆ›å»º</h3><p><code>new ThreadPoolExecutor(xxx)</code>ï¼Œå…¶ä¸­å‚æ•°å…·ä½“å«ä¹‰å¦‚ä¸‹ï¼š</p>
<p>1ã€corePoolSize(çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°)ï¼šå½“æäº¤ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡(å³ä½¿å…¶ä»–ç©ºé—²çš„åŸºæœ¬çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œæ–°ä»»åŠ¡ä¹Ÿä¼šåˆ›å»ºï¼Œæ»¡äº†ä¸å†åˆ›å»ºã€‚ï¼‰å¦‚æœè°ƒç”¨äº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰åŸºæœ¬çº¿ç¨‹ã€‚</p>
<p>2ã€runnableTaskQueue(ä»»åŠ¡é˜Ÿåˆ—)ï¼šç”¨äºä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ArrayBlockingQueue:åŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOåŸåˆ™å¯¹å…ƒç´ æ’åºã€‚</span><br><span class="line"></span><br><span class="line">LinkedBlockingQueue:åŸºäºé“¾è¡¨ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒFIFOåŸåˆ™ï¼Œååé‡é«˜äºArrayBlockingQueueï¼Œ</span><br><span class="line">é™æ€å·¥å‚æ–¹æ³•Executors.newFixedThreadPool()ä½¿ç”¨è¯¥é˜Ÿåˆ—ã€‚</span><br><span class="line"></span><br><span class="line">SynchronousQueue:ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´é˜»å¡ã€‚ååé‡é«˜äºLinkedBlockingQueueã€‚</span><br><span class="line">é™æ€å·¥å‚æ–¹æ³•Executors.newCachedThreadPoolä½¿ç”¨è¯¥é˜Ÿåˆ—ã€‚</span><br><span class="line"></span><br><span class="line">PriorityBlockingQueue:ä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—ã€‚</span><br></pre></td></tr></table></figure>

<p>3ã€maximumPoolSize(çº¿ç¨‹æ± æœ€å¤§æ•°é‡)ï¼šçº¿ç¨‹æ± å…è®¸åˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”å·²åˆ›å»ºçš„çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™çº¿ç¨‹æ± ä¼šå†åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚å¦‚æœä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œæ”¹å‚æ•°æ²¡æ•ˆæœã€‚</p>
<p>4ã€ThreadFactoryï¼šè®¾ç½®åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œå¯ä»¥ç»™çº¿ç¨‹å‘½åã€‚</p>
<p>5ã€RejectedExecutionHandler(é¥±å’Œç­–ç•¥)ï¼šå½“é˜Ÿåˆ—å’Œçº¿ç¨‹æ± éƒ½æ»¡äº†ï¼Œåˆ™é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†æäº¤çš„æ–°ä»»åŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AbortPolicy(é»˜è®¤)ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</span><br><span class="line">CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡ã€‚</span><br><span class="line">DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—é‡Œæœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</span><br><span class="line">DiscardPolicyï¼šä¸å¤„ç†ï¼Œä¸¢å¼ƒæ‰ä¸”ä¸æŠ›å‡ºå¼‚å¸¸</span><br></pre></td></tr></table></figure>

<p>6ã€keepAliveTime(çº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´)ï¼šçº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ç©ºé—²åä¿æŒå­˜æ´»çš„æ—¶é—´(è¶…è¿‡è¯¥æ—¶é•¿ï¼Œéæ ¸å¿ƒçº¿ç¨‹å°±ä¼šè¢«å›æ”¶)</p>
<p>7ã€TimeUnit(çº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´çš„å•ä½)</p>
<h3 id="3-å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡"><a href="#3-å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡" class="headerlink" title="3.å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡"></a>3.å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡</h3><ul>
<li>execute()ï¼šç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸ</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">threadsPool.execute(new Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>submit()ï¼šç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡(è¿”å›futureç±»å‹çš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸä¸”å¯ä»¥é€šè¿‡å¯¹è±¡çš„get()æ¥è·å–è¿”å›å€¼).<br>get()æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆã€‚<code>get(long timeout, TimeUnit unit)</code>å¯é˜»å¡ä¸€æ®µæ—¶é—´åç«‹å³è¿”å›ã€‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;Object&gt; future = executor.submit(harReturnValuetask);</span><br><span class="line">    try &#123;</span><br><span class="line">    	Object s = future.get();</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">    	// å¤„ç†ä¸­æ–­å¼‚å¸¸</span><br><span class="line">    &#125; catch (ExecutionException e) &#123;</span><br><span class="line">    	// å¤„ç†æ— æ³•æ‰§è¡Œä»»åŠ¡å¼‚å¸¸</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">    	// å…³é—­çº¿ç¨‹æ± </span><br><span class="line">    	executor.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-å…³é—­çº¿ç¨‹æ± "><a href="#4-å…³é—­çº¿ç¨‹æ± " class="headerlink" title="4.å…³é—­çº¿ç¨‹æ± "></a>4.å…³é—­çº¿ç¨‹æ± </h3><p>çº¿ç¨‹æ± çš„shutdownæˆ–shutdownNowæ–¹æ³•å…³é—­çº¿ç¨‹æ± ï¼ŒåŸç†æ˜¯éå†çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œç„¶åé€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹ã€‚</p>
<p>æ— æ³•å“åº”ä¸­æ–­çš„çº¿ç¨‹å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ã€‚</p>
<p>shutdown =&gt; å¹³ç¼“å…³é—­ï¼Œç­‰å¾…æ‰€æœ‰å·²æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œå†å…³é—­<br>shutdownNow =&gt; ç«‹åˆ»å…³é—­ï¼Œåœæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶è¿”å›é˜Ÿåˆ—ä¸­æœªæ‰§è¡Œçš„ä»»åŠ¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">shutdownå’ŒshutdownNowï¼š</span><br><span class="line">1ã€shutdown()</span><br><span class="line">é˜»æ­¢æ–°æ¥çš„ä»»åŠ¡æäº¤ï¼Œå¯¹å·²ç»æäº¤äº†çš„ä»»åŠ¡ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚</span><br><span class="line">å½“å·²ç»æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œå®ƒä¼šå°†é‚£äº›é—²ç½®çš„çº¿ç¨‹ï¼ˆidleWorksï¼‰è¿›è¡Œä¸­æ–­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã€‚</span><br><span class="line">å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹æˆSHUTDOWNï¼Œå½“å†å°†æ‰§è¡Œexecuteæäº¤ä»»åŠ¡æ—¶ï¼Œå¦‚æœæµ‹è¯•åˆ°çŠ¶æ€ä¸ä¸ºRUNNINGï¼Œåˆ™æŠ›å‡ºrejectedExecutionï¼Œä»è€Œè¾¾åˆ°é˜»æ­¢æ–°ä»»åŠ¡æäº¤çš„ç›®çš„ã€‚</span><br><span class="line"></span><br><span class="line">2ã€shutdownNow()</span><br><span class="line">é˜»æ­¢æ–°æ¥çš„ä»»åŠ¡æäº¤ï¼ŒåŒæ—¶ä¼šä¸­æ–­å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œå³workersä¸­çš„çº¿ç¨‹ã€‚</span><br><span class="line">å®ƒè¿˜å°†workQueueä¸­çš„ä»»åŠ¡ç»™ç§»é™¤ï¼Œå¹¶å°†è¿™äº›ä»»åŠ¡æ·»åŠ åˆ°åˆ—è¡¨ä¸­è¿›è¡Œè¿”å›ã€‚</span><br><span class="line">é€šè¿‡å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹æˆSTOPï¼Œå½“å†å°†æ‰§è¡Œexecuteæäº¤ä»»åŠ¡æ—¶ï¼Œå¦‚æœæµ‹è¯•åˆ°çŠ¶æ€ä¸ä¸ºRUNNINGï¼Œåˆ™æŠ›å‡ºrejectedExecutionï¼Œä»è€Œè¾¾åˆ°é˜»æ­¢æ–°ä»»åŠ¡æäº¤çš„ç›®çš„.</span><br><span class="line">ä¸€ä¸ªç‰¹ä¾‹ï¼š</span><br><span class="line">ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨sleepçŠ¶æ€ä¸­ï¼Œæ­¤æ—¶æ‰§è¡ŒshutdownNow()ï¼Œ</span><br><span class="line">å®ƒå‘è¯¥çº¿ç¨‹å‘èµ·interrupt()è¯·æ±‚ï¼Œè€Œsleep()æ–¹æ³•é‡åˆ°æœ‰interrupt()è¯·æ±‚æ—¶ï¼Œä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—</span><br><span class="line">å¦‚æœcatchäº†ï¼Œå¹¶æ²¡æœ‰åœ¨catchä¸­å†interrupt()ï¼Œä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</span><br><span class="line">å¦‚æœå‘å¤–æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šä¸­æ–­</span><br></pre></td></tr></table></figure>

<h3 id="5-åˆç†é…ç½®çº¿ç¨‹æ± "><a href="#5-åˆç†é…ç½®çº¿ç¨‹æ± " class="headerlink" title="5.åˆç†é…ç½®çº¿ç¨‹æ± "></a>5.åˆç†é…ç½®çº¿ç¨‹æ± </h3><p>1ã€ä»»åŠ¡çš„æ€§è´¨ï¼š</p>
<p>CPUå¯†é›†å‹ä»»åŠ¡ï¼šé…ç½®å°½å¯èƒ½å°çš„çº¿ç¨‹(Ncpu+1)ï¼Œå› ä¸ºCPUå¯†é›†å‹ä»»åŠ¡ä½¿å¾—CPUä½¿ç”¨ç‡å¾ˆé«˜ï¼Œè‹¥å¼€è¿‡å¤šçš„çº¿ç¨‹æ•°èƒ½å¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ï¼Œå¸¦æ¥é¢å¤–çš„å¼€é”€ã€‚</p>
<p>IOå¯†é›†å‹ä»»åŠ¡ï¼šé…ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹(2*Ncpu)ï¼Œå› ä¸ºCPUä½¿ç”¨ç‡å¹¶ä¸é«˜ï¼Œå¯ä»¥è®©CPUåœ¨ç­‰å¾…IOçš„æ—¶å€™å»å¤„ç†åˆ«çš„ä»»åŠ¡ï¼Œå……åˆ†åˆ©ç”¨CPUæ—¶é—´ã€‚</p>
<p>æ··åˆå‹ä»»åŠ¡ï¼šå¯å°†ä»»åŠ¡åˆ†æˆIOå¯†é›†å‹å’ŒCPUå¯†é›†å‹ä»»åŠ¡(ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ç›¸å·®ä¸å¤§æ—¶)ï¼Œç„¶ååˆ†åˆ«ç”¨ä¸åŒçš„çº¿ç¨‹æ± å»å¤„ç†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CPUå¯†é›†å‹å’ŒIOå¯†é›†å‹ï¼š</span><br><span class="line">CPUå¯†é›†å‹ï¼šéœ€éå¸¸å¤šCPUè®¡ç®—èµ„æºï¼Œè®©æ¯ä¸ªCPUæ ¸å¿ƒéƒ½å‚ä¸è®¡ç®—ï¼ŒCPUæ€§èƒ½å……åˆ†åˆ©ç”¨ï¼Œåº”é¿å…è¿‡å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</span><br><span class="line">IOå¯†é›†å‹ï¼šç½‘ç»œã€ç£ç›˜ IO ï¼ˆä¸DBã€ç¼“å­˜ï¼‰ï¼Œä¸€æ—¦IOï¼Œçº¿ç¨‹å°±ç­‰å¾…ï¼Œç»“æŸæ‰æ‰§è¡Œã€‚å¤šè®¾çº¿ç¨‹æ•°ï¼Œç­‰å¾…æ—¶å»åšå…¶å®ƒäº‹ï¼Œæé«˜æ•ˆç‡ã€‚</span><br></pre></td></tr></table></figure>

<p>2ã€ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼šä¼˜å…ˆçº§ä¸åŒçš„ä»»åŠ¡å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—PriorityBlockingQueueæ¥å¤„ç†</p>
<p>3ã€ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼šå¯ä»¥äº¤ç»™ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œæˆ–è€…ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚æ‰§è¡Œæ—¶é—´çŸ­çš„å…ˆæ‰§è¡Œ</p>
<p>4ã€ä»»åŠ¡çš„ä¾èµ–æ€§ï¼šæ¯”å¦‚ä¾èµ–æ•°æ®åº“è¿æ¥æ± çš„ä»»åŠ¡ï¼Œçº¿ç¨‹æäº¤SQLåéœ€è¦ç­‰å¾…æ•°æ®åº“è¿”å›ç»“æœï¼Œç­‰å¾…çš„æ—¶é—´è¶Šé•¿ï¼ŒCPUç©ºé—²æ—¶é—´å°±è¶Šé•¿(ç›¸å½“äºIOå¯†é›†å‹ä»»åŠ¡ï¼Œåº”è®¾ç½®è¾ƒå¤§çº¿ç¨‹æ•°)</p>
<p>5ã€å»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¯ä»¥å¢åŠ ç³»ç»Ÿç¨³å®šæ€§å’Œé¢„è­¦èƒ½åŠ›ï¼Œå†æŠ›å¼ƒä»»åŠ¡çš„æ—¶å€™åŠ ç›‘æ§ï¼Œæ— ç•Œé˜Ÿåˆ—ä¼šæ’‘æ»¡å†…å­˜ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸èƒ½ç”¨ã€‚</p>
<h3 id="6-çº¿ç¨‹æ± çš„ç›‘æ§"><a href="#6-çº¿ç¨‹æ± çš„ç›‘æ§" class="headerlink" title="6.çº¿ç¨‹æ± çš„ç›‘æ§"></a>6.çº¿ç¨‹æ± çš„ç›‘æ§</h3><p>å¦‚æœåœ¨ç³»ç»Ÿä¸­å¤§é‡ä½¿ç”¨çº¿ç¨‹æ± ï¼Œåˆ™éœ€è¦å¯¹çº¿ç¨‹æ± è¿›è¡Œç›‘æ§ï¼Œåœ¨å‡ºç°é—®é¢˜æ—¶ï¼Œå¯æ ¹æ®çº¿ç¨‹æ± çš„ä½¿ç”¨çŠ¶å†µå¿«é€Ÿå®šä½é—®é¢˜ã€‚å¯ä½¿ç”¨ä»¥ä¸‹å±æ€§ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">taskCountï¼šçº¿ç¨‹æ± éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡</span><br><span class="line">completedTaskCountï¼šçº¿ç¨‹æ± åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡</span><br><span class="line">largestPoolSizeï¼šçº¿ç¨‹æ± é‡Œæ›¾ç»åˆ›å»ºè¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡</span><br><span class="line">getPoolSizeï¼šçº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡(çº¿çº¿ç¨‹æ± ä¸é”€æ¯çš„è¯ï¼Œçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹ä¸ä¼šè‡ªåŠ¨é”€æ¯)</span><br><span class="line">getActiveCountï¼šè·å–æ´»åŠ¨çš„çº¿ç¨‹æ•°</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç»§æ‰¿çº¿ç¨‹æ± æ¥è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œé‡å†™çº¿ç¨‹æ± çš„beforeExecuteã€afterExecuteå’Œterminatedæ–¹æ³•è¿›è¡Œç›‘æ§ã€‚åœ¨æ‰§è¡Œå‰ã€æ‰§è¡Œåã€çº¿ç¨‹æ± å…³é—­å‰ç›‘æ§ï¼Œæ¯”å¦‚ï¼šä»»åŠ¡å¹³å‡æ‰§è¡Œæ—¶é—´ï¼Œæœ€å¤§æ‰§è¡Œæ—¶é—´ï¼Œæœ€å°æ‰§è¡Œæ—¶é—´ã€‚</p>
<h3 id="7-Executorsçš„çº¿ç¨‹æ± ï¼š"><a href="#7-Executorsçš„çº¿ç¨‹æ± ï¼š" class="headerlink" title="7.Executorsçš„çº¿ç¨‹æ± ï¼š"></a>7.Executorsçš„çº¿ç¨‹æ± ï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">å®šé•¿çº¿ç¨‹æ± (FixedThreadPool)ï¼šç”¨äºæ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°</span><br><span class="line">åªæœ‰æ ¸å¿ƒçº¿ç¨‹</span><br><span class="line">çº¿ç¨‹æ•°é‡å›ºå®š</span><br><span class="line">æ‰§è¡Œå®Œç«‹å³å›æ”¶</span><br><span class="line">ä»»åŠ¡é˜Ÿåˆ—ä¸ºé“¾è¡¨ç»“æ„çš„æœ‰ç•Œé˜Ÿåˆ—(æ¶ˆè€—å†…å­˜)</span><br><span class="line"></span><br><span class="line">å®šæ—¶çº¿ç¨‹æ± (ScheduledThreadPool)ï¼šç”¨äºæ‰§è¡Œå®šæ—¶æˆ–å‘¨æœŸæ€§çš„ä»»åŠ¡</span><br><span class="line">æ ¸å¿ƒçº¿ç¨‹æ•°é‡å›ºå®š</span><br><span class="line">éæ ¸å¿ƒçº¿ç¨‹æ•°é‡æ— é™(çº¿ç¨‹è¿‡å¤šå¯¼è‡´å†…å­˜æº¢å‡º)</span><br><span class="line">æ‰§è¡Œå®Œé—²ç½®10msåå›æ”¶</span><br><span class="line">ä»»åŠ¡é˜Ÿåˆ—ä¸ºå»¶æ—¶é˜»å¡é˜Ÿåˆ—</span><br><span class="line"></span><br><span class="line">å¯ç¼“å­˜çº¿ç¨‹æ± (CachedThreadPool)ï¼šæ‰§è¡Œå¤§é‡ä¸”è€—æ—¶å°‘çš„ä»»åŠ¡</span><br><span class="line">æ— æ ¸å¿ƒçº¿ç¨‹</span><br><span class="line">éæ ¸å¿ƒçº¿ç¨‹æ•°é‡æ— é™(çº¿ç¨‹è¿‡å¤šå¯¼è‡´å†…å­˜æº¢å‡º)</span><br><span class="line">æ‰§è¡Œå®Œé—²ç½®60såå›æ”¶</span><br><span class="line">ä»»åŠ¡é˜Ÿåˆ—ä¸ºä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—</span><br><span class="line"></span><br><span class="line">å•çº¿ç¨‹åŒ–çº¿ç¨‹æ± (SingleThreadExecutor)ï¼šåº”ç”¨äºä¸é€‚åˆå¹¶å‘ä½†å¯èƒ½å¼•èµ·IOé˜»å¡æ€§åŠå½±å“UIçº¿ç¨‹å“åº”çš„æ“ä½œï¼Œå¦‚æ•°æ®åº“æ“ä½œ</span><br><span class="line">åªæœ‰1ä¸ªæ ¸å¿ƒçº¿ç¨‹</span><br><span class="line">æ— éæ ¸å¿ƒçº¿ç¨‹</span><br><span class="line">æ‰§è¡Œå®Œç«‹å³å›æ”¶</span><br><span class="line">ä»»åŠ¡é˜Ÿåˆ—ä¸ºé“¾è¡¨ç»“æ„çš„æœ‰ç•Œé˜Ÿåˆ—(æ¶ˆè€—å†…å­˜)</span><br></pre></td></tr></table></figure>

<p>åŸä¹¦ç¬”è®°ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41398418/article/details/126279652">https://blog.csdn.net/qq_41398418/article/details/126279652</a></p>
<h2 id="ç¬¬åç« -Executoræ¡†æ¶"><a href="#ç¬¬åç« -Executoræ¡†æ¶" class="headerlink" title="ç¬¬åç«  Executoræ¡†æ¶"></a>ç¬¬åç«  Executoræ¡†æ¶</h2><p>åœ¨Javaä¸­ï¼Œä½¿ç”¨çº¿ç¨‹æ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚Javaçº¿ç¨‹çš„åˆ›å»ºä¸é”€æ¯éœ€è¦ä¸€å®šçš„å¼€é”€ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºæ¯ä¸€ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè¿™äº›çº¿ç¨‹çš„åˆ›å»ºä¸é”€æ¯å°†æ¶ˆè€—å¤§é‡çš„è®¡ç®—èµ„æºã€‚åŒæ—¶ï¼Œ ä¸ºæ¯ä¸€ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè¿™ç§ç­–ç•¥å¯èƒ½ä¼šä½¿å¤„äºé«˜è´Ÿè·çŠ¶æ€çš„åº”ç”¨æœ€ç»ˆå´©æºƒã€‚</p>
<p>Javaçš„çº¿ç¨‹æ—¢æ˜¯å·¥ä½œå•å…ƒï¼Œä¹Ÿæ˜¯æ‰§è¡Œæœºåˆ¶ã€‚ä»JDK 5å¼€å§‹ï¼ŒæŠŠå·¥ä½œå•å…ƒä¸æ‰§è¡Œæœºåˆ¶åˆ†ç¦»å¼€æ¥ã€‚å·¥ä½œå•å…ƒåŒ…æ‹¬Runnableå’ŒCallableï¼Œè€Œæ‰§è¡Œæœºåˆ¶ç”±Executoræ¡†æ¶æä¾›ã€‚</p>
<h3 id="1-Executoræ¡†æ¶"><a href="#1-Executoræ¡†æ¶" class="headerlink" title="1.Executoræ¡†æ¶"></a>1.Executoræ¡†æ¶</h3><h4 id="âœ…Executoræ¡†æ¶çš„ä¸¤çº§è°ƒåº¦æ¨¡å‹"><a href="#âœ…Executoræ¡†æ¶çš„ä¸¤çº§è°ƒåº¦æ¨¡å‹" class="headerlink" title="âœ…Executoræ¡†æ¶çš„ä¸¤çº§è°ƒåº¦æ¨¡å‹"></a>âœ…Executoræ¡†æ¶çš„ä¸¤çº§è°ƒåº¦æ¨¡å‹</h4><p>åœ¨HotSpot VMçš„çº¿ç¨‹æ¨¡å‹ä¸­ï¼ŒJavaçº¿ç¨‹ï¼ˆjava.lang.Threadï¼‰è¢«ä¸€å¯¹ä¸€æ˜ å°„ä¸ºæœ¬åœ°æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚æ“ä½œç³»ç»Ÿä¼šè°ƒåº¦æ‰€æœ‰çº¿ç¨‹å¹¶å°†å®ƒä»¬åˆ†é…ç»™å¯ç”¨çš„CPUã€‚</p>
<p><strong>ä¸¤çº§è°ƒåº¦æ¨¡å‹</strong>ï¼š<br>åœ¨ä¸Šå±‚ï¼ŒJavaå¤šçº¿ç¨‹ç¨‹åºé€šå¸¸æŠŠåº”ç”¨åˆ†è§£ä¸ºè‹¥å¹²ä¸ªä»»åŠ¡ï¼Œç„¶åä½¿ç”¨ç”¨æˆ·çº§çš„è°ƒåº¦å™¨ï¼ˆExecutoræ¡†æ¶ï¼‰å°†è¿™äº›ä»»åŠ¡æ˜ å°„ä¸ºå›ºå®šæ•°é‡çš„çº¿ç¨‹ï¼›åœ¨åº•å±‚ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸å°†è¿™äº›çº¿ç¨‹æ˜ å°„åˆ°ç¡¬ä»¶å¤„ç†å™¨ä¸Šã€‚<br><em>åº”ç”¨ç¨‹åºé€šè¿‡Executoræ¡†æ¶æ§åˆ¶ä¸Šå±‚çš„è°ƒåº¦ï¼›è€Œä¸‹å±‚çš„è°ƒåº¦ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ§åˆ¶ï¼Œä¸‹å±‚çš„è°ƒåº¦ä¸å—åº”ç”¨ç¨‹åºçš„æ§åˆ¶ã€‚</em></p>
<h4 id="âœ…Executoræ¡†æ¶çš„ç»“æ„"><a href="#âœ…Executoræ¡†æ¶çš„ç»“æ„" class="headerlink" title="âœ…Executoræ¡†æ¶çš„ç»“æ„"></a>âœ…Executoræ¡†æ¶çš„ç»“æ„</h4><p>Executoræ¡†æ¶ä¸»è¦ç”±3å¤§éƒ¨åˆ†ç»„æˆï¼š</p>
<p>1ã€ä»»åŠ¡ã€‚åŒ…æ‹¬è¢«æ‰§è¡Œä»»åŠ¡éœ€è¦å®ç°çš„æ¥å£ï¼šRunnableæ¥å£æˆ–Callableæ¥å£ã€‚</p>
<p>2ã€ä»»åŠ¡çš„æ‰§è¡Œã€‚åŒ…æ‹¬ä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£Executorï¼Œä»¥åŠå®ç°è‡ªExecutorçš„ExecutorServiceæ¥å£ã€‚Executoræ¡†æ¶æœ‰ä¸¤ä¸ªå…³é”®ç±»å®ç°äº†ExecutorServiceæ¥å£ï¼ˆThreadPoolExecutorå’Œ<br>ScheduledThreadPoolExecutorï¼‰ã€‚</p>
<p>3ã€å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚åŒ…æ‹¬æ¥å£Futureå’Œå®ç°Futureæ¥å£çš„FutureTaskç±»ã€‚</p>
<hr>
<p>Executoræ¡†æ¶çš„ç±»ä¸æ¥å£ï¼š</p>
<p>1ã€Executoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ˜¯Executoræ¡†æ¶çš„åŸºç¡€ï¼Œå®ƒå°†ä»»åŠ¡çš„æäº¤ä¸ä»»åŠ¡çš„æ‰§è¡Œåˆ†ç¦»å¼€æ¥ã€‚</p>
<p>2ã€ExecutorServiceæ¥å£ï¼Œå®ç°è‡ªExecutoræ¥å£ã€‚</p>
<p>3ã€ThreadPoolExecutorç±»æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°ç±»ï¼Œç”¨æ¥æ‰§è¡Œè¢«æäº¤çš„ä»»åŠ¡ã€‚</p>
<p>4ã€ScheduledThreadPoolExecutoræ˜¯ä¸€ä¸ªå®ç°ç±»ï¼Œå¯ä»¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œå‘½ä»¤ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œå‘½ä»¤ã€‚<br>ScheduledThreadPoolExecutoræ¯”Timeræ›´çµæ´»ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€‚</p>
<p>5ã€Futureæ¥å£å’Œå®ç°Futureæ¥å£çš„FutureTaskç±»ï¼Œä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚</p>
<p>6ã€Runnableæ¥å£å’ŒCallableæ¥å£çš„å®ç°ç±»ï¼Œéƒ½å¯ä»¥è¢«ThreadPoolExecutoræˆ–Scheduled- ThreadPoolExecutoræ‰§è¡Œã€‚</p>
<hr>
<p>ä½¿ç”¨æ­¥éª¤ï¼š</p>
<p>1.åˆ›å»ºä»»åŠ¡å¯¹è±¡ï¼šä¸»çº¿ç¨‹åˆ›å»ºå®ç°Runnableæˆ–è€…Callableæ¥å£çš„ä»»åŠ¡å¯¹è±¡ã€‚<code>å·¥å…·ç±»Executorså¯ä»¥æŠŠä¸€ä¸ªRunnableå¯¹è±¡å°è£…ä¸ºä¸€ä¸ªCallableå¯¹è±¡ï¼ˆExecutors.callableï¼ˆRunnable taskï¼‰æˆ–Executors.callableï¼ˆRunnable taskï¼ŒObject resuleï¼‰ï¼‰</code></p>
<p>2.ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œï¼šæŠŠRunnableå¯¹è±¡ç›´æ¥äº¤ç»™ExecutorServiceæ‰§è¡Œ<code>ï¼ˆExecutorService.executeï¼ˆRunnable commandï¼‰ï¼‰</code>ï¼›æˆ–è€…ä¹Ÿå¯ä»¥æŠŠRunnableå¯¹è±¡æˆ–Callableå¯¹è±¡æäº¤ç»™ExecutorServiceæ‰§è¡Œ<code>ï¼ˆExecutorService.submitï¼ˆRunnable taskï¼‰æˆ–ExecutorService.submitï¼ˆCallabletaskï¼‰ï¼‰</code><br>å¦‚æœæ‰§è¡ŒExecutorService.submitï¼ˆâ€¦ï¼‰ï¼ŒExecutorServiceå°†è¿”å›ä¸€ä¸ªå®ç°Futureæ¥å£çš„å¯¹è±¡ï¼ˆåˆ°ç›®å‰ä¸ºæ­¢çš„JDKä¸­ï¼Œè¿”å›çš„æ˜¯FutureTaskå¯¹è±¡ï¼‰ã€‚ç”±äºFutureTaskå®ç°äº†Runnableï¼Œç¨‹åºå‘˜ä¹Ÿå¯ä»¥åˆ›å»ºFutureTaskï¼Œç„¶åç›´æ¥äº¤ç»™ExecutorServiceæ‰§è¡Œã€‚</p>
<p>3.submitçš„è·å–ç»“æœï¼šä¸»çº¿ç¨‹å¯ä»¥æ‰§è¡Œ<code>FutureTask.get()</code>æ–¹æ³•æ¥ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥æ‰§è¡Œ<code>FutureTask.cancelï¼ˆboolean mayInterruptIfRunningï¼‰</code>æ¥å–æ¶ˆæ­¤ä»»åŠ¡çš„æ‰§è¡Œã€‚</p>
<h4 id="âœ…-Executoræ¡†æ¶çš„æˆå‘˜"><a href="#âœ…-Executoræ¡†æ¶çš„æˆå‘˜" class="headerlink" title="âœ… Executoræ¡†æ¶çš„æˆå‘˜"></a>âœ… Executoræ¡†æ¶çš„æˆå‘˜</h4><p>Executoræ¡†æ¶çš„ä¸»è¦æˆå‘˜ï¼šThreadPoolExecutorã€<br>ScheduledThreadPoolExecutorã€Futureæ¥å£ã€Runnableæ¥å£ã€Callableæ¥å£å’ŒExecutorsã€‚</p>
<hr>
<p>ï¼ˆ1ï¼‰ ThreadPoolExecutor</p>
<p>ThreadPoolExecutorå¯ä»¥ä½¿ç”¨å·¥å‚ç±»Executorsæ¥åˆ›å»ºã€‚Executorså¯ä»¥åˆ›å»º3ç§ç±»å‹çš„ThreadPoolExecutorï¼šSingleThreadExecutorã€FixedThreadPoolå’ŒCachedThreadPoolã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å›ºå®šçº¿ç¨‹æ•°çš„FixedThreadPoolçš„ APIã€‚</span><br><span class="line">é€‚ç”¨äºä¸ºäº†æ»¡è¶³èµ„æºç®¡ç†çš„éœ€æ±‚ï¼Œè€Œéœ€è¦é™åˆ¶å½“å‰çº¿ç¨‹æ•°é‡çš„åº”ç”¨åœºæ™¯ï¼Œå®ƒé€‚ç”¨äºè´Ÿè½½æ¯”è¾ƒé‡çš„æœåŠ¡å™¨ã€‚</span><br><span class="line">public static ExecutorService newFixedThreadPool(int nThreads) &#123;</span><br><span class="line">    return new ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">        0L, TimeUnit.MILLISECONDS,</span><br><span class="line">        new LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å•ä¸ªçº¿ç¨‹çš„SingleThreadExecutorçš„API.</span><br><span class="line">é€‚ç”¨äºéœ€è¦ä¿è¯é¡ºåºåœ°æ‰§è¡Œå„ä¸ªä»»åŠ¡ï¼›åªè¦ä¸€ä¸ªçº¿ç¨‹çš„åº”ç”¨åœºæ™¯ã€‚</span><br><span class="line">public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) &#123;</span><br><span class="line">    return new FinalizableDelegatedExecutorService(new ThreadPoolExecutor(1, 1,</span><br><span class="line">        0L, TimeUnit.MILLISECONDS,</span><br><span class="line">        new LinkedBlockingQueue&lt;Runnable&gt;(),</span><br><span class="line">        threadFactory));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CachedThreadPoolæ˜¯å¤§å°æ— ç•Œçš„çº¿ç¨‹æ± ï¼Œ</span><br><span class="line">é€‚ç”¨äºæ‰§è¡Œå¾ˆå¤šçš„çŸ­æœŸå¼‚æ­¥ä»»åŠ¡çš„å°ç¨‹åºï¼Œæˆ–è€… æ˜¯è´Ÿè½½è¾ƒè½»çš„æœåŠ¡å™¨ã€‚</span><br><span class="line">public static ExecutorService newCachedThreadPool() &#123;</span><br><span class="line">    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,</span><br><span class="line">        60L, TimeUnit.SECONDS,</span><br><span class="line">        new SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>ï¼ˆ2ï¼‰ ScheduledThreadPoolExecutor<br>ScheduledThreadPoolExecutorå¯ä»¥ä½¿ç”¨å·¥å‚ç±»Executorsæ¥åˆ›å»ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ScheduledThreadPoolExecutorã€‚</span><br><span class="line">åŒ…å«è‹¥å¹²ä¸ªçº¿ç¨‹çš„ScheduledThreadPoolExecutorã€‚</span><br><span class="line">é€‚ç”¨äºéœ€è¦å¤šä¸ªåå°çº¿ç¨‹æ‰§è¡Œå‘¨æœŸä»»åŠ¡</span><br><span class="line">public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) &#123;</span><br><span class="line">    return new ScheduledThreadPoolExecutor(corePoolSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SingleThreadScheduledExecutorã€‚</span><br><span class="line">åªåŒ…å«ä¸€ä¸ªçº¿ç¨‹çš„ScheduledThreadPoolExecutorã€‚</span><br><span class="line">public static ScheduledExecutorService newSingleThreadScheduledExecutor() &#123;</span><br><span class="line">    return new DelegatedScheduledExecutorService</span><br><span class="line">        (new ScheduledThreadPoolExecutor(1));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>ï¼ˆ3ï¼‰ Futureæ¥å£</p>
<p>Futureæ¥å£å’Œå®ç°Futureæ¥å£çš„FutureTaskç±»ç”¨æ¥è¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚å½“æˆ‘ä»¬æŠŠRunnable æ¥å£æˆ–Callableæ¥å£çš„å®ç°ç±»æäº¤ï¼ˆsubmitï¼‰ç»™ThreadPoolExecutoræˆ–<br>ScheduledThreadPoolExecutoræ—¶ï¼Œä¼šå‘æˆ‘ä»¬è¿”å›ä¸€ä¸ªFutureTaskå¯¹è±¡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">api:</span><br><span class="line">&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span><br><span class="line">&lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);</span><br><span class="line">Future&lt;?&gt; submit(Runnable task);</span><br></pre></td></tr></table></figure>

<p>åˆ°ç›®å‰æœ€æ–°çš„JDK 8ä¸ºæ­¢ï¼ŒJavaé€šè¿‡ä¸Šè¿°APIè¿”å›çš„æ˜¯ä¸€ä¸ªFutureTaskå¯¹è±¡ã€‚ä½†ä»APIå¯ä»¥çœ‹åˆ°ï¼ŒJavaä»…ä»…ä¿è¯è¿”å›çš„æ˜¯ä¸€ä¸ªå®ç°äº†Futureæ¥å£çš„å¯¹è±¡ã€‚</p>
<hr>
<p>ï¼ˆ4ï¼‰ Runnableæ¥å£å’ŒCallableæ¥å£</p>
<p>Runnableæ¥å£å’ŒCallableæ¥å£çš„å®ç°ç±»ï¼Œéƒ½å¯ä»¥è¢«ThreadPoolExecutoræˆ–Scheduled- ThreadPoolExecutoræ‰§è¡Œã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯Runnableä¸ä¼šè¿”å›ç»“æœï¼Œè€ŒCallableå¯ä»¥è¿”å›ç»“æœã€‚</p>
<p>å·¥å‚ç±»Executorså¯ä»¥æŠŠä¸€ä¸ªRunnableåŒ…è£…æˆä¸€ä¸ªCallableã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static Callable&lt;Object&gt; callable(Runnable task) //ç»“æœæ˜¯null</span><br><span class="line"></span><br><span class="line">public static &lt;T&gt; Callable&lt;T&gt; callable(Runnable task, T result)  //ç»“æœæ˜¯result</span><br></pre></td></tr></table></figure>

<h3 id="2-ThreadPoolExecutorè¯¦è§£"><a href="#2-ThreadPoolExecutorè¯¦è§£" class="headerlink" title="2.ThreadPoolExecutorè¯¦è§£"></a>2.ThreadPoolExecutorè¯¦è§£</h3><p>ä»‹ç»ä¸€ä¸‹Executorsåˆ›å»ºçš„ä¸‰ç§ç”¨çš„æ˜¯ä»€ä¹ˆå‚æ•°</p>
<p>1.FixThreadPoolå†…éƒ¨ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—çš„å®¹é‡ä¸ºInteger.MAX_VALUEï¼Œç”±äºæ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¸ä¼šæ‹’ç»ä»»åŠ¡ï¼ŒmaximumPoolæ²¡æœ‰æ„ä¹‰ï¼Œå¯èƒ½ä¼šé€ æˆä»»åŠ¡æ— é™å †ç§¯ï¼Œä»è€Œå¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½çš„æƒ…å†µã€‚</p>
<p>2.SingleThreadExecutorï¼šä¸FixThreadPoolç±»ä¼¼ï¼Œåªæ˜¯SingleThreadExecutorçš„çº¿ç¨‹æ•°å›ºå®šä¸º1</p>
<p>3.CachedThreadPoolçš„corePoolä¸ºç©ºï¼ŒmaximumPoolSizeä¸ºInteger.MAX_VALUEï¼ŒkeepAliveTimeä¸º60Lï¼Œè¿™æ„å‘³ç€çº¿ç¨‹ç©ºé—²è¶…è¿‡60ç§’åˆ™ä¼šè¿›è¡Œå›æ”¶ã€‚CachedThreadPoolå†…éƒ¨ä½¿ç”¨ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—SynchronousQueueä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç§»é™¤æ“ä½œã€‚è¿™æ„å‘³ç€å¦‚æœä»»åŠ¡çš„æäº¤é€Ÿåº¦é«˜äºçº¿ç¨‹çš„å¤„ç†é€Ÿåº¦ï¼Œé‚£ä¹ˆCachedThreadPoolåˆ™ä¼šä¸æ–­çš„åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼Œåœ¨æç«¯çš„æƒ…å†µä¸‹ï¼Œä¼šè€—å°½CPUå’Œå†…å­˜èµ„æºã€‚</p>
<h3 id="3-ScheduledThreadPoolExecutor"><a href="#3-ScheduledThreadPoolExecutor" class="headerlink" title="3.ScheduledThreadPoolExecutor"></a>3.ScheduledThreadPoolExecutor</h3><p>ScheduledThreadPoolExecutorä¸»è¦ç”¨æ¥æ‰§è¡Œéœ€è¦å»¶è¿Ÿæˆ–è€…å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒåŠŸèƒ½ä¸Timerç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯Timeråªèƒ½å•çº¿ç¨‹å…è®¸ï¼ŒScheduledThreadPoolExecutorå¯ä»¥æŒ‡å®šå¤šä¸ªçº¿ç¨‹ã€‚</p>
<p>ScheduledThreadPoolExecutoræ‰§è¡Œ<code>scheduleAtFixedRate()æ–¹æ³•æˆ–è€…scheduleWithFixedDelay()</code>æ–¹æ³•æ—¶ï¼Œä¼šæŠŠè¦æ‰§è¡Œçš„ä»»åŠ¡æ”¾åœ¨ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—DelayQueueä¸­ï¼Œ<code>ScheduledThreadPoolExecutorä¼šæŠŠRunableå¯¹è±¡å°è£…æˆScheduledFutureTaskï¼ˆå®ç°äº†RunnableScheduledFutureæ¥å£ï¼‰</code>ã€‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä»DelayQueueä¸­è·å–ScheduledFutureTaskã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">private class ScheduledFutureTask&lt;V&gt;</span><br><span class="line">    extends FutureTask&lt;V&gt; implements RunnableScheduledFuture&lt;V&gt;</span><br></pre></td></tr></table></figure>

<p>ScheduledFutureTaskå†…éƒ¨åŒ…å«ä¸‰ä¸ªæˆå‘˜å˜é‡ã€‚<br>timeï¼šä»»åŠ¡è¦è¢«æ‰§è¡Œçš„å…·ä½“æ—¶é—´<br>sequenceNumberï¼šä»»åŠ¡æ’åºç¼–å·ï¼Œå¦‚æœä¸¤ä¸ªä»»åŠ¡çš„timeç›¸åŒï¼Œé‚£ä¹ˆåˆ™sequenceNumberè¾ƒå°çš„ä¼šå…ˆæ‰§è¡Œ<br>periodï¼šä»»åŠ¡æ‰§è¡Œçš„å‘¨æœŸ</p>
<hr>
<p>ScheduledThreadPoolExecutoræ‰§è¡Œä»»åŠ¡çš„æµç¨‹å¤§ä½“æ˜¯ï¼š<br>1.ä»DelayQueueä¸­è·å–ScheduledFutureTaskï¼ˆtimeå¤§äºå½“å‰æ—¶é—´çš„ä»»åŠ¡ï¼‰<br>2.æ‰§è¡ŒScheduledFutureTask<br>3.ä¿®æ”¹ScheduledFutureTaskçš„timeä¸ºä¸‹æ¬¡è¦æ‰§è¡Œçš„æ—¶é—´<br>4.å°†ScheduledFutureTaskå†æ¬¡æ”¾å…¥DelayQueueä¸­</p>
<h3 id="3-FutureTask"><a href="#3-FutureTask" class="headerlink" title="3.FutureTask"></a>3.FutureTask</h3><p>Futureæ¥å£å’ŒFutureTaskå®ç°ç±»ä»£è¡¨çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œçš„ç»“æœï¼Œå¯ä»¥é€šè¿‡FutureTask.get()æ–¹æ³•è·å–å¼‚æ­¥è¿”å›çš„ç»“æœã€‚</p>
<p>FutureTaskç±»è¿˜å®ç°äº†Runnableæ¥å£ï¼Œå› æ­¤å¯ä»¥äº¤ç»™Executoræ‰§è¡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œï¼š<code>FutureTask.run()</code>ã€‚</p>
<hr>
<p>æ ¹æ®FutureTask.runè¢«æ‰§è¡Œçš„æ—¶æœºï¼ŒFutureTaskå¯å¤„äºä¸‹é¢3ç§çŠ¶æ€ï¼š<br>æœªå¯åŠ¨ï¼šæ–¹æ³•è¿˜æ²¡æœ‰è¢«æ‰§è¡Œä¹‹å‰ï¼ŒFutureTaskå¤„äºæœªå¯åŠ¨çŠ¶æ€<br>å·²å¯åŠ¨ï¼šæ–¹æ³•è¢«æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒFutureTaskå¤„äºå·²å¯åŠ¨çŠ¶æ€<br>å·²å®Œæˆï¼šæ–¹æ³•æ‰§è¡Œå®Œåæ­£å¸¸ç»“æŸæˆ–ã€å–æ¶ˆ(å³æ‰§è¡ŒFutureTask.cancel)æˆ–æŠ›å¼‚å¸¸ï¼ŒFutureTaskå¤„äºå·²å®ŒæˆçŠ¶æ€</p>
<hr>
<p>FutureTaskçŠ¶æ€å†³å®šgetå’Œcancelæ–¹æ³•æ‰§è¡Œç»“æœï¼š</p>
<p>1.geiæ–¹æ³•ï¼šå¦‚æœæœªå¯åŠ¨æˆ–å·²å¯åŠ¨çŠ¶æ€ï¼Œgetæ–¹æ³•å°†å¯¼è‡´è°ƒç”¨çº¿ç¨‹é˜»å¡ï¼Œå¦‚æœå·²å®ŒæˆçŠ¶æ€ï¼Œgetæ–¹æ³•å°†å¯¼è‡´è°ƒç”¨çº¿ç¨‹ç«‹å³è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>2.cancelæ–¹æ³•ï¼šå½“å¤„äºæœªå¯åŠ¨çŠ¶æ€ï¼Œè¯¥ä»»åŠ¡å°†ä¸ä¼šæ‰§è¡Œï¼Œå½“å¤„äºå·²å¯åŠ¨çŠ¶æ€ï¼Œ<code>Future.cancel(true)</code>å°†ä¸­æ–­æ­¤ä»»åŠ¡çº¿ç¨‹æ¥åœæ­¢ä»»åŠ¡ï¼Œ<code>Future.cancel(false)</code>å°†ä¸ä¼šå¯¹æ­£åœ¨æ‰§è¡Œæ­¤ä»»åŠ¡çš„çº¿ç¨‹äº§ç”Ÿå½±å“ï¼Œå½“å¤„äºå·²å®ŒæˆçŠ¶æ€æ—¶ï¼Œcancelæ–¹æ³•å°†è¿”å›falseã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æŠŠæŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œåå¹¶è·å–ç»“æœå®ƒæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå¯ä½¿ç”¨FutureTaskã€‚</p>
<hr>
<p>FutureTaskçš„å®ç°ï¼š</p>
<p>FutureTaskçš„å®ç°åŸºäºAbstractQueuedSynchronizer(AQSæ˜¯åŒæ­¥æ¡†æ¶ï¼Œå®ƒæä¾›é€šç”¨æœºåˆ¶æ¥åŸå­æ€§ç®¡ç†åŒæ­¥çŠ¶æ€ã€é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œä»¥åŠç»´æŠ¤è¢«é˜»å¡çº¿ç¨‹çš„é˜Ÿåˆ—)ã€‚java.util.concurrenté‡Œçš„å¾ˆå¤šé˜»å¡ç±»ï¼šReetrantLockã€Semaphoreã€ReetrantReadWriteLockã€CountDownLatchéƒ½æ˜¯åŸºäºAQSå®ç°ã€‚</p>
<hr>
<p>AQSé—å¿˜çš„çŸ¥è¯†ï¼š<br>AQSå®ç°çš„åŒæ­¥å™¨éƒ½ä¼šåŒ…å«ä¸¤ç§ç±»å‹çš„æ“ä½œï¼š<br>1.acquuireæ“ä½œï¼Œè·å–åŒæ­¥çŠ¶æ€ï¼Œç”¨æ¥é˜»å¡è°ƒç”¨çº¿ç¨‹ã€‚FutureTaskä¸­ä¸ºgetæ–¹æ³•ã€‚<br>2.releaseæ“ä½œï¼Œé‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç”¨æ¥è§£é™¤é˜»å¡çº¿ç¨‹çš„é˜»å¡ï¼ŒFutureTaskä¸­ä¸ºrunæ–¹æ³•å’Œcancelæ–¹æ³•ã€‚</p>
<hr>
<p>åŸºäºå¤åˆä¼˜å…ˆäºåŸºç¡€åŸåˆ™ï¼ŒFutureTaskçš„å†…éƒ¨ç§æœ‰ç±»Syncç»§æ‰¿è‡ªAQSã€‚å®ç°äº†AQSçš„<code>tryAcquireShared(int) å’Œ tryReleaseShared(int)</code>.</p>
<p>ğŸ¤”å› ä¸ºFutureTaskæ¶‰åŠåˆ°çº¿ç¨‹çš„é˜»å¡å”¤é†’ä¹Ÿå°±æ˜¯åŒæ­¥ï¼Œæ‰€ä»¥ç”¨AQSã€‚</p>
<h2 id="ç¬¬åä¸€ç« -javaå¹¶å‘ç¼–ç¨‹å®è·µ"><a href="#ç¬¬åä¸€ç« -javaå¹¶å‘ç¼–ç¨‹å®è·µ" class="headerlink" title="ç¬¬åä¸€ç«  javaå¹¶å‘ç¼–ç¨‹å®è·µ"></a>ç¬¬åä¸€ç«  javaå¹¶å‘ç¼–ç¨‹å®è·µ</h2><h3 id="1-ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼"><a href="#1-ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="1.ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼"></a>1.ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼</h3><p>ä»€ä¹ˆæ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ï¼Ÿ</p>
<p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼æ˜¯<strong>é€šè¿‡ä¸€ä¸ªå®¹å™¨æ¥è§£å†³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¼ºè€¦åˆé—®é¢˜</strong>ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å½¼æ­¤ä¹‹é—´ä¸ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯<strong>é€šè¿‡é˜»å¡é˜Ÿåˆ—æ¥è¿›è¡Œé€šä¿¡</strong>ï¼Œæ‰€ä»¥ç”Ÿäº§è€…ç”Ÿäº§å®Œæ•°æ®ä¹‹åä¸ç”¨ç­‰å¾…æ¶ˆè´¹è€…å¤„ç†ï¼Œç›´æ¥æ‰”ç»™é˜»å¡é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä¸æ‰¾ç”Ÿäº§è€…è¦æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥ä»é˜»å¡é˜Ÿåˆ—é‡Œå–ï¼Œ<strong>é˜»å¡é˜Ÿåˆ—å°±ç›¸å½“äºä¸€ä¸ªç¼“å†²åŒº</strong>ï¼Œå¹³è¡¡äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚</p>
<p>è¿™ä¸ªé˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”¨æ¥ç»™ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è§£è€¦çš„ã€‚çºµè§‚å¤§å¤šæ•°è®¾è®¡æ¨¡å¼ï¼Œéƒ½ä¼š<strong>æ‰¾ä¸€ä¸ªç¬¬ä¸‰è€…å‡ºæ¥è¿›è¡Œè§£è€¦</strong>ï¼Œå¦‚å·¥å‚æ¨¡å¼çš„ç¬¬ä¸‰è€…æ˜¯å·¥å‚ç±»ï¼Œæ¨¡æ¿æ¨¡å¼çš„ç¬¬ä¸‰è€…æ˜¯æ¨¡æ¿ç±»ã€‚åœ¨å­¦ä¹ ä¸€äº›è®¾è®¡æ¨¡å¼çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæ‰¾åˆ°è¿™ä¸ªæ¨¡å¼çš„ç¬¬ä¸‰è€…ï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç†Ÿæ‚‰ä¸€ä¸ªè®¾è®¡æ¨¡å¼ã€‚</p>
<p>è·å–æœºå™¨æœ‰å¤šå°‘ä¸ªCPUï¼Œæ¥å†³å®šçº¿ç¨‹æ± å¤§å°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int corePoolSize = Runtime.getRuntime().availableProcessors();</span><br></pre></td></tr></table></figure>


<h3 id="2-å¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…åœºæ™¯"><a href="#2-å¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…åœºæ™¯" class="headerlink" title="2.å¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…åœºæ™¯"></a>2.å¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…åœºæ™¯</h3><p>åœ¨å¤šæ ¸æ—¶ä»£ï¼Œå¤šçº¿ç¨‹å¹¶å‘å¤„ç†é€Ÿåº¦æ¯”å•çº¿ç¨‹å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨å¤šä¸ªçº¿ç¨‹æ¥ç”Ÿäº§æ•°æ®ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨å¤šä¸ªæ¶ˆè´¹çº¿ç¨‹æ¥æ¶ˆè´¹æ•°æ®ã€‚è€Œæ›´å¤æ‚çš„æƒ…å†µæ˜¯ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹çš„æ•°æ®ï¼Œæœ‰å¯èƒ½éœ€è¦ç»§ç»­å¤„ç†ï¼Œäºæ˜¯æ¶ˆè´¹è€…å¤„ç†å®Œæ•°æ®ä¹‹åï¼Œå®ƒåˆè¦ä½œä¸ºç”Ÿäº§è€…æŠŠæ•°æ®æ”¾åœ¨æ–°çš„é˜Ÿåˆ—é‡Œï¼Œäº¤ç»™å…¶ä»–æ¶ˆè´¹è€…ç»§ç»­å¤„ç†.</p>
<h3 id="3-çº¿ç¨‹æ± å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"><a href="#3-çº¿ç¨‹æ± å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" class="headerlink" title="3.çº¿ç¨‹æ± å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼"></a>3.çº¿ç¨‹æ± å°±æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h3><p>Java ä¸­çš„çº¿ç¨‹æ± ç±»å…¶å®å°±æ˜¯ä¸€ç§ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯æ›´åŠ é«˜æ˜ã€‚ç”Ÿäº§è€…æŠŠä»»åŠ¡ä¸¢ç»™çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹å¹¶å¤„ç†ä»»åŠ¡ï¼Œå¦‚æœå°†è¦è¿è¡Œçš„ä»»åŠ¡æ•°å¤§äºçº¿ç¨‹æ± çš„åŸºæœ¬çº¿ç¨‹æ•°å°±æŠŠä»»åŠ¡æ‰”åˆ°é˜»å¡é˜Ÿåˆ—é‡Œï¼Œè¿™ç§åšæ³•æ¯”åªä½¿ç”¨ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—æ¥å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼æ˜¾ç„¶è¦é«˜æ˜å¾ˆå¤šï¼Œå› ä¸ºæ¶ˆè´¹è€…èƒ½å¤Ÿå¤„ç†ç›´æ¥å°±å¤„ç†æ‰äº†ï¼ˆä¸ç”¨ä¸­è½¬é˜Ÿåˆ—ï¼‰ï¼Œè¿™æ ·é€Ÿåº¦æ›´å¿«ï¼Œè€Œç”Ÿäº§è€…å…ˆå­˜ï¼Œæ¶ˆè´¹è€…å†å–è¿™ç§æ–¹å¼æ˜¾ç„¶æ…¢ä¸€äº›ã€‚</p>
<p>ç”Ÿäº§è€…æ¶ˆè´¹è€…ä¾‹å­ï¼š</p>
<p>è°ƒç”¨ä¸€ä¸ªè¿œç¨‹æ¥å£æŸ¥è¯¢æ•°æ®ï¼Œå¦‚æœè¿œç¨‹æœåŠ¡æ¥å£æŸ¥è¯¢æ—¶éœ€è¦å‡ åç§’çš„æ—¶é—´ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥æä¾›ä¸€ä¸ªç”³è¯·æŸ¥è¯¢çš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£æŠŠè¦ç”³è¯·æŸ¥è¯¢ä»»åŠ¡æ”¾æ•°æ®åº“ä¸­ï¼Œç„¶åè¯¥æ¥å£ç«‹åˆ»è¿”å›ã€‚ç„¶åæœåŠ¡å™¨ç«¯ç”¨çº¿ç¨‹è½®è¯¢å¹¶è·å–ç”³è¯·ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œä¹‹åå‘æ¶ˆæ¯ç»™è°ƒç”¨æ–¹ï¼Œè®©è°ƒç”¨æ–¹å†æ¥è°ƒç”¨å¦å¤–ä¸€ä¸ªæ¥å£å–æ•°æ®ã€‚</p>
<p>å†æ¯”å¦‚ï¼š</p>
<p>1.æœ‰ä¸€äº›ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡æ”¾åœ¨dbé‡Œï¼Œè¡¨ç¤ºå®Œæˆè¿›ç¨‹ï¼ŒåŒæ—¶å°†è¡¨çš„idæ”¾å…¥redisé˜Ÿåˆ—ä¸­ã€‚</p>
<p>2.ä»»åŠ¡å¤„ç†ç«¯ï¼Œä»redisé˜Ÿåˆ—ä¸­å–å‡ºidï¼Œå†ç”¨idä»æ•°æ®åº“è¯»å‡ºä¸€ä¸ªä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¹¶æ›´æ–°dbä¸­ä»»åŠ¡å®Œæˆçš„è¿›ç¨‹ã€‚</p>
<p>3.å› ä¸ºredisç¼“å­˜ç¨³å®šæ€§è€ƒè™‘ï¼Œå®šæ—¶ä»»åŠ¡æ‚dbä¸­é•¿æ—¶é—´æœªå®Œæˆçš„ä»»åŠ¡ï¼Œå°†idæ”¾å…¥redisé˜Ÿåˆ—ä¸­ã€‚</p>
<h3 id="4-çº¿ä¸Šé—®é¢˜å®šä½"><a href="#4-çº¿ä¸Šé—®é¢˜å®šä½" class="headerlink" title="4.çº¿ä¸Šé—®é¢˜å®šä½"></a>4.çº¿ä¸Šé—®é¢˜å®šä½</h3><p>çœ‹æ—¥å¿—ã€ç³»ç»ŸçŠ¶æ€å’Œ dump çº¿ç¨‹ã€‚</p>
<p>åœ¨ Java è¿›ç¨‹è¿™ä¸€è¡Œé‡Œå¯ä»¥çœ‹åˆ° CPU åˆ©ç”¨ç‡æ˜¯ 300%ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œè¿™ä¸ªæ˜¯å½“å‰æœºå™¨æ‰€æœ‰æ ¸åŠ åœ¨ä¸€èµ·çš„ CPU åˆ©ç”¨ç‡ã€‚</p>
<p>jstackå‘½ä»¤å¯ä»¥æŠŠçº¿ç¨‹ dump ä¸‹æ¥ï¼Œçœ‹çœ‹ç©¶ç«Ÿæ˜¯å“ªä¸ªçº¿ç¨‹ã€æ‰§è¡Œä»€ä¹ˆä»£ç é€ æˆçš„ CPU åˆ©ç”¨ç‡é«˜ã€‚</p>
<p>dump å‡ºæ¥çš„çº¿ç¨‹ IDï¼ˆnidï¼‰æ˜¯åå…­è¿›åˆ¶çš„ï¼Œè€Œæˆ‘ä»¬ç”¨ TOP å‘½ä»¤çœ‹åˆ°çš„çº¿ç¨‹ ID æ˜¯åè¿›åˆ¶çš„ï¼Œæ‰€ä»¥è¦ç”¨ printf å‘½ä»¤è½¬æ¢ä¸€ä¸‹è¿›åˆ¶ã€‚ç„¶åç”¨åå…­è¿›åˆ¶çš„ ID å» dump é‡Œæ‰¾åˆ°å¯¹åº”çš„çº¿ç¨‹ã€‚</p>
<p>åè¿›åˆ¶è½¬åå…­è¿›åˆ¶ï¼š<br><code>printf &quot;%x\n&quot; 31558</code></p>
<p><code>netstat -nat | grep 8080 -c</code> å¤šå°‘å°æœºå™¨è¿æ¥åˆ°æœ¬æœº8080ç«¯å£</p>
<p><code>ps -eLf|grep java -c</code> çœ‹javaçº¿ç¨‹æ•°</p>
<h3 id="5-å¼‚æ­¥ä»»åŠ¡æ± "><a href="#5-å¼‚æ­¥ä»»åŠ¡æ± " class="headerlink" title="5.å¼‚æ­¥ä»»åŠ¡æ± "></a>5.å¼‚æ­¥ä»»åŠ¡æ± </h3><p>å¦‚æœä¸€ä¸ªä»»åŠ¡ä»è¿›çº¿ç¨‹æ± ä¹‹åï¼Œè¿è¡Œçº¿ç¨‹æ± çš„ç¨‹åºé‡å¯äº†ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± é‡Œçš„ä»»åŠ¡å°±ä¼šä¸¢å¤±ã€‚å¦å¤–ï¼Œçº¿ç¨‹æ± åªèƒ½å¤„ç†æœ¬æœºçš„ä»»åŠ¡ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ä¸èƒ½æœ‰æ•ˆåœ°è°ƒåº¦æ‰€æœ‰æœºå™¨çš„ä»»åŠ¡ã€‚æ‰€ä»¥ï¼Œç»“åˆçº¿ç¨‹æ± å¼€å‘ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡å¤„ç†æ± ã€‚</p>
<p>ä»»åŠ¡æ± çš„ä¸»è¦å¤„ç†æµç¨‹æ˜¯ï¼Œæ¯å°æœºå™¨ä¼šå¯åŠ¨ä¸€ä¸ªä»»åŠ¡æ± ï¼Œæ¯ä¸ªä»»åŠ¡æ± é‡Œæœ‰å¤šä¸ªçº¿ç¨‹æ± ï¼Œå½“æŸå°æœºå™¨å°†ä¸€ä¸ªä»»åŠ¡äº¤ç»™ä»»åŠ¡æ± åï¼Œä»»åŠ¡æ± ä¼šå…ˆå°†è¿™ä¸ªä»»åŠ¡ä¿å­˜åˆ°æ•°æ®ä¸­ï¼Œç„¶åæŸå°æœºå™¨ä¸Šçš„ä»»åŠ¡æ± ä¼šä»æ•°æ®åº“ä¸­è·å–å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå†æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</p>
<p>æ¯ä¸ªä»»åŠ¡æœ‰å‡ ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯åˆ›å»ºï¼ˆNEWï¼‰ã€æ‰§è¡Œä¸­ï¼ˆEXECUTINGï¼‰ã€RETRYï¼ˆé‡è¯•ï¼‰ã€æŒ‚èµ·ï¼ˆSUSPENDï¼‰ã€ä¸­æ­¢ï¼ˆTEMINERï¼‰å’Œæ‰§è¡Œå®Œæˆï¼ˆFINISHï¼‰ã€‚</p>
<p>åˆ›å»ºï¼šæäº¤ç»™ä»»åŠ¡æ± ä¹‹åçš„çŠ¶æ€ã€‚<br>æ‰§è¡Œä¸­ï¼šä»»åŠ¡æ± ä»æ•°æ®åº“ä¸­æ‹¿åˆ°ä»»åŠ¡æ‰§è¡Œæ—¶çš„çŠ¶æ€ã€‚<br>é‡è¯•ï¼šå½“æ‰§è¡Œä»»åŠ¡æ—¶å‡ºç°é”™è¯¯ï¼Œç¨‹åºæ˜¾å¼åœ°å‘Šè¯‰ä»»åŠ¡æ± è¿™ä¸ªä»»åŠ¡éœ€è¦é‡è¯•ï¼Œå¹¶è®¾ç½®ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ã€‚<br>æŒ‚èµ·ï¼šå½“ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œä¾èµ–äºå…¶ä»–ä»»åŠ¡å®Œæˆæ—¶ï¼Œå¯ä»¥å°†è¿™ä¸ªä»»åŠ¡æŒ‚èµ·ï¼Œå½“æ”¶åˆ°æ¶ˆæ¯åï¼Œå†å¼€å§‹æ‰§è¡Œã€‚<br>ä¸­æ­¢ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè®©ä»»åŠ¡æ± åœæ­¢æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œå¹¶è®¾ç½®é”™è¯¯æ¶ˆæ¯å‘Šè¯‰è°ƒç”¨ç«¯ã€‚<br>æ‰§è¡Œå®Œæˆï¼šä»»åŠ¡æ‰§è¡Œç»“æŸã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jade liu"
      src="/images/head.gif">
  <p class="site-author-name" itemprop="name">Jade liu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/jadeliuliu" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;jadeliuliu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jadeliu1998@163.com" title="E-Mail â†’ mailto:jadeliu1998@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/jadeliu1998" title="CSDN â†’ https:&#x2F;&#x2F;blog.csdn.net&#x2F;jadeliu1998" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5823044646" title="Weibo â†’ https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5823044646" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jade liu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>





        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
